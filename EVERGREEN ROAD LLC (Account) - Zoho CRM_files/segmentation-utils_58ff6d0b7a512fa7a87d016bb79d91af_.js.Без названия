Lyte.Mixin.register("segmentation-utils",{getFeatureRelatedErrorMsg:function(e,t,r){var i=e.segmentations?e.segmentations[0]:e,n=i.code,a=i.details,s=i.message;if("INTERNAL_ERROR"===n)return I18n.getMsg("crm.label.cf.error.internal");if("FEATURE_NOT_SUPPORTED"===n)return I18n.getMsg("crm.segmentation.feature.unavailable");if("LIMIT_EXCEEDED"===n){if(a.resource&&"fields"===a.resource.type)return I18n.getMsg("crm.segmentation.free.cf.unavailable");if(a.module)return I18n.getMsg("crm.segmentation.publish.module.duplicates");if("publish"===a.type)return I18n.getMsg("crm.segmentation.publish.limit.exceed");if("draft"===a.type)return I18n.getMsg("crm.segmentation.draft.limit.exceed")}return"DAILY_LIMIT_EXCEEDED"===n?I18n.getMsg("crm.segmentation.publish.republish.limit.exceed"):this.getApiKeysVsErrorMsg.call(this,n,a,t,s,r)},getApiKeysVsErrorMsg:function(e,t,r,i,n){if(t.resource){var a=t.resource[0];return i.toLowerCase()===(a.api_name+" API Name already exists. Please disable translation and change the API Name and after that create the Segmentation process.").toLowerCase()?I18n.getMsg("crm.segmentation.cf.api.name.duplicate.translation",[a.api_name]):i.toLowerCase()===(a.api_name+" API Name and field label already exists. Please disable translation and change the API Name, field label and after that create the Segmentation process.").toLowerCase()?I18n.getMsg("crm.segmentation.cf.name.field.duplicate.translation",[a.api_name]):i.toLowerCase()===(a.api_name+" field label already exists. Please disable translation and change the Field Label and after that create the Segmentation process.").toLowerCase()?I18n.getMsg("crm.segmentation.cf.field.label.duplicate.translation",[a.api_name]):"Free Custom fields unavailable. 3 Integer fields and 1 Pick List field is required for publishing this segmentation process."==i?I18n.getMsg("crm.segmentation.free.cf.unavailable"):this.getCustomFieldError(a.api_name,a)}if(t.resource_path_index)return"INVALID_DATA"==e&&1==t.resource_path_index?I18n.getMsg("crm.segmentation.no.permission.deleted"):i;if("name"===t.api_name&&!t.parent_api_name)return"DUPLICATE_DATA"===e?I18n.getMsg("crm.segmentation.segment.duplicate"):I18n.getMsg("crm.segmentation.name.blank",I18n.getMsg("crm.segmentation.name.title"));if("api_name"===t.api_name||"id"===t.api_name){if("INVALID_DATA"===e){if(t.json_path.indexOf("link_field")>0)return I18n.getMsg("crm.segmentation.link.field.err");if(t.json_path.indexOf("recency_field.")>0)return I18n.getMsg("crm.segmentation.recency.field.required");if(t.json_path.indexOf("frequency_field.")>0)return I18n.getMsg("crm.segmentation.frequency.field.required");if(t.json_path.indexOf("monetary_field.")>0)return I18n.getMsg("crm.segmentation.monetary.field.required");if(t.json_path.indexOf("link_module.")>0)return I18n.getMsg("crm.segmentation.link.module.required");if(t.json_path.indexOf("module.")>0)return I18n.getMsg("crm.segmentation.module.required")}}else if("score_details"===t.api_name){if(["MANDATORY_NOT_FOUND","DEPENDENT_FIELD_MISSING"].contains(e))return I18n.getMsg("crm.segmentation.criterias.missing");if("INVALID_DATA"===e&&t.length)return I18n.getMsg("crm.segmentation.criteria.count.mismatch")}else if("status"===t.api_name){if("INVALID_DATA"===e)return I18n.getMsg("crm.segmentation.deactivation.error")}else if("labels"===t.api_name){if("INVALID_DATA"===e&&t.minimum_length&&t.maximum_length)return I18n.getMsg("crm.segmentation.label.count")}else{if("labels"===t.parent_api_name)return this.validateLabels.call(this,r.labels,r.max_score);if("CANNOT_PROCESS"===e&&"delete"===n)return I18n.getMsg("crm.segmentation.custom.field.dependency")}},getCustomFieldError:function(e,t){return 2===t._change.length?I18n.getMsg("crm.segmentation.cf.name.field.duplicate",[e]):"api_name"===t._change[0]?I18n.getMsg("crm.segmentation.cf.api.name.duplicate",[e]):I18n.getMsg("crm.segmentation.cf.field.label.duplicate",[I18n.getMsg(e)])},validateLabels:function(e,t){for(var r=e.length,i=[],n=[],a=[],s=[],o=[],l=[],d=[],c=0;c<r;c++){var m=e[c],u=m.name;if(d[c]=u,i[c]=this.getMinValue(m.recency),n[c]=this.getMaxValue(m.recency),i!==n&&i>n)return I18n.getMsg("crm.segmentation.label.invalid.score",[d[c],I18n.getMsg("crm.segmentation.recency")]);if(i>t&&n>t)return I18n.getMsg("crm.segmentation.label.invalid.score.range",[d[c],I18n.getMsg("crm.segmentation.recency")]);if(a[c]=this.getMinValue(m.frequency),s[c]=this.getMaxValue(m.frequency),a!==s&&a>s)return I18n.getMsg("crm.segmentation.label.invalid.score",[d[c],I18n.getMsg("crm.segmentation.frequency")]);if(a>t&&s>t)return I18n.getMsg("crm.segmentation.label.invalid.score.range",[d[c],I18n.getMsg("crm.segmentation.frequency")]);if(o[c]=this.getMinValue(m.monetary),l[c]=this.getMaxValue(m.monetary),o!==l&&o>l)return I18n.getMsg("crm.segmentation.label.invalid.score",[d[c],I18n.getMsg("crm.segmentation.monetary")]);if(o>t&&l>t)return I18n.getMsg("crm.segmentation.label.invalid.score.range",[d[c],I18n.getMsg("crm.segmentation.monetary")])}for(c=0;c<r;c++)for(var g=c+1;g<r;g++){var p=!1,f=!1,y=!1;if((i[g]>=i[c]&&i[g]<=n[c]||n[g]>=i[c]&&n[g]<=n[c])&&(p=!0),(a[g]>=a[c]&&a[g]<=s[c]||s[g]>=a[c]&&s[g]<=s[c])&&(f=!0),(o[g]>=o[c]&&o[g]<=l[c]||l[g]>=o[c]&&l[g]<=l[c])&&(y=!0),d[c].trim()===d[g].trim())return I18n.getMsg("crm.segemnt.label.name.exist",[d[c]]);if(""===d[c].trim())return I18n.getMsg("crm.segmentation.label.name.empty");if(p&&f&&y)return I18n.getMsg("crm.segment.duplicate.label")}},getSegmentStatusForApi:function(e){return{published:"published",publishedInactive:"inactive",drafted:"draft"}[e]},getSegmentStatus:function(e){return{published:"published",inactive:"publishedInactive",draft:"drafted"}[e]},showSegmentsList:function(){store.unloadAll("segments");var e=getElemById("createSegment");e&&e.setData("isSegmentCreated",!1),Lyte.Router.transitionTo({route:"crm.settings.section.segmentation.index"})},removeErrorMsg:function(e,t,r){document.getElementsByClassName(e)[0].classList.add("dN"),document.getElementsByClassName(t)[0].classList.remove(r)},showErrorMsg:function(e,t,r){document.getElementsByClassName(e)[0].classList.remove("dN"),(t=document.getElementsByClassName(t)[0]).classList.add(r),t.focus()},getMinValue:function(e){var t=e,r=e.indexOf("-");return-1!==r&&(t=e.substring(0,r)),t},getMaxValue:function(e){var t=e,r=e.indexOf("-");return-1!==r&&(t=e.substring(r+1)),t},saveSegmentation:function(e,t,r,i){var n,a,s=store.peekRecord("segments",e);s.$.set("status",t?"published":"drafted"),commonUtils.showHideLoadingDiv(!0),s.$.save({isCriteriaModified:i.getData("isCriteriaModified")}).then((function(){if(s.slider_details=[],i.showSegmentsList(),n=I18n.getMsg("crm.segmentation.success.draft",[s.module.plural_label]),(a=i.getRecordById(store.peekAll("module"),s.module.id))&&moduleRecordMapping[a[0].module_name]&&(store.peekRecord("module",moduleRecordMapping[a[0].module_name].id).fields=void 0),commonUtils.showHideLoadingDiv(!1),t&&!r)return n='<div class="mB5 crm-font-bold">'+I18n.getMsg("crm.segmentation.success.create.heading")+'</div><div class="mB5">'+I18n.getMsg("crm.segmentation.success.create1",s.module.plural_label)+"</div>"+I18n.getMsg("crm.segmentation.success.create2",s.module.plural_label),void _cruxUtils.showCustomMessage({params:{ltPropMessage:n,ltPropYield:!0,ltPropDuration:"6000"}});r&&(n=I18n.getMsg("crm.segmentation.success.update")),i.showAlertBox("success",n)}),(function(e){commonUtils.showHideLoadingDiv(!1),s.$.rollBackAttributes("status"),i.setData("isBtnDisable",!1);var t=JSON.parse(e.response),r=t.segmentations?t.segmentations[0]:t,n=i.getFeatureRelatedErrorMsg.call(i,t,s);i.showAlertBox("error",n||r.message)}))},rfmSliderHandlerValues:function(e){return this.getRFMSliderDivision(5,e)},getRFMSliderDivision:function(e,t){var r,i=[],n=r=3===e?35:100/e,a=1;for(e-=1;e;){var s={};s.value=n,n+=r,s.class="rfmRanger some1 rfm_multiSliderState",s.id=t+a,a++,i.push(s),e--}return i[0].min=5,i[i.length-1].max=95,i},showAlertBox:function(e,t,r){var i=document.getElementById("segmentationAlertBox");if(r=r||4e3,!i){var n=document.createElement("lyte-messagebox");n.set("id","segmentationAlertBox"),document.getElementById("setupshow").appendChild(n),i=n}i.ltProp({type:e,message:t,duration:r,transition:{animation:"slideFromTop"},show:!0})},showNoResultInSerach:function(e){e.length>0?this.setData("showNoResult",!1):this.setData("showNoResult",!0)},resetSearchText:function(e){var t=getElemById(e);t&&t.setValue("")},validateName:function(e){return!/[\^~`#%^&*+={}[\]|;"<>\\]+/g.test(e)},unloadComputeModel:function(e){var t=getElemById("segmentScore").component,r=store.peekRecord("segments",this.getData("segmentId"));if("ALL"===e)r.slider_details=[],t.setData({showRecencyFromToRange:!1,showFrequencyFromToRange:!1,showMonetaryFromToRange:!1,showRecencyComputed:!1,showFrequencyComputed:!1,showMonetaryComputed:!1});else{if(r.slider_details)for(var i=r.slider_details.length,n=0;n<i;n++)if(r.slider_details[n].score_type===e){r.slider_details.splice(n,1);break}var a=e.charAt(0).toLocaleUpperCase()+e.slice(1).toLowerCase();t.setData("show"+a+"FromToRange",!1)}switch(t.setData("disableCompute",!1),t.setData("isCompute",!0),t.setData("showRecencyPopUp",!1),t.setData("showFrequencyPopUp",!1),t.setData("showMonetaryPopUp",!1),e){case"recency":t.setData("showRecencyComputed",!1);break;case"frequency":t.setData("showFrequencyComputed",!1);break;case"monetary":t.setData("showMonetaryComputed",!1)}},checkDuplicateSegmentName:function(e,t){if(t)var r=store.peekAll("segments").filter((function(e){return t!==e.id})).map((function(e){return e.name.toLocaleLowerCase()}));else r=store.peekAll("segments").map((function(e){return e.name.toLocaleLowerCase()}));return r.contains(e.toLocaleLowerCase().trim())},getSegmentationDetails:function(e,t,r){var i=!1;r&&(r.isProductionDiff||r.isSandboxDiff)&&(i=!0);var n=this;return store.unloadAll("segments"),(i?store.findRecord("segments",e,null,!1,!1,r):store.findRecord("segments",e)).then((function(a){var s=i?a.hasOwnProperty("segments")?a.segments[0]:null:store.peekRecord("segments",e);if(!(r&&r.isFromSandbox||!s||"publishedInactive"!==s.status))return{noPermission:!0,heading:"crm.segment.access.denied",msg:I18n.getMsg("crm.segmentation.no.permission.deactivated",[s.name]),noNeedI18N:!0};if(!s)return{noPermission:!0,heading:"crm.segmentation.deleted.access",msg:"crm.segmentation.no.permission.deleted"};if(s.labels.forEach((function(e){e.rMin=n.getMinValue(e.recency),e.rMax=n.getMaxValue(e.recency),e.fMin=n.getMinValue(e.frequency),e.fMax=n.getMaxValue(e.frequency),e.mMin=n.getMinValue(e.monetary),e.mMax=n.getMaxValue(e.monetary)})),t)return commonUtils.showHideLoadingDiv(!1),{labels:s.labels,segment:s,isEdit:!0,segmentId:e,isLabelsEdit:t};var o={segmentId:s.id,segmentName:s.name};return i?store.findAll("module",null,!1,!1,r).then((function(e){return commonUtils.showHideLoadingDiv(!1),o.segmentModuleDetails=n.getRecordById(e.module,s.module.id)[0],o.lookUpModuleDetails=n.getRecordById(e.module,s.link_module.id)[0],n.populateSegmentFields(o,s,i,r)}),(function(e){commonUtils.showHideLoadingDiv(!1);var t=JSON.parse(e.response);n.showAlertBox("warning",I18n.getMsg(t.message))})):(o.segmentModuleDetails=store.peekRecord("module",s.module.id),o.lookUpModuleDetails=store.peekRecord("module",s.link_module.id),n.populateSegmentFields(o,s,i,r))}),(function(e){var t=JSON.parse(e.response);if("NOT_SUPPORTED_FEATURE"===t.code||"NO_PERMISSION"===t.code||"INVALID_MODULE"===t.code)return{noPermission:!0,msg:"crm.security.error"}}))},populateSegmentFields:function(e,t,r,i){if(e.segmentModuleDetails&&e.lookUpModuleDetails&&e.segmentModuleDetails.visible&&e.lookUpModuleDetails.visible){var n=this,a=e.segmentModuleDetails.plural_label;e.allModulesArray=[e.segmentModuleDetails.api_name,e.lookUpModuleDetails.api_name],e.segmentAndLookupModule=a,e.isCreate=!1,e.viewCriClass="",e.addCriClass="dN",e.linkingField=t.link_field,e.recencyField=t.recency_field,e.frequencyField=t.frequency_field,e.status=t.status,e.monetaryField=t.monetary_field,e.score=t.max_score,e.rangeMax=e.score;var s=t.global_criteria;s?(e.setGlobalCriteria=s,e.isBasedOnCriteria=!0,e.isBasedOnAllRecords=!1):(e.isBasedOnCriteria=!1,e.isBasedOnAllRecords=!0),t.link_module_criteria?(e.setConCriteria=t.link_module_criteria,e.hasContrubuteModuleCriteria=!0,e.contributeModuleAllRecords=!1):(e.hasContrubuteModuleCriteria=!1,e.contributeModuleAllRecords=!0),e.byManual="manual"===t.score_type,e.automatic="automatic"===t.score_type,e.criteriaType="automatic"===t.score_type?I18n.getMsg("crm.dumprequest.automatic"):I18n.getMsg("crm.dumprequest.manual"),e.isFrequencyBasedOnField="$Count_Of"!==e.frequencyField.api_name,e.isFrequencyBasedOnField&&(e.showFrequencyDropDown=!0),e.isFrequencyBasedOnCount=!e.isFrequencyBasedOnField,e.isEdit=!0,e.isEditCompute=!0,"published"===e.status?(e.showRecencyComputed=!0,e.showFrequencyComputed=!0,e.showMonetaryComputed=!0):(e.showRecencyComputed=!1,e.showFrequencyComputed=!1,e.showMonetaryComputed=!1),e.computeToolTip=I18n.getMsg("crm.segmentation.compute.tooltip2"),e.scoreSliderValue=[{value:e.score,min:3,max:5,id:"scoreSlider",class:"scoreSlider"}],e.labels=t.labels,e.segmentLabels=e.labels.length;var o=[];t.score_details.forEach((function(e){o.push(e)})),e.recRangeArr=[],e.freqRangeArr=[],e.monRangeArr=[],e.rSliderDivision=[],e.fSliderDivision=[],e.mSliderDivision=[];var l=1,d=o.length;if(e.automatic)for(var c=0;c<d;c++){var m=o[c],u={};-1!==["recency","frequency","monetary"].indexOf(m.type)&&m.score!==e.score&&(u.value=m.criteria.max,u.class="rfmRanger some1",u.id=m.type+l,1===m.score?u.min=5:m.score===e.score-1&&(u.max=95),"recency"===m.type?e.rSliderDivision.push(u):"frequency"===m.type?e.fSliderDivision.push(u):e.mSliderDivision.push(u)),l++}else{for(var g=0;g<d;g++){"recency"===(m=o[g]).type?e.recRangeArr.push(m):"frequency"===m.type?e.freqRangeArr.push(m):e.monRangeArr.push(m)}e.recRangeArr=$u.sortBy(e.recRangeArr,"score").reverse(),e.freqRangeArr=$u.sortBy(e.freqRangeArr,"score").reverse(),e.monRangeArr=$u.sortBy(e.monRangeArr,"score").reverse()}if(r){var p=i;return p.apiVersion="2.2",Lyte.resolvePromises([store.findAll("field",{module:e.segmentModuleDetails.api_name,type:"all"},!1,!1,p),store.findAll("field",{module:e.lookUpModuleDetails.api_name,type:"all"},!1,!1,p)]).then((function(i){var n=i[0].field,a=i[1].field,s=n.concat(a);return e.newSegment=t,{segmentRecord:e,segmentedModuleFields:n,lookUpModuleFields:a,segmentId:e.segmentId,isEdit:!0,cacheFields:s,noCache:r}}),(function(e){commonUtils.showHideLoadingDiv(!1);var t=JSON.parse(e.response);n.showAlertBox("warning",I18n.getMsg(t.message))}))}var f={apiVersion:"2.2"},y=[store.findAll("field",{module:e.segmentModuleDetails.api_name,type:"all"},!1,!0,f),store.findAll("field",{module:e.lookUpModuleDetails.api_name,type:"all"},!1,!0,f)];if("published"===e.status&&e.automatic){var h={compute:[{segmentation:{id:e.segmentId}}]};y.push(store.triggerAction("segments","compute",h,null,"POST"))}return Lyte.resolvePromises(y).then((function(i){commonUtils.showHideLoadingDiv(!1);var n=i[0],a=i[1];return e.newSegment=t,t.slider_details=i[2]&&i[2].compute?i[2].compute:[],{segmentRecord:e,segmentedModuleFields:n,lookUpModuleFields:a,segmentId:e.segmentId,isEdit:!0,cacheFields:null,noCache:r}}),(function(e){commonUtils.showHideLoadingDiv(!1);var t=JSON.parse(e.response);if("NO_PERMISSION"===t.code)return{noPermission:!0,heading:"crm.social.setup.denied",msg:"crm.segmentation.hidden.module"};n.showAlertBox("warning",I18n.getMsg(t.message))}))}return{noPermission:!0,heading:"crm.social.setup.denied",msg:"crm.segmentation.hidden.module"}},populateSegmentationDetails:function(e,t){if(e.noPermission||t)return e;var r,i=[],n=[],a=[],s=[],o=e.segmentRecord,l=e.lookUpModuleFields,d=[17];l&&(r=(l=l.filter((e=>null===e.crypt))).length);for(var c=[CrmField.UITYPES.LOOK_UP_ENTITY,CrmField.UITYPES.CONTACT_ID,CrmField.UITYPES.CONTACT_LOOKUP,CrmField.UITYPES.ACCOUNT_NAME_LOOKUP,CrmField.UITYPES.CAMPAIGN_NAME_LOOKUP,CrmField.UITYPES.PRODUCT_NAME_LOOKUP,CrmField.UITYPES.VENDOR_NAME_LOOKUP,CrmField.UITYPES.OWNER,CrmField.UITYPES.USERLOOKUP,CrmField.UITYPES.PRODUCT_HANDLER,46],m=0;m<r;m++)d.includes(l[m].show_type)||(c.indexOf(l[m].ui_type)>-1&&Object.keys(l[m].lookup).length&&l[m].lookup.module&&l[m].lookup.module.api_name===o.segmentModuleDetails.api_name&&i.push(l[m]),l[m].ui_type===CrmField.UITYPES.DATE||l[m].ui_type===CrmField.UITYPES.DATE_LONG||l[m].ui_type===CrmField.UITYPES.DATE_TIME_LONG||l[m].ui_type===CrmField.UITYPES.CREATED_TIME?n.push(l[m]):([CrmField.UITYPES.FORMULA,CrmField.UITYPES.AGGREGATE_FIELD].includes(l[m].ui_type)&&"currency"===l[m].formula.return_type||l[m].ui_type===CrmField.UITYPES.DATA_PARAM&&"currency"===l[m].rollup_summary.return_type||l[m].ui_type===CrmField.UITYPES.CURRENCY||l[m].ui_type===CrmField.UITYPES.CURRENCY_ROUND_OFF||l[m].ui_type===CrmField.UITYPES.CURRENCY_ROUND_DOWN||l[m].ui_type===CrmField.UITYPES.CURRENCY_ROUND_UP)&&a.push(l[m]));var u={};u.recencyFields=n,u.monetaryFields=a,u.lookUpFields=i,u.linkingModuleFields=l,o.conModuleFields=l,o.segModuleFields=e.segmentedModuleFields.filter((function(e){if(0!==e.show_type&&-1===["Recency","Frequency","Monetary","Segment_Label"].indexOf(e.api_name))return!0}));var g=o.segModuleFields.length;for(m=0;m<g;m++)null!==o.segModuleFields[m].crypt||o.segModuleFields[m].ui_type!==CrmField.UITYPES.NUMERIC_FIELD||["Recency","Frequency","Monetary"].indexOf(o.segModuleFields[m].field_label)>-1&&!d.includes(segModuleFields[m].show_type)||s.push(o.segModuleFields[m]);s.length&&(u.frequencyFields=s);var p=[{module:o.lookUpModuleDetails.api_name,fields:l},{module:o.segModuleFields.api_name,fields:o.segModuleFields}];u.allFieldsList=p,o.editSegmentDetails=u,o.globalCriteriaFields=p,e.cacheFields?(o.lookUpFieldDetails=this.getRecordById(e.cacheFields,o.linkingField.id)[0],o.recencyCriField=this.getRecordById(e.cacheFields,o.recencyField.id),o.monetaryCriField=this.getRecordById(e.cacheFields,o.monetaryField.id)):(o.lookUpFieldDetails=store.peekRecord("field",o.linkingField.id),o.recencyCriField=[store.peekRecord("field",o.recencyField.id)],o.monetaryCriField=[store.peekRecord("field",o.monetaryField.id)]);var f={api_name:"$Count_Of",id:null};if(f.field_label=I18n.getMsg("crm.dashboard.funnel.count.of",[o.lookUpModuleDetails.plural_label]),f.display_label=f.field_label,f.ui_type=CrmField.UITYPES.NUMERIC_FIELD,f.json_type="integer",f.data_type="integer",f.visible=!0,o.isFrequencyBasedOnCount)o.frequencyCriField=[],o.frequencyCriField.push(f),o.customFrequencyCriField=o.frequencyCriField;else{e.cacheFields?o.frequencyCriField=this.getRecordById(e.cacheFields,o.frequencyField.id):o.frequencyCriField=[store.peekRecord("field",o.frequencyField.id)];var y=o.conModuleFields.length;for(m=0;m<y;m++){if([CrmField.UITYPES.CURRENCY,CrmField.UITYPES.CURRENCY_ROUND_OFF,CrmField.UITYPES.CURRENCY_ROUND_DOWN,CrmField.UITYPES.CURRENCY_ROUND_UP,77].indexOf(o.conModuleFields[m].ui_type)>-1){o.customFrequencyCriField=[],o.customFrequencyCriField.push(f);break}}}return o.noCache=e.noCache,e.segmentRecord},getRecordById:function(e,t){return e.filter((function(e){return e.id===t}))},getAssociationsObj:function(e,t,r,i,n){for(var a=e.length,s={},o=0;o<a;o++){e[o].type="workflow_field_update"===e[o].type?"field_update":e[o].type,e[o].type="lookup filter criteria"===e[o].type?"lookup_filter_criteria":e[o].type,e[o].type=e[o].action?e[o].type+"_"+e[o].action:e[o].type;var l=r.getData("associationConstants");t.indexOf(e[o].type)>-1?(e[o].dynamicParam=l[e[o].type].dynamicParam?0!==l[e[o].type].dynamicParam.length?[i]:[]:void 0,"email_template"===e[o].type||"inventory"===e[o].type?(e[o].queryParam=objectUtils.cloneObject(l[e[o].type].queryParam),e[o].queryParam.templateId=e[o].id,e[o].queryParam.module&&(e[o].queryParam.module=i)):"lookup_filter_criteria"===e[o].type?(e[o].dynamicParam.push(e[o].module),e[o].dynamicParam.push(e[o].details.layout.id)):"chart_view"===e[o].type?(e[o].queryParam={chart_id:e[o].details.chart_details.chart_id},e[o].dynamicParam.push(e[o].id)):e[o].dynamicParam&&e[o].rule_id?e[o].dynamicParam.push(e[o].rule_id):"kanban_view"===e[o].type?(e[o].dynamicParam.push(e[o].id),e[o].queryParam={action:"edit",kvId:e[o].details.kanban_details.kvId}):"assignment rule"===e[o].type?(e[o].dynamicParam.push(e[o].id),e[o].queryParam={action:"viewRuleEntries"}):e[o].dynamicParam&&-1===["custom_button","layout_rule","formula_field"].indexOf(e[o].type)?e[o].dynamicParam.push(e[o].id):"canvas_rules"===e[o].type?e[o].queryParam={ruleId:e[o].id}:"abmSegmentCampaignsListCriteria"===e[o].type&&(e[o].url=window.location.origin+"/crm/"+crmPortal+"/abm/segments/"+e[o].id+"/home"),l[e[o].type].queryParam&&l[e[o].type].queryParam.module&&(e[o].queryParam?e[o].queryParam.module=i:e[o].queryParam={module:i}),s[e[o].type]?s[e[o].type].items.push(e[o]):(s[e[o].type]={},s[e[o].type].items=new Array(e[o]),Lyte.objectUtils(s[e[o].type],"add",l[e[o].type]))):"layouts"!==e[o].type&&(s[e[o].type]?s[e[o].type].items.push(e[o]):(s[e[o].type]={},s[e[o].type].items=new Array(e[o]),Lyte.objectUtils(s[e[o].type],"add",l[e[o].type])))}return s},createSegmentationCriteria:function(e,t,r){var i=[];for(let a=t;a>0;a--){var n=store.createRecord("segment_criteria");n.$.set("type",e),n.$.set("score",a),n.$.set("segments",store.peekRecord("segments",r)),i.push(n)}return i},resetSegmentationCriteria:function(e,t){var r=e.length;for(let a=0;a<r;a++){var i=this.getCrietriaArrayForType(e[a],t),n=i.length;for(let e=0;e<n;e++)i[e].criteria&&i[e].$.set("criteria",void 0)}},checkAllCriteriaEntered:function(e){var t=e.length,r=!0;for(let i=0;i<t;i++)if(!e[i].criteria){r=!1;break}return r},checkCriteriaEntered:function(e){var t=e.length,r=!1;for(let i=0;i<t;i++)if(e[i].criteria){r=!0;break}return r},getCrietriaArrayForType:function(e,t){return store.peekRecord("segments",t).score_details.filter((function(t){if(t.type===e)return!0}))},getValueForPercentile:function(e,t){var r=e.length;for(let i=0;i<r;i++)if(e[i].percentile===t)return e[i].value},getUsersForScore:function(e,t){var r=e.length;for(let i=0;i<r;i++)if(e[i].score===t)return e[i].users_count},changeFieldsValue:function(e,t,r){var i=e.group;if(i){let e=i.length;for(let n=0;n<e;n++)this.changeFieldsValue(i[n],t,r)}else e.field.api_name=t,e.field.id=r},getFieldDetailsFromCriteria:function(e){var t={},r=e.group;if(r){let e=r.length;for(let n=0;n<e;n++){var i=this.getFieldDetailsFromCriteria(r[n]);if(i){t=i;break}}}else t.api_name=e.field.api_name,t.id=e.field.id;return t},getRecordByScore:function(e,t){var r=e.length;for(let i=0;i<r;i++)if(e[i].score===t)return e[i]},addOrDeleteCriteria:function(e,t,r,i){var n=i.getCrietriaArrayForType("recency",r),a=i.getCrietriaArrayForType("frequency",r),s=i.getCrietriaArrayForType("monetary",r);if(e!==t&&n.length!==t){var o=n.length;if(e<t)for(var l=o;l<t;l++){var d=l+1;store.createRecord("segment_criteria",{score:d,type:"recency",segments:store.peekRecord("segments",r)}),store.createRecord("segment_criteria",{score:d,type:"frequency",segments:store.peekRecord("segments",r)}),store.createRecord("segment_criteria",{score:d,type:"monetary",segments:store.peekRecord("segments",r)})}else for(l=o;l>t;l--){var c=[];c.push(i.getRecordByScore(n,l).id),c.push(i.getRecordByScore(a,l).id),c.push(i.getRecordByScore(s,l).id),store.deleteMany("segment_criteria",c)}}},removeOldValues:function(e){for(var t=e.length,r=0;r<t;r++)(e[r].hasOwnProperty("_delete")||e[r].$&&"removed"==e[r].$.partialType)&&(e.removeFirstOccurenceOfElement(e[r]),t--,r--);return e},resetAllManualCriteria:function(e,t,r,i){for(var n=e.concat(t).concat(r),a=n.length,s=0;s<a;s++){var o=store.createRecord("segment_criteria");o.$.set("type",n[s].type),o.$.set("score",n[s].score),o.$.set("criteria",n[s].criteria),o.$.set("segments",i),store.unloadRecord("segment_criteria",n[s].id)}},fillAutomaticCriteria:function(e,t){var r=e.length,i=!1;for(let d=0;d<r;d++){var n=e[d].score,a=e[d].type,s=t.score_details,o=s?s.filterBy({score:n}).filterBy({type:a}):[];if(1===o.length){var l=o[0];JSON.stringify(l.criteria)!==JSON.stringify(e[d].criteria)&&(i=!0),l.$.set("type",a),l.$.set("score",n),l.$.set("criteria",e[d].criteria)}else(o=store.createRecord("segment_criteria")).$.set("type",a),o.$.set("score",n),o.$.set("criteria",e[d].criteria),o.$.set("segments",t)}return i},pauseTheTransaction:function(e){var t=e.pause();return Lyte.Component.render("crm-segment-confirmation",{cancelButton:I18n.getMsg("crm.admin.email.sharing.confirmation.message2"),proceedButton:I18n.getMsg("crm.button.yes.move.away"),heading:I18n.getMsg("crm.event.layout.leavepage.confirm.message2"),message:I18n.getMsg("crm.cancel.segment")},"#result").setMethods({callBackMethod:function(){store.unloadAll("segments"),t.resume()},callCancelMethod:function(){t.abort()}}),!1},filterSliderDetails:function(e,t){if(t)for(var r=t.length,i=0;i<r;i++)if(t[i].score_type===e)return t[i]},checkValueExist:function(e,t){if(e)for(var r=e.length,i=0;i<r;i++)if(e[i].score_type===t)return!0;return!1},getNewApiVersion:function(){return{apiVersion:"2.2"}},getDefaultStageCriteria:function(e){var t=this.getStageFieldApiName(),r=e.find((e=>e.api_name===t));return{comparator:"equal",field:{api_name:t,id:r.id,data_type:r.data_type},value:"${CLOSEDWON}"}},checkStageFieldPermission:function(e){var t=this.getStageFieldApiName(),r=e.find((e=>e.api_name===t)).profiles.find((e=>e.name===Crm.userDetails.PROFILE_NAME));return r&&"hidden"!==r.permission_type},maxLookupLimit:function(){return 5},countLookupFieldsCount:function(e,t){var r=$L("#"+e),i=$L("#"+t);this.setData("lookUpFieldsInCriteria",[]),r.length&&this.countLookUpFields(r[0].component.data.setCriteriaObj),i.length&&this.countLookUpFields(i[0].component.data.setCriteriaObj)},countLookUpFields:function(e){var t,r;if(!e)return 0;e.forEach((e=>{t=this.getData("lookUpFieldsInCriteria"),r=store.peekRecord("field",e.field.id),"lookup"!==CrmField.getDataType(r.ui_type)||t.includes(r.id)||Lyte.arrayUtils(t,"push",r.id)})),t=this.getData("lookUpFieldsInCriteria"),Lyte.arrayUtils(t,"splice",0,t.length,t)},getStageFieldApiName:function(){return"Stage"},IsSegmentAvailable:async function(e){var t=networkUtils.returnDependencyFiles(["segmentation-financeSuit.js"],ResourceConstants.CRMClient);return!!e.includes("books")&&(commonUtils.showHideLoadingDiv(!0),t=(t=t.concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("SegmentationFinanceSuit")],ResourceConstants.CRM))).concat(networkUtils.returnDependencyFiles(["segmentation-model.js"],ResourceConstants.CRMClient)),await this.downloadresource(t),await this.getBookssegment())},getBookssegment:async function(){var e=!1,t=[],r={},i={},n=["CustomModule5001","CustomModule5002","CustomModule5003","CustomModule5004"],a={field:{api_name:"link_module.api_name"},comparator:"in",value:n},s={filters:JSON.stringify(a)};return store.unloadAll("segments"),await store.findAll("segments",s).then((function(){(i=store.peekAll("segments"))&&(i.forEach((e=>{n.includes(e.link_module.api_name)&&(r={id:e.id,name:e.name},t.push(r))})),t.length&&($L("crm-segment-financesuite-alert")[0].setData("segmentName",t),$L("#financesuiteAlert")[0].ltProp("show","true"),e=!0))}),(function(t){403===t.status&&(e=!1)})).finally((function(){commonUtils.showHideLoadingDiv(!1)})),e},downloadresource:async function(e){var t=new Promise((function(t){Lyte.injectResources(e,void 0,(function(){t()}))}));await t},loadSegmentationInfo:function(e,t,r,i){store.findRecord("rfm_entity",e,null,null,null,t).then((function(e){e&&e[0]&&((e=e[0]).$.set("module",t),r&&i.setData("isSegmentScoreAvailable",!0),Lyte.Component.render("related-list-segment",e,"#segmentation"),document.getElementById("segmentation").style.display="block")}))},compareCriteria:function(e,t){if(null==e||null==t)return!1;for(var r in e)if("object"==typeof e[r]){if(!this.compareCriteria(e[r],t[r]))return!1}else if("string"==typeof e[r]){if(t[r]&&e[r].toLowerCase()!==t[r].toLowerCase())return!1;if(void 0===t[r])return!1}else if(e[r]!==t[r])return!1;return!0},unloadAllSegmentModels:function(){store.unloadAll("segment_criteria"),store.unloadAll("segment_labels"),store.unloadAll("segments")}});
