function EmailSendingUtil(){}var dotAnimate;EmailSendingUtil.action="",EmailSendingUtil.defaultEditorHeight="",EmailSendingUtil.tempHeight=0,EmailSendingUtil.metaDetailHeight=0,EmailSendingUtil.summaryHeight=0,EmailSendingUtil.editorHeight=0,EmailSendingUtil.totalHeight=0,EmailSendingUtil.attachmentContainerHeight=0,EmailSendingUtil.fileCount=0,EmailSendingUtil.acResultIndex=0,EmailSendingUtil.statusArray={},EmailSendingUtil.moreResults={},EmailSendingUtil.toAddr="",EmailSendingUtil.toAddress="",EmailSendingUtil.ccAddr="",EmailSendingUtil.bccAddr="",EmailSendingUtil.replyToAddr="",EmailSendingUtil.subject="",EmailSendingUtil.mailBody="",EmailSendingUtil.signContent="",EmailSendingUtil.selectedEntityEmail="",EmailSendingUtil.ColleaugeImgURL="",EmailSendingUtil.numberOfEmailAddr=50,EmailSendingUtil.maxLimitExceedsMsg={},EmailSendingUtil.templateIdVsDetail={},EmailSendingUtil.moduleVsTempList={},EmailSendingUtil.numberOfAttachmentsAllowed=20,EmailSendingUtil.filesAttached=0,EmailSendingUtil.filesFlag=0,EmailSendingUtil.templatesFetched=!1,EmailSendingUtil.composeActive=!1,EmailSendingUtil.isEntityWindow=!1,EmailSendingUtil.isEmailProgressing=!1,EmailSendingUtil.mailSentStatus=!1,EmailSendingUtil.zohoDocsAttachIncluded=!1,EmailSendingUtil.displayName="",EmailSendingUtil.isSurvey=!1,EmailSendingUtil.activeModule="",EmailSendingUtil.URL=Crm.getCrmBasePath()+"/mailer/EmailSending.do",EmailSendingUtil.removeFileReq="removeFileFromZFS",EmailSendingUtil.LOAD_MORE_DRAFTS="loadMoreDrafts",EmailSendingUtil.attachDocuments="attachDocuments",EmailSendingUtil.attachIMAPDocuments="attachIMAPDoc",EmailSendingUtil.autoCompleteResultsReceived=!0,EmailSendingUtil.autoCompleteAjaxReceived=!0,EmailSendingUtil.isCrtlKeyPressed=!1,EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE="getEntitiesForAutoComplete",EmailSendingUtil.LEADS="Leads",EmailSendingUtil.CONTACTS="Contacts",EmailSendingUtil.POTENTIALS="Potentials",EmailSendingUtil.COLLEAGUES="Colleagues",EmailSendingUtil.ACCOUNTS="Accounts",EmailSendingUtil.VENDORS="Vendors",EmailSendingUtil.CASES="Cases",EmailSendingUtil.USERS="Users",EmailSendingUtil.CUSTOMODULE="",EmailSendingUtil.AutoCompleteModulesArray=[EmailSendingUtil.LEADS,EmailSendingUtil.CONTACTS,EmailSendingUtil.POTENTIALS,EmailSendingUtil.ACCOUNTS,EmailSendingUtil.VENDORS,EmailSendingUtil.CASES,EmailSendingUtil.COLLEAGUES,EmailSendingUtil.USERS],EmailSendingUtil.docsAttachmentArray=[],EmailSendingUtil.preLoadedAutoCompleteData={},EmailSendingUtil.AutoCompleteData={},EmailSendingUtil.bestTimeInterval=void 0,EmailSendingUtil.addTemplateHandlebar=null,EmailSendingUtil.templateValues={},EmailSendingUtil.hoverStatus=0,EmailSendingUtil.attachFileType="",EmailSendingUtil.attachZMAILDocuments="attachZmailDoc",EmailSendingUtil.attachGMAILDocuments="attachGmailDoc",EmailSendingUtil.mailType="",EmailSendingUtil.attachSentMailDocuments="",EmailSendingUtil.userDetails={},EmailSendingUtil.searchNotFoundStrings=[],EmailSendingUtil.ScheduledTime="",EmailSendingUtil.ScheduledDay="",EmailSendingUtil.bestTimeData=null,EmailSendingUtil.isConsentEmail=!1,EmailSendingUtil.isTemplateDumped=!1,EmailSendingUtil.consentEmail=!1,EmailSendingUtil.formsPage=1,EmailSendingUtil.formsPer_page=100,EmailSendingUtil.besttimeReqflag=!0,EmailSendingUtil.besttimeSetflag=!0,EmailSendingUtil.besttimedate="Today",EmailSendingUtil.singularMod="",EmailSendingUtil.switchedToOldEditor=!1,EmailSendingUtil.entityId="",EmailSendingUtil.view="",EmailSendingUtil.tempEditor="",EmailSendingUtil.tempContent="",EmailSendingUtil.attachArray=[],EmailSendingUtil.inventObj=void 0,EmailSendingUtil.dataReqObj=void 0,EmailSendingUtil.showFeedBack=!1,EmailSendingUtil.draftId="",EmailSendingUtil.ScheduleText="",EmailSendingUtil.SwitchedFromOldToNew=!1,EmailSendingUtil.OrgEmailArray=[],EmailSendingUtil.isReplyClicked=!1,EmailSendingUtil.isPrivacyEnabled=!1,EmailSendingUtil.isOrgEmailFlow=!1,EmailSendingUtil.oldScheduleText=void 0,EmailSendingUtil.oldScheduleval=void 0,EmailSendingUtil.signDetails="",EmailSendingUtil.fromAddr="",EmailSendingUtil.templatecontentStyle=void 0,EmailSendingUtil.replyTo="",EmailSendingUtil.module="",EmailSendingUtil.switchPlaineditor=!1,EmailSendingUtil.isOrgEmail=[],EmailSendingUtil.relayEnabledDomains=[],EmailSendingUtil.isLoadTemplate=!1,EmailSendingUtil.isFromCscript=null,EmailSendingUtil.templateData="",EmailSendingUtil.isSignatureForOldFlow=!1,EmailSendingUtil.isSendMailActionCalled=!1,EmailSendingUtil.openTabALertPopup=!1,EmailSendingUtil.removeFocus=!1,EmailSendingUtil.other_emails_array=[],EmailSendingUtil.pMailContent=[],EmailSendingUtil.templateIdVsContent={},EmailSendingUtil.emailAddedFromComponent=!1,EmailSendingUtil.showHideEditorTools=function(e){var i=$(".ceVariousTextFormattingOptionContainer");"plaintext"===e?(i.addClass("plainTextFormat"),i.hide(),$("#plainTextBtn").hide(),$("#emailEditorFormattingIcon").show()):(i.show(),i.removeClass("plainTextFormat"),$("#emailEditorFormattingIcon").hide(),$("#plainTextBtn").show())},EmailSendingUtil.initialize=function(e){EmailSendingUtil.showHideEditorTools(e),EmailSendingUtil.zeCreate(e),setTimeout(EmailSendingUtil.doBindings,300),EmailSendingUtil.HideEmptyfields(),EmailSendingUtil.templatesFetched=!1,EmailSendingUtil.activeModule="",EmailSendingUtil.populateWindowElementsHeight(),window.addEventListener("resize",(function(){EmailSendingUtil.defaultEditorHeight=$(document).height()-218,$("#ecDisplayAttachmentNames").outerHeight()>0&&(EmailSendingUtil.defaultEditorHeight=EmailSendingUtil.defaultEditorHeight-40),EmailSendingUtil.populateWindowElementsHeight()})),EmailSendingUtil.besttimeReqflag&&EmailSendingUtil.setBestTime(new Date),setTimeout(EmailSendingUtil.initiateAttachment,200),EmailSendingUtil.action!==EmailTabHomeUtil.FORWARD&&EmailSendingUtil.action!==EmailTabHomeUtil.COMPOSE||$("#ceToAddr").focus(),$("#emailTempModule").val(""),EmailSendingUtil.featureSpecificHandling()},EmailSendingUtil.zeCreate=function(e){var i={id:"emailEditor",editorheight:EmailSendingUtil.defaultEditorHeight};editor=ZE.create(i),editor.setMode(e),editor.afterEditorLoad((function(){EmailSendingUtil.populateContentsOnReply(),EmailSendingUtil.isEntityWindow&&afterEditorLoad(),CustomizeEditor.init("emailEditor"),$(".ceVariousTextFormattingOptionContainer").find("li").mousedown((function(e){e.preventDefault()}))}))},EmailSendingUtil.populateContentsOnReply=function(){"editInCompose"===EmailSendingUtil.action&&($(window).on("beforeunload",(function(e){return"You have some unsaved changes"})),$(window).on("unload",(function(e){})));var e=EmailSendingUtil.toAddr;"null"!==e&&EmailSendingUtil.action!==EmailTabHomeUtil.FORWARD&&e.length>5&&(EmailSendingUtil.populateAddrForReply(e,"ceToAddr",EmailSendingUtil.action),EmailSendingUtil.selectedEntityEmail=e);var i=EmailSendingUtil.ccAddr;"null"!=i&&i.length>5&&(EmailSendingUtil.newshowHideoptions($("#ceCcLink"),"cc"),EmailSendingUtil.populateAddrForReply(i,"ceCCAddr",EmailSendingUtil.action),EmailSendingUtil.resizeEditorHeight());var t=EmailSendingUtil.bccAddr;"null"!=t&&t.length>5&&(EmailSendingUtil.newshowHideoptions($("#ceBccLink"),"bcc"),EmailSendingUtil.populateAddrForReply(t,"ceBCCAddr",EmailSendingUtil.action),EmailSendingUtil.resizeEditorHeight());var a=EmailSendingUtil.replyToAddr;"null"!=a&&a.length>5&&($("#ceReplyToAddr").val(a),$("#ceOption_replyto").removeClass("hide"),$("#ceReplyToAddrSpan").attr("selectedval",a).text(a),EmailSendingUtil.resizeEditorHeight());var l=EmailSendingUtil.subject;"null"!=l&&l.length>0&&($("#ceSubject").val(l),$("#ceSubject1").val(l));var o=EmailSendingUtil.mailBody,n=o;EmailSendingUtil.signContent&&""!=EmailSendingUtil.signContent&&0==window.opener.$("#openInNewComposeWindow").length&&(o=EmailSendingUtil.signContent+o),EmailSendingUtil.isSurvey&&(ZSurvey.insertTextMail(),o=ZSurvey.getSurveyLinkForMail()+o),"null"!=o&&(editor.setContent(o),EmailSendingUtil.action!==EmailTabHomeUtil.FORWARD&&EmailSendingUtil.action!==EmailTabHomeUtil.REPLY&&EmailSendingUtil.action!==EmailTabHomeUtil.REPLYALL||($("#previousMailContent").val(o),$("#previousMailContentWithOutSign").val(n))),EmailSendingUtil.action===EmailActionHandling.LOAD_DRAFT&&EmailActionHandling.setDraftDetails()},EmailSendingUtil.populateAddrForReply=function(e,i,t){if(t===EmailActionHandling.LOAD_DRAFT)EmailSendingUtil.populateAddrForDrafts(e,i);else{EmailSendingUtil.isEntityWindow&&"ceToAddr"===i&&"editInCompose"!==t&&t!==EmailTabHomeUtil.REPLYALL&&(e=e.split(",")[0]);for(var a=e.split(","),l=a.length,o=0;o<l;o++){var n=null,s=a[o],m=s.lastIndexOf("<"),r=s.lastIndexOf(">");m>0&&r>m&&(n=s.substring(0,m),s=s.substring(m+1,r)),EmailSendingUtil.setUnameAndEmail(s,n,null,$("#"+i).closest("li"))}}},EmailSendingUtil.populateAddrForDrafts=function(e,i){for(var t=JSON.parse(e),a=0;a<t.length;a++){var l=t[a],o="",n=l.MODULE?l.MODULE:"";l.PHOTOID&&("Contacts"===n||"Leads"===n||"Potentials"===n?o=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+("Potentials"===n?"Contacts":n)+"&entityId="+l.ENTITYID+"&actionName=readImage&fileId="+l.PHOTOID:"Colleagues"===l.MODULE&&(o=window.location.protocol+"//"+EmailSendingUtil.ColleaugeImgURL+"/file?ID="+l.PHOTOID+"&fs=thumb")),EmailSendingUtil.setUnameAndEmail(l.EMAIL,l.NAME,o,$("#"+i).closest("li"),l.ENTITYID,l.MODULE,l.PHOTOID)}},EmailSendingUtil.validateMailData=function(){var e=editor.getContent();if(EmailSendingUtil.templatecontentStyle&&(e="<html><head>"+EmailSendingUtil.templatecontentStyle+"</head><body>"+e+"</body></html>"),e.length>16e6)return Crm.showAlertMsg(I18n.getMsg("crm.email.char.max.msg")),!1;if("Script tags found"==e)return!1;if(null!=(i=$("#jsonForMergefields").data("mergeFieldsData"))&&null!=i&&(e=this.convertMergeFieldstoFieldIds(e,i)),$("#editorMode").val(editor.mode),"plaintext"==editor.mode?$("#descriptionInPlainText").val(e):$("#description").val(e),!EmailSendingUtil.validateEmailFieldsOfToCcBcc("ceToAddr","ceCCAddr","ceBCCAddr",EmailSendingUtil.maxLimitExceedsMsg.toCcBcc))return!1;if(!EmailSendingUtil.validateAllEmailFields("ceToAddr",!0,EmailSendingUtil.numberOfEmailAddr,I18n.getMsg("crm.email.toaddr.empty"),I18n.getMsg("crm.email.toaddr.provide.valid")))return!1;if(!EmailSendingUtil.missedAttachmentInBody())return!1;if(!EmailSendingUtil.validateAllEmailFields("ceCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.ccaddr.provide.valid")))return!1;if(!EmailSendingUtil.validateAllEmailFields("ceBCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.bccaddr.provide.valid")))return!1;if(!EmailSendingUtil.validateAllEmailFields("ceReplyToAddr",!1,1,null,I18n.getMsg("crm.email.replyaddr.provide.valid")))return!1;if($("#ceReplyToAddrDetails .selectedEmail").length>1)return Crm.showAlertMsg(maxLimitExceedMsg),!1;EmailSendingUtil.selectedEmailMatches()||EmailSendingUtil.isEntityWindow||($("#moduleName").val(""),$("#ecEntityId").val(""));var i,t=$("#ceSubject1").val();t&&t.length>250&&(t=t.substring(0,250),$("#ceSubject1").val(t),$("#ceSubject").val(t));if(t&&commonUtils.showHideLoadingDiv(!0),null!=(i=$("#jsonForMergefields").data("mergeFieldsData"))&&null!=i&&(t=this.convertMergeFieldstoFieldIds(t,i),$("#ceSubject").val(t)),EmailSendingUtil.filesFlag>0)return Crm.showAlertMsg(I18n.getMsg("crm.email.attach.inprogess")),!1;var a=EmailSendingUtil.calculateFileSize();if(a>10485760)return Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.restriction.individual.error1")),!1;if(a>0&&EmailSendingUtil.zohoDocsAttachIncluded)for(var l=$("#ecDisplayAttachmentNames").find(".ecAttachmentDispPattern").length,o=0;o<l;o++){var n=$("#ecDisplayAttachmentNames").find(".ecAttachmentDispPattern")[o];$(n).find("span").text($(n).attr("filename"))}return EmailSendingUtil.composeActive=!1,!0},EmailSendingUtil.missedAttachmentInBody=function(){var e=$(".ze_area").contents().find(".ze_body").contents().filter((function(e,i){return!$(i).hasClass("mcPreviousMailContent")}));return 0===(e=$(e).text()).length||(!((e.toLowerCase().indexOf("I have attached".toLowerCase())>-1||e.toLowerCase().indexOf("I have an attachment".toLowerCase())>-1||e.toLowerCase().indexOf("I've attached".toLowerCase())>-1||e.toLowerCase().indexOf("I have included".toLowerCase())>-1||e.toLowerCase().indexOf("I've included".toLowerCase())>-1||e.toLowerCase().indexOf("see the attached".toLowerCase())>-1||e.toLowerCase().indexOf("see the attachment".toLowerCase())>-1||e.toLowerCase().indexOf("attached file".toLowerCase())>-1||e.toLowerCase().indexOf("I attached a file".toLowerCase())>-1)&&!($("#ecDisplayAttachmentNames").is(":visible")&&$("#ecDisplayAttachmentNames").height()>0||confirm("It seems that you might have forgotten to attach files.Send this message without attachments?")))||($(".ze_area").contents().find("body").focus(),!1))},EmailSendingUtil.validateAllEmailFields=function(e,i,t,a,l){var o=$("#"+e);if(0===o.length)return!0;var n=o.val().trim();return""!==n&&EmailSendingUtil.setUnameAndEmail(n,"",null,o.closest("li")),$("#"+e+"Details .invalidEmail").length>0?(Crm.showAlertMsg(l),!1):"ceToAddr"!=e||0!=$("#"+e+"Details .selectedEmail").length||(Crm.showAlertMsg(a),!1)},EmailSendingUtil.validateEmailFieldsOfToCcBcc=function(e,i,t,a){var l=$("#"+e+"Details .selectedEmail").length,o=$("#"+i+"Details .selectedEmail").length,n=$("#"+t+"Details .selectedEmail").length;if(l+o+n>EmailSendingUtil.numberOfEmailAddr)return Crm.showAlertMsg(a),!1;var s=editor.getContent();if(-1!==s.indexOf("${Unsubscribe")&&s.indexOf("${Unsubscribe")!==s.lastIndexOf("${Unsubscribe"))return Crm.showAlertMsg(I18n.getMsg("crm.unsubscription.linklimit")),!1;var m="IMAP"!=$("#mailConfigType").val()||EmailSendingUtil.isOrgEmailFlow?1:10;return!(-1!==s.search(/\$\{Unsubscribe\.(.*?)\}/)&&l+o+n>m)||(Crm.showAlertMsg(I18n.getMsg("crm.email.toaddr.provide.nomore",m)),!1)},EmailSendingUtil.validate=function(e){if($("#ceFromAddr").val($("#addrsVal").attr("selectedval")),$("#ceReplyToAddr").val($("#ceReplyToAddrSpan").attr("selectedVal")),!EmailSendingUtil.isEmailProgressing&&EmailSendingUtil.validateMailData()){if(!e){if(""==$("#ceSubject1").val().trim()){var i=prompt(I18n.getMsg("crm.email.specify.subject"));if(i&&i.length>250)i=i.substring(0,250);else if(null==i||""==i)return Crm.showAlertMsg(I18n.getMsg("crm.field.empty.check",I18n.getMsg("crm.label.subject"))),!1;$("#ceSubject1").val(i);var t=$("#jsonForMergefields").data("mergeFieldsData");null!=t&&null!=t&&(i=this.convertMergeFieldstoFieldIds(i,t)),$("#ceSubject").val(i),commonUtils.showHideLoadingDiv(!0)}var a=!0;if(-1===editor.getContent().search(/\$\{ConsentForm\.[a-zA-Z0-9_]+\}/))if(EmailSendingUtil.isTemplateDumped){if(EmailSendingUtil.isTemplateDumped){-1===editor.getContent().search(/\/crm\/MyConsentPortal\?id=([a-z0-9A-z]*)/)&&(a=!1)}}else a=!1;if(!0===a)EmailSendingUtil.isConsentEmail||$(getOpenerObj("dataPrivacyContainerDiv")).html(""),$(sendMailForm).find('input[name="isConsentEmail"]').val("true");else if(EmailSendingUtil.isConsentEmail)return crmui.showMsgBand("error",I18n.getMsg("crm.send.consent.link.missing.message"),5e3),CustomizeEditor.mapClicks($(".ceSvgEmbedLink").closest("li")),!1;EmailSendingUtil.setEmailAddresses();var l=$("#moduleName").val(),o=$("#emailTempModule").val();if(l&&o&&l!=o){var n={};return n.info=I18n.getMsg("crm.email.module.differ.alert"),EmailTabHomeUtil.customConfirmation(n,(function(){EmailSendingUtil.validate(!0)})),!1}}if(EmailSendingUtil.isEntityWindow)EmailSendingUtil.sendingPopup(),EmailSendingUtil.setEntityAttachDetails();else{var s=$("#emc_msg_Tab");s.css("left",(EmailTabHomeUtil.ViewPortWidth-s.outerWidth())/2).show(),s.attr("data-zcqa","emc_SendTab_SendingMail"),s.css({"z-index":"102"}),s.html("Sending Mail")}return EmailSendingUtil.isEmailProgressing=!0,$("#editorMode").val(editor.mode),e&&document.sendMailForm.submit(),Macro.autoSuggest(l,!1),!0}return commonUtils.showHideLoadingDiv(!1),!1},EmailSendingUtil.showError=function(){var e=$("#emc_msg_Tab");e.css("left",($(document).outerWidth()-e.outerWidth())/2).show(),emc_msg_Tab.css({"z-index":"100"})},EmailSendingUtil.setEmailAddresses=function(){if($("#ceToAddrDetails .selectedEmail").length>0&&($("#ceToAddrDetails").parent().find("#toAddress").val(EmailSendingUtil.getCommaSeparatedEmails("ceToAddrDetails")),$("#ceToAddrDetails").parent().find("#toAddrUname").val(EmailSendingUtil.getCommaSeparatedUsernames("ceToAddrDetails"))),$("#ceCCAddrDetails .selectedEmail").length>0&&($("#ceCCAddrDetails").parent().find("#ccAddress").val(EmailSendingUtil.getCommaSeparatedEmails("ceCCAddrDetails")),$("#ceCCAddrDetails").parent().find("#ccAddrUname").val(EmailSendingUtil.getCommaSeparatedUsernames("ceCCAddrDetails"))),$("#ceBCCAddrDetails .selectedEmail").length>0&&($("#ceBCCAddrDetails").parent().find("#bccAddress").val(EmailSendingUtil.getCommaSeparatedEmails("ceBCCAddrDetails")),$("#ceBCCAddrDetails").parent().find("#bccAddrUname").val(EmailSendingUtil.getCommaSeparatedUsernames("ceBCCAddrDetails"))),!EmailSendingUtil.isEntityWindow){var e=$("#ceToAddrDetails li")[0];if(""!=$(e).attr("module")&&"null"!=$(e).attr("module")&&""!=$(e).attr("entityid")&&"null"!=$(e).attr("entityid")){var i=$(e).attr("entityid");$("#moduleName").val($(e).attr("module")),$("#ecEntityId").val(i);var t=EmailComposeUtil.entityIdVsTabIds[i];t&&t.length>0&&t.push(EmailComposeUtil.CURRENT_TAB),t&&0===t.length&&(t=[EmailComposeUtil.CURRENT_TAB])}}},EmailSendingUtil.resetEmailAddresses=function(){$("#ceToAddrDetails").parent(),$("#ceCCAddrDetails").parent(),$("#ceBCCAddrDetails").parent();var e=$("#toAddress"),i=$("#toAddrUname");$("#ceToAddrDetails .selectedEmail").length>=0?(e.val(EmailSendingUtil.getCommaSeparatedEmails("ceToAddrDetails")),i.val(EmailSendingUtil.getCommaSeparatedUsernames("ceToAddrDetails"))):(e.val(""),i.val(""));var t=$("#ccAddress"),a=$("#ccAddrUname");$("#ceCCAddrDetails .selectedEmail").length>=0?(t.val(EmailSendingUtil.getCommaSeparatedEmails("ceCCAddrDetails")),a.val(EmailSendingUtil.getCommaSeparatedUsernames("ceCCAddrDetails"))):(t.val(""),a.val(""));var l=$("#bccAddress"),o=$("#bccAddrUname");$("#ceBCCAddrDetails .selectedEmail").length>=0?(l.val(EmailSendingUtil.getCommaSeparatedEmails("ceBCCAddrDetails")),o.val(EmailSendingUtil.getCommaSeparatedUsernames("ceBCCAddrDetails"))):(l.val(""),o.val(""))},EmailSendingUtil.getCommaSeparatedEmails=function(e){var i=[];return $("#"+e+" .selectedEmail").each((function(){!1===i.contains($(this).attr("email"))&&i.push($(this).attr("email"))})),i.toString()},EmailSendingUtil.getCommaSeparatedUsernames=function(e){var i="",t=[];return $("#"+e+" .selectedEmail").each((function(){-1===t.indexOf($(this).attr("email"))&&(t.push($(this).attr("email")),""!=$(this).attr("username")?i+=""==i?$(this).attr("username"):","+$(this).attr("username"):i+=""==i?$(this).attr("email"):","+$(this).attr("email"))})),i},EmailSendingUtil.getUserNameWithEmail=function(e){var i="[]";if($("#"+e+"Details li").length>0){var t=[];$("#"+e+"Details li").each((function(){if(!$(this).hasClass("ecAddrEditor")){var e={};e.NAME=$(this).attr("username"),e.EMAIL=$(this).attr("email"),e.ENTITYID=$(this).attr("entityid"),e.PHOTOID=$(this).attr("phid"),e.MODULE=$(this).attr("module"),t.push(e)}})),i=JSON.stringify(t)}return i},EmailSendingUtil.getUserNameWithEmailForSwitch=function(e){var i="[]";if($("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" li").length>0){var t=[];$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" li").each((function(){if(!$(this).hasClass("ecAddrEditor")){var e={};e.NAME=$(this).attr("username"),e.EMAIL=$(this).attr("email"),e.ENTITYID=$(this).attr("entityid"),e.PHOTOID=$(this).attr("phid"),e.MODULE=$(this).attr("module"),t.push(e)}})),i=JSON.stringify(t)}return i},EmailSendingUtil.selectedEmailMatches=function(){var e=$("#ceToAddr").val();return EmailSendingUtil.isNewEditor()&&(e=$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).val()),e||(e=""),e=(e=e.replace(/\s+/g,"")).substring(0,e.indexOf(",")),EmailSendingUtil.selectedEntityEmail===e},EmailSendingUtil.doBindings=function(){var e=$(".ze_area"),i=e.height();e.css("height",i),e.contents().find("body").css("height",i-30),e.attr("data-zcqa","emc_ze_area"),EmailSendingUtil.toggleClickEventForEditor("bind"),$(".ceComposeSummary").on("click",EmailSendingUtil.displayComposeMetaFields),$(".attachFile").click((function(e){renderingUtils.triggerEvent("click",$(".smFile"))}));var t=$(window).height();$(window).resize((function(){var a=t>$(window).height()?t-$(window).height():$(window).height()-t;e.outerHeight()>30?(i=t>$(window).height()?e.outerHeight()-a:e.outerHeight()+a,e.css("height",i),$("#emailEditor").css("height",i),e.contents().find("body").css("height",i-30),t=$(window).height()):($("#emailEditor").css("height","31px"),e.css("height","31px"),e.contents().find("body").css("height","1px"),t=$(window).height())}))},EmailSendingUtil.toggleClickEventForEditor=function(e){"bind"==e?$(".ze_area").contents().find("body").on("click",(function(){EmailSendingUtil.showComposeMetaSummary(),EmailSendingUtil.hideEditorPopups()})):"unbind"==e&&($(".ze_area").contents().find("body").off("click"),EmailSendingUtil.hideEditorPopups())},EmailSendingUtil.hideEditorPopups=function(){$("#ceVariousAttachmentOptionContainer ,.ceToolBarPopupActions").hide(),$("#etSchedulePopId").addClass("hide")},EmailSendingUtil.summarizeUserNameandEmail=function(e){e||(e=["ceToAddr","ceCCAddr","ceBCCAddr"],EmailSendingUtil.isNewEditor()&&((e=[])[0]="ceToAddr_"+EmailComposeUtil.CURRENT_TAB,e[1]="ceCCAddr_"+EmailComposeUtil.CURRENT_TAB,e[2]="ceBCCAddr_"+EmailComposeUtil.CURRENT_TAB)),$.each(e,(function(e,i){var t=$("#"+i).closest("ul").find("li:not(.ecAddrEditor)").find('input[type="text"]:not(.hide)');t.length>0&&$.each(t,(function(e,i){EmailSendingUtil.rectifyEmail(i)}))}))},EmailSendingUtil.showComposeMetaSummary=function(){EmailSendingUtil.summarizeUserNameandEmail(),""!=$("#ceToAddr").val()&&$("#ceToAddr").val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($("#ceToAddr").val()),EmailSendingUtil.formattedUsernameFromEmail($("#ceToAddr").val()),null,$("#ceToAddr").closest("li")),""!=$("#ceCCAddr").val()&&$("#ceCCAddr").val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($("#ceCCAddr").val()),EmailSendingUtil.formattedUsernameFromEmail($("#ceCCAddr").val()),null,$("#ceCCAddr").closest("li")),""!=$("#ceBCCAddr").val()&&$("#ceBCCAddr").val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($("#ceBCCAddr").val()),EmailSendingUtil.formattedUsernameFromEmail($("#ceBCCAddr").val()),null,$("#ceBCCAddr").closest("li"));var e="";$("#ceOption_replyto").is(":visible")&&$("#ceReplyToAddrSpan").attr("selectedval").replace(/\s/g,"").length>5&&(e+=" <b>"+I18n.getMsg("crm.label.reply.to")+"</b> "+$ESAPI.encoder().encodeForHTML($("#ceReplyToAddrSpan").attr("selectedval")));var i="<span class='dB lh20 fL'><span class='etsColumnLabel crm-base-font-size  mR5 mT1 fL'>"+I18n.getMsg("crm.label.to.email")+"</span>"+$ESAPI.encoder().encodeForHTML(EmailSendingUtil.getDisplayAddresses("ceToAddr"))+"</span>";0==$("#ceToAddrDetails li").length&&(i="<span class='etsColumnLabel crm-base-font-size mR5'>"+I18n.getMsg("crm.label.to.email")+"</span> <span style='color:#434D5F;'></span>"),$("#ceCCAddrDetails li").length>1&&(i+="<span class='dB lh20 fL'><span class='etsColumnLabel crm-base-font-size mR5 mL10 mT1 fL'>"+I18n.getMsg("crm.label.cc.email")+"</span>"+$ESAPI.encoder().encodeForHTML(EmailSendingUtil.getDisplayAddresses("ceCCAddr"))+"</span>"),$("#ceBCCAddrDetails li").length>1&&(i+="<span class='dB lh20 fL'><span class='etsColumnLabel crm-base-font-size mR5 mL10 mT1 fL'>"+I18n.getMsg("crm.label.bcc.email")+"</span> "+$ESAPI.encoder().encodeForHTML(EmailSendingUtil.getDisplayAddresses("ceBCCAddr"))+"</span>"),i=i.replace(/,/g,", ");var t=$(".ceSenderInfo"),a=$(".ceReceiverInfo");""!=e?(t.find(".pR").html(e),t.show()):t.hide(),a.find(".pR").html(i),$("#ceReplyToLink").length>0&&!$("#ceOption_replyto").is(":visible")||$("#ceReplyToLink").addClass("hide"),$(".ceComposeMeta").hide(),a.show();$("#ecDisplayAttachmentNames").is(":visible")&&$("#ecDisplayAttachmentNames").height();var l=$("#emailComposeContainer").height();l<=0&&(l=EmailTabHomeUtil.ViewPortHeight-60),$("#ecAutoCompleteContainer").addClass("hide"),EmailSendingUtil.toggleClickEventForEditor("unbind"),EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.getDisplayAddresses=function(e){var i="";return $("#"+e+"Details li").length>1&&$("#"+e+"Details li").each((function(){$(this).hasClass("ecAddrEditor")||(""!=$(this).attr("username")?i+=""==i?$(this).attr("username"):","+$(this).attr("username"):i+=""==i?$(this).attr("email"):","+$(this).attr("email"))})),i},EmailSendingUtil.getFormattedEmailAndUserName=function(e){var i=[],t=e.lastIndexOf("<"),a=e.lastIndexOf(">");if(t>0&&a>t){var l=e.substring(0,t);e=e.substring(t+1,a),i.push(e),l=l.replace(/;/g,"").replace(/:/g,"").replace(/>/g,"").replace(/</g,""),i.push(l)}else i.push(e),i.push(e);return i},EmailSendingUtil.removeHTMLTags=function(e){var i=e.replace(/</g,"&lt;");return i=i.replace(/>/g,"&gt;")},EmailSendingUtil.populateAddnEmail=function(e,i){$("#addSecondaryEmail").hide();var t="",a="",l="",o=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM),n="selectedEmail",s="selectedEmail";if(i.indexOf(",")>-1){t=i.substr(i.indexOf(",")+1),i=i.substr(0,i.indexOf(","));var m=this.getFormattedEmailAndUserName(i),r=this.getFormattedEmailAndUserName(t);i=m[0],a=m[1],t=r[0],l=r[1]}if(validationUtils.isValidEmail(i)||(s="invalidEmail"),validationUtils.isValidEmail(t)||(n="invalidEmail"),i=$ESAPI.encoder().encodeForHTMLAttribute(i),a=$ESAPI.encoder().encodeForHTMLAttribute(a),t=$ESAPI.encoder().encodeForHTMLAttribute(t),l=$ESAPI.encoder().encodeForHTMLAttribute(l),"EA"==e){var d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d=(d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>")+"<li class='fL "+n+"' username='"+l+"' email='"+t+"' >",d=(d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>")+"</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_"+$ESAPI.encoder().encodeForHTMLAttribute(i)+"' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else if("AO"==e){d="<li class='fL "+n+"' username='"+l+"' email='"+t+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else{d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}$("#ceToAddrDetails").html(""),d+="<li class='fL ecAddrEditor w100' id='liToAddresDetails' style='background:var(--bg_white);'><input data-zcqa='emc_ceToAddr' initialliselection='true' autocomplete='off' class='fL ecTxtboxes mT2' type='text' onkeydown='EmailSendingUtil.handleKeyDownEventsForAutoComplete(this,event);sE(event);' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete(this,event);sE(event);' onpaste='EmailSendingUtil.handlePasteEventForAutoComplete(this);sE(event);' onfocus='EmailSendingUtil.isCrtlKeyPressed = false;sE(event);' placeholder='' id='ceToAddr' onclick='sE(event)' value='' style='width: 54px;'></li>",$("#ceToAddrDetails").html(d),$(".liToAddresDetails").html("")},EmailSendingUtil.displayComposeMetaFields=function(){if($(".ceComposeSummary").hide(),$(".ceComposeMeta").show(),$("#ceToAddr").focus(),$("#ecDisplayAttachmentNames").is(":visible")&&$("#ecDisplayAttachmentNames").height()>0)$("#ecDisplayAttachmentNames").height();$("#ceReplyToLink").length>0&&!$("#ceOption_replyto").is(":visible")&&$("#ceReplyToLink").removeClass("hide"),EmailSendingUtil.resizeEditorHeight(),EmailSendingUtil.toggleClickEventForEditor("bind")},EmailSendingUtil.postFormSubmission=function(e,i,t,a,l,o,n,s,m){var r=$("#emc_msg_Tab");if(r.css("left",(EmailTabHomeUtil.ViewPortWidth-r.outerWidth())/2).show(),r.css({"z-index":"100"}),commonUtils.showHideLoadingDiv(!1),"SUCCESS"==e)r.attr("data-zcqa","emc_SendTab_Success"),EmailSendingUtil.isEntityWindow?($(window).off("beforeunload"),$(window).off("unload"),$("#emc_msg_Tab").hide(),$("#bestTime").length>0&&$("#bestTime").is(":checked")&&""!==$("#bestTime").val()?$("#emailEntityComposepopup").html(I18n.getMsg("crm.case.schedule.message")):$("#emailEntityComposepopup").html(I18n.getMsg("crm.case.sent.message")),$("#cmpKanbanView").length>0&&"true"==$("#cmpKanbanView").val()&&$("#cmpCloseWindowOptn").length?renderingUtils.triggerEvent("click",$("#cmpCloseWindowOptn")):((getOpenerObj("relatedPageContent")||opener.document.querySelector("crm-emailsrl-canvas-view")||opener.document.querySelector("crm-zsurvey-rl-label"))&&(getOpenerObj("navigationRefreshKey")&&$(getOpenerObj("emailDetailIframeContent")).is(":visible")?$(getOpenerObj("navigationRefreshKey")).html("true"):(EmailSendingUtil.refreshEmailRelList(),EmailSendingUtil.isConsentEmail&&opener.DataPrivacy.loadDataPrivacy($("#newleft_DataPrivacy")),"null"!==m&&void 0!==m&&$(getOpenerObj("dataRequestMailLink_"+m)).removeClass("dataRequestMailLink cP").text(I18n.getMsg("crm.data.subject.mail.sent")).unbind("click").addClass("eventNone"))),EmailSendingUtil.showFeedBack?showSwitchReasonSurvey():setTimeout((function(){window.self.close()}),4e3))):(r.hide(),r.removeAttr("data-zcqa"),EmailActionHandling.closeCompose(EmailSendingUtil.action,!0,i,t,a,n,s),EmailSendingUtil.constructDivElements(i,o,t,l,"CRM_EMAIL"),EmailSendingUtil.fetchMailsFromFolder("Sent")),EmailSendingUtil.mailSentStatus=!0;else{if(r.hide(),e.indexOf(I18n.getMsg("crm.email.spam"))>-1){var d=e.split("::");e=d[0];var c=d[1];if(r.html(e+" "),null!=c&&""!==c&&"null"!==c){var p=document.createElement("a");p.setAttribute("id","EditTemplate"),p.setAttribute("href",Crm.getCrmBasePath()+"/settings/templates?type=email&step=edit&templateId="+c);var E=$("#ecTemplateId").val();void 0!==EmailSendingUtil.templateIdVsDetail[E]&&delete EmailSendingUtil.templateIdVsDetail[E],p.setAttribute("target","_blank"),p.text=" "+I18n.getMsg("crm.templates.edit.template"),document.getElementById("emc_msg_Tab").append(p)}}else e.includes("Mail Sending Failed! Your SMTP server does not allow sending emails to addresses which contain special and/or foreign characters")||e.includes("Error while processing the request! javax.mail.MessagingException: 5.5.2 Syntax error")?r.html(I18n.getMsg("chatacters_not_allowed_by_smtp_server")):r.html(e);r.attr("data-zcqa","emc_SendTab_Error"),EmailSendingUtil.isEntityWindow?($("#emailEntityComposeOverlay").hide(),$("#emailEntityComposepopup").hide(),setTimeout((function(){r.show().css("left",($(document).outerWidth()-r.outerWidth())/2)}),100)):setTimeout((function(){r.show().css("left",(EmailTabHomeUtil.ViewPortWidth-r.outerWidth())/2)}),100),setTimeout((function(){$("#emc_msg_Tab").hide(),r.removeAttr("data-zcqa"),$("#emc_msg_Tab").html("Loading...")}),8e3)}EmailSendingUtil.isEmailProgressing=!1},EmailSendingUtil.fetchMailsFromFolder=function(e){setTimeout((function(){var i="action=fetchMails&folder="+e;i+="&"+csrfParamName+"="+csrfToken,$.ajax({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:EmailSendingUtil.URL,data:i})}),2e3)},EmailSendingUtil.refreshEmailRelList=function(){var e=getOpenerObj("module").value,i=getOpenerObj("id").value,t=$("#selectMails"),a=t.length>0?t:$(getOpenerObj("selectMails")),l=/\d/.test(a.attr("lt-prop-selected"))?"":a.attr("lt-prop-selected");if(getOpenerObj("emailId")){var o=getOpenerObj("emailId").value,n=getOpenerObj("fullname").value,s=getOpenerObj("mailListRelId").value,m="";m="Potentials"==e?getOpenerObj("id").value:getOpenerObj("entityId").value,null!=getOpenerObj("isFromNewAPI")||$("#isFromNewAPI").length>0?"Schedule"==$("#emcSendBtn").val()?showMailsListViaAPI(l,"-10","next",null,"scheduledMails"):showMailsListViaAPI(l,"-10","next",null,"mails"):showMailsList(m,o,n,s,"-10","next","","false",e)}else opener.document.querySelector("crm-zsurvey-rl-label")&&opener.ZSurvey.refreshSurveyPersonality(e,i)},EmailSendingUtil.constructDivElements=function(e,i,t,a,l){var o='<input type="button" onclick="return addNote(\''+e+"','"+i+"', '"+t+"','"+a+"', '"+l+'\');" value="save" class="button hideNs" style="margin-top:2px; border:1px solid #999;" id="save_comment">';o+='<a href="javascript:;" onclick="$(\'#noteCreation\').hide()" class="pL5 sl hideNs">close</a>',$("#addRMButton").html(o)},EmailSendingUtil.resizeEditorHeight=function(e){e="number"==typeof e?e:35,EmailSendingUtil.setWindowElementsHeight()},EmailSendingUtil.showAttachmentNFormattingOptions=function(e,i){var t=$("#ceVariousAttachmentOptionContainer")[0];if(t&&""===t.style.display)t.style.display="none";else{$(".ceAttachmentAndFormatterImg span").css("color","#888"),$(e).find("span").css("color","#222");var a=$(e).offset(),l=200;"-180px"==$("#etleftNavContainer").css("left")&&(l=20),EmailSendingUtil.isEntityWindow&&(l=0);var o=a.left-($("#ceVariousAttachmentOptionContainer").outerWidth()/2+l);Crm.userDetails.RTL_ENABLED&&(o=a.right-($("#ceVariousAttachmentOptionContainer").outerWidth()/2+l)),"formatting"===i?($("#emailEditorFormattingIcon").hide(),$(".selectedBtn").removeClass("selectedBtn"),$("#emcSaveandSendBtn").hide(),$("#ceVariousAttachmentOptionContainer").fadeOut(200),$(".ceVariousTextFormattingOptionContainer").css({left:$("#ecMailOptions").outerWidth()}).show(),CustomizeEditor.toogleRichTextAndPlainText(e)):"attachments"===i&&($("#emcSaveandSendBtn").hide(),$(".selectedBtn").removeClass("selectedBtn"),Crm.userDetails.RTL_ENABLED?($("#ceVariousAttachmentOptionContainer").css({top:"-"+($("#ceVariousAttachmentOptionContainer").height()+10)+"px","min-width":"150px","max-width":"500px",right:o+20}),setTimeout((function(){$("#ceVariousAttachmentOptionContainer").css({top:"-"+($("#ceVariousAttachmentOptionContainer").height()+10)+"px"}),$("#ceVariousAttachmentOptionContainer").fadeIn(200)}),200)):$("#ceVariousAttachmentOptionContainer").fadeIn(200).css({top:"-"+($("#ceVariousAttachmentOptionContainer").height()+10)+"px",width:"150px",left:o+20}))}},EmailSendingUtil.process=function(e){var i=$(e).val(),t=$(e).attr("name")+"_"+EmailSendingUtil.filesAttached;EmailSendingUtil.createFileInputTag(e,t),EmailSendingUtil.displayAttachmentName(i);var a=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=a&&60!=EmailSendingUtil.attachmentContainerHeight){var l=a-EmailSendingUtil.attachmentContainerHeight;a>60&&($("#ecDisplayAttachmentNames").css({height:"72px",overflow:"auto"}),l=72-EmailSendingUtil.attachmentContainerHeight,a=72),EmailSendingUtil.attachmentContainerHeight=a}EmailSendingUtil.resizeEditorHeight(l),EmailSendingUtil.filesAttached++},EmailSendingUtil.docsHandling=function(){Crm.userDetails.isNewEditor?EmailUtil.docsHandling():(document.getElementById("attachdialogdiv")&&(document.getElementById("attachdialogdiv").style.display="none"),document.getElementById("zohodocsframe")&&(document.getElementById("zohodocsframe").style.display="none"),EmailSendingUtil.uploadDocsAttachments())},EmailSendingUtil.createFileInputTag=function(e,i){$('<input type="file" class="ecFileInput" style="display: none;" name="ecAttachments"  onchange="EmailSendingUtil.process(this)">').appendTo(e.closest("li")),e.removeAttr("onchange"),e.removeAttr("class"),e.attr("id",i),e.detach().appendTo("#ecDisplayAttachmentNames")},EmailSendingUtil.displayAttachmentName=function(e,i,t,a){var l,o=e;(l=a?$("#ecAttachmentTempDispPattern").clone():$("#ecAttachmentDispPattern").clone()).removeAttr("id"),l.attr("fileName",$ESAPI.encoder().encodeForHTML(e)),i&&null!=i&&null!=i?l.find("span").html($ESAPI.encoder().encodeForHTML(i)):l.find("span").html($ESAPI.encoder().encodeForHTML(o)),l.find("span").attr("id","ecAttachDetails"+EmailSendingUtil.fileCount),l.find("img").attr("data-zcqa","emc_removeAttachment_"+o),t&&null!=t&&""!=t&&(l.attr("fileSize",t),l.find("p").html(EmailSendingUtil.bytesToSize(t))),l.appendTo("#ecDisplayAttachmentNames"),l.show(),EmailSendingUtil.fileCount++},EmailSendingUtil.removeAttachment=function(e){var i=$(e).closest("div"),t=i.attr("name"),a=i.attr("fileId");$("#massMailId").length>0&&(a=i.attr("massMailFileId")),null!=a&&-1!=a&&""!=a&&EmailSendingUtil.removeFileFromZFS(a),i.remove(),$("#"+t).remove();var l=$("#ecDisplayAttachmentNames");l.css({height:"",overflow:""});var o=l.height();if(o<=60&&EmailSendingUtil.attachmentContainerHeight!=o){var n=o-EmailSendingUtil.attachmentContainerHeight;EmailSendingUtil.attachmentContainerHeight=o,EmailSendingUtil.resizeEditorHeight(n)}else o>60&&l.css({height:"60px",overflow:"auto"})},EmailSendingUtil.newshowHideoptions=function(e,i){$(e).addClass("hide");var t=$("#ceOption_"+i);if(Crm.userDetails.isNewEditor&&(t=$("#ceOption_"+i+"_"+EmailComposeUtil.CURRENT_TAB)),t.removeClass("hide"),t.find("input").val(""),t.find("input").focus(),Crm.userDetails.isNewEditor&&($("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide"),t.addClass("ceComposeMeta")),"replyto"===i){var a=$("#ceReplyToAddrSpan").parent().find("ul li:first").attr("lival"),l=$("#ceReplyToAddrSpan");l.attr("selectedval",a),l.html(a)}EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.HideEmptyfields=function(){$("#ceOption_cc").is(":visible")&&(0===$("#ceOption_cc").find("input").val().length&&1==$("#ceCCAddrDetails li").length&&($("#ceOption_cc").addClass("hide"),$("#ceCcLink").removeClass("hide")));$("#ceOption_bcc").is(":visible")&&(0===$("#ceOption_bcc").find("input").val().length&&1==$("#ceBCCAddrDetails li").length&&($("#ceOption_bcc").addClass("hide"),$("#ceBccLink").removeClass("hide")));EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.setTextareaHeight=function(){var e=$("#emailComposeContainer").outerHeight()-($(".ceContenteditOptions").outerHeight()+$("#ceRecipents").outerHeight()+$("#etUserDetails").outerHeight()+$("#emailDraftContainer").outerHeight()+170),i=$(".ceComposeinfo:visible");if($(".ceComposeinfo").is(":visible")){var t=i.length;if(e)e-=t*i.height(),$(".ze_area").contents().find("body").css("height",e)}},EmailSendingUtil.addTemplate=function(){if(Crm.userDetails.isNewEditor&&($("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),$("#"+EmailComposeUtil.activeContentId+" .etInsertSurvey").hide()),EmailSendingUtil.isEntityWindow){var e=EmailSendingUtil.getModuleName();"Accounts"===e&&"Contacts"===EmailCompose.optOutModule[EmailComposeUtil.CURRENT_TAB]&&(e="Contacts"),template.showTemplateList("sendMail","ecTemplateId","EmailSendingUtil.dumpTemplateBody()","",e,EmailSendingUtil.isConsentEmail)}else EmailSendingUtil.templatesFetched?EmailSendingUtil.postGetTemplatesForModule():EmailSendingUtil.getTemplatesForModule()},EmailSendingUtil.getModuleName=function(){var e=$("#moduleName").val(),i=Crm.userDetails.isNewEditor||EmailSendingUtil.composeActive&&!$("#oldtoNewDiv")[0],t=$("#customModuleName").val();return i&&(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),(t=$("#customModuleName_"+EmailComposeUtil.CURRENT_TAB).val())&&(e=t),e=EmailSendingUtil.getModuleAPIModuleName(e)),e},EmailSendingUtil.getModuleAPIModuleName=function(e){var i;for(val in Crm.userDetails.MODULE_LIST){var t=Crm.userDetails.MODULE_LIST[val];if(t.module_name===e||t.api_name===e){i=t;break}}return i&&(e=i.module_name),e},EmailSendingUtil.searchModule=function(e){for(var i=$.trim($(e).val()).toLowerCase(),t=($("#ecModules_"+EmailSendingUtil.activeModule).find("div"),EmailSendingUtil.activeModule),a={},l=[],o=EmailSendingUtil.templateValues[t],n=0;n<o[0].length;n++){var s={},m=[];s.folder=o[0][n].folder;for(var r=0;r<o[0][n].folderValue.length;r++)if(o[0][n].folderValue[r].name.toLowerCase().indexOf(i)>-1){var d={};d.name=o[0][n].folderValue[r].name,d.Id=o[0][n].folderValue[r].Id,d.openPerc=o[0][n].folderValue[r].openPerc,d.openCount=o[0][n].folderValue[r].openCount,d.deliveredCount=o[0][n].folderValue[r].deliveredCount,d.tempIdEncrypt=o[0][n].folderValue[r].tempIdEncrypt,m.push(d)}s.folderValue=m,s.folderValue.length>0&&l.push(s)}a.module=t,a.size=o[1].size,a.data=l,$("#ecModules_"+t).html(EmailSendingUtil.addTemplateHandlebar(a)),EmailSendingUtil.bindTemplateScroll()},EmailSendingUtil.setActiveModule=function(e,i){EmailSendingUtil.activeModule=i,$(".ecModulesSet").addClass("hide");var t=$("#ecModules_"+EmailSendingUtil.activeModule);t.find("li").removeClass("hide"),t.removeClass("hide"),$("#ecTemplateSearchBox").val(""),$('div[id^="ecRecentTemplates_"]').hide();var a=$(e).position().left,l=$(e).width();$(e).closest(".etsTab").find(".animatedBorder").animate({left:a,width:l},300),EmailSendingUtil.populateEmailTemplates(i),$("#ecRecentTemplates_"+i).show(),thirdPartyUtils.unbindPerfectScroll(".ecvTemplateListOuter"),$(".ecvTemplateListInner").css({height:""}),$(".ecSearchModules").addClass("hide");var o=$(".ecvTemplateListInner").outerHeight();$(".ecSearchModules").removeClass("settingsBottomshadow"),o>280&&EmailSendingUtil.bindTemplateScroll()},EmailSendingUtil.bindTemplateScroll=function(){var e=$(".ecvTemplateListOuter"),i=$(".ecvTemplateListInner");thirdPartyUtils.unbindPerfectScroll(".ecvTemplateListOuter"),i.css({height:"0px"});var t=$(".ecvTemplateListOuter")[0].scrollHeight;i.css({height:t}),e.css({height:"300px",overflow:"hidden"}),thirdPartyUtils.bindPerfectScroll(".ecvTemplateListOuter",{wheelSpeed:1,preventOnEnd:!1,preventHorizontal:!1}),$(".ecSearchModules").removeClass("hide"),EmailSendingUtil.setTemplateShadow()},EmailSendingUtil.populateEmailTemplates=function(e){if(EmailSendingUtil.moduleVsTempList[e]&&null!=EmailSendingUtil.moduleVsTempList[e]&&""!=EmailSendingUtil.moduleVsTempList[e])$("#ecModules_"+e).html(EmailSendingUtil.moduleVsTempList[e]);else{var i="action=getTemplatesForModule&module="+e;$(EmailTabHomeUtil.Loading).show(),$(EmailTabHomeUtil.Loading).attr("data-zcqa","emc_etLoading"),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:i,dataType:"json",success:function(i){var t;EmailSendingUtil.templateValues[i.module]=[i.data,{size:i.size}];var a=I18n.getMsg("crm.template.openrate.lastversion"),l=I18n.getMsg("crm.no.templates");EmailSendingUtil.addTemplateHandlebar||(EmailSendingUtil.addTemplateHandlebar=Handlebars.compile("{{#if data}}{{#each data}}<div class=\"cBoth\"><span class='fL pT5 pL30 crm-base-font-size mT10 crm-font-xbold'>{{this.folder}}</span><ul class=\"m0 mT5 cBoth fL pL30\" onclick=\"EmailSendingUtil.getTemplateContentById(event,'{{../module}}')\">{{#each this.folderValue}}<li class='ecTemplatesList' templateId=\"{{this.Id}}\"><a href=\"javascript:;\" data-zcqa=\"emc_{{../../module}}Module_{{../this.folder}}_{{this.name}}\">{{this.name}}</a>{{#ifCondLogic this.deliveredCount '!=' '0' '&&' this.deliveredCount '!=' undefined}}<span  onclick='sE(event)'  onmouseenter='renderingUtils.zctt.showtt(\""+a+'")\'   onmouseout=\'renderingUtils.zctt.hidett()\' data-zcqa=\'eA_CW_openRate_{{this.Id}}\' class=\'mL10  crm-font-regular crm-small-font-size crmNotFoundColor fL mT1 etOpenrate\'>{{this.openPerc}}  ({{this.openCount}}/{{this.deliveredCount}})</span> <a class=\'fL newTabIcon mT1 mL5\'  data-zcqa=\'eA_CW_newTabIcon_{{this.Id}}\' href=\'javascript:;\' onclick=\'crmTemplateStats.getTemplateStats(event, this, undefined, 1); sE(event);\' data-params=\'{"templateid" : "{{this.tempIdEncrypt}}", "source" : "description", "viewtype" : "viewEmailTemplate", "category" : "versionView"}\'></a>{{/ifCondLogic}}</li>{{/each}}</ul></div>{{/each}}{{else}}<span class="centerTemplateMsg">'+l+"</span>{{/if}}")),t=EmailSendingUtil.addTemplateHandlebar(i),$("#ecModules_"+e).html(t),EmailSendingUtil.moduleVsTempList[e]=t,$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa"),thirdPartyUtils.unbindPerfectScroll(".ecvTemplateListOuter"),$(".ecvTemplateListInner").css({height:""}),$(".ecSearchModules").addClass("hide"),$(".ecvTemplateListInner").outerHeight()>280&&EmailSendingUtil.bindTemplateScroll();var o=$(".ecvTemplateListInner").outerWidth()-40;$(".ecTemplatesList").each((function(){if($(this).find(".etOpenrate").length){var e=$(this).find(".etOpenrate").outerWidth(),i=$(this).find(".newTabIcon").outerWidth();$(this).find(".ecTemplateName").css("max-width",o-(e+i+20))}else $(this).find(".ecTemplateName").css("max-width",o-(i+20))}))},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailSendingUtil.getTemplatesForModule=function(){var e="action="+EmailTabHomeUtil.GET_ALL_TEMPLATES_FOR_MODULE+"&isEntityMail="+EmailSendingUtil.isEntityWindow;$(EmailTabHomeUtil.Loading).show(),$(EmailTabHomeUtil.Loading).attr("data-zcqa","emc_etLoading"),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:e,success:function(e){$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa"),EmailSendingUtil.templatesFetched=!0,$("#ecAddTemplate").html(e),EmailSendingUtil.postGetTemplatesForModule()},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.postGetTemplatesForModule=function(){Crm.userDetails.isNewEditor&&EmailSendingUtil.composeActive?EmailComposeUtil.showCustomFreezeLayer():(renderingUtils.freezeBackground(),$("#FreezeLayer").css({opacity:.5,"background-color":"#000"}));var e=$("#ecAddTemplate");e.animate({top:"0px"},"200","easeOutCubic");var i=null;$(".ecPermittedTemplateModuels").hide(),EmailSendingUtil.isEntityWindow?(i=$("#moduleName").val(),e.removeClass("hide").css("left",($("#ecAddTemplate").width()+200)/2),$("#ecPermittedModulesLi_"+i).show()):e.removeClass("hide").css("left",(EmailTabHomeUtil.ViewPortWidth-$("#ecAddTemplate").width())/2),$("#ecAddTemplate li:visible:last").css("margin-right","0"),EmailSendingUtil.isEntityWindow&&$("#chooseTemplateLi").length>0?EmailSendingUtil.setActiveModule($("#chooseTemplateLi"),i):""===EmailSendingUtil.activeModule&&(EmailSendingUtil.activeModule=i,renderingUtils.triggerEvent("click",$("#ecPermittedModulesLi_"+i).find("a")),$('div[id^="ecRecentTemplates_"]').hide(),$("#ecRecentTemplates_"+i).show())},EmailSendingUtil.closeTemplatesDiv=function(){$("#ecAddTemplate").animate({top:"-420px"},200,(function(){$("#ecAddTemplate").addClass("hide")}));var e=$L("#commonActionPage"),i=$L(".calendarPreferenceModal");e&&0!=e.length&&e.length>0&&"none"!==e[0].style.display&&"hidden"!==e[0].style.visibility||i&&0!=i.length&&i.length>0&&"none"!==i[0].style.display&&"hidden"!==i[0].style.visibility||renderingUtils.removeFreezeLayer(),$("#freezeBackGround_gdocs").remove()},EmailSendingUtil.getTemplateContentById=function(e,i,t){var a=$("#moduleName").val();a&&a!==i&&$("#ceToAddr").val("");var l=$($("#ceToAddrDetails").children()[0]).attr("email"),o=$("#addrsVal").attr("selectedval"),n=$("#ecEntityId").val(),s=$("#editorMode").val();if(EmailSendingUtil.isNewEditor()&&(a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=$($("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).children().eq(0)).attr("email"),n=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),o=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("data")[0].element.value,s=$("#editorMode_"+EmailComposeUtil.CURRENT_TAB).val()),!t){var m=$(e.target).closest("li");t=m.attr("templateId")}if(-1!==parseInt(t)){var r="action="+EmailTabHomeUtil.GET_TEMPLATE_DETAIL_BY_ID+"&templateId="+t+"&module="+a+"&toAddr="+encodeURIComponent(l)+"&fromAddr="+encodeURIComponent(o)+"&entId="+n+"&editorMode="+s;$(EmailTabHomeUtil.Loading).show(),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:r,dataType:"json",success:function(e){$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa"),EmailSendingUtil.templateIdVsDetail[t]=e,EmailSendingUtil.postGetTemplateContentById(e,i);var a=$(`#toolBarDiv_${EmailComposeUtil.CURRENT_TAB} .zi_emailfooter_li`);a&&a.hide()},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailSendingUtil.postGetTemplateContentById=function(e,i){if(null!=e.result){var t=$("#emc_msg_Tab");t.css("left",(EmailTabHomeUtil.ViewPortWidth-t.outerWidth())/2).show(),t.css({"z-index":"100"}),t.hide(),t.html(e.result),t.attr("data-zcqa","emc_SendTab_Error"),Crm.userDetails.isNewEditor&&EmailSendingUtil.composeActive&&"Sorry, there seems to be a problem in attaching the template. Please try after some time."==e.result&&crmui.showMsgBand("error",I18n.getMsg("crm.email.label.error.template.attach"),3e3),EmailSendingUtil.isEntityWindow?($("#emailEntityComposeOverlay").hide(),$("#emailEntityComposepopup").hide(),setTimeout((function(){t.show().css("left",($(document).outerWidth()-t.outerWidth())/2)}),100)):setTimeout((function(){t.show().css("left",(EmailTabHomeUtil.ViewPortWidth-t.outerWidth())/2)}),100),setTimeout((function(){t.hide(),t.removeAttr("data-zcqa"),t.html("Loading...")}),8e3)}else void 0!==e.id&&EmailSendingUtil.populateEditorWithTemplate(e,i)},EmailSendingUtil.populateEditorWithTemplate=function(e,i){Crm.userDetails.isNewEditor?(EmailSendingUtil.populateNewEditorWithTemplate(e,i),EmailActionHandling.saveDraftDetails()):EmailSendingUtil.populateOldEditorWithTemplate(e,i)},EmailSendingUtil.populateNewEditorWithTemplate=function(e,i){var t="";EmailComposeUtil.clearTemplate();var a=2===e.editorMode?"plainEditor":"richEditor",l=editor.zEditor;l.setEditorMode=a;var o=e.body;if("plainEditor"===a){l.showPlainEditor(!0),l.plainEditor.value=o}else{l.showRichEditor();try{var n=o;o.indexOf("<body>")>-1&&o.indexOf("</body>")>-1&&(n=o.substring(o.indexOf("<body>")+6,o.indexOf("</body>")));var s=document.createElement("div");s.innerHTML=n;var m=s.getElementsByTagName("pre");if(m&&m.length>0||n.includes("pre-wrap")){for(var r=s.getElementsByTagName("*"),d=0,c=r.length;d<c;d++)r[d].style&&"pre-wrap"===r[d].style.whiteSpace&&(r[d].innerHTML=r[d].innerHTML.replaceAll("\n","<br>"));Array.from(m).forEach((e=>{e.innerHTML=e.innerHTML.replace(/\n/g,"<br>")}));var p=s.outerHTML.substring(s.outerHTML.indexOf("<div>")+5,s.outerHTML.length-6),E=new RegExp(n),u=o.replace(E,p);if(-1===o.indexOf(p)||u.length-o.length>1e3){var C=o.replace(n,p);C.length-o.length>1e3||(o=C)}else o=u}}catch(e){o+=""}editor.setContent(o,!0),t=editor.getContent();var g=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(),U=editor.zEditor.z_doc.getElementById("ecw_signature");if(g&&U){var h=EmailUtil.getSignaturebyEmail(g);h||(h=""),U.innerHTML=h,EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]=U.innerHTML,EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]=g}EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]&&EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]&&(editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML+EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB])}var v=$("#ceAddtemplate_"+EmailComposeUtil.CURRENT_TAB),f=$("#emcTemplateNameHolder_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.IsReplyOrForwardMail()||EmailComposeUtil.setSubject(e.subject),v.html($ESAPI.encoder().encodeForHTML(e.name)).attr("title",e.name),v.attr("templateid",e.id),Crm.userDetails.isNewEditor?(f.removeClass("hide"),$("#emcTemplateOptions_"+EmailComposeUtil.CURRENT_TAB).addClass("hide")):(f.addClass("emcTemplateNameHolder"),$("#ceCleartemplate").parent().removeClass("hide")),e.isMergFieldReplaced&&$("#cePreviewMergeFields_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),!EmailSendingUtil.isEntityWindow||"PurchaseOrders"!==i&&"SalesOrders"!==i&&"Quotes"!==i&&"Invoices"!==i?$("#ecDisplayAttachmentNames_"+EmailComposeUtil.CURRENT_TAB).html(""):$("#"+EmailComposeUtil.activeContentId+" .ecMailAttachment").each((function(){$(this).hasClass("ecInventoryAttachment")||"ecAttachmentDispPattern"===$(this).attr("id")||$(this).remove()})),$("#emailTempModule_"+EmailComposeUtil.CURRENT_TAB).val(i);var T=$("#mailConfigType_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.isEntityWindow&&T.length>0&&"NORMAL"===T.val()&&(e.fromId&&"null"!==e.fromId&&EmailSendingUtil.setTemplateFromAddress(e.fromId),e.replyTo&&"null"!==e.replyTo&&EmailSendingUtil.setTemplateReplytoAddress(e.replyTo)),e.rawFileNames&&EmailComposeUtil.handleTemplateAttachments(e.rawFileNames,e.fileSizes,e.fileNames),EmailSendingUtil.closeTemplatesDiv(),EmailSendingUtil.composeActive=!1;EmailCompose.deleteDraft(!0),$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val(e.id);var S=e.id;EmailSendingUtil.templateIdVsContent[S]=t,EmailUtil.saveTempDraftDetails(),EmailSendingUtil.composeActive=!0},EmailSendingUtil.IsReplyOrForwardMail=function(){if(Crm.userDetails.isNewEditor){var e=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();return!(!EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]||!e||!e.startsWith("Re:")&&!e.startsWith("Fwd:"))}var i=$("#ceSubject1").val(),t=$("#msgid"),a=t?t.val():void 0,l=$("#sendMailType").val();return!("reply"!==l&&"forward"!==l&&"replyAll"!==l&&!a||!i||!i.startsWith("Re:")&&!i.startsWith("Fwd:"))},EmailSendingUtil.populateOldEditorWithTemplate=function(e,i){EmailSendingUtil.clearTemplate(),editorMode=e.editorMode,2===editorMode?(editor.setMode("plaintext"),EmailSendingUtil.showHideEditorTools("plaintext")):(editor.setMode("richtext"),EmailSendingUtil.showHideEditorTools("richtext"));var t=$("#previousMailContentWithOutSign").val();if(null!=t&&null!=t&&""!=t)editor.setContent(e.body+"<br>"+t);else if(EmailSendingUtil.templatecontentStyle=void 0,1===editorMode){var a=e.body;if(a.indexOf("<head>")>-1&&a.indexOf("</head>")>-1){var l=a.substring(a.indexOf("<head>"),a.indexOf("</head>")+7);a=a.replace(l,""),l=(l=l.replace("<head>","")).replace("</head>",""),EmailSendingUtil.templatecontentStyle=l}editor.setContent(a),EmailSendingUtil.templatecontentStyle&&(editor.doc.head.innerHTML='<style type="text/css">.ze_body{font-family:Verdana,arial,Helvetica,sans-serif;font-size:13px;} table{font-size:100%}</style>'+EmailSendingUtil.templatecontentStyle)}else editor.setContent(e.body);EmailSendingUtil.IsReplyOrForwardMail()||($("#ceSubject1").val(e.subject),$("#ceSubject").val(e.subject)),$("#ceAddtemplate").html($ESAPI.encoder().encodeForHTML(e.name)).attr("title",e.name),$("#emcTemplateNameHolder").addClass("emcTemplateNameHolder"),$("#ceAddtemplate").attr("templateid",e.id),$("#ceCleartemplate").parent().removeClass("hide"),e.isMergFieldReplaced&&$("#cePreviewMergeFields").removeClass("hide"),!EmailSendingUtil.isEntityWindow||"PurchaseOrders"!==i&&"SalesOrders"!==i&&"Quotes"!==i&&"Invoices"!==i?$("#ecDisplayAttachmentNames").html(""):$(".ecMailAttachment").each((function(){$(this).hasClass("ecInventoryAttachment")||"ecAttachmentDispPattern"===$(this).attr("id")||$(this).remove()})),$("#emailTempModule").val(i),EmailSendingUtil.isEntityWindow&&$("#mailConfigType").length>0&&"NORMAL"==$("#mailConfigType").val()&&(null!=e.fromId&&"null"!=e.fromId&&""!=e.fromId&&EmailSendingUtil.setTemplateFromAddress(e.fromId),null!=e.replyTo&&"null"!=e.replyTo&&""!=e.replyTo&&EmailSendingUtil.setTemplateReplytoAddress(e.replyTo)),null!=e.rawFileNames&&""!=e.rawFileNames&&EmailSendingUtil.handleTemplateAttachments(e.rawFileNames,e.fileSizes),$("#ecTemplateId").val(e.id),EmailSendingUtil.closeTemplatesDiv(),EmailActionHandling.deleteDraft(),$("#draftId").val("")},EmailSendingUtil.handleTemplateAttachments=function(e,i){var t=e.split(";"),a=i.split(";"),l=0,o=t.length;for(l=0;l<o&&""!=t[l];l++)EmailSendingUtil.displayAttachmentName(t[l],null,a[l],!0),EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.clearTemplate=function(){var e=$("#emcTemplateNameHolder");if(EmailSendingUtil.IsReplyOrForwardMail()||($("#ceSubject1").val(""),$("#ceSubject").val("")),$("#ceAddtemplate").html(I18n.getMsg("crm.email.add.template")),e.removeClass("emcTemplateNameHolder"),Crm.userDetails.isNewEditor?(e.addClass("hide"),EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName(),EmailUtil.clearEditorAttachments()):$("#ceCleartemplate").parent().addClass("hide"),0==$("#moduleName").length||"Quotes"!==$("#moduleName").val()&&"Invoices"!==$("#moduleName").val()&&"PurchaseOrders"!==$("#moduleName").val()&&"SalesOrders"!==$("#moduleName").val())$("#ecDisplayAttachmentNames").html("");else for(var i=$(".ecMailAttachment"),t=0;t<$(i).length;t++){var a=$(i)[t];$(a).hasClass("pdfAttachment")||"ecAttachmentDispPattern"===$(a).attr("id")||"ecAttachmentTempDispPattern"===$(a).attr("id")||$(a).remove()}$("#ecTemplateId").val(""),$("#emailTempModule").val("");var l=$("#previousMailContent").val();null!=l&&null!=l&&""!=l?editor.setContent(l):(Crm.userDetails.isNewEditor&&(EmailComposeUtil.editorContent="",editor.zEditor.plainEditor&&(editor.zEditor.plainEditor.value="")),editor.setContent("<br>"))},EmailSendingUtil.isKeyCodeAllowedForGetData=function(e){return null!=e&&(e>=64&&e<=90||e>=97&&e<=122||e>=48&&e<=57||8===e||0===e||46===e||190===e)},EmailSendingUtil.isKeyCodeForA=function(e){return e&&65==e},EmailSendingUtil.isKeyCodeForCmdOrCtrl=function(e){return e&&(224==e||17==e||91==e||93==e)},EmailSendingUtil.isKeyCodeForLeftArrow=function(e){return e&&37==e},EmailSendingUtil.isKeyCodeForBksp=function(e){return e&&8==e},EmailSendingUtil.isKeyCodeForTab=function(e){return e&&9==e},EmailSendingUtil.isKeyCodeForUpArrow=function(e){return e&&38==e},EmailSendingUtil.isKeyCodeForRightArrow=function(e){return e&&39==e},EmailSendingUtil.isKeyCodeForDownArrow=function(e){return e&&40==e},EmailSendingUtil.isKeyCodeForEnter=function(e){return e&&13==e},EmailSendingUtil.isKeyCodeForComma=function(e){return e&&188==e},EmailSendingUtil.isKeyCodeForShift=function(e){return e&&16==e},EmailSendingUtil.limitExceedAlertFor50Mails=function(){EmailSendingUtil.isNewEditor()?EmailUtil.showMsg("error",EmailSendingUtil.maxLimitExceedsMsg.toCcBcc,5e3):Crm.showAlertMsg(EmailSendingUtil.maxLimitExceedsMsg.toCcBcc)},EmailSendingUtil.handlePasteEventForAutoComplete=function(e,t){var a=$("#ceRecipents_"+EmailComposeUtil.CURRENT_TAB).find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)");if(a.removeClass("ecHighlightSelection"),a.length>49)return EmailSendingUtil.limitExceedAlertFor50Mails(),void setTimeout((function(){$(e).val("")}),100);var l=t.clipboardData.getData("text");EmailSendingUtil.handlePasteEventsForAutoComplete(e,l);var o=$(e).closest("li");setTimeout((function(){var t=$(e).val();if(t&&""!=t){var a=t.split(",");for(i=0;i<a.length-1;i++){if($("#ceRecipents_"+EmailComposeUtil.CURRENT_TAB).find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)").length>49)return EmailSendingUtil.limitExceedAlertFor50Mails(),void $(e).val("");EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($.trim(a[i])),EmailSendingUtil.formattedUsernameFromEmail($.trim(a[i])),null,o)}$(e).val(a[a.length-1])}setTimeout((function(){EmailSendingUtil.isCrtlKeyPressed=!1}),100)}),100)},EmailSendingUtil.handleBlurOnEmailTextBoxes=function(e){EmailSendingUtil.isClickOnAutoCompleteDiv||EmailSendingUtil.rectifyEmail(e)},EmailSendingUtil.handleKeyDownEventsForAutoComplete=function(e,i){var t=commonUtils.getCharacterCode(i);if(EmailSendingUtil.isKeyCodeForCmdOrCtrl(t))EmailSendingUtil.isCrtlKeyPressed=!0;else if(EmailSendingUtil.isKeyCodeForBksp(t)){var a=$(e).closest("ul").children("li:not(.ecAddrEditor)");if(""===$(e).val()&&a.length>=1)if(a.hasClass("ecHighlightSelection")){var l=a.filter(".ecHighlightSelection"),o=l.prev(),n=l.length;if(n>1)for(var s=0;s<n;s++){var m=$L(l.get(s)).attr("emailType");EmailSendingUtil.removeMailTypeFromEmailPicker(m)}else{m=l.attr("emailType");EmailSendingUtil.removeMailTypeFromEmailPicker(m)}l.remove(),EmailSendingUtil.isEntityWindow||EmailSendingUtil.checkEntityAndAlert(),o.length>0&&o.addClass("ecHighlightSelection")}else elem=a[a.length-1],a.removeClass("ecHighlightSelection"),$(elem).addClass("ecHighlightSelection");$L(".email_option_dropdown")[0].close()}else if(EmailSendingUtil.isKeyCodeForTab(t)){var r=$(e).closest("li"),d=$.trim($(e).val());d&&(d=d.replace(/,/g,""),EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(d),EmailSendingUtil.formattedUsernameFromEmail(d),null,r),event.preventDefault(),$(e).focus(),$("#ecAutoCompleteContainer").addClass("hide").html(""))}else $L(".ecHighlightSelection").removeClass("ecHighlightSelection")},EmailSendingUtil.handlePasteEventsForAutoComplete=function(e,i,t){if("etSearchBox"===$(e).attr("id")||$(e).hasClass("evCriteriaValue")||$(e).width(9*$(e).val().length),$(e).hasClass("evCriteriaValue")){var a=$(e).closest(".evFieldCriteriaVal").find("span.evCriteriaFieldVal").attr("foName");if(!a||"FROM"!==a&&"TO"!==a&&"CC"!==a&&"TO_CC"!==a)return}else if(i&&""!==i){var l;(l=Crm.userDetails.isNewEditor?$("#ceRecipents_"+EmailComposeUtil.CURRENT_TAB).find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)"):$("#ceRecipents").find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)")).removeClass("ecHighlightSelection");var o=l.filter(".selectedEmail"),n=EmailSendingUtil.getEmailsArrayFromSelectedElements(o),s=EmailSendingUtil.getUserNamesArrayFromSelectedElements(o);null!==t&&t||(l.length<50?EmailSendingUtil.getAutoCompleteEntities(e,i,n,s):($(e).closest("ul.mailToAddrUL").children(".ecAddrEditor input").val(""),EmailSendingUtil.limitExceedAlertFor50Mails(),$(e).val(""),$(e).focus()))}},EmailSendingUtil.handleKeyUpEventsForAutoComplete=function(e,i,t){var a=$(e).closest("li"),l=$.trim($(e).val());if(l&&l.trim()||(EmailSendingUtil.lastSearchChar=l),EmailSendingUtil.CurrentSearchFor=l,"etSearchBox"===$(e).attr("id")||$(e).hasClass("evCriteriaValue")||$(e).width(9*$(e).val().length),$(e).hasClass("evCriteriaValue")){var o=$(e).closest(".evFieldCriteriaVal").find("span.evCriteriaFieldVal").attr("foName");if(!o||"FROM"!==o&&"TO"!==o&&"CC"!==o&&"TO_CC"!==o)return}var n=commonUtils.getCharacterCode(i);if(EmailSendingUtil.isKeyCodeForCmdOrCtrl(n))setTimeout((function(){EmailSendingUtil.isCrtlKeyPressed=!1}),100);else{if(1==EmailSendingUtil.isCrtlKeyPressed){if(EmailSendingUtil.isKeyCodeForA(n)&&""==l)(u=$(e).closest("ul").children("li:not(.ecAddrEditor)")).addClass("ecHighlightSelection");return}if(EmailSendingUtil.isKeyCodeAllowedForGetData(n)&&l&&""!==l){var s;(s=Crm.userDetails.isNewEditor?$("#ceRecipents_"+EmailComposeUtil.CURRENT_TAB).find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)"):$("#ceRecipents").find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)")).removeClass("ecHighlightSelection");var m=s.filter(".selectedEmail"),r=EmailSendingUtil.getEmailsArrayFromSelectedElements(m),d=EmailSendingUtil.getUserNamesArrayFromSelectedElements(m);null!=t&&t||(s.length<50?EmailSendingUtil.getAutoCompleteEntities(e,l,r,d):($(e).closest("ul.mailToAddrUL").children(".ecAddrEditor input").val(""),EmailSendingUtil.limitExceedAlertFor50Mails(),$(e).val(""),$(e).focus()))}else if(EmailSendingUtil.isKeyCodeForDownArrow(n))EmailSendingUtil.moveToAdjLi(e,"next");else if(EmailSendingUtil.isKeyCodeForUpArrow(n))EmailSendingUtil.moveToAdjLi(e,"prev");else if(EmailSendingUtil.isKeyCodeForLeftArrow(n))$("#ecAutoCompleteContainer").is(":visible")?EmailSendingUtil.moveToAdjUl(e,"prev"):""==l&&EmailSendingUtil.selectAdjacentLi(e,"prev");else if(EmailSendingUtil.isKeyCodeForRightArrow(n))$("#ecAutoCompleteContainer").is(":visible")?EmailSendingUtil.moveToAdjUl(e,"next"):""==l&&EmailSendingUtil.selectAdjacentLi(e,"next");else if(EmailSendingUtil.isKeyCodeForEnter(n))if($(e).hasClass("evCriteriaValue")){var c=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi");c.length>0&&EmailSendingUtil.populateSearchValue(null,c)}else if($("#ecAutoCompleteContainer").is(":visible")){var p=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi"),E=p.parent().attr("module");EmailSendingUtil.populateOrClearEntityId(null,E,p)}else if(""!==l)a.hasClass("ecAddrEditor")?EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(l),EmailSendingUtil.formattedUsernameFromEmail(l),null,a):EmailSendingUtil.rectifyEmail(e);else if(a.hasClass("ecAddrEditor")){var u;if((u=$(e).closest("ul").children("li:not(.ecAddrEditor)")).hasClass("ecHighlightSelection")&&1==u.filter(".ecHighlightSelection").length){var C=u.filter(".ecHighlightSelection");C.removeClass("ecHighlightSelection"),renderingUtils.triggerEvent("click",C.find(".selUserDetails"))}}else $(a).siblings(".ecAddrEditor").find("input").focus();else if(EmailSendingUtil.isKeyCodeForComma(n)&&l)""!==l?(l=l.replace(/,/g,""),a.hasClass("ecAddrEditor")?EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(l),EmailSendingUtil.formattedUsernameFromEmail(l),null,a):($(e).val(l),EmailSendingUtil.rectifyEmail(e))):a.hasClass("ecAddrEditor")||$(a).siblings(".ecAddrEditor").find("input").focus();else if(!EmailSendingUtil.isKeyCodeForShift(n)){var g=$("#ecAutoCompleteContainer");g.addClass("hide"),g.html(""),0!=l.length||EmailSendingUtil.isEntityWindow||EmailSendingUtil.populateOrClearEntityId(),l&&l.trim()||e.click()}}},EmailSendingUtil.getUserNamesArrayFromSelectedElements=function(e){var i=[];return e&&e.length>0&&$.each(e,(function(e,t){i.push($(t).attr("username").toLowerCase())})),i},EmailSendingUtil.getEmailsArrayFromSelectedElements=function(e){var i=[];return e&&e.length>0&&$.each(e,(function(e,t){i.push($(t).attr("email").toLowerCase())})),i},EmailSendingUtil.selectAdjacentLi=function(e,i){var t,a=$(e).closest("ul").children("li:not(.ecAddrEditor)"),l=a.filter(".ecHighlightSelection");1==l.length?("prev"==i?t=l.prev():"next"==i&&(t=l.next("li:not(.ecAddrEditor)")),t.length>0?(l.removeClass("ecHighlightSelection"),t.addClass("ecHighlightSelection")):"next"==i&&l.removeClass("ecHighlightSelection")):l.length>1&&"next"==i?l.removeClass("ecHighlightSelection"):"prev"===i&&a.last().addClass("ecHighlightSelection")},EmailSendingUtil.moveToAdjLi=function(e,i){var t=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi");if(t.length<1)"prev"==i?$("#ecAutoCompleteContainer").find("li").last().addClass("autoCompleteSelectedLi"):$("#ecAutoCompleteContainer").find("li").first().addClass("autoCompleteSelectedLi");else{if(currentLiIndex=parseInt(t.attr("index")),"prev"==i)var a=currentLiIndex-1;else a=currentLiIndex+1;var l=t.siblings("li[index="+a+"]");l.length>0?(t.removeClass("autoCompleteSelectedLi"),l.addClass("autoCompleteSelectedLi")):"prev"==i?EmailSendingUtil.moveToAdjUl(e,i,!0):EmailSendingUtil.moveToAdjUl(e,i)}},EmailSendingUtil.moveToAdjUl=function(e,i,t){var a=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi");if(a.length<1)"prev"==i?$("#ecAutoCompleteContainer").find("li").last().addClass("autoCompleteSelectedLi"):$("#ecAutoCompleteContainer").find("li").first().addClass("autoCompleteSelectedLi");else{var l=a.parent(),o=parseInt(l.attr("index")),n=o,s=l;if("prev"==i&&l.find("li").eq(0).attr("index")==a.attr("index")?(n=o-1,s=l.siblings("ul[index="+n+"]")):"next"==i&&(n=o+1,s=l.siblings("ul[index="+n+"]")),s.length>0){a.removeClass("autoCompleteSelectedLi");var m=0;t&&(m=s.find("li").length-1),s.find("li").eq(m).addClass("autoCompleteSelectedLi")}else"true"!==$(e).attr("initialLiSelection")&&$("#ecAutoCompleteContainer").find("li").removeClass("autoCompleteSelectedLi")}},EmailSendingUtil.getAutoCompleteEntities=function(e,i,t,a){var l=i,o=EmailSendingUtil.getFilteredValuesForAutoComplete(t,a,i,EmailSendingUtil.preLoadedAutoCompleteData,5);EmailSendingUtil.postGetAutoCompleteEntities(o,e,i),$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa");var n="",s=$("#emailTempModule").val();if(s&&"Potentials"==s)n=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE+"&module=Potentials&searchFor="+encodeURIComponent(l);else{if(EmailSendingUtil.isEntityWindow){var m=$("#moduleName").val();m||void 0===EmailComposeUtil||(m=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),"Deals"===m&&(m="Potentials");r="&module="+m;EmailSendingUtil.isAutoCompleteSupportedModule(m)||(r+="&isPreLoad=true")}else var r="&module="+EmailSendingUtil.AutoCompleteModulesArray.toString();n=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE+r+"&searchFor="+encodeURIComponent(l)}EmailSendingUtil.lastSearchChar!==i&&(null!==EmailSendingUtil.timer&&window.clearTimeout(EmailSendingUtil.timer),EmailSendingUtil.lastSearchChar=i,EmailSendingUtil.timer=window.setTimeout((function(){$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailSendingUtil.URL,data:n,dataType:"json",success:function(o){if(EmailSendingUtil.CurrentSearchFor){var n={};if($.each(EmailSendingUtil.AutoCompleteModulesArray,(function(e,i){o[i]?n[i]=o[i].length:n[i]=0})),EmailSendingUtil.statusArray[l]=n,o.Colleagues){o.Colleagues.length;EmailSendingUtil.removeDuplicateColleagues(o),searchCharDatum=EmailSendingUtil.getFilteredValuesForAutoComplete([],[],l,EmailSendingUtil.preLoadedAutoCompleteData),searchCharDatum.Colleagues&&(o.Colleagues=searchCharDatum.Colleagues.concat(o.Colleagues))}else searchCharDatum=EmailSendingUtil.getFilteredValuesForAutoComplete([],a,l,EmailSendingUtil.preLoadedAutoCompleteData),searchCharDatum.Colleagues&&(o.Colleagues=searchCharDatum.Colleagues);if(o.custommodule&&""!==o.custommodule&&!EmailSendingUtil.AutoCompleteModulesArray.contains(o.custommodule)&&(EmailSendingUtil.AutoCompleteModulesArray.push(o.custommodule),EmailSendingUtil.CUSTOMODULE=o.custommodule),o[Object.keys(o)[1]])o[Object.keys(o)[1]].length<1001&&(EmailSendingUtil.AutoCompleteData.searchValue={},EmailSendingUtil.AutoCompleteData.searchValue[l]=o);(i=l).length>0&&(o=EmailSendingUtil.getFilteredValuesForAutoComplete(t,a,i,o,5),EmailSendingUtil.postGetAutoCompleteEntities(o,e,i)),EmailSendingUtil.autoCompleteAjaxReceived=!0,EmailSendingUtil.autoCompleteResultsReceived=!0,$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa");var s=$L("crm-email-picker-in-compose").get(0).component;s.setData("fromSearchCallBack",!0),s.methods.populateAutoCompleteData.call(s)}},error:function(e){200===e.status&&"parsererror"===e.statusText||EmailTabHomeUtil.handleAjaxAbort()}})}),300))},EmailSendingUtil.removeDuplicateColleagues=function(e){EmailSendingUtil.preLoadedAutoCompleteData.Colleagues&&(e.Colleagues=e.Colleagues.filter(EmailSendingUtil.removingExistingContacts))},EmailSendingUtil.removingExistingContacts=function(e){if(EmailSendingUtil.preLoadedAutoCompleteData.Colleagues.filterWithLimit(EmailSendingUtil.isSameContact(e),1).length<1)return!0},EmailSendingUtil.isSameContact=function(e){return function(i){if(i.CONTACT_PRIMARY_EMAIL===e.CONTACT_PRIMARY_EMAIL)return!0}},EmailSendingUtil.getFilteredValuesForAutoComplete=function(e,i,t,a,l){var o,n={};return $.each(EmailSendingUtil.AutoCompleteModulesArray,(function(s,m){"Users"===m&&EmailSendingUtil.userDetails[m]?o=EmailSendingUtil.userDetails[m].filterWithLimit(EmailSendingUtil.filterValuesForAutoComplete(e,i,t.toLowerCase(),m),l):a[m]&&(o=a[m].filterWithLimit(EmailSendingUtil.filterValuesForAutoComplete(e,i,t.toLowerCase(),m),l)),o&&0!=o.length&&(n[m]=o,o=null)})),n},EmailSendingUtil.filterValuesForAutoComplete=function(e,i,t,a){return function(l){l.EMAIL||(l.EMAIL="");var o=l.FULLNAME?l.FULLNAME:l.FIRSTNAME?l.FIRSTNAME+(l.LASTNAME?" "+l.LASTNAME:""):l.LASTNAME?l.LASTNAME:l.NAME?l.NAME:"";return!(a!==EmailSendingUtil.POTENTIALS||!(l.POTENTIALNAME.toLowerCase().startsWith(t)||l.EMAIL&&l.EMAIL.toLowerCase().startsWith(t))||!l.EMAIL||-1!==e.indexOf(l.EMAIL.toLowerCase()))||(!(a!==EmailSendingUtil.COLLEAGUES||!l.CONTACT_PRIMARY_EMAIL||!(l.CONTACT_FIRSTNAME&&l.CONTACT_FIRSTNAME.toLowerCase().startsWith(t)||l.CONTACT_LASTNAME&&l.CONTACT_LASTNAME.toLowerCase().startsWith(t)||l.CONTACT_FIRSTNAME&&l.CONTACT_LASTNAME&&(l.CONTACT_FIRSTNAME+" "+l.CONTACT_LASTNAME).toLowerCase().startsWith(t)||l.CONTACT_PRIMARY_EMAIL.toLowerCase().startsWith(t))||-1!=e.indexOf(l.CONTACT_PRIMARY_EMAIL.toLowerCase()))||(!(a!==EmailSendingUtil.LEADS&&a!==EmailSendingUtil.CONTACTS||!(l.FULLNAME.toLowerCase().startsWith(t)||l.FIRSTNAME&&l.FIRSTNAME.toLowerCase().startsWith(t)||l.LASTNAME&&l.LASTNAME.toLowerCase().startsWith(t)||l.EMAIL&&l.EMAIL.toLowerCase().startsWith(t)||l.ADDN_EMAIL&&l.ADDN_EMAIL.toLowerCase().startsWith(t))||!l.EMAILOPTOUT||"false"!==l.EMAILOPTOUT||!(l.EMAIL&&-1===e.indexOf(l.EMAIL.toLowerCase())||-1===i.indexOf(o.toLowerCase())))||(!!(a===EmailSendingUtil.CUSTOMODULE&&(l.NAME.toLowerCase().startsWith(t)||l.EMAIL&&l.EMAIL.toLowerCase().startsWith(t)||l.ADDN_EMAIL&&l.ADDN_EMAIL.toLowerCase().startsWith(t))&&l.EMAILOPTOUT&&"false"===l.EMAILOPTOUT&&(l.EMAIL&&-1===e.indexOf(l.EMAIL.toLowerCase())||-1===i.indexOf(o.toLowerCase())))||!("Users"!==a||!(l.FULLNAME.toLowerCase().startsWith(t)||l.FIRSTNAME&&l.FISRTNAME.toLowerCase().startsWith(t)||l.LASTNAME&&l.LASTNAME.toLowerCase().startsWith(t)||l.EMAIL&&l.EMAIL.toLowerCase().startsWith(t))||!(l.EMAIL&&-1===e.indexOf(l.EMAIL.toLowerCase())||-1===i.indexOf(o.toLowerCase().trim()))))))}},EmailSendingUtil.postGetAutoCompleteEntities=function(e,i,t){var a=$.trim($(i).val());if($.isEmptyObject(e))a&&a.split(",").length<2&&EmailSendingUtil.populateOrClearEntityId();else{var l='<div id="ecAutoCompleteContainerOuter"><div id="ecAutoCompleteContainerInner">',o=0,n="true"===$(i).attr("initialLiSelection"),s=0;$(i).hasClass("evCriteriaValue")&&(s=1),$.each(EmailSendingUtil.AutoCompleteModulesArray,(function(i,a){var m=e[a];if(null!=m&&m.length>0){var r;if(a===EmailSendingUtil.COLLEAGUES)l+='<h3 class="crm-font-regular crm-subheading-font-size mB5 mL10 cBoth fL mT10" style="color:#434D5F;">Address Book/Colleagues</h3>',l+=1==s?'<ul data-zcqa="emc_AutoComplete'+a+'" module='+a+" index="+o+' onclick="EmailSendingUtil.populateSearchValue(event)">':'<ul data-zcqa="emc_AutoComplete'+a+'" module='+a+" index="+o+" onclick=\"EmailSendingUtil.populateOrClearEntityId(event, '"+a+"')\">",$.each(m,(function(e,i){l+=EmailSendingUtil.constructLiForColleaguesResult(i,t,a,e,n)}));else r=a===EmailSendingUtil.USERS?a:Crm.moduleInfo[a]?Crm.moduleInfo[a].translatedPluralLabel:a,l+='<h3 class="crm-font-regular crm-subheading-font-size mB5 mL10 cBoth fL mT10" style="color:#434D5F;">'+r+"</h3>",l+=1==s?'<ul class="cBafter" data-zcqa="emc_AutoComplete'+a+'" module='+a+" index="+o+' onclick="EmailSendingUtil.populateSearchValue(event)">':'<ul class="cBafter" data-zcqa="emc_AutoComplete'+a+'"  module='+a+" index="+o+" onclick=\"EmailSendingUtil.populateOrClearEntityId(event, '"+a+"')\">",EmailSendingUtil.acResultIndex=0,$.each(m,(function(e,i){l+=EmailSendingUtil.constructLiForACResult(i,t,a,e,n)}));l+="</ul>",o++,n=!1}})),l+="</div></div>";var m=$("#ecAutoCompleteContainer");m.html(l),$("#ecAutoCompleteContainerOuter").addClass("pR");var r=$(i).offset(),d=($(i).width(),21);"ceToAddr"==$(i).attr("id")&&(d=22),m.css({left:r.left,top:r.top+1+d}),0==s&&EmailSendingUtil.isEntityWindow&&$("#ecAutoCompleteContainer").offset().left+$("#ecAutoCompleteContainer").outerWidth()+30>$(window).outerWidth()&&(m.removeAttr("style"),m.css({right:30,top:r.top-1+d})),1==s?m.attr("inputId",$(i).attr("id")):m.attr("inputId",$(i).closest("ul").find('li.ecAddrEditor input[type="text"]').attr("id")),EmailSendingUtil.bindAutoCompleteScroll()}EmailSendingUtil.autoCompleteResultsReceived=!0},EmailSendingUtil.populateOrClearEntityId=function(e,i,t){if(void 0!==i){if(!t)t=$(e.target).closest("li");var a=t.closest("#ecAutoCompleteContainer").attr("inputId"),l=$("#"+a),o=l.closest("li"),n=l.val();n=-1!==n.lastIndexOf(",")?n.substring(0,n.lastIndexOf(",")+1)+t.attr("email"):t.attr("email");var s=l.closest("ul").find("li:not(.ecAddrEditor)").find('input[type="text"]:not(.hide)');1===s.length?(s.val(n),EmailSendingUtil.rectifyEmail(s)):EmailSendingUtil.setUnameAndEmail(n,t.attr("username"),t.attr("photoUrl"),o,t.attr("entityId"),i,t.attr("phid")),EmailSendingUtil.selectedEntityEmail=t.attr("email");try{i||(i=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val());var m=t[0].getAttribute("entityid"),r=t.attr("username"),d={};d.suggestionLi=l.parent().parent(),d.record_name=r||n,EmailUtil.isRecordLockedAndMailRestricted(i,m,EmailUtil.handleRecordLocking,d)}catch(e){murphy.error(e)}}else EmailSendingUtil.isEntityWindow||(EmailSendingUtil.isNewEditor()?($("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(""),$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val("")):($("#ecEntityId").val(""),$("#moduleName").val("")));$("#ecAutoCompleteContainer").addClass("hide")},EmailSendingUtil.setUnameAndEmail=function(e,i,t,a,l,o,n,s,m){var r=EmailSendingUtil.getModuleAPIModuleName(o);CrmEmailInitialize&&CrmEmailInitialize.ComposeMailData&&CrmEmailInitialize.ComposeMailData.features_available&&CrmEmailInitialize.ComposeMailData.features_available.COMPOSE_CMODULE_TO_ADDR_NAME&&o&&r.includes("CustomModule")&&m&&!m.includes("searchResult_")&&(i=void 0),(e=$.trim(e))&&e.indexOf("<strong>")>-1&&e.indexOf("<strong>")<e.indexOf("</strong>")&&(e=(e=e.replace("<strong>","")).replace("</strong>",""));var d=s?a[0].closest("ul.mailToAddrUL"):a.closest("ul.mailToAddrUL"),c="";n=n||"",validationUtils.isValidEmail(e)?c+="<li class='fL selectedEmail'":($("#ecAutoCompleteContainer").addClass("hide").html(""),c+="<li class='fL invalidEmail'"),c+=" phid='"+n+"'",l&&(c+=" entityid='"+$ESAPI.encoder().encodeForHTMLAttribute(l)+"' "),m&&(c+=" emailType='"+m+"' "),o&&(c+=" module='"+$ESAPI.encoder().encodeForHTMLAttribute(o)+"' ");var p=$ESAPI.encoder().encodeForHTMLAttribute(e);c+='data-zcqa="emc_selected_'+$ESAPI.encoder().encodeForHTMLAttribute(e)+'"',i&&""!=i?(c+="username='"+$ESAPI.encoder().encodeForHTMLAttribute(i)+"' email='"+p+"' title='"+p+"' > <div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>",c+=t&&null!=t?"<span class='ecUserImage'><img src='"+t+"'  alt=''/></span>":"<span class='ecUserImage'><img src='"+(t=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM))+"'  alt=''/></span>",c+="<span class='fL ecSelectedUserName'>"+$ESAPI.encoder().encodeForHTML(i)):(c+="username='"+(i=e.substring(0,e.indexOf("@")))+"' email='"+p+"' title='"+p+"'> <div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>",c+=t&&null!=t?"<span class='ecUserImage'><img src='"+$ESAPI.encoder().encodeForHTMLAttribute(t)+"'  alt=''/></span>":"<span class='ecUserImage'><img src='"+(t=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM))+"'  alt=''/></span>",c+="<span class='fL ecSelectedUserName'>"+$ESAPI.encoder().encodeForHTML(i)),c+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_"+$ESAPI.encoder().encodeForHTMLAttribute(e)+"' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>",a.filter(".ecAddrEditor").length>0?$(c).insertBefore($(d).find(".ecAddrEditor")):$(a).replaceWith(c),$(d).find('li.ecAddrEditor input[type="text"]').val("").focus(),EmailSendingUtil.isEntityWindow||EmailSendingUtil.checkEntityAndAlert(),$("#ecAutoCompleteContainer").addClass("hide")},EmailSendingUtil.removeEmail=function(e){var i=$(e).parent("li").attr("emailType");EmailSendingUtil.removeMailTypeFromEmailPicker(i),$(e).parent("li").remove(),EmailSendingUtil.checkEntityAndAlert(),EmailSendingUtil.isNewEditor()?(EmailComposeUtil.setEmailAddresses(),EmailComposeUtil.closeZiaEmotionBand()):EmailSendingUtil.setEmailAddresses()},EmailSendingUtil.constructLiForColleaguesResult=function(e,i,t,a,l){var o="";l&&0==a&&(o=" class=autoCompleteSelectedLi");var n,s="",m="",r="",d="",c="",p="",E="",u="",C=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM);return e.CONTACT_FIRSTNAME&&(s=$.trim(e.CONTACT_FIRSTNAME)).length>0&&(r=s,s=EmailSendingUtil.highlightSearchFor(s,i)),e.CONTACT_LASTNAME&&(m=$.trim(e.CONTACT_LASTNAME)).length>0&&(d=m,m=EmailSendingUtil.highlightSearchFor(m,i)),n=E=r+" "+d,e.CONTACT_FIRSTNAME&&e.CONTACT_LASTNAME&&(s=$.trim(e.CONTACT_FIRSTNAME)).length>0&&(m=$.trim(e.CONTACT_LASTNAME)).length>0&&(E=EmailSendingUtil.highlightSearchFor(s+" "+m,i)),e.CONTACT_PRIMARY_EMAIL&&(c=$.trim(e.CONTACT_PRIMARY_EMAIL)).length>0&&(p=c,c=EmailSendingUtil.highlightSearchFor(c,i),u=$.trim(e.CONTACT_ZUID)),str="<li index="+a+" entityid='' phid='"+(u&&null!=u&&""!=u?u:"")+"' email='"+p+"' username='"+n+"'",null!=u&&""!=u&&(C="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+u+"&fs=thumb",str+="' photoUrl='"+C),str+="' "+o+"><div class='fL'> <span class='fL mR10' style='width:35px; height:35px'><img style='width:100%;' src='"+C+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+E+" </span><span class='cBoth fL'>"+c+"</span></div> </div>",str+="</li>",str},EmailSendingUtil.constructLiForACResult=function(e,i,t,a,l){var o="",n="",s=!1,m=!1,r=!1,d=0;1==l&&0==a&&(n=' class="autoCompleteSelectedLi"',l=!1),o=t&&"Potentials"==t?$.trim(e.POTENTIALNAME):t&&t==EmailSendingUtil.CUSTOMODULE?$.trim(e.NAME):$.trim(e.FULLNAME);var c=$.trim(e.EMAIL),p="";o.length>0&&(s=o.toLowerCase().indexOf(i.toLowerCase())>-1),c.length>0&&(m=c.toLowerCase().indexOf(i.toLowerCase())>-1),null!=e.ADDN_EMAIL&&(r=(p=$.trim(e.ADDN_EMAIL)).toLowerCase().indexOf(i.toLowerCase())>-1),s?d=3:m?d=2:r&&(d=1);var E=null!=e.PHOTO_FILEID?e.PHOTO_FILEID:"";return EmailSendingUtil.constructAndGetMatchedLi(a,e.SEID,E,c,o,p,d,n,i,t)},EmailSendingUtil.constructAndGetMatchedLi=function(e,i,t,a,l,o,n,s,m,r){var d="";if(3===n){var c=l;l=EmailSendingUtil.highlightSearchFor(l,m),d="<li index="+(e+EmailSendingUtil.acResultIndex)+" entityId='"+i;var p=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM);t&&(d+="' photoUrl='"+(p=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+r+"&entityId="+i+"&actionName=readImage&fileId="+t)),r===EmailSendingUtil.USERS&&i&&(d+="' photoUrl='"+(p="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+i+"&fs=thumb")),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(a)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(c)+"' "+s+"><div class='fL'> <span class='fL mR15' style='width:35px; height:35px'><img style='width:100%;' src='"+p+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+l+" </span>",d+="<span class='cBoth fL  crm-small-font-size'>"+$ESAPI.encoder().encodeForHTMLAttribute(a)+"</span></div> </div></li>",o&&(EmailSendingUtil.acResultIndex++,d+="<li index="+(e+EmailSendingUtil.acResultIndex)+" entityId='"+i,""!==p&&(d+="' photoUrl='"+p),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(o)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(c)+"'><div class='pR' style='left:-20px; top:2px;'><i class='eacStraightLine'></i><i class='eacCrossLine'></i></div> <div class='fL'> <span class='fL mR10 hide' style='width:35px; height:35px'><img style='width:100%;' src='"+p+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL hide'>"+l+" </span>",d+="<span class='cBoth fL crm-base-font-size pL50'>"+I18n.getMsg("crm.email.autocomplete.label.secondaryemail")+"</span></div> <div class='' style='padding:1px 0px'><span class='crm-small-font-size pL50'>"+$ESAPI.encoder().encodeForHTMLAttribute(o)+"</span></div></li>")}else if(2===n){var E=a;a=EmailSendingUtil.highlightSearchFor(a,m),d="<li index="+e+" entityId='"+i;p=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM);t&&(d+="' photoUrl='"+(p=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+r+"&entityId="+i+"&actionName=readImage&fileId="+t)),r===EmailSendingUtil.USERS&&i&&(d+="' photoUrl='"+(p="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+i+"&fs=thumb")),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(E)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(l)+"' "+s+"><div class='fL'> <span class='fL mR10' style='width:35px; height:35px'><img style='width:100%;' src='"+p+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+$ESAPI.encoder().encodeForHTML(l)+" </span>",d+="<span class='cBoth fL'>"+a+"</span></div> </div></li>"}else if(1===n){var u=o;o=EmailSendingUtil.highlightSearchFor(o,m),d="<li  index="+e+" entityId='"+i;p=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM);t&&(d+="' photoUrl='"+(p=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+r+"&entityId="+i+"&actionName=readImage&fileId="+t)),r===EmailSendingUtil.USERS&&i&&(d+="' photoUrl='"+(p="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+i+"&fs=thumb")),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(u)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(l)+"' "+s+"><div class='fL'> <span class='fL mR10' style='width:35px; height:35px'><img style='width:100%;' src='"+p+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+$ESAPI.encoder().encodeForHTML(l)+" </span>",d+="<span class='cBoth fL'>"+o+"</span></div> </div></li>"}return d},EmailSendingUtil.highlightSearchFor=function(e,i){var t=e.toLowerCase().indexOf(i.toLowerCase());if(t>-1){var a=$ESAPI.encoder().encodeForHTML(e.substring(0,t)),l=$ESAPI.encoder().encodeForHTML(e.substring(t,t+i.length)),o=$ESAPI.encoder().encodeForHTML(e.substring(t+i.length));return e=a+"<strong>"+l+"</strong>"+o}return null},EmailSendingUtil.highlightSearchString=function(e,i){if(!e)return e;var t=EmailCompose.decodeHTML(e);if(t.toLowerCase().startsWith(i.toLowerCase())){var a=t.toLowerCase().indexOf(i.toLowerCase());return $ESAPI.encoder().encodeForHTML(t.substring(0,a))+"<strong>"+$ESAPI.encoder().encodeForHTML(t.substring(a,a+i.length))+"</strong>"+$ESAPI.encoder().encodeForHTML(t.substring(a+i.length))}return null},EmailSendingUtil.populateWindowElementsHeight=function(){EmailSendingUtil.metaDetailHeight=0,EmailSendingUtil.summaryHeight=0,$(".ceComposeinfo").each((function(){$(this).is(":visible")&&(EmailSendingUtil.metaDetailHeight=EmailSendingUtil.metaDetailHeight+$(this).outerHeight())})),($(".ceSenderInfo").is(":visible")||$(".ceReceiverInfo").is(":visible"))&&(EmailSendingUtil.summaryHeight=EmailSendingUtil.summaryHeight+$("#ceRecipents").outerHeight()),EmailSendingUtil.editorHeight=EmailSendingUtil.defaultEditorHeight,EmailSendingUtil.totalHeight=EmailSendingUtil.metaDetailHeight+EmailSendingUtil.summaryHeight+EmailSendingUtil.editorHeight+$("#ecDisplayAttachmentNames").outerHeight()},EmailSendingUtil.setWindowElementsHeight=function(){var e=$("#emc_bestTime").length>0?$("#emc_bestTime").outerHeight()+10:0;if(EmailSendingUtil.totalHeight>0){EmailSendingUtil.metaDetailHeight=0,EmailSendingUtil.summaryHeight=0,$(".ceComposeinfo").each((function(){$(this).is(":visible")&&(EmailSendingUtil.metaDetailHeight=EmailSendingUtil.metaDetailHeight+$(this).outerHeight())})),($(".ceSenderInfo").is(":visible")||$(".ceReceiverInfo").is(":visible"))&&(EmailSendingUtil.summaryHeight=EmailSendingUtil.summaryHeight+$("#ceRecipents").outerHeight()),EmailSendingUtil.editorHeight=EmailSendingUtil.totalHeight-(EmailSendingUtil.metaDetailHeight+EmailSendingUtil.summaryHeight+$("#ecDisplayAttachmentNames").outerHeight()+e+20);var i=$(".ze_area");i.css("height",EmailSendingUtil.editorHeight),i.contents().find("body").css("height",EmailSendingUtil.editorHeight-20),$("#emailEditor").css("height",EmailSendingUtil.editorHeight)}},EmailSendingUtil.processAttachment=function(){for(var e=EmailSendingUtil.calculateFileSize(),i=document.getElementById("ecFileInput"),t=0;t<i.files.length;t++)e+=i.files[t].size;if(e<10485760)if(EmailSendingUtil.isEntityWindow)EmailSendingUtil.fillUploadData($(a).val());else{var a=$("#draftId");$(a).length>0&&""!==$(a).val()&&"null"!==$(a).val()?EmailSendingUtil.fillUploadData($(a).val()):EmailActionHandling.formDraft(!0)}else Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.restriction.individual.error1"))},EmailSendingUtil.fillUploadData=function(e){for(var i=document.getElementById("ecFileInput"),t=0;t<i.files.length;t++){EmailSendingUtil.displayAttachmentName(i.files[t].name,null,i.files[t].size);var a=new FormData;a.append("theFile",i.files[t]),e&&null!=e&&a.append("draftId",e),a.append(csrfParamName,csrfToken),EmailSendingUtil.startUpload(a,EmailSendingUtil.fileCount-1)}var l=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=l&&60!=EmailSendingUtil.attachmentContainerHeight){var o=l-EmailSendingUtil.attachmentContainerHeight;l>60&&($("#ecDisplayAttachmentNames").css({"max-height":"72px",overflow:"auto"}),o=72-EmailSendingUtil.attachmentContainerHeight,l=72),EmailSendingUtil.attachmentContainerHeight=l}EmailSendingUtil.resizeEditorHeight(o),EmailSendingUtil.filesAttached++;var n=document.getElementById("ecFileInput");n.value=n.defaultValue},EmailSendingUtil.startUpload=function(e,i,t){t=t||0;var a=new XMLHttpRequest,l=$("#ecAttachDetails"+i);EmailSendingUtil.filesFlag++,a.upload.onprogress=function(e){var i=e.loaded/e.total*100;l.parent().find(".ecAttachmentProgress").css("background","#1B6BCC"),l.parent().find(".ecAttachmentProgress").css("width",i+"%")},a.onload=function(){200==a.status?a&&"File Storage not available"===a.response?(Crm.showAlertMsg(I18n.getMsg("crm.view.attachment.add.nostorage")),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc"))):(l.parent().addClass("ecMailAttachment"),l.parent().attr("fileId",a.responseText),l.parent().find(".removeAttc").removeClass("hide"),l.parent().find(".abortAttc").addClass("hide"),EmailSendingUtil.filesFlag--):t<2?(EmailSendingUtil.filesFlag--,l.parent().find(".ecAttachmentProgress").css("width","100%"),l.parent().find(".ecAttachmentProgress").css("background","#CC1B1B"),setTimeout((function(){EmailSendingUtil.startUpload(e,i,t+1)}),1e3)):(Crm.showAlertMsg(I18n.getMsg("crm.email.attach.error")),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc")),EmailSendingUtil.filesFlag--)},l.parent().find(".abortAttc").on("click",(function(){a.abort(),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc")),EmailSendingUtil.filesFlag--})),a.onerror=function(){Crm.showAlertMsg(I18n.getMsg("crm.email.attach.error")),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc")),EmailSendingUtil.filesFlag--},l.value=0,a.open(EmailTabHomeUtil.POST_REQUEST_TYPE,EmailSendingUtil.URL+"?action=upload",!0),a.send(e)},EmailSendingUtil.removeFileFromZFS=function(e){var i=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.removeFileReq;$("#massMailId").length>0&&(i+="&massMailId="+$("#massMailId").val()),i+="&fileId="+e,i+="&"+csrfParamName+"="+csrfToken,$.ajax({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:EmailSendingUtil.URL,data:i,error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.uploadDocsAttachments=function(){var e=$("#draftId").val();EmailSendingUtil.isEntityWindow||e&&null!==e&&"null"!==e&&""!==e?EmailSendingUtil.processDocsAttachments():EmailActionHandling.formDraftAndUploadDocs()},EmailSendingUtil.processDocsAttachments=function(){for(i=0;i<EmailSendingUtil.docsAttachmentArray.length;i++){var e=EmailSendingUtil.docsAttachmentArray[i].split(":::")[0],t=EmailSendingUtil.docsAttachmentArray[i].split(":::")[1];t=e+":::"+(t=(t=t.replace(e+",","")).replace(",",":::"));EmailSendingUtil.filesAttached;EmailSendingUtil.saveAndUploadDocs(t,e);var a=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=a&&60!=EmailSendingUtil.attachmentContainerHeight){var l=a-EmailSendingUtil.attachmentContainerHeight;a>60&&($("#ecDisplayAttachmentNames").css({height:"60px",overflow:"auto"}),l=60-EmailSendingUtil.attachmentContainerHeight,a=60),EmailSendingUtil.attachmentContainerHeight=a,EmailSendingUtil.resizeEditorHeight(l)}EmailSendingUtil.filesAttached++}EmailSendingUtil.docsAttachmentArray=[]},EmailSendingUtil.saveAndUploadDocs=function(e,i){var t=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.attachDocuments;EmailSendingUtil.isEntityWindow?t+="&attachDoc="+encodeURIComponent(e):t+="&draftId="+$("#draftId").val()+"&attachDoc="+encodeURIComponent(e),t+="&"+csrfParamName+"="+csrfToken,EmailSendingUtil.filesFlag++,$.ajax({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:EmailSendingUtil.URL,data:t,success:function(e){if(!e)return EmailSendingUtil.filesFlag--,void Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.file.error"));if(Crm.userDetails.isNewEditor){var t={SZ:e.SZ,FILEID:e.FILEID,FILE_NAME:e.FILE_NAME};editor.zEditor.showAttachment(t)}else{EmailSendingUtil.displayAttachmentName(i,e.FILE_NAME);var a=EmailSendingUtil.fileCount-1,l=$("#ecAttachDetails"+a),o=EmailSendingUtil.calculateFileSize();EmailSendingUtil.zohoDocsAttachIncluded=!0,isNaN(parseInt(e.SZ))||(o+=parseInt(e.SZ)),o<10485760&&o>0?(l.parent().attr("fileId",e.FILEID),l.parent().addClass("ecMailAttachment"),l.parent().attr("fileSize",e.SZ),l.parent().find("p").html(EmailSendingUtil.bytesToSize(e.SZ)),l.parent().find(".removeAttc").removeClass("hide"),l.parent().find(".abortAttc").addClass("hide"),l.parent().find(".ecAttachmentProgress").css("width","100%"),setTimeout((function(){EmailSendingUtil.adjustAttachHeight()}))):o<=0?(EmailSendingUtil.removeAttachment(l),Crm.showAlertMsg(I18n.getMsg("errors.zeroByteFile"))):(EmailSendingUtil.removeAttachment(l),Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.restriction.individual.error1"))),EmailSendingUtil.filesFlag--}},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.adjustAttachHeight=function(){var e=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=e&&60!=EmailSendingUtil.attachmentContainerHeight){var i=e-EmailSendingUtil.attachmentContainerHeight;e>60&&($("#ecDisplayAttachmentNames").css({height:"60px",overflow:"auto"}),i=60-EmailSendingUtil.attachmentContainerHeight,e=60),EmailSendingUtil.attachmentContainerHeight=e,EmailSendingUtil.resizeEditorHeight(i)}},EmailSendingUtil.calculateFileSize=function(){var e=0;return $(".ecMailAttachment").each((function(){$(this).attr("fileSize")&&""!=$(this).attr("fileSize")&&(e+=parseInt($(this).attr("fileSize")))})),e},EmailSendingUtil.bytesToSize=function(e){if(isNaN(e)||0==e||-1==e)return"0 B";var i=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,i)).toPrecision(3)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][i]},EmailSendingUtil.initiateAttachment=function(){$("#ecDisplayAttachmentNames").removeClass("hide"),EmailSendingUtil.setWindowElementsHeight(),$(".ecForwardAttachment").each((function(){EmailSendingUtil.triggerAttachment($(this))}))},EmailSendingUtil.triggerAttachment=function(e){var i=$(e).find("span");EmailSendingUtil.attachFileType="IMAP"===EmailSendingUtil.mailType?EmailSendingUtil.attachIMAPDocuments:"GMail"===EmailSendingUtil.mailType?EmailSendingUtil.attachGMAILDocuments:"ZMAIL"===EmailSendingUtil.mailType?EmailSendingUtil.attachZMAILDocuments:EmailSendingUtil.attachSentMailDocuments;var t=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.attachFileType;EmailSendingUtil.attachFileType!==EmailSendingUtil.attachZMAILDocuments&&EmailSendingUtil.attachFileType!==EmailSendingUtil.attachGMAILDocuments||(t+="&msgid="+$("#msgid").val()),EmailSendingUtil.attachFileType===EmailSendingUtil.attachSentMailDocuments?t+="&aid="+$(e).attr("fileId"):t+="&aid="+$(e).attr("fileIndex"),EmailSendingUtil.isEntityWindow?t+="&userId="+i.attr("userId")+"&fileName="+encodeURIComponent(i.html()):t+="&draftId="+$("#draftId").val()+"&userId="+i.attr("userId")+"&fileName="+i.html(),t+="&uid="+i.attr("uid"),t+="&"+csrfParamName+"="+csrfToken,EmailSendingUtil.filesFlag++,(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:t,success:function(e){i.parent().attr("fileId",e.FILEID),i.parent().addClass("ecMailAttachment"),i.parent().attr("fileSize",e.SZ),i.parent().find("p").html(EmailSendingUtil.bytesToSize(e.SZ)),i.parent().find(".removeAttc").removeClass("hide"),i.parent().find(".ecAttachmentProgress").css("width","100%"),EmailSendingUtil.filesFlag--},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.checkEntityAndAlert=function(){var e=EmailSendingUtil.getCommaSeparatedEmails("ceToAddrDetails");""!==e&&""!==$("#ceToAddr").val()?e+=","+$("#ceToAddr").val():""===e&&""!==$("#ceToAddr").val()&&(e=$("#ceToAddr").val());var i=!0;if(e){var t=e.split(","),a=$("#ceToAddrDetails li.selectedEmail")[0],l=$(a).attr("module"),o=$(a).attr("entityid");l&&""!==l&&("Potentials"===l||"Leads"===l||"Contacts"===l)&&o&&""!==o?(t.length>1?$("#ceOptionToAlert").text(I18n.getMsg("crm.email.entity.store")):$("#ceOptionToAlert").text(""),i=!1):l||null!==t[0]&&validationUtils.isValidEmail(t[0])&&EmailSendingUtil.findAndSetEntity(t[0])}i&&$("#ceOptionToAlert").hide(),EmailSendingUtil.handleSaveAndSend()},EmailSendingUtil.handleSaveAndSend=function(){var e=$("#ceToAddrDetails li")[0],i=$(e).attr("module"),t=$(e).attr("entityid");i&&""!=i&&("Potentials"==i||"Leads"==i||"Contacts"==i)&&t&&""!=t?($(".emcSaveandSend").removeClass("hide"),$("#toSave").val("true"),$("#emcSendBtn").val(I18n.getMsg("crm.button.save")+" & "+I18n.getMsg("crm.button.send"))):($(".emcSaveandSend").addClass("hide"),$("#toSave").val("false"),$("#emcSendBtn").val(I18n.getMsg("crm.button.send"))),$(".ceVariousTextFormattingOptionContainer").css("left",$("#ecMailOptions").outerWidth())},EmailSendingUtil.findAndSetEntity=function(e){if(!EmailSendingUtil.isEntityWindow){var i=EmailTabHomeUtil.ACTION+"=findEntity";i+="&email="+encodeURIComponent(e),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailSendingUtil.URL,data:i,success:function(e){var i=$("#ceToAddrDetails li.selectedEmail")[0];null!=e?($(i).attr("module",e.module),$(i).attr("entityid",e.entityId),$(i).attr("username",e.username),$(i).find(".ecSelectedUserName").text(e.username),e.photoUrl&&"null"!=e.photoUrl&&""!=e.photoUrl?($(i).find(".ecUserImage img").attr("src",e.photoUrl),$(i).find(".ecUserImage").removeClass("hide")):($(i).find(".ecUserImage img").attr("src",networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM)),$(i).find(".ecUserImage").removeClass("hide"))):$(i).attr("module","UnMatched"),EmailSendingUtil.checkEntityAndAlert()},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailSendingUtil.editUnameAndEmail=function(e){var i="";i=e.attr("username")==e.attr("email")?e.attr("email"):e.attr("username")+"<"+e.attr("email")+">",e.css("background","var(--bg_white)"),e.find(".selUserDetails").addClass("hide"),e.append('<span class="userEmailDetailsTxt fL">'+EmailSendingUtil.removeHTMLTags(i)+"</span>");var t=e.find(".userEmailDetailsTxt").outerWidth();e.find(".userEmailDetailsTxt").hide(),e.find("input").removeClass("hide").css("width",t).val(i).focus()},EmailSendingUtil.rectifyEmail=function(e){var i=$(e).val(),t=$(e).parent();if(t.css("background",""),t.removeClass("selectedEmail"),t.removeClass("invalidEmail"),""!=i){t.find(".selUserDetails").removeClass("hide"),t.find("input").addClass("hide");var a=null,l="";-1!=i.indexOf("<")&&-1!=i.indexOf(">")?(a=i.substring(0,i.indexOf("<")),l=i.substring(i.indexOf("<")+1,i.indexOf(">")),$.trim(a).length<1&&(a=l)):(a=i,l=i),validationUtils.isValidEmail(l)?t.addClass("selectedEmail"):t.addClass("invalidEmail"),t.attr("username",a),t.attr("email")!=l&&(t.attr("email",l),t.attr("entityId",""),t.attr("module","")),t.attr("title",l),t.find(".ecSelectedUserName").text(EmailSendingUtil.removeHTMLTags(a)),t.attr("data-zcqa","emc_selected_"+EmailSendingUtil.removeHTMLTags(a)),t.find(".selUserDetails.closeIconB").attr("data-zcqa","emc_remove_"+EmailSendingUtil.removeHTMLTags(a));try{if(!EmailSendingUtil.isRecordLockingReqInitiated){EmailSendingUtil.isRecordLockingReqInitiated=!0,setTimeout((function(){EmailSendingUtil.isRecordLockingReqInitiated=!1}),1500);var o=t.attr("module"),n=t.attr("entityid"),s={};s.suggestionLi=t.parent(),s.record_name=a,EmailUtil.isRecordLockedAndMailRestricted(o,n,EmailUtil.handleRecordLocking,s)}}catch(e){murphy.error(e)}}else t.remove();$(e).closest("ul").find('li.ecAddrEditor input[type="text"]').focus()},EmailSendingUtil.bindAutoCompleteScroll=function(){var e=$("#ecAutoCompleteContainerOuter");e.find("#ecAutoCompleteContainerInner").css({height:"0px"});var i=$("#ecAutoCompleteContainer").outerHeight();i>400&&(i=400),e.css({height:i+"px"}),scrollHeight1=e[0].scrollHeight,e.css({overflow:"hidden"}),thirdPartyUtils.bindPerfectScroll("#ecAutoCompleteContainerOuter",{wheelSpeed:1,preventOnEnd:!1})},EmailSendingUtil.sendWithoutSaving=function(){EmailSendingUtil.validate()&&($("#toSave").val("false"),document.sendMailForm.submit())},EmailSendingUtil.setEntityAttachDetails=function(){var e="",i="",t="";$(".ecMailAttachment").each((function(){null!=$(this).attr("fileId")&&""!=$(this).attr("fileId")&&(""===e?(e=$(this).attr("fileId"),i=$(this).attr("fileName"),t=$(this).attr("fileSize")):(e+="####"+$(this).attr("fileId"),i+="####"+$(this).attr("fileName"),t+="####"+$(this).attr("fileSize")))})),$("#entAttachId").val(e),$("#entAttachName").val(i),$("#entAttachSize").val(t)},EmailSendingUtil.setTemplateShadow=function(){$(".ecvTemplateListOuter").on("wheel",(function(){$L(".ecvTemplateListOuter").scrollTop()>10?$(".ecSearchModules").addClass("settingsBottomshadow"):$(".ecSearchModules").removeClass("settingsBottomshadow")}))},EmailSendingUtil.setTemplateFromAddress=function(e){var i=$("[name='folderListDropdown']").find(".orgEmailsPart").clone();if(e&&null!=e&&"$(Record.Owner.Email)"==e){var t=$("#defaultFromAddr").val(),a='<span id="addrsVal" class="fL dropdownOptionSpan pL10 cP" selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'">'+$ESAPI.encoder().encodeForHTML(t)+'</span><span class="customSelectArrow fL"></span>';if(a+='<ul data-zcqa="emc_fromDropDown" name="folderListDropdown" class="dropdownOptionsList" style="top: 33px; display: none; min-width: 210px;" onclick="sE(event)">',a+='<li data-zcqa="emc_frm_0" lival="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'" class="customDropdownSelFieldLi" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+$ESAPI.encoder().encodeForHTML(t)+"</li>",a+='<li data-zcqa="emc_frm_0" lival="'+e+'" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+I18n.getMsg("crm.template.record.owner.email")+"</li></ul>",$("#addrsVal").parent().html(a),i.hasClass("customDropdownSelFieldLi")){var l=i.filter(".customDropdownSelFieldLi");$("[name='folderListDropdown']").find("li").removeClass("customDropdownSelFieldLi"),$("#addrsVal").attr("selectedval",l.attr("lival")),$("#addrsVal").text(l.text())}$("[name='folderListDropdown']").append(i)}else if(e&&null!=e&&"$(Current.User.Email)"!=e&&e!=t){t=$("#defaultFromAddr").val(),a='<span id="addrsVal" class="fL dropdownOptionSpan pL10 cP" selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'">'+$ESAPI.encoder().encodeForHTML(t)+'</span><span class="customSelectArrow fL"></span>';if(a+='<ul data-zcqa="emc_fromDropDown" name="folderListDropdown" class="dropdownOptionsList" style="top: 33px; display: none; min-width: 210px;" onclick="sE(event)">',a+='<li data-zcqa="emc_frm_0" lival="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'" class="customDropdownSelFieldLi" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+$ESAPI.encoder().encodeForHTML(t)+"</li>",a+='<li data-zcqa="emc_frm_0" lival="'+e+'" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+e+"</li></ul>",$("#addrsVal").parent().html(a),i.hasClass("customDropdownSelFieldLi")){l=i.filter(".customDropdownSelFieldLi");$("[name='folderListDropdown']").find("li").removeClass("customDropdownSelFieldLi"),$("#addrsVal").attr("selectedval",l.attr("lival")),$("#addrsVal").text(l.text())}$("[name='folderListDropdown']").append(i)}},EmailSendingUtil.setTemplateReplytoAddress=function(e){e&&null!=e&&($("#ceReplyToAddrSpan").attr("selectedval",e),$("#ceReplyToAddrSpan").html(e),$("#ceOption_replyto").removeClass("hide"))},EmailSendingUtil.removeFromAndReplytoAddress=function(){var e=$("[name='folderListDropdown']").find(".orgEmailsPart").clone();if(e.length<=0){var i=$("#defaultFromAddr").val(),t='<span id="addrsVal" class="fL dropdownOptionSpan pL10 " selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(i)+'">'+$ESAPI.encoder().encodeForHTML(i)+"</span>";$("#addrsVal").parent().html(t)}else{i=$("#defaultFromAddr").val(),t='<span id="addrsVal" class="fL dropdownOptionSpan pL10 cP" selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(i)+'">'+$ESAPI.encoder().encodeForHTML(i)+'</span><span class="customSelectArrow fL"></span>';if(t+='<ul data-zcqa="emc_fromDropDown" name="folderListDropdown" class="dropdownOptionsList" style="top: 33px; display: none; min-width: 210px;" onclick="sE(event)">',t+='<li data-zcqa="emc_frm_0" lival="'+$ESAPI.encoder().encodeForHTMLAttribute(i)+'" class="customDropdownSelFieldLi" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+$ESAPI.encoder().encodeForHTML(i)+"</li></ul>",$("#addrsVal").parent().html(t),e.hasClass("customDropdownSelFieldLi")){var a=e.filter(".customDropdownSelFieldLi");$("[name='folderListDropdown']").find("li").removeClass("customDropdownSelFieldLi"),$("#addrsVal").attr("selectedval",a.attr("lival")),$("#addrsVal").text(a.text())}$("[name='folderListDropdown']").append(e)}$("#ceReplyToAddrSpan").attr("selectedval",""),$("#ceReplyToAddrSpan").html(""),$("#ceOption_replyto").addClass("hide")};var dots=0;EmailSendingUtil.sendingPopup=function(){$("#emc_msg_Tab").hide(),$("#emc_msg_Tab").removeAttr("data-zcqa"),$("#emailEntityComposeOverlay").show();var e=$("#bestTime");e.length>0&&(e.is(":checked")?$("#emailEntityComposepopup").html(I18n.getMsg("scheduling")+'<span id="eECDots"></span>'):$("#emailEntityComposepopup").html(I18n.getMsg("sending")+'<span id="eECDots"></span>')),mailsetCenter("emailEntityComposepopup"),dotAnimate=setInterval(EmailSendingUtil.animateDots,200)},EmailSendingUtil.animateDots=function(){dots<3?($("#eECDots").append("."),dots++):($("#eECDots").text(""),dots=0)},EmailSendingUtil.formatEmail=function(e){return-1!=e.indexOf("<")&&-1!=e.indexOf(">")&&(e=e.substring(e.indexOf("<")+1,e.indexOf(">"))),e},EmailSendingUtil.formattedUsernameFromEmail=function(e){var i=null;return-1!=e.indexOf("<")&&-1!=e.indexOf(">")&&(i=""!=e.substring(0,e.indexOf("<"))&&null!=e.substring(0,e.indexOf("<"))?e.substring(0,e.indexOf("<")):null),i},EmailSendingUtil.bindSalesIqLinkEvents=function(){$(".salesIqLink").click((function(){var e=$("#ze_lnkurl");e.val(""),$("#siq_Url").text(""),$("#siq_trackingParam").text("");var i,t,a,l=$("#addLinkDiv");if(""===l.html()){var o=inSplnk.getDataReqTypeJson("","","addLinkPop");"undefined"!=typeof CrmPlusLib&&CrmPlusLib.isLoadedInCrmplusFrame?(Handlebars.registerPartial("DataRequestLinkTypes",Handlebars.templates.DataRequestLinkTypes),l.html(Handlebars.templates.AddLinkForEmailCompose(o))):(parent.Handlebars.registerPartial("DataRequestLinkTypes",parent.Handlebars.templates.DataRequestLinkTypes),l.html(parent.Handlebars.templates.AddLinkForEmailCompose(o)))}CustomizeEditor.initialize();var n="";EmailSendingUtil.isNewEditor()?(editor.zEditor.editorDiv.focus(),editor.zEditor.focusEditor(),a=(i=editor.zEditor.z_win.getSelection()).toString(),CustomizeEditor.selectedText=a,t=editor.zEditor.getParentNode(),window.document.documentMode?(CustomizeEditor.selectedArea=editor.zEditor.getRange(i),null===t.parentNode&&(t=editor.zEditor.editorDiv)):CustomizeEditor.selectedArea=i.getRangeAt(0)):((i=editor._getSelection()).rangeCount>0&&(CustomizeEditor.selectedText=editor._getSelectedText(),CustomizeEditor.selectedArea=i.getRangeAt(0)),t=editor.getParentElement()),null!==t&&"BODY"!==t.nodeName?(n=t.getAttribute("href"),CustomizeEditor.parentEle=t):CustomizeEditor.parentEle="",$("#addLinkPop").attr("value","zp_salesIqLink"),$(".removeForSalesIqLink").hide();EmailSendingUtil.isNewEditor()?($("#addLinkPop, #zp_SalesIqLink").add(l).show(),$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),EmailComposeUtil.showCustomFreezeLayer()):$("#custom_freeze, #addLinkPop, #zp_SalesIqLink").add(l).show(),n&&-1===n.search(/\$\{ConsentForm\.[a-zA-Z0-9_]+\}/)&&-1===n.search(/\$\{Datarequest\.[a-zA-Z0-9_]+\}/)&&e.val(n),EmailSendingUtil.fnUpdateSIQTracking()}))},EmailSendingUtil.fnUpdateSIQTracking=function(){var e=$("#ze_lnkurl").val().trim(),i=$("#siq_trackingParam"),t=CustomizeEditor.getPrimaryUserNameAndEmail(),a=t.username,l=t.emailAdd,o=!1,n=!1,s=e.split("?"),m=null;if((-1!==e.indexOf("siq_name=")||-1!==e.indexOf("siq_email="))&&s.length>1&&(m=s[1].split("&")).forEach((function(e){var i="siq_name="+encodeURIComponent(a),t="siq_email="+encodeURIComponent(l);!e.startsWith("siq_name=")||i!==e&&"siq_name="+a!=e?e.startsWith("siq_email=")&&t===e&&(n=!0):o=!0})),i.text(""),""==e)$("#siq_Url").text("");else if(""===e||-1===e.indexOf("siq_name=")&&-1===e.indexOf("siq_email=")||o&&n){if(""!==e&&-1===e.indexOf("siq_name=")){var r="";-1===e.indexOf("siq_name=")&&(r="siq_name="+a+"&siq_email="+encodeURIComponent(l));var d=e.length-1===e.lastIndexOf("?");e=-1===e.indexOf("?")||d?d?e:e+"?":e+"&",$("#siq_Url").text(e),i.text(r)}else if(o&&n&&null!=m){var c=s[0]+"?";r="siq_name="+a+"&siq_email="+encodeURIComponent(l);m.forEach((function(e){e.startsWith("siq_name=")||e.startsWith("siq_email=")||(c+=e+"&")})),$("#siq_Url").text(c),i.text(r)}}else $("#siq_Url").text(e)},EmailSendingUtil.bindInsertSurvey=function(){$(".surveyLink").click((function(){var e=$("input[id=ecEntityId]").val();$(this).attr("data-params",'{"action":"surveyDetails","from":"email","entityId":"'+e+'"}'),ZSurvey.showSurveyDetails(this);var i="";EmailSendingUtil.isNewEditor()?"undefined"!=typeof editor&&editor&&editor.zEditor&&(i=editor.zEditor.z_win.getSelection()):"undefined"!=typeof editor&&editor&&editor._getSelectedText&&(i=editor._getSelectedText());var t=i?i.toString():"";$("#textDispField").val(t)}))},EmailSendingUtil.bindSurveyEvents=function(){$(".surveyLink").click((function(e){event.stopPropagation();var i=$(this).offset(),t=i.top+35,a=i.left-274,l=t-10,o=$(".ppContSlide");if(Crm.userDetails.isNewEditor){var n=i.left-o.innerWidth(),s=i.top-10;$(".setDDPopupAbGzs").addClass("hide"),o.css({left:n,top:s}),setTimeout((function(){$(".ppContSlide").show()}),10)}else o.css({top:l+"px",left:a+"px",opacity:"1"}).show()})),$(".ppContSlide").click((function(e){e.stopPropagation()})),$(".goRight").click((function(){var e=$(".activeSlide").next(),i=$(".tSNum").text(),t=parseInt($(".cSNum").text());(t+=1)<=i&&($(".activeSlide").css({left:"-370px"}),$(".activeSlide").next().css({left:"0px"}),$(".activeSlide").removeClass("activeSlide"),$(e).addClass("activeSlide"),$(".cSNum").text(t),$(".goLeft").removeClass("disable")),t==i&&($(".goRight").hide(),$(".slideNumber").hide(),$(".fSlideBut").fadeIn())})),$(".goLeft").click((function(){$(".goRight ").show(),$(".fSlideBut").hide(),$(".slideNumber").show();var e=$(".activeSlide").prev(),i=($(".tSNum").text(),$(".cSNum").text());(i-=1)>0&&($(".activeSlide").css({left:"370px"}),$(e).css({left:"0px"}),$(".secSlide").removeClass("activeSlide"),$(e).addClass("activeSlide"),$(".cSNum").text(i)),1==i&&$(".goLeft").addClass("disable")}))},EmailSendingUtil.removeAttachments=function(){if(!EmailSendingUtil.isEmailProgressing&&!EmailSendingUtil.mailSentStatus){var e="";$(".ecMailAttachment").each((function(){null!=$(this).attr("fileId")&&""!=$(this).attr("fileId")&&(""===e?e=$(this).attr("fileId"):e+=","+$(this).attr("fileId"))})),""!=e&&EmailSendingUtil.removeFileFromZFS(e)}},EmailSendingUtil.dumpTemplateBody=function(){var e=$("#moduleName").val(),i=$("#ecTemplateId").val();EmailSendingUtil.isNewEditor()&&(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),EmailSendingUtil.getTemplateContentById(void 0,e,i),EmailSendingUtil.isTemplateDumped=!0},EmailSendingUtil.convertMergeFieldstoFieldIds=function(e,i){return CrmConvertMergeFields.convertMergeFieldsAsRequiredFormat(e,mergeFieldsConstants.fromlabel_to_id,i,!1,!1)},EmailSendingUtil.populateSearchValue=function(e,i){if(!i)i=$(e.target).closest("li");var t=i.closest("#ecAutoCompleteContainer").attr("inputId");email=i.attr("email"),$("#"+t).val(email),$("#ecAutoCompleteContainer").addClass("hide")},EmailSendingUtil.showDropDown=function(e){var i=$(e),t=i.find(".dropdownOptionSpan").attr("selectedVal");i.find(".dropdownOptionsList li").removeClass("customDropdownSelFieldLi");var a=i.find('.dropdownOptionsList li[liVal="'+t+'"]');a.length>1?"true"==$("#isOrgEmail").val()?a.filter(".orgEmailsPart").addClass("customDropdownSelFieldLi"):a.not(".orgEmailsPart").addClass("customDropdownSelFieldLi"):a.addClass("customDropdownSelFieldLi"),$(".dropdownOptionsList").length&&($(".dropdownOptionsList").hide(),$(".selectedCustomSpan").removeClass("selectedCustomSpan")),i.addClass("selectedCustomSpan"),i.find(".dropdownOptionsList").css("min-width",i.outerWidth()).show(),EmailSendingUtil.bindCreateCriteriaScroll()},EmailSendingUtil.bindCreateCriteriaScroll=function(e){var i=$("#etsCriteriaCreatorOuter"),t=$(e);if(i.is(":visible")){var a=$("#etMailSettings").outerHeight()-($("#etTabShadow").height()+$("#evSuggestedTitle").outerHeight())-30,l=i[0].scrollHeight;$("#etsCriteriaCreator").css({height:l}),i.css({height:a,overflow:"hidden"}),thirdPartyUtils.bindPerfectScroll("#etsCriteriaCreatorOuter",{wheelSpeed:1,preventOnEnd:!1}),evSuggestedViewsInner_isvisible||EmailTabSettings.setHeadingShadow("etsCriteriaCreatorOuter"),EmailTabSettings.criteriaEditorBlurEffect()}if("criteriaDiv"===t.closest("table.newFormContBlk").parent().attr("id")||"eiwfFolderDropDown"===t.attr("id")){t.find(".dropDownDiv ul").css({height:""});var o=t.find(".dropDownDiv")[0].scrollHeight;t.find(".dropDownDiv ul").css({height:o}),t.find(".dropDownDiv").css({overflow:"hidden"}),t.find(".dropDownDiv").perfectScrollbar({wheelSpeed:50,wheelPropagation:!0})}else if("ewfMultiselectSearch"===t.attr("id")){var n=t.closest("div").find("#iewfLabelsListUl");n.css({height:""}).find("ul").css({height:""}),(o=n[0].scrollHeight)>200&&(n.find("ul").css({height:o-20}),n.css({height:"200px",overflow:"hidden"}),n.perfectScrollbar({wheelSpeed:50,wheelPropagation:!0}))}},EmailSendingUtil.showOrgMailInfo=function(e){var i=$("#emc_msg_Tab");i.css({"z-index":"100"}),i.html(e),i.attr("data-zcqa","emc_SendTab_Error"),i.show().css("left",($(document).outerWidth()-i.outerWidth())/2)},EmailSendingUtil.selectDropdownVal=function(e,i){var t=$(e),a=t.closest("ul"),l=t.text(),o=t.attr("liVal");t.siblings().removeClass("selectedText customDropdownSelFieldLi"),t.addClass("selectedText customDropdownSelFieldLi"),t.closest("div").find(".dropdownOptionSpan").text(l).attr("selectedVal",o),a.hide(),$(".selectedCustomSpan").removeClass("selectedCustomSpan");var n=$("#emc_msg_Tab"),s=$("#isOrgEmail");if(EmailSendingUtil.isOrgEmailFlow=!1,i&&"replyTo"===i)n.is(":visible")?n.show:n.hide;else if(s.val("false"),n.hide(),i){s.val("true");var m=I18n.getMsg("crm.email.orgemail.message",[o]),r="",d=o.lastIndexOf("<"),c=o.lastIndexOf(">");r=-1!==d&&-1!==c&&c>d?o.slice(o.lastIndexOf("@")+1,c):o.slice(o.lastIndexOf("@")+1,o.length),JSON.parse(EmailSendingUtil.relayEnabledDomains).contains(r)||EmailSendingUtil.showOrgMailInfo(m),EmailSendingUtil.isOrgEmailFlow=!0}EmailSendingUtil.isSignatureForOldFlow&&EmailSendingUtil.setSignature(o)},EmailSendingUtil.setBestTime=function(e){var i=$("#emc_bestTime"),t=$("#bestTime"),a=$("#moduleName").val(),l=null,o=$("#ecRelEntityId");if("Leads"===a||"Contacts"===a)l=$("#ecEntityId").val()+"";else if(o.length>0&&null!==o.val()&&""!==o.val())l=o.val()+"",a="Contacts";else if("Vendors"===a||"Accounts"===a)return;if(Crm.userDetails.isNewEditor&&(t=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB),o=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB),i=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB),a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=o.val()),i.length>0&&null!==l&&""!==l&&Crm.userDetails.isBestTimeEnabledMail){"editInCompose"===EmailSendingUtil.action&&t.length>0&&""!==t.val()&&(i.removeClass("hide"),EmailSendingUtil.setWindowElementsHeight(),$("#ecSchduleTrigger").addClass("ecSchedulerBlueIcon"));var n=new crmRequestPool,s={id:l,module:a,reqDate:e.getTime(),type:"TEXT"},m={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid};n.initiate({action:"/crm/di/besttime",headers:m,type:"GET",data:s,success:function(i){if(i.data=i.data?i.data:{},void 0===i.data.user_time){var t=new Date;i.data.user_time={},i.data.user_time.hour=t.getHours(),i.data.user_time.minute=t.getMinutes()}EmailSendingUtil.bestTimeData=i,"editInCompose"!==EmailSendingUtil.action&&(EmailSendingUtil.besttimeSetflag?(EmailSendingUtil.processAndSetUpcomingBestTime(i),EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,l,e),EmailSendingUtil.besttimeSetflag=!1):EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,l,e))}})}i.mouseenter((function(){EmailSendingUtil.hoverStatus=1,setTimeout((function(){1==EmailSendingUtil.hoverStatus&&"bestTime"===$("#timeSource").val()&&i.find(".userTimeInfo").show()}),100)})),i.mouseleave((function(){EmailSendingUtil.hoverStatus=0,$(this).find(".userTimeInfo").hide()}))},EmailSendingUtil.processAndSetUpcomingBestTime=function(e){if(e.besttime&&e.data&&null!=e.data.user_time){var i=crmBstTime.getBestTimeByDay(e.besttime),t=e.data.user_time.hour,a=e.data.user_time.minute,l=null,o=null;i.length>0&&(l="tomorrow##"+i[0].bestTime.replace(" ","##"),o=EmailSendingUtil.getProperMsg(i[0].bestTime,"tomorrow"));for(var n=!0,s=0;s<i.length&&n;s++)if("hh:mm a"===Crm.userDetails.TIME_FORMAT){var m=i[s].bestTime.split(" ")[1],r=i[s].bestTime.split(" ")[0],d=r.split(":")[0],c=r.split(":")[1],p="12"===d||"pm"!==m&&"PM"!==m?0:12;(parseInt(d)+p>t||parseInt(d)+p===t&&parseInt(a)+10<c)&&(l="today##"+i[s].bestTime.replace(" ","##"),o=EmailSendingUtil.getProperMsg(i[s].bestTime,"today"),n=!1)}else{d=i[s].bestTime.split(":")[0],c=i[s].bestTime.split(":")[1];(parseInt(d)>t||parseInt(d)===t&&parseInt(c)>a+10)&&(l="today##"+i[s].bestTime.replace(" ","##"),o=EmailSendingUtil.getProperMsg(i[s].bestTime,"today"),n=!1)}null!=l&&EmailSendingUtil.suggestBestTime(l,o)}},EmailSendingUtil.suggestBestTime=function(e,i){var t=$("#emc_bestTime");t.find("label").html('<span class="fL mR10 mT1" data-zcqa=""></span>'+$ESAPI.encoder().encodeForHTML(i)),t.removeClass("hide"),$("#timeSource").val("bestTime"),$("#bestTime").val(e),EmailSendingUtil.setWindowElementsHeight()},EmailSendingUtil.processAndSetBestTime=function(e,i,t,a,l){if(e&&e.besttime){for(var o=crmBstTime.getBestTimeByDay(e.besttime),n=e.data.user_time.hour,s=e.data.user_time.minute,m="",r=0;r<o.length;r++){var d=o[r].level?"lev"+o[r].level:void 0;if("hh:mm a"===Crm.userDetails.TIME_FORMAT){var c=o[r].bestTime.split(" ")[1],p=o[r].bestTime.split(" ")[0],E=p.split(":")[0],u=p.split(":")[1],C="12"===E||"pm"!==c&&"PM"!==c?0:12;(t||parseInt(E)+C>n||parseInt(E)+C===n&&parseInt(u)>s+10)&&(""===m?m='<div class="ecSelectedBestTime ecwBestTimeOptions" onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="'+(""===c?"hrs":c)+'"  timeVal="'+o[r].bestTime+'">'+(d?' <i class=ecwBestTimeOptions"'+d+'"></i>':"")+o[r].bestTime+"</div>":m+='<div class="ecwBestTimeOptions" onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="'+(""===c?"hrs":c)+'" timeVal="'+o[r].bestTime+'">'+(d?' <i class=ecwBestTimeOptions"'+d+'"></i>':"")+o[r].bestTime+"</div>")}else{E=o[r].bestTime.split(":")[0],u=o[r].bestTime.split(":")[1];(t||parseInt(E)>n||parseInt(E)===n&&parseInt(u)>s+10)&&(""===m?m='<div class="ecSelectedBestTime" onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="hrs"  timeVal="'+o[r].bestTime+' hrs">'+(d?'<i class=ecwBestTimeOptions"'+d+'"></i>':"")+o[r].bestTime+" hrs</div>":m+='<div class="ecwBestTimeOptions" onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="hrs" timeVal="'+o[r].bestTime+' hrs">'+(d?' <i class=ecwBestTimeOptions"'+d+'"></i>':"")+o[r].bestTime+" hrs</div>")}}""!==m?$("#ecBestTimeListView").html(m):($("#ecBestTimeListView").html(I18n.getMsg("crm.besttime.mail.msg.none")),t||l||($("#ecSchduleTime").trigger("click"),EmailSendingUtil.isNewEditor()&&setTimeout(EmailCompose.resetSchedulePopupPosition,1e3)))}else t||l||($("#ecSelectedDate").addClass("hide"),$("#ecBestTimeListView").html(I18n.getMsg("crm.besttime.mail.record.none")),$("#ecSchduleTime").trigger("click"),EmailSendingUtil.isNewEditor()&&setTimeout(EmailCompose.resetSchedulePopupPosition,1e3))},EmailSendingUtil.getBestTimeForCompose=function(){var e=$("#bestTime");if(e.val()){EmailSendingUtil.besttimeReqflag=!1,EmailSendingUtil.besttimeSetflag=!1;var i=new Date(Number(e.val()));Utils.convertToUserTimezone(i);var t,a=new Date;Utils.convertToUserTimezone(a);var l,o=i.getHours(),n=i.getMinutes().toString(),s=(i.getFullYear(),(1+i.getMonth()).toString());s=("0"+s).slice(-2);var m=i.getDate().toString();m=("0"+m).slice(-2);var r=Utils.convertDateToUserPattern(i);if("hh:mm a"===Crm.userDetails.TIME_FORMAT){var d=o<12?"AM":"PM";t=r+"##"+(p=(p=(o>=12?o-12:o).toString()).length>1?p:"0"+p)+":"+(E=n.length>1?n:"0"+n)+"##"+d;var c=p+":"+E+" "+d}else{var p,E;t=r+"##"+(p=(p=o.toString()).length>1?p:"0"+p)+":"+(E=n.length>1?n:"0"+n);c=p+":"+E}var u=Math.abs(i.getTime()-a.getTime());l=1===Math.ceil(u/864e5)-1?I18n.getMsg("Tommorow"):I18n.getMsg(crmBstTime.getDayName(i))+", "+I18n.getMsg(crmBstTime.getMonthName(i))+" "+i.getDate();var C=EmailSendingUtil.getProperMsg(c,l);e.val(t),$("#timeSource").val("bestTime"),C=EmailSendingUtil.getProperMsg(c,l),EmailSendingUtil.suggestBestTime(t,C),EmailSendingUtil.checkButtonName(),i.setHours(0),i.setMinutes(0),i.setSeconds(0),EmailSendingUtil.setBestTime(i),EmailSendingUtil.besttimedate=l}},EmailSendingUtil.setCalendarBestTime=function(){var e=crmBstTime.constructDateObject($("#bstDate").val()),i=new Date,t="",a=$("#ecRelEntityId"),l=$("#moduleName").val();"Leads"===l||"Contacts"===l?$("#ecEntityId").val():a.length>0&&null!==a.val()&&""!==a.val()&&(a.val(),l="Contacts"),Utils.dateEquals(e,i)?(t=I18n.getMsg("Today"),EmailSendingUtil.setBestTime(e)):e-i<864e5&&i<e?(t=I18n.getMsg("Tommorow"),EmailSendingUtil.setBestTime(e)):(t=I18n.getMsg(crmBstTime.getDayName(e))+", "+I18n.getMsg(crmBstTime.getMonthName(e))+" "+e.getDate(),EmailSendingUtil.setBestTime(e)),$("#ecSelectedDate").text(t)},EmailSendingUtil.checkButtonName=function(){var e=$("#bestTime");if(Crm.userDetails.isNewEditor){if((e=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB)).length>0){var i=$("#emcSendBtn_"+EmailComposeUtil.CURRENT_TAB);e.is(":checked")?(i.addClass("hide"),$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide")):(i.removeClass("hide"),$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).addClass("hide"))}}else if(e.length>0){var t=$("#emcSendBtn");e.is(":checked")?($("#ecSchduleTrigger").addClass("ecSchedulerBlueIcon"),t.val(I18n.getMsg("crm.reportschedule"))):($("#ecSchduleTrigger").removeClass("ecSchedulerBlueIcon"),t.val(I18n.getMsg("crm.button.send"))),$(".ceVariousTextFormattingOptionContainer").css("left",$("#ecMailOptions").outerWidth())}},EmailSendingUtil.previewTemplateMergeFields=function(){var e=$("#ceAddtemplate").attr("templateid");Crm.userDetails.isNewEditor&&EmailSendingUtil.composeActive?0===$("#nTTemplateListDIV").length&&1===$("#emailEntityComposepopup").length&&(EmailUtil.showEditorFreezeLayer(),e=$("#ceAddtemplate_"+EmailComposeUtil.CURRENT_TAB).attr("templateid")):renderingUtils.freezeBackground(),template&&(template.featureName="sendMail");var i=Crm.getCrmBasePath()+"/Template.do?step=previewTemplate",t=csrfParamName+"="+encodeURIComponent(csrfToken);t+="&templateId="+encodeURIComponent(e),t+="&from=templateComponent",t+="&inventory="+template.inventory,template.templatePostCall("comp_previewTemplate",i,t)},EmailSendingUtil.showSchedulePopup=function(){var e=$("#schedulerPopup");e.length>0&&(""!==e.html()?EmailSendingUtil.setUPSchedulePopup():EmailSendingUtil.loadAndSetScheduleOptions(!1))},EmailSendingUtil.setUPSchedulePopup=function(e){$("#newFreezeLayer").removeClass("hide").css({opacity:"0.15"});var i=$(window),t=$("#schedulerPopup"),a=(i.outerWidth()-t.outerWidth())/2,l=(i.outerHeight()-t.outerHeight())/2;if(t.css({top:l,left:a}).show(),thirdPartyUtils.bindSelect2($(".newSelect select")),e){var o=$("#moduleName").val();"Leads"!==o&&"Contacts"!==o&&"Potentials"!==o&&$(".ecBestTimeScheduleli").addClass("hide"),"editInCompose"===EmailSendingUtil.action&&$("#ecSchduleTime").trigger("click"),EmailSendingUtil.timeInit()}},EmailSendingUtil.loadAndSetScheduleOptions=function(){var e=EmailTabHomeUtil.ACTION+"=loadScheduleOptions",i=$("#bestTime"),t=$("#timeSource"),a=$("#timeZoneSet");i.length>0&&null!==i.val()&&""!==i.val()&&"today"!==i.val()&&"tomorrow"!==i.val()&&t.length>0&&""==t.val()&&(e+="&timeVal="+i.val()),a.length>0&&""!==a.val()&&(e+="&timeZone="+a.val()),(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.GET_REQUEST_TYPE,data:e,success:function(e){var i=Handlebars.templates.TimeSchedule(e),t=$("#moduleName").val();$("#schedulerPopup").html(i),EmailSendingUtil.besttimeReqflag||$("#ecSelectedDate").text(EmailSendingUtil.besttimedate);var a=null;"Leads"===t||"Contacts"===t?a=$("#ecEntityId").val():"Potentials"===t&&(a=$("#ecRelEntityId").val()),EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,a),EmailSendingUtil.setUPSchedulePopup(!0)},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.hideSchedulePopup=function(){$("#newFreezeLayer").addClass("hide"),$("#schedulerPopup,#Calendar").hide()},EmailSendingUtil.assignTimeSchedule=function(e){var i="";if($("#ecSchduleBestTime").is(":checked")){var t=$(".ecSelectedBestTime");t.length>0?(i=EmailSendingUtil.getProperMsg(t.attr("timeVal"),$("#ecSelectedDate").html()),$("#bestTime").val($("#bstDate").val()+"##"+t.attr("time").replace(" ","##")),$("#timeSource").val("bestTime"),Crm.client_tracking("BestTime - Usage",{Module:$("#moduleName").val(),viewType:"Schedule Mail",BestTimeTo:"Text"}),EmailSendingUtil.setTime(i,e)):alert(I18n.getMsg("crm.besttime.mail.msg.none"))}else if($("#ecSchduleSendTime").is(":checked")){var a=$("#upcomingTime"),l=(i=(i=a.val().replace("##",", ")).replace("##"," ")).split(",");i=EmailSendingUtil.getProperMsg(l[1].toUpperCase(),l[0]),$("#timeSource").val("upTime"),$("#bestTime").val(a.val()),EmailSendingUtil.setTime(i,e)}else if($("#ecSchduleTime").is(":checked")){var o=$("#startDate");""!==o.val()?CrmDateUtils.dateTimeValidate("startDate","startDate","Date","G",void 0,void 0,!0)&&EmailSendingUtil.validateAndSetTime(o,e):(alert(I18n.getMsg("crm.besttime.mail.msg.date.empty")),o.focus())}},EmailSendingUtil.getProperMsg=function(e,i,t){i=i.trim();var a="",l=(e=e.toUpperCase().trim()).split(" ");return e="AM"===l[1]||"PM"===l[1]?l[0]+" "+I18n.getMsg(l[1]):l[0]+" "+I18n.getMsg("crm.workflow.scheduler.hours"),t&&(e+=" "+t),i?"today"===i||"Today"===i?(i=I18n.getMsg("Today"),a=I18n.getMsg("crm.besttime.mail.scheduleat")+" "+e+", "+i):"tomorrow"===i||"Tomorrow"===i?(i=I18n.getMsg("Tomorrow"),a=I18n.getMsg("crm.besttime.mail.scheduleat")+" "+e+", "+i):a=I18n.getMsg("crm.besttime.mail.scheduleon")+" "+i+" "+I18n.getMsg("crm.homepage.at")+" "+e:a=I18n.getMsg("crm.besttime.mail.scheduleat")+" "+e+" "+i,a},EmailSendingUtil.validateAndSetTime=function(e,i){var t=EmailTabHomeUtil.ACTION+"=validateTime",a=$("#schTimeMail"),l=$("#startDateampm"),o=$("#timeZone"),n=l.length>0&&""!==l.val()?l.val():"HRS",s=CrmDateUtils.convertDateTimetoISOFormat(e.val()+" "+a.val()+" "+n),m=$L.moment(CrmDateUtils.convertDateTimetoISOFormat(e.val()+" "+a.val()+" "+n)).timezone(o.val()?o.val():Crm.userDetails.USER_TIME_ZONE).format(),r=s.replace(s.slice(-6),m.slice(-6));$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(r),t+="&time="+encodeURIComponent(r),t+="&"+csrfParamName+"="+csrfToken,(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:t,success:function(t){if(t.time&&"Future"===t.time){if($("#defaultTZ").val()!==o.val()){var l=$("#timeZone option[value='"+o.val()+"']").text();l=l.substring(0,l.indexOf(")")+1),time=EmailSendingUtil.getProperMsg(a.val()+" "+n.toUpperCase(),EmailSendingUtil.formattedDate(e.val()),l)}else time=EmailSendingUtil.getProperMsg(a.val()+" "+n.toUpperCase(),EmailSendingUtil.formattedDate(e.val()));$("#timeSource").val("schTime"),$("#bestTime").val(e.val()+"##"+a.val()+"##"+n+"##"+o.val()),Crm.userDetails.isNewEditor?EmailComposeUtil.setTime(time,i):EmailSendingUtil.setTime(time,i)}else Crm.userDetails.isNewEditor?crmui.showMsgBand("error",I18n.getMsg("crm.besttime.mail.msg.future"),5e3):alert(I18n.getMsg("crm.besttime.mail.msg.future"))},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.validateScheduleTime=function(e,i){var t=EmailTabHomeUtil.ACTION+"=validateTime",a=$("#schTimeMail"),l=$("#startDateampm"),o=$("#timeZone").val();o||(o=Crm.userDetails.USER_TIME_ZONE);var n=l.length>0&&""!==l.val()?l.val():"HRS",s=$("#bestTime");if(EmailSendingUtil.isNewEditor()&&(s=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB)),s.length>0){var m,r=s.val().split("##"),d=r[0],c=r[1];n=r[2];"today"===d.toLowerCase()||"tomorrow"===d.toLowerCase()||d.toLowerCase().indexOf("to")>-1?(d=EmailDateTimeUtils.convertDateTodayTomorrow(d),m=Crm.userDetails.USER_TIME_ZONE):(m=r[3])||(m=o),d+"##"+c+"##"+n+"##"+encodeURIComponent(m),s.val().indexOf("##")>-1&&s.val(CrmDateUtils.convertDateTimetoISOFormat(d+" "+c+" "+n))}else e.val()+"##"+a.val()+"##"+n+"##"+encodeURIComponent(o);t+="&time="+encodeURIComponent(s.val()),(new crmRequestPool).initiate({headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:t,success:function(e){e.time&&"Future"===e.time?i():Crm.userDetails.isNewEditor&&crmui.showMsgBand("error",I18n.getMsg("crm.besttime.mail.msg.future"),5e3)},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.formattedDate=function(e){var i=new Date;Utils.convertToUserTimezone(i),newDate=crmBstTime.constructDateObject(e);return Utils.dateEquals(newDate,i)?I18n.getMsg("Today"):newDate-i<864e5&&i<newDate?I18n.getMsg("Tomorrow"):I18n.getMsg(crmBstTime.getDayName(newDate))+", "+I18n.getMsg(crmBstTime.getMonthName(newDate))+" "+newDate.getDate()},EmailSendingUtil.setTime=function(e,i){var t=$("#emc_bestTime");$("#bestTime").prop("checked",!0),t.find("label").html('<span class="fL mR10 mT1" data-zcqa=""></span>'+e),t.removeClass("hide"),EmailSendingUtil.setWindowElementsHeight(),$("#scheduledTime").removeClass("hide"),$("#ecSchduleTrigger").addClass("ecSchedulerBlueIcon"),EmailSendingUtil.hideSchedulePopup(),$("#emcSendBtn").val(I18n.getMsg("crm.reportschedule")),$(".ceVariousTextFormattingOptionContainer").css("left",$("#ecMailOptions").outerWidth()),i&&EmailSendingUtil.validate()&&($("#editorMode").val(editor.mode),document.sendMailForm.submit())},EmailSendingUtil.selectCheckBox=function(e){var i=$(e),t=document.getElementById("ecBestTimeListView");if(!(Crm.userDetails.isNewEditor&&i.find(".ecBestTimeList")[0]&&t)||t.innerText!==I18n.getMsg("crm.besttime.mail.msg.none")&&t.innerText!==I18n.getMsg("crm.besttime.mail.record.none")){$("#sDiv").hide();var a=$("#ecUpComing").is(":checked");a||i.find("input[name=ecScheduleTime]").prop("checked",!0),$("#schedulerPopup").find("li").removeClass("ecSelectedSchedule"),i.addClass("ecSelectedSchedule"),i.find("#timeZone").length?a||$("#timeZone").parent().slideDown():$("#timeZone").parent().hide(),i.find("#ecSchduleBestTime").length?$(".ecBestTimeList").find("div:first").addClass("ecSelectedBestTime"):$(".ecSelectedBestTime").removeClass("ecSelectedBestTime"),EmailSendingUtil.isNewEditor()&&setTimeout(EmailCompose.resetSchedulePopupPosition,300)}},EmailSendingUtil.chooseBestTime=function(e){var i=$(e);i.closest("li").trigger("click"),$(".ecSelectedBestTime").removeClass("ecSelectedBestTime"),i.addClass("ecSelectedBestTime"),EmailSendingUtil.ScheduledTime=i.attr("timeVal"),EmailSendingUtil.ScheduledDay=$("#ecSelectedDate").text()},EmailSendingUtil.timeInit=function(){populateTimeVal();var e="h12",i=$(".newtimefrmt");"HH:mm"===Crm.userDetails.TIME_FORMAT&&(e="h24"),i.addClass(e),"HH:mm"!==Crm.userDetails.TIME_FORMAT&&$(".ampmSpan").show(),$(".newtimefrmt,.newtimefrmt input,#startDateampmSpan,#schTimeMail").click((function(){if($("#timesData").find("#sdiv").show().css({left:$(this).offset().left,top:$(this).offset().top+20}),$(this).attr("scrolltoElem")){var e=$("#schTimeMail").attr("time"),i=!1;cur=0,$("#times li").each((function(){if($(this).attr("time")==e){var t=$(this).position().top;$L("#sdiv").scrollTop(t),$(this).addClass("li_hover"),i=!0}i||(cur+=1)}))}}))},EmailSendingUtil.featureSpecificHandling=function(){if(null!=window.opener&&window.opener.Crm.CurrentSendEmailSource&&"ChatBot"===window.opener.Crm.CurrentSendEmailSource){var e=window.opener.askZia.getDataFromOpener(),i=new Image(600,400);i.src=e;var t=$(".ze_area").contents().find(".ze_body");t.append("</br></br>"),t.append(i),t.append("<div></br></div>"),delete window.opener.Crm.CurrentSendEmailSource}},EmailSendingUtil.bindZohoFormsFunctions=function(){var e="#zforms_link";EmailSendingUtil.isNewEditor()&&(e=e+"_"+EmailComposeUtil.CURRENT_TAB),$(e).click((function(){var e=-1===Crm.crmSupportedLocales.indexOf(Crm.userDetails.LOCALE)?Crm.userDetails.RELEVANT_LOCALE:Crm.userDetails.LOCALE,i=networkUtils.returnDependencyFiles([e+".js"],ResourceConstants.CRMClient),t=networkUtils.returnDependencyFiles(["crux_"+e+".js"],ResourceConstants.CRMClient),a=networkUtils.returnDependencyFiles(["integration/crm-zforms-popup.js"],ResourceConstants.CRMClient),l=networkUtils.returnDependencyFiles(["integration/crm-zforms-popup.css"],ResourceConstants.CRMClient),o=networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("FormsIntegration")],ResourceConstants.CRM),n=i.concat(t).concat(a).concat(o).concat(l);EmailSendingUtil.isNewEditor()&&$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),Lyte.injectResources(n,void 0,(function(){var e=$("#moduleName").val();e||void 0===EmailComposeUtil||(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val());var i=moduleApiMapping&&moduleApiMapping[e]?moduleApiMapping[e]:e;store.findAll("form_links",{module:i,page:EmailSendingUtil.formsPage,per_page:EmailSendingUtil.formsPer_page}).then((function(t){var a={};a.module=e,a.form_links=t,a.entityId=$("#ecEntityId").val();var l="";EmailSendingUtil.isNewEditor()?"undefined"!=typeof editor&&editor&&editor.zEditor&&(l=editor.zEditor.z_win.getSelection()):"undefined"!=typeof editor&&editor&&editor._getSelectedText&&(l=editor._getSelectedText());var o=l?l.toString():"";if(a.title=o,a.formsPer_page=EmailSendingUtil.formsPer_page,a.apiName=i,a.hasNext=!(!t||!t.$.meta)&&t.$.meta.more_records,$L("#lookupdiv").html(""),Lyte.Component.render("crm-zforms-popup",a,"#lookupdiv"),document.getElementById("zforms_popup").ltProp("show",!0),EmailSendingUtil.isNewEditor()&&EmailSendingUtil.composeActive){var n=$L("#zforms_popup")[0],s=n.ltProp("wrapperClass");n.ltProp("wrapperClass",s+" emailComposeZindex")}}))})),window.opener&&window.opener.Crm&&window.opener.Crm.trackSpotLightAction("Forms Integ -EmailPop Insert Forms Link")}))},EmailSendingUtil.isNewEditor=function(){return Crm.userDetails.isNewEditor||EmailSendingUtil.composeActive&&!$("#oldtoNewDiv")[0]},EmailSendingUtil.setUnameAndEmailAddress=function(e,i){var t=$(e).closest("li"),a=$.trim($(i).val()),l=$("#ecAutoCompleteContainer");l.is(":visible")||a&&(a=a.replace(/,/g,""),EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(a),EmailSendingUtil.formattedUsernameFromEmail(a),null,t),l.addClass("hide").html(""))},EmailSendingUtil.getAddressesForNewCompose=function(e,i){for(var t,a=[],l=(t=i?$("#"+e+" .selectedEmail,#"+e+" .invalidEmail"):$("#"+e+" .selectedEmail")).length,o=0;o<l;o++){var n={};n.user_name=t[o].getAttribute("username"),n.email=t[o].getAttribute("email"),a.push(n)}return a},EmailSendingUtil.getApiNameForModule=function(e){var i=Crm.userDetails.MODULE_LIST[e],t=e;return i&&(t=i.api_name),t},EmailSendingUtil.isInventoryModule=function(e){return e||(e=$("#moduleName").val()),e||void 0===EmailComposeUtil||(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),"Invoices"===(e=EmailSendingUtil.getApiNameForModule(e))||"Sales_Orders"===e||"Purchase_Orders"===e||"Quotes"===e},EmailSendingUtil.isAutoCompleteSupportedModule=function(e){Crm.userDetails.isNewEditor&&!e&&(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val());var i=e.startsWith("CustomModule"),t=EmailSendingUtil.isInventoryModule(e);return!!(EmailSendingUtil.AutoCompleteModulesArray.indexOf(e)>-1||i||t)},EmailSendingUtil.addAttachmentsFromCloudPicker=function(e){var i=document.querySelector("crm-cloud-picker").component;i.hidePicker.call(i),EmailComposeUtil.tabIdVsAddingAttachmentCount.set(EmailComposeUtil.CURRENT_TAB,e?e.length:-2),$.each(e,(function(e,i){if(Crm.userDetails.isNewEditor){var t={};t.file_name=i.File_Name,t.file_size=null,t.id=i.$doc_id,t.id=i.$cloud_account_id,t.file_path=i.$file_path,t.file_details=i,t.service_name="otherDrives::"+i.$type;var a=EmailComposeUtil.getFormattedAttachmentDetails(t.id,i.File_Name,"","");a.file_details=i,editor.zEditor.showLoadingAttachment(a),zEditor.prototype.uploadFiles(t)}else i.service_name="otherDrives::"+i.$type,EmailSendingUtil.saveAndUploadDocs(JSON.stringify(i))}))},EmailSendingUtil.openOtherDriveAttachment=function(e){var i={feature:"attachments",cloud_services:"gdrive,box,skydrive",callback:EmailSendingUtil.addAttachmentsFromCloudPicker,max_file_selection:5};e&&(i.cloud_services="gdrive,box,skydrive,dropbox,evernote"),Crm.userDetails.GOOGLE_SHARED_DRIVE&&(i.cloud_services="gdrive,googleTD"),Lyte.injectResources(networkUtils.returnDependencyFiles(["crm-cloud-picker-mixin.js"],ResourceConstants.CRMClient),void 0,(function(){Lyte.registeredMixins["crm-cloud-picker-mixin"].loadCloudPicker(i)}))},EmailSendingUtil.getFontList=function(){return{Arial:"Arial,Helvetica,sans-serif",Calibri:"Calibri,Candara,Segoe,Segoe UI,Optima,Arial,sans-serif","Comic Sans MS":"Comic Sans MS,cursive,sans-serif","Courier New":"Courier New,Courier,monospace",Georgia:"Georgia,Times New Roman,Times,serif","Lucida Console":"Lucida Console,Monaco,monospace","Lucida Sans Unicode":"Lucida Sans Unicode,Lucida Grande,sans-serif","MS Serif":"MS Serif,New York,serif",Tahoma:"Tahoma,Geneva,sans-serif","Times New Roman":"Times New Roman,Times,serif","Trebuchet MS":"Trebuchet MS,Arial,Helvetica,sans-serif",Verdana:"Verdana,Geneva,sans-serif"}},EmailSendingUtil.setDefaultValues=function(){var e=EmailSendingUtil.signDetails;e.font_size&&editor.doc.execCommand("fontsize",!1,{8:"1",10:"2",12:"3",14:"4",18:"5",24:"6",36:"7"}[e.font_size]),e.font_family&&editor.doc.execCommand("fontname",!1,EmailSendingUtil.getFontList()[e.font_family]);var i=EmailSendingUtil.signDetails.default_from_address.email,t=EmailSendingUtil.signDetails.default_from_address.type,a=$("#addrsVal");a.attr("selectedval",i),"org_email"===t&&($("#isOrgEmail").val(!0),EmailSendingUtil.signDetails.default_from_address.user_name&&(i=EmailSendingUtil.signDetails.default_from_address.user_name+"<"+i+">")),a.text(i)},EmailSendingUtil.setSignature=function(e){var i;if(!document.getElementById("editorSignatureContainer")&&$("#ceCleartemplate").parent().hasClass("hide")){if(e){var t=e.indexOf("<"),a=e.indexOf(">");-1!==t&&-1!==a&&t<a&&(e=e.slice(t+1,a))}var l=!1,o=EmailSendingUtil.signDetails.email_signatures;if(o)for(var n=o.length,s=0;s<n&&!l;s++)if(e&&o[s].from){for(var m=o[s].from.length,r=0;r<m;r++)if(e===o[s].from[r].email){i=o[s].content,l=!0;break}}else if(o[s].default){i=emailSignatures[s].content;break}var d=editor.mode,c=editor.doc.getElementById("ecw_signature"),p=$L(".ze_area").contents().find(".ze_body")[0];if("richtext"===d){if(e&&c)return i||(i=""),void(c.innerHTML=i);i=i?"<br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'><br><br>"+i+"</span>":"<br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'><br><br></span>",c||(p.innerHTML.includes("<div>")?editor.setContent(i):p.innerHTML=e?p.innerHTML+i.replace("<br><br><br><br><br><br><br><br><br><br><br><br><br>",""):p.innerHTML+i.replace("<br><br><br><br><br><br><br><br><br>",""))}else e&&i&&editor.getContent()?editor.setContent(editor.getContent()+"\n"+EmailSendingUtil.convertToPlainText(i)):i=i?"\n\n\n\n"+EmailSendingUtil.convertToPlainText(i):"\n\n\n\n"}},EmailSendingUtil.closeTabALertPopup=function(){if(!EmailSendingUtil.openTabALertPopup){var e=$L("#ecwTabPop")[0];e&&e.ltProp("show",!1)}},EmailSendingUtil.convertToPlainText=function(e){var i=document.createElement("div"),t=ZSEC.HTMLPurifier({ALLOWED_STYLE:"ALL",STYLE_VALIDATION:!1});i.innerHTML=t.sanitize(e.replace(/<(p|div|h\\d|br)>/gi,"\n"));var a=i.innerText;return i=void 0,a},EmailSendingUtil.removeMailTypeFromEmailPicker=function(e){var i=!1;0===$L("#emailPickerComponent_"+EmailComposeUtil.CURRENT_TAB).length&&(EmailComposeUtil.emailPickerCalledFor[EmailComposeUtil.CURRENT_TAB]="#emailPickerToAddr_",Lyte.Component.render("crm-email-picker-in-compose",[],"#emailPickerToAddr_"+EmailComposeUtil.CURRENT_TAB),i=!0);for(var t=$L("crm-email-picker-in-compose"),a=t.length,l=0;l<a;l++){var o=t.get(l).component;if(o)if(o.getData("ltPropQuery").includes(EmailComposeUtil.CURRENT_TAB))var n=o;else if(i)n=t.get(0).component}n&&n.methods.emailAddressRemoved.call(n,e)},EmailSendingUtil.isSendMailPermissionAvailableForCurrentProfile=function(e){return!Crm.SEND_MAIL_BUTTON_HIDE||void 0!==Crm.userDetails.permissions["Crm_Implied_Send_Mail_"+e]&&Crm.userDetails.permissions["Crm_Implied_Send_Mail_"+e]};var EmailComposeUtil={mailSentStatus:!1,APIBaseURL:"/crm/email/v2",InlineImageURL:"/Emails/inline_images",ComoposeMailData:void 0,resourcesLoaded:!1,editorLoaded:!1,hasDictionarySourceAdded:!1,editorContent:"",freezeLayerId:"z1_freezeLayer",DraftsAction:"__email_drafts",Draft_Root_Element:"__email_drafts",DraftAPIURL:"/crm/v6",draftInterval:null,sessionStoredDraftDetails:null,sessionStoredDraftId:null,isAutoCorrectionEnabled:!0,FILE_SIZE:"file_size",FILE_NAME:"file_name",FILE_ID:"id",SERVICE_NAME:"service_name",Attachment:{}};EmailComposeUtil.Attachment.Desktop="Desktop",EmailComposeUtil.Attachment.ZFS_ATTACHED="ZFSAttached",EmailComposeUtil.INVENTORY_DETAILS="inventory_details",EmailComposeUtil.GET_TEMPLATE_DETAIL_BY_ID="getTemplatesDetailById",EmailComposeUtil.EDIT_IN_COMPOSE="editInCompose",EmailComposeUtil.totalAttachmentSize="10 MB",EmailComposeUtil.INVENTORY_TEMPLATE_API_URL="/crm/v2/settings/inventory_templates",EmailComposeUtil.RL_Attachments={},EmailComposeUtil.RL_Attachments.ATTACHMENT_ID="id",EmailComposeUtil.RL_Attachments.ZFS_FILE_ID="$file_id",EmailComposeUtil.RL_Attachments.FILE_NAME="File_Name",EmailComposeUtil.RL_Attachments.FILE_SIZE="Size",EmailComposeUtil.RL_Attachments.CREATED_TIME="Created_Time",EmailComposeUtil.RL_Attachments.MODIFIED_TIME="Modified_Time",EmailComposeUtil.RL_Attachments.FILES_COUNT=10,EmailComposeUtil.MAX_TAB_COUNT=5,EmailComposeUtil.CURRENT_TAB=0,EmailComposeUtil.TAB_COUNT=0,EmailComposeUtil.OPEN_TAB_COUNT=0,EmailComposeUtil.tabIdPrefix="ecw_tab_",EmailComposeUtil.contentIdPrefix="composeContentPanel_",EmailComposeUtil.editorObj={},EmailComposeUtil.tabDetails={},EmailComposeUtil.composeSettingObj=null,EmailComposeUtil.TEMP_TAB=void 0,EmailComposeUtil.disableAttachSizeCalc=!1,EmailComposeUtil.isReplyMail=!1,EmailComposeUtil.isCloseAll=!1,EmailComposeUtil.isRefresh=!1,EmailComposeUtil.tempFontSize="",EmailComposeUtil.isConsentEmail=[],EmailComposeUtil.dataReqObj=[],EmailComposeUtil.lastDraftUpdatedTime=0,EmailComposeUtil.replyOrForWardMail=[],EmailComposeUtil.tempforwardAttach=[],EmailComposeUtil.tabIdVsModuleName={},EmailComposeUtil.tabIdVsEntityName={},EmailComposeUtil.entityIdVsTabIds={},EmailComposeUtil.tabIdVsAddingAttachmentCount=new Map,EmailComposeUtil.tabIdVsAttachmentDetails=new Map,EmailComposeUtil.tempSmartSignature=[],EmailComposeUtil.initialContent=[],EmailComposeUtil.currentEntityName=[],EmailComposeUtil.configuredEmail=null,EmailComposeUtil.isContactEmailOptOut=!1,EmailComposeUtil.CustomModuleForLinkToModule=Object.keys(Object.keys(Crm.moduleInfo).filter((e=>e.includes("CustomModule"))).reduce(((e,i)=>Object.assign(e,{[Crm.moduleInfo[i].apiname]:[i]})),{})),EmailComposeUtil.linkToModuleRendered=[],EmailComposeUtil.linkToModuleSelected=[],EmailComposeUtil.linkedModule=[],EmailComposeUtil.getDraftModule="",EmailComposeUtil.fromGetDraftLinkedModule=null,EmailComposeUtil.linkToModuleDraftChanged=[],EmailComposeUtil.sendMailButtonCalled=!1,EmailComposeUtil.composeEmailAddresses=[],EmailComposeUtil.emailPickerCalledFor=[],EmailComposeUtil.linkedModuleFromAccounts=null,EmailComposeUtil.relatedContactEmails=[],EmailComposeUtil.selectedEmails=[],EmailComposeUtil.selectedFromSearch=[],EmailComposeUtil.handleTemplateAttachments=function(e,i,t){var a=e.split(";"),l=i.split(";"),o=t.split("&#x3b;"),n=0,s=a.length;for(n=0;n<s&&""!==a[n];n++){var m,r=l[n];o[n]&&(m=o[n].split("&#x3a;&#x3a;")[2]);var d=a[n],c=EmailComposeUtil.getFormattedAttachmentDetails(m,d,r,"RawZFSFile");editor.zEditor.displayAttachment(c)}},EmailComposeUtil.formatAttachmentSize=function(e){var i=parseInt(e)/1048576;if(i>=1||i<=-1)e=(i=i.toPrecision(3))+" MB";else{if(void 0===e)return e="";e=(i=parseInt(e)/1024)>=1||i<=-1?(i=i.toFixed())+" KB":parseInt(e)+" Bytes"}return e},EmailComposeUtil.setMessagesForAlerts=function(){EmailSendingUtil.maxLimitExceedsMsg.to=I18n.getMsg("crm.email.to.check"),EmailSendingUtil.maxLimitExceedsMsg.bcc=I18n.getMsg("crm.email.bcc.check"),EmailSendingUtil.maxLimitExceedsMsg.cc=I18n.getMsg("crm.email.cc.check"),EmailSendingUtil.maxLimitExceedsMsg.replyTo=I18n.getMsg("crm.email.inreplyto.check"),EmailSendingUtil.maxLimitExceedsMsg.toCcBcc=I18n.getMsg("crm.email.toccbcc.check")},EmailComposeUtil.pastEventHandle=function(e){const i=zEditor.prototype.getSelection();if(i.rangeCount>0){var t=i.getRangeAt(0);const o=document.createElement("span");if(1===e.clipboardData.types.length&&e.clipboardData.types.includes("text/plain"))o.innerText=e.clipboardData.getData("text/plain");else{if(e.clipboardData.types.length>1&&e.clipboardData.types.includes("text/rtf")&&e.clipboardData.types.includes("text/plain"))return;e.clipboardData.types.length>1&&e.clipboardData.types.includes("text/html")&&(o.innerHTML=e.clipboardData.getData("text/html"))}e.preventDefault();for(var a,l=document.createDocumentFragment();o.firstChild;)a=l.appendChild(o.firstChild);t.deleteContents();try{t.insertNode(l)}catch(e){t.startContainer.activeElement.appendChild(l)}a&&((t=t.cloneRange()).setStartAfter(a),t.collapse(!0),i.removeAllRanges(),i.addRange(t))}},EmailComposeUtil.assignTimeSchedule=function(e){var i="",t=$("#ecUpComing");if($("#ecSchduleBestTime").is(":checked")){var a=$(".ecSelectedBestTime");if(!(a.length>0))return crmui.showMsgBand("error",I18n.getMsg("crm.besttime.mail.msg.none"),5e3),!1;i=EmailSendingUtil.getProperMsg(a.attr("timeVal"),$("#ecSelectedDate").html()),$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val($("#bstDate").val()+"##"+a.attr("time").replace(" ","##")),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecSchduleBestTime"),EmailComposeUtil.setTime(i,e)}else if($("#ecOneHourAhead").is(":checked")){var l=new Date;Utils.convertToUserTimezone(l);var o,n=("0"+l.getHours()).slice(-2),s=("0"+l.getMinutes()).slice(-2),m="today",r=Crm.userDetails.TIME_FORMAT;n=parseInt(n),s=parseInt(s),n>=23?(m="tomorrow",n=0):n+=1,"hh:mm a"===r?(n<12?o="AM":n>=12&&(o="PM"),i=(n=("0"+(n=n<=12?n:n-12)).slice(-2))+":"+(s=("0"+s).slice(-2))+" "+o):i=(n=("0"+n).slice(-2))+":"+(s=("0"+s).slice(-2))+" "+I18n.getMsg("crm.workflow.scheduler.hours"),$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(m+"##"+i.replace(" ","##")),i=EmailSendingUtil.getProperMsg(i,m),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecOneHourAhead"),EmailComposeUtil.setTime(i,e)}else if(t.is(":checked")){var d=t.val(),c=(r=Crm.userDetails.TIME_FORMAT,d.split("##")),p=(l=c[0],i=c[1],c[2]);"hh:mm"===r.toLowerCase()&&(i="20:00",p=I18n.getMsg("crm.workflow.scheduler.hours"));var E=(d=l+"##"+i+"##"+p).replace("##",", "),u=(E=E.replace("##"," ")).split(",");E=EmailSendingUtil.getProperMsg(u[1].toUpperCase(),u[0]),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecUpComing"),$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(d),EmailComposeUtil.setTime(E,e)}else if($("#ecSchduleTime").is(":checked")){var C=$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB);""!==C.val()?CrmDateUtils.dateTimeValidate("startDate","startDate","Date","G",void 0,void 0,!0)&&EmailSendingUtil.validateAndSetTime(C,e):(renderingUtils.showCustomAlert(I18n.getMsg("crm.besttime.mail.msg.date.empty")),C.focus()),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecSchduleTime")}},EmailComposeUtil.setTime=function(e,i){var t=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB),a=$("#ecMailOptions").outerWidth();$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).prop("checked",!0),EmailSendingUtil.checkButtonName(),t.find("label").html('<span class="fL mR10 mT1" data-zcqa=""></span>'+e),t.removeClass("hide"),EmailSendingUtil.setWindowElementsHeight();var l=$("#startDate");$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB).val(l.val()),EmailUtil.hideSchedulePopUp(),$("#ecScheduledTime_"+EmailComposeUtil.CURRENT_TAB).html(EmailSendingUtil.ScheduledTime+", "+EmailSendingUtil.ScheduledDay),$(".ceVariousTextFormattingOptionContainer_"+EmailComposeUtil.CURRENT_TAB).css("left",a),i&&EmailCompose.sendMail(i)},EmailComposeUtil.setIntialValuesForScheduleMail=function(){var e=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB);e[0].value=e[0].value.replace(/[']/g,"");var i,t=e.is(":checked"),a=$("#startDate"),l=$("#schTimeMail");if($("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB).val(a.val()),l.focus(),t){i=e.val();var o=(i=EmailDateTimeUtils.formatDate(i)).getDate(),n=i.getMonth(),s=i.getFullYear();try{crmCalendar.setCalendarNode=a,crmCalendar.displaySelectedDate(o+" "+n+" "+s,a)}catch(e){murphy.error("Exeption while displaySelectedDate function execute"),murphy.error(e)}var m=Utils.getTimeInUserFormat(i);l.focus();var r=Crm.userDetails.TIME_FORMAT;m=EmailComposeUtil.getNextFormattedScheduleTime(m,r),sdTime||(sdTime=$(".ddTime"));try{setTime(m)}catch(e){murphy.error(e)}l.focus()}},EmailComposeUtil.deleteDraft=function(e,i,t,a){var l=EmailComposeUtil.getAPIDraftURL(e,i,t);(new crmRequestPool).initiate({url:l,type:"DELETE",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},success:function(i){if("success"===(i=i.__email_drafts[0]).status){e=i.details.id;var t=EmailComposeUtil.getTabIdContainingGivenDraft(e);t&&!a&&EmailUtil.closeEmailTab(t,!0),EmailComposeUtil.removeDraftIdFromSessionStorage(e),($("#maxComposeBtn").hasClass("hide")&&!EmailSendingUtil.composeActive||$("#draftMails").hasClass("selectTab"))&&EmailComposeUtil.refreshDraftsList()}else"NO_PERMISSION"===i.code?EmailUtil.showMsg("error",I18n.getMsg("crm.security.error"),3e3):EmailUtil.showMsg("error",I18n.getMsg("crm.email.no.drafts.msg"),3e3)},error:function(i){i=i.responseJSON;var t=$("#deleteDraftIcon")[0],l=$("#"+e+"relatedlist")[0];t&&(t.classList.remove("loading"),t.classList.add("deleteIcon")),l&&(l.classList.remove("loading"),l.classList.add("deleteIcon")),EmailSendingUtil.composeActive&&!a&&EmailUtil.closeMailContentView(!0),"NO_PERMISSION"===i.code?EmailUtil.showMsg("error",I18n.getMsg("crm.security.error"),3e3):i.message&&i.message.includes("The record is in stop processing")?EmailUtil.showMsg("error",I18n.getMsg("crm.email.error.draft.delete.locked"),3e3):i.responseJSON&&"the related id given seems to be invalid"===i.responseJSON.message?EmailUtil.showMsg("error",I18n.getMsg("crm.email.label.error.item_deleted_or_removed",I18n.getMsg("Record")),3e3):EmailUtil.showMsg("error",I18n.getMsg("crm.email.no.drafts.msg"),3e3)}})},EmailComposeUtil.refreshDraftsList=function(){try{var e=$("#selectMails"),i="";if(void 0!==e&&e.length>0||$("#draftMails").length>0)if("DRAFTS"===e.val()){var t=$("#mailNav #navigationIndex");if(t&&t.length>0)var a=t.text(),l=parseInt(a)-10+"",o=$("#mailNav #navigationEntityId").text(),n=$("#mailNav #navigationModule").text(),s=$("#mailNav #navigationFullname").text();else l=-10,o=$("#entityId").val(),n=$("#module").val(),s=$("#fullname").val();var m=$("#mailTable").children().children(".topband_dv_row").length;l>=0&&m<=1&&(i="previous"),showMailsList(o,"",s,"",l,i,n)}else $("#isFromNewAPI").length>0&&showMailsListViaAPI("","-10","next",null,"draftMails")}catch(e){return!1}},EmailComposeUtil.setUPSchedulePopup=function(){var e=$("#schedulerPopup"),i=(renderingUtils.windowOuterHeight-e.outerWidth())/2,t=(renderingUtils.windowOuterHeight-e.outerHeight())/2;$("#newFreezeLayer").removeClass("hide").css({opacity:"0.15"}),e.css({top:t,left:i}).show()},EmailComposeUtil.closeAllAlertPop=function(){EmailSendingUtil.closeTabALertPopup();var e=$L("#ecwSignaturePop")[0];e&&e.ltProp("show",!1);var i=$L("#ecwCloseAllPop")[0];i&&i.ltProp("show",!1);var t=$L("#ecwSubjectModal")[0];t&&t.ltProp("show",!1);var a=$L("#ecwDraftPop")[0];a&&a.ltProp("show",!1)},EmailComposeUtil.hideAllComposeRelatedPopup=function(){if(crmui.hideMsgBand(),EmailCompose.hideSchedulePop(),template){var e=$("#templateAnalyticsDIV");e&&(crmui.modalZIndex("nonLyte",e&&e.length>0?e[0]:$L("#etComposePanel")[0],"close"),e.hide())}"undefined"!=typeof ZSurvey&&ZSurvey&&ZSurvey.cancelPopup("lookupdiv");var i=$L("#zforms_popup")[0];i&&i.ltProp("show",!1);var t=$("#customConfirmationPop"),a=document.defaultView.getComputedStyle(t[0],null).getPropertyValue("visibility");t.length>0&&t.is(":visible")&&"hidden"!==a&&hideAnimatePopup("customConfirmationPop"),document.getElementById("linkdocsdialogdiv")&&ZDDialog.closePopUp("linkdocsdialogdiv"),document.getElementById("attachfiledialogdiv")&&ZDDialog.closePopUp("attachfiledialogdiv");var l=document.getElementById("attachdialogdiv"),o=document.getElementById("zohodocsframe");l&&(l.style.display="none"),o&&(o.style.display="none")},EmailComposeUtil.setSubject=function(e){var i=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB);i.val(e),EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName(i)},EmailComposeUtil.setFromAddress=function(e,i){return EmailSendingUtil.OrgEmailArray&&EmailSendingUtil.OrgEmailArray.contains(e)&&EmailSendingUtil.other_emails_array&&!EmailSendingUtil.other_emails_array.contains(e)||i?EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0:EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1,$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB+" option[value='"+$.escapeSelector(e)+"']").length>0&&($("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(e).select2().trigger("change"),!0)},EmailComposeUtil.setReplyToAddress=function(e){e&&($("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB+" option[value='"+$.escapeSelector(e)+"']").length>0&&($("#ceReplyToLink_"+EmailComposeUtil.CURRENT_TAB).trigger("click"),$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).val(e).select2().trigger("change")))},EmailComposeUtil.zeCreate=function(e,i,t,a,l){var o,n=CrmEmailInitialize.ComposeMailData.user.compose_settings;if(EmailComposeUtil.composeSettingObj)o=EmailComposeUtil.composeSettingObj;else{var s=I18n.getMsg("crm.title.show.documents");moduleRecordMapping.Documents&&(s=moduleRecordMapping.Documents.singular_label);var m=Crm.userDetails.isSandbox?I18n.getMsg("crm.title.show.documents"):s,r="Accounts"===EmailComposeUtil.tabIdVsModuleName[EmailComposeUtil.CURRENT_TAB]?I18n.getMsg("crm.email.entattach.label.entattach.Accounts"):I18n.getMsg("crm.email.entattach.label.entattach"),d=CrmEmailInitialize.ComposeMailData.features_available.EMAIL_ATTACHMENT_MAXLIMIT?"52428800":"10485760";if(o={editorContainer:EmailComposeUtil.contentIdPrefix+e,parentElement:"emailEditor",toolbarPosition:"top",id:"editorContent_"+e,css:["inline_editor_min.css"],fontSize:{8:"1",10:"2",12:"3",14:"4",18:"5",24:"6",36:"7"}[n.font_size],fontFamily:{Arial:"Arial,Helvetica,sans-serif",Calibri:"Calibri,Candara,Segoe,Segoe UI,Optima,Arial,sans-serif","Comic Sans MS":"Comic Sans MS,cursive,sans-serif","Courier New":"Courier New,Courier,monospace",Georgia:"Georgia,Times New Roman,Times,serif","Lucida Console":"Lucida Console,Monaco,monospace","Lucida Sans Unicode":"Lucida Sans Unicode,Lucida Grande,sans-serif","MS Serif":"MS Serif,New York,serif",Tahoma:"Tahoma,Geneva,sans-serif","Times New Roman":"Times New Roman,Times,serif","Trebuchet MS":"Trebuchet MS,Arial,Helvetica,sans-serif",Verdana:"Verdana,Geneva,sans-serif"}[n.font_family],js:["InitializeDictionary.js"],composerHeight:"240px",domElements:[{element:"emcc_bestTime",appendAfter:"composeEditor"}],afterEditorLoad:function(i){i&&(EmailComposeUtil.tabDetails[e].zEditor=i,EmailComposeUtil.tabDetails[e].spellCheck={}),EmailCompose.postEditorLoad(l)},resourcesLoaded:t,tableResize:!0,parentFeature:"CrmEmail",uploadImage:"/crm/v2/emails/attachments/upload",uploadAttachemnt:"/crm/v2/files",uploadThirdPartyAttachment:"/crm/v2/_internal/emails/attachments/add_attachment",attachmentSizeLimit:d,tabId:e,activeTabId:EmailComposeUtil.tabIdPrefix+e,activeTabContentId:EmailComposeUtil.contentIdPrefix+e,toolbarOptions:[{attachment:{label:I18n.getMsg("crm.label.addons.gdocs"),cmd:"g_docs",callback:function(){EmailAttachmentsUtil.openForDocs("gdoc",RebrandLinkUtil.getProperty("GadGetsURL"),RebrandLinkUtil.getProperty("CRMURL")),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:I18n.getMsg("Zoho")+" "+I18n.getMsg("crm.gapp.attach.docs.br"),cmd:"z_docs",callback:function(){EmailAttachmentsUtil.openForDocs("zdoc",RebrandLinkUtil.getProperty("docsURL")),EmailUtil.showCustomFreezeLayer(),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:m,cmd:"show_docs",callback:function(){EmailAttachmentsUtil.openZDocsLinkDialog(a),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:I18n.getMsg("crm.label.teamdrive"),cmd:"team_drive",callback:function(){EmailAttachmentsUtil.openForDocs("teamdrive",RebrandLinkUtil.getProperty("teamdriveURL")),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:r,cmd:"rel_list_attach",callback:function(){EmailAttachmentsUtil.showRelatedListAttachment()}}},{attachment:{label:I18n.getMsg("crm.attach.cloud.picker"),cmd:"crm.attach.cloud.picker",callback:function(){var e={feature:"attachments",cloud_services:"gdrive,box,skydrive",callback:EmailSendingUtil.addAttachmentsFromCloudPicker,max_file_selection:5};CrmEmailInitialize.ComposeMailData.features_available.EMAIL_CLOUD_PICKER&&(e.cloud_services="gdrive,box,skydrive,dropbox,evernote"),Lyte.injectResources(networkUtils.returnDependencyFiles(["crm-cloud-picker-mixin.js"],ResourceConstants.CRMClient),void 0,(function(){Lyte.registeredMixins["crm-cloud-picker-mixin"].loadCloudPicker(e)})),EmailComposeUtil.handleAttachmentPopupInEditor()}}}]},"China"===RebrandLinkUtil.getProperties().DeploymentLocation){Lyte.deepCopyObject(o);o.toolbarOptions.shift(),o.toolbarOptions.pop()}}if(EmailComposeUtil.editorLoaded=!1,EmailComposeUtil.isPrivacyEnabled()){var c={links:{label:"Consent Form",cmd:"consentform",callback:function(){CustomizeEditor.openAddLinkPop("consentFormLink")}}},p={links:{label:"Data Request",cmd:"datarequest",callback:function(){CustomizeEditor.openAddLinkPop("dataRequestLink")}}};o.toolbarOptions.push(c),o.toolbarOptions.push(p)}var E={links:{label:I18n.getMsg("crm.unsubscription.link"),cmd:"unSubscriptionLink",id:"unsubscribeLinkLi",callback:function(){CustomizeEditor.openAddLinkPop("unsubscribeLink")}}};if(o.toolbarOptions.push(E),EmailLaunchUtil.isInitialResourceLoaded||EmailComposeUtil.composeSettingObj)if("undefined"!=typeof ZBluePencil&&ZBluePencil){var u=networkUtils.returnDependencyFiles(["inlineEmailCompose_min.js","zohocrm_mailClient.js"],ResourceConstants.CRM).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.js"],ResourceConstants.CRMClient)).concat(networkUtils.returnDependencyFiles(["lyte-draggable.js"],ResourceConstants.CRMClient));u=u.concat(networkUtils.returnDependencyFiles(["email-emotions.js","zia-notification-settings.js"],ResourceConstants.CRMClient));var C=networkUtils.returnDependencyFiles(["inline_ComposeEditor_min.css"],ResourceConstants.CRM).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.css"],ResourceConstants.CRMClient)),g=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor"),networkUtils.getI18nJSUrl("emailsRelatedList"),networkUtils.getI18nJSUrl("threadsummaryandtranslation")],U=Lyte.injectResources(networkUtils.returnDependencyFiles(g,ResourceConstants.CRM),void 0,void 0),h=u.concat(C).concat(U);EmailLaunchUtil.resources_1=h,Lyte.injectResources(h,void 0,(function(){"undefined"!=typeof ZBluePencil&&ZBluePencil||Lyte.injectResources(o.dictionaryURL,void 0,(function(){})),editor.create(o)}))}else Lyte.injectResources(o.dictionaryURL,void 0,(function(){EmailComposeUtil.hasDictionarySourceAdded="undefined"!=typeof ZBluePencil,editor.create(o)}))},EmailComposeUtil.initialize=function(e,i,t){EmailComposeUtil.ComposeWindowLoaded?EmailComposeUtil.zeCreate(e,i,l,a,t):(EmailComposeUtil.appendInitialDOMElements(),EmailComposeUtil.zeCreate(e,i,EmailComposeUtil.resourcesLoaded,Crm.userDetails.ZGID,t),EmailComposeUtil.setInitialValues(),EmailSendingUtil.templatesFetched=!1,EmailSendingUtil.activeModule="");var a=EmailComposeUtil.ComposeMailData.user.zgid,l=EmailComposeUtil.resourcesLoaded;(i=i||"richtext",setTimeout((function(){EmailSendingUtil.timeInit(),EmailComposeUtil.doBindings()}),1e3),EmailComposeUtil.bindSurveyEvents(),EmailComposeUtil.bindOrgEmailEvent(),EmailSendingUtil.bindZohoFormsFunctions(),""===$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val())&&$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB).addClass("hide");$("#emailTempModule_"+EmailComposeUtil.CURRENT_TAB).val(""),EmailComposeUtil.ComposeWindowLoaded=!0,EmailSendingUtil.composeActive=!0},EmailComposeUtil.setInitialValues=function(){EmailComposeUtil.sessionStoredDraftDetails=null;var e=$("#jsonForMergefields_"+EmailComposeUtil.CURRENT_TAB),i={};i&&(i=EmailComposeUtil.ComposeMailData.mergeFieldsData,i=JSON.parse(i),e.data("mergeFieldsData",i))},EmailComposeUtil.bindSalesIqLink=function(){var e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),i=!!(e=e?e.toUpperCase():e)&&("LEADS"===e||"CONTACTS"===e),t=$("#ecw_insertSalesIqLink_"+EmailComposeUtil.CURRENT_TAB);t&&i&&(t.removeClass("hide"),t.show(),EmailSendingUtil.bindSalesIqLinkEvents())},EmailComposeUtil.bindSurveyEvents=function(){var e=CrmEmailInitialize.ComposeMailData.features_available.zsurvey_enabled,i=Crm.userDetails.IS_ADMIN,t=$("#composeEditor");if(e)EmailComposeUtil.bindInsertSurvey();else{var a,l=EmailComposeUtil.getContextHelpURL("help.zsurvey.index");if(l=String(l),t)a=i?'<div class="ppContSlide etInsertSurvey dIB pA" style="display:none;"><div class="pR"><div class="secOneSlide secSlide activeSlide"><div class="secSlideHd crm-base-font-size crmParagraphColor">'+I18n.getMsg("crm.survey.mailpopup.commessage1.new",[Crm.brandName,Crm.appName])+'</div><div class="secSlideDesc crm-small-font-size crmParagraphColor mT15">'+I18n.getMsg("crm.survey.mailpopup.adminmsg1")+'</div></div></div><div class="slideFooter pR cBafter"><a href="javascript:;" onclick="ZSurvey.redirectToSurvey()" >'+I18n.getMsg("crm.tpi.ctiapi.label.knowmore")+'</a><div class="fSlideBut fR"><input type="button" class="slideBut crm-small-font-size cP" value="'+I18n.getMsg("crm.label.yes")+'" onclick="ZSurvey.redirectToSurvey()" ><a href="javascript:;" class=" crmLabelColor crm-small-font-size mL10" onclick="EmailUtil.hidecallout()">'+I18n.getMsg("crm.zsurvey.label.doit.later")+"</a></div></div></div>":'<div class="ppContSlide etInsertSurvey dIB pA" style="display:none;"><div class="pR"><i class="setDDPopupAbGzs"><i class="setDDPopupAzs"></i></i><div class="pR" style="height:128px;overflow:hidden;"><div class="secOneSlide secSlide p30 pA activeSlide"><div class="secSlideHd crm-base-font-size crmParagraphColor">'+I18n.getMsg("crm.survey.mailpopup.commessage1.new",[Crm.brandName,Crm.brandName])+'</div><div class="secSlideDesc crm-small-font-size crmParagraphColor mT15">'+I18n.getMsg("crm.survey.mailpopup.othermsg1",Crm.brandName)+'</div></div></div></div><div class="slideFooter pR">'+I18n.getMsg("crm.label.formoredetails")+'&nbsp;<a href="javascript:openHelp('+l+');">'+I18n.getMsg("crm.webtoentity.generate.html")+'</a><div class="fSlideBut pA"><a href="javascript:;" class=" crmLabelColor crm-small-font-size mL10" onclick="EmailUtil.hidecallout()">'+I18n.getMsg("crm.button.close")+'</a><div class="cBoth"></div></div><div class="cBoth"></div></div></div>',t.append(a),EmailSendingUtil.bindSurveyEvents()}},EmailComposeUtil.bindInsertSurvey=function(){$(".surveyLink").click((function(){var e=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();$(this).attr("data-params",'{"action":"surveyDetails","from":"email","entityId":"'+e+'"}'),ZSurvey.showSurveyDetails(this)}))},EmailComposeUtil.doBindings=function(){EmailComposeUtil.toggleClickEventForEditor("bind"),$("#"+EmailComposeUtil.activeContentId+" .ceComposeSummary").on("click",EmailComposeUtil.displayComposeMetaFields),$("#wmsstatusbar").on("click",(function(e){var i=$L("#maxComposeBtn");"maxComposeBtn"===e.target.parentNode.id||e.target.contains(i[0])||EmailSendingUtil.composeActive&&$("#etComposePanel").hasClass("ecwMaximizedState")&&EmailCompose.etMinimiseCompose()})),$("#wVisTitBar").on("click",(function(e){var i=$L("#maxComposeBtn");"maxComposeBtn"===e.target.parentNode.id||e.target.contains(i[0])||EmailSendingUtil.composeActive&&EmailCompose.etMinimiseCompose()})),$("#secondaryEmailOption_"+EmailComposeUtil.CURRENT_TAB).hover((function(){var e=$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB),i=$(this),t=$L("#etComposePanel")[0].getBoundingClientRect().y,a=$L(this)[0].getBoundingClientRect().y-t+i.height()+10;e.show(),e.css("top",a)})),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hover((function(){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).show()}),(function(){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide()})),EmailComposeUtil&&"999"===EmailComposeUtil.CURRENT_TAB&&EmailComposeUtil.hideAllComposeRelatedPopup()},EmailComposeUtil.toggleClickEventForEditor=function(e){"bind"===e||"unbind"===e&&EmailComposeUtil.hideEditorPopups(),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide()},EmailComposeUtil.getEntityDetailsFromDB=function(e,i,t){var a=EmailComposeUtil.getApiNameForModule(e),l="/crm/v2/"+a+"/"+i;if((new crmRequestPool).initiate({url:l,type:"GET",data:"approved=both",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},content:"application/json; charset=UTF-8",dataType:"json",success:function(l){l||(EmailComposeUtil.isHavingRecordPermission=!1);var o=(l=l?l.data[0]:{}).Email?l.Email:"",n=l.Secondary_Email?l.Secondary_Email:"";EmailComposeUtil.currentEntityName[EmailComposeUtil.CURRENT_TAB]=l.Full_Name?l.Full_Name:"";try{o?EmailComposeUtil.setEmailAddressesInCompose(o,n,l,t,i,e):EmailComposeUtil.getEntityFieldDetailsAndPopEmailAddr(e,l,t,i)}catch(e){murphy.error(e)}if(Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].getPreviousMailDetailsFromDB(a,i);else{var s=networkUtils.returnDependencyFiles(["email-emotions.js","zia-notification-settings.js"],ResourceConstants.CRMClient);Lyte.injectResources(s,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].getPreviousMailDetailsFromDB(a,i)}))}}}),t&&"listview"!==t){var o=$("#mailListRelId"),n=o?o.val():"";$("#ecMailListRelId_"+EmailComposeUtil.CURRENT_TAB).val(n)}},EmailComposeUtil.setEmailAddressesInCompose=function(e,i,t,a,l,o){var n=t,s=e||i,m=n&&n.Name?n.Name:"",r=n.Full_Name?n.Full_Name:m;if(EmailComposeUtil.tabIdVsEntityName[EmailComposeUtil.CURRENT_TAB]=r,e&&i){var d=EmailComposeUtil.getFormattedEmailAddress(r,e),c=EmailComposeUtil.getFormattedEmailAddress(r,i);EmailCompose.addSecondaryMailDropDown(d,c)}if(""===r&&t.Vendor_Name&&""!==t.Vendor_Name&&(r=t.Vendor_Name),0===e.length&&0===i.length&&"Contacts"===o&&Crm.userDetails.CONTACT_ROLES_EMAILS_RL){var p="The chosen Contact "+r+" does not have any primary or secondary email address associated with it.";_cruxUtils.showCustomMessage({params:{ltPropType:"warning",ltPropMessage:p,ltPropDuration:"3000",ltPropShow:!0}})}"draft"!==a&&(EmailCompose.setMailAddress(s,r,"To"),EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB]&&void 0!==EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].tempDraftDetails&&(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].tempDraftDetails.toAddr=s)),$("#ecId_"+EmailComposeUtil.CURRENT_TAB).val(l),$("#ecEmailId_"+EmailComposeUtil.CURRENT_TAB).val(s),$("#ecFullname_"+EmailComposeUtil.CURRENT_TAB).val(r),EmailSendingUtil.toAddr=EmailComposeUtil.getFormattedEmailAddress(r,s)},EmailComposeUtil.getEntityFieldDetailsAndPopEmailAddr=function(e,i,t,a){var l=EmailComposeUtil.getApiNameForModule(e),o=new crmRequestPool,n="module="+l,s=new Map;o.initiate({url:"/crm/v4/settings/fields",type:"GET",data:n,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},content:"application/json; charset=UTF-8",dataType:"json",success:function(l){var o=l;o&&o.fields&&o.fields.forEach((e=>{"EMAIL"!==e.column_name&&"ADDN_EMAIL"!==e.column_name||(s.set(e.column_name,e.api_name),s.size)}));var n=i[s.get("EMAIL")],m=i[s.get("ADDN_EMAIL")];n=n||"",m=m||"",EmailComposeUtil.setEmailAddressesInCompose(n,m,i,t,a,e)},error:function(){return""}})},EmailComposeUtil.getUserDetails=function(e,i){if(e){var t="/crm/v2/users/"+e;(new crmRequestPool).initiate({url:t,type:"GET",data:"approved=both",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},content:"application/json; charset=UTF-8",dataType:"json",success:function(e){var t=e.users[0];i(t)},error:function(e){var i=e.status,t=(e=e.responseJSON,EmailUtil.getProperErrorMessage(e,i));crmui.showMsgBand("error",t,5e3)}})}},EmailComposeUtil.hideEditorPopups=function(){$("#ceVariousAttachmentOptionContainer ,.ceToolBarPopupActions").hide(),$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("close"),EmailCompose.hideSchedulePop(),$("#etSchedulePopId").addClass("hide"),EmailUtil.isReplyToAddressAdded()&&$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).select2("close")},EmailComposeUtil.parseContentToRemoveAutoSuggestionElem=function(e){return e=e.replace(/<span(.)*?class=(\\s)*?['"]{1}suggestedWord['"]{1}(.)*?<\/span>/gi,"")},EmailComposeUtil.showComposeMetaSummary=function(){if("999"!==EmailComposeUtil.CURRENT_TAB){var e=$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB),i=$("#ceCCAddr_"+EmailComposeUtil.CURRENT_TAB),t=$("#ceBCCAddr_"+EmailComposeUtil.CURRENT_TAB),a=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB),l=$("#ceOption_replyto_"+EmailComposeUtil.CURRENT_TAB),o=$("#ceReplyToLink_"+EmailComposeUtil.CURRENT_TAB),n=o.length,s=l.is(":visible"),m=$("#emailComposeContainer_"+EmailComposeUtil.CURRENT_TAB).height();EmailSendingUtil.summarizeUserNameandEmail(),""!==e.val()&&e.val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(e.val()),EmailSendingUtil.formattedUsernameFromEmail(e.val()),null,e.closest("li")),""!==i.val()&&i.val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(i.val()),EmailSendingUtil.formattedUsernameFromEmail(i.val()),null,i.closest("li")),""!==t.val()&&t.val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(t.val()),EmailSendingUtil.formattedUsernameFromEmail(t.val()),null,t.closest("li"));var r="";if(l.is(":visible")&&a.children("option").length>0){var d=a.select2("data"),c=d?d[0].text:"";c&&(r+=" <b>"+I18n.getMsg("crm.label.reply.to")+"</b> "+$ESAPI.encoder().encodeForHTML(c))}var p=EmailComposeUtil.getDisplayAddresses("ceToAddr"),E=$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" > li").length-2,u="";if(E&&E>0?u="<span class='dB ecRecipientTagContainer boxBB dIF aiCenter jcCenter crm-small-font-size mR6'><span class='etsColumnLabel crm-small-font-size mR7'>"+I18n.getMsg("crm.label.to.email")+"</span><span class='etsColDivider dIB mR7'></span> <lyte-text class='etsRecipientValues ellipsistext  crm-small-font-size mR7' lt-prop-value='"+p[0]+"'></lyte-text><span class='etsRecipientOverflowCount' > + "+E+"</span></span>":p.every((e=>""===e))||(u="<span class='dB ecRecipientTagContainer boxBB dIF aiCenter jcCenter crm-small-font-size mR6'><span class='etsColumnLabel crm-small-font-size mR7'>"+I18n.getMsg("crm.label.to.email")+"</span><span class='etsColDivider dIB mR7'></span> <lyte-text class='etsRecipientValues ellipsistext  crm-small-font-size mR7' lt-prop-value='"+p[0]+"'></lyte-text></span>"),0===$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").length&&(u="<span class='etsColumnLabel crm-base-font-size mR5'>"+I18n.getMsg("crm.label.to.email")+"</span> <span style='color:#434D5F;'></span>"),$("#ceCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").length>1){var C=EmailComposeUtil.getDisplayAddresses("ceCCAddr"),g=$("#ceCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" > li").length-2;u+=g&&g>0?"<span class='dB ecRecipientTagContainer boxBB dIF aiCenter jcCenter crm-small-font-size mR6'><span class='etsColumnLabel crm-small-font-size mR7'>"+I18n.getMsg("crm.label.cc.email")+"</span><span class='etsColDivider dIB mR7'></span> <lyte-text class='etsRecipientValues ellipsistext  crm-small-font-size mR7' lt-prop-value='"+C[0]+"'></lyte-text><span class='etsRecipientOverflowCount' > + "+g+"</span></span>":"<span class='dB ecRecipientTagContainer boxBB dIF aiCenter jcCenter crm-small-font-size mR6'><span class='etsColumnLabel crm-small-font-size mR7'>"+I18n.getMsg("crm.label.cc.email")+"</span><span class='etsColDivider dIB mR7'></span> <lyte-text class='etsRecipientValues ellipsistext  crm-small-font-size mR7' lt-prop-value='"+C[0]+"'></lyte-text></span>"}if($("#ceBCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").length>1){var U=EmailComposeUtil.getDisplayAddresses("ceBCCAddr"),h=$("#ceBCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" > li").length-2;u+=h&&h>0?"<span class='dB ecRecipientTagContainer boxBB dIF aiCenter jcCenter crm-small-font-size mR6'><span class='etsColumnLabel crm-small-font-size mR7'>"+I18n.getMsg("crm.label.bcc.email")+"</span><span class='etsColDivider dIB mR7'></span> <lyte-text class='etsRecipientValues ellipsistext  crm-small-font-size mR7' lt-prop-value='"+U[0]+"'></lyte-text><span class='etsRecipientOverflowCount ' > + "+h+"</span></span>":"<span class='dB ecRecipientTagContainer boxBB dIF aiCenter jcCenter crm-small-font-size mR6'><span class='etsColumnLabel crm-small-font-size mR7'>"+I18n.getMsg("crm.label.bcc.email")+"</span><span class='etsColDivider dIB mR7'></span><lyte-text class='etsRecipientValues ellipsistext  crm-small-font-size mR7' lt-prop-value='"+U[0]+"'></lyte-text></span>"}u=u.replace(/,/g,", ");var v=$("#"+EmailComposeUtil.activeContentId+" .ceSenderInfo"),f=$("#"+EmailComposeUtil.activeContentId+" .ceReceiverInfo");""!==r&&(v.find(".pR").html(r),v.show());var T=f.find(".pR");T.html(u),T.addClass("dIF aiCenter"),n>0&&!s||o.addClass("hide"),u&&($("#"+EmailComposeUtil.activeContentId+" .ceComposeMeta").addClass("hide"),f.show()),m<=0&&(m=EmailTabHomeUtil.ViewPortHeight-60),$("#ecAutoCompleteContainer").addClass("hide"),$L(".etAttachmentCountContainer").removeClass("active"),EmailComposeUtil.toggleClickEventForEditor("unbind"),EmailSendingUtil.resizeEditorHeight()}},EmailComposeUtil.displayComposeMetaFields=function(){$("#"+EmailComposeUtil.activeContentId+" .ceComposeSummary").hide(),$("#"+EmailComposeUtil.activeContentId+" .ceComposeMeta").removeClass("hide"),$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).focus(),EmailSendingUtil.resizeEditorHeight(),EmailComposeUtil.toggleClickEventForEditor("bind")},EmailComposeUtil.bindOrgEmailEvent=function(){EmailComposeUtil.bindEventForOrgEmails();var e=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB);thirdPartyUtils.bindSelect2(e),Lyte.registeredMixins["crm-email-auth-util"].getDomainsAuthNPolicy(e,e.val(),"email_compose"),e.on("select2:open",(function(e){e.preventDefault(),$("#"+EmailComposeUtil.activeContentId+" .select2-container").addClass("emailComposeSelect"),$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),EmailUtil.hideSchedulePopUp()})),e.on("select2:select",(function(e){var i=e.params.data.element.value;EmailUtil.setSignature(i);var t=e.params.data.element.getAttribute("isorgemail");EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1;var a="";if(t){EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0;var l=i.lastIndexOf("<"),o=i.lastIndexOf(">");a=-1!==l&&-1!==o&&o>l?i.slice(i.lastIndexOf("@")+1,o):i.slice(i.lastIndexOf("@")+1,i.length),!CrmEmailInitialize.ComposeMailData.relay_domains||CrmEmailInitialize.ComposeMailData.relay_domains.map((e=>e.toLowerCase())).contains(a.toLowerCase())||EmailUtil.hideBand||(EmailUtil.hideBand=!1,crmui.showMsgBand("warning",I18n.getMsg("crm.email.orgemail.message",i),5e3))}Lyte.registeredMixins["crm-email-auth-util"].getDomainsAuthNPolicy($("#etSenderList_"+EmailComposeUtil.CURRENT_TAB),i,"email_compose")}))},EmailComposeUtil.bindEventForOrgEmails=function(){var e=document.getElementById("etSenderList_"+EmailComposeUtil.CURRENT_TAB),i={},t=0,a=document.createElement("optgroup");a.setAttribute("Label",I18n.getMsg("crm.email.label.OrganisationEmail"));var l=e.childElementCount,o=e.children;EmailSendingUtil.other_emails_array=[];for(var n=l-1;n>=0;n--){(s=o[n]).getAttribute("isorgemail")||(EmailSendingUtil.other_emails_array.push(s.getAttribute("value")),i[s.getAttribute("value")]=s)}for(n=l-1;n>=0;n--){var s;(s=o[n]).getAttribute("isorgemail")?(a.appendChild(s),EmailSendingUtil.OrgEmailArray.push(s.getAttribute("value"))):t+=1}a.childElementCount>0&&e.appendChild(a),1===t&&EmailComposeUtil.disableReplyToAddressField()},EmailComposeUtil.initiateDraft=function(){setTimeout((function(){EmailActionHandling.saveDraftPeriodically($("#draftId").val(),!0)}),6e4),EmailComposeUtil.draftInterval=setInterval(EmailActionHandling.saveDraftPeriodically,18e4)},EmailComposeUtil.setEntityDetails=function(e,i){if(void 0===e&&(e=$("#module").val()),$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(e),EmailComposeUtil.isCustomModule(e)&&EmailComposeUtil.setCustomModuleName(e),void 0===i&&(i=$("#entityID").val()),i){EmailSendingUtil.isEntityWindow=!0,$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(i);var t=EmailComposeUtil.entityIdVsTabIds[i];t&&t.length>0?t.push(EmailComposeUtil.CURRENT_TAB):EmailComposeUtil.entityIdVsTabIds[i]=[EmailComposeUtil.CURRENT_TAB];var a=document.getElementById("fileCheckVariable");if(a){var l=a.value;if(a.getAttribute("tempVal")){var o=document.createElement("div");o.setAttribute("id","fileCheckVariable"),o.setAttribute("name","fileCheckVariable"),o.setAttribute("tempVal","EntityMail"),o.value="EntityMail",document.getElementById("emailEditor").append(o)}else a.setAttribute("tempVal",l),a.value="EntityMail"}}Crm.userDetails.isBestTimeEnabled=EmailComposeUtil.ComposeMailData.user.isBestTimeEnabled},EmailComposeUtil.setEntityDetailsEquivalentToInventoryModule=function(e,i){var t=i.inventory_template.id,a=EmailComposeUtil.INVENTORY_TEMPLATE_API_URL+"/"+t;(new crmRequestPool).initiate({url:a,type:"GET",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},success:function(i){if((i=i.inventory_templates)&&i.length>0){var t=(i=i[0]).module.api_name;EmailComposeUtil.setEntityDetails(t,e)}}})},EmailComposeUtil.closeOtherPopUps=function(){$("#ecAutoCompleteContainer").addClass("hide")},EmailComposeUtil.appendInitialDOMElements=function(){var e=$("body"),i=$("#composeEditor"),t=$("#ecAutoCompleteContainer");0===t.length&&(t='<div id="ecAutoCompleteContainer" class="hide"></div>',i.append(t));var a=$("#ecTemplateId");0===a.length&&(a='<input name="emailTemplateId" data-zcqa="emcTemplateId" id="ecTemplateId" type="hidden" value=""> ',i.append(a));var l=$("#etComposePanel"),o=$("#emailEntityComposepopup");if(0===o.length&&(o='<div id="emailEntityComposepopup"  class="emailEntityComposepopupClass" style="display:block">',e.append(o)),0===(n=document.getElementsByTagName("crm-emailrelatedlist-attachment")).length){var n="<crm-emailrelatedlist-attachment></crm-emailrelatedlist-attachment>";i.append(n)}if(0===$("#etSchedulePopId").length){i.append('<div class="w400 hide dIB etSchedulePop p30 pT20 boxBB bg_white pA" id="etSchedulePopId">'),EmailCompose.populateEmailScheduleDetails()}var s=document.getElementById("msgid");s&&(s='<input type="hidden" id="msgid" value>',i.append(s));e.append('<div data-zcqa="addLinkDiv_editor_ecw" id="addLinkDiv"></div>'),i.append('<div data-zcqa="timesData_editor_ecw" id="timesData" style="z-index:1000;"></div>'),i.append('<div data-zcqa="newFreezeLayer_editor_ecw" id="newFreezeLayer" class="hide" style=" "></div>'),crmui.closeOtherWMSBars(),crmui.modalZIndex("nonLyte",l[0],"open")},EmailComposeUtil.showComposeWindow=function(){var e;if(!EmailComposeUtil.isRefresh){var i=$("#etComposePanel");i.find(".etAttachmentIcn").parent().addClass("hide");var t=!1;CrmEmailInitialize&&CrmEmailInitialize.ComposeMailData&&CrmEmailInitialize.ComposeMailData.features_available&&(t=CrmEmailInitialize.ComposeMailData.features_available.ATTACHMENT);var a="<div class='mL8 etAttachmentPopupIcnContainer "+(t?"":" hide ")+" ecwNoDrag boxBB cP flexAlignCenter p7 ' tabindex=0  onkeydown='if(event.keyCode === 13) { this.click(); }' data-zcqa = 'ecw_attachmentPopupIcnContainer' lt-prop-title='"+I18n.getMsg("crm.email.entattach.label.attachfile")+"'><crmutil-icon icon-name='attachment' icon-class='zcicn-attachment  crmBaseIcon ' class='ecwAttachIcon'></crmutil-icon></div> <div class='etAttachmentCountContainer crm-small-font-size mL5 boxBB flexAlignCenter pL10 pR10 cP jcCenter' data-zcqa = 'ecw_etAttachmentCountContainer' id = 'etAttachmentCountContainer_"+EmailComposeUtil.CURRENT_TAB+"' ><div class='flexAlignCenter ecwAtchmntCountTxtWrapper hide'><span class='etAttachmentsCount vaM'></span><span class='mL2 etAttachmentsText vaM'>"+I18n.getMsg("Attachments")+"</span></div></div>",l=$L(".etFooterContent:visible");l.addClass("pR");var o=[{name:"navanee",fileFormat:".pdf",fileSize:"2345"}],n=networkUtils.returnDependencyFiles(["crm-emailcompose-attachment-popover.js","crm-email-summary-view.js","crm-email-activity-suggestions.js","crm-link-to-module.js","crm-email-picker-in-compose.js"],ResourceConstants.CRMClient).concat(networkUtils.returnDependencyFiles(["lyte-draggable.js"],ResourceConstants.CRMClient)),s=networkUtils.returnDependencyFiles(["crm-emailcompose-attachment-popover.css","crm-email-summary-view.css","crm-email-activity-suggestions.css","crm-link-to-module.css","zia/zia-common.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT),m=n.concat(s);if(m=m.concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("emailsForAllModules")],ResourceConstants.CRM)),featuresAvailable.WRITING_ASSISTANT&&(m=m.concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("WritingAssistant")],ResourceConstants.CRM))),Lyte.injectResources(m,void 0,(function(){Lyte.Component.render("crm-emailcompose-attachment-popover",o,"#composeContentPanel_"+EmailComposeUtil.CURRENT_TAB+" .etFooterContent");var e=$L("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),i=$("#module").val();void 0===i&&(i=e);var t=!1;(EmailCompose.isDraftOpen&&"Contacts"===i||"Contacts"===e&&"Contacts"===i)&&(t=!0);var a=void 0!==EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB]&&null!==EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB]&&"For_Accounts"===EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB].name,l=CrmEmailInitialize.ComposeMailData.features_available.isLinkToModuleEnabled;t&&!a&&l&&Lyte.Component.render("crm-link-to-module",[],"#linkToModule_"+EmailComposeUtil.CURRENT_TAB)})),null!==EmailComposeUtil.fromGetDraftLinkedModule){var r=EmailComposeUtil.fromGetDraftLinkedModule;EmailComposeUtil.fromGetDraftLinkedModule=null;var d={module:r.module.api_name,id:r.id,name:r.name};EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB]=d,EmailComposeUtil.linkToModuleSelected[EmailComposeUtil.CURRENT_TAB]=!0,EmailComposeUtil.linkToModuleDraftChanged[EmailComposeUtil.CURRENT_TAB]=!1}var c=l[0].firstElementChild;$L(c).addClass("flexAlignCenter"),$(c).prepend(a),$L("#etAttachmentCountContainer_"+EmailComposeUtil.CURRENT_TAB).on("click",(function(){EmailComposeUtil.showOrHidePopover(),$(this).removeClass("active")})),EmailComposeUtil.updatePopCount();var p=$L(".etComposeHeaderNew").length;e=p>1;var E,u=$L("#etComposePanel");if(sessionStorage&&void 0!==sessionStorage.compsoePosition&&(E=JSON.parse(sessionStorage.compsoePosition),EmailComposeUtil.setSessionComposePositionInComposePanel()),!E||"null"===E||!0===E.isDefaultView||EmailLaunchUtil.isDraftDtailsStoredInsession){if(EmailLaunchUtil.isDraftDtailsStoredInsession&&(EmailComposeUtil.resetSessionStorageComposePosition(),EmailCompose.popupPos={top:null,right:null,bottom:null,left:null,width:null,height:null,isDraggable:null}),EmailCompose.showFreezelayer(),EmailComposeUtil.setComposePositionInSessionStorage(!0),EmailLaunchUtil.isDraftDtailsStoredInsession||EmailComposeUtil.OPEN_TAB_COUNT>1){if(Lyte.registeredMixins["crm-email-compose"])Lyte.registeredMixins["crm-email-compose-mixin"].etToggleMinimiseRestore(!0);else{var C=networkUtils.returnDependencyFiles(["crm-email-compose.js"],ResourceConstants.CRMClient);Lyte.injectResources(C,void 0,(function(){Lyte.registeredMixins["crm-email-compose-mixin"].etToggleMinimiseRestore(!0)}))}EmailLaunchUtil.isDraftDtailsStoredInsession=!1}return u.removeClass("etMinimize"),void crmui.modalZIndex("nonLyte",u[0],"open")}if(Lyte.registeredMixins["crm-email-compose"])Lyte.registeredMixins["crm-email-compose-mixin"].etToggleMinimiseRestore(e,!0);else{C=networkUtils.returnDependencyFiles(["crm-email-compose.js"],ResourceConstants.CRMClient);Lyte.injectResources(C,void 0,(function(){Lyte.registeredMixins["crm-email-compose-mixin"].etToggleMinimiseRestore(e,!0)}))}u.removeClass("etMinimize"),e&&i.addClass("emailComposeNoTrans")}},EmailComposeUtil.populateAddnEmail=function(e,i){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide();var t="",a="",l="",o=networkUtils.getImageUrl("nophoto.png",ResourceConstants.CRM),n="selectedEmail",s="selectedEmail";if(i.indexOf("###")>-1){t=i.substr(i.indexOf("###")+3),i=i.substr(0,i.indexOf("###"));var m=EmailSendingUtil.getFormattedEmailAndUserName(i),r=EmailSendingUtil.getFormattedEmailAndUserName(t);i=m[0],a=m[1],t=r[0],l=r[1]}if(validationUtils.isValidEmail(i)||(s="invalidEmail"),validationUtils.isValidEmail(t)||(n="invalidEmail"),i=$ESAPI.encoder().encodeForHTMLAttribute(i),a=$ESAPI.encoder().encodeForHTMLAttribute(a),t=$ESAPI.encoder().encodeForHTMLAttribute(t),l=$ESAPI.encoder().encodeForHTMLAttribute(l),"EA"===e){var d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d=(d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>")+"<li class='fL "+n+"' username='"+l+"' email='"+t+"' >",d=(d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>")+"</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_"+$ESAPI.encoder().encodeForHTMLAttribute(i)+"' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else if("AO"===e){d="<li class='fL "+n+"' username='"+l+"' email='"+t+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else{d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide ecwNoDrag'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).html(""),d+="<li class='fL ecAddrEditor' id='liToAddresDetails' style='background:var(--bg_white);'><input data-zcqa='emc_ceToAddr' initialliselection='true' autocomplete='off' class='fL ecTxtboxes mT2' type='text' onkeydown='EmailSendingUtil.handleKeyDownEventsForAutoComplete(this,event);sE(event);' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete(this,event);sE(event);' onpaste='EmailSendingUtil.handlePasteEventForAutoComplete(this);sE(event);' onfocus='EmailSendingUtil.isCrtlKeyPressed = false;sE(event);' placeholder='' id='ceToAddr' onclick='sE(event)' value='' style='width: 54px;'></li>",$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).html(d),$(".liToAddresDetails").html("")},EmailComposeUtil.putAttachmentsOnEditor=function(e){if(EmailSendingUtil.SwitchedFromOldToNew&&EmailComposeUtil.isInventoryModule($("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val())&&EmailSendingUtil.inventObj){$("#layout_Id").val(EmailSendingUtil.inventObj.layout_Id),$("#layout_Name").val(EmailSendingUtil.inventObj.layout_Name),$("#viewType").val(EmailSendingUtil.inventObj.viewType),$("#paperType").val(EmailSendingUtil.inventObj.paperType);var i={},t={};t.id=EmailSendingUtil.inventObj.layout_Id,t.name=EmailSendingUtil.inventObj.layout_Name,i.inventory_template=t,i.paper_type=EmailSendingUtil.inventObj.paperType,i.view_type=EmailSendingUtil.inventObj.viewType,EmailUtil.setInventoryDetails(i)}$.each(e,(function(e,i){var t=editor.zEditor;if(t){EmailSendingUtil.SwitchedFromOldToNew&&(i.service_name="Desktop",EmailActionHandling.saveDraftDetails(i),i.id&&i.id.length>70&&(i.service_name="ZFSAttached")),t.showLoadingAttachment(i),t.showAttachment(i,i),EmailComposeUtil.updatePopCount();var a=i[EmailComposeUtil.FILE_SIZE];a&&t.addToTotalAttachmentSize(a)}})),setTimeout((function(){EmailSendingUtil.SwitchedFromOldToNew=!1}),5e3)},EmailComposeUtil.getFormattedEmailAddress=function(e,i){return e?e+"<"+i+">":i},EmailComposeUtil.showCustomFreezeLayer=function(e){var i=$("#etComposePanel");if(window.event&&window.event.currentTarget&&(window.event.currentTarget.id&&"zi_insertImage_li"===window.event.currentTarget.id||window.event.currentTarget.parent&&"emailComposeUploadOptionsMenu"===window.event.currentTarget.parent.getAttribute("lt-prop-wrapper-class")||i.length)||e){var t=editor.zEditor;t&&t.freezeLayer("show")}else{var a=$("#z_freezeLayer");a.length>0?a.show():(a='<div id="z_freezeLayer" class="z_freezeLayer" style="display: block;z-index: 1;"></div>',i.append(a))}},EmailComposeUtil.removeCustomFreezeLayer=function(){var e=$(".z_freezeLayer");e&&e.remove()},EmailComposeUtil.closeViewMailPopUp=function(){void 0!==$("#emailDetailIframeContent")&&EmailComposeUtil.closeIconBtn()},EmailComposeUtil.closeIconBtn=function(){var e;"undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof CrmPlusLib&&CrmPlusLib.isLoadedInCrmplusFrame?(e=$("#lookupdiv"),$("#chatbotDiv #kso_mails_list .kso_eachMailContainer").length?renderingUtils.freezeBackground():renderingUtils.removeFreezeLayer(),$("#ddm").hide(),$("#kanbanTaskDetailctn").removeClass("hide")):(e=parent.$("#lookupdiv"),$("#chatbotDiv #kso_mails_list .kso_eachMailContainer").length?renderingUtils.freezeBackground():parent.renderingUtils.removeFreezeLayer(),parent.$("#ddm").hide(),parent.$("#kanbanTaskDetailctn").removeClass("hide")),e.removeClass("p20");var i=$("#navigationRefreshKey");if(i.length>0&&"true"===i.html()){var t=$("module").val(),a="";a="Potentials"===t?$("#id").val():$("#entityId").val(),i.html("false"),window.parent.showMailsList(a,$("#emailId").val(),$("#fullname").val(),$("#mailListRelId").val(),"-10","next","","false",t)}e.html("").height("").hide()},EmailComposeUtil.getAPIDraftURL=function(e,i,t){var a=EmailComposeUtil.DraftAPIURL;return i||(i=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),i&&i.startsWith("CustomModule")&&(i=Crm.userDetails.MODULE_LIST[i].api_name),i=EmailComposeUtil.getApiNameForModule(i),t||(t=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val()),a+="/"+i+"/"+t+"/"+EmailComposeUtil.DraftsAction,e&&(a+="/"+e),a},EmailComposeUtil.setSessionStorageDraft=function(e,i){var t;t=i||EmailComposeUtil.CURRENT_TAB;var a=sessionStorage.getItem("draftDetails");a=a&&"null"!==a?JSON.parse(a):{};e=$("#draftId_"+t).val();var l=$("#moduleName_"+t).val(),o=$("#ecEntityId_"+t).val(),n=$("#ceSubject_"+t).val();if(e&&"undefined"!==e){e+="";var s=Object.keys(a);if(e&&!s.contains(e)){var m=e+":"+l+":"+o+":"+n;a[e]=m,a=JSON.stringify(a),sessionStorage.setItem("draftDetails",a)}}},EmailComposeUtil.resetSessionStorageDraft=function(){sessionStorage.setItem("draftDetails",null)},EmailComposeUtil.removeDraftIdFromSessionStorage=function(e){var i=sessionStorage.getItem("draftDetails");i&&"null"!==i&&((i=JSON.parse(i))&&e&&delete i[e+=""],i&&0!==Object.keys(i).length?(i=JSON.stringify(i),sessionStorage.setItem("draftDetails",i)):EmailComposeUtil.resetSessionStorageDraft())},EmailComposeUtil.populateEmailAddress=function(e,i){var t,a=i,l=e[a];if(l){switch("string"==typeof e[a]&&(l=JSON.parse(e[a])),a){case"to":t="To";case"to_address":t="To";break;case"cc":t="CC";case"cc_address":t="CC";break;case"bcc":t="BCC";case"bcc_address":t="BCC";break;default:t=null}for(var o,n,s=l.length,m=0;m<s;m++)if(o=l[m].user_name,n=l[m].email){var r=n.lastIndexOf("<"),d=n.lastIndexOf(">");-1!==r&&-1!==d&&d>r&&(o||(o=n.slice(0,r).trim()),n=n.slice(r+1,d)),EmailCompose.setMailAddress(n,o,t)}}},EmailComposeUtil.hideMaximizeComposeButton=function(){$("#maxComposeBtn").addClass("hide"),"undefined"!=typeof CrmPlusImpl&&("undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof isZohoOneUser&&"true"===isZohoOneUser)&&CrmPlusImpl.handleDraftMailIcon(!1)},EmailComposeUtil.restoreComposePopup=function(){crmui.fromCloseOther||crmui.closeOtherWMSBars("email");var e=$L("#templatePreviewDIV"),i=$L(".z_freezeLayer");if(e&&e.length>0&&i||EmailComposeUtil.removeCustomFreezeLayer(),$(".ze_toolbarbg").parent().remove(),EmailSendingUtil.isSendMailActionCalled=!1,$("#addNewSign")[0]){$("#z_imagePopup").css("display","none");var t=$("#z_freezeLayer");t[0]&&t.remove(),EmailComposeUtil.TEMP_TAB?(EmailComposeUtil.CURRENT_TAB=EmailComposeUtil.TEMP_TAB,EmailComposeUtil.activeContentId="composeContentPanel_"+EmailComposeUtil.CURRENT_TAB):EmailComposeUtil.CURRENT_TAB="1",null!==EmailComposeUtil.sessionStoredDraftDetails&&"null"!==EmailComposeUtil.sessionStoredDraftDetails||!EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB]?EmailComposeUtil.CURRENT_TAB="1":EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB),$("#etComposePanel").attr("id","emailComposeEditor"),$("#composeEditor").attr("id","composeEmailEditor")}if("999"===EmailComposeUtil.CURRENT_TAB&&(EmailComposeUtil.CURRENT_TAB=EmailComposeUtil.TEMP_TAB),null!==EmailComposeUtil.sessionStoredDraftDetails&&"null"!==EmailComposeUtil.sessionStoredDraftDetails){var a=EmailComposeUtil.sessionStoredDraftDetails;EmailComposeUtil.sessionStoredDraftDetails=null;var l=Object.keys(a),o=l.length;EmailCompose.isSessionRestore=!0,setTimeout((function(){EmailCompose.isSessionRestore=!1}),1e3*o+1e3),EmailLaunchUtil.isDraftDtailsStoredInsession=!1;for(var n=0;n<o;n++){var s=l[n],m=a[s].split(":");s=m[0];var r=m[1],d=m[2],c=m[3];n===o-1?(EmailCompose.isRefreshFirstOpen=!0,EmailCompose.fetchDraftDetails(s,r,d)):EmailComposeUtil.createComposeTab(s,r,d,c)}}else{var p=$("#gOnboardSection"),E=(p[0]&&p.css("display"),EmailComposeUtil.isPopUpVisible(),$(".sticky-notes-label"));E.length>0&&"viewed"===E.attr("data-active")&&crmStickies.viewStickyNewNote(E),EmailComposeUtil.isPopUpVisible(),"visible"===$("#chatbotDiv").css("visibility")&&"undefined"!=typeof zia&&zia&&zia.minimizeChat(),$("#remainder-notifi").is(":visible")&&Activities.showHideRemainder(),$("#rItemDataDiv").is(":visible")&&hideMenu(event),"none"!==$("#showSignalPop").css("display")&&!1,EmailCompose.etMaximizeCompose()}},EmailComposeUtil.isPopUpVisible=function(){var e=$L("crm-emailconversation-view"),i=!!e.length&&!e[0].component.getData("showModal");return $("lyte-modal-freeze").css("opacity")>0&&i||$("#FreezeLayer, #freezeBackGround").is(":visible")},EmailComposeUtil.setScheduleTime=function(e,i){var t,a,l=Crm.userDetails.tzOffset;if("editInCompose"===EmailSendingUtil.action){var o=parseFloat(Crm.userDetails.TIME_ZONE).toFixed(2),n=o.split(".");o="30"===n[1]?n[0]+".50":n[0]+".00",Crm.userDetails.tzOffset=60*o*60*1e3}if(e.time){var s=e.time;t=s.indexOf("T")>-1?EmailDateTimeUtils.ISO8601toDateObject(s):new Date(s),a=s.timezone}else t=e.indexOf("T")>-1?EmailDateTimeUtils.ISO8601toDateObject(e):new Date(e);var m="ecSchduleTime";i||(m=e.source?e.source:m);var r=new Date;if(Utils.convertToUserTimezone(r),!(t-r<=0)){var d,c=EmailDateTimeUtils.getDateInUserFormatFromDateObject(t),p=Crm.userDetails.TIME_FORMAT,E=t.getHours();"hh:mm a"===p&&(d=(E=parseInt(E))>=12?"pm":"am",E=E>12?E-12:E);var u,C=(E=("0"+E).slice(-2))+":"+("0"+t.getMinutes()).slice(-2);u=d?c+"##"+C+"##"+d:c+"##"+C+"##Hrs",a||(a=Crm.userDetails.USER_TIME_ZONE),u=u+"##"+a,$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(u);var g,U=d?d.toUpperCase():I18n.getMsg("crm.workflow.scheduler.hours");g=i?EmailComposeUtil.getProperScheduleTimeMsg(C+" "+U,EmailSendingUtil.formattedDate(c)):EmailSendingUtil.getProperMsg(C+" "+U,EmailSendingUtil.formattedDate(c)),EmailComposeUtil.setTime(g),EmailComposeUtil.setScheduleTimeSource(m),EmailComposeUtil.setIntialValuesForScheduleMail(),"editInCompose"===EmailSendingUtil.action&&(Crm.userDetails.tzOffset=l)}},EmailComposeUtil.setScheduleTimeSource=function(e){$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val(e);var i=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB).closest("li");EmailSendingUtil.selectCheckBox(i)},EmailComposeUtil.getProperScheduleTimeMsg=function(e,i,t){i=i.trim();var a="",l=(e=e.toUpperCase().trim()).split(" ");return e="AM"===l[1]||"PM"===l[1]?l[0]+" "+I18n.getMsg(l[1]):l[0]+" "+I18n.getMsg("crm.workflow.scheduler.hours"),t&&(e+=" "+t),i&&""!==i?"today"===i||"Today"===i?(i=I18n.getMsg("Today"),a=I18n.getMsg("crm.besttime.mail.scheduledat")+" "+e+", "+i):"tomorrow"===i||"Tomorrow"===i?(i=I18n.getMsg("Tomorrow"),a=I18n.getMsg("crm.besttime.mail.scheduledat")+" "+e+", "+i):a=I18n.getMsg("crm.besttime.mail.scheduledon")+" "+i+" "+I18n.getMsg("crm.homepage.at")+" "+e:a=I18n.getMsg("crm.besttime.mail.scheduledat")+" "+e+" "+i,a},EmailComposeUtil.getEditorContent=function(){var e="";if(Crm.userDetails.isNewEditor){if(!editor.zEditor)return;e="plainEditor"===editor.getEditorMode()?editor.zEditor.plainEditor.value:editor.getContent()}else e=editor.getContent();return e},EmailComposeUtil.getFormattedAttachmentDetails=function(e,i,t,a){var l={};return l[EmailComposeUtil.FILE_ID]=e,l[EmailComposeUtil.FILE_NAME]=i,l[EmailComposeUtil.FILE_SIZE]=t,l[EmailComposeUtil.SERVICE_NAME]=a,l},EmailComposeUtil.populateWithTemplate=function(e,i,t){$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val(e);var a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val();a&&a!==module&&$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).val("");var l=$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).children().eq(0).attr("email"),o=$("#addrsVal_"+EmailComposeUtil.CURRENT_TAB).attr("selectedval"),n=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),s=$("#editorMode_"+EmailComposeUtil.CURRENT_TAB).val(),m=EmailUtil.getTemplateData(e,a,o,l,n,s);m.subject=i,m.body=t,EmailSendingUtil.populateNewEditorWithTemplate(m,a)},EmailComposeUtil.isCustomModule=function(e){return!!e.startsWith("CustomModule")},EmailComposeUtil.getTextUptoCursorPos=function(){for(var e=editor.zEditor.editorDiv,i=editor.zEditor,t=i.getSelection(),a=i.getRange(t),l=a.startContainer,o=l,n="";l!==e;)o=l,l=l.parentNode;for(var s=e.childNodes,m=s.length,r=0;r<m;r++){var d=s[r],c="";if(c=3===d.nodeType?d.textContent:d.innerText,d===o){var p=EmailUtil.getNodeText(a);p&&(n+=(c=c.substring(0,c.lastIndexOf(p)))+p);break}n+=c}return n},EmailComposeUtil.isInventoryModule=function(e){return e||(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),"Invoices"===(e=EmailComposeUtil.getApiNameForModule(e))||"Sales_Orders"===e||"Purchase_Orders"===e||"Quotes"===e},EmailComposeUtil.getContextHelpURL=function(e){switch(Crm.userDetails.RELEVANT_LOCALE){case"fr_FR":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"fr/crm/help/"+crmConstants.helpUrl[e];case"es_ES":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"es-xl/crm/help/"+crmConstants.helpUrl[e];case"pt_BR":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"pt-br/crm/help/"+crmConstants.helpUrl[e];case"de_DE":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"de/crm/help/"+crmConstants.helpUrl[e];default:return"https://help.zoho.com/portal/kb/articles/zoho-survey-crm-integration"}},EmailComposeUtil.removeDraftDOMElement=function(){var e=$("#maxComposeBtn");if(e.length>0&&e.is(":visible")){if(EmailSendingUtil.composeActive||!EmailComposeUtil.editorLoaded)return EmailComposeUtil.hideMaximizeComposeButton(),void EmailComposeUtil.resetSessionStorageDraft();$("body #composeEditor").remove(),EmailComposeUtil.removeSpectrumElem(),EmailComposeUtil.editorLoaded=!1,EmailSendingUtil.composeActive=!1,EmailComposeUtil.editorContent="",EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData,editor&&editor.zEditor&&(editor.zEditor.body[0].removeEventListener("click",editor.zEditor.hideAllProps,!1),editor.zEditor={}),tableResize.init={},$(".editorToolDiv").remove(),Lyte.removeFromCache(EmailComposeUtil.resources_1),Lyte.removeFromCache(EmailComposeUtil.resources_2),EmailComposeUtil.ComposeWindowLoaded=!1,null!==EmailComposeUtil.draftInterval&&clearInterval(EmailComposeUtil.draftInterval),EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.resetSessionStorageDraft()}},EmailComposeUtil.removeSpectrumElem=function(){EmailComposeUtil.editorLoaded&&($("#lb_foreColor").spectrum("destroy"),$("#lb_bgColor").spectrum("destroy"),$("#sp_borderColor").spectrum("destroy"),$("#sp_fillColor").spectrum("destroy"))},EmailComposeUtil.setCustomModuleName=function(e){var i=$("#customModuleName_"+EmailComposeUtil.CURRENT_TAB);i&&i.val(e)},EmailComposeUtil.setEditorFocus=function(){editor&&editor.zEditor?(editor.zEditor.focusEditor(),editor.zEditor.editorDiv.click(),EmailComposeUtil.showOrHidePopover()):setTimeout((function(){editor&&editor.zEditor&&(editor.zEditor.focusEditor(),editor.zEditor.editorDiv.click(),EmailComposeUtil.showOrHidePopover())}),1e3)},EmailComposeUtil.setInitialComposeWindowFocus=function(){EmailSendingUtil.action===EmailTabHomeUtil.FORWARD||EmailSendingUtil.action===EmailTabHomeUtil.COMPOSE?$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).focus():(EmailComposeUtil.setEditorFocus(),editor.zEditor.editorDiv.click())},EmailComposeUtil.isValidWordKey=function(e){return e>47&&e<58||e>64&&e<91||e>95&&e<112||e>185&&e<193||e>218&&e<223||32===e},EmailComposeUtil.isInvalidKey=function(e){return e.altKey||e.ctrlKey||27===e||13===e||37===e||38===e||40===e||33===e||34===e},EmailComposeUtil.validateMailSendingPermission=function(e,i,t,a,l){var o=e,n=i;if("Accounts"===e)if(Crm.userDetails.isEmailsForModuleEnabled){var s=$L("#recordId");s.length>0&&(o="Contacts",n=s[0].cxProp("selected"))}else{var m=$L("#scheduledMails"),r=$L("#draftMails").hasClass("selectTab")?$L("#accountsDrafts"):m.hasClass("selectTab")?$L("#accountsScheduled"):$L("#contactSelDropdownInAcc");r.length>0&&(o="Contacts",n=r[0].ltProp("selected"))}n&&n.length>0&&"ALL"===n&&(n=i);var d=Crm.getCrmBasePath()+"/mailer/EntReply.do",c="action=openComposeWindow&entType="+o+"&entityId="+n;var p="";commonUtils.showHideLoadingDiv(!0),(new crmRequestPool).initiate({type:"POST",url:d,data:c,success:function(o){if(EmailCompose.replaceTabid||EmailCompose.isSessionRestore||commonUtils.showHideLoadingDiv(),("1101"===(p=o)||"8011"===p||"8013"===p||p.indexOf("UNCONFIRMED_USER")>-1||p.indexOf("TRANSMAIL_BLOCKED_ERROR")>-1||"1003"===p||"2309"===p&&"Potentials"!==e)&&EmailSendingUtil.isFromCscript)return EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.callback&&EmailSendingUtil.isFromCscript.callback(p),EmailSendingUtil.isFromCscript=null,!1;if("1101"===p&&l&&Crm.userDetails.LITE.IS_LITE_USER)return a(t,e,i),!1;var n=!1;if("1101"===p)_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.security.error")},close:function(){EmailCompose.hideGSearch()}});else if("8011"===p)_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.priv.email.consent")},close:function(){EmailCompose.hideGSearch()}});else if("8013"===p)_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.record.lock.mail",moduleRecordMapping[e].plural_label),ltPropContentAlign:"center"},close:function(){EmailCompose.hideGSearch()}});else if(p.indexOf("UNCONFIRMED_USER")>-1){var s=$("#shownotes");p=p.substring(16,p.length),s.addClass("newPopup p30"),s.html(p);var m=document.getElementById("shownotes");m.style.zIndex=21,m.style.width="600px",m.style.position="absolute",s.find("input").click((function(){var e=$("#shownotes");renderingUtils.removeFreezeLayer(),e.html(""),e.hide()})),renderingUtils.freezeBackground(),s.show(),mailsetCenter("shownotes")}else if(p.indexOf("TRANSMAIL_BLOCKED_ERROR")>-1&&"Potentials"!==e&&Crm.userDetails&&Crm.userDetails.isNewEditor&&"forward"!==EmailCompose.action){var r=$("#emailalert"),d=parseInt($(".emailalert").css("margin-top"))-$("#wmstoolbar").outerHeight()-12;p=p.substring(23,p.length);var c="<div class='aligncenter crm-font-bold crm-heading-font-size' text-align:auto;'>";c+=I18n.getMsg("crm.bouncemail.heading"),c+="</div>",r.hide(),p="<div class='massMailstatscloseIcon cP' style='top:20px;right:20px' onclick=closealertMail('emailalert')></div><div class='aligncenter crm-font-regular crm-base-font-size mT20'>"+p+"</div> </div></div>",r.empty(),document.getElementById("emailalert").innerHTML=c+p,r.css({"margin-top":d,"max-height":renderingUtils.windowHeight-110}),$("html,body").css("overflow","hidden"),mailsetCenter("emailalert"),renderingUtils.freezeBackground()}else if("1003"===p&&"Potentials"!==e)_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.label.emailoptout.alert.message"),ltPropContentAlign:"center"},close:function(){EmailCompose.hideGSearch()}});else{if("2309"!==p||"Potentials"===e)return n=!0,a(t,e,i),!0;renderingUtils.showCustomAlert(I18n.getMsg("crm.zmail.unableto.sendmail",Crm.moduleInfo[e].translatedSingularLabel),I18n.getMsg("crm.error.email.notfound"))}return n||i===$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB)&&EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB),!1},error:function(e){if(commonUtils.showHideLoadingDiv(),EmailSendingUtil.isFromCscript)return EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.callback&&EmailSendingUtil.isFromCscript.callback(e),void(EmailSendingUtil.isFromCscript=null);renderingUtils.showCustomAlert(I18n.getMsg("crm.migration.general.error"))}})},EmailComposeUtil.validateEmailFieldsOfToCcBcc=function(){return!($("#ToDetails .selectedEmail").length+$("#CCDetails .selectedEmail").length+$("#BCCDetails .selectedEmail").length>EmailSendingUtil.numberOfEmailAddr)||(crmui.showMsgBand("error",maxLimitExceedMsg,5e3),!1)},EmailComposeUtil.getAutoCompleteSuggestedElem=function(){var e;if(editor&&editor.zEditor){var i=editor.zEditor.z_doc;e=i?i.getElementsByClassName("suggestedWord")[0]:e}return e},EmailComposeUtil.getApiNameForModule=function(e){var i=Crm.userDetails.MODULE_LIST[e],t=e;return i&&(t=i.api_name),t},EmailComposeUtil.isPrivacyEnabled=function(){return EmailComposeUtil.ComposeMailData.features_available.isPrivacyEnabled},EmailComposeUtil.showSubjectInputPopup=function(){var e=$L("#ecwSubjectModal")[0];if(e.ltProp("show",!0),EmailSendingUtil.isNewEditor()&&EmailSendingUtil.composeActive){var i=e.ltProp("wrapperClass");e.ltProp("wrapperClass",i+" emailComposeZindex")}},EmailComposeUtil.handleAttachmentPopupInEditor=function(){if(void 0!==EmailComposeUtil)var e=setInterval((function(){EmailComposeUtil.AttachmentPopupTriggerEvent()&&(crmui.modalZIndex("nonLyte",$L(".docsdialog")[0],"open"),$L(".ui-widget-overlay").css("z-index",crmui.zIndex-1),clearInterval(e))}),300)},EmailComposeUtil.AttachmentPopupTriggerEvent=function(){var e=$("#attachfiledialogdiv"),i=$("#linkdocsdialogdiv"),t=$("#zohodocsframe"),a=!1;return i.length>0?(i.on("remove",EmailComposeUtil.AttachmentPopupRemovalEvent),EmailComposeUtil.showCustomFreezeLayer(!0),a=!0):e.length>0?(e.on("remove",EmailComposeUtil.AttachmentPopupRemovalEvent),EmailComposeUtil.showCustomFreezeLayer(!0),a=!0):t.length>0&&(t.on("remove",EmailComposeUtil.AttachmentPopupRemovalEvent),a=!0),a},EmailComposeUtil.AttachmentPopupRemovalEvent=function(){EmailSendingUtil.isNewEditor()&&EmailSendingUtil.composeActive&&(crmui.modalZIndex("nonLyte",$L("#linkdocsdialogdiv")[0],"close"),EmailComposeUtil.removeCustomFreezeLayer())},EmailComposeUtil.getNextFormattedScheduleTime=function(e,i){var t,a,l;if("hh:mm"===(i=i.toLowerCase()))t=e.split(":")[0],a=e.split(":")[1];else if("hh:mm a"===i){t=e.split(":")[0];var o=e.split(":")[1];a=o.split(" ")[0],l=o.split(" ")[1]}l&&(l=l.toUpperCase());var n=parseInt(t),s=parseInt(a);"00"!==a&&"30"!==a?s<29?a="30":s<=59&&(a="00",n<11?t=parseInt(t)+1:"11"===t&&"hh:mm a"===i?"AM"===l?(l="PM",t="12"):"PM"===l&&(l="AM",t="00"):"hh:mm a"===i&&"PM"===l?t="01":"hh:mm"===i&&(t="23"===t?"00":parseInt(t)+1)):"00"===a?a="30":"30"===a&&("hh:mm"===i&&n<23?(t=("0"+(n+=1)).slice(-2),a="00"):"hh:mm a"===i&&(a="00",11!==n?t=n+1:11===n&&("AM"===l?(t=n+1,l="PM"):a="30")));e=t+":"+a;return e=l?e+":"+l:e},EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName=function(){var e=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();$("#ceSubject1_"+EmailComposeUtil.CURRENT_TAB).val(e),e&&e.length>250&&crmui.showMsgBand("warning",I18n.getMsg("crm.email.compose.subject.len.check",250),3e3),""===e&&(e=I18n.getMsg("crm.email.label.newmessage")),$("#"+EmailComposeUtil.activeTabId+" .etTxt").text(e),$L("#"+EmailComposeUtil.activeTabId).attr("lt-prop-title",e),$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val()&&EmailComposeUtil.hideTemplateNameHolderInContentChanged()},EmailComposeUtil.disableReplyToAddressField=function(){var e=$("#ceOption_replyto_"+EmailComposeUtil.CURRENT_TAB),i=$("#ceReplyToLink_"+EmailComposeUtil.CURRENT_TAB);e.hide(),i.hide()},EmailComposeUtil.hideTemplateNameHolderInContentChanged=function(){try{var e=$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB),i=e.val();if(EmailSendingUtil.templateIdVsContent[i]!==editor.getContent()||$("#ceSubject1_"+EmailComposeUtil.CURRENT_TAB).val()!==EmailSendingUtil.templateIdVsDetail[i].subject){EmailSendingUtil.isLoadTemplate||$("#emcTemplateNameHolder_"+EmailComposeUtil.CURRENT_TAB).addClass("hide"),e.val("");var t=EmailUtil.getAttachmentDetails();t.length>0&&EmailActionHandling.saveDraftOnAttachmentAddition(t)}}catch(i){e.val("")}},EmailComposeUtil.insertLinkInComposeEditor=function(e,i,t,a){var l=editor.zEditor;l.rangeObj&&l.restoreSelection(l.rangeObj);var o=editor.getEditorMode(),n=l.getSelection(),s=l.getRange(n),m=n.toString(),r=l.getClosestElement("a");if(l.editorDiv.focus(),e){var d=l.z_doc;if(t=t||"",i=i||e,"plainEditor"===o){var c=$("#emailEditor").find("iframe").eq(0).contentDocument;return d=c,void c.execCommand("insertHTML","true",e)}if(null!==r&&m)r.title=t,r.href=e,r.innerHTML!==i&&(r.innerHTML=i),r.target="_blank",s.selectNode(r),n.removeAllRanges(),n.addRange(s),n.collapseToEnd(),l.linkDesc&&(l.linkDesc.getElementsByClassName("goToLink")[0].innerText=e),l.rangeObj=l.saveCaretPostion();else if(m&&0!==m.length){d.execCommand("createlink",!1,e),(n=l.getSelection()).collapseToEnd();var p=l.getParentNode();r=p,"A"===p.tagName&&(t&&(p.title=t),p.innerHTML!==i&&(p.innerHTML=i),"ZForms"===a&&p.setAttribute("data_zformlink",e),p.target="_blank",s.selectNodeContents(p),n.removeAllRanges(),n.addRange(s),n.collapseToEnd())}else{if(l.isGecko||l.isSafari)(E=d.createElement("A")).innerHTML=i,E.target="_blank",E.title=t,"ZForms"===a&&E.setAttribute("data_zformlink",e),E.href=e,E.classList.add("cP"),d.execCommand("insertHTML",!1,E.outerHTML);else if(d.execCommand("createlink",!1,e)){(n=l.getSelection()).collapseToEnd(),"A"===(E=l.getParentNode()).tagName&&(E.innerHTML=i,E.target="_blank",E.title=t,"ZForms"===a&&E.setAttribute("data_zformlink",e),E.href=e,E.classList.add("cP"),(s=l.getRange(n)).selectNode(E),n.removeAllRanges(),n.addRange(s),n.collapseToEnd())}else{var E;(E=d.createElement("A")).innerHTML=i,E.target="_blank",E.href=e,E.title=t,E.classList.add("cP");n=d.getSelection(),s=l.getRange(n);"function"==typeof n.collapseToEnd?(s.deleteContents(),s.insertNode(E),s.selectNode(E),s.setStartAfter(E),s.setEndAfter(E),n.removeAllRanges(),n.addRange(s)):(s.pasteHTML(E.outerHTML),n.collapseToEnd())}}}},EmailComposeUtil.removeAutoSuggestedElement=function(){var e=EmailComposeUtil.getAutoCompleteSuggestedElem();e&&(e.parentElement.removeChild(e),EmailCompose.EnableTab=!1)},EmailComposeUtil.removeSuggestedElement=function(e){e&&(window.document.documentMode?e.parentElement.removeChild(e):e.remove())},EmailComposeUtil.loadI18nResources=function(){var e=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor")];Lyte.injectResources(networkUtils.returnDependencyFiles(e,ResourceConstants.CRM),void 0,void 0)},EmailComposeUtil.setDefaultValues=function(){var e=CrmEmailInitialize.ComposeMailData.user.compose_settings,i={8:"1",10:"2",12:"3",14:"4",18:"5",24:"6",36:"7"},t=editor.zEditor.z_doc.getElementById("ecw_signature"),a=editor.zEditor.editorDiv.innerHTML;const l=document.createElement("div");EmailComposeUtil.isReplyMail&&!EmailSendingUtil.SwitchedFromOldToNew&&(editor.zEditor.editorDiv.innerHTML="<br><br><br>dummytextdummytext");var o=$(t).clone();if(e.font_size&&(editor.zEditor.focusEditor(),editor.zEditor.z_doc.execCommand("selectAll",!1,null),editor.zEditor.z_doc.execCommand("fontsize",!1,i[e.font_size]),editor.zEditor.updateFontSize(i[e.font_size]),editor.zEditor.activeTabElem.querySelector("#z_fntsizeText").innerHTML=e.font_size,l.style.fontSize=getFontList()[e.font_family]),e.font_family){var n=editor.zEditor;zEditor.prototype.createFontFamily(),editor.zEditor.z_doc.execCommand("selectAll",!1,null),zEditor.prototype.updateFontFamily(getFontList()[e.font_family]),n.z_doc.execCommand("fontname",!1,getFontList()[e.font_family]),l.style.fontFamily=i[e.font_size],n.hideDD(n.fontFamilyDiv)}EmailComposeUtil.isReplyMail&&!EmailSendingUtil.SwitchedFromOldToNew?(editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML+a,editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML.replaceAll("dummytextdummytext","")):EmailCompose.isDraftOpen||!t||EmailSendingUtil.SwitchedFromOldToNew?(EmailCompose.isDraftOpen||EmailSendingUtil.SwitchedFromOldToNew)&&(editor.zEditor.editorDiv.innerHTML=a):(t.remove(),editor.zEditor.editorDiv.append(o[0])),editor.zEditor.editorDiv.insertBefore(l,editor.zEditor.editorDiv.firstChild),editor.zEditor.getSelection().removeAllRanges()},EmailComposeUtil.createNewComposeTab=function(e){var i=EmailComposeUtil.createComposeTab();return(e=void 0===e?EmailComposeUtil.ComposeMailData:e).tabId=i,EmailComposeUtil.createComposeBody(e,i),i},EmailComposeUtil.createComposeTab=function(e,i,t,a){var l,o=$("body"),n=$("#composeEditor");if(Lyte.registeredMixins["crm-email-compose-mixin"])l=Lyte.registeredMixins["crm-email-compose-mixin"];else{var s=networkUtils.returnDependencyFiles(["crm-email-compose.js"],ResourceConstants.CRMClient);Lyte.injectResources(s,void 0,(function(){l=Lyte.registeredMixins["crm-email-compose-mixin"]}))}if(!n||0===n.length){(n=document.createElement("div")).setAttribute("id","composeEditor"),n.setAttribute("data-zcqa","composeEditorOuter_editor_ecw"),o.append(n);var m,r='<div data-zcqa="etNewMsg_ecw" class="cBafter etNewMsg">\t\t\t\t\t\t\t\t\t<div id="etZiaEmotionBand"></div>            \t\t\t\t\t\t<div class="fL">\t\t\t\t\t\t\t\t\t\t<ul class="m0 p0 dF" id="etComposeId">\t\t\t\t\t\t\t\t\t\t</ul>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t<div class="fR mR20 mT15 ecwNoDrag">'+(CrmEmailInitialize.ComposeMailData.features_available.COMPOSE_SWITCH_OPTION||EmailSendingUtil.SwitchedFromOldToNew?'<span class="ecwTryOldVersion ecwTryOldVersion mR10 vaM crm-small-font-size" onclick="EmailCompose.showEditorFeedBack()">'+I18n.getMsg("crm.email.compose.switch.old")+"</span>":"")+'<span data-zcqa="minimiseCompose_ecw" lt-prop-title="'+I18n.getMsg("crm.label.minimize")+'" class=" zcrm_svgIcons dIB etComposeMinIcon  cP mR10 op7 vaM" onclick="EmailCompose.etMinimiseCompose();"></span><span id ="etComposeMinMaxIcon" lt-prop-title="'+I18n.getMsg("crm.dashboard.compact")+'" class="mR10 zcrm_svgIcons dIB etComposeMinRestoreIcon cP vaM op7" data-zcqa = "ecAttachmentMinExpandIcon"> </span><span lt-prop-title="'+I18n.getMsg("crm.button.close")+'"  class=" zcrm_svgIcons dIB etComposeCloseIcon cP vaM op7" data-zcqa = "ecAttachmentCloseIcon" onclick="EmailCompose.etCloseAllTabs()" ></span></div>\t\t\t\t\t\t\t  </div>';(m=document.createElement("div")).setAttribute("id","etComposePanel"),m.setAttribute("data-zcqa","etComposePanel_ecw"),m.setAttribute("id","etComposePanel"),m.setAttribute("class","etRightPanel boxBB ecwMaximizedState"),$L(m).on("mousedown touchstart",(function(e){var i=e.target,t=$L("#etComposePanel"),a=getComputedStyle(t[0]),l=parseInt(a.top),o=window.scrollY;if(t.hasClass("ecwMaximizedState")){if("etComposeMinMaxIcon"!==i.id&&!i.classList.contains("etComposeMinIcon"))return}else{if(i.closest(".ecwNoDrag"))return;$L(".email_option_dropbox").is(":visible")&&$L(".email_option_dropdown")[0].close(),t.addClass("emailComposeDraggable"),t.removeClass("emailComposeNotDraggable")}o&&!t.hasClass("ecwMaximizedState")&&t.css({top:l+o}),$("body").addClass("ecwBodyOH")})),$L(m).on("mouseup touchend",(function(e){var i=$L("#etComposePanel"),t=e.target,a=getComputedStyle(i[0]),l=parseInt(a.top),o=window.scrollY;if(i.hasClass("ecwMaximizedState")){if("etComposeMinMaxIcon"!==t.id&&!t.classList.contains("etComposeMinIcon"))return}else{if(t.closest(".ecwNoDrag"))return;i.removeClass("emailComposeDraggable"),i.addClass("emailComposeNotDraggable")}o&&!i.hasClass("ecwMaximizedState")&&i.css({top:l-o}),$("body").removeClass("ecwBodyOH"),"200000"===i[0].style.zIndex&&crmui.modalZIndex("nonLyte",i[0],"open","drag")})),m.addEventListener("mouseleave",(function(){var e=$L("#etComposePanel");e&&e.length>0&&"200000"===e[0].style.zIndex&&crmui.modalZIndex("nonLyte",e[0],"open","drag")}),{passive:!0}),(n=$(n)).append(m),(m=$(m)).append(r);var d=document.createElement("div");$L(d).addClass("ecDragContainer"),n[0].insertBefore(d,n[0].firstChild);m.append('<div class="ecDragEle ecDragtopLeft"></div>\t\t\t<div class="ecDragEle hide ecDragtopMiddle" ></div>\t\t\t<div class="ecDragEle hide ecDragtopRight" ></div>\t\t\t<div class="ecDragEle hide ecDragmidLeft" ></div>\t\t\t<div class="ecDragEle hide ecDragmidRight"></div>\t\t\t<div class="ecDragEle hide ecDragbottomLeft" ></div>\t\t\t<div class="ecDragEle hide ecDragbottomMiddle"  ></div>\t\t\t<div class="ecDragEle hide ecDragbottomRight" ></div>'),$("#etComposePanel .ecDragEle").on("mousedown mouseup",(function(e){switch(e.type){case"mousedown":Lyte.registeredMixins["crm-email-compose-mixin"].stopEvent();break;case"mouseup":Lyte.registeredMixins["crm-email-compose-mixin"].onMouseUp()}}))}$L("#ecAutoCompleteContainer").addClass("hide");var c=$L("#etComposePanel");c.removeClass("etMinimize"),crmui.modalZIndex("nonLyte",c[0],"open");var p,E,u=$("#etComposeId");(p=EmailComposeUtil.composeSettingObj?"999":EmailComposeUtil.getNextTabId(),EmailComposeUtil.tabDetails[p]&&EmailUtil.closeEmailTab(p),a||(a=I18n.getMsg("crm.email.label.newmessage")),E=e&&i&&t?'<li class=" p15 pR maxW250 crmEllipticText dIB etComposeHeaderNew"  temptab="true" lt-prop-title = '+a+'  id="ecw_tab_'+p+'"   data-draftId='+e+" data-module="+i+" data-entId="+t+' data-subject="'+a+'" data-etTab="etComposeId1"  onclick="EmailComposeUtil.switchToTab(this)"> \t\t<span class="crm-base-font-size etTxt">'+a+'</span> \t\t<span class="svgIcons ico-close-white-small2 pA etClseIcn cP" onclick="EmailUtil.closeEmailTab('+p+');sE(event);"></span> \t</li>':'<li class="etComposeHeader p15 pR maxW250 crmEllipticText dIB etComposeHeaderNew" lt-prop-title = "New Message"  id="ecw_tab_'+p+'"  data-etTab="etComposeId1"  onclick="EmailComposeUtil.switchToTab(this)"> \t\t<span class="crm-base-font-size etTxt" >'+I18n.getMsg("crm.email.label.newmessage")+'</span> \t\t<span class="svgIcons ico-close-white-small2 pA etClseIcn cP" onclick="EmailUtil.closeEmailTab('+p+');sE(event);"></span> \t</li>',u.append(E),setTimeout((function(){document.body.addEventListener("mouseup",l.onBodyMouseUp)}),1e3),0===EmailComposeUtil.OPEN_TAB_COUNT)&&(c.addClass("etMinimize"),$L("#etComposePanel .etComposeMinRestoreIcon").on("click",(function(e){var i=$L(e.target),t=$L("#etComposePanel");$L("#ecAutoCompleteContainer").addClass("hide"),i.hasClass("etComposeMinRestoreIcon")?t.removeClass("ecwMaximizedState"):t.addClass("ecwMaximizedState"),Lyte.registeredMixins["crm-email-compose-mixin"].etToggleMinimiseRestore(),crmui.modalZIndex("nonLyte",t[0],"open")})));EmailSendingUtil.isLoadTemplate||(EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.successcallback&&EmailSendingUtil.isFromCscript.successcallback(),EmailSendingUtil.isFromCscript=null),EmailComposeUtil.tabDetails[p]={},EmailComposeUtil.OPEN_TAB_COUNT+=1;var C=EmailComposeUtil.linkedModuleFromAccounts;return null!==C&&(EmailComposeUtil.linkToModuleSelected[p]=!0,EmailComposeUtil.linkedModule[p]=C,EmailComposeUtil.linkedModuleFromAccounts=null),p},EmailComposeUtil.createComposeBody=function(e,i){var t=$("#etComposePanel"),a=document.createElement("div");if(a.setAttribute("data-zcqa","composeContentPanel_ecw_"+i),a.setAttribute("id","composeContentPanel_"+i),a.setAttribute("class","composeContentPanel hide"),e.integrationsAppName=Crm.integrationsAppName.ZOHO_SALESIQ,a.innerHTML=Handlebars.templates.EmailCompose(e),t.append(a),$("#composeContentPanel_"+i,"#ceSubject").on("input",EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName),e&&e.from_address){var l=e.from_address.find((e=>!0===e.default));l&&"primary"!==l.type&&(EmailComposeUtil.configuredEmail=l.email)}},EmailComposeUtil.getNextTabId=function(){var e,i,t=Object.keys(EmailComposeUtil.tabDetails),a=0,l=t.length,o=Number(EmailComposeUtil.OPEN_TAB_COUNT),n=Number(EmailComposeUtil.MAX_TAB_COUNT);if(o<n){var s=[];for(a=1;a<=n;a++){var m=a+"";s.push(m)}for(a=0;a<l;a++)i=t[a],s.removeFirstOccurenceOfElement(i);e=s[0]}else{var r=document.getElementsByClassName("etComposeHeaderNew")[0].getAttribute("id");e=Number(r.split(EmailComposeUtil.tabIdPrefix).pop())}return e},EmailComposeUtil.switchToTab=function(e){if(EmailCompose.closeSmartPrompt(),$(".ze_toolbarbg").parent().remove(),$("#ecw_tab_"+EmailComposeUtil.CURRENT_TAB).attr("isActiveComposeTab",!1),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide(),EmailComposeUtil.closeZiaEmotionBand(),EmailCompose.replaceTabid){var i=$("#"+e.id),t=i.clone();i.remove(),jQuery("#ecw_tab_"+EmailCompose.replaceTabid).replaceWith(jQuery(t)),$(e).appendTo("#ecw_tab_"+EmailCompose.replaceTabid),EmailUtil.closeEmailTab(EmailCompose.replaceTabid,!1,!1,!0),EmailCompose.replaceTabid=void 0,setTimeout(commonUtils.showHideLoadingDiv(),2e3)}$(".composeContentPanel").not(".hide").find(".select2-selection__rendered").removeClass("activeFromSpan");var a=EmailComposeUtil.CURRENT_TAB,l=e.getAttribute("id"),o=l.substring(l.lastIndexOf("_")+1,l.length);a!==(o=Number(o))&&Lyte.registeredMixins.crm_zia_writing_assistant_mixin.closeZiaWritingAssistPanel(),EmailComposeUtil.handleTheTabSwitchEvent(a,l);var n=EmailComposeUtil.tabIdPrefix+o,s=EmailComposeUtil.contentIdPrefix+o,m=document.getElementById(n),r=document.getElementById(s);if(0!==a){var d=EmailComposeUtil.tabIdPrefix+a,c=EmailComposeUtil.contentIdPrefix+a,p=document.getElementById(d),E=document.getElementById(c);p&&($(".etComposeHeader").removeClass("etComposeHeader"),r?(EmailActionHandling.saveDraftDetails(void 0,!0),E.classList.add("hide")):e.classList.add("etComposeDummyHeader"))}r?(m.classList.add("etComposeHeader"),r.classList.remove("hide"),EmailComposeUtil.CURRENT_TAB=o,EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,$("#ecw_tab_"+EmailComposeUtil.CURRENT_TAB).attr("isActiveComposeTab",!0),EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB+""),EmailComposeUtil.activeContentId=s,EmailComposeUtil.activeTabId=n,EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].lastActivityTime=(new Date).getTime()):(commonUtils.showHideLoadingDiv(!0),EmailComposeUtil.fetchAndPopulateBodyContent(e)),EmailLaunchUtil.showHideFromRecord(),setTimeout((function(){$(".composeContentPanel").not(".hide").find(".select2-selection__rendered").addClass("activeFromSpan")}),300),EmailComposeUtil.updatePopCount()},EmailComposeUtil.fetchAndPopulateBodyContent=function(e){var i=e.getAttribute("id"),t=i.split("ecw_tab_")[1];i=t;var a=e.getAttribute("data-draftId"),l=e.getAttribute("data-module"),o=e.getAttribute("data-entId");EmailCompose.replaceTabid=t,EmailCompose.hideDiscardPop=!0,setTimeout(EmailCompose.hideDiscardPop=!1,3e3),EmailCompose.fetchDraftDetails(a,l,o)},EmailComposeUtil.handleTheTabSwitchEvent=function(e){EmailComposeUtil.handleAutoCompleteEventOnTabSwitch(e)},EmailComposeUtil.handleAutoCompleteEventOnTabSwitch=function(e){0!==e&&EmailComposeUtil.removeAutoSuggestedElement(),EmailCompose.autoCompleteReqPool="",EmailCompose.insertWord=!0,EmailCompose.enableTab=!1,EmailCompose.responseAwaiting=!1,EmailCompose.TypedTextBeforeRecievingResponse=""},EmailComposeUtil.switchToCurrentEditor=function(e){var i=EmailComposeUtil.tabDetails[e].zEditor;i&&editor&&(editor.zEditor=i)},EmailComposeUtil.getCurrentTabId=function(){return EmailComposeUtil.tabIdPrefix+EmailComposeUtil.CURRENT_TAB},EmailComposeUtil.getMRUTabId=function(){var e,i,t,a,l=Object.keys(EmailComposeUtil.tabDetails),o=0,n=l.length;for(o=0;o<n;o++)t=l[o],a=EmailComposeUtil.tabDetails[t].lastActivityTime,(!i||a>i)&&(i=a,e=t);return e},EmailComposeUtil.getDisplayAddresses=function(e){var i=[],t="#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" li",a=$(t);return a.length>1&&a.each((function(){if(!$(this).hasClass("ecAddrEditor")){if(""!==$(this).attr("username"))var e=$ESAPI.encoder().encodeForHTML($(this).attr("username"));else e=$ESAPI.encoder().encodeForHTML($(this).attr("email"));i.push(e)}})),i},EmailComposeUtil.setEmailAddresses=function(){var e=$("#toAddress_"+EmailComposeUtil.CURRENT_TAB),i=$("#toAddrUname_"+EmailComposeUtil.CURRENT_TAB);$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>=0&&(e.val(EmailComposeUtil.getCommaSeparatedEmails("ceToAddrDetails")),i.val(EmailComposeUtil.getCommaSeparatedUsernames("ceToAddrDetails")));var t=$("#ccAddress_"+EmailComposeUtil.CURRENT_TAB),a=$("#ccAddrUname_"+EmailComposeUtil.CURRENT_TAB);$("#ceCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>=0&&(t.val(EmailComposeUtil.getCommaSeparatedEmails("ceCCAddrDetails")),a.val(EmailComposeUtil.getCommaSeparatedUsernames("ceCCAddrDetails")));var l=$("#bccAddress_"+EmailComposeUtil.CURRENT_TAB),o=$("#bccAddrUname_"+EmailComposeUtil.CURRENT_TAB);$("#ceBCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>=0&&(l.val(EmailComposeUtil.getCommaSeparatedEmails("ceBCCAddrDetails")),o.val(EmailComposeUtil.getCommaSeparatedUsernames("ceBCCAddrDetails")))},EmailComposeUtil.getCommaSeparatedEmails=function(e){var i=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB).find("li"),t=[];return $.each(i,(function(e,i){if(i.hasAttribute("email")&&!t.contains(i.getAttribute("email"))){var a=i.getAttribute("email");t.push(a)}})),t.toString()},EmailComposeUtil.getEmailAddressFromCompose=function(e){var i=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB).find("li"),t=[],a=[];return $.each(i,(function(e,i){var l={};if(i.hasAttribute("email")&&!t.contains(i.getAttribute("email"))){var o=i.getAttribute("username"),n=i.getAttribute("email");o||(o=n),l.user_name=o,l.email=n,t.push(n),a.push(l)}})),a},EmailComposeUtil.getCommaSeparatedUsernames=function(e){var i=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB).find("li"),t=[],a=[];return $.each(i,(function(e,i){if(i.hasAttribute("email")&&!t.contains(i.getAttribute("email"))){var l=i.getAttribute("username"),o=i.getAttribute("email");l||(l=o),a.push(l),t.push(o)}})),a.toString()},EmailComposeUtil.getTabIdContainingGivenDraft=function(e){for(var i,t=Object.keys(EmailComposeUtil.tabDetails),a=t.length,l=$("#isFromNewAPI").length>0,o=0;o<a;o++){var n=t[o],s=EmailComposeUtil.tabDetails[n].draftDetails;if(l&&s&&s.newRLDraftId===e)return i=n;if(s&&s.draftId===e)return i=n}return i},EmailComposeUtil.clearTemplate=function(){var e=$("#emcTemplateNameHolder_"+EmailComposeUtil.CURRENT_TAB),i=$("#ceSubject1_"+EmailComposeUtil.CURRENT_TAB),t=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.IsReplyOrForwardMail()||(i.val(""),t.val("")),$("#ceAddtemplate_"+EmailComposeUtil.CURRENT_TAB).html(I18n.getMsg("crm.email.add.template")),e.removeClass("emcTemplateNameHolder"),e.addClass("hide"),$("#emcTemplateOptions_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName(),EmailUtil.clearEditorAttachments(),$("#deleteDraft_"+EmailComposeUtil.CURRENT_TAB).hide();var a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB);(0===a.length||"Quotes"!==a.val()&&"Invoices"!==a.val()&&"PurchaseOrders"!==a.val()&&"SalesOrders"!==a.val())&&$("#ecDisplayAttachmentNames_"+EmailComposeUtil.CURRENT_TAB).html(""),$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val(""),editor.zEditor.plainEditor&&(editor.zEditor.plainEditor.value=""),editor.setContent("<br>"),EmailComposeUtil.editorContent=""},EmailComposeUtil.postLaunchHandling=function(){EmailSendingUtil.privacyPolicyDetails&&Object.keys(EmailSendingUtil.privacyPolicyDetails).length>0?EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].privacyPolicyDetails=EmailSendingUtil.privacyPolicyDetails:(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].privacyPolicyDetails={},EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].privacyPolicyDetails.isConsentMail=!1),EmailSendingUtil.privacyPolicyDetails={}},EmailComposeUtil.preLaunchHandling=function(){var e=Object.keys(EmailComposeUtil.tabDetails);EmailComposeUtil.sessionStoredDraftDetails&&0===e&&(EmailComposeUtil.resetSessionStorage(),EmailComposeUtil.sessionStoredDraftDetails=null)},EmailComposeUtil.setFileCheckVariableValue=function(){if($("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val()){var e=document.getElementById("fileCheckVariable_"+EmailComposeUtil.CURRENT_TAB),i=e.value;e.setAttribute("tempVal",i),e.value="EntityMail"}},EmailComposeUtil.resetFileCheckVariableValue=function(){var e=document.getElementById("fileCheckVariable_"+EmailComposeUtil.CURRENT_TAB);if(e){var i=e.getAttribute("tempval");e.value=i,e.removeAttribute("tempval")}},EmailComposeUtil.isValidInputForAutoComplete=function(e){var i=!0;if(""===e.trim())i=!1;else{var t=e.length;length>1&&(160===e.charCodeAt(t-1)||32===e.charCodeAt(t-1))&&(i=!1)}return i},EmailComposeUtil.getErrorMessageFromCode=function(e){var i="action failed",t=e.indexOf("UNCONFIRMED_USER")>-1,a=e.indexOf("TRANSMAIL_BLOCKED_ERROR")>-1;if(t)i="unconfirmed user";else if(a)i="email blocked";else switch(e){case"1101":i="no permission to perform this action";break;case"8011":i="no consent";break;case"8013":i="record locked with send mail restriction";break;case"1003":i="email opted out";break;case"2309":i="module doesnt have email"}return i},EmailComposeUtil.formEmailObject=function(e){return e&&Array.isArray(e)?e.map((function(e){return{email:e.email,user_name:e.label}})):[]},EmailComposeUtil.preformAndComposeWindow=function(e,i,t){var a=e.from||"",l=EmailComposeUtil.formEmailObject(e.to),o=EmailComposeUtil.formEmailObject(e.cc),n=EmailComposeUtil.formEmailObject(e.bcc),s=e.subject||"",m=ZSEC.HTMLPurifier({ALLOWED_STYLE:"ALL",STYLE_VALIDATION:!1}).sanitize(e.body||""),r=i.module,d=i.record,c=d?d.id:"",p={};e.pdfLayoutDetails&&(p.pdfLayoutDetails=e.pdfLayoutDetails),EmailSendingUtil.entityId=c,EmailLaunchUtil.openComposeWindow(a,l,o,n,r,c,e.templateId,m,s,t,p)},EmailComposeUtil.closeZiaEmotionBand=function(){Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand()},EmailComposeUtil.getCurrentPopover=function(){for(var e,i=document.getElementsByTagName("crm-emailcompose-attachment-popover"),t=i.length,a=0;a<t;a++)i[a].firstElementChild.id==="ecAttchmntPopContainer_"+EmailComposeUtil.CURRENT_TAB&&(e=a);return i[e].component},EmailComposeUtil.closeTabAtDeleteRecords=function(e){try{if(e&&e.length>0)for(var i=e.length,t=0;t<i;t++){var a,l=EmailComposeUtil.entityIdVsTabIds[e[t]];if(l&&(a=l.length,l&&a&&a>0)){for(var o=0;o<a;o++)EmailUtil.closeEmailTab(l[o],void 0,void 0,!0);delete EmailComposeUtil.entityIdVsTabIds[e[t]]}}}catch(e){murphy.error(e)}},EmailComposeUtil.setComposePositionInSessionStorage=function(e){e||(e=!1);var i=sessionStorage.getItem("compsoePosition");if(i&&"null"!==i||(i={}),e)return i={isDefaultView:e},void sessionStorage.setItem("compsoePosition",JSON.stringify(i));i={bottom:EmailCompose.popupPos.bottom,height:EmailCompose.popupPos.height,left:EmailCompose.popupPos.left,right:EmailCompose.popupPos.right,top:EmailCompose.popupPos.top,width:EmailCompose.popupPos.width,isDefaultView:e},sessionStorage.setItem("compsoePosition",JSON.stringify(i))},EmailComposeUtil.setSessionComposePositionInComposePanel=function(){var e=sessionStorage.getItem("compsoePosition");if(e&&"null"!==e){var i=JSON.parse(e);!i||"null"===i.top||"null"===i.left&&"null"===i.right||(EmailCompose.popupPos.bottom=i.bottom,EmailCompose.popupPos.height=i.height,EmailCompose.popupPos.left=i.left,EmailCompose.popupPos.right=i.right,EmailCompose.popupPos.top=i.top,EmailCompose.popupPos.width=i.width)}},EmailComposeUtil.updatePopCount=function(){if(Lyte.registeredMixins["crm-email-compose"])Lyte.registeredMixins["crm-email-compose-mixin"].updatePopCount();else{var e=networkUtils.returnDependencyFiles(["crm-email-compose.js"],ResourceConstants.CRMClient);Lyte.injectResources(e,void 0,(function(){Lyte.registeredMixins["crm-email-compose-mixin"].updatePopCount()}))}},EmailComposeUtil.showOrHidePopover=function(e){if(Lyte.registeredMixins["crm-email-compose"])Lyte.registeredMixins["crm-email-compose-mixin"].showOrHidePopover(e);else{var i=networkUtils.returnDependencyFiles(["crm-email-compose.js"],ResourceConstants.CRMClient);Lyte.injectResources(i,void 0,(function(){Lyte.registeredMixins["crm-email-compose-mixin"].showOrHidePopover(e)}))}},EmailComposeUtil.reduceAttachmentCount=function(e,i){i||(i=EmailComposeUtil.CURRENT_TAB);var t=EmailComposeUtil.tabIdVsAddingAttachmentCount.get(i);t&&t>0&&(t-=e,EmailComposeUtil.tabIdVsAddingAttachmentCount.set(i,t))},EmailComposeUtil.checkSaveDraftPermissionIsGivenForTap=function(e){e||(e=EmailComposeUtil.CURRENT_TAB);var i=EmailComposeUtil.tabIdVsAddingAttachmentCount.get(e);return!i||-1===i||0===i},EmailComposeUtil.resetSessionStorageComposePosition=function(){sessionStorage.setItem("compsoePosition",null)},EmailComposeUtil.isZBluePencilFeatureAvailable=function(){return"true"===RebrandLinkUtil.getProperty("BLUEPENCIL_ENABLED")&&void 0!==EmailComposeUtil};var EmailCompose={aiData:{},tempCallback:"",tempData:"",tempEditorMode:"",isDraft:!1,hideDiscardPop:(!1,!1),disableToaddress:!1,openingScheduleMail:!1,replaceTabid:"",isSessionRestore:!1,isRefreshFirstOpen:!1,autoCompleteData:""};EmailComposeUtil.action=[],EmailComposeUtil.forwardAttachmentDetails=[],EmailCompose.minEmailBodyLength=100,EmailCompose.maxAPICallCount=5,EmailCompose.autoTrigger="",EmailCompose.optOutModule=[],EmailCompose.contactId=[],EmailCompose.populateEmailScheduleDetails=function(){(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:"GET",data:"action=loadScheduleOptions",success:function(e){var i=Handlebars.templates.ScheduleTime(e);$("#etSchedulePopId").append(i);var t=new Date;Utils.convertToUserTimezone(t),EmailSendingUtil.setBestTime(t);var a=$("#startDate");a&&a.on("change",(function(){var e=$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB),i=$("#startDate");e.val(i.val())}))}}),EmailComposeUtil.setUPSchedulePopup(!0)},EmailCompose.showInsertOptions=function(){(crmui.hideMsgBand(),"Cases"===$L("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val())&&$L("#zforms_link_"+EmailComposeUtil.CURRENT_TAB).hide();$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).show(),EmailCompose.initializeHideSchedulePop()},EmailCompose.setMailAddress=function(e,i,t){if(e){var a,l=$("#ce"+t+"AddrDetails_"+EmailComposeUtil.CURRENT_TAB);if(a=l.children(".ecAddrEditor"),EmailComposeUtil.validateEmailFieldsOfToCcBcc()){var o=$L("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),n=Object.keys(moduleApiMapping).filter((e=>moduleApiMapping[e]===o));n&&n.length>0&&EmailComposeUtil.isCustomModule(n[0])&&(o=n[0]);var s=$L("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),m=Lyte.Router.getRouteInstance().transition.info.dynamicParams[0];if("Deals"===o||"Potentials"===o)EmailSendingUtil.setUnameAndEmail(e,i,null,a,s,o,null,!1,"contactEmails_"+s);else if("Accounts"===m&&"Contacts"===o&&Crm.userDetails.isEmailsForModuleEnabled)EmailSendingUtil.setUnameAndEmail(e,i,null,a,s,o,null,!1,"contactEmails_"+s);else if("Cases"===o){var r=store.peekRecord(moduleRecordMapping.Cases.id,s);if(r&&r.Related_To){var d=r.Related_To.id,c=EmailComposeUtil.selectedEmails[EmailComposeUtil.CURRENT_TAB];c||(c={});c.primaryEmail=e,EmailComposeUtil.selectedEmails[EmailComposeUtil.CURRENT_TAB]=c,EmailSendingUtil.setUnameAndEmail(e,i,null,a,d,"Contacts",null,!1,"primaryEmail")}else EmailCompose.getEmailTypeAndSetUnameAndEmail(o,s,e,i,a)}else EmailCompose.getEmailTypeAndSetUnameAndEmail(o,s,e,i,a)}if(2===l.children("li").length){var p=document.getElementById("ce"+t.toUpperCase()+"Link_"+EmailComposeUtil.CURRENT_TAB);p&&EmailSendingUtil.newshowHideoptions(p,t.toLowerCase())}$("#toAddress_"+EmailComposeUtil.CURRENT_TAB).val(e),setTimeout((function(){EmailSendingUtil.isSendMailActionCalled=!1}),3e3),EmailCompose.disableRecipientSection()}},EmailCompose.disableRecipientSection=function(){if(CrmEmailInitialize.ComposeMailData.features_available.DISABLE_ECW_RECIPIENT)try{var e=EmailComposeUtil.getEmailAddressFromCompose("ceToAddrDetails"),i=EmailComposeUtil.getEmailAddressFromCompose("ceCCAddrDetails"),t=EmailComposeUtil.getEmailAddressFromCompose("ceBCCAddrDetails");e&&e.length>0?($L("#ceOptionTo_"+EmailComposeUtil.CURRENT_TAB).addClass("pointerEveNone","op6","disabled").css("pointer-events","none"),$L("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).prop("disabled",!0)):($L("#ceOptionTo_"+EmailComposeUtil.CURRENT_TAB).removeClass("pointerEveNone","op6").css("pointer-events",""),$L("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).prop("disabled",!1)),i&&i.length>0?($L("#ceOption_cc_"+EmailComposeUtil.CURRENT_TAB).addClass("pointerEveNone","op6","disabled").css("pointer-events","none"),$L("#ceCCAddr_"+EmailComposeUtil.CURRENT_TAB).prop("disabled",!0)):($L("#ceOption_cc_"+EmailComposeUtil.CURRENT_TAB).removeClass("pointerEveNone","op6").css("pointer-events",""),$L("#ceCCAddr_"+EmailComposeUtil.CURRENT_TAB).prop("disabled",!1)),t&&t.length>0?($L("#ceOption_bcc_"+EmailComposeUtil.CURRENT_TAB).addClass("pointerEveNone","op6","disabled").css("pointer-events","none"),$L("#ceBCCAddr_"+EmailComposeUtil.CURRENT_TAB).prop("disabled",!0)):($L("#ceOption_bcc_"+EmailComposeUtil.CURRENT_TAB).removeClass("pointerEveNone","op6").css("pointer-events",""),$L("#ceBCCAddr_"+EmailComposeUtil.CURRENT_TAB).prop("disabled",!1))}catch(e){return}},EmailCompose.getEmailTypeAndSetUnameAndEmail=function(e,i,t,a,l){if("Sales_Orders"===e)var o=store.peekRecord(moduleRecordMapping.SalesOrders.id,i);else if("Purchase_Orders"===e)o=store.peekRecord(moduleRecordMapping.PurchaseOrders.id,i);else if(moduleRecordMapping[e])o=store.peekRecord(moduleRecordMapping[e].id,i);if(o){var n=EmailCompose.findEmailType(o,t);EmailSendingUtil.setUnameAndEmail(t,a,null,l,i,e,null,!1,n)}else EmailSendingUtil.setUnameAndEmail(t,a,null,l,i,e,null,!1)},EmailCompose.findEmailType=function(e,i){if(e){var t=e.Email,a=e.Secondary_Email;if(t&&t===i)return"primaryEmail";if(a&&a===i)return"addnEmail"}},EmailCompose.deleteDraft=function(e){var i=$("#draftId_"+EmailComposeUtil.CURRENT_TAB),t=i.val(),a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();t&&(i.val(""),EmailComposeUtil.deleteDraft(t,a,l,e))},EmailCompose.deleteDraftPopup=function(e,i,t){if(!e){var a=$("#draftId_"+EmailComposeUtil.CURRENT_TAB);e=a.val()}i||(i=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),t||(t=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val());var l=I18n.getMsg("crm.email.delete.confirm.msg",I18n.getMsg("crm.process.tab.draft")),o=event.target,n={val:I18n.getMsg("crm.button.scoring.rules.delete.rule.confimation"),fn:function(){EmailComposeUtil.deleteDraft(e,i,t),o&&$(o).is(":visible")&&(o.classList.remove("ecwDeleteIconContainer"),o.classList.add("loading")),EmailSendingUtil.composeActive&&EmailUtil.hideEditorFreezeLayer()}},s={val:I18n.getMsg("crm.button.cancel"),fn:function(){EmailSendingUtil.composeActive&&EmailUtil.hideEditorFreezeLayer(),$("#customConfirmationPop").hide()}};EmailSendingUtil.composeActive&&EmailUtil.showEditorFreezeLayer(),renderingUtils.showCustomConfirmMessageNewModel(l,n,s),$L("#customConfirmationPop").find(".confirmBtn").addClass("redbtn").removeClass("primarybtn")},EmailCompose.removeTemplate=function(){if(EmailActionHandling.removeTemplate(),editor){editor.zEditor.showRichEditor();var e=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("data");if(e){var i=e[0].element;EmailUtil.setSignature(i.value)}EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]&&EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]&&(editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML+EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB])}EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB]=[],EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB]&&(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].tempDraftDetails=editor.getContent());var t=$(`#toolBarDiv_${EmailComposeUtil.CURRENT_TAB} .zi_emailfooter_li`);t&&t.show()},EmailCompose.launchEmailCompose=function(e,i){var t=$("#module");if(t.length>0?EmailSendingUtil.module=t.val():EmailSendingUtil.module=$("#mainMenuTabDiv crm-tab").attr("previously-selected-module"),EmailComposeUtil.OPEN_TAB_COUNT>0&&EmailComposeUtil.OPEN_TAB_COUNT<6&&EmailActionHandling.saveDraftDetails(),EmailComposeUtil.EditorContent="",CrmEmailInitialize.ComposeMailData){if(EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData,CrmEmailInitialize.PopulateComposeMailData(),i)EmailCompose.launchEmailComposeWindow(e,undefined,i);else EmailCompose.launchEmailComposeWindow(e);EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]="",EmailCompose["parsedContent_"+EmailComposeUtil.CURRENT_TAB]="",EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]=0}else CrmEmailInitialize.PopulateComposeMailData(e,!0,i)},EmailCompose.openComposeWindow=function(){EmailCompose.launchEmailCompose(),EmailCompose.setEntityToAddress(),EmailSendingUtil.composeActive=!0,showComposeWindow()},EmailCompose.showFreezelayer=function(){var e=$("body"),i=$("#EmailComposeFreezelayer");if(!i||0===i.length){e.append("<div data-zcqa='emailComposeFreezelayer_editor_ecw' id='EmailComposeFreezelayer' class='EmailComposeFreezelayer'></div>"),e.addClass("ecwBodyOH")}},EmailCompose.removeFreezelayer=function(){$("body").removeClass("ecwBodyOH"),$("#EmailComposeFreezelayer").remove()},EmailCompose.launchSignatureEditor=function(e){var i=networkUtils.returnDependencyFiles(["inlineEmailCompose_min.js","zohocrm_mailClient.js"],ResourceConstants.CRM).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.js"],ResourceConstants.CRMClient)).concat(networkUtils.returnDependencyFiles(["lyte-draggable.js"],ResourceConstants.CRMClient)),t=networkUtils.returnDependencyFiles(["inline_ComposeEditor_min.css"],ResourceConstants.CRM).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.css"],ResourceConstants.CRMClient)),a=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor")];Lyte.injectResources(networkUtils.returnDependencyFiles(a,ResourceConstants.CRM),void 0,void 0);var l=[];featuresAvailable.WRITING_ASSISTANT&&(l=l.concat(networkUtils.returnDependencyFiles(["crm-zia-writing-assistant.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT))),l=l.concat(networkUtils.returnDependencyFiles(["crm-zia-writing-assistant-mixin.js","crm-zia-writing-assistant.js"],ResourceConstants.CRMClient));var o=(i=i.concat(l)).concat(t);Lyte.injectResources(o,void 0,(function(){var i=e.tabId;EmailComposeUtil.CURRENT_TAB=i,EmailComposeUtil.tabDetails[i]={},"undefined"!=typeof ZBluePencil&&ZBluePencil?(EmailComposeUtil.hasDictionarySourceAdded=!1,editor.create(e)):Lyte.injectResources(e.dictionaryURL,void 0,(function(){EmailComposeUtil.hasDictionarySourceAdded="undefined"!=typeof ZBluePencil,editor.create(e)}))}))},EmailCompose.launchEmailComposeWindow=function(e,i,t,a){if(5===EmailComposeUtil.OPEN_TAB_COUNT&&!a&&!EmailCompose.replaceTabid)return EmailSendingUtil.openTabALertPopup=!0,EmailCompose.tempCallback=e,EmailCompose.tempData=i,EmailCompose.tempEditorMode=t,EmailCompose.disableToaddress=!0,$L("#ecwTabPop")[0].ltProp("show",!0),setTimeout((function(){EmailSendingUtil.isSendMailActionCalled=!1}),3e3),void setTimeout(EmailSendingUtil.openTabALertPopup=!1,2e3);EmailComposeUtil.editorContent="",EmailComposeUtil.isRefresh||EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.preLaunchHandling();var l=EmailComposeUtil.createNewComposeTab(i),o=document.getElementById(EmailComposeUtil.tabIdPrefix+l);EmailComposeUtil.switchToTab(o),EmailComposeUtil.initialize(l,t,e),EmailComposeUtil.showComposeWindow(),$("#editorContent_"+EmailComposeUtil.CURRENT_TAB).on("click",(function(){$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide")})),$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).on("click",(function(){$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide"),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide()})),EmailComposeUtil.postLaunchHandling()},EmailCompose.getContactRelatedToCase=function(e){var i=store.peekRecord(moduleRecordMapping.Cases.id,e);if(i&&i.Related_To)return i.Related_To.id},EmailCompose.setEntityToAddress=function(e,i,t){EmailComposeUtil.currentEntityName[EmailComposeUtil.CURRENT_TAB]="";var a=EmailComposeUtil.isCustomModule(e),l=$("#scheduledMails"),o=$("#draftMails");if("listview"===t&&"Potentials"!==e){if(["Quotes","SalesOrders","PurchaseOrders","Invoices"].indexOf(e)>=0&&!EmailComposeUtil.isContactEmailOptOut)EmailCompose.getParentEntityDetailsThenRelatedContactDetails(e,i);else{if("Cases"===e)(E=EmailCompose.getContactRelatedToCase(i))&&EmailComposeUtil.getEntityDetailsFromDB("Contacts",E,t);else EmailComposeUtil.getEntityDetailsFromDB(e,i,t);EmailComposeUtil.isContactEmailOptOut=!1}}else if("sendReminder"===t){var n=EmailComposeUtil.ReminderMail.userId;EmailComposeUtil.getUserDetails(n,(function(e){var i=e.email,t=e.entityName;EmailCompose.setMailAddress(i,t,"To"),EmailComposeUtil.ReminderMail={}}))}else if("Potentials"===e){var s=$("#dealOnlyDropDown").attr("lt-prop-selected"),m=$L("#contactRolesDropDown"),r=Crm.userDetails.CONTACT_ROLES_EMAILS_RL&&m&&m.length>0?m[0].component.data.ltPropSelected:$L("#cntId").val();if(r&&r.length>0&&s&&"dealsOnly"!==s){var d=r;returnJson&&returnJson.entityMapJson&&returnJson.entityMapJson.CONTACTID&&returnJson.entityMapJson.CONTACTID.defaultid&&!r&&(d=returnJson.entityMapJson.CONTACTID.defaultid),EmailComposeUtil.getEntityDetailsFromDB("Contacts",d,t)}else EmailCompose.getParentEntityDetailsThenRelatedContactDetails(e,i,t)}else if("Accounts"===e){var c=(o.hasClass("selectTab")?$("#accountsDrafts :selected"):l.hasClass("selectTab")?$("#accountsScheduled :selected"):$("#contactSelDropdownInAcc :selected")).attr("value");void 0!==c&&"ALL"!==c&&(i=c,e="Contacts"),null==i&&(i=o.hasClass("selectTab")?$("#accountsDrafts").attr("lt-prop-selected"):l.hasClass("selectTab")?$("#accountsScheduled").attr("lt-prop-selected"):$("#contactSelDropdownInAcc").attr("lt-prop-selected")),EmailComposeUtil.getEntityDetailsFromDB(e,i,t)}else if("Invoices"!==e&&"SalesOrders"!==e&&"PurchaseOrders"!==e&&"Quotes"!==e||EmailComposeUtil.isContactEmailOptOut)if("Cases"!==e||EmailComposeUtil.isContactEmailOptOut)if(a){var p=Crm.userDetails.MODULE_LIST[e].api_name;EmailComposeUtil.getEntityDetailsFromDB(p,i,t),EmailComposeUtil.setCustomModuleName(e)}else EmailComposeUtil.getEntityDetailsFromDB(e,i,t);else{var E;(E=EmailCompose.getContactRelatedToCase(i))&&EmailComposeUtil.getEntityDetailsFromDB("Contacts",E,t),EmailComposeUtil.isContactEmailOptOut=!1}else EmailCompose.getParentEntityDetailsThenRelatedContactDetails(e,i,t),EmailComposeUtil.isContactEmailOptOut=!1;EmailComposeUtil.setEntityDetails(e,i)},EmailCompose.getParentEntityDetailsThenRelatedContactDetails=function(e,i,t){var a=EmailComposeUtil.getApiNameForModule(e),l=EmailComposeUtil.pdfLayoutDetails?EmailComposeUtil.pdfLayoutDetails.isMailToVendor:void 0;l||(l=void 0),EmailComposeUtil.isMailToVendor=l;var o="/crm/v2/"+a+"/"+i;(new crmRequestPool).initiate({url:o,type:"GET",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},content:"application/json; charset=UTF-8",dataType:"json",success:function(a){var l=(a=a?a.data[0]:{}).Contact_Name,o=EmailComposeUtil.isMailToVendor;if(EmailComposeUtil.isInventoryModule(e)&&EmailComposeUtil.pdfLayoutDetails&&(EmailComposeUtil.pdfLayoutDetails.subject=a.Subject,EmailComposeUtil.setSubject(a.Subject)),l&&!o)i=l.id,e="Contacts",EmailComposeUtil.getEntityDetailsFromDB(e,i,t);else if(o){var n=a.Vendor_Name;i=n.id,e="Vendors",EmailComposeUtil.getEntityDetailsFromDB(e,i,t)}EmailComposeUtil.isMailToVendor=!1}})},EmailCompose.addSecondaryMailDropDown=function(e,i){$("#secondaryEmailOption_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide");var t=e+"###"+i,a=$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).find("ul").children("li"),l=["EO","EA","AO"];$.each(a,(function(e){this.setAttribute("onClick","EmailComposeUtil.populateAddnEmail('"+l[e]+"',\""+$ESAPI.encoder().encodeForJavaScript(t)+'")')}))},EmailCompose.fetchDraftDetails=function(e,i,t,a){let l=Crm.userDetails.LITE.IS_LITE_USER;var o=Crm.userDetails.isEmailAuthorisationEnabled;i||(i=$("#module").val()),t||(t=$("#entityId").val()),EmailComposeUtil.loadI18nResources();var n=$("#isFromNewAPI").length>0,s=e,m=$("#dealOnlyDropDown");if(n&&"Potentials"==i&&m.length>0&&"dealsOnly"!=m.attr("lt-prop-selected")){i="Contacts",t=m.attr("lt-prop-selected");var r=$L("#contactRolesDropDown");if(r.length>0&&Crm.userDetails.CONTACT_ROLES_EMAILS_RL){var d=r[0].component.data.ltPropSelected;t=d}}if("Cases"===i&&Crm.userDetails.isEmailsForCasesModuleEnabled){var c=$L("crm-email-rl-filter"),p=(c.length>0?c.get(0).component:void 0).getData("moduleSelected");p&&"CASES_ALL"!==p&&"ACCOUNTS_ALL"!==p&&(i="Contacts",t=p)}if((!Crm.userDetails.isNewEditor||!Crm.userDetails.EMAIL_THREAD_VIEW)&&!a&&o){var E=Crm.getCrmBasePath()+"/mailer/EntReply.do?action=viewDraft",u="&user_id="+Crm.userDetails.USER_ID+"&module="+i+"&entId="+t+"&draftId="+e;return u+="&"+csrfParamName+"="+encodeURIComponent(csrfToken),void(new crmRequestPool).initiate({action:E,data:u,success:function(a){if(""!==a){var l=$("#lookupdiv");0==$("crm-emails-related-list").length&&l.addClass("edvContainer");var o=$(document.createElement("iframe"));o.attr({id:"emailDetailIframeContent",style:"opacity:1; width:100%; height:100%;clear: both; border: medium none",src:"/crm/html/content1.html"}),$(document.getElementById("lookupdiv")).append(o).append('<div id="edvFreezeLayer" class="hide"><div id="loading-bar-spinner" class="spinner"><div class="spinner-icon"></div></div></div>'),$("#emailDetailIframeContent").load((function(){var e=$("#emailDetailIframeContent").contents(),i=e.find("body"),t=e.find("#emailDetailContentDivOuter .getFirstEmailContent").height();setTimeout((function(){$("#emailDetailIframeContent").parent().css("z-index",28),document.getElementById("emailDetailIframeContent").contentWindow.document.write(a),0==$("crm-emails-related-list").length&&mailsetCenter("lookupdiv")}),0),$("#lookupdiv").removeClass("p20").addClass("mB20"),i.css("overflow","hidden"),e.find("#emailDetailContentDivOuter").perfectScrollbar({wheelSpeed:1,wheelPropagation:!0,suppressScrollX:!1}),setTimeout((function(){var e=$L("#emailDetailIframeContent").contents(),i=e.find("body"),a=e.find(".ecMailDp");i.css("margin","0");var l=a.hasClass("emptyImgContainer")?"/nophoto.png":a.attr("src");if(t>545&&e.find("#mailClientPopupCss").addClass("headerFixCssAfter"),e.find("#emailDetailContentDivOuter").perfectScrollbar({wheelSpeed:1,wheelPropagation:!0,suppressScrollX:!1}),l&&"nophoto.png"==l.substr(l.lastIndexOf("/")+1))a.addClass("emptyImgContainer"),createAvatar();else{var o='<img src="'+l+'" alt="" style=" border:1px solid #fff;border-radius:50%;" height="48" width="48">';a.parent().append(o),a.remove()}var n=$("#edvFreezeLayer");n.length&&n.addClass("hide"),"canvas"==Lyte.Router.getRouteInstance().routeName&&e.find(".enrichData").hide()}),200)})),renderingUtils.freezeBackground();var n=$("#FreezeLayer");n.css({"z-index":"24"}),$("#kso_mails_list .kso_eachMailContainer").length?(l.css({position:"absolute",width:"1000px",height:"600px",zIndex:35,opacity:"1"}).show(),n.css({"z-index":"33"})):$("#isFromNewAPI").length>0?(l.addClass("topAlignEmailDetail"),l[0].style.display="block",setPopCenter(l)):l.css({position:"absolute",width:"1000px",height:"600px",zIndex:30,opacity:"1"}).show(),EvalInnerScript(l.get(0)),$(".currViewedMail").removeClass("currViewedMail")}else EmailCompose.fetchDraftDetails(e,i,t,!0)}})}var C=EmailComposeUtil.validateMailSendingPermission(i,t,e,(function(e,i,t){var m=EmailComposeUtil.getTabIdContainingGivenDraft(e),r=$("#moduleName_"+m),d=$("#ecEntityId_"+m);if((e&&r.val()!==i&&d.val()!==t&&(r.val(i),d.val(t)),m)&&EmailCompose.etMaximizeCompose(m))return;if("Accounts"===(i=EmailComposeUtil.getApiNameForModule(i))){var c=$L("#accountsDrafts");if(n&&c.length>0)"ACCOUNTS_ALL"!==c[0].ltProp("selected")&&(i="Contacts",t=c[0].ltProp("selected"),EmailSendingUtil.optOutModule=i)}var p=EmailComposeUtil.getAPIDraftURL(e,i,t);(new crmRequestPool).initiate({url:p,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},type:"GET",success:function(m){if(!m){if(crmui.showMsgBand("error",I18n.getMsg("crm.email.no.drafts.msg"),5e3),EmailComposeUtil.removeDraftIdFromSessionStorage(e),EmailCompose.replaceTabid&&(EmailUtil.closeEmailTab(EmailCompose.replaceTabid,!1,!1,!0),EmailCompose.replaceTabid=""),0===EmailComposeUtil.OPEN_TAB_COUNT&&EmailCompose.isRefreshFirstOpen)$("#maxComposeBtn").addClass("hide");return commonUtils.showHideLoadingDiv(!1),void(EmailCompose.isRefreshFirstOpen=!1)}var r=m.__email_drafts[0].$sharing_permission?m.__email_drafts[0].$sharing_permission:"full_access",d=void 0!==m.__email_drafts[0].owner&&Crm.userDetails.USER_ID===m.__email_drafts[0].owner.id;if(!o||(a||d)&&!l)return a&&"read_only"===r?(EmailUtil.showMsg("error",I18n.getMsg("crm.security.error"),3e3),void renderingUtils.removeFreezeLayer()):void(o&&!d?_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.email.message.draft.edit"),ltPropSecondaryMessage:I18n.getMsg("crm.email.message.draft.explanation"),ltPropButtons:[{type:"reject",text:I18n.getMsg("crm.button.cancel"),appearance:"default"},{type:"accept",text:I18n.getMsg("crm.button.edit"),appearance:"primary"}]},accept:function(){var l=$L("#edvModalConversation")[0];l&&l.ltProp("show",!1),a&&renderingUtils.removeFreezeLayer(),EmailCompose.openDraftCompose(m,i,t,n,e,s)},reject:function(){a&&renderingUtils.removeFreezeLayer()}}):EmailCompose.openDraftCompose(m,i,t,n,e,s));EmailCompose.viewDraftMail(m.__email_drafts[0])},error:function(i){("204"===i.status&&crmui.showMsgBand(I18n.getMsg("crm.email.no.drafts.msg"),5e3),i.responseJSON&&"NO_PERMISSION"===i.responseJSON.code?EmailUtil.showMsg("error",I18n.getMsg("crm.security.error"),3e3):i.responseJSON&&"the id given seems to be invalid"===i.responseJSON.message?EmailUtil.showMsg("error",I18n.getMsg("crm.email.no.drafts.msg"),3e3):i.responseJSON&&"the related id given seems to be invalid"===i.responseJSON.message&&EmailUtil.showMsg("error",I18n.getMsg("crm.email.label.error.item_deleted_or_removed",I18n.getMsg("Record")),3e3),EmailComposeUtil.removeDraftIdFromSessionStorage(e),EmailCompose.replaceTabid&&(EmailUtil.closeEmailTab(EmailCompose.replaceTabid,!1,!1,!0),EmailCompose.replaceTabid=""),0===EmailComposeUtil.OPEN_TAB_COUNT&&EmailCompose.isRefreshFirstOpen)&&$("#maxComposeBtn").addClass("hide");EmailCompose.isRefreshFirstOpen=!1,commonUtils.showHideLoadingDiv(!1)}})}),!0);if(!C&&!l)return!1},EmailCompose.openDraftCompose=function(e,i,t,a,l,o){EmailCompose.isRefreshFirstOpen=!1;var n=e?e[EmailComposeUtil.Draft_Root_Element][0]:null;if(n=EmailCompose.paramChangesForV3(n),$("#isFromNewAPI").length>0){var s=EmailComposeUtil.getTabIdContainingGivenDraft(n.id);if(s)if(EmailCompose.etMaximizeCompose(s))return}if(!!n&&n.email_opt_out)renderingUtils.showCustomAlert(I18n.getMsg("crm.label.emailoptout.alert.message"));else{var m=n.linked_record;m&&null!==m&&(EmailComposeUtil.fromGetDraftLinkedModule=m,EmailComposeUtil.getDraftModule=i),EmailCompose.populateComposeData=e,EmailCompose.isDraftOpen=!0,EmailCompose.launchEmailCompose((function(){(e=EmailCompose.populateComposeData).__email_drafts[0].rich_text||editor.zEditor.showPlainEditor(!0);var n="draft";if(EmailComposeUtil.isInventoryModule(i)||"Potentials"===i)EmailCompose.getParentEntityDetailsThenRelatedContactDetails(i,t,n);else if(EmailComposeUtil.isCustomModule(i)){var s=Crm.userDetails.MODULE_LIST[i].api_name;EmailComposeUtil.getEntityDetailsFromDB(s,t,n)}else EmailComposeUtil.getEntityDetailsFromDB(i,t,n);EmailComposeUtil.setEntityDetails(i,t),EmailComposeUtil.bindSalesIqLink(),EmailCompose.populateComposeMailData(e),EmailCompose.populateComposeData={},e.__email_drafts&&e.__email_drafts[0]&&e.__email_drafts[0].source&&EmailActionHandling.source.set(EmailComposeUtil.CURRENT_TAB,e.__email_drafts[0].source),l=e.__email_drafts[0].id,$("#draftId_"+EmailComposeUtil.CURRENT_TAB).val(l),$("#deleteDraft_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),$("#deleteDraftIcon_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),$("#draftStatusMsg_"+EmailComposeUtil.CURRENT_TAB).text(I18n.getMsg("crm.email.label.delete.draft"));var m=EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails;EmailCompose.isComposeOpenFromDraft=!0;var r=EmailCompose.removeSignature(e.__email_drafts[0].content);r=EmailCompose.extractHTMLTags(r);var d=EmailCompose.removeSpaces(r),c=e.__email_drafts[0].subject&&"null"===e.__email_drafts[0].subject?"":e.__email_drafts[0].subject;""!==d&&d.length>EmailCompose.minEmailBodyLength&&(""===c?EmailCompose.getSuggestion(!1,"draft"):EmailCompose.getSuggestion(!0,"draft")),m?(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.draftId=l,a&&(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.newRLDraftId=o)):(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails={},EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.draftId=l,a&&(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.newRLDraftId=o)),EmailComposeUtil.setEditorFocus()}),e)}},EmailCompose.viewDraftMail=function(e){let i=e.attachments?e.attachments.length:0;var t={};t.subject=e.subject,t.sent_time=e.created_time;var a={};a.email=e.from,t.from=a;var l=e.to;t.to=l,t.cc=e.cc,t.bcc=e.bcc,t.hasAttach=!!i,t.message_id=e.id;var o=e.$sharing_permission?e.$sharing_permission:"full_access";t.sharing_permission=o;var n=[],s={type:"draft"};n[0]=s,t.status=n;let m=[];m[0]=t;let r=[];i>0&&e.attachments.forEach((function(e){let i={};i.id=e.id,i.name=e.file_name,i.size=e.file_size,r.push(i)}));var d=[],c={attachments:[]};c.subject=e.subject,c.mail_format="html",c.content=e.content,c.from=a,c.to=l,c.cc=e.cc,c.bcc=e.bcc,c.attachments=r,d[0]=c;let p=Lyte.registeredMixins["crm-emailconversation-view-mixin"].getOfffsetHeight(),E={conversationList:Array.from(m),moduleInfo:{},mailType:mailType,sentOrReceived:"Draft",offsetHeight:p,mailArray:d,processedMails:[],dealData:{},selectedCount:[0],mailSource:"draft",dealArray:[],messageId:"",subjectText:t.subject};Lyte.registeredMixins["crm-emailconversation-view-mixin"].postProcessEmailThreadView(E)},EmailCompose.paramChangesForV3=function(e){return e&&(e.bcc&&(e.bcc_address=e.bcc),e.cc&&(e.cc_address=e.cc),e.to&&(e.to_address=e.to),e.reply_to&&(e.replyto_address=e.reply_to),e.from&&(e.from_address=e.from)),e},EmailCompose.launchReplyMail=function(e,i,t){if(CrmEmailInitialize.ComposeMailData)EmailCompose.TriggerLaunchReplyMail(e,i,t);else{var a={"X-ZOHO-SERVICE":"crm","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid};(new crmRequestPool).initiate({url:"/crm/v2/__internal/__emailcompose_meta",type:"GET",headers:a,content:"application/json",success:function(a){CrmEmailInitialize.ComposeMailData=a.data[0],CrmEmailInitialize.ComposeMailData.showSwitchMessage&&_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.email.compose.old.eol.message"),ltPropType:"warning",ltPropDuration:"6000"}}),CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isComposeAutoSuggestionEnabled=CrmEmailInitialize.ComposeMailData.features_available.auto_suggestion),EmailCompose.TriggerLaunchReplyMail(e,i,t)},error:function(){crmui.showMsgBand("error",I18n.getMsg("error.unexpected"),3e3)}})}},EmailCompose.TriggerLaunchReplyMail=function(e,i,t){EmailComposeUtil&&(EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData),EmailComposeUtil&&EmailComposeUtil.ComposeMailData&&EmailComposeUtil.ComposeMailData.default_from&&(e.from_address=EmailComposeUtil.ComposeMailData.default_from),i&&t?EmailComposeUtil.validateMailSendingPermission(i,t,e,EmailCompose.populateReplyMailDetails):EmailCompose.populateReplyMailDetails(e,i,t),EmailSendingUtil.SwitchedFromOldToNew=!1,setTimeout((function(){EmailSendingUtil.SwitchedFromOldToNew=!1}),1500)},EmailCompose.populateReplyMailDetails=function(e,i,t){"Contacts"===i&&(EmailSendingUtil.optOutModule=i),EmailComposeUtil.isReplyMail=!0,EmailComposeUtil.closeViewMailPopUp(),EmailCompose.populateComposeData=e,EmailCompose.launchEmailCompose((function(e){var t=EmailCompose.populateComposeData,a=t?t.data[0].attachments:{},l=t?t.data[0].linked_record:void 0;if(l){EmailComposeUtil.linkToModuleSelected[EmailComposeUtil.CURRENT_TAB]=!0;var o={module:l.module.api_name,id:l.id,name:l.name};if(EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB]=o,"Contacts"===i){var n=$L("crm-link-to-module").get(0).component;n.methods.populateLinkToModuleData.call(n)}}var s=a?EmailUtil.formatAttachment(a):[];t.isLoadtemplate=e,EmailCompose.populateEmailContentOnReply(t),EmailComposeUtil.putAttachmentsOnEditor(s),EmailComposeUtil.forwardAttachmentDetails=s,EmailCompose.populateComposeData={},EmailComposeUtil.setEditorFocus()})),EmailComposeUtil.setEntityDetails(i,t)},EmailCompose.postEditorLoad=function(e){try{var i=EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].zEditor.editorDiv,t=Crm.userDetails.LOCALE?Crm.userDetails.LOCALE:"en-US";t=Lyte.registeredMixins.crm_zia_writing_assistant_mixin.getCrmVsBluePencilLanguages(t),EmailUtil&&EmailUtil.tempSignature&&EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]&&(EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]="");var a=editor.zEditor.activeTabElem.querySelector("#spellcheck_li");EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].spellCheck.isSpellCheckEnabled=!0,a.children[0].classList.add("selectedLi")}catch(e){murphy.error(e)}$L("#etComposePanel").trapFocus();var l=$L("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val();if(l||EmailCompose.isDraftOpen||$L("#insertOptions_"+EmailComposeUtil.CURRENT_TAB).addClass("hide"),EmailCompose.action&&(EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]=EmailCompose.action),Crm.userDetails.IS_SMART_PROMPT_AVAILABLE){var o=[],n=[];o=(o=(o=o.concat(networkUtils.returnDependencyFiles(["crm-zia-smart-prompt.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT))).concat(networkUtils.returnDependencyFiles(["crm-ui-loaders.js","crm-zia-smart-prompt.js","crm-zia-smart-prompt-store.js","note_model.js","lyte-draggable.js","lyte-resize.js"],ResourceConstants.CRMClient))).concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("SmartPrompt")],ResourceConstants.CRM));n=n.concat(o);Lyte.injectResources(n,void 0,(function(){Lyte.Component.render("crm-zia-smart-prompt-icon",{iconType:"link",focusedArea:"mail",class:"dIB zia_smartprompt_email",id:"mailSmartPromptIcon"},"#emcSmartPromtBtn_"+EmailComposeUtil.CURRENT_TAB)}))}if(EmailCompose.action="",$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("open"),$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("close"),$(".dv_consent_status_lists").hide(),EmailComposeUtil.ComposeMailData&&EmailComposeUtil.ComposeMailData.default_from&&("compose"===EmailSendingUtil.action||"reply"===EmailSendingUtil.action)){var s=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).find("[value='"+$.escapeSelector(EmailComposeUtil.ComposeMailData.default_from.email)+"']");"org_email"===EmailComposeUtil.ComposeMailData.default_from.type?(s&&s.length>1&&(s[0].value=EmailComposeUtil.ComposeMailData.default_from.email+EmailComposeUtil.CURRENT_TAB),EmailComposeUtil.setFromAddress(EmailComposeUtil.ComposeMailData.default_from.email,!0),s&&s.length>1&&(s[0].value=EmailComposeUtil.ComposeMailData.default_from.email),EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0):(s&&s.length>1&&s[1]&&(s[1].value=EmailComposeUtil.ComposeMailData.default_from.email+EmailComposeUtil.CURRENT_TAB),EmailComposeUtil.setFromAddress(EmailComposeUtil.ComposeMailData.default_from.email),s&&s.length>1&&s[1]&&(s[1].value=EmailComposeUtil.ComposeMailData.default_from.email),EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1)}EmailSendingUtil.switchedToOldWin=!1,EmailComposeUtil.isCloseAll=!1;var m=CrmEmailInitialize.ComposeMailData.from_address;if(m&&1===m.length?$("#fromDetails_"+EmailComposeUtil.CURRENT_TAB).addClass("ecwSingleUserList"):$("#fromDetails_"+EmailComposeUtil.CURRENT_TAB).removeClass("ecwSingleUserList"),EmailSendingUtil.SwitchedFromOldToNew){if(EmailComposeUtil.setFromAddress(EmailSendingUtil.fromAddr),EmailComposeUtil.setReplyToAddress(EmailSendingUtil.replyTo),EmailActionHandling.isSwitchSave=!0,EmailSendingUtil.oldScheduleText){var r=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB);r.removeClass("hide");var d=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB);d.prop("checked",!0),r.find("label")[0].innerText=EmailSendingUtil.oldScheduleText,d.val(EmailSendingUtil.oldScheduleval),$("#emcSendBtn").addClass("hide"),$("#emcScheduleMailBtn").removeClass("hide")}crmui.showMsgBand("success",I18n.getMsg("crm.email.compose.switchedToNew"),3e3)}else EmailCompose.isDraftOpen||"999"===EmailComposeUtil.CURRENT_TAB||EmailCompose.openingScheduleMail||EmailComposeUtil.isReplyMail||EmailSendingUtil.SwitchedFromOldToNew||EmailUtil.setSignature(EmailComposeUtil.ComposeMailData.default_from.email);if(EmailLaunchUtil.privacyPolicyDetails&&EmailLaunchUtil.privacyPolicyDetails.isConsentEmail?(EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]=!0,EmailLaunchUtil.privacyPolicyDetails.isConsentEmail=!1):EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]=!1,EmailLaunchUtil.privacyPolicyDetails&&EmailLaunchUtil.privacyPolicyDetails.dataReqObj){EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]=EmailLaunchUtil.privacyPolicyDetails.dataReqObj;var c=EmailComposeUtil.getFormattedAttachmentDetails(EmailLaunchUtil.privacyPolicyDetails.dataReqObj.id,I18n.getMsg("crm.mail.label.DataRequest")+"_"+$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val()+".csv");c.EDITOR_ATTACH=1,editor.zEditor.displayAttachment(c),EmailLaunchUtil.privacyPolicyDetails.dataReqObj=""}else EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]="";EmailLaunchUtil.showHideFromRecord(),!EmailCompose.openingScheduleMail&&EmailComposeUtil.isReplyMail?EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]=!0:EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]=!1,EmailCompose.optOutModule[EmailComposeUtil.CURRENT_TAB]=EmailSendingUtil.optOutModule?EmailSendingUtil.optOutModule:"",EmailCompose.contactId[EmailComposeUtil.CURRENT_TAB]=EmailSendingUtil.contactId?EmailSendingUtil.contactId:"",EmailSendingUtil.optOutModule="",EmailSendingUtil.contactId="",EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB]=[],EmailCompose.openingScheduleMail=!1,EmailComposeUtil.editorLoaded=!0,EmailComposeUtil.resourcesLoaded=!0,EmailCompose.autoComplete(),EmailComposeUtil.initiateDraft(),EmailUtil.initializePlainTextEditor(),EmailComposeUtil.bindSalesIqLink(),EmailComposeUtil.doBindings();try{EmailSendingUtil.postEditorCallBack&&(EmailSendingUtil.postEditorCallBack(),EmailSendingUtil.postEditorCallBack="")}catch(e){murphy.error(e)}editor.zEditor.editorDiv.onclick=function(){var e=EmailComposeUtil.getAutoCompleteSuggestedElem();e&&(e.parentElement.removeChild(e),editor.zEditor.enableTab=!1)},EmailComposeUtil.setInitialComposeWindowFocus(),EmailComposeUtil.displayComposeMetaFields(),editor.zEditor.editorDiv.focus();var p=EmailSendingUtil.isLoadTemplate;EmailSendingUtil.templateData&&EmailSendingUtil.isLoadTemplate&&(EmailSendingUtil.populateEditorWithTemplate(EmailSendingUtil.templateData,EmailSendingUtil.module),EmailComposeUtil.setSubject(EmailSendingUtil.templateData.subject),EmailSendingUtil.isLoadTemplate=!1,EmailSendingUtil.templateData=""),EmailSendingUtil.pdfLayoutDetails&&(EmailCompose.loadInventoryAttach(),EmailSendingUtil.pdfLayoutDetails="");var E=editor.zEditor.saveCaretPostion();e?e(p):EmailComposeUtil.editorContent&&editor.setContent(EmailComposeUtil.editorContent),EmailSendingUtil.switchPlaineditor&&(editor.zEditor.switchToPlainEditor(),EmailSendingUtil.switchPlaineditor=!1),EmailLaunchUtil.tempSource&&EmailActionHandling.source.set(EmailComposeUtil.CURRENT_TAB,EmailLaunchUtil.tempSource),$(".etComposeHeader:not(#ecw_tab_"+EmailComposeUtil.CURRENT_TAB+")").removeClass("etComposeHeader"),E.collapse=!0,editor.zEditor.restoreCaretPosition(E),EmailComposeUtil.setInitialComposeWindowFocus(),"999"!==EmailComposeUtil.CURRENT_TAB&&EmailComposeUtil.setDefaultValues(),EmailCompose.isDraftOpen=!1,EmailComposeUtil.isReplyMail=!1,setTimeout(EmailUtil.saveTempDraftDetails,1e3),setTimeout((function(){EmailSendingUtil.removeFocus?(editor.zEditor.editorDiv.blur(),EmailSendingUtil.removeFocus=!1):EmailComposeUtil.setInitialComposeWindowFocus()}),500),editor.zEditor.z_doc.getElementById("editorDiv").style.outline="none",$(".composeContentPanel").not(".hide").find(".select2-selection__rendered").addClass("activeFromSpan"),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,setTimeout((function(){EmailSendingUtil.isSendMailActionCalled=!1}),3e3),commonUtils.showHideLoadingDiv(!1),$("[isActiveComposeTab]").attr("isActiveComposeTab",!1),$("#ecw_tab_"+EmailComposeUtil.CURRENT_TAB).attr("isActiveComposeTab",!0),EmailComposeUtil.tabIdVsAddingAttachmentCount.set(EmailComposeUtil.CURRENT_TAB,-1),EmailComposeUtil.initialContent[EmailComposeUtil.CURRENT_TAB]=editor.getContent();var u=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB);try{void 0!==EmailComposeUtil&&EmailComposeUtil.forwardAttachmentDetails&&EmailComposeUtil.forwardAttachmentDetails.length>0&&EmailActionHandling.saveDraftOnAttachmentAddition(EmailComposeUtil.forwardAttachmentDetails)}catch(e){murphy.error(e)}Lyte.registeredMixins["crm-email-auth-util"].getDomainsAuthNPolicy(u,u.val(),"email_compose");var C=$L("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();if(l){var g=Object.keys(moduleApiMapping).filter((e=>moduleApiMapping[e]===l));if(g&&g.length>0&&EmailComposeUtil.isCustomModule(g[0])&&(l=g[0]),"Sales_Orders"===l)var U="SalesOrders";else if("Purchase_Orders"===l)U="PurchaseOrders";else U=l;store.findRecord("module",moduleRecordMapping[U].id).then((function(e){try{var a=moduleRecordMapping[$L("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()].access_type;Lyte.Component.render("crm-zia-writing-assistant-icon",{iconType:"link",access_type:a,focusedArea:"mail",id:"mailWritingAssistantIcon",editor:i,language:t,parentId:"#emcWritingAssistant_"+EmailComposeUtil.CURRENT_TAB},"#emcWritingAssistant_"+EmailComposeUtil.CURRENT_TAB)}catch(e){murphy.error(e)}e&&e.length>0&&store.findRecord(moduleRecordMapping[U].id,C).then((function(e){e&&e.length}))}))}var h=EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].zEditor.editorDiv.innerHTML,v=$L(".translateClass_"+EmailComposeUtil.CURRENT_TAB);(h=EmailCompose.extractHTMLTags(h,!0).trim())&&""!==h?v.addClass("zia_highlight1"):v.addClass("disabled eventNone");var f=Lyte.Router.getRouteInstance().transition.info.dynamicParams;if("Accounts"===l||"Accounts"===f[0]){var T=C;l!==f[0]&&(T=f[1]),store.findAll("dummy",void 0,!1,!1,{url:"/crm/v3/Accounts/"+T+"/Contacts",method:"GET"}).then((function(e){e&&e.data&&e.data.length>0&&(EmailComposeUtil.relatedContactEmails[EmailComposeUtil.CURRENT_TAB]=e.data)})),moduleRecordMapping.Contacts.fields||store.findAll("dummy",void 0,!1,!1,{url:"/crm/v4/settings/fields?module=Contacts",method:"GET"}).then((function(e){e&&e.fields&&e.fields.length>0&&store.pushPayload("module",{id:moduleRecordMapping.Contacts.id,fields:e.fields})}))}"Deals"!==l&&"Potentials"!==l||store.findAll("emails_rl_user",void 0,!1,!1,{module:"Potentials",entityId:C,action:"getContactRoles"}).then((function(e){e&&e.data&&e.data.length>0&&(EmailComposeUtil.relatedContactEmails[EmailComposeUtil.CURRENT_TAB]=e.data)}))},EmailCompose.insertWord=!0,EmailCompose.suggestedString,EmailCompose.enableTab,EmailCompose.partOfTheSuggestedWordTyped,EmailCompose.responseAwaiting=!1,EmailCompose.TypedTextBeforeRecievingResponse="",EmailCompose.autoComplete=function(){var e=editor.zEditor.z_doc.getElementById("editorDiv");e.setAttribute("contenteditable","true");var i=document.getElementById("etnSub_"+EmailComposeUtil.CURRENT_TAB);i.addEventListener("keyup",(function(){Lyte.registeredMixins["crm-email-summary-mixin"]&&Lyte.registeredMixins["crm-email-summary-mixin"].subjectBackup()})),i.addEventListener("paste",(function(){Lyte.registeredMixins["crm-email-summary-mixin"]&&Lyte.registeredMixins["crm-email-summary-mixin"].subjectBackup()})),e.addEventListener("paste",(function(e){Lyte.registeredMixins["crm-email-summary-mixin"]&&Lyte.registeredMixins["crm-email-summary-mixin"].contentBackup(editor);var i=e.clipboardData.getData("text"),t=EmailCompose.removeSignature(i);t=EmailCompose.extractHTMLTags(t),(t=EmailCompose.removeSpaces(t)).length>=EmailCompose.minEmailBodyLength&&0===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]&&(i=EmailCompose.removeSignature(i),i=EmailCompose.extractHTMLTags(i),EmailCompose["parsedContent_"+EmailComposeUtil.CURRENT_TAB]=i.trim().substring(0,2500),EmailCompose.getSuggestion(!1,"paste"))})),e.addEventListener("keyup",(function(){Lyte.registeredMixins["crm-email-summary-mixin"]&&Lyte.registeredMixins["crm-email-summary-mixin"].contentBackup(editor)})),e.addEventListener("keydown",(function(e){let i=editor.getEditorMode(),t="";"plainEditor"===i?t=editor.getContent():"richEditor"===i&&(t=editor.zEditor.editorDiv.innerHTML);var a=EmailCompose.removeSignature(t);a=EmailCompose.extractHTMLTags(a),a=EmailCompose.decodeHTML(a),EmailCompose.removeSpaces(a).length>=EmailCompose.minEmailBodyLength&&0===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]&&EmailCompose.getSuggestion(!1,"keydown");var l=e.keyCode,o=EmailCompose["parsedContent_"+EmailComposeUtil.CURRENT_TAB];""!==(o=EmailCompose.removeSpaces(o))&&o.length>=EmailCompose.minEmailBodyLength&&o.length!==a.length&&""!==EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]&&(8===l||46===l||91===l)&&EmailCompose.hideAllSuggestions();var n=editor.zEditor,s=n.z_doc;if($("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val()&&setTimeout(EmailComposeUtil.hideTemplateNameHolderInContentChanged,1e3),EmailComposeUtil.isAutoCorrectionEnabled){var m;if(!n.enableTab&&9===e.keyCode){var r=document.querySelector(".mL8.etAttachmentPopupIcnContainer");r&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),r.focus())}if(n.enableTab){if(m=s.getElementsByClassName("suggestedWord")[0],9===e.keyCode||39===e.keyCode){e.preventDefault(),e.stopPropagation();var d=s.getSelection(),c=d.getRangeAt(0);return setTimeout((function(){var e=editor.zEditor.z_doc,i=m?m.innerText:"",t=e.createTextNode(i);c.insertNode(t),EmailCompose.insertWord=!0;var a=e.getElementsByClassName("suggestedWord")[0];a&&a.innerText&&(Crm.client_tracking("Compose Auto Complete"),"word"===EmailCompose.autoCompleteData?Crm.client_tracking("Email Auto Complete - words picked"):"sentence"===EmailCompose.autoCompleteData&&Crm.client_tracking("Email Auto Complete - sentence picked")),EmailComposeUtil.removeSuggestedElement(a),c.setStart(d.anchorNode.nextSibling,d.anchorNode.nextSibling.length),c.collapse(!0),d.removeAllRanges(),d.addRange(c),n.enableTab=!1,EmailCompose.suggestedString=""}),1),!1}EmailCompose.autoCompleteData="";var p=EmailCompose.suggestedString,E=e.keyCode;l=e.key;if(EmailComposeUtil.isValidWordKey(E))if(EmailCompose.partOfTheSuggestedWordTyped+=l,p===EmailCompose.partOfTheSuggestedWordTyped)m&&EmailComposeUtil.removeSuggestedElement(m),n.enableTab=!1,EmailCompose.suggestedString="";else if(p.startsWith(EmailCompose.partOfTheSuggestedWordTyped)){var u=EmailCompose.partOfTheSuggestedWordTyped.length,C=p.slice(u);if(m&&(m.innerText=C)," "===e.key||"Space"===e.key||32===e.keyCode)return}else m&&EmailComposeUtil.removeSuggestedElement(m),n.enableTab=!1,EmailCompose.suggestedString="";else if("Backspace"===e.key){if(0===EmailCompose.partOfTheSuggestedWordTyped.length)m&&EmailComposeUtil.removeSuggestedElement(m),n.enableTab=!1,EmailCompose.suggestedString="";else if(EmailCompose.partOfTheSuggestedWordTyped=EmailCompose.partOfTheSuggestedWordTyped.slice(0,-1),p.startsWith(EmailCompose.partOfTheSuggestedWordTyped)){u=EmailCompose.partOfTheSuggestedWordTyped.length,C=p.slice(u);m&&(m.innerText=C,m.hidden=!1)}}else EmailComposeUtil.isInvalidKey(E)&&(m&&EmailComposeUtil.removeSuggestedElement(m),n.enableTab=!1,EmailCompose.suggestedString="")}else if(EmailCompose.responseAwaiting){E=e.keyCode,l=e.key;EmailComposeUtil.isValidWordKey(E)&&(EmailCompose.TypedTextBeforeRecievingResponse+=l)}if(!(EmailCompose.responseAwaiting||Crm.userDetails.DEPLOYMENT.includes("UBI")||Crm.userDetails.DEPLOYMENT.includes("China")||Crm.userDetails.DEPLOYMENT.includes("JP")||" "!==e.key&&"Space"!==e.key&&32!==e.keyCode)){var g=EmailComposeUtil.getTextUptoCursorPos();if(!EmailComposeUtil.isValidInputForAutoComplete(g))return;var U=$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").eq(0).attr("email"),h=U||"",v=$("#select2-etSenderList_"+EmailComposeUtil.CURRENT_TAB+"-container").text(),f=v||"",T={},S=(new Date).getTime();S=parseInt(S);var _=parseInt(S/1e3);T.input=g.trim(),T.to_address=h,T.from_address=f,T.timestamp=_+"",T=JSON.stringify(T),EmailCompose.responseAwaiting=!0;var A=s.createElement("span");A.classList.add("suggestedWord"),A.setAttribute("style","color:#ccc;"),A.setAttribute("data-zbluepencil-ignore",!0),EmailCompose.autoCompleteReqPool=new crmRequestPool,EmailCompose.autoCompleteReqPool.initiate({url:"/crm/zia/text/api/v2/autocomplete.do",type:"POST",data:T,xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},dataType:"json",content:"application/json; charset=UTF-8",success:function(i){if((i="string"==typeof i?JSON.parse(i):i)&&i.statusCode&&200===i.statusCode&&Crm.client_tracking("Compose Auto Complete - 200"),!i)return!1;if(i.sentence||i.word){var t=i.sentence?i.sentence:i.word;if(i.sentence&&i.word?(Crm.client_tracking("Compose Auto Complete - sentence"),EmailCompose.autoCompleteData="sentence"):(Crm.client_tracking("Compose Auto Complete - word"),EmailCompose.autoCompleteData="word"),s.getElementsByClassName("suggestedWord")[0])return!1;if(EmailCompose.insertWord){e.preventDefault(),e.stopPropagation();var a=s.getSelection(),l=a.getRangeAt(0);if(EmailCompose.responseAwaiting=!1,EmailCompose.partOfTheSuggestedWordTyped=EmailCompose.TypedTextBeforeRecievingResponse,EmailCompose.TypedTextBeforeRecievingResponse="",!t.startsWith(EmailCompose.partOfTheSuggestedWordTyped))return EmailCompose.partOfTheSuggestedWordTyped&&(Crm.client_tracking("Compose Auto Complete Slowness"),i&&i.sentence?Crm.client_tracking("Compose Auto Complete Slowness - sentence"):i&&i.word&&Crm.client_tracking("Compose Auto Complete Slowness - word")),!1;var o=EmailCompose.partOfTheSuggestedWordTyped.length,m=t.slice(o);return EmailCompose.suggestedString=t,n.enableTab=!0,A.innerText=m,l.insertNode(A),l.setStart(a.anchorNode,a.anchorNode.length),l.collapse(!0),a.removeAllRanges(),a.addRange(l),!1}}},complete:function(){EmailCompose.responseAwaiting=!1,EmailCompose.TypedTextBeforeRecievingResponse=""}})}}}))},EmailCompose.populateComposeMailData=function(e){var i=e.__email_drafts[0],t=i.subject?i.subject:"",a=i.from_address,l=i.content?i.content:"";"string"==typeof a&&a.indexOf("{")>-1&&(a=JSON.parse(a).email);var o=i.replyto_address;if(EmailComposeUtil.setReplyToAddress(o),EmailComposeUtil.setFromAddress(a),EmailComposeUtil.populateEmailAddress(i,"to_address"),EmailComposeUtil.populateEmailAddress(i,"cc_address"),EmailComposeUtil.populateEmailAddress(i,"bcc_address"),i.schedule_details){var n=i.schedule_details;EmailComposeUtil.setScheduleTime(n)}if(i.template){var s=i.template.id;EmailComposeUtil.populateWithTemplate(s,t,l)}else EmailComposeUtil.setSubject(t),l&&("undefined"!=typeof editor?(editor.setContent(l),EmailComposeUtil.editorContent=l):EmailComposeUtil.editorContent=l);if(i[EmailComposeUtil.INVENTORY_DETAILS]){var m=i[EmailComposeUtil.INVENTORY_DETAILS];if(m)if(EmailUtil.setInventoryDetails(m),!EmailComposeUtil.isInventoryModule()){var r=m.record.id;EmailComposeUtil.setEntityDetailsEquivalentToInventoryModule(r,m)}}EmailComposeUtil.putAttachmentsOnEditor(i.attachments)},EmailCompose.populateEmailContentOnReply=function(e){if(e){var i=e.data[0],t=i.subject,a=i.from,l=i.content,o=i.enc_msgid,n=i.msgid,s=i.enc_thread_id,m=$("#sendMailType_"+EmailComposeUtil.CURRENT_TAB);if("string"==typeof a&&a.indexOf("{")>-1&&(a=JSON.parse(a).email),a&&(EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1),i.sent_time?(EmailComposeUtil.setFromAddress(a.email),EmailSendingUtil.OrgEmailArray.contains(a.email)&&EmailSendingUtil.other_emails_array&&!EmailSendingUtil.other_emails_array.contains(a.email)&&(EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0)):(a=EmailComposeUtil.ComposeMailData.default_from.email,EmailComposeUtil.setFromAddress(a),EmailSendingUtil.OrgEmailArray.contains(a)&&EmailSendingUtil.other_emails_array&&!EmailSendingUtil.other_emails_array.contains(a)&&(EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0)),EmailSendingUtil.SwitchedFromOldToNew&&EmailSendingUtil.fromAddr&&EmailComposeUtil.setFromAddress(EmailSendingUtil.fromAddr),i.from_address&&"CScript"===i.source&&EmailComposeUtil.setFromAddress(i.from_address),t&&EmailComposeUtil.setSubject(t),EmailComposeUtil.populateEmailAddress(i,"to"),EmailComposeUtil.populateEmailAddress(i,"cc"),EmailComposeUtil.populateEmailAddress(i,"bcc"),i.sent_time){var r=i.sent_time;EmailComposeUtil.setScheduleTime(r,!0),m.val(EmailComposeUtil.EDIT_IN_COMPOSE)}else if(l){var d=l.indexOf("<div data-zbluepencil-ignore=true id=ecw_signature>");if(d<20&&d>-1){var c=$(l),p=$("<p>").append(c),E=p.find("#ecw_signature")[0];E&&E.remove();var u=p.html();u="<br><br><div data-zbluepencil-ignore=true id=ecw_signature></div>"+u,EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]=u}else"CScript"===i.source?l+="<br><div data-zbluepencil-ignore=true id=ecw_signature></div>":l="<br><br><div data-zbluepencil-ignore=true id=ecw_signature></div>"+l,EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]=l;0===EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB].indexOf("<br><br><br><br>")&&EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB].replace("<br><br>","")}else l="<br><br><div data-zbluepencil-ignore=true id=ecw_signature></div>";var C=$("#msgId_"+EmailComposeUtil.CURRENT_TAB),g=$("#enc_msgId_"+EmailComposeUtil.CURRENT_TAB),U=$("#enc_threadId_"+EmailComposeUtil.CURRENT_TAB);if(C.val(n),g.val(o),U.val(s),l&&("undefined"!=typeof editor?(editor.setContent(l),EmailComposeUtil.editorContent=l):EmailComposeUtil.editorContent=l,i.sent_time||EmailSendingUtil.SwitchedFromOldToNew||"CScript"===i.source&&e.isLoadtemplate||EmailUtil.setSignature($("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val())),i&&i.to&&null!=i.to)if(Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].loadEmotionBand(i.emotion,i.to[0].user_name);else{var h=networkUtils.returnDependencyFiles(["email-emotions.js","zia-notification-settings.js"],ResourceConstants.CRMClient);Lyte.injectResources(h,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].loadEmotionBand(i.emotion,i.to[0].user_name)}))}}},EmailCompose.hideGSearch=function(){var e=$L("#primaryGsearch")[0];void 0!==e&&e.ltProp("overlayClose",!0)},EmailCompose.SendMailEvent=function(e,i,t,a){if(EmailComposeUtil.tabIdVsModuleName[EmailComposeUtil.getNextTabId()]=e,i)if(CrmEmailInitialize.ComposeMailData)EmailCompose.TriggerMailEvent(e,i,t,a),void 0!==EmailSendingUtil.callbackFn&&EmailSendingUtil.callbackFn();else{var l={"X-ZOHO-SERVICE":"crm","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid};(new crmRequestPool).initiate({url:"/crm/v2/__internal/__emailcompose_meta",type:"GET",headers:l,content:"application/json",success:function(l){CrmEmailInitialize.ComposeMailData=l.data[0],CrmEmailInitialize.ComposeMailData.showSwitchMessage&&_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.email.compose.old.eol.message"),ltPropType:"warning",ltPropDuration:"6000"}}),CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isComposeAutoSuggestionEnabled=CrmEmailInitialize.ComposeMailData.features_available.auto_suggestion),EmailCompose.TriggerMailEvent(e,i,t,a),void 0!==EmailSendingUtil.callbackFn&&EmailSendingUtil.callbackFn()},error:function(){crmui.showMsgBand("error",I18n.getMsg("error.unexpected"),3e3)}})}else renderingUtils.showCustomAlert("Not an Entity Window... will be handled soon.")},EmailCompose.TriggerMailEvent=function(e,i,t,a){if(hideMenu(),EmailSendingUtil.isEntityWindow=!0,EmailSendingUtil.action="compose",EmailComposeUtil.setMessagesForAlerts(),EmailComposeUtil.resourcesLoaded)EmailCompose.launchEmailComposeEvent(a),EmailCompose.disableToaddress?EmailCompose.disableToaddress=!1:EmailCompose.setEntityToAddress(e,i,t);else{var l=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor")];Lyte.injectResources(networkUtils.returnDependencyFiles(l,ResourceConstants.CRM),void 0,(function(){EmailCompose.launchEmailComposeEvent(a),EmailCompose.disableToaddress?EmailCompose.disableToaddress=!1:EmailCompose.setEntityToAddress(e,i,t)}))}},EmailCompose.launchEmailComposeEvent=function(e){e?EmailCompose.launchEmailCompose(e):EmailCompose.launchEmailCompose()},EmailCompose.sendMailEventForInventoryModule=function(e,i,t){var a,l,o,n,s,m;EmailComposeUtil.pdfLayoutDetails={},a=t.layout_id,l=t.layout_name,o=t.paperType,n=t.viewType,s=t.flag,m=t.pdfVersion,s="string"==typeof s&&"true"===s,EmailComposeUtil.pdfLayoutDetails.layoutId=a,EmailComposeUtil.pdfLayoutDetails.layoutName=l,EmailComposeUtil.pdfLayoutDetails.paperType=o,EmailComposeUtil.pdfLayoutDetails.viewType=n,EmailComposeUtil.pdfLayoutDetails.isMailToVendor=s,EmailComposeUtil.pdfLayoutDetails.pdfVersion=m;EmailLaunchUtil.SendMailEvent(e,i,"",(function(){var e=EmailComposeUtil.pdfLayoutDetails.layoutId,i=EmailComposeUtil.pdfLayoutDetails.layoutName,t=EmailComposeUtil.pdfLayoutDetails.paperType,a=EmailComposeUtil.pdfLayoutDetails.viewType,l=EmailComposeUtil.pdfLayoutDetails.subject,o=EmailComposeUtil.pdfLayoutDetails.pdfVersion;EmailComposeUtil.pdfLayoutDetails={},t="default"===t?"A4":t,(i+=".pdf").includes(".pdf")||(i+=".pdf");var n=EmailComposeUtil.getFormattedAttachmentDetails(e,i);n.EDITOR_ATTACH=1,editor.zEditor.displayAttachment(n),$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(e),$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val(i),$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val(t),$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(a),$("#inventoryMailFlag_"+EmailComposeUtil.CURRENT_TAB).val(s),$("#pdf_engine_type_"+EmailComposeUtil.CURRENT_TAB).val(o),l&&EmailComposeUtil.setSubject(l),EmailUtil.setSignature(EmailComposeUtil.ComposeMailData.default_from.email),editor.setContent(EmailComposeUtil.editorContent)}))},EmailCompose.editScheduleMail=function(e,i,t){var a=Crm.userDetails.USER_ID,l="editInCompose",o="/crm/v2/__internal/"+(e=EmailComposeUtil.getApiNameForModule(e))+"/"+i+"/Emails/"+t+"/actions/"+l;EmailComposeUtil.isCustomModule(e)&&(o="/crm/v2/__internal/"+Crm.userDetails.MODULE_LIST[e].api_name+"/"+i+"/Emails/"+t+"/actions/"+l);var n="user_id="+a+"&mail_type=ALLUSERSMAILS&sent=true";(new crmRequestPool).initiate({action:o,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},data:n,type:"GET",success:function(t){if(t.data&&t.data[0]&&t.data[0].enc_msgid){EmailCompose.openingScheduleMail=!0;var a="/crm/email/v2/"+e+"/"+i+"/Emails?message_id="+t.data[0].enc_msgid+"composescheduledelete",o={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken};(new crmRequestPool).initiate({type:"DELETE",url:a,data:{},headers:o,success:function(){EmailUtil.refreshEmailRelList()}})}EmailSendingUtil.action=l,EmailCompose.launchReplyMail(t,e,i)},error:function(){crmui.showMsgBand("error",I18n.getMsg("crm.migration.general.error"),3e3)}})},EmailCompose.etScheduleEvent=function(e,i){1===i?EmailComposeUtil.assignTimeSchedule():EmailComposeUtil.assignTimeSchedule(!0)},EmailCompose.showScheduleMailPopup=function(e){var i=$(e),t=editor.zEditor.z_doc,a=$L("#etComposePanel");t=$(t);var l=i.offset(),o=$("#etSchedulePopId");thirdPartyUtils.bindSelect2("#timeZone"),event.stopPropagation(),t.find("#attachmentDiv").addClass("emailComposeCRM"),o.removeClass("hide");var n=o.innerHeight(),s=o.innerWidth(),m=l.left-s/2+35,r=l.top-n-15;if(a.hasClass("ecwMaximizedState")?(m-=50,o.addClass("ecwScheduleMax")):o.removeClass("ecwScheduleMax"),Crm.userDetails.RTL_ENABLED)if(m<0){m*=-1;var d=a.offset();a[0].classList.contains("ecwMaximizedState")&&o.addClass("ecwSchedulePopFix"),m>d.left?o.addClass("ecwSchedulePopFixMin"):(o[0].classList.contains("ecwSchedulePopFixMin"),o.removeClass("ecwSchedulePopFixMin"))}else o[0].classList.contains("ecwSchedulePopFix")?o.removeClass("ecwSchedulePopFix"):o[0].classList.contains("ecwSchedulePopFixMin")&&o.removeClass("ecwSchedulePopFixMin");o.css({left:m,top:r}),$("body").addClass("ecwScheduleBodyOH"),$("#timeZone").on("select2:open",(function(){$(".select2-dropdown").addClass("ecwTimeZone")})),o.click((function(e){e.stopPropagation(),$("#calenDiv").hide()}))},EmailCompose.translate=function(){try{if($L(".translateClass_"+EmailComposeUtil.CURRENT_TAB).addClass("hide"),$L("crm-email-summary-view")[EmailComposeUtil.CURRENT_TAB-1]){var e=$L("crm-email-summary-view")[EmailComposeUtil.CURRENT_TAB-1];if(e&&e.component){var i=e.component.getData("actualSubjectBackup");Lyte.registeredMixins["crm-email-summary-mixin"].initMethod(e.component,editor.getContent(),EmailComposeUtil.CURRENT_TAB,i)}}else Lyte.Component.render("crm-email-summary-view",{disableDropdown:!0,isTranslation:!0,tabId:EmailComposeUtil.CURRENT_TAB},"#translate_"+EmailComposeUtil.CURRENT_TAB)}catch(e){throw new Error(e)}},EmailCompose.etShowSchedule=function(e){EmailComposeUtil.closeOtherPopUps();var i=$("#ecUpComing"),t=i.is(":checked"),a=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,a,!1),t&&(i.prop("checked",t),$("#timeZone").parent().hide()),EmailCompose.showScheduleMailPopup(e),EmailCompose.initializeHideSchedulePop();var l=$("#startDate");$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB).val(l.val()),EmailSendingUtil.timeInit(),$(window).resize((function(){var e=$("#etSchedulePopId"),i=$("#ecAttachmentsOption_ecw"),t=$("#attachmentDIV"),a=i.offset(),l=a.left,o=a.top,n=t.innerHeight();e.is(":visible")&&e.addClass("hide"),t.css({top:o-n,left:l})}))},EmailCompose.resetSchedulePopupPosition=function(){var e=$L("#etComposePanel"),i=$("#etShowSchedule_"+EmailComposeUtil.CURRENT_TAB).offset(),t=$("#etSchedulePopId"),a=t.innerHeight(),l=t.innerWidth(),o=i.left-l/2+35,n=i.top-a-15;if(e.hasClass("ecwMaximizedState")?(o-=50,t.addClass("ecwScheduleMax")):t.removeClass("ecwScheduleMax"),Crm.userDetails.RTL_ENABLED)if(o<0){o*=-1;var s=e.offset();e[0].classList.contains("ecwMaximizedState")&&t.addClass("ecwSchedulePopFix"),o>s.left?t.addClass("ecwSchedulePopFixMin"):(t[0].classList.contains("ecwSchedulePopFixMin"),t.removeClass("ecwSchedulePopFixMin"))}else t[0].classList.contains("ecwSchedulePopFix")?t.removeClass("ecwSchedulePopFix"):t[0].classList.contains("ecwSchedulePopFixMin")&&t.removeClass("ecwSchedulePopFixMin");t.css({left:o,top:n})},EmailCompose.initializeHideSchedulePop=function(){$("#z_editor").contents().find(".editorDiv").click((function(){EmailCompose.hideSchedulePop(),EmailUtil.hidecallout()})),$("#EmailComposeFreezelayer,#etComposePanel").on("click",(function(){EmailCompose.hideSchedulePop()}))},EmailCompose.hideSchedulePop=function(){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide();var e=$("#etSchedulePopId"),i=$("#calenDiv");e.addClass("hide"),$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),i.addClass("hide");var t=$("#timeZone"),a=$("#etSenderList");t.data("select2")&&t.select2("close"),a.data("select2")&&a.select2("close"),$("#sdiv").hide(),$("body").removeClass("ecwScheduleBodyOH")},EmailCompose.closeSmartPrompt=function(){if(Crm.userDetails.IS_SMART_PROMPT_AVAILABLE){var e=$L("#advancePromptModel")[0];e&&e.ltProp("show",!1)}},EmailCompose.etCloseAllTabs=function(){crmui.modalZIndex("nonLyte",$L("#etComposePanel")[0],"close"),document.querySelector("crm-besttime-new")&&Lyte.triggerEvent("bestTimeActivityListener",{type:"email"}),EmailCompose.closeSmartPrompt();for(var e=EmailComposeUtil.CURRENT_TAB,i=EmailComposeUtil.OPEN_TAB_COUNT,t=!1,a=1;a<=i;a++)if(EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB+""),EmailActionHandling.hasAnythingChanged()){t=!0;break}if(EmailComposeUtil.CURRENT_TAB=e,t)$L("#ecwCloseAllPop")[0].ltProp("show",!0);else{for(a=0;a<i;a++)EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB,!1,!0);$("#addNewSign")[0]?(EmailComposeUtil.CURRENT_TAB="999",EmailComposeUtil.TEMP_TAB="999"):(EmailComposeUtil.CURRENT_TAB=0,EmailComposeUtil.TEMP_TAB=0),EmailComposeUtil.lastDraftUpdatedTime=0}EmailCompose.popupPos={top:null,right:null,bottom:null,left:null,width:null,height:null,isDraggable:null},EmailComposeUtil.entityIdVsTabIds={},EmailComposeUtil.resetSessionStorageComposePosition(),EmailComposeUtil.resetSessionStorageDraft()},EmailCompose.currentResizePos=null,EmailCompose.maxComposeWindowWidth=document.documentElement.clientWidth,EmailCompose.maxComposeWindowHeight=document.documentElement.clientHeight,EmailCompose.popupPos={top:null,right:null,bottom:null,left:null,width:null,height:null,isDraggable:null},EmailCompose.currentWidth=function(e){return parseInt(getComputedStyle(e).width)},EmailCompose.currentHeight=function(e){return parseInt(getComputedStyle(e).height)},EmailCompose.etMinimiseCompose=function(){if(Lyte.registeredMixins.crm_zia_writing_assistant_mixin.closeZiaWritingAssistPanel(),"999"!==EmailComposeUtil.CURRENT_TAB){var e,i;document.querySelector("crm-besttime-new")&&Lyte.triggerEvent("bestTimeActivityListener",{type:"email"}),EmailCompose.closeSmartPrompt();var t=$("#etComposePanel"),a=$("#maxComposeBtn"),l=getComputedStyle(t[0]),o=$L(".editorToolDiv:visible"),n=editor?editor.zEditor:editor;a.removeClass("hide");var s=a[0].getBoundingClientRect(),m=s.x,r=s.width;t.removeClass("emailComposeNoTrans"),(u=$L("#etComposeMinMaxIcon"))&&u.hasClass("etComposeMinRestoreIcon")&&EmailComposeUtil.setComposePositionInSessionStorage(!0),t.hasClass("ecwMaximizedState")||(EmailCompose.popupPos.top=t[0].style.top,EmailCompose.popupPos.right=t[0].style.right,EmailCompose.popupPos.bottom=t[0].style.bottom,EmailCompose.popupPos.left=t[0].style.left,EmailCompose.popupPos.width=t[0].style.width,EmailCompose.popupPos.height=t[0].style.height),EmailCompose.popupPos.isDraggable=t.hasClass("draggable-element"),EmailSendingUtil.isSendMailActionCalled=!1,EmailComposeUtil.setSessionStorageDraft(void 0,EmailComposeUtil.CURRENT_TAB);var d=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB);i=parseInt(l.left),d.val()&&(EmailSendingUtil.module=d.val()),setTimeout((function(){a.addClass("enableRipple")}),700),e=m+r/2-parseInt(l.width)/2;for(var c=i;c<=e;c++)t.css({left:c+"px"});t.addClass("etMinimize"),o.length&&n.hideDD(o[0]),EmailComposeUtil.removeAutoSuggestedElement(),EmailComposeUtil.closeAllAlertPop(),EmailComposeUtil.hideAllComposeRelatedPopup(),EmailCompose.removeFreezelayer();var p=$L("#templatePreviewDIV"),E=$L(".z_freezeLayer");p&&p.length>0&&E||EmailComposeUtil.removeCustomFreezeLayer();var u;if(EmailActionHandling.saveDraftDetails(void 0,!0,(function(){$L("#ecwDraftsSuccessMsg")[0].ltProp("show",!0)})),EmailSendingUtil.composeActive=!1,EmailComposeUtil.ComposeWindowLoaded=!1,$("#ecAutoCompleteContainer").addClass("hide"),EmailComposeUtil.resetFileCheckVariableValue(),(u=$("#etComposeMinMaxIcon")).hasClass("etComposeMinRestoreIcon"))if(Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand();else{var C=networkUtils.returnDependencyFiles(["email-emotions.js","zia-notification-settings.js"],ResourceConstants.CRMClient);Lyte.injectResources(C,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand()}))}"undefined"!=typeof CrmPlusImpl&&("undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof isZohoOneUser&&"true"===isZohoOneUser)&&CrmPlusImpl.handleDraftMailIcon(!0),a.hasClass("hide")||$(".EmailComposeFreezelayer").remove(),$("#addNewSign")[0]&&($("#emailComposeEditor").attr("id","etComposePanel"),$("#composeEmailEditor").attr("id","composeEditor"),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB="999",EmailComposeUtil.activeContentId="composeContentPanel_999",EmailComposeUtil.switchToCurrentEditor("999")),EmailComposeUtil.lastDraftUpdatedTime=0;var g=document.getElementById("hideImagePopup");g&&g.click();var U=document.getElementById("hideHTMLPopup");U&&U.click();var h=document.getElementById("hideLinkeModal");h&&h.click();var v=document.getElementById("hideTablePopup");v&&v.click();var f=document.getElementById("zp_AddLinkCancel");f&&f.click()}},EmailCompose.etMaximizeCompose=function(e){EmailLaunchUtil.showHideFromRecord();var i=$("#etComposePanel"),t=$L("#etComposePanel"),a=EmailCompose.popupPos.right,l=EmailCompose.popupPos.left,o=EmailCompose.popupPos.top,n=EmailCompose.popupPos.bottom;if(e){var s,m=EmailComposeUtil.tabIdPrefix+e,r=document.getElementById(m);if(!r)return!1;if(sessionStorage&&void 0!==sessionStorage.compsoePosition&&(s=JSON.parse(sessionStorage.compsoePosition),EmailComposeUtil.setSessionComposePositionInComposePanel()),s&&"null"!==s&&!0!==s.isDefaultView)i.css({top:o&&o,right:a&&a,bottom:n&&n,left:l&&l});else if(Lyte.registeredMixins["crm-email-compose"])Lyte.registeredMixins["crm-email-compose-mixin"].etToggleMinimiseRestore(!0);else{var d=networkUtils.returnDependencyFiles(["crm-email-compose.js"],ResourceConstants.CRMClient);Lyte.injectResources(d,void 0,(function(){Lyte.registeredMixins["crm-email-compose-mixin"].etToggleMinimiseRestore(!0)}))}t.removeClass("etMinimize"),EmailComposeUtil.hideMaximizeComposeButton(),EmailSendingUtil.composeActive=!0,EmailComposeUtil.ComposeWindowLoaded=!0,EmailComposeUtil.switchToTab(r)}else t.removeClass("etMinimize"),i.hasClass("draggable-element")?(i.css({top:o&&o,right:a&&a,bottom:n&&n,left:l&&l}),setTimeout((function(){$L(i).addClass("emailComposeNoTrans")}),1e3)):(EmailCompose.showFreezelayer(),i.removeClass("emailComposeNoTrans"),i.css({left:"",top:"",right:"",bottom:"",width:"",height:""})),EmailComposeUtil.hideMaximizeComposeButton(),EmailSendingUtil.composeActive=!0,EmailComposeUtil.ComposeWindowLoaded=!0;return crmui.modalZIndex("nonLyte",t[0],"open"),EmailComposeUtil.setFileCheckVariableValue(),!0},EmailCompose.sendMail=function(e){if(EmailUtil.validateMailData()){var i=$L("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),t=!1;if(("Accounts"===i||Crm.userDetails.isEmailsForCasesModuleEnabled&&"Cases"===i)&&(t=!0),t){var a="#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB,l=$L(a).find(".selectedEmail"),o=l.attr("entityid"),n=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),s=l.attr("module"),m=l.attr("username");if(o!==n&&s&&""!==s&&o&&""!==o){var r={module:s,id:o,name:m};EmailComposeUtil.linkToModuleSelected[EmailComposeUtil.CURRENT_TAB]=!0,EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB]=r}}var d=function(){var i,t=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("data")[0].element,a={};if(a.email=t.value,a.user_name=t.getAttribute("username"),a.isOrgEmail=t.getAttribute("isOrgEmail"),!Lyte.registeredMixins["email-footer-common-utils"].checkIfFooterPreferenceViolated()){Lyte.registeredMixins["email-footer-common-utils"].checkAndRemoveFooterDiv();var l=EmailComposeUtil.getEditorContent();l=EmailComposeUtil.parseContentToRemoveAutoSuggestionElem(l);var o=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val(),n=$("#jsonForMergefields_"+EmailComposeUtil.CURRENT_TAB).data("mergeFieldsData");null!=n&&(l=EmailSendingUtil.convertMergeFieldstoFieldIds(l,n),o=EmailSendingUtil.convertMergeFieldstoFieldIds(o,n)),EmailComposeUtil.setEmailAddresses();var s={};if(EmailUtil.isReplyToAddressAdded()){var m=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).select2("data")[0].element;s.user_name=m.getAttribute("username"),s.email=m.getAttribute("value")}var r,d=EmailComposeUtil.getEmailAddressFromCompose("ceToAddrDetails"),c=EmailComposeUtil.getEmailAddressFromCompose("ceCCAddrDetails"),p=EmailComposeUtil.getEmailAddressFromCompose("ceBCCAddrDetails"),E=$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val();if(e&&(r=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val()),void 0===d||d.length<=0)crmui.showMsgBand("error",I18n.getMsg("crm.email.toaddr.empty"),3e3);else{if(!E){EmailUtil.addAttachments();var u=!0;i=EmailUtil.getAttachmentDetails(u)}if(E&&EmailActionHandling.draftContent.templateId===E&&(EmailActionHandling.draftContent.content!==l||EmailActionHandling.draftContent.subject!==o)){EmailUtil.addAttachments();u=!0;i=EmailUtil.getAttachmentDetails(u)}var C={};EmailUtil.createJSONObjectForMailContent(C,a,l,o,d,c,p,E,r,i,s),EmailCompose.sendMailFromAPI(!0,C)}}},c=$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB);e&&c?EmailSendingUtil.validateScheduleTime(c,d):d()}},EmailCompose.sendMailFromAPI=function(e,i){var t=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),a=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();EmailCompose.aiData.module=t,EmailCompose.aiData.entityId=a,(t=EmailComposeUtil.getApiNameForModule(t))&&""!==t&&(EmailCompose.aiData.module=t);var l=EmailUtil.getSendMailURL(t,a,i),o="POST";document.getElementById("msgId_"+EmailComposeUtil.CURRENT_TAB).value&&(o="PUT"),e&&(i=JSON.stringify(i)),(new crmRequestPool).initiate({url:l,type:o,data:i,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-REQUEST-GROUP":"mailer"},contentType:"application/json; charset=UTF-8",dataType:"json",beforeSend:EmailUtil.sendingPopup,afterSend:EmailUtil.closeSendingPopup,success:function(e){var i=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB),l=EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB],o=$("#draftId_"+EmailComposeUtil.CURRENT_TAB),n=o.val(),s=o.val();EmailUtil.closeSendingPopup();let m=$L("crm-emailconversation-view");if(m.length&&m[0].component.setData("showModal",!1),n){o.val("");n=s;if(o&&o.val()===n&&(EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.sessionStoredDraftId=null,EmailComposeUtil.removeDraftDOMElement()),$("#mails").hasClass("selectTab"))try{EmailUtil.refreshEmailRelList()}catch(e){murphy.error(e)}else EmailComposeUtil.refreshDraftsList()}else try{EmailUtil.refreshEmailRelList()}catch(e){murphy.error(e)}EmailSendingUtil.isEmailProgressing=!1;var r=$("#newleft_DataPrivacy");l&&Crm.userDetails.detailView_newUI&&r&&r.hasClass("sel")&&DataPrivacy.loadDataPrivacy(r);var d=EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB];if(d){var c=$("#dataRequestMailLink_"+d.id);d&&d.id&&c&&c.removeClass("dataRequestMailLink cP").text(I18n.getMsg("crm.data.subject.mail.sent")).unbind("click").addClass("eventNone")}var p="";try{e&&e.data&&e.data.length>0&&e.data[0].details&&e.data[0].details&&e.data[0].details.blocked_email_addresses&&e.data[0].details.blocked_email_addresses.length>0&&e.data[0].details.blocked_email_addresses.forEach((e=>{p=0===p.length?e.email+p:" , "+e.email+p}))}catch(e){murphy.error(e)}let E=$L("crm-detailview-data-privacy")[0];if(void 0!==E&&E.component){let e=E.component.getData("latestMailActivityComponent");"crm-data-subject-requests-view"===e?$L(e)[0].component.reloadDataSubjectRequestsView():$L("crm-data-processing-basis-view")[0].component.reloadDataProcessingBasisView()}var u=!1;EmailCompose.aiData.msgid=e.data?e.data[0].details.message_id:e.send_mail[0].details.message_id;var C={module:t,id:a,msgid:EmailCompose.aiData.msgid};CrmEmailInitialize.ComposeMailData.features_available.activity_suggestions?(u=!0,store.findAll("activity_suggestions",{include_inner_details:"linked_record->Events.Start_Date_Time,linked_record->Tasks.Due_Date,linked_record->Calls.Call_Start_Time"},void 0,void 0,C).then((function(e){if(e&&e[0]&&e[0].activities&&e[0].activities.length){EmailCompose.aiData.massmaildi=String(e[0].id);var t="<span onclick='EmailCompose.openActivityPopup()' class='emailsAIActivityAlert crmLinkColor cP'>"+I18n.getMsg("crm.email.zia.activityv2.suggestions.available")+"</span>";p&&p.length>0||(i.length>0&&i.is(":checked")?_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropCloseManually:!1,ltPropYield:!0,ltPropMessage:I18n.getMsg("crm.email.zia.activityv2.message.schedule",t)},close:function(){Crm.client_tracking("Activity Extraction - closed from sent mail"),Crm.client_tracking("Activity Extraction - closed from sent mail with schedule")}}):_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropCloseManually:!1,ltPropYield:!0,ltPropMessage:I18n.getMsg("crm.email.zia.activityv2.message",t)},close:function(){Crm.client_tracking("Activity Extraction - closed from sent mail")}})),Crm.client_tracking("Activity Extraction - from sent mail")}else EmailCompose.emailSendingAlertPopup(i)}),(function(){i.length>0&&i.is(":checked")?_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropYield:!0,ltPropMessage:I18n.getMsg("crm.case.schedule.message")}}):_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropYield:!0,ltPropMessage:I18n.getMsg("crm.case.sent.message")}})}))):EmailCompose.emailSendingAlertPopup(i);try{var g=$L("#module").val();if(("Potentials"===g||"Leads"===g)&&EmailActionHandling.source&&"nbx"===EmailActionHandling.source.get(EmailComposeUtil.CURRENT_TAB)){var U=document.querySelector("crm-nba-detail-page");U&&U.component.updateSuggestionFollowUp()}}catch(e){murphy.error(e)}commonUtils.showHideLoadingDiv(!1),EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB,!0);p&&p.length>0?(p.slice(0,-1),_cruxUtils.showCustomMessage({params:{ltPropType:"warning",ltPropYield:!0,ltPropDuration:"5000",ltPropMessage:I18n.getMsg("crm.mail.send.message.partial.success",p)}})):u||(i.length>0&&i.is(":checked")?_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropYield:!0,ltPropMessage:I18n.getMsg("crm.email.zia.activityv2.message.schedule","")}}):_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropYield:!0,ltPropMessage:I18n.getMsg("crm.email.zia.activityv2.message","")}})),document.querySelector("crm-besttime-new")&&Lyte.triggerEvent("bestTimeActivityListener",{type:"email"})},error:function(e){EmailUtil.closeSendingPopup();var i=e.status,t=(e=e.responseJSON,EmailUtil.getProperErrorMessage(e,i));t.includes("Mail Sending Failed! Your SMTP server does not allow sending emails to addresses which contain special and/or foreign characters")||t.includes("Error while processing the request! javax.mail.MessagingException: 5.5.2 Syntax error")?EmailUtil.showMsg("error",I18n.getMsg("chatacters_not_allowed_by_smtp_server"),5e3):401!==i&&crmui.showMsgBand("error",t,5e3),document.querySelector("crm-besttime-new")&&Lyte.triggerEvent("bestTimeActivityListener",{type:"email"})}})},EmailCompose.openActivityPopup=function(){$(".cxAlertWrapper").addClass("hide"),Lyte.Component.render("crm-email-activity-suggestions",{massmailid:EmailCompose.aiData.massmaildi,module:EmailCompose.aiData.module,entityId:EmailCompose.aiData.entityId,isFromCompose:!0},"body"),Crm.client_tracking("Activity Extraction - opened from sent mail")},EmailCompose.emailSendingAlertPopup=function(e){e.length>0&&e.is(":checked")?_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropYield:!0,ltPropCloseManually:!1,ltPropMessage:I18n.getMsg("crm.case.schedule.message")}}):_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropYield:!0,ltPropCloseManually:!1,ltPropMessage:I18n.getMsg("crm.case.sent.message")}})},EmailCompose.closeBcCc=function(e){var i=$(e).closest(".ceComposeinfo"),t=i.attr("id");i.removeClass("ceComposeMeta"),EmailUtil.removeAllAddedEmails(t),$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide"),i.addClass("hide"),$("[data-divid='"+t+"']").removeClass("hide"),EmailSendingUtil.resetEmailAddresses()},EmailCompose.SwitchToOldEditor=function(){var e=$L("#ecwFeedBackPop");e&&e.get(0).ltProp("show",!1);var i=EmailTabHomeUtil.ACTION+"=composeFeedback";i+="&"+csrfParamName+"="+csrfToken+"&switchType=newToOld",(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:i,error:EmailTabHomeUtil.handleAjaxAbort});var t=editor.zEditor.z_doc.getElementsByClassName("suggestedWord")[0];t&&t.remove();var a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();EmailSendingUtil.entityId&&(l=EmailSendingUtil.entityId),l||(l=$("#ecEntityId").val());var o=$("#contactSelDropdownInAcc :selected");o&&o.attr("value")&&(a="Accounts");var n=$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val();if(EmailComposeUtil.isInventoryModule(a)&&n?(n.includes(".pdf")||(n+=".pdf"),EmailSendingUtil.inventObj={layout_Id:$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(),layout_Name:n,viewType:$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(),paperType:$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val()}):EmailSendingUtil.inventObj=void 0,"undefined"!=typeof editor&&editor&&editor.zEditor){EmailSendingUtil.switchedToOldEditor=!0,EmailSendingUtil.switchedToOldWin=!0,EmailSendingUtil.subject=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val(),editor.zEditor.editorDiv?EmailSendingUtil.tempContent=editor.zEditor.editorDiv.innerHTML.replace("?Subject=","?subject="):EmailSendingUtil.tempContent="",EmailSendingUtil.setEmailAddresses(),EmailSendingUtil.fromAddr=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(),EmailSendingUtil.toAddr=EmailSendingUtil.getUserNameWithEmailForSwitch("ceToAddr"),EmailSendingUtil.bccAddr=EmailSendingUtil.getUserNameWithEmailForSwitch("ceBCCAddr"),EmailSendingUtil.ccAddr=EmailSendingUtil.getUserNameWithEmailForSwitch("ceCCAddr");var s=document.getElementById("ceOption_replyto");if(s&&!s.classList.contains("hide")){var m=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.replyTo=m.val()}else EmailSendingUtil.replyTo="";EmailUtil.addAttachments(),EmailSendingUtil.attachArray=EmailUtil.getAttachmentDetails();var r=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB);if(r.is(":checked")){var d=EmailDateTimeUtils.formatDate(r.val()),c=d.getTime(),p=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.ScheduleText=p.find("label")[0].innerText;var E=EmailUtil.getTimeZoneOffsetFromTextString(EmailSendingUtil.ScheduleText),u=c-60*d.getTimezoneOffset()*1e3;u+=60*(Utils.getTimezoneOffset()+E)*1e3,EmailSendingUtil.ScheduledTime=u;p=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.ScheduleText=p.find("label")[0].innerText}else EmailSendingUtil.ScheduledTime="";editor.zEditor.editorMode&&("plainEditor"===editor.zEditor.editorMode?(EmailSendingUtil.tempEditor="plaintext",EmailSendingUtil.tempContent=editor.zEditor.plainEditor.value):EmailSendingUtil.tempEditor="richtext"),Crm.userDetails.isNewEditor=!1,EmailSendingUtil.view?EntSendMail(a,l,EmailSendingUtil.view):EntSendMail(a,l,"",EmailSendingUtil.singularMod)}EmailComposeUtil.isCloseAll=!0,setTimeout((function(){EmailSendingUtil.switchedToOldWin=!1}),4e5);for(var C=EmailComposeUtil.OPEN_TAB_COUNT,g=0;g<C;g++)EmailComposeUtil.lastDraftUpdatedTime=0,EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB,!1,!0);EmailComposeUtil.CURRENT_TAB=0,EmailComposeUtil.TEMP_TAB=0,EmailComposeUtil.lastDraftUpdatedTime=0},EmailCompose.showEditorFeedBack=function(){var e=$L("#etAtchmentPopOverallContainer_"+EmailComposeUtil.CURRENT_TAB+" [data-showLoading='true']");if(e&&e.length>0)return crmui.showMsgBand("error",I18n.getMsg("crm.email.attach.inprogess"),3e3),!1;$L("#ecwFeedBackPop").get(0).ltProp("show",!0)},EmailCompose.closeEditorFeedBack=function(){$L("#ecwFeedBackPop").get(0).ltProp("show",!1)},EmailCompose.openDraftDisclaimer=function(e,i,t){if(EmailSendingUtil.entityId=t,EmailSendingUtil.activeModule=i,EmailSendingUtil.draftId=e,Crm.userDetails.isNewEditor){EmailCompose.fetchDraftDetails(EmailSendingUtil.draftId,EmailSendingUtil.activeModule,EmailSendingUtil.entityId,!0);var a=$("#lookupdiv");a.empty(),a[0].style.display="none"}else $L("#draftEditOld")[0].ltProp("show",!0)},EmailCompose.closeDraftDisclaimer=function(){$L("#draftEditOld")[0].ltProp("show",!1)},EmailCompose.openDraftFromOldCompose=function(){$L("#draftEditOld")[0].ltProp("show",!1);var e=EmailTabHomeUtil.ACTION+"=composeFeedback";e+="&"+csrfParamName+"="+csrfToken+"&switchType=oldToNew",(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:e,success:function(){Crm.userDetails.isNewEditor=!0,parent.renderingUtils.removeFreezeLayer(),EmailCompose.fetchDraftDetails(EmailSendingUtil.draftId,EmailSendingUtil.activeModule,EmailSendingUtil.entityId),EmailSendingUtil.SwitchedFromOldToNew=!0;var e=$("#lookupdiv");e.empty(),e[0].style.display="none"},error:EmailTabHomeUtil.handleAjaxAbort})},EmailCompose.openComposeWindow=function(e,i,t,a,l,o,n,s,m,r,d){var c=!1;Crm.userDetails.isNewEditor||(c=!0,Crm.userDetails.isNewEditor=!0);var p={},E=[],u={};if(u.content=s,u.enc_msgid="",u.enc_thread_id="",u.from_address=e,u.subject="",u.to=i,u.cc=t,u.bcc=a,u.subject=m,u.source="CScript",n&&(u.content=""),E.push(u),p.data=E,EmailSendingUtil.isFromCscript=r,EmailSendingUtil.removeFocus=!0,d.postEditorCallBack&&(EmailSendingUtil.postEditorCallBack=d.postEditorCallBack),d&&d.pdfLayoutDetails&&EmailComposeUtil.isInventoryModule(l)&&(EmailSendingUtil.pdfLayoutDetails=d.pdfLayoutDetails),EmailLaunchUtil.launchReplyMail(p,l,o),n){EmailSendingUtil.isLoadTemplate=!0,EmailSendingUtil.module=l;var C=EmailUtil.getTemplateData(n,l,e,u.to[0].email,o,"richtext","CScript",m);if(C&&C.error)return;EmailSendingUtil.templateData=C}c&&setTimeout((function(){Crm.userDetails.isNewEditor=!1}),4e3)},EmailCompose.loadInventoryAttach=function(){var e=EmailSendingUtil.pdfLayoutDetails.layoutId,i=EmailSendingUtil.pdfLayoutDetails.layoutName,t=EmailSendingUtil.pdfLayoutDetails.paperType,a=EmailSendingUtil.pdfLayoutDetails.viewType,l=EmailSendingUtil.pdfLayoutDetails.pdfVersion;EmailComposeUtil.pdfLayoutDetails={},t="default"===t?"A4":t,(i+=".pdf").includes(".pdf")||(i+=".pdf");var o=EmailComposeUtil.getFormattedAttachmentDetails(e,i);o.EDITOR_ATTACH=1,editor.zEditor.displayAttachment(o),$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(e),$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val(i),$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val(t),$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(a),$("#pdf_engine_type_"+EmailComposeUtil.CURRENT_TAB).val(l)},EmailCompose.isTranslationEnabled=function(){return!!(CrmEmailInitialize&&CrmEmailInitialize.ComposeMailData&&CrmEmailInitialize.ComposeMailData.features_available&&CrmEmailInitialize.ComposeMailData.features_available.isTranslationAvailable)},EmailCompose.isSubjectLineSuggestionEnabled=function(){return"999"!==EmailComposeUtil.CURRENT_TAB&&(CrmEmailInitialize.ComposeMailData.features_available.subject_line_suggestion&&EmailCompose.languageCheck())},EmailCompose.languageCheck=function(){var e=Crm.userDetails.RELEVANT_LOCALE;return"en_US"===e||"en_GB"===e},EmailCompose.setSubjectToDefault=function(){$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).attr("placeholder",I18n.getMsg("crm.email.search.option.subject"))},EmailCompose.isEmailContentEmpty=function(){let e=editor.getEditorMode(),i="";"plainEditor"===e?i=editor.getContent():"richEditor"===e&&(i=editor.zEditor.editorDiv.innerHTML);var t=EmailCompose.removeSignature(i);return t=EmailCompose.extractHTMLTags(t),t=EmailCompose.removeSpaces(t),"paste"!==EmailCompose.autoTrigger&&t.length<EmailCompose.minEmailBodyLength},EmailCompose.isSubjectEmpty=function(){!EmailCompose.isSubjectLineSuggestionEnabled()||EmailCompose.isEmailContentEmpty()||EmailCompose.isEmailTemplates()?(EmailCompose.setSubjectToDefault(),$("#suggestion_icon_"+EmailComposeUtil.CURRENT_TAB).addClass("vH")):""===$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val()?EmailCompose.getSuggestion(!1):EmailCompose.showSuggestionIcon()},EmailCompose.showSuggestionIcon=function(){if(!EmailCompose.isSubjectLineSuggestionEnabled()||EmailCompose.isEmailContentEmpty()||EmailCompose.isEmailTemplates()||""===EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB])$("#suggestion_icon_"+EmailComposeUtil.CURRENT_TAB).addClass("vH");else{var e=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();e===EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]||""===e?($("#suggestion_icon_"+EmailComposeUtil.CURRENT_TAB).addClass("vH"),$("#suggestions_dropdown_"+EmailComposeUtil.CURRENT_TAB).addClass("vH"),EmailCompose.getSuggestion(!1)):$("#suggestion_icon_"+EmailComposeUtil.CURRENT_TAB).removeClass("vH")}},EmailCompose.showSuggestionPlaceholder=function(){var e=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();""!==EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]?($("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).attr("placeholder",EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]),1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]&&""===e&&Crm.client_tracking("Email Subject Suggestion - default call placeholder suggestion viewed"),void 0!==EmailCompose.autoTrigger&&!1!==EmailCompose.autoTrigger||1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]||""!==e||Crm.client_tracking("Email Subject Suggestion - non default call placeholder suggestion viewed")):EmailCompose.setSubjectToDefault()},EmailCompose.showSuggestionDropdown=function(){$("#suggestions_dropdown_"+EmailComposeUtil.CURRENT_TAB).removeClass("vH"),$("#suggested_subject_"+EmailComposeUtil.CURRENT_TAB).text(EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]),1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]&&""!==EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]&&Crm.client_tracking("Email Subject Suggestion - default call dropdown suggestion viewed"),void 0!==EmailCompose.autoTrigger&&!1!==EmailCompose.autoTrigger||1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]||Crm.client_tracking("Email Subject Suggestion - non default call dropdown suggestion viewed")},EmailCompose.hideSuggestionDropdown=function(){$("#suggestions_dropdown_"+EmailComposeUtil.CURRENT_TAB).addClass("vH")},EmailCompose.hideAllSuggestions=function(){EmailCompose.setSubjectToDefault(),$("#suggestion_icon_"+EmailComposeUtil.CURRENT_TAB).addClass("vH"),$("#suggestions_dropdown_"+EmailComposeUtil.CURRENT_TAB).addClass("vH")},EmailCompose.replaceSubjectOnKeyDown=function(e,i){var t=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();if(EmailCompose.isSubjectLineSuggestionEnabled()&&""!==EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]&&""===t&&!EmailCompose.isEmailContentEmpty()){var a=i.keyCode;39!==a&&9!==a||(EmailComposeUtil.setSubject(EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]),Crm.client_tracking("Email Subject Suggestion - suggestion used"),1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]&&Crm.client_tracking("Email Subject Suggestion - default call placeholder suggestion used"),void 0!==EmailCompose.autoTrigger&&!1!==EmailCompose.autoTrigger||1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]||Crm.client_tracking("Email Subject Suggestion - non default call placeholder suggestion used"))}},EmailCompose.replaceSubjectOnClick=function(e){EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]=EmailCompose.decodeHTML(e.innerHTML),EmailComposeUtil.setSubject(EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]),EmailCompose.hideSuggestionDropdown(),$("#suggestion_icon_"+EmailComposeUtil.CURRENT_TAB).addClass("vH"),Crm.client_tracking("Email Subject Suggestion - suggestion used"),1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]&&""!==EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]&&Crm.client_tracking("Email Subject Suggestion - default call dropdown suggestion used"),void 0!==EmailCompose.autoTrigger&&!1!==EmailCompose.autoTrigger||1===EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]||Crm.client_tracking("Email Subject Suggestion - non default call dropdown suggestion used")},EmailCompose.getSuggestion=function(e,i){let t=editor.getEditorMode(),a="";if("plainEditor"===t?a=editor.getContent():"richEditor"===t&&(a=editor.zEditor.editorDiv.innerHTML),EmailCompose.autoTrigger=i,EmailCompose.isSubjectLineSuggestionEnabled()&&!EmailCompose.isEmailContentEmpty()&&!EmailCompose.isEmailTemplates()){var l=EmailCompose.removeSignature(a);if(l=EmailCompose.extractHTMLTags(l),l=EmailCompose.decodeHTML(l),EmailCompose.matchStringCheck(EmailCompose["parsedContent_"+EmailComposeUtil.CURRENT_TAB],l))!0===e?EmailCompose.showSuggestionDropdown():EmailCompose.showSuggestionPlaceholder();else if("paste"!==EmailCompose.autoTrigger&&(EmailCompose["parsedContent_"+EmailComposeUtil.CURRENT_TAB]=l.trim().substring(0,2500),l=""),EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]=EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]+1,EmailCompose["APICallCount_"+EmailComposeUtil.CURRENT_TAB]<=EmailCompose.maxAPICallCount){var o=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val(),n=!1;"paste"!==EmailCompose.autoTrigger&&"keydown"!==EmailCompose.autoTrigger&&"draft"!==EmailCompose.autoTrigger||""===o||o===EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]||(n=!0,Crm.client_tracking("Email Subject Suggestion - suggested subject already present before DI API call")),""===EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]&&Crm.client_tracking("Email Subject Suggestion - suggested subject empty before DI API call");var s={emails:[{id:"1",email_body:EmailCompose["parsedContent_"+EmailComposeUtil.CURRENT_TAB]}]},m=networkUtils.returnDependencyFiles(["subject-line-suggestion.js"],ResourceConstants.CRMClient);Lyte.injectResources(m,void 0,(function(){store.createRecord("subject_line_suggestion"),store.create("subject_line_suggestion",void 0,s).then((function(i){var t=i.subject_line_suggestion[0].details;if("success"===t.status&&200===t.statusCode&&""!==t.response.summary){if(Crm.client_tracking("Email Subject Suggestion - suggestion received"),EmailCompose["ziaSuggestedSubject_"+EmailComposeUtil.CURRENT_TAB]=t.response.summary,("keydown"===EmailCompose.autoTrigger||"paste"===EmailCompose.autoTrigger||"draft"===EmailCompose.autoTrigger)&&("draft"===EmailCompose.autoTrigger&&Crm.client_tracking("Email Subject Suggestion - suggestion shown for draft mail"),""===o))return void EmailCompose.showSuggestionPlaceholder();if(n)return void EmailCompose.showSuggestionIcon();e?EmailCompose.showSuggestionDropdown():EmailCompose.showSuggestionPlaceholder()}else"success"!==t.status&&"error"!==t.status&&204!==t.statusCode&&""!==t.response.summary||Crm.client_tracking("Email Subject Suggestion - empty subject received")})).catch((function(e){Crm.client_tracking("Email Subject Suggestion - DI API error",{error:e})})),store.unloadAll("subject_line_suggestion")}))}else!0===e?EmailCompose.showSuggestionIcon():EmailCompose.showSuggestionPlaceholder()}},EmailCompose.matchStringCheck=function(e,i){return(e=e.trim().replace(/\s+/g,""))===(i=i.trim().replace(/\s+/g,""))},EmailCompose.isEmailTemplates=function(){let e=editor.getEditorMode(),i="";return"plainEditor"===e?i=editor.getContent():"richEditor"===e&&(i=editor.zEditor.editorDiv.innerHTML),/<html.*?>/.test(i)||/<style.*?>/.test(i)||i.includes("zppage-container")},EmailCompose.decodeHTML=function(e){var i=document.createElement("textarea");i.innerHTML=e;let t=i.childNodes;return 0===t.length?"":t[0].nodeValue},EmailCompose.removeSpaces=function(e){return e=(e=(e=e.trim()).replace(/&nbsp;/,"")).replace(/\s+/g,"")},EmailCompose.removeSignature=function(e){return e=(e=e.replace(/<span data-zbluepencil-ignore="true" id="ecw_signature">(.*)<\/span>/g,"")).replace(/<div data-zbluepencil-ignore="true" id="ecw_signature">(.*)<\/div>/g,"")},EmailCompose.removeLinks=function(e){return e=(e=(e=(e=e.replace(/<a.*?>/g,"")).replace(/<\/a>/g,"")).replace(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_.~#?&=]*)/g,"")).replace(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/g,"")},EmailCompose.removeForwardMailTags=function(e){return e=e.replace(/<div class="mcPreviousMailContent">(.*?)<\/div>/g,"")},EmailCompose.removeReplyMailTags=function(e){return e=(e=e.replace(/<blockquote.*?>/g,"")).replace(/<\/blockquote>/g,"")},EmailCompose.extractHTMLTags=function(e,i){return EmailSendingUtil.IsReplyOrForwardMail()&&(e=EmailCompose.removeForwardMailTags(e),e=EmailCompose.removeReplyMailTags(e)),e=e.replace(/----(.*)/g,""),e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=EmailCompose.removeLinks(e)).replace(/<font.*?>/g,"")).replace(/<\/font>/g,"")).replace(/<p.*?>/g,"")).replace(/<\/p>/g,"")).replace(/<span.*?>/g,"")).replace(/<\/span>/g," ")).replace(/<hr>/g,"")).replace(/<\/b>/g,"")).replace(/<i.*?>/g,"")).replace(/<\/i>/g,"")).replace(/<u.*?>/g,"")).replace(/<\/u>/g,"")).replace(/<ul.*?>/g,"")).replace(/<\/ul>/g,"")).replace(/<li.*?>/g,"")).replace(/<\/li>/g,"")).replace(/<ol.*?>/g,"")).replace(/<\/ol>/g,"")).replace(/<sup.*?>/g,"")).replace(/<\/sup>/g,"")).replace(/<blockquote.*?>/g,"")).replace(/<\/blockquote>/g,"")).replace(/<div.*?>/g,"")).replace(/<\/div>/g,"")).replace(/<strike.*?>/g,"")).replace(/<\/strike>/g,"")).replace(/<table.*?>/g,"")).replace(/<\/table>/g,"")).replace(/<td.*?>/g,"")).replace(/<\/td>/g,"")).replace(/<tr.*?>/g,"")).replace(/<\/tr>/g,"")).replace(/<th.*?>/g,"")).replace(/<\/th>/g,"")).replace(/<tbody.*?>/g,"")).replace(/<\/tbody>/g,"")).replace(/<meta.*?\/>/g,"")).replace(/<meta.*?>/g,"")).replace(/<\/meta>/g,"")).replace(/&nbsp;/g," ")).replace(/&quot;/g,"'")).replace(/&amp;/g,"&")).replace(/&#39;/g,"'"),e=i?(e=(e=e.replaceAll(/<br\s*.*?>/g,"\n")).replaceAll("<br>","\n")).replace(/<[^>]*>/g,""):(e=(e=(e=e.replaceAll(/<br\s*.*?>/g,"\n")).replace(/\n.*?/g,"")).replace(/\\n.*?/g,"")).replace(/<b.*?>/g,"")},EmailCompose.insertSmartSuggestion=function(e){if("plainEditor"===editor.getEditorMode()){var i=EmailCompose.getEmailDetails(e);e=i.content;var t=editor.zEditor.plainEditor;if(n=t.value.substring(t.selectionStart,t.selectionEnd)){var a=t.value.substring(0,t.selectionStart),l=t.value.substring(t.selectionEnd);t.value=a+e+l;var o=a.length+e.length;t.setSelectionRange(o,o)}else t.value=e;i.subject&&$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val(i.subject)}else{var n="";if(editor.zEditor.getSelection&&(n=editor.zEditor.getSelection().toString()),n){editor.zEditor.z_doc.execCommand("insertText",!1,e);o=editor.zEditor.getSelection().getRangeAt(0).endOffset;var s=editor.zEditor.z_doc.createRange();editor.zEditor.z_doc.getSelection().removeAllRanges(),editor.zEditor.z_doc.getSelection().addRange(s)}else editor.zEditor.editorDiv.innerHTML=e,EmailCompose.setFontProps(),"reply"!==EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]&&"replyAll"!==EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]&&EmailComposeUtil.tempSmartSignature[EmailComposeUtil.CURRENT_TAB]&&(editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML+"<br>"+EmailComposeUtil.tempSmartSignature[EmailComposeUtil.CURRENT_TAB].outerHTML)}},EmailCompose.getEmailDetails=function(e){var i="",t=e.indexOf("Subject:");if(-1!==t){var a=e.indexOf("\n",t);i=e.substring(t+9,a).trim()}var l=e.indexOf("\n\n");return{subject:i,content:-1!==l&&i?e.substring(l+2).trim():e}},EmailCompose.setFontProps=function(){var e=editor.zEditor.activeTabElem.querySelector("#z_fntsizeText").innerHTML;e&&(editor.zEditor.focusEditor(),editor.zEditor.z_doc.execCommand("selectAll",!1,null),editor.zEditor.z_doc.execCommand("fontsize",!1,{8:"1",10:"2",12:"3",14:"4",18:"5",24:"6",36:"7"}[e]));var i=$(editor.zEditor.fontFamilyDiv).find(".selectedTool")[0].getAttribute("data-font");if(i){var t=editor.zEditor;editor.zEditor.z_doc.execCommand("selectAll",!1,null),zEditor.prototype.updateFontFamily(i),t.z_doc.execCommand("fontname",!1,i)}editor.zEditor.getSelection().removeAllRanges()},EmailCompose.renderEmailPicker=function(e,i){var t=i.type;if("input"===t||"click"===t){if("click"!==t)EmailSendingUtil.handleKeyUpEventsForAutoComplete(e,i);else if($("#ceRecipents_"+EmailComposeUtil.CURRENT_TAB).find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)").length>=50)return EmailComposeUtil.setMessagesForAlerts(),void EmailSendingUtil.limitExceedAlertFor50Mails();var a=$L(e).attr("id"),l="";if(a.includes("ceToAddr")?(EmailComposeUtil.emailPickerCalledFor[EmailComposeUtil.CURRENT_TAB]="#emailPickerToAddr_",l="#emailPickerToAddr_"):a.includes("ceCCAddr")?(EmailComposeUtil.emailPickerCalledFor[EmailComposeUtil.CURRENT_TAB]="#emailPickerCCAddr_",l="#emailPickerCCAddr_"):a.includes("ceBCCAddr")&&(EmailComposeUtil.emailPickerCalledFor[EmailComposeUtil.CURRENT_TAB]="#emailPickerBCCAddr_",l="#emailPickerBCCAddr_"),0===$L("#emailPickerComponent_"+EmailComposeUtil.CURRENT_TAB).length)Lyte.Component.render("crm-email-picker-in-compose",[],l+EmailComposeUtil.CURRENT_TAB);else{var o=$L("crm-email-picker-in-compose .email_option_dropdown")[0].ltProp("query");o.includes(l)||($L(o)[0].innerHTML="",Lyte.Component.render("crm-email-picker-in-compose",[],l+EmailComposeUtil.CURRENT_TAB))}var n=e.value;n=n.trim();for(var s=$L("crm-email-picker-in-compose"),m=s.length,r=0;r<m;r++){var d=s.get(r).component;if(d.getData("ltPropQuery").includes(EmailComposeUtil.CURRENT_TAB))var c=d}"input"===t?n?(c.setData("isEmptySearch",!1),c.setData("searchFor",n),c.methods.searchInEmails.call(c,n)):(c.setData("isEmptySearch",!0),c.methods.didConnectReRender.call(c)):n?c.methods.searchInEmails.call(c,n):(c.setData("isEmptySearch",!0),c.setData("isSearchResultAvailable",!1),c.methods.didConnectReRender.call(c));var p=$L("#emailPickerComponent_"+EmailComposeUtil.CURRENT_TAB)[0];p.ltProp("selected",""),(c.getData("renderPicker")||c.getData("renderSearchResult"))&&p.open()}else"keydown"===t?EmailSendingUtil.handleKeyDownEventsForAutoComplete(e,i):"paste"===t?EmailSendingUtil.handlePasteEventForAutoComplete(e,i):"keyup"===t?EmailSendingUtil.handleKeyUpEventsForAutoComplete(e,i):EmailComposeUtil.closeOtherPopUps()};var EmailTabHomeUtil={dragAndDropObject:{}};EmailTabHomeUtil.dragAndDropObject.dropedElement=void 0,EmailTabHomeUtil.dragAndDropObject.isCompleted=!0,EmailTabHomeUtil.dragAndDropObject.fromMod=void 0,EmailTabHomeUtil.dragAndDropObject.toMod=void 0,EmailTabHomeUtil.tempEleScrVal=0,EmailTabHomeUtil.isOnSentimentDiv=!1,EmailTabHomeUtil.URL=Crm.getCrmBasePath()+"/View.do",EmailTabHomeUtil.ACTION="action",EmailTabHomeUtil.POST_REQUEST_TYPE="POST",EmailTabHomeUtil.GET_REQUEST_TYPE="GET",EmailTabHomeUtil.DISABLED_DROPNDIV="disabledDropDiv",EmailTabHomeUtil.GET_FILE_DATA="getFileData",EmailTabHomeUtil.COMPOSE="compose",EmailTabHomeUtil.REPLY="reply",EmailTabHomeUtil.REPLYALL="replyAll",EmailTabHomeUtil.FORWARD="forward",EmailTabHomeUtil.VIEW_MAILS="viewMails",EmailTabHomeUtil.LOAD_MAILS="loadMails",EmailTabHomeUtil.LOAD_MORE_SEARCH_MAILS="loadMoreSearchMails",EmailTabHomeUtil.CONVERT_UNMATCHED_TO_COLLEAGUES="convertUnMatchedMailToColleaugesList",EmailTabHomeUtil.DELETE="delete",EmailTabHomeUtil.DELETE_DRAFT="deleteDraft",EmailTabHomeUtil.MOVE_TO_TRASH="moveToTrash",EmailTabHomeUtil.MOVE_MAIL="moveMail",EmailTabHomeUtil.MOVE_TO_FOLDER="moveToFolder",EmailTabHomeUtil.MARK_AS_SPAM="markAsSpam",EmailTabHomeUtil.MARK_AS_READ="markAsRead",EmailTabHomeUtil.MARK_AS_UNREAD="markAsUnread",EmailTabHomeUtil.SEARCH="search",EmailTabHomeUtil.GET_ALL_TEMPLATES_FOR_MODULE="getAllTemplatesForModule",EmailTabHomeUtil.GET_TEMPLATE_DETAIL_BY_ID="getTemplatesDetailById",EmailTabHomeUtil.GET_POTENTIAL_STATGES="getPotentialStages",EmailTabHomeUtil.EMAIL_DETAILVIEW_PARENT="emaildetailresult",EmailTabHomeUtil.EMAIL_CONVIEW_PARENT="etConvDetailView",EmailTabHomeUtil.imgStaticServerPath="",EmailTabHomeUtil.ViewPortWidth="",EmailTabHomeUtil.ViewPortHeight="",EmailTabHomeUtil.KanbanViewBoxHeight="",EmailTabHomeUtil.KanbanViewSelectionObject="",EmailTabHomeUtil.Loading="#etLoading",EmailTabHomeUtil.detailViewParent="",EmailTabHomeUtil.uiSender=null,EmailTabHomeUtil.uiItem=null,EmailTabHomeUtil.droppedElement="",EmailTabHomeUtil.DragStart="",EmailTabHomeUtil.mailActionsOpener=null,EmailTabHomeUtil.SUCCESS="SUCCESS",EmailTabHomeUtil.selectedMailsIds=new Array,EmailTabHomeUtil.selectedThreadIds=new Array,EmailTabHomeUtil.MailInView="",EmailTabHomeUtil.ThreadIdInView="",EmailTabHomeUtil.MessageIdInView="",EmailTabHomeUtil.CurrentlyDetailViewOpened=!1,EmailTabHomeUtil.MAIL_SELECTION_LIMIT=200,EmailTabHomeUtil.DefaultMailBoxWidth=260,EmailTabHomeUtil.KanbanViewBoxHeight="",EmailTabHomeUtil.KanbanViewBoxLength=4,EmailTabHomeUtil.CustomMailBoxWidth=-1,EmailTabHomeUtil.VisibleModulesCount=0,EmailTabHomeUtil.subMenuActive=0,EmailTabHomeUtil.mainMenuActive=0,EmailTabHomeUtil.KanbanMailBoxWidth="",EmailTabHomeUtil.ModuleVsParentDivId={},EmailTabHomeUtil.QuickEditDeleteIcons=0,EmailTabHomeUtil.MailMultiSelect=0,EmailTabHomeUtil.MailSelection=0,EmailTabHomeUtil.ContextMenuParent="",EmailTabHomeUtil.isChatEnabled="",EmailTabHomeUtil.isMenuEnabled=!0,EmailTabHomeUtil.FullnameView=0,EmailTabHomeUtil.FullnameQuickView=0,EmailTabHomeUtil.shouldReloadView=!1,EmailTabHomeUtil.createdEntitiesJsonResponse=[],EmailTabHomeUtil.EmailcontainerHeight,EmailTabHomeUtil.HasPotentialStagesBeenFetched=0,EmailTabHomeUtil.CloseSuccDiv=0,EmailTabHomeUtil.PotentialStages,EmailTabHomeUtil.createPotentialFrom=null,EmailTabHomeUtil.isShiftKeyPressed=!1,EmailTabHomeUtil.isInitialLoad=!1,EmailTabHomeUtil.lastSelectedMailLi=null,EmailTabHomeUtil.isMailMultiSelectEnabled=!1,EmailTabHomeUtil.TopMenuBarHeight=0,EmailTabHomeUtil.BottomChatBarHeight=0,EmailTabHomeUtil.httpprotocol=location.protocol+"//",EmailTabHomeUtil.viewOrLabelLimit=32,EmailTabHomeUtil.currentThreadMailDetailContainer=null,EmailTabHomeUtil.viewNameWidth=0,EmailTabHomeUtil.syncStatus=0,EmailTabHomeUtil.searchIndexStatus=null,window.ajaxPager=!0,EmailTabHomeUtil.showNewTooltip=function(e){var i=$("#ecTTPointer"),t=$(e).attr("toolTipVal");if(t){var a,l=$(e).offset(),o=$("#ecNewToolTip"),n=l.left-o.outerWidth()/2;n=EmailTabHomeUtil.ViewPortWidth<n+o.outerWidth()?EmailTabHomeUtil.ViewPortWidth-o.outerWidth()-5:n<0?5:l.left-o.outerWidth()/2;var s=l.top-o.outerHeight();a=l.left-o.offset().left+$(e).outerWidth()/2-14,s>10?(s=l.top-35,i.css("bottom","-4px").removeClass("rotate180")):(s=l.top+$(e).outerHeight()+10,i.css("bottom",o.outerHeight()-1+"px").addClass("rotate180")),o.css({top:s,left:n}).show(),i.css("left",a+"px"),$("#ecTTVal").text(t),o.show()}},EmailTabHomeUtil.hideNewTooltip=function(){$("#ecNewToolTip").hide()},EmailTabHomeUtil.handleAjaxAbort=function(e){var i=$(EmailTabHomeUtil.Loading);if(i.hide(),i.removeAttr("data-zcqa"),e&&e.status&&(451==e.status||452==e.status||453==e.status||454==e.status))Crm.showAlertMsg(e.responseText);else if(e&&e.status&&455!=e.status){var t=arguments[0].readyState;0!==t&&Crm.showAlertMsg(I18n.getMsg("crm.security.error.add.user"))}},EmailTabHomeUtil.closeSuccessDiv=function(){0==EmailTabHomeUtil.CloseSuccDiv&&$("#mailSentSuccessfullyDiv").hide()},EmailTabHomeUtil.customConfirmation=function(e,i,t){var a=e.confirm?e.confirm:I18n.getMsg("crm.button.ok"),l=e.cancel?e.cancel:I18n.getMsg("crm.button.cancel"),o="emailGeneralConfirmMsgDiv";$("#contextMenuLabels").hide();var n=$("#"+o),s=n.find(".confirm"),m=n.find(".cancelBtn"),r=n.find(".ceCloseIconBold");return e.close&&(r.removeClass("hide"),r.off("click").click((function(e){var i=$("#"+o);return i.find(".ceCloseIconBold").addClass("hide"),i.hide(),renderingUtils.removeFreezeLayer(),renderingUtils.stopEvent(e),!1}))),s.text(a),m.text(l),n.find(".infoCont").text(e.info),s.off("click").click((function(e){var t=$("#"+o);t.find(".ceCloseIconBold").addClass("hide"),t.hide(),renderingUtils.removeFreezeLayer(),i&&i(),renderingUtils.stopEvent(e)})),m.off("click").click((function(e){var i=$("#"+o);return i.find(".ceCloseIconBold").addClass("hide"),i.hide(),renderingUtils.removeFreezeLayer(),renderingUtils.stopEvent(e),t&&t(),!1})),renderingUtils.freezeBackground(),mailsetCenter(o),n.show(),!1},EmailTabHomeUtil.NavigateToIMAP=function(){crmTab.redirectToSalesInbox=!0,Crm.trackSpotLightAction("SalesInbox - Configure Now Click")},EmailTabHomeUtil.initiateConfig=function(){crmTab.isMailClientEnabled&&!crmTab.isMailClientActive&&($("#etsImportFilter").removeClass("hide"),renderingUtils.freezeBackground(),Crm.isInitialFilterConfig=!0,mailsetCenter("etsImportFilter"),EmailImportFilter.saveConfig=EmailTabHomeUtil.startMigration)},EmailTabHomeUtil.startMigration=function(){var e=$("#tryNowBtn");e.prop("disabled",!0),e.attr("opacity",.5);var i=EmailTabHomeUtil.ACTION+"=trySalesinbox";i+="&"+csrfParamName+"="+csrfToken,(new crmRequestPool).initiate({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:Crm.getCrmBasePath()+"/SalesInboxIntro.do",data:i,success:function(e){"SUCCESS"!==e&&"ALREADY_ACTIVE"!==e||("undefined"!=typeof CrmPlusImpl&&CrmPlusImpl.isLoadedInCrmplus()?CrmPlusImpl.trigger("updateSalesInboxConfigurationData",[{"isconfigured ":!0,isfromconfigrationview:!0,has_access:!0,isemailadded:!0}]):window.location=crmHistory.locationOrigin+networkUtils.getOrgSpecificURL(Urls.Salesinbox))}})},EmailTabHomeUtil.adjustRightpanelTab=function(){setTimeout((function(){var e=$("#unknownConvertbuttonDiv");if(e.is(":visible")){var i=$("#krp_Conversation_Container"),t=i.outerHeight(),a=e.outerHeight(),l=$("#krp_Conversation_InnerContainer"),o=l[0].scrollHeight;i.css("height",t-a),l.css({height:o}),$$rightPanel.setPerfectScrollBar("krp_Conversation_Container","krp_Conversation_InnerContainer","")}$("#kso_rightpanel_title").addClass("hide")}),50)},EmailTabHomeUtil.appendCreateEntityAfterMailFetch=function(e,i){return function(){var t=EmailTabHomeUtil.getEmailToCreateEntity(e,i);if(!EmailTabHomeUtil.showEntityCreatedSuccessMsg(t)){var a=$.parseJSON('{"emailAddr":"'+t+'"}');a.leadpermission=crmTab.tabList.contains("Leads")&&Crm.userDetails.permissions.Crm_Implied_Create_Leads,a.contactpermission=crmTab.tabList.contains("Contacts")&&Crm.userDetails.permissions.Crm_Implied_Create_Contacts,EmailTabHomeUtil.populateUnMatchedEntityDetails("CreateEntityFromUnMatchedMails",a)}}},EmailTabHomeUtil.getEmailToCreateEntity=function(e,i){var t="";e===$("#configuredZmailAddr").val()?t=i.split(",")[0]:t=e;return t},EmailTabHomeUtil.showEntityCreatedSuccessMsg=function(e){var i=!1;if(null!=EmailTabHomeUtil.createdEntitiesJsonResponse&&EmailTabHomeUtil.shouldReloadView){var t=$(".outlookqCreate");$.each(EmailTabHomeUtil.createdEntitiesJsonResponse,(function(a,l){if(l.fromAddr===e||t.length)return l.taskpermission=crmTab.tabList.contains("Activities")&&Crm.userDetails.permissions.Crm_Implied_Create_Tasks,l.potentialpermission=crmTab.tabList.contains("Potentials")&&Crm.userDetails.permissions.Crm_Implied_Create_Potentials,EmailTabHomeUtil.populateUnMatchedEntityDetails("PostCreateEntity",l),i=!0,!0}))}return i},EmailTabHomeUtil.populateUnMatchedEntityDetails=function(e,i){var t=$("#kso_social_rightpanel");if(t.length){var a=Handlebars.templates[e](i);a+=t[0].outerHTML,EmailTabHomeUtil.adjustRightpanelTab(),$("#entityInfoOuterDiv").html(a),"undefined"!=typeof $$rightPanel&&$(".outlookqCreate").length&&$$rightPanel.bindClickEventForOutlook()}},EmailTabHomeUtil.reloadOnEntityCreationFromUnMatched=function(){var e=$(".emailnavLink.aliaslinksel");e.removeClass("aliaslinksel"),e.parent().find(".elpSelectedOption").removeClass("elpSelectedOption");var i=e.attr("emailViewId");EmailTabHomeUtil.shouldReloadView=!1,EmailTabHomeUtil.createdEntitiesJsonResponse=[],EmailViewsUtil.getMailsbyViewId(i)},EmailTabHomeUtil.postEntityCreate=function(e){if(EmailTabHomeUtil.shouldReloadView||(EmailTabHomeUtil.createdEntitiesJsonResponse=[],EmailTabHomeUtil.shouldReloadView=!0),"update"===e.action)$.each(EmailTabHomeUtil.createdEntitiesJsonResponse,(function(i,t){if(e.entityId===t.entityId)return"Tasks"===e.module?t.taskId=e.taskId:"Potentials"===e.module&&(t.potentialId=e.potentialId),!0}));else if("create"===e.action){var i=$("#"+EmailTabHomeUtil.detailViewParent).find("iframe").contents().find("#"+EmailTabHomeUtil.currentThreadMailDetailContainer);e.fromAddr="salesinbox"==Q.source?Q.actionDetails.email:i.length?i.find(".fromAddr").val():$("#rightPanelfromAddr").val(),EmailTabHomeUtil.createdEntitiesJsonResponse.push(e)}EmailTabHomeUtil.showEntityCreatedSuccessMsg($ESAPI.encoder().decodeFromURL($$rightPanel.rpSearchEmailAddr))},EmailTabHomeUtil.getViewPort=function(){var e,i;if(void 0!==window.innerWidth)e=window.innerWidth,i=window.innerHeight;else if(void 0!==document.documentElement&&void 0!==document.documentElement.clientWidth&&0!=document.documentElement.clientWidth)e=document.documentElement.clientWidth,i=document.documentElement.clientHeight;else{var t=document.getElementsByTagName("body")[0];e=t.clientWidth,i=t.clientHeight}EmailTabHomeUtil.ViewPortWidth=e,EmailTabHomeUtil.ViewPortHeight=i};var EmailUtil={dots:0,tempSignature:[],hideBand:!1,tempFrom:[],cancelFrom:"",tempDraftTab:"",isContinue:!1,refreshEmailRelList:function(){let e=$L("crm-emailconversation-view");if(!e.length||!e[0].component.getData("showModal")){var i=$("#module").val(),t=$("#entityId").val(),a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),o=$("#ecEmailId_"+EmailComposeUtil.CURRENT_TAB),n=$("#mailListRelId"),s=$("#contactSelDropdownInAcc")[0],m=t===l&&i===a,r=$L("#accountsScheduled")[0],d=$L(".selectTab").attr("id");if(d&&"scheduledMails"===d&&r)var c=r.ltProp("selected");else if(d&&"mails"===d&&s)c=s.ltProp("selected");if(n&&n.length>0&&n.val()&&(m||EmailComposeUtil.isCustomModule(i)||c&&c===l)&&o){var p=o.val(),E=$("#ecFullname_"+EmailComposeUtil.CURRENT_TAB).val(),u=n.val(),C="";C=t,$("#isFromNewAPI").length>0||null!=getOpenerObj("isFromNewAPI")?0!=$("#emcScheduleMailBtn").length&&!$("#emcScheduleMailBtn").hasClass("hide")||0!=$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).length&&!$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).hasClass("hide")?showMailsListViaAPI("","-10","next",null,"scheduledMails"):showMailsListViaAPI("","-10","next",null,"mails"):showMailsList(C,p,E,u,"-10","next","","false",i)}document.querySelector("crm-zsurvey-rl-label")&&ZSurvey.refreshSurveyPersonality(i,t)}},getSignaturebyEmail:function(e){var i,t=!1;if(e){var a=e.indexOf("<"),l=e.indexOf(">");-1!==a&&-1!==l&&a<l&&(e=e.slice(a+1,l))}var o=CrmEmailInitialize.ComposeMailData.user.compose_settings.email_signatures;if(o){for(var n=o.length,s=0;s<n&&!t;s++)if(e&&o[s].from){for(var m=o[s].from.length,r=0;r<m;r++)if(e.toLocaleLowerCase()===o[s].from[r].email.toLocaleLowerCase()){i=o[s].content,t=!0;break}}else if(o[s].default){i=o[s].content;break}return i=ZSEC.HTMLPurifier({ALLOWED_STYLE:"ALL",STYLE_VALIDATION:!1}).sanitize(i)}},setSignature:function(e,i){var t=editor.zEditor.z_doc.getElementById("ecw_signature");if(!$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val()||t){if(!i&&t&&EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]&&EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]!==t.innerHTML)return EmailComposeUtil.setFromAddress(EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]),EmailUtil.cancelFrom=EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB],$L("#ecwSignaturePop")[0].ltProp("show",!0),EmailUtil.hideBand=!0,void(EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]=e);if(EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]=e,"999"!==EmailComposeUtil.CURRENT_TAB){var a=EmailUtil.getSignaturebyEmail(e),l=Lyte.registeredMixins["email-footer-common-utils"],o=l.checkFooterAvailableAndMandatedforOrg()?l.getFooterContent(a):"";o=""===o?"":"<br>"+o,a=a?a+o:o;var n=editor.getEditorMode(),s=editor.zEditor.z_doc.getElementById("editorDiv");if("richEditor"===n){if(e&&t)return a||(a=""),"richEditor"===n&&(t.innerHTML=a),void(EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]=t.innerHTML);a=a?"<br><br><br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'>"+a+"</span>":"<br><br><br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'></span>",t||(s.innerHTML.includes("<div>")?editor.setContent(a):s.innerHTML=e?s.innerHTML+a.replace("<br><br><br><br><br><br><br><br><br><br><br><br>",""):s.innerHTML+a.replace("<br><br><br><br><br><br>",""))}else e&&a&&editor.getContent()?editor.setContent(editor.getContent()+"\n"+EmailUtil.convertToPlainText(a)):a=a?"\n\n\n\n"+convertToPlainText(a):"\n\n\n\n";(t=editor.zEditor.z_doc.getElementById("ecw_signature"))&&(EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]=t.innerHTML)}}},convertToPlainText:function(e){var i=document.createElement("div"),t=ZSEC.HTMLPurifier({ALLOWED_STYLE:"ALL",STYLE_VALIDATION:!1});i.innerHTML=t.sanitize(e.replace(/<(p|div|h\\d|br)>/gi,"\n"));var a=i.innerText;return i=void 0,a},closeMailTab:function(){document.querySelector("crm-besttime-new")&&Lyte.triggerEvent("bestTimeActivityListener",{type:"email"});var e=$("#draftId").val();EmailActionHandling.closeTab=!0;var i=EmailActionHandling.hasAnythingChanged();EmailActionHandling.closeTab=!1,e&&""!==e||i||EmailUtil.isEditInScheduleMail()&&!EmailCompose.hideDiscardPop?$L("#ecwDraftPop")[0].ltProp("show",!0):EmailUtil.closeMailContentView()},closeEmailTab:function(e,i,t,a){if(Lyte.registeredMixins.crm_zia_writing_assistant_mixin.closeZiaWritingAssistPanel(),e&&EmailActionHandling.source&&EmailActionHandling.source.get(e)&&EmailActionHandling.source.delete(e),EmailSendingUtil.isSendMailActionCalled=!1,!i)if(t)EmailUtil.tempDraftTab=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB=e,EmailActionHandling.saveDraftDetails(void 0,!0),EmailComposeUtil.CURRENT_TAB=EmailUtil.tempDraftTab;else{EmailUtil.tempDraftTab=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB=e,delete EmailComposeUtil.tabIdVsModuleName[e],delete EmailComposeUtil.tabIdVsEntityName[e],EmailComposeUtil.switchToCurrentEditor(e);var l=EmailUtil.isEditInScheduleMail()||EmailActionHandling.hasAnythingChanged();if(EmailComposeUtil.CURRENT_TAB=EmailUtil.tempDraftTab,EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB),l){var o=$L("#ecwDraftPop")[0];if(o&&!a&&l&&!EmailCompose.hideDiscardPop)return EmailUtil.tempDraftTab=e,void o.ltProp("show",!0);EmailCompose.hideDiscardPop=!1}}if(Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand();else{var n=networkUtils.returnDependencyFiles(["email-emotions.js","zia-notification-settings.js"],ResourceConstants.CRMClient);Lyte.injectResources(n,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand()}))}EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]="";var s=EmailComposeUtil.tabIdPrefix+e,m=EmailComposeUtil.contentIdPrefix+e,r=$("#"+s),d=$("#"+m);r.remove(),d.remove(),EmailComposeUtil.CURRENT_TAB===Number(e)?(EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB]=void 0,EmailComposeUtil.linkToModuleSelected[EmailComposeUtil.CURRENT_TAB]=!1,EmailComposeUtil.selectedEmails[EmailComposeUtil.CURRENT_TAB]=void 0,EmailComposeUtil.relatedContactEmails[EmailComposeUtil.CURRENT_TAB]=void 0,EmailComposeUtil.selectedFromSearch[EmailComposeUtil.CURRENT_TAB]=void 0):(EmailComposeUtil.linkedModule[Number(e)]=void 0,EmailComposeUtil.linkToModuleSelected[Number(e)]=!1,EmailComposeUtil.selectedEmails[Number(e)]=void 0,EmailComposeUtil.relatedContactEmails[Number(e)]=void 0,EmailComposeUtil.selectedFromSearch[Number(e)]=void 0),EmailComposeUtil.linkToModuleLabel="Linked to 1 module";var c,p=void 0===EmailComposeUtil.tabDetails[e]?void 0:EmailComposeUtil.tabDetails[e].draftDetails;if(p&&(c=p.draftId),c&&EmailComposeUtil.removeDraftIdFromSessionStorage(c),delete EmailComposeUtil.tabDetails[e],0!==EmailComposeUtil.OPEN_TAB_COUNT&&(EmailComposeUtil.OPEN_TAB_COUNT=Number(EmailComposeUtil.OPEN_TAB_COUNT)-1),EmailComposeUtil.composeEmailAddresses[EmailComposeUtil.CURRENT_TAB]=[],EmailComposeUtil.CURRENT_TAB===Number(e)){var E=EmailComposeUtil.getMRUTabId(),u=EmailComposeUtil.tabIdPrefix+E,C=document.getElementById(u);E&&E!==EmailComposeUtil.CURRENT_TAB&&"999"!==E&&C?(EmailComposeUtil.switchToTab(C),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.activeContentId="composeContentPanel_"+EmailComposeUtil.CURRENT_TAB):(EmailUtil.closeEmailContent(),$("#addNewSign")[0]&&($("#emailComposeEditor").attr("id","etComposePanel"),$("#composeEmailEditor").attr("id","composeEditor"),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB="999",EmailComposeUtil.activeContentId="composeContentPanel_999",EmailComposeUtil.switchToCurrentEditor("999")))}EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,0===EmailComposeUtil.OPEN_TAB_COUNT&&EmailComposeUtil.resetSessionStorageComposePosition()},closeEmailContent:function(){EmailCompose.closeSmartPrompt(),EmailComposeUtil.hideAllComposeRelatedPopup(),EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.removeCustomFreezeLayer(),EmailCompose.removeFreezelayer();var e=$L("#etComposePanel");e.css("right","-100%"),crmui.modalZIndex("nonLyte",e[0],"close"),$("body #composeEditor").remove(),EmailComposeUtil.removeSpectrumElem(),EmailComposeUtil.editorLoaded=!1,EmailSendingUtil.composeActive=!1,editor.zEditor={},tableResize.init={},EmailUtil.removeEmailComposePopupBasedDOMElements(),EmailComposeUtil.ComposeWindowLoaded=!1;var i=document.getElementById("fileCheckVariable");if(i){var t=i.getAttribute("tempval");i.value=t,i.removeAttribute("tempval")}},removeEmailComposePopupBasedDOMElements:function(){$(".editorToolDiv").remove()},closeMailContentView:function(e){crmui.hideMsgBand(),e||EmailActionHandling.saveDraftDetails(),EmailComposeUtil.hideAllComposeRelatedPopup(),EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.removeCustomFreezeLayer(),EmailCompose.removeFreezelayer(),$("#etComposePanel").css("right","-100%"),$("body #composeEditor").remove(),EmailComposeUtil.removeSpectrumElem(),EmailComposeUtil.editorLoaded=!1,EmailSendingUtil.composeActive=!1,EmailComposeUtil.editorContent="",EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData,document.body.removeEventListener("click",editor.zEditor.hideAllProps,!1),editor.zEditor={},tableResize.init={},$(".editorToolDiv").remove(),Lyte.removeFromCache(EmailComposeUtil.resources_1),Lyte.removeFromCache(EmailComposeUtil.resources_2),initializeSpellCheck&&initializeSpellCheck.stopSpellCheck(),EmailComposeUtil.ComposeWindowLoaded=!1,null!==EmailComposeUtil.draftInterval&&clearInterval(EmailComposeUtil.draftInterval),EmailComposeUtil.resetSessionStorageDraft();var i=document.getElementById("fileCheckVariable");if(i){var t=i.getAttribute("tempval");i.value=t,i.removeAttribute("tempval")}},pushDocsToArray:function(e,i){EmailSendingUtil.docsAttachmentArray.push(e),i&&"true"===i&&(EmailUtil.docsHandling(),EmailComposeUtil.tabIdVsAddingAttachmentCount.set(EmailComposeUtil.CURRENT_TAB,EmailSendingUtil.docsAttachmentArray.count))}};pushDocsToArray=function(e,i){EmailSendingUtil.docsAttachmentArray.push(e),i&&"true"===i&&(EmailUtil.docsHandling(),EmailComposeUtil.tabIdVsAddingAttachmentCount.set(EmailComposeUtil.CURRENT_TAB,EmailSendingUtil.docsAttachmentArray.count))},EmailUtil.hidecallout=function(){var e=$(".ppContSlide");e.css({top:"0px",left:"0px",opacity:"1"}),e.hide()},EmailUtil.docsHandling=function(){var e=document.getElementById("attachdialogdiv"),i=document.getElementById("zohodocsframe");e&&(e.style.display="none"),i&&(i.style.display="none"),Crm.userDetails.isNewEditor&&EmailUtil.removeCustomFreezeLayer(),EmailUtil.uploadDocsAttachments()},EmailUtil.uploadDocsAttachments=function(){var e=$("#draftId").val();EmailSendingUtil.isEntityWindow||e&&"null"!==e?EmailUtil.processDocsAttachments():EmailActionHandling.formDraftAndUploadDocs()},EmailUtil.processDocsAttachments=function(){for(var e;void 0!==(e=EmailSendingUtil.docsAttachmentArray.pop());){var i=e.split(":::")[0],t=e.split(":::")[1];t=i+":::"+(t=(t=t.replace(i+",","")).replace(",",":::")),EmailUtil.saveAndUploadAttachment(t)}},EmailUtil.saveAndUploadAttachment=function(e){var i=e.split(":::"),t=i[0],a=i[1],l=i[2],o=EmailComposeUtil.getFormattedAttachmentDetails(l,t,null,a);delete o[EmailComposeUtil.FILE_SIZE],editor.zEditor.thirdPartyAttachment(o)},EmailUtil.getAttachmentDetails=function(e){for(var i,t=document.getElementsByTagName("crm-emailcompose-attachment-popover"),a=t.length,l=0;l<a;l++)t[l].firstElementChild.id==="ecAttchmntPopContainer_"+EmailComposeUtil.CURRENT_TAB&&(i=l);var o,n=[],s=t[i].component.data.attachmentRecords;a=s.length;for(o=0;o<a;o++){var m=s[o].id,r=$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val();if(m&&r!==m&&(!EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]||EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB].id!==m)){var d={},c=s[o].serviceName;if(d.id=m,d.file_name=s[o].name,c)switch(c){case"null":case"":case EmailComposeUtil.Attachment.Desktop:d.service_name=e?"":c;break;case"IMAPAttached":case"GMailAttached":case"ZMAILAttached":case"RawZFSFile":case"from_record":d.service_name=c;break;default:d.service_name="ZFSAttached"}else d.service_name="";e||(d.file_size=parseInt(s[o].fileSize)),n.push(d)}}return n},EmailUtil.addAttachments=function(){var e="",i="",t="",a="",l="";$("#"+EmailComposeUtil.activeContentId+" #z_editor").contents().find("#attachmentList").find("li").each((function(){var o=$(this).attr("data-fileid"),n=$(this).attr("data-xAttach");if(o&&!n){var s=$(this).find(".attach_size");""===e?(e=$(this).attr("data-fileid"),a=$(this).attr("data-serviceName")?$(this).attr("data-serviceName"):"null",i=$(this).attr("title")?$(this).attr("title"):"null",t=s.html(),l=$(this).attr("data-filesize")?$(this).attr("data-filesize"):"null"):(e+=$(this).attr("data-fileid")?"###"+$(this).attr("data-fileid"):"###null",a+=$(this).attr("data-serviceName")?"###"+$(this).attr("data-serviceName"):"###null",i+=$(this).attr("title")?"###"+$(this).attr("title"):"###null",t+=s.html()?"###"+s.html():"###null",l+=$(this).attr("data-filesize")?"###"+$(this).attr("data-filesize"):"###null")}})),$("#entAttachId_"+EmailComposeUtil.CURRENT_TAB).val(e),$("#entAttachName_"+EmailComposeUtil.CURRENT_TAB).val(i),$("#entAttachSize_"+EmailComposeUtil.CURRENT_TAB).val(t),$("#attachServiceNames_"+EmailComposeUtil.CURRENT_TAB).val(a),$("#entAttachSZ_"+EmailComposeUtil.CURRENT_TAB).val(l)},EmailUtil.clearEditorAttachments=function(){var e=EmailComposeUtil.getCurrentPopover(),i=e.data.attachmentRecords,t=i.length;if(void 0!==t&&0!==t)if(EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]&&0==EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB].length){for(var a=[],l=0;l<t;l++)a.push(i[l].id);EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB]=a}else{var o=0;for(l=0;l<t;l++){var n=void 0===i[l-o].inventoryAttachment?3:i[l-o].inventoryAttachment;n&&1===n||EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB].contains(i[l-o].id)||(Lyte.arrayUtils(e.data.attachmentRecords,"removeAt",l-o,1),o+=1)}EmailComposeUtil.updatePopCount()}},EmailUtil.isAttachmentLoading=function(){if("undefined"!=typeof editor?editor.zEditor:void 0){var e=$L("#etAtchmentPopOverallContainer_"+EmailComposeUtil.CURRENT_TAB+" [data-showLoading='true']");if(e&&e.length>0)return!0}return!1},EmailUtil.createJSONObjectForMailContent=function(e,i,t,a,l,o,n,s,m,r,d){var c=l,p=o,E=n,u=$("#draftId_"+EmailComposeUtil.CURRENT_TAB).val(),C=[],g={from:{}};g.from.email=i.email,g.from.user_name=i.user_name;var U=$L("crm-rl-users-list"),h=!!(U&&U.length&&U[0].component.data.mailObj)&&U[0].component.data.mailObj.mailConfigured,v=void 0===EmailComposeUtil.isHavingRecordPermission||EmailComposeUtil.isHavingRecordPermission;if(S&&(Crm.userDetails.CONTACT_ROLES_EMAILS_RL&&Lyte.Component.registeredHelpers.getUserStatus("IMAP_STATUS")||!h)&&v){g.related_to_record={},g.related_to_record.module={};var f=$L("#contactRolesDropDown"),T=f&&f.length>0?f[0].component.data.ltPropSelected:null,S=$L("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),_=$L("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();if("Potentials"===S&&T&&T!==_&&!T.includes(_)&&Crm.userDetails.permissions.Crm_Implied_Send_Mail_Contacts){var A="Contacts";g.related_to_record.module.api_name=A,g.related_to_record.module.id=moduleRecordMapping.Contacts.id,g.related_to_record.id=T}else{var R,b=void 0===moduleRecordMapping[S];b&&(R=Object.values(moduleRecordMapping).find((e=>e.api_name===S))),g.related_to_record.module.api_name=b?R.module_name:S,g.related_to_record.module.id=b?R.id:moduleRecordMapping[S].id,g.related_to_record.id=_}}d&&"{}"!==JSON.stringify(d)&&(g.reply_to=d);var y={};y.id=u,u&&u.length>0&&(g.email_draft=y);var M=i.isOrgEmail||EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB];M=i.isOrgEmail||EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB];g.org_email=!!M,EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]&&(g.mode=EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB].toLowerCase());i=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val();var L=CrmEmailInitialize.ComposeMailData.from_address;try{if(L&&g.org_email&&i){g.org_email=!1;for(var I=L.length,D=0;D<I;D++)if((L[D].email.includes(i)||EmailSendingUtil.OrgEmailArray.contains(i))&&"org_email"===L[D].type){g.org_email=!0;break}}}catch(e){g.org_email=!0}if(g.to=c,p&&p.length>0&&(g.cc=p),E&&E.length>0&&(g.bcc=E),g.subject=a,EmailActionHandling&&EmailActionHandling.source&&EmailComposeUtil.CURRENT_TAB&&(g.source=EmailActionHandling.source.get(EmailComposeUtil.CURRENT_TAB)),r&&r.length>0&&(g.attachments=r),s&&EmailActionHandling.draftContent.templateId===s?EmailActionHandling.draftContent.content===t&&EmailActionHandling.draftContent.subject===a&&(g.template_id=s):g.template_id=s,m&&(g.scheduled_time=m),g.mail_format="richEditor"===editor.getEditorMode()?"html":"text","text"===g.mail_format)g.plainTextContent=t;else{if(CrmEmailInitialize.ComposeMailData&&CrmEmailInitialize.ComposeMailData.features_available&&CrmEmailInitialize.ComposeMailData.features_available.isComposeShiftChangeEnabled)try{var w=(new DOMParser).parseFromString(t,"text/html");if(w.body){var N=document.createElement("div");for(N.style.fontSize="13px";w.body.firstChild;)N.appendChild(w.body.firstChild);w.body.appendChild(N)}else{var B=document.createElement("div");B.style.fontSize="13px",w.appendChild(B)}t=w.documentElement.outerHTML}catch(e){murphy.error(e)}g.content=t}EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]&&(g.data_subject_request=EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]),(EmailSendingUtil.consentEmail||EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB])&&(g.consent_email=!0);var F=document.getElementById("msgId_"+EmailComposeUtil.CURRENT_TAB).value,P=document.getElementById("sendMailType_"+EmailComposeUtil.CURRENT_TAB).value,k=document.getElementById("enc_msgId_"+EmailComposeUtil.CURRENT_TAB).value,O=$("#enc_threadId_"+EmailComposeUtil.CURRENT_TAB).val(),x=!1;try{x="reply"===EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]||"replyAll"===EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]}catch(e){murphy.error(e)}if(F&&P===EmailComposeUtil.EDIT_IN_COMPOSE&&!EmailUtil.isEditInScheduleMail()?(g.message_id={},g.message_id=F):k&&x?(g.in_reply_to={},g.in_reply_to.owner={},g.in_reply_to.owner.id=EmailLaunchUtil.selectedMailOwner,g.in_reply_to.message_id=k):O&&x&&(g.in_reply_to={},g.in_reply_to.owner={},g.in_reply_to.owner.id=EmailLaunchUtil.selectedMailOwner,g.in_reply_to.message_id=O),EmailUtil.isInventoryModule()){var z=$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(),H=$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val(),j=$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val(),V=$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(),W=$("#pdf_engine_type_"+EmailComposeUtil.CURRENT_TAB).val();g.layout_id=z,g.layout_name=H,g.paper_type=j,g.view_type=V,g.pdf_engine=W}if(EmailSendingUtil.dataReqObj&&(g.data_subject_request=EmailSendingUtil.dataReqObj),EmailComposeUtil.linkToModuleSelected[EmailComposeUtil.CURRENT_TAB]){var q=EmailComposeUtil.linkedModule[EmailComposeUtil.CURRENT_TAB],Z={id:q.id,name:q.name,module:{api_name:q.module}};g.linked_record=Z}return C.push(g),e.data=C,e},EmailUtil.isInventoryModule=function(e){return EmailComposeUtil.isInventoryModule(e)},EmailUtil.validateMailData=function(){var e=editor.zEditor,i=EmailComposeUtil.getEditorContent();if(i&&i.length>16e6)return crmui.showMsgBand("error",I18n.getMsg("crm.email.char.max.msg"),5e3),!1;if(EmailComposeUtil.ComposeMailData.features_available.EMAIL_PREFERENCE&&EmailComposeUtil.ComposeMailData.features_available.mandateUnsubLink&&"plainEditor"!==editor.getEditorMode()&&-1===i.indexOf("${Unsubscribe"))return crmui.showMsgBand("error",I18n.getMsg("crm.email.preference.mandatory.unsublink.sendmail"),5e3),!1;if($("#editorMode_"+EmailComposeUtil.CURRENT_TAB).val(e.editorMode),!EmailUtil.validateEmailFieldsOfToCcBcc("ceToAddr","ceCCAddr","ceBCCAddr",EmailSendingUtil.maxLimitExceedsMsg.toCcBcc))return!1;if(!EmailUtil.validateAllEmailFields("ceToAddr",!0,EmailSendingUtil.numberOfEmailAddr,I18n.getMsg("crm.email.toaddr.empty"),I18n.getMsg("crm.email.toaddr.provide.valid")))return!1;if(!EmailSendingUtil.missedAttachmentInBody())return!1;if(!EmailUtil.validateAllEmailFields("ceCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.ccaddr.provide.valid")))return!1;if(!EmailUtil.validateAllEmailFields("ceBCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.bccaddr.provide.valid")))return!1;if(!EmailUtil.validateAllEmailFields("ceReplyToAddr",!1,1,null,I18n.getMsg("crm.email.replyaddr.provide.valid")))return!1;if($("#ceReplyToAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>1)return crmui.showMsgBand("error",maxLimitExceedMsg,5e3),!1;if(EmailUtil.isAttachmentLoading())return crmui.showMsgBand("warning",I18n.getMsg("crm.email.attach.inprogess"),5e3),!1;EmailSendingUtil.selectedEmailMatches()||EmailSendingUtil.isEntityWindow||($("#moduleName").val(""),$("#ecEntityId").val(""));var t=$("#ceSubject1_"+EmailComposeUtil.CURRENT_TAB).val();if(""===$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val().trim())return EmailComposeUtil.showSubjectInputPopup(),!1;if(t&&t.length>250){var a=I18n.getMsg("crm.email.compose.subject.len.check","250");return crmui.showMsgBand("warning",a,3e3),!1}if(EmailComposeUtil.filesFlag>0)return crmui.showMsgBand("error",I18n.getMsg("crm.email.attach.inprogess"),5e3),!1;if(editor.zEditor.totalAttachmentSize>(CrmEmailInitialize.ComposeMailData.features_available.EMAIL_ATTACHMENT_MAXLIMIT?"52428800":"10485760"))return crmui.showMsgBand("error",I18n.getMsg("crm.mail.attach.restriction.individual.error1"),5e3),!1;var l=!0;if(-1===i.search(/\$\{ConsentForm\.[a-zA-Z0-9_]+\}/)){l=!1;l=-1!==i.search(/\/crm\/MyConsentPortal\?id=([a-z0-9A-z]*)/)}if(!0===l)EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]||$("#dataPrivacyContainerDiv").html(""),$("#emc_isConsentMail").val("true"),EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]=!0;else if(EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB])return crmui.showMsgBand("error",I18n.getMsg("crm.send.consent.link.missing.message"),5e3),CustomizeEditor.mapClicks($(".ceSvgEmbedLink").closest("li")),!1;return EmailSendingUtil.composeActive=!1,!0},EmailUtil.validateAllEmailFields=function(e,i,t,a,l){var o=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB);if(0===o.length)return!0;var n=o.val().trim();return""!==n&&EmailSendingUtil.setUnameAndEmail(n,"",null,o.closest("li")),$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" .invalidEmail").length>0?(crmui.showMsgBand("error",l,5e3),!1):"ceToAddr"!==e||0!==$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length||(crmui.showMsgBand("error",a,5e3),!1)},EmailUtil.validateEmailFieldsOfToCcBcc=function(e,i,t,a){var l=$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length,o=$("#"+i+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length,n=$("#"+t+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length;if(l+o+n>EmailSendingUtil.numberOfEmailAddr)return crmui.showMsgBand("error",a,5e3),!1;var s="",m=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(),r=CrmEmailInitialize.ComposeMailData.from_address;if(r)for(var d=r.length,c=0;c<d;c++)if(r[c].email.includes(m)&&"imap"===r[c].type){s="IMAP";break}var p="IMAP"==s?10:1;return!(-1!==editor.getContent().search(/\$\{Unsubscribe\.(.*?)\}/)&&l+o+n>p)||(crmui.showMsgBand("error",I18n.getMsg("crm.email.toaddr.provide.nomore",p),3e3),!1)},EmailUtil.getUserNameWithEmail=function(e){var i=[],t=$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB).find("li");return t.length>0&&t.each((function(){if($(this).hasClass("selectedEmail")||$(this).hasClass("invalidEmail")){var e={};e.user_name=$(this).attr("username"),e.email=$(this).attr("email"),i.push(e)}})),i},EmailUtil.hideSchedulePopUp=function(){$("#etSchedulePopId,#calenDiv").addClass("hide")},EmailUtil.showCustomFreezeLayer=function(){if($("#etComposePanel").length>0){var e=editor.zEditor;e&&e.freezeLayer("show")}else{$("#composeEditor").append('<div id="z_freezeLayer" class="z_freezeLayer" style="display: block;"></div>')}},EmailUtil.removeCustomFreezeLayer=function(){var e=$(".z_freezeLayer");e&&e.remove()},EmailUtil.showEditorFreezeLayer=function(){var e=$("#etComposePanel");if(e.length>0){var i=editor.zEditor;i&&i.freezeLayer("show")}else{var t=$("#z_freezeLayer"),a=$L("body");t.length>0?t.show():(t='<div id="z_freezeLayer" class="z_freezeLayer" style="display: block;"></div>',event&&event.target&&"emcSendBtn_1"===event.target.id?a.append(t):e.append(t))}},EmailUtil.hideEditorFreezeLayer=function(){($L("#etComposePanel").length?$("#z_freezeLayer"):$("#etComposePanel #z_freezeLayer")).hide()},EmailUtil.sendingPopup=function(){EmailUtil.showEditorFreezeLayer();var e=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB),i=$("#emailEntityComposepopup");e.length>0&&(e.is(":checked")?i.html(I18n.getMsg("scheduling")+'<span id="eECDots"></span>'):i.html(I18n.getMsg("sending")+'<span id="eECDots"></span>')),EmailUtil.dots=0,setInterval(EmailUtil.animateDots,500)},EmailUtil.animateDots=function(){EmailUtil.dots<3?($("#eECDots").append("."),EmailUtil.dots++):($("#eECDots").text(""),EmailUtil.dots=0)},EmailUtil.closeSendingPopup=function(){$("#emailEntityComposepopup").html(""),EmailUtil.hideEditorFreezeLayer()},EmailUtil.newshowHideoptions=function(e,i){$(e).addClass("hide");var t=$("#ceOption_"+i+"_"+EmailComposeUtil.CURRENT_TAB);t.addClass("ceComposeMeta"),t.removeClass("hide"),$("#ecAutoCompleteContainer").addClass("hide");var a=t.find("input");if(a.val(""),"replyto"===i){var l=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB),o=l.find("option").eq(0).attr("value");l.attr("selectedval",o)}EmailComposeUtil.displayComposeMetaFields(),a.focus(),EmailSendingUtil.resizeEditorHeight(),thirdPartyUtils.bindSelect2(l)},EmailUtil.formatAttachment=function(e){var i=[];return $.each(e,(function(e,t){var a={};a[EmailComposeUtil.FILE_NAME]=t.name,a[EmailComposeUtil.FILE_ID]=t.id,""===t.service||"IMAPAttached"===t.service||"GMailAttached"===t.service||"ZMAILAttached"===t.service?a[EmailComposeUtil.SERVICE_NAME]=t.service:a[EmailComposeUtil.SERVICE_NAME]="ZFSAttached",(t.filesize||t.size)&&(a[EmailComposeUtil.FILE_SIZE]=t.filesize||t.size),i.push(a)})),i},EmailUtil.saveTempDraftDetails=function(){EmailComposeUtil.setEmailAddresses(),EmailActionHandling.setDraftDetails()},EmailUtil.initializePlainTextEditor=function(){editor.zEditor.createPlainEditor(),editor.zEditor.plainEditor.style.display="none"},EmailUtil.getSendMailURL=function(e,i,t){if(isnewCalendarBookingEnabled&&!e&&!i&&t&&t.data){if(!t.data.org_email)return delete t.data[0].org_email,t.send_mail=t.data,delete t.data,"/crm/v6/__internal/actions/send_mail";_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("attacherror"),ltPropType:"error"}})}return"/crm/v6/"+e+"/"+i+"/actions/send_mail"},EmailUtil.isReplyToAddressAdded=function(){var e=$(".ceSenderInfo");return $(".ceReceiverInfo").is(":visible")||e.is(":visible")?e.is(":visible"):$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).is(":visible")},EmailUtil.setInventoryDetails=function(e){if(e||(e=EmailComposeUtil.inventory_details),e){var i=e.inventory_template;if(i){var t=i.id,a=i.name,l=e.paper_type,o=e.view_type,n=e.pdf_engine,s=EmailComposeUtil.getFormattedAttachmentDetails(t,a);s.EDITOR_ATTACH=1,s.file_name.includes(".pdf")||(s.file_name=s.file_name+".pdf"),editor.zEditor.displayAttachment(s),$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(t),$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val(a),$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val(l),$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(o),$("#pdf_engine_type_"+EmailComposeUtil.CURRENT_TAB).val(n)}}},EmailUtil.removeAllAddedEmails=function(e){var i=$("#"+e);if(0!==i.length){var t=i.find("li"),a=$L(i.eq(0)).attr("id");if(a.includes("ceOption_cc")){EmailComposeUtil.emailPickerCalledFor[EmailComposeUtil.CURRENT_TAB]="#emailPickerCCAddr_";var l="#emailPickerCCAddr_"}else if(a.includes("ceOption_bcc")){EmailComposeUtil.emailPickerCalledFor[EmailComposeUtil.CURRENT_TAB]="#emailPickerBCCAddr_";l="#emailPickerBCCAddr_"}else{EmailComposeUtil.emailPickerCalledFor[EmailComposeUtil.CURRENT_TAB]="#emailPickerToAddr_";l="#emailPickerToAddr_"}if(0===$L("#emailPickerComponent_"+EmailComposeUtil.CURRENT_TAB).length)Lyte.Component.render("crm-email-picker-in-compose",[],l+EmailComposeUtil.CURRENT_TAB);else{var o=$L("crm-email-picker-in-compose .email_option_dropdown")[0].ltProp("query");o.includes(l)||($L(o)[0].innerHTML="",Lyte.Component.render("crm-email-picker-in-compose",[],l+EmailComposeUtil.CURRENT_TAB))}for(var n=$L("crm-email-picker-in-compose"),s=n.length,m=0;m<s;m++){var r=n.get(m).component;if(r.getData("ltPropQuery").includes(EmailComposeUtil.CURRENT_TAB))var d=r}$.each(t,(function(e,i){if(i.classList.contains("selectedEmail")){var t=i.getAttribute("emailtype");d.methods.emailAddressRemoved.call(d,t)}i.classList.contains("ecAddrEditor")||i.remove()}))}},EmailUtil.getNodeText=function(e){var i="",t=e.startContainer,a=e.endOffset;if(t)if(t.innerText)i=t.innerText;else{var l=t.wholeText,o=t.textContent;i=o===l.trim()?l:o}return i=i.substring(0,a)},EmailUtil.getProperErrorMessage=function(e,i){var t="";if(e&&e.data&&e.data[0]||e.message){if(e.message||(e=e.data[0]),e&&e.message)if(e.message.includes("permission"))t=I18n.getMsg("crm.security.error");else if(e.message.includes("Account confirmation required"))t=I18n.getMsg("crm.mail.user.not.confirmed.new");else if(e.message.includes("your maximum scheduling limit for this time period has been reached"))t=I18n.getMsg("schedule_limit_reached");else if(e.message.includes("Email Confirmation Required"))t=I18n.getMsg("crm.mail.user.email.not.confirmed");else if(e.message.includes("You have reached the daily mail usage"))t=I18n.getMsg("crm.mail.free.mail.count.exceeded");else if(e.message.includes("your organization has been blocked"))t=I18n.getMsg("crm.mail.free.mail.blocked",[RebrandLinkUtil.getProperty("SUPPORTMAILID")]);else if(e.message.includes("Have not consented to receive email")){var a="<a href="+RebrandLinkUtil.getProperty("CRM_BLOCKEDEMAIL_HELPLINK")+" target=_blank class=link> help page </a>";t=e.details.email&&"null"!==e.details.email?I18n.getMsg("crm.mail.address.blocked",["("+e.details.email+")",I18n.getMsg("crm.priv.email.consent"),a]):I18n.getMsg("crm.mail.address.blocked",["",I18n.getMsg("crm.priv.email.consent"),a])}else if(e.message.includes("The record is in stop processing"))t=I18n.getMsg("crm.email.error.sending.locked");else if(e.message.includes("cannot send an email to this customer"))t=I18n.getMsg("crm.label.emailoptout.alert.message");else if(e.message.includes("recipient email's contain one or more blocked email")){a="<a href="+RebrandLinkUtil.getProperty("CRM_BLOCKEDEMAIL_HELPLINK")+" target=_blank class=link> help page </a>";t=I18n.getMsg("crm.mail.address.blocked",["("+e.details.email+")",e.details.reason,a])}else if(e.message.includes("Compliance settings is not enabled"))t=I18n.getMsg("crm.email.consent.confirmation.title.modulediffer");else if(e.message.includes("license type does not support email scheduling"))t=I18n.getMsg("crm.email.editor.error.schedule");else if(e.message.includes("From_address_is_not_available"))t=I18n.getMsg("crm.email.label.from_address_is_not_available");else if(e.message.includes("the related id given seems to be invalid"))t=I18n.getMsg("crm.email.label.error.item_deleted_or_removed",I18n.getMsg("Record"));else{if(e.message.includes("Connectivity issue occured when sending mail via your SMTP server"))return e.details.reason;e.message.includes("File Size Exceeds")?t=I18n.getMsg("crm.attach.file.limit.msg"):e.message.includes("Error occured while processing attachments")&&e.details.reason?t=e.details.reason.replace("Could not send the email due to an issue with the attached file",I18n.getMsg("crm.transmail.error.attachment.process")+" ").replaceAll(" ' ","'"):e.message.includes("Error occured while processing attachments")?t="Error occured while processing attachments. Kindly check the file(s) again.":e.message.includes("Sorry, you cannot send mail as the record is locked.")?t=I18n.getMsg("crm.lock.email.action.restricted"):e.message.includes("Sorry, you cannot send survey as the record is locked.")&&(t=I18n.getMsg("crm.lock.survey.restricted"))}if(""!==t)return t;if(e&&e.code){var l=e.code;if(l.includes("INVALID_REQUEST")||l.includes("REQUIRED_PARAM_MISSING"))return I18n.getMsg("crm.label.xmlparseError")}}switch(i){case 400:case 403:t=e.message;break;default:t=e&&e.message?e.message:I18n.getMsg("error.unexpected")}return t=t&&"Internal Server Error"!==t?t.replace(/( api )/g," send mail "):I18n.getMsg("error.unexpected")},EmailUtil.getTemplateData=function(e,i,t,a,l,o,n,s){if(-1!==parseInt(e)){a||(a=void 0);var m="action="+EmailComposeUtil.GET_TEMPLATE_DETAIL_BY_ID+"&templateId="+e+"&module="+i+"&toAddr="+encodeURIComponent(a)+"&fromAddr="+encodeURIComponent(t)+"&entId="+l+"&editorMode="+o;$(EmailTabHomeUtil.Loading).show(),(new crmRequestPool).initiate({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:m,dataType:"json",success:function(i){var t=$(EmailTabHomeUtil.Loading);if(t.hide(),t.removeAttr("data-zcqa"),i&&"parsererror"===i.statusText&&"CScript"===n){var a={error:"template id is invalid"};return setTimeout((function(){_cruxUtils.showCustomMessage({params:{ltPropMessage:"Seems given template Id is Invalid.",ltPropType:"warning",ltPropDuration:6e3}})}),200),EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.callback&&EmailSendingUtil.isFromCscript.callback(a.error),EmailSendingUtil.isFromCscript=null,a.error}EmailSendingUtil.templateIdVsDetail[e]=i;var l=EmailSendingUtil.templateIdVsDetail[e];return EmailSendingUtil.templateData=l,editor&&editor.zEditor&&l&&EmailSendingUtil.isLoadTemplate&&EmailComposeUtil.editorLoaded&&(EmailSendingUtil.populateEditorWithTemplate(EmailSendingUtil.templateData,EmailSendingUtil.module),s&&(EmailSendingUtil.templateData.subject=s),EmailComposeUtil.setSubject(EmailSendingUtil.templateData.subject),EmailSendingUtil.isLoadTemplate=!1,EmailSendingUtil.templateData=""),editor&&editor.zEditor&&EmailSendingUtil.pdfLayoutDetails&&(EmailCompose.loadInventoryAttach(),EmailSendingUtil.pdfLayoutDetails=""),"CScript"===n&&(EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.successcallback&&EmailSendingUtil.isFromCscript.successcallback(),EmailSendingUtil.isFromCscript=null),s&&(l.subject=s),l},error:function(){if(EmailTabHomeUtil.handleAjaxAbort(),"CScript"===n){var e={error:"template id is invalid"};return setTimeout((function(){_cruxUtils.showCustomMessage({params:{ltPropMessage:"Seems given template Id is Invalid.",ltPropType:"warning",ltPropDuration:6e3}})}),200),EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.callback&&EmailSendingUtil.isFromCscript.callback(e.error),EmailSendingUtil.isFromCscript=null,e.error}}})}},EmailUtil.showMsg=function(e,i,t){crmui.showMsgBand(e,i,t);var a=$("#crm-msg");$("#composeContentPanel").append(a),a.addClass("pA")},EmailUtil.isSpecialLink=function(e){var i=!1;return validationUtils.isValidWebUrl(e)||e.indexOf("${")>=0&&(i=!0),i},EmailUtil.addRelatedListAttachment=function(e){EmailComposeUtil.tabIdVsAddingAttachmentCount.set(EmailComposeUtil.CURRENT_TAB,e?e.length:-2);for(var i=e.length,t=i,a=0,l=0;l<i;l++){var o=e[l].id,n=e[l].fileName,s=e[l].fileSize;e[l].service_name="RawZFSFile";var m=Crm.userDetails.isWorkdriveConfigured;m&&(e[l].service_name="from_record");var r="RawZFSFile";m&&(r="from_record");var d=EmailComposeUtil.getFormattedAttachmentDetails(o,n,s,r);!$("#etAtchmentPopOverallContainer_"+EmailComposeUtil.CURRENT_TAB+" #"+o).length>0?editor&&(editor.zEditor.displayAttachment(d),e[l].file_name=e[l].fileName,e[l].file_size=e[l].fileSize,editor.zEditor.totalAttachmentSize=editor.zEditor.totalAttachmentSize+parseInt(e[l].fileSize),delete e[l].fileSize,delete e[l].fileName):(e.deleteElementAt(l),l--,i--,a++)}1===t&&1===a?crmui.showMsgBand("error",I18n.getMsg("crm.email.entattach.error.duplicate"),5e3):a>0&&t>1&&crmui.showMsgBand("error",I18n.getMsg("crm.email.entattach.error.duplicate2"),5e3),e.length>0&&EmailActionHandling.saveDraftOnAttachmentAddition(e)},EmailUtil.isEditInScheduleMail=function(){var e=$("#sendMailType_"+EmailComposeUtil.CURRENT_TAB);return!!(e&&e.length>0&&e.val()===EmailComposeUtil.EDIT_IN_COMPOSE)},EmailUtil.getTimeZoneOffsetFromTextString=function(e){var i=0,t=e.match(/\GMT[\s]{1}([\-]{0,1}.*?)\)/);if(t&&t.length>0){var a=t[1].split(":"),l=Number(a[0]),o=Number(a[1]);i=-(i=l<0?60*l-o:60*l+o)}return i},EmailUtil.handleRecordLocking=function(e,i,t,a){var l=a.suggestionLi,o=$L(l).find("li"),n=o.length;if(n>1)for(var s=0;s<n;s++){var m=o[s];if(t===$L(m)[0].getAttribute("entityid"))var r=$L(m)}if(r&&e){r.addClass("invalidEmail");var d=Object.values(moduleRecordMapping).filter((function(e){return e.api_name===i}))[0];d&&d.singular_label&&(i=d.singular_label),crmui.showMsgBand("error",I18n.getMsg("crm.email.label.error.record.restricted",[i,a.record_name]),3e3)}},EmailUtil.isRecordLockedAndMailRestricted=function(e,i,t,a){var l=[];moduleRecordMapping[e]&&(e=moduleRecordMapping[e].api_name),store.findAll("record_locking_configurations",{module:e}).then((function(o){for(var n=o.length,s=0;s<n;s++){var m=o[s];if(m&&m.restricted_communications)for(var r=m.restricted_communications,d=r.length,c=0;c<d;c++)if(r[c].includes("send_mail"))if("all_profiles"===m.locked_for)l.push(m.id);else{for(var p=m.lock_excluded_profiles?m.lock_excluded_profiles.length:0,E=!0,u=0;u<p;u++){if(m.lock_excluded_profiles[s].name===Crm.userDetails.PROFILE_NAME){E=!1;break}}E&&l.push(m.id)}}l.length>0&&store.findAll("dummy",void 0,!1,!1,{url:"/crm/v2.2/"+e+"/"+i+"/Locking_Information__s",method:"GET"}).then((function(o){for(var n=o.data,s=n.length,m=0;m<s;m++){var r=n[m];if(l.contains(r.Record_Locking_Configuration_Id__s)){t&&t(!0,e,i,a);break}}}))}))};var CrmEmailInitialize={sessionStorageDetails:void 0,isInitialResourcesLoaded:!1,editorLoaded:!1,ComposeMailData:void 0,initialize:function(){CrmEmailInitialize.PopulateComposeMailData(),CrmEmailInitialize.LoadResource_EmailCompose()},LoadResource_EmailCompose:function(){CrmEmailInitialize.setMaximizeMinimizeButton()},PopulateComposeMailData:function(e,i,t){var a={"X-ZOHO-SERVICE":"crm","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid};(new crmRequestPool).initiate({url:"/crm/v2/__internal/__emailcompose_meta",type:"GET",headers:a,content:"application/json",success:function(a){CrmEmailInitialize.ComposeMailData=a.data[0],CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isNewEditor=!!CrmEmailInitialize.ComposeMailData.features_available.inline_compose_window,Crm.userDetails.isComposeAutoSuggestionEnabled=CrmEmailInitialize.ComposeMailData.features_available.auto_suggestion,EmailComposeUtil.editorLoaded&&editor&&editor.zEditor),i?EmailCompose.launchEmailCompose(e,t):e&&e(CrmEmailInitialize.ComposeMailData)},error:function(){CrmEmailInitialize.ComposeMailData={}}})}};$(document).ready((function(){CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isNewEditor=!!CrmEmailInitialize.ComposeMailData.features_available.inline_compose_window)})),CrmEmailInitialize.setMaximizeMinimizeButton=function(){setTimeout((function(){var e=$("#maxComposeBtn");if(e){var i=sessionStorage.getItem("draftDetails");(i=JSON.parse(i))?(delete i.undefined,"null"!==i&&0!==Object.keys(i).length&&(EmailComposeUtil.loadI18nResources(),EmailLaunchUtil.sessionStoredDraftDetails=i,EmailLaunchUtil.isDraftDtailsStoredInsession=!0,e.removeClass("hide"),"undefined"!=typeof CrmPlusImpl&&("undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof isZohoOneUser&&"true"===isZohoOneUser)&&CrmPlusImpl.handleDraftMailIcon(!0))):EmailLaunchUtil.isDraftDtailsStoredInsession=!0}}),5e3)};var EmailLaunchUtil={sessionStoredDraftDetails:void 0,isInitialResourceLoaded:!1,postResourceLoadInitialization:void 0,isDraftDtailsStoredInsession:!1,selectedMailOwner:0,tempSource:"",SendMailEvent:function(e,i,t,a){if(EmailCompose.closeSmartPrompt(),EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.SendMailEvent(e,i,t,a);else{var l=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=l,Lyte.injectResources(l,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.SendMailEvent(e,i,t,a)}))}},sendMailEventForInventoryModule:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.sendMailEventForInventoryModule(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailSendingUtil.entityId=i,EmailCompose.sendMailEventForInventoryModule(e,i,t)}))}},launchReplyMail:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.launchReplyMail(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.launchReplyMail(e,i,t)}))}},editScheduleMail:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.editScheduleMail(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.editScheduleMail(e,i,t)}))}},fetchDraftDetails:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.fetchDraftDetails(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.fetchDraftDetails(e,i,t)}))}},openComposeWindow:function(e,i,t,a,l,o,n,s,m,r,d){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.openComposeWindow(e,i,t,a,l,o,n,s,m,r,d);else{var c=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=c,Lyte.injectResources(c,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.openComposeWindow(e,i,t,a,l,o,n,s,m,r,d)}))}},restoreComposePopup:function(){if(!$("#profileEditPopup").hasClass("zcrm-show")&&!$("#localeEditPopup").hasClass("zcrm-show"))if(EmailLaunchUtil.isInitialResourceLoaded){EmailComposeUtil.hideAllComposeRelatedPopup();var e=$L("#templatePreviewDIV"),i=$L(".z_freezeLayer");e&&e.length>0&&i||EmailComposeUtil.removeCustomFreezeLayer(),EmailComposeUtil.restoreComposePopup()}else{var t=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=t,Lyte.injectResources(t,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailComposeUtil.sessionStoredDraftDetails=EmailLaunchUtil.sessionStoredDraftDetails,EmailComposeUtil.restoreComposePopup()}))}},getApiNameForModule:function(e){var i=Crm.userDetails.MODULE_LIST[e],t=e;return i&&(t=i.api_name),t},launchComposeMailWithSurvey:function(){EmailLaunchUtil.tempSource="survey",EmailUtil.setSignature(EmailComposeUtil.ComposeMailData.default_from.email),EmailComposeUtil.editorContent&&editor.setContent(EmailComposeUtil.editorContent),ZSurvey.insertText()},showHideFromRecord:function(){var e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),i=$("#module");!e&&i.val()&&(e=i.val()),e&&store.findAll("related_list",{module:EmailComposeUtil.getApiNameForModule(e)},!0).then((function(e){var i=$L(".emailComposeUploadOptionsMenu [data-value=fromrecord]");0===e.filter((function(e){return"ATTACHMENTSPERSONALITY"===e.personality_name&&!1===e.visible})).length?i.removeClass("hide"):i.addClass("hide")}))},getInitialResources:function(){var e=networkUtils.getI18nJSUrl("emailcompose"),i=networkUtils.getI18nJSUrl("emaileditor"),t=networkUtils.getI18nJSUrl("emailsRelatedList"),a=networkUtils.getI18nJSUrl("EmailFooterCommon"),l=networkUtils.getI18nJSUrl("activityv2"),o=networkUtils.getI18nJSUrl("ThreadSummaryAndTranslation"),n=[e,i,t,a,l,networkUtils.getI18nJSUrl("FeedbackMechanism"),o];Lyte.injectResources(networkUtils.returnDependencyFiles(n,ResourceConstants.CRM),void 0,void 0);var s=networkUtils.returnDependencyFiles(["inlineEmailCompose_min.js","zohocrm_mailClient.js"],ResourceConstants.CRM).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.js"],ResourceConstants.CRMClient)).concat(networkUtils.returnDependencyFiles(["lyte-draggable.js"],ResourceConstants.CRMClient));s=(s=s.concat(networkUtils.returnDependencyFiles(["email-emotions.js","crm-emails-related-list.js","zia-notification-settings.js"],ResourceConstants.CRMClient))).concat(networkUtils.returnDependencyFiles(["email-footer-common-utils.js"],ResourceConstants.CRMClient));var m=networkUtils.returnDependencyFiles(["inline_ComposeEditor_min.css"],ResourceConstants.CRM).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.css"],ResourceConstants.CRMClient)),r=[];return featuresAvailable.WRITING_ASSISTANT&&(r=r.concat(networkUtils.returnDependencyFiles(["crm-zia-writing-assistant.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT))),r=r.concat(networkUtils.returnDependencyFiles(["crm-zia-writing-assistant-mixin.js","crm-zia-writing-assistant.js"],ResourceConstants.CRMClient)),(s=s.concat(r)).concat(m)},isComposeActive:function(){var e=!1;return EmailLaunchUtil.isInitialResourceLoaded&&(e=EmailSendingUtil.composeActive),e}};!function(){var e=Handlebars.template,i=Handlebars.templates=Handlebars.templates||{};i.AddLinkForEmailCompose=e({compiler:[7,">= 4.0.0"],main:function(e,i,t,a,l){var o,n=null!=i?i:{},s=e.escapeExpression;return'<div class="addLinkPop" id="addLinkPop" style="display:none;" value=""> <div class="ze_pop_header pB20 removeForSalesIqLink" style="height: 30px;"> <h4 class="pL0 pT0 crm-heading-font-size" id="addLinkName"></h4> </div> <div class="mB20 zclnktab" id="zp_ConsentFormtab" style="display:none;"> <div class="textFld tabDivCreate newmandatory crm-font-regular" id="edtConsentFormLink"> \x3c!--shreddercss dynamicselectors #edtConsentFormLink ,#ConsentFormSelectValDiv,#zp_AddLinkCancel,#zp_unsubscribetab,#edtUnsubLink,#unsubSelectValDiv,#zp_DataRequesttab,#DataRequestLanguageSelectValDiv,#DataRequestSelectValDiv#siqTrackingEnabledURL --\x3e <div class="labelTabCreate pT0 pB0 pR fL crm-base-font-size">'+s(t.getI18n.call(n,"crm.consent.language",{name:"getI18n",hash:{},data:l}))+'</div> <div class="labelValCreate pB0 pR pT0 fL cP crm-base-font-size" id="ConsentFormSelectValDiv" onclick="inSplnk.fnLanguageList(\'addLinkPop\', event,\'ConsentFormSelectValDiv\');"> <span class="dIB pR pR25 mT3" id="ConsentFormSelectVal" value="">'+s(t.getI18n.call(n,"crm.select",{name:"getI18n",hash:{},data:l}))+'</span> </div> <span class="errMsg" id="errorMsgSelectLink" style="display: none;">'+s(t.getI18n.call(n,"crm.ConsentForm.select.alert",{name:"getI18n",hash:{},data:l}))+'</span> <div class="cBoth"></div> </div> </div> <div class="mB20 zclnktab crm-font-regular"" id="zp_SalesIqLink" style="display:none;"> <span class=" dIB vaM" id="popupHead">'+s(t.getI18n.call(n,"crm.salesiq.insert.label.link",{name:"getI18n",hash:{},data:l}))+"</span> <div class='textFld tabDivCreate m0 newmandatory' id='ze_lnkUrlTab'> <div class='labelTabCreate pL5 pR fL crm-base-font-size'> <label>"+s(t.getI18n.call(n,"zc.editor.enter.weburl",{name:"getI18n",hash:{},data:l}))+"</label> </div> <div class=\"labelValCreate no-hvr-ln fL crm-font-regular crm-base-font-size\" style=\"border-bottom: 1px solid transparent !important;\"> <input id='ze_lnkurl' data-zcqa='ze_linkUrl' type='text' placeholder='http://www.example.com' style=\"border: 0 none; width: 95%;\" onkeyup='EmailSendingUtil.fnUpdateSIQTracking();' onblur='EmailSendingUtil.fnUpdateSIQTracking();'/> </div> <span class='errMsg' id='errMsgUrl' style='display: none;'></span> <div class='cBoth'></div> </div> <div class=\"tabDivCreate\"> <div class=\"labelTabCreate pL5 fL crm-base-font-size\" style=\"width: 100%;\"><span>"+s(t.getI18n.call(n,"zc.editor.salesiq.param.hint",{name:"getI18n",hash:{},data:l}))+'</span></div> </div> <div class="tabDivCreate"> <div> \x3c!--textarea readonly="" id="siqTrackingEnabledURL" value="" class="sIq_txtAra" style=" width: 95%;min-height: 60px;resize: vertical; padding: 10px; line-height: 20px;overflow: auto;border: 1px dashed var(--br_c0c6cc); color: var(--labelColor);transition: all .2s ease-in-out;background: #EDF0F4;font-size: var(--crm-extra-medium-font-size);"></textarea--\x3e <div  id="siqTrackingEnabledURL" class="sIq_txtAra" data-zcqa="siqTrackingEnabledURL"> <span id="siq_Url"></span><span id="siq_trackingParam" class="siq_trackingParam"></span> </div> </div> </div> </div> <div class="mB20 zclnktab" id="zp_DataRequesttab" style="display:none;"> <div class="textFld edtDataRequestLink mB20" style="border: none;" > <div class="labelTabCreate pT0 pB0 pR fL newmandatory">'+s(t.getI18n.call(n,"crm.datarequest.type",{name:"getI18n",hash:{},data:l}))+'</div> <div class="labelValCreate pB0 pR pT0 fL" id="DataRequestSelectValDiv"> '+(null!=(o=e.invokePartial(a.DataRequestLinkTypes,null!=i?i.types:i,{name:"DataRequestLinkTypes",data:l,helpers:t,partials:a,decorators:e.decorators}))?o:"")+' </div> <div class="cBoth"></div> </div> <div class="textFld tabDivCreate newmandatory" > <div class="labelTabCreate pT0 pB0 pR fL">'+s(t.getI18n.call(n,"crm.label.language",{name:"getI18n",hash:{},data:l}))+'</div> <div class="labelValCreate pT0 pB0 pR fL cP" id="DataRequestLanguageSelectValDiv" onclick="inSplnk.fnLanguageList(\'addLinkPop\', event,\'DataRequestLanguageSelectValDiv\');"> <span class="dIB pR pR25 mT3" id="DataRequestLanguageSelectVal" value="">'+s(t.getI18n.call(n,"crm.select",{name:"getI18n",hash:{},data:l}))+'</span> </div> <span class="errMsg" id="errorMsgDataRequestLink" style="display: none;">'+s(t.getI18n.call(n,"crm.datarequest.lang.select.alert",{name:"getI18n",hash:{},data:l}))+'</span> <div class="cBoth"></div> </div> </div> <div class="mB20 zclnktab" id="zp_unsubscribetab" style="display:none;"> <div class="textFld tabDivCreate newmandatory" id="edtUnsubLink"> <div class="labelTabCreate pT0 pB0 pR fL">'+s(t.getI18n.call(n,"crm.unsubscription.link",{name:"getI18n",hash:{},data:l}))+'</div> <div class="labelValCreate pR pT0 fL cP" id="unsubSelectValDiv" onclick="inSplnk.showUnsubscriptionList(\'addLinkPop\', event,\'unsubSelectValDiv\',false);"> <span class="dIB pR pR25 mT3" id="unsubSelectVal" value="">'+s(t.getI18n.call(n,"crm.select",{name:"getI18n",hash:{},data:l}))+'</span> </div> <span class="errMsg" id="errorMsgUnsubSelectLink" style="display: none;">'+s(t.getI18n.call(n,"crm.unsubscription.select.alert",{name:"getI18n",hash:{},data:l}))+'</span> <div class="cBoth"></div> </div> </div> <div class="ze_botpart pB0 fR"> <input type="button" value="'+s(t.getI18n.call(n,"crm.button.cancel",{name:"getI18n",hash:{},data:l}))+'" id="zp_AddLinkCancel" data-zcqa="zp_AddLinkCancel" class="newgraybtn" onclick="CustomizeEditor.hideAddLinkPop();"> <input type="button" value="'+s(t.getI18n.call(n,"crm.button.save",{name:"getI18n",hash:{},data:l}))+'" id="zp_AddLinkSave" data-zcqa="zp_AddLinkSave" class="primarybtn" onclick="CustomizeEditor.saveLink();"> </div> </div> <div class="ConsentLanguages pA crm-font-regular crm-base-font-size drpDwn" style="z-index:1002;display: none;"></div> <div class="unsubsList pA crm-font-regular crm-base-font-size drpDwn" style="z-index:1002;display: none;"></div> <div class="ze_freeze" id="custom_freeze" style="z-index:30;display:none;"></div> <div class="zcrm-modal zcrm-effect w500" id="existingLinkRemoveConfirm" value=""> <div class="zcrm-content"> <div class="popup-model-content pB0"> <div id="removeConfInfo"></div> </div> <div class="popup-model-footer"> <input type="button" value="'+s(t.getI18n.call(n,"crm.button.cancel",{name:"getI18n",hash:{},data:l}))+'" data-zcqa="zp_ConsentFormlinkCancel" class="newgraybtn" onclick="CustomizeEditor.hideLinkRemoveConfirm();"> <input type="button" value="'+s(t.getI18n.call(n,"crm.button.remove",{name:"getI18n",hash:{},data:l}))+'" data-zcqa="zp_ConsentFormlinkSave" class="redbtn" onclick="CustomizeEditor.linkRemoveConfirmation();"> </div> </div> </div> <div class="existCheckPop zclnktab" id="existCheckPop" style="display:none;"> <div class="pT0" style="height: 30px;"> <span class="ze_closeimg" onclick="CustomizeEditor.hideExistCheckPop();"></span> <h4 class="pL0 pT0 mT0 pB0" id="existCheckPopHead"></h4> </div> <div id="existCheckPopMsg"></div> </div> '},usePartial:!0,useData:!0}),i.DataRequestLinkTypes=e({1:function(e,i,t,a,l){var o=e.lambda,n=e.escapeExpression;return' <li class="DataReqLi"> <label class="p0 mR5 cP"> <input type="checkbox" class="DataReqChkbx hide" data-param="'+n(o(null!=i?i.param:i,i))+'" onclick="inSplnk.selectDataRequest(this)"> <span class="mR10 fL mT1 ecwCheckBx"></span> <span class="cP p0 crm-base-font-size fL ecwCheckBx">'+n(o(null!=i?i.value:i,i))+"</span> </label> </li> "},compiler:[7,">= 4.0.0"],main:function(e,i,t,a,l){var o,n=null!=i?i:{},s=e.escapeExpression;return'<div class="DataRequestList mT0 ecwComposeDataReq" id="DataRequestList" style="border: 1px solid var(--br_EDF0F4);width: 98%;"> <div class="surProfRoleAll bg_crmBg2 cP" id="selectAllRequestOpt"> <label class="p0 cP fL mT3 mR5"> <input type="checkbox" class="DataReqChkbxAll hide" onchange="inSplnk.selectAllDataRequest(this)"> <span class="mR10 fL mT1 ecwCheckBx"></span> <span class="cP p0 crm-base-font-size fL ecwCheckBx">'+s(t.getI18n.call(n,"crm.select.all",{name:"getI18n",hash:{},data:l}))+'</span> <div class="cBoth"></div> </label> <div class="cBoth"></div> </div> <ul class="m0" style="display:block;color: var(--baseColor) !important;"> '+(null!=(o=t.each.call(n,null!=i?i.data:i,{name:"each",hash:{},fn:e.program(1,l,0),inverse:e.noop,data:l}))?o:"")+' </ul> </div> <span class="errMsg" id="errorMsgDataRequestType" style="display: none;position: relative;">'+s(t.getI18n.call(n,"crm.datarequest.datareq.select.alert",{name:"getI18n",hash:{},data:l}))+"</span>"},useData:!0}),i.dataRequestLink=e({compiler:[7,">= 4.0.0"],main:function(e,i,t,a,l){var o,n=null!=i?i:{},s=e.escapeExpression;return'<div class="mT10 mB30 zclnktab" id="ze_DataRequesttab" style=\'display:none;\'> <div class="textFld borderNone edtDataRequestLink" id="edtDataRequestLink"> <div class="labelTabCreate newmandatory pL5 pR fL">'+s(t.getI18n.call(n,"crm.datarequest.type",{name:"getI18n",hash:{},data:l}))+'</div> <div class="labelValCreate fL" id="DataRequestSelectValDiv" style="min-height: 45px;"> '+(null!=(o=e.invokePartial(a.DataRequestLinkTypes,null!=i?i.types:i,{name:"DataRequestLinkTypes",data:l,helpers:t,partials:a,decorators:e.decorators}))?o:"")+' </div> <div class="cBoth"></div> </div> <div class="textFld tabDivCreate newmandatory" id="edtDataRequestLanguage"> <div class="labelTabCreate pL5 pR fL">'+s(t.getI18n.call(n,"crm.label.language",{name:"getI18n",hash:{},data:l}))+'</div> <div class="labelValCreate fL cP" id="DataRequestLanguageSelectValDiv" onclick="inSplnk.fnLanguageList(\''+s(t.encodeJS.call(n,null!=i?i.editorName:i,{name:"encodeJS",hash:{},data:l}))+'\', event,\'DataRequestLanguageSelectValDiv\');"> <span class="dIB pR pR25" id="DataRequestLanguageSelectVal" value="">'+s(t.getI18n.call(n,"crm.select",{name:"getI18n",hash:{},data:l}))+'</span> </div> <span class="errMsg" id="errorMsgDataRequestLink" style="display: none;">'+s(t.getI18n.call(n,"crm.datarequest.lang.select.alert",{name:"getI18n",hash:{},data:l}))+'</span> <div class="cBoth"></div> </div> </div> '},usePartial:!0,useData:!0})}();var mergeFieldsConstants={variable:"variable",system:"system",custom_lookup:"custom_lookup",system_module_lookup:"system_module_lookup",system_field_lookup:"system_field_lookup",unrelated_module:"unrelated_module",polymorphic_lookup:"polymorphic_lookup",subform_module:"subform_module",fromlabel_to_api:"labeltoapi",fromlabel_to_id:"labeltoid",fromapi_to_label:"apitolabel",Lookup:"Lookup:",mxn_lookup:"mxn_lookup",multilevel_lookup:"multilevel_lookup",mxn:"mxn"},CrmConvertMergeFields={getUnsupportedMergeFields:function(e,i,t,a){var l,o=new RegExp(/\$\{([^\{|^\}]*)\}/g);a&&(o=new RegExp(/\#\{([^\{|^\}]*)\}/g));var n="${"+I18n.getMsg("crm.template.email.unsupported.merge.field")+"}",s=[];for((e.indexOf("${Unsupported_Field}")>-1||e.indexOf(n)>-1)&&s.push(n);l=o.exec(e);){var m=l[0],r=l[1].split("."),d=r[0];if("ZSURVEY"===d||"Datarequest"===d)CrmConvertMergeFields.isModuleAvail(t,d)||s.push(m);else if(r.length>1){CrmConvertMergeFields.getModuleAndFieldInfo(t,r,i)||CrmConvertMergeFields.isCampaignsWebinarUrlMergeField(m,t,i)||s.push(m)}else"userSignature"!==d&&"companyLogo"!==d&&"serialNumber"!==d&&s.push(m)}return s},getFieldsUsedInContent:function(e,i,t,a,l){var o,n=[],s=new RegExp(/\$\{([^\{|^\}]*)\}/g);for(l&&(s=new RegExp(/\#\{([^\{|^\}]*)\}/g));o=s.exec(e);){var m=o[1].split("."),r=m[0];if("Datarequest"!==r&&"ZSURVEY"!==r&&m.length>1){var d=CrmConvertMergeFields.getModuleAndFieldInfo(t,m,i);if(d){var c=d.field,p=c.data_type;if(a&&!a.includes(p))continue;n.push(c)}}}return n},getFieldsUsedInContent:function(e,i,t,a,l){var o,n=[],s=new RegExp(/\$\{([^\{|^\}]*)\}/g);for(l&&(s=new RegExp(/\#\{([^\{|^\}]*)\}/g));o=s.exec(e);){var m=o[1].split("."),r=m[0];if("Datarequest"!==r&&"ZSURVEY"!==r&&m.length>1){var d=CrmConvertMergeFields.getModuleAndFieldInfo(t,m,i);if(d){var c=d.field,p=c.data_type;if(a&&!a.includes(p))continue;n.push(c)}}}return n},convertMergeFieldsAsRequiredFormat:function(e,i,t,a,l,o){var n=new RegExp(/\$\{([^\{|^\}]*)\}/g);l&&(n=new RegExp(/\#\{([^\{|^\}]*)\}/g));for(var s,m,r=0,d=e;m=n.exec(e);){var c=m[0],p=m[1].split("."),E=p[0];if(i===mergeFieldsConstants.fromapi_to_label&&(E=E.substring(1)),"Datarequest"!==E&&"ZSURVEY"!==E)if(CrmConvertMergeFields.isCampaignsWebinarUrlMergeField(c,t,i)){var u=CrmConvertMergeFields.getCampaignsWebinarUrlMergeField(t,i);s=c.length,o&&i===mergeFieldsConstants.fromapi_to_label&&(u=$ESAPI.encoder().encodeForHTML(u)),d=d.substring(0,m.index+r)+u+d.substring(n.lastIndex+r),r+=u.length-s}else if(p.length>1){var C=CrmConvertMergeFields.getModuleAndFieldInfo(t,p,i);if(C){var g=C.module,U=C.field,h=C.lookuprelfield;s=c.length;var v=CrmConvertMergeFields.getConvertedMergeField(g,U,h,i,a,l,C.multiLevelModule,C.parentMod,t.mergefields);o&&i===mergeFieldsConstants.fromapi_to_label&&(v=$ESAPI.encoder().encodeForHTML(v)),d=d.substring(0,m.index+r)+v+d.substring(n.lastIndex+r),r+=v.length-s}}else if("userSignature"===E||"companyLogo"===E||"serialNumber"===E||"${Current Record}"===e||"${!CURRENTRECORD}"===e){s=c.length;var f=l?"#{":"${";if(f=i===mergeFieldsConstants.fromlabel_to_api?f+"!":f,i===mergeFieldsConstants.fromlabel_to_api&&"${Current Record}"===e)return"${!CURRENTRECORD}";if(i===mergeFieldsConstants.fromapi_to_label&&"${!CURRENTRECORD}"===e){if(U=wfmergefield.getFieldObj(wfmergefield.getMainModule(),"CURRENTRECORD"))return f+U.field_label+"}"}else v=f+E+"}";d=d.substring(0,m.index+r)+v+d.substring(n.lastIndex+r),r+=v.length-s}}return d},getConvertedMergeField:function(e,i,t,a,l,o,n,s,m){var r,d,c,p,E,u,C,g=CrmConvertMergeFields.getReplaceField(i,a);if(CrmConvertMergeFields.isStaticField(i)){if(a===mergeFieldsConstants.fromlabel_to_id)return"${"+i.id+"}";if(a===mergeFieldsConstants.fromapi_to_label)return"${"+i.field_label+"}"}if(g){var U,h,v,f,T,S,_,A=e.type,R=e.display_name,b=e.api_name,y=e.name,M=e.id,L=e.lookup_details;if(L&&(U=e.parent_module_api_name,h=L.api_name,v=L.display_label,f=L.id,c=A===mergeFieldsConstants.custom_lookup||A===mergeFieldsConstants.system_field_lookup,p=A===mergeFieldsConstants.subform_module||A===mergeFieldsConstants.system_module_lookup||A===mergeFieldsConstants.custom_lookup||A===mergeFieldsConstants.system_field_lookup,d=A===mergeFieldsConstants.polymorphic_lookup,E=A===mergeFieldsConstants.mxn_lookup,u=!(!n||!s),c&&a===mergeFieldsConstants.fromapi_to_label)){var I=CrmConvertMergeFields.getModuleObjectByApiName(e.parent_module_api_name,m);if(I&&CrmConvertMergeFields.isKioskModule(I.name))R=CrmConvertMergeFields.getModuleObjectByApiName(e.api_name,m).display_name,C=!0}t&&(u?(U=s.api_name,h=e.api_name,b=t.api_name,S=void 0,R=n.display_name):(T=t.api_name,S=t.field_label,_=t.id)),A===mergeFieldsConstants.variable&&a===mergeFieldsConstants.fromlabel_to_id&&(y=M);var $=o?"#{":"${";if(a===mergeFieldsConstants.fromlabel_to_id)r=u?$+U+"."+h+"."+b+"."+g+"}":E?$+U+"."+f+"."+g+"}":c?$+mergeFieldsConstants.Lookup+f+"."+g+"}":$+y+(_?"."+_:"")+"."+g+"}";else if(a===mergeFieldsConstants.fromapi_to_label)if(l){var D=CrmConvertMergeFields.getConvertedMergeField(e,i,t,mergeFieldsConstants.fromlabel_to_api,!1,o,void 0,void 0,m),w=document.createElement("span");w.setAttribute("value",D),w.contentEditable=!1;var N="";N=c?mergeFieldsConstants.Lookup+v+" - "+g:R+(S?" - "+S:"")+" - "+g,"variable"===e.type&&"Deluge"===wfmergefield.actionName&&(N=I18n.getMsg("crm.crmvariables.new",Crm.appName)+" - "+N),w.textContent=N,w.style.color="var(--linkColor)",w.setAttribute("class","mergespan"),w.title=N,r=w.outerHTML}else r=c?C?$+R+"."+g+"}":$+mergeFieldsConstants.Lookup+v+"."+g+"}":E?$+U+"."+v+"."+g+"}":$+R+(S?"."+S:"")+"."+g+"}";else a===mergeFieldsConstants.fromlabel_to_api&&(u&&(r=$+"!"+U+"."+h+"."+b+"."+g+"}"),r=E&&U?$+"!"+U+"."+h+"."+g+"}":d&&U?$+"!"+U+"."+h+"->"+b+"."+g+"}":p&&U?$+"!"+U+"."+h+"."+g+"}":$+"!"+b+(T?"."+T:"")+"."+g+"}")}return r},isStaticField:function(e){return["CURRENTRECORD"].indexOf(e.id)>=0},getModuleAndFieldInfo:function(e,i,t){var a,l,o=i.length,n=0,s=i[0],m=!1;t===mergeFieldsConstants.fromapi_to_label&&(s=s.substring(1)),t!==mergeFieldsConstants.fromlabel_to_api&&t!==mergeFieldsConstants.fromlabel_to_id||s.startsWith(mergeFieldsConstants.Lookup)&&(s=s.substring(7),m=!0);var r=!1;do{var d=CrmConvertMergeFields.getModuleandFieldsObj(e,s,m,!1,!1,t);if(a=d,d){var c=n+1,p=i[c];if(p=CrmConvertMergeFields.replaceHtmlEncodedChars(p),t===mergeFieldsConstants.fromapi_to_label){var E=p.split("->");if(E.length>1)d=CrmConvertMergeFields.getModuleandFieldsObj(e,E[1],!1,!1,!1,t),p=i[++c];else if(!CrmConvertMergeFields.isMultiLevelAllowed(d.module.name)){var u=CrmConvertMergeFields.getFieldObject(d,p,t);if(u&&u.lookup_module){var C=u.api_name,g=CrmConvertMergeFields.getModuleandFieldsObj(e,u.lookup_module.api_name,!1,!1,!0,mergeFieldsConstants.fromapi_to_label,C);g&&c<o-1&&(d=g,p=i[++c])}}}if(d){var U=d.module;if("mxn"===U.type&&o>2){s=i[1];m=!0,n++;continue}var h=CrmConvertMergeFields.getFieldInfoFromFieldPart(e,d,p,t,i,c,o);if(h)(t!==mergeFieldsConstants.fromlabel_to_api||U.lookup_details&&U.type!==mergeFieldsConstants.custom_lookup&&U.type!==mergeFieldsConstants.system_field_lookup||U.lookup_details&&i[0].startsWith(mergeFieldsConstants.Lookup)||!U.lookup_details&&!i[0].startsWith(mergeFieldsConstants.Lookup))&&(r=!0),r&&((l=h).module=U,h.multiLevelModule&&(l.parentMod=a.module,n++));else if("Unsubscribe"===U.name){var v=CrmConvertMergeFields.getUnsubscribeFieldInfo(t,p);v&&((l=v).module=U)}}}s+="."+i[++n]}while(n<o-1&&!r);return l},getFieldInfoFromFieldPart:function(e,i,t,a,l,o,n){var s,m,r=CrmConvertMergeFields.getFieldObject(i,t,a);if(r&&r.lookup_module&&o<n-1){var d=!r.lookup_module.mutilevel_lookup&&!i.module.kiosk_module;i=CrmConvertMergeFields.getModuleandFieldsObj(e,r.lookup_module.api_name,!1,d,!1,mergeFieldsConstants.fromapi_to_label),m=r,r=void 0,t=""}return r&&o===n-1?(s={}).field=r:o<n-1&&i&&(""!==t&&(t+="."),t+=l[++o],(s=CrmConvertMergeFields.getFieldInfoFromFieldPart(e,i,t,a,l,o,n))&&m&&(s.lookuprelfield=m,i.module.type===mergeFieldsConstants.multilevel_lookup&&(s.multiLevelModule=i.module))),s},isModuleAvail:function(e,i){var t,a,l=e.mergefields;if(l)for(var o=l.length,n=0;n<o;n++){if((t=l[n]).module.name===i){a=!0;break}}return!!a&&t},getModuleandFieldsObj:function(e,i,t,a,l,o,n){var s,m=!1;i=CrmConvertMergeFields.replaceHtmlEncodedChars(i);var r=e?e.mergefields:e;a&&(void 0===(r=e.lookuprelmergefields)&&template&&template.fetchMergeFieldsAPIJson&&(r=template.fetchMergeFieldsAPIJson(i).mergefields));if(r)for(var d=r.length,c=0;c<d;c++){var p=(s=r[c]).module;if("Datarequest"!==p.name){var E=p.api_name;"Execution_Info"!==E||"Execution_Info"!==i&&"Execution Info"!==i||(E=i);var u,C,g=p.display_name,U=p.name,h=p.lookup_details;if(h&&(u=h.display_label,C=h.api_name),o===mergeFieldsConstants.fromapi_to_label){if(E===i){if(!l){m=!0;break}if(p.type!==mergeFieldsConstants.system_module_lookup&&p.type!==mergeFieldsConstants.subform_module&&p.type!==mergeFieldsConstants.custom_lookup&&p.type!==mergeFieldsConstants.system_field_lookup)continue;if(!n){m=!0;break}if(l&&n===C){m=!0;break}}else if(C===i&&p.type===mergeFieldsConstants.mxn_lookup){m=!0;break}}else if(o===mergeFieldsConstants.fromlabel_to_api||o===mergeFieldsConstants.fromlabel_to_id)if(t){if(u===i){m=!0;break}}else{if(g===i){m=!0;break}if(p.type===mergeFieldsConstants.mxn&&(U===i||E===i)){m=!0;break}}}}return m?s:void 0},getFieldObject:function(e,i,t){var a,l=e.sections,o=l.length,n=t===mergeFieldsConstants.fromlabel_to_api,s=t===mergeFieldsConstants.fromlabel_to_id,m=t===mergeFieldsConstants.fromapi_to_label,r=!1;i=CrmConvertMergeFields.replaceHtmlEncodedChars(i);for(var d=CrmConvertMergeFields.isKioskModule(e.module.name),c=0;c<o;c++){for(var p=l[c].fields,E=p.length,u=0;u<E;u++)if(a=p[u],n||s){if(d&&i.indexOf(" > ")>1&&i===a.$field_label){r=!0;break}if(i===a.field_label){r=!0;break}}else if(m&&i===a.api_name){r=!0;break}if(r)break}return r?a:void 0},getReplaceField:function(e,i){var t;return i===mergeFieldsConstants.fromlabel_to_api?t=e.api_name:i===mergeFieldsConstants.fromapi_to_label?t=e.field_label:i===mergeFieldsConstants.fromlabel_to_id&&(t=e.id),t},getAllModulesAndFields:function(e){for(var i=e.modules,t=e.details,a=t.length,l=i.length,o=[],n={},s=0;s<l;s++)for(var m=i[s],r=m.name,d=m.type,c=0;c<a;c++){var p=t[c],E=p.module;if(r===E.name){var u={},C={};C.id=E.id,C.name=E.name,C.api_name=E.api_name,C.singular_label=E.singular_label,C.display_name=m.display_name,C.custom_module=E.custom_module,C.kiosk_module=E.kiosk_module,C.type=d,C.lookup_details=m.lookup_details,C.parent_module_api_name=m.parent_module_api_name,u.module=C;var g=p.sections;u.sections=g,o.push(u);break}}return n.mergefields=o,n},convert:function(e,i,t){var a,l,o,n,s,m,r="${"+I18n.getMsg("crm.template.email.unsupported.merge.field")+"}",d="";d=t?new RegExp(/(\#\{)(.+?)\.(.+?)\}/g):new RegExp(/\$\{serialNumber\}|\$\{userSignature\}|\$\{companyLogo\}|\$\{Unsupported_Field\}|(\$\{)(.+?)\.(.+?)\}/g);var c,p=["&amp;","&#39;","&quot;","&lt;","&gt;","&nbsp;","%28","%29","%3C","%3E","%20","%7B","%7D","%27"],E=["&","'",'"',"<",">"," ","(",")","<",">"," ","{","}","'"],u=e,C=0,g="";for(e=e.replace(r,"${Unsupported_Field}");a=d.exec(e);){l=a[2],o=a[3],s=null,m=null;var U=l;if(null!=l){l.startsWith(mergeFieldsConstants.Lookup)&&(l=l.substring(7)),c=l.length+o.length;for(var h=p.length,v=0;v<h;v++){var f=new RegExp(p[v],"g");l=l.replace(f,E[v]),o=o.replace(f,E[v]),U=U.replace(f,E[v])}if((s=U.startsWith(mergeFieldsConstants.Lookup)?i[mergeFieldsConstants.Lookup+l]:i[l])&&(s=s.label),!s){var T=o.split("."),S=T.length-1;for(v=0;S--;)if(l=l+"."+T[v],v++,(s=U.startsWith(mergeFieldsConstants.Lookup)?i[mergeFieldsConstants.Lookup+l]:i[l])&&(s=s.label),s){o=U.startsWith(mergeFieldsConstants.Lookup)?o.substring(l.length-U.length+7):o.substring(l.length-U.length);break}}(n=U.startsWith(mergeFieldsConstants.Lookup)?i[mergeFieldsConstants.Lookup+l]:i[l])&&(n=n.field)&&(m=n[o],g.indexOf(m)>-1||isNaN(m)||(g=g+m+",",isNaN(s)||(g=g+s+","))),null==m&&(m=o),null!=s&&U.startsWith(mergeFieldsConstants.Lookup)?(u=u.substring(0,a.index+2+C)+U.substring(0,7)+s+"."+m+"}"+u.substring(d.lastIndex+C),C+=s.length+m.length-c):null!=s&&(u=u.substring(0,a.index+2+C)+s+"."+m+"}"+u.substring(d.lastIndex+C),C+=s.length+m.length-c)}}return{content:u,fieldIds:g}},getUnsupportedFieldsList:function(e,i,t,a){var l,o,n,s,m,r,d="${"+I18n.getMsg("crm.template.email.unsupported.merge.field")+"}",c="${Unsupported_Field}",p="";p=t?new RegExp(/(\#\{)(.+?)\.(.+?)\}/g):new RegExp(/\$\{serialNumber\}|\$\{userSignature\}|\$\{companyLogo\}|\$\{Unsupported_Field\}|\$\{ZSURVEY\.(.+?)\}|\$\{(.+?)\.(.+?)\}|\$\{Campaigns\.Registration URL\}/g);var E=["&amp;","&#39;","&quot;","&lt;","&gt;","&nbsp;","%28","%29","%3C","%3E","%20","%7B","%7D","%27"],u=["&","'",'"',"<",">"," ","(",")","<",">"," ","{","}","'"],C=[];for((e=e.replace(d,c)).indexOf(c)>-1&&C.push(d);l=p.exec(e);){o=l[2],n=l[3],m=null,r=null;var g=o;if(("Datarequest"!==o||-1===l[0].search(/\$\{Datarequest\.[a-zA-Z_]+\}/))&&null!=o){o.startsWith(mergeFieldsConstants.Lookup)&&(o=o.substring(7));for(var U=E.length,h=0;h<U;h++){var v=new RegExp(E[h],"g");o=o.replace(v,u[h]),n=n.replace(v,u[h]),g=g.replace(v,u[h])}if((m=g.startsWith(mergeFieldsConstants.Lookup)?i[mergeFieldsConstants.Lookup+o]:i[o])&&(m=m.label),!m){var f=n.split("."),T=f.length-1;for(h=0;T--;)if(o=o+"."+f[h],h++,(m=g.startsWith(mergeFieldsConstants.Lookup)?i[mergeFieldsConstants.Lookup+o]:i[o])&&(m=m.label),m){n=g.startsWith(mergeFieldsConstants.Lookup)?n.substring(o.length-g.length+7):n.substring(o.length-g.length);break}}m?((s=g.startsWith(mergeFieldsConstants.Lookup)?i[mergeFieldsConstants.Lookup+o]:i[o])&&(s=s.field)&&(r=s[n]),null==r&&(a?C.push(o+" - "+n):C.push(l[0]))):a?C.push(o+" - "+n):C.push(l[0])}}return C},fetchMergeFieldsAPIJson:function(e,i,t,a,l,o,n){var s={};if(s.module=e,i&&(s.relatedmodules=i),a&&(s.type=a),n&&(s.locale=n),s.includelookups=t,commonUtils.showHideLoadingDiv(!0),"CRMCCActions"!==e)return store.findAll("dummy",s,!1,!1,{url:"/crm/v7/settings/mergefields",method:"GET"}).then((function(e){commonUtils.showHideLoadingDiv(!1);var i=CrmConvertMergeFields.getAllModulesAndFields(e.mergefields);o&&o(i,l)}));if(window.process){commonUtils.showHideLoadingDiv(!1);var m=window.process.draft_variables;if(m){var r=JSON.parse(JSON.stringify(m)),d=CrmConvertMergeFields.getAllModulesAndFields(r);o&&o(d,l)}}},fetchMergeFieldsAPIJsonForLookups:function(e,i){var t,a=e.join(",");(l={}).modules=a,i&&(l.type=i),commonUtils.showHideLoadingDiv(!0);var l,o={action:"/crm/v2/settings/lookupmergefields",type:"GET",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},data:l,async:!1},n=o.url?o.url:o.action,s=o.headers||{};(l=o.data)||(l={});var m=o.dataType?o.dataType:null,r=o.type?o.type:"POST",d=o.contentType?o.contentType:"application/x-www-form-urlencoded; charset=UTF-8";return n=networkUtils.getPortalURL(n),$.ajax({type:r,url:n,data:l,contentType:d,headers:s,dataType:m,async:!1,success:function(e){commonUtils.showHideLoadingDiv(!1),t=CrmConvertMergeFields.getAllModulesAndFields(e.mergefields)},error:function(){commonUtils.showHideLoadingDiv(!1)}}),t},getMergeFieldsofDataType:function(e,i,t,a,l,o){for(var n=(t=JSON.parse(JSON.stringify(t))).mergefields,s=n.length,m=0;m<s;m++){for(var r=n[m].module,d=r.name,c=!r.lookup_details&&e&&d==e,p=n[m].sections,E=p.length,u=0;u<E;u++){var C=p[u],g=C.fields,U=CrmConvertMergeFields.filterFieldsArrForDataType(r,c,i,g,a,l,o);U.length<1?(p.splice(u,1),u--,E--):C.fields=U}p.length<1&&(n.splice(m,1),m--,s--)}return t},getFieldJSONFromMergeFieldJSON:function(e,i,t){for(var a=e.mergefields,l=a.length,o=0;o<l;o++){if(a[o].module.name===i)for(var n=a[o].sections,s=n.length,m=0;m<s;m++)for(var r=n[m].fields,d=r.length,c=0;c<d;c++){var p=r[c];if(p.id===t)return JSON.parse(JSON.stringify(p))}}},removeUnsupportedMultilevels:function(e,i){var t=$L("crm-orchestration-builder").e[0].component;if(i=t.currentStateData)for(var a=Lyte.registeredMixins.orchestration_validation.getOrchestrationModule(),l=i.instanceType,o=i.instanceIndex,n=i.statetransId,s=e.mergefields,m=s.length,r=0;r<m;r++){if(s[r].module.name===a){for(var d=s[r].sections,c=d.length,p=0;p<c;p++){var E=d[p],u=E.fields.filter((function(e){if(e.multilevel)for(var i=e.multilevel_props,a=1;a<=10;a++){var s=i["level"+a];if(!s)break;var m=s.type;if(t.isActionInstanceType(m)){var r,d=i["level"+(a-1)];if(n&&d.id===n)if("instant_action"!==m&&(r=t.getInstanceIndexFromSection(m),m=t.getInstanceTypeFromSection(m)),m===l){if("instant_action"===l||o===r)return!1}else if("instant_action"===l&&"instant_action"!==m)return!1}}return!0}));u.length<1?(d.splice(p,1),p--,c--):E.fields=u}d.length<1&&(s.splice(r,1),r--,m--)}}},removeUnsupportedModules:function(e,i){for(var t=e.mergefields,a=t.length,l=0;l<a;l++){var o=t[l].module;CrmConvertMergeFields.presentinJSONArray(o.name,i)&&(t.splice(l,1),a--,l--)}},presentinJSONArray:function(e,i){for(var t=i.length,a=0;a<t;a++)if(i[a]===CrmConvertMergeFields.getElemName(e))return!0;return!1},getElemName:function(e){return"webhooks"===wfmergefield.actionName&&"webhooks"===e?"Webhook":e},isOrchestrationModule:function(e){return e.indexOf("Orchestration")>-1||e.indexOf("CRMCCActions")>-1},isKioskModule:function(e){return!!e&&e.indexOf("ProcessFlow")>-1},filterFieldsArrForDataType:function(e,i,t,a,l,o,n){return a.filter((function(a){if(a.supported_places){if(t&&!CrmConvertMergeFields.presentinJSONArray(t,a.supported_places))return!1;a.show=!0}var s=!1;if(l&&"text"!==l&&"textarea"!==l){s=CrmConvertMergeFields.isDataTypeSupported(a,l,i);var m=l.split(":")[0];"lookup"!==m&&"desk_ticket"!==m&&"richtext"!==m&&CrmConvertMergeFields.isSecondLevelLookupSupported(e.name,a)&&(s=!0,"Kiosk"===wfmergefield.featureName&&"fileupload"===m&&(s=!0))}else s=!0;var r=!0;return o&&!CrmConvertMergeFields.showFieldForBinding(e,i,l,a)&&(r=!1),n&&"kiosk_get_record_single"===n&&"lookup"===a.data_type&&133===a.ui_type&&!r&&s&&"Kiosk"===wfmergefield.featureName&&(r=!0),"undefined"!=typeof mergeField&&mergeField.filterCallBack&&(r=mergeField.filterCallBack(e,l,a,r,t)),!(!s||!r)&&(a.show=!0,!0)}))},showFieldForBinding:function(e,i,t,a){var l=e.name;return!!("CURRENTRECORD"===a.id&&t&&t.indexOf("lookup")>=0)||(!(!t||!t.startsWith("lookup:"))||(CrmConvertMergeFields.isUserField(t)?"Users"!=l||!e.lookup_details:!!a.show&&(!(!i&&!a.showinlookup)||!(!e.kiosk_module||!wfmergefield||"Deluge"!==wfmergefield.actionName))))},isSecondLevelLookupSupported:function(e,i){if(i&&i.multilevel&&133===i.ui_type&&i.lookup_module&&CrmConvertMergeFields.isMultiLevelAllowed(e)){var t=i.lookup_module.id,a=store.peekRecord("module",t);return!!a&&"Modules"!==a.module_name}return!1},isDataTypeSupported:function(e,i,t){if("desk_ticket"===i)return e.field_label.includes("> Trigger - Desk")&&e.field_label.endsWith("> Ticket ID")||e.field_label.includes("> Touchpoint - Desk")&&e.field_label.endsWith("> Ticket ID");if(i&&null!=i&&"text"!==i&&"textarea"!==i){var a=i.split(":");if(CrmConvertMergeFields.isUserField(i)&&CrmConvertMergeFields.isUserField(e.data_type))return!0;if("recordCurrency"===i&&39===e.ui_type)return!0;if("richtext"===i&&250===e.ui_type&&t)return!0;if(a[0]===e.data_type&&CrmConvertMergeFields.isMergeFieldAvailableForThisType(e)){if("lookup"===a[0]){if(a.length>1){var l=a[1];if(e.lookup_module&&null!=e.lookup_module){if((Lyte.registeredMixins["crm-automation-actions"]?Lyte.registeredMixins["crm-automation-actions"].fetchModuleName(e.lookup_module.api_name):automationActions.getTabNameByAPIName(e.lookup_module.api_name))===l)return!("lookup:Accounts"===i&&wfmergefield&&"Kiosk"===wfmergefield.featureName&&"CreateRecord"===wfmergefield.actionName&&!e.show)}else if("CURRENTRECORD"===e.id&&l===wfmergefield.getMainModule()&&t)return!0;return!1}return!0}return!0}return!1}return!0},isUserField:function(e){return-1!==["ownerlookup","userlookup"].indexOf(e)},isMergeFieldAvailableForThisType:function(e){var i=e.data_type;return"208"!==e.ui_type||"bigint"!==i},isMergeFieldPresent:function(e){return"${CURRENTUSER}"!==e&&"${EXECUTION_TIME}"!==e&&"${EXECUTION_DAY}"!==e&&new RegExp(/\$\{([^\{|^\}]*)\}/g).test(e)},getMessage:function(e){var i=e,t=$("#divToProcessContent");t.html(i.html());var a=t.find("div");a.length>0&&a.each((function(){var e=$(this);e.replaceWith("<br>"+e.html())}));var l=t.find("span.mergespan");l.length>0&&l.each((function(){var e=$(this),i=this.getAttribute("value");e.replaceWith($ESAPI.encoder().encodeForHTML(i))}));var o=t.find("span");return o.length>0&&o.each((function(){var e=$(this);e.replaceWith(e.html())})),t.html()},removeMergeSpans:function(e){var i=$("<div/>");i.html(e);var t=i.find("span.mergespan");return t.length>0?(t.each((function(){var e=$(this),i=this.getAttribute("value");i||(i=this.getAttribute("title")),e.replaceWith($ESAPI.encoder().encodeForHTML(i))})),i.html()):e},replaceHtmlEncodedChars:function(e){for(var i=["&amp;","&#39;","&quot;","&lt;","&gt;","&nbsp;","%28","%29","%3C","%3E","%20","%7B","%7D","%27","&#x24;","&#x7b;","&#x21;","&#x7d;"],t=["&","'",'"',"<",">"," ","(",")","<",">"," ","{","}","'","$","{","!","}"],a=i.length,l=0;l<a;l++){var o=new RegExp(i[l],"g");e=e.replace(o,t[l])}return e},isMultiLevelAllowed:function(e){return CrmConvertMergeFields.isOrchestrationModule(e)||e.indexOf("PathFinder")>-1||CrmConvertMergeFields.isKioskModule(e)},encodeMergeFieldZE:function(e){for(var i,t,a=new RegExp(/((<a ([^<]*|[^>]*)(href="(.*?)")(.*?)>(.*?)<\/a>)|(<img([^>]*).*?>)|(<span class="mergespan(.*?)<\/span>)|(\$\{([^\{|^\}]*)\}))/g),l=0,o=e;t=a.exec(e);){var n=t[2],s=t[12];if(n){for(var m,r,d=t[7],c=new RegExp(/\$\{([^\{|^\}]*)\}/g),p=d,E=0;r=c.exec(d);){var u=r[0];u&&(m=u.length,u=CrmConvertMergeFields.replaceHtmlEncodedChars(u),u=$ESAPI.encoder().encodeForHTML(u),p=p.substring(0,r.index+E)+u+p.substring(c.lastIndex+E),E+=u.length-m)}if(d!==p)for(;n.includes(d);)o=o.replace(d,p),n=n.replace(d,p),l+=E}else s&&(i=s.length,s=CrmConvertMergeFields.replaceHtmlEncodedChars(s),s=$ESAPI.encoder().encodeForHTML(s),o=o.substring(0,t.index+l)+s+o.substring(a.lastIndex+l),l+=s.length-i)}return o},encodeMergeField:function(e){for(var i,t,a=new RegExp(/((<a ([^<]*|[^>]*))(.*?>.*?<\/a>)|(\$\{([^\{|^\}]*)\})|(<span class="unsupportMergeField"(.*?)<\/span>))/g),l=0,o=e;t=a.exec(e);){var n=t[5];n&&(i=n.length,n=CrmConvertMergeFields.replaceHtmlEncodedChars(n),n=$ESAPI.encoder().encodeForHTML(n),o=o.substring(0,t.index+l)+n+o.substring(a.lastIndex+l),l+=n.length-i)}return o},removeMergeFieldsInStr:function(e){for(var i,t,a=e,l=new RegExp(/\$\{([^\}].*?)\}/g),o=0;t=l.exec(e);){var n=t[0];n&&(i=n.length,n="",a=a.substring(0,t.index+o)+n+a.substring(l.lastIndex+o),o+=n.length-i)}return a},getUnsubscribeFieldInfo:function(e,i){var t=template.unsubscribeMergeFields;if(t)for(var a=t.length,l={},o=0;o<a;o++){var n=t[o];if(e===mergeFieldsConstants.fromapi_to_label){if(n.api_name===i)return l.field=n,l}else if((e===mergeFieldsConstants.fromlabel_to_api||e===mergeFieldsConstants.fromlabel_to_id)&&n.field_label===i)return l.field=n,l}},getAllFieldsForModule:function(e,i){var t={};if(i)for(var a=i.length,l=0;l<a;l++){var o=i[l];if(o.module.name===e){t.sections=o.sections;break}}return t},getModuleObjectByApiName:function(e,i){if(i)for(var t=i.length,a=0;a<t;a++){var l=i[a].module;if(l.api_name===e)return l}},getModuleObjectByModName:function(e,i){if(i)for(var t=i.length,a=0;a<t;a++){var l=i[a].module;if(l.name===e)return l}},getModuleFieldsObjectByLookupApiId:function(e,i){if(i)for(var t=i.length,a=0;a<t;a++){var l=i[a];if(l.module.lookup_details&&l.module.lookup_details.id===e)return l}},getModuleFieldsInfoProcessFlow:function(e){if(e)for(var i=e.length,t=0;t<i;t++){var a=e[t];if(a.module.kiosk_module&&!0===a.module.kiosk_module)return a}},validCurrentRecordField:function(e,i,t){if("lookup"===i&&t.lookup&&((Lyte.registeredMixins["crm-automation-actions"]?Lyte.registeredMixins["crm-automation-actions"].fetchModuleName(t.lookup.module.api_name):automationActions.getTabNameByAPIName(t.lookup.module.api_name))===wfmergefield.getMainModule()&&(t=wfmergefield.getFieldObj(wfmergefield.getMainModule(),"CURRENTRECORD"))&&"${"+t.field_label+"}"===e))return!0;return!1},isCampaignsWebinarUrlMergeField:function(e,i,t){var a="",l="";if(i&&i.mergefields&&i.mergefields.length>0&&i.mergefields.forEach((function(e){"Campaigns"===e.module.name&&(l=e.module.display_name,t===mergeFieldsConstants.fromapi_to_label&&(l=e.module.api_name),e.sections[0].fields.forEach((function(e){"Native__Webinar__Extn__Webinar_Registration_URL"===e.api_name&&(a=e.field_label,t===mergeFieldsConstants.fromapi_to_label&&(a=e.api_name))})))})),a){var o="${"+l+"."+a+"}";if(t===mergeFieldsConstants.fromapi_to_label&&(o="${!"+l+"."+a+"}"),o===e)return!0}return!1},getCampaignsWebinarUrlMergeField:function(e,i){var t="",a="";if(e&&e.mergefields&&e.mergefields.length>0&&e.mergefields.forEach((function(e){"Campaigns"===e.module.name&&(a=e.module.api_name,i===mergeFieldsConstants.fromapi_to_label&&(a=e.module.display_name),e.sections[0].fields.forEach((function(e){"Native__Webinar__Extn__Webinar_Registration_URL"===e.api_name&&(t=e.api_name,i===mergeFieldsConstants.fromapi_to_label&&(t=e.field_label))})))})),t)return i===mergeFieldsConstants.fromapi_to_label?"${"+a+"."+t+"}":"${!"+a+"."+t+"}"}};