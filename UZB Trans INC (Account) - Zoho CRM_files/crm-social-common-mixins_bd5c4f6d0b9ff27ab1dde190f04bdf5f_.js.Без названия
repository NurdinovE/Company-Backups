Lyte.Mixin.register("crm-social-tab",{appendDepartment:function(e){var t=$("#socDeskDepartment");t.html(""),null!==e.desk_department&&e.desk_department&&e.desk_department.length>0&&(t.append('<option value="">'+I18n.getMsg("crm.social.desk.choosedepartment")+"</option>"),$.each(e.desk_department,(function(e,o){t.append('<option value="'+o.id+'">'+o.name+"</option>")})))},getFeeds:function(e,t,o,s,r,a){if($L("#socMessageContent").addClass("dN"),e)this.showMoreLoading(e);else{var i=$L("#socAllConvo");if($L("#socConvoContent").removeClass("dN"),i.removeClass("dN"),i&&i.length>0)return;var n=$L("crm-social-interaction-loading");n&&n.length>0&&n[0].remove(),Lyte.Component.render("crm-social-interaction-loading",{index:[1,2,3,4,5]},"#socConvoContent")}var c={brand_id:t,cursor:o,entity_type:s,place_type:a,network:r,currentEle:e},l={};o&&(l.cursor=o),s&&(l.entity_type=s),r&&(l.network=r),this.appendDeskEnabledQuery()&&(l.desk_enabled_user=this.appendDeskEnabledQuery());var d=this;store.findAll("crm_social_feed",l,void 0,void 0,{brand_id:t}).then((function(e){d.renderFeeds(c,e)}))},getReports:function(){var e=this;store.findAll("crm_social_report").then((function(t){e.renderReports(void 0,t)}))},renderReports:function(e,t){if(t){var o=$L("crm-social-reports")[0];o&&o.remove();var s={Contacts:[],Leads:[],Accounts:[]};$.each(t,(function(e,t){"Contacts"===t.module.api_name?s.Contacts.push(t):"Leads"===t.module.api_name?s.Leads.push(t):s.Accounts.push(t)}));var r=[];$.each(s,(function(e,t){var o={module:moduleRecordMapping[e].singular_label};if(t.length>1){var s=t[0],a=t[1];s.from!==a.to&&(s=t[1],a=t[0]),o.increase=s.count>a.count,o.equal=s.count===a.count,o.current=s.count,o.previous=a.count,0!==a.count&&(o.percentage=parseFloat((s.count-a.count)/a.count*100).toFixed(1))}else o.count=t[0].count,o.create_count=!0;r.push(o)})),Lyte.Component.render("crm-social-reports",{report:r},"#socDashLeadsDetails")}},getNetworkJsonByBrandId:function(e,t,o){var s={},r=store.peekAll("Social")[0];return r&&$.each(r.accounts,(function(r,a){var i=!0;if(t&&a.perm_type>t&&(i=!1),o&&a.reauth&&(i=!1),i&&a.brand&&a.brand.id===e){var n=a.network;s[n]=a}})),s},checkReauthStatus:function(e,t,o){var s=store.peekAll("Social")&&store.peekAll("Social").length>0?store.peekAll("Social")[0]:!!(store.peekAll("social_related_list")&&store.peekAll("social_related_list").length>0)&&store.peekAll("social_related_list")[0];if(s){var r=!1;if($.each(s.accounts,(function(o,s){if(s.brand&&s.brand.id===e&&s.network===t)return s.reauth&&(r=s.reauth),!1})),r){var a=$L("crm-social-account-reauth");a&&0===a.length&&crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.reauth.error"),3e3)}return r}},getAccountByBrandIdAndNetwork:function(e,t){var o=null,s=store.peekAll("Social")[0];return $.each(s.accounts,(function(s,r){r.brand&&r.brand.id===e&&t===r.network&&(o=r.id)})),o},appendDeskEnabledQuery:function(){var e=store.peekAll("Social");if(e&&e.length>0)return!!e[0].configered_desk_detials.is_desk_supported_org},processTags:function(e){if(e.message){"twitter"!==e.network&&(e.message=$ESAPI.encoder().encodeForHTML(e.message));var t=e.user&&e.user.screen_name?"@"+e.user.screen_name+" ":"";e.message_tags&&$.each(e.message_tags,(function(o,s){var r;"twitter"!==e.network?s.text=$ESAPI.encoder().encodeForHTML(s.text):"symbols"===s.type?s.text="\\"+s.text:"Mentions"===s.type&&e.account&&"@"+e.account.screen_name!==s.text&&(t=t+s.text+" "),s.replace_text="twitter"!==e.network?$ESAPI.encoder().encodeForHTML(s.show_text):s.show_text,r="Mentions"===s.type||"hashtags"===s.type?'<a class="socMsgHandleElement" href="javascript:;" network="'+e.network+'" entity_profile_id="'+s.profile_id+'"type="'+s.type+'"replace_text="'+s.replace_text+'">'+s.replace_text+"</a>":"twitter"!==e.network?s.replace_text:'<a class="socFbMulLink" link="'+s.link+'" + href="'+s.link+'" target="_blank" rel="noopener noreferrer">'+s.replace_text+"</a>",r="photo"===s.type?"":r,e.message=(" "+e.message).replaceAll(" "+s.text,r).trim(),e.message=e.message.replaceAll("\n"+s.text,"\n"+r)})),e.reply_text=t}if(e.story&&("twitter"!==e.network&&(e.story=$ESAPI.encoder().encodeForHTML(e.story)),e.story_tags&&$.each(e.story_tags,(function(t,o){var s;"twitter"!==e.network?o.text=$ESAPI.encoder().encodeForHTML(o.text):"symbols"===o.type&&(o.text="\\"+o.text),o.replace_text="twitter"!==e.network?$ESAPI.encoder().encodeForHTML(o.show_text):o.show_text,s="Mentions"===o.type||"hashtags"===o.type?'<a class="socMsgHandleElement" href="javascript:;" network="'+e.network+'" entity_profile_id="'+o.profile_id+'"type="'+o.type+'"replace_text="'+o.replace_text+'">'+o.replace_text+"</a>":"facebook"!==e.network?o.replace_text:'<a class="socFbMulLink" link="'+o.link+'" + href="'+o.link+'" target="_blank" rel="noopener noreferrer">'+o.replace_text+"</a>",e.story=" "+e.story,e.story=e.story.replaceAll(" "+o.text,s).trim(),e.story=e.story.replaceAll("\n"+o.text,"\n"+s)}))),e.permissions)switch(e.permissions){case"Creators":e.perm=1;break;case"Responders":e.perm=2;break;case"Listeners":e.perm=3}(Crm.userDetails.permissions.Crm_Implied_Create_Leads||Crm.userDetails.permissions.Crm_Implied_Create_Contacts||Crm.userDetails.permissions.Crm_Implied_Create_Accounts)&&(e.add_to_crm=!0),Lyte.registeredMixins["crm-social-integration"].processTwitterTags()},processPosts:function(e){var t={data:[],cursor:e&&e.$?e.$.meta:void 0},o=this;return e=e&&e.data?e.data:e,$.each(e,(function(e,s){if(s){if(void 0!==s.retweeted_status&&(s.retweet_screen_name=s.retweeted_status.user.screen_name,o.processTags(s.retweeted_status)),void 0!==s.quoted_status&&(s.quote_screen_name=s.quoted_status.user.screen_name,o.processTags(s.quoted_status)),s.comments&&(s.comments=o.processComments(s.comments)),s.id){var r=$L(".socPostId_"+s.id).find(".socModuleName");if(r&&r.length>0){var a=r[0].tagName;a&&"SPAN"===a&&r[0].remove()}}o.processTags(s),t.data.push(s)}})),t},processPostsForRender:function(e){var t={data:[],cursor:e.$?e.$.meta:void 0};return e=e.data?e.data:e,$.each(e,(function(e,o){o&&t.data.push(o)})),t},processComments:function(e,t){var o=this,s=JSON.parse(JSON.stringify(e));return s.data=[],s.cursor=e.cursor,t&&e.data&&(e.data=e.data.reverse()),e.data?$.each(e.data,(function(e,r){r.comments&&(r.comments=o.processComments(r.comments,t),s.data.push(r)),"googleplus"!==r.network&&o.processTags(r)})):$.each(e,(function(e,r){r.comments&&(r.comments=o.processComments(r.comments,t),s.data.push(r)),"googleplus"!==r.network&&o.processTags(r)})),s},getFilterFeeds:function(e){if(void 0!==e.type){var t=null,o=null;switch(e.type){case"mention":case"timeline":case"like":break;case"keyword_search":t=e.info?e.info.keyword:e.details&&e.details.info?e.details.info.keyword:void 0;break;case"user_search":case"page_search":case"list":o=e.info.profile_id;break;default:return}this.getFilterFeedsCommon(void 0,e.id,e.type,e.network,t,o,e.display_name,void 0,e.id,void 0,"monitor")}},getFilterFeedsCommon:function(e,t,o,s,r,a,i,n,c,l,d){var p=$L(".selectedBrand").attr("value"),m=null,u=$L("#"+t+"_column");if("social_tab_preview"===c)m=$L(".socialFilterPreview");else if("social_tab_user_preview"===c)m=$L(".socUserSearchDetList");else if("rightpanel_popup"!==c||"keyword_search"!==o||n)m=u.find(".socColumnLists"),u.attr("loaded",!0);else{var g=$L("crm-zso-entity-create");g&&g.length>0&&g[0].component.resetEntityForm(),$L(".socViewConvoClose").hide();var f="#socialDashboard";0===$L(f).length&&(f="body");var h=$L("crm-social-right-panel-search");h&&h.length>0&&h[0].remove(),Lyte.Component.render("crm-social-right-panel-search",{search_query:r,display_name:r},f).setData("renderRightPanelSearch",!0),Lyte.Component.render("crm-social-interaction-loading",{index:[1,2,3,4,5]},"#socRightPanelSearchRes"),$L("#socRightPanelSearchKey").text(r),$L("#rightPanelAddcolumn").attr({search_query:r,display_name:r})}var _=$L(".socPeoResults");if(_&&_.length>0&&_.addClass("dN"),this.checkReauthStatus(p,s)){var v=renderingUtils.createHTML({name:"div",attr:{class:"pA socAccReauth aligncenter"},child:[{name:"span",attr:{class:"dIB svgIcons socAccWarningIcon"}},{name:"span",attr:{class:"dB crmNotFoundColor"},child:[{name:"text",content:I18n.getMsg("crm.social.integ.reauth.error")}]}]});return m.empty(),null!==m&&m.append(v),void m.closest(".socCustomColumn").find(".socRefresh").removeClass("socRefreshRotate")}if(("social_tab_preview"===c||"social_tab_user_preview"===c)&&!n){var w="social_tab_user_preview"===c?".socUserSearchDetList":"#socKeyPeoSearch";Lyte.Component.render("crm-social-interaction-loading",{index:[1,2,3,4,5]},w)}p||(p=l);var L={id:t,brand_id:p,type:o,network:s,search:r,profile_id:a,cursor:n,place_type:c,display_name:i,tab:d,ele:e},C={};C.type=o,r&&(C.keyword=r),a&&(C.profile_id=a),n&&(C.cursor=JSON.stringify({after:decodeURIComponent(n)}),this.showMoreLoading(e)),C.time=Date.now();var y=this.appendDeskEnabledQuery();C.desk_enabled_user=y||!1;var I=this;store.findAll("crm_social_post",C,void 0,void 0,{brand_id:p,network:s}).then((function(e){commonUtils.showHideLoadingDiv(!1),I.renderFilterFeeds(L,e)}),(function(e){var t=Lyte.registeredMixins["crm-social-tab"];if(t.handleErrorCase(e.response?JSON.parse(e.response):e),t.checkReauthStatus(p,s)){var o=renderingUtils.createHTML({name:"div",attr:{class:"pA socAccReauth aligncenter"},child:[{name:"span",attr:{class:"dIB svgIcons socAccWarningIcon"}},{name:"span",attr:{class:"dB crmNotFoundColor"},child:[{name:"text",content:I18n.getMsg("crm.social.integ.reauth.error")}]}]});return m.empty(),null!==m&&m.append(o),void m.closest(".socCustomColumn").find(".socRefresh").removeClass("socRefreshRotate")}}))},renderFilterFeeds:function(e,t){if((o=$L("crm-social-interaction-loading"))&&o.length>0&&("social_tab_preview"===e.place_type||"rightpanel_popup"===e.place_type)){var o,s=$L("#socRightPanelSearchRes");if(s&&s.length>0)(o=s.find("crm-social-interaction-loading"))&&o.length>0&&o[0].remove();else o[0].remove()}if(t.code)this.handleErrorCase(t,"posts","GET");else{t&&(t=this.processPostsForRender(t)),"monitor"!==e.tab&&this.showMoreRemove(e.ele),t.brand={id:e.brand_id},t.network=e.network,t.place_type=e.place_type,t.type=e.type,t.search=e.search,t.profile_id=e.profile_id,t.id=e.id,t.filter=!0,t.display_name=e.display_name;var r=null;switch(e.place_type){case"social_tab_preview":r=document.querySelector(".socialFilterPreview"),t.preview=!0;break;case"rightpanel_popup":if("keyword_search"===e.type)return(n=document.createElement("crm-social-my-posts")).setData(t),void(null!==(r=document.getElementById("socRightPanelSearchRes"))&&$L(r).append(n));if("following"===t.type||"followers"===t.type){t.users=this.processSearchResult(e,t.users?t.users:t.data?t.data:t),t.users.brand={id:e.brand_id},t.users.network=e.network,t.users.place_type=e.place_type,t.users.type=e.type,t.users.search=e.search,t.users.profile_id=e.profile_id,t.users.id=e.id,t.users.filter=!0,t.users.display_name=e.display_name;var a=document.createElement("crm-social-search-people-filter");a.setData(t);var i=$L("#socProfPopupUsers");""===e.cursor&&i.empty(),i.append(a)}else{i=$L("#socProfPopupUsers");(n=document.createElement("crm-social-my-posts")).setData(t),""===e.cursor&&i.empty(),i.append(n)}return;case"social_tab_user_preview":null===(r=document.querySelector(".socUserSearchDetList"))&&(r=document.querySelector(".socProfPopupUsers")),t.preview=!0;break;default:null!==(r=document.getElementById(e.id))&&(r=r.querySelector(".socColumnLists"))}$L("#"+t.id+"_column").find(".socRefresh").removeClass("socRefreshRotate");var n=document.createElement("crm-social-my-posts");if(e.cursor?n.setData(t):(t.show_empty=!0,n.setData(t),null!==r&&$L(r).empty()),null!==r){var c,l,d=$L(r).closest(".socColumnContent");c=d||$L(r).closest("lyte-modal-content"),$L(r).append(n),l=c.scrollTop()+100,void 0!==e.cursor&&crmui.animateScrollTop(c[0],l,300,"")}}},setMonitorContentWidth:function(){var e=$L(".socColumnHeading"),t=$L("#socMonitorContentInner"),o=renderingUtils.windowWidth,s=$L("#socMonitorContentInner .socCustomColumn"),r=(s.outerWidth()+12)*s.length,a=e.outerHeight();$L(".socCustomColumn .socColumnContent").css("height","calc(100% - "+a+"px)"),r>o?t.css("width",r):t.css("width",""),s.length>0?($L("#socMonitorEmpty").addClass("dN"),this.monitorApplySortable()):$L("#socMonitorEmpty").removeClass("dN")},getStarted:function(){networkUtils.openUrl(networkUtils.getOrgSpecificURL(Crm.getCrmBasePath()+"/settings/extensions/social/brands"))},renderReauthAccounts:function(e,t){var o=[];t=store.peekAll("Social")[0];$.each(t.accounts,(function(e,t){t.reauth&&"brand"===t.type&&o.push(t)})),o.length>0?($L(".socSettingIconOuter").find(".reauthDot").addClass("follow_dot"),Lyte.Component.render("crm-social-account-reauth",{accounts:o},"#socialDashboard"),$L("crm-social-account-reauth")[0].component.setData("showReauthPop",!0)):e||this.getStarted()},renderFeeds:function(e,t){t||(t={}),t.data=this.processFeedsForRender(t),$("#social").hide();var o=null,s=null;if(e.message){if(!e.cursor){var r=$L("#socMessageContent");r[0]&&(r[0].innerHTML=""),r.append(renderingUtils.createHTML([{name:"div",attr:{id:"socAllMessages"}},{name:"div",attr:{id:"socMessageDetail",class:"socMessageDetail bg_white p20 pA dN"}}])),r.removeClass("dN")}o=$L("#socAllMessages"),s=document.createElement("crm-social-messages-list")}else{if(!e.cursor){var a=$L("#socConvoContent");a[0]&&(a[0].innerHTML=""),a.append(renderingUtils.createHTML([{name:"div",attr:{id:"socAllConvo"}},{name:"div",attr:{id:"socConvoDetail",class:"socConvoDetail bg_white p20 pA dN"}}])),a.removeClass("dN")}o=$L("#socAllConvo"),s=document.createElement("crm-social-posts-new")}if(t.brand={id:e.brand_id},t.entity_type=e.entity_type,t.message=e.message,t.place_type=e.place_type,t.network=e.network,t.entity_type=e.entity_type,t.cursor=t.$&&t.$.meta?t.$.meta.cursor:void 0,void 0===e.cursor){var i=$L("crm-social-notification-new");t.data&&!t.data[0]&&0===i.length&&(t.show_empty=!0),s.setData(t),o.empty()}else{this.showMoreRemove(e.currentEle),s.setData(t);var n=$L(o.parent()),c=n.scrollTop()}o.append(s),void 0!==e.cursor&&crmui.animateScrollTop(n[0],c,300,"")},getMyPosts:function(e,t,o,s,r){var a=null;switch(s){case"twitter":a=$L(".socTwPosts").find(".socColumnLists");break;case"facebook":a=$L(".socFbPosts").find(".socColumnLists")}if(this.checkReauthStatus(t,s)){var i=renderingUtils.createHTML({name:"div",attr:{class:"pA socAccReauth aligncenter"},child:[{name:"span",attr:{class:"dIB svgIcons socAccWarningIcon"}},{name:"span",attr:{class:"dB crmNotFoundColor"},child:[{name:"text",content:I18n.getMsg("crm.social.integ.reauth.error")}]}]});return a.empty(),void(null!==a&&a.append(i))}var n={brand_id:t,cursor:o,network:s,place_type:r,currentEle:e},c={type:"user_posts"};void 0!==o&&(c.cursor=o),this.appendDeskEnabledQuery()&&(c.desk_enabled_user=!0);var l=this;store.findAll("crm_social_post",c,void 0,void 0,{brand_id:t,network:s}).then((function(e){l.renderPosts(n,e)}),(function(e){l.handleErrorCase(e.response?JSON.parse(e.response):e)}))},renderPosts:function(e,t){if(t.code)this.handleErrorCase(t);else{if(t[0]&&t[0].$.isError){var o=t[0].$.error&&t[0].$.error.id?t[0].$.error.id.data:void 0;if(o&&o.network)return void this.handleReauth(o,o.network)}t=this.processPostsForRender(t);var s=null;switch(e.network){case"twitter":s=$L(".socTwPosts").find(".socColumnLists");break;case"facebook":s=$L(".socFbPosts").find(".socColumnLists");break;case"googleplus":s=$L(".socGpPosts").find(".socColumnLists")}s.removeClass("h100_per pR"),t.brand={id:e.brand_id},t.network=e.network,t.place_type=e.place_type;var r=document.createElement("crm-social-my-posts");if(r.setData(t),void 0===e.cursor)s.empty();else{var a=e.currentEle;this.showMoreRemove(a);var i=s.parent(),n=i.scrollTop()+100}s.append(r),void 0!==e.cursor&&crmui.animateScrollTop(i[0],n,300,"")}},getInteractions:function(e,t,o,s,r,a,i){var n=$L("crm-social-interaction-loading");n&&n.length>0&&n[0].remove(),e?this.showMoreLoading(e):"message"===o?Lyte.Component.render("crm-social-interaction-loading",{index:[1,2,3,4,5]},".socMessagesDetAll"):Lyte.Component.render("crm-social-interaction-loading",{index:[1,2,3,4,5]},".socInteractionDetAll");var c={brand_id:t,cursor:s,profile_ids:r,place_type:a,element:i,type:o,currentEle:e},l={profile_ids:r};o&&(l.interaction_type=o),s&&(l.cursor=s),this.appendDeskEnabledQuery&&(l.desk_enabled_user="true");var d=this;store.findAll("crm_social_interaction",l,void 0,void 0,{brand_id:t}).then((function(e){d.renderInteractions(c,e)}),(function(e){Lyte.registeredMixins["crm-social-tab"].handleErrorCase(JSON.parse(e.response))}))},renderInteractions:function(e,t){t||(t={}),t.data=this.processFeedsForRender(t),$L("#social").hide(),t.brand={id:e.brand_id},t.profile_ids=e.profile_ids,t.social_interactions=!0,t.place_type=e.place_type,t.cursor=t.$&&t.$.meta?t.$.meta.cursor:void 0;var o=null,s=null;"message"===e.type?(e.profile_ids&&(t.profile_detail=!0),o=$L(".socMessagesDetAll").removeClass("dN"),s=document.createElement("crm-social-messages-list")):(t.profile_detail=!0,o=$L(".socInteractionDetAll").removeClass("dN"),s=document.createElement("crm-social-posts-new"));o=e.element?$L("."+e.element):o;t.element=e.element,e.cursor?(this.showMoreRemove(e.currentEle?e.currentEle:o),s.setData(t)):(t.show_empty=!0,s.setData(t),o.empty()),o.append(s)},getMessagesByProfile:function(e,t,o,s,r){var a={brand_id:t,cursor:o,profile_ids:s,place_type:r,type:"message"},i={interaction_type:"message",profile_ids:s};o&&(i.cursor=o);var n=this;store.findAll("crm_social_interaction",i,void 0,void 0,{brand_id:t}).then((function(e){n.renderInteractions(a,e)}),(function(e){n.handleErrorCase(JSON.parse(e.response))}))},processFeeds:function(e){var t=[],o=this;return $.each(e,(function(e,s){var r=s;if(s.permissions)switch(s.permissions){case"Creators":s.perm="1";break;case"Responders":s.perm="2";break;case"Listeners":s.perm="3"}r.interaction_info?("googleplus"!==(r=r.interaction_info).network&&"reply"!==r.history_type?o.processTags(r):(Crm.userDetails.permissions.Crm_Implied_Create_Leads||Crm.userDetails.permissions.Crm_Implied_Create_Contacts||Crm.userDetails.permissions.Crm_Implied_Create_Accounts)&&(r.add_to_crm=!0),delete s.interaction_info,Object.assign(s,r)):r.recipient&&o.processTags(r),t.push(s)})),t},processFeedsForRender:function(e){var t=[];return $.each(e,(function(e,o){t.push(o)})),t},setHeightForConvoPopup:function(e){var t=null;t=$L("#signalPopupViewContent").is(":visible")?$L("#signalPopupViewContent .popup-model-content").outerHeight()-($L(".socView"+e+"Header").outerHeight()+$L(".socView"+e+"Reply").outerHeight()):renderingUtils.windowHeight-(renderingUtils.tabLayerTop()+renderingUtils.tabLayerOuterHeight()+70+$L(".socView"+e+"Header").outerHeight()+$L(".socViewConvoInner").find(".socView"+e+"Reply").outerHeight()),$L(".socView"+e+"Parent").css("max-height",t)},processUserPageSearch:function(e,t){var o=store.peekAll("monitor_column");return $.each(t,(function(e,t){t.exist&&(t.exist=!1)})),$.each(t,(function(e,t){$.each(o,(function(e,o){o.info?(t.id===o.info.profile_id||t.id_str&&t.id_str===o.info.profile_id)&&(t.exist=!0,t.filter_id=o.id):o.details.info&&t.id===o.details.info.profile_id&&(t.exist=!0,t.filter_id=o.id)}))})),t},processSearchResult:function(e,t){var o=store.peekAll("monitor_column");return t.exist&&(t.exist=!1),$.each(t,(function(e,t){$.each(o,(function(e,o){(o.info&&(t.id===o.info.profile_id||t.id&&t.id===o.info.profile_id)||o.details&&o.details.info&&t.id===o.details.info.profile_id)&&(t.exist=!0,t.filter_id=o.id)}))})),t},processEntityDetail:function(e,t,o){var s=$L(e).attr("type");o||(o=$L(".profileIds").attr("ids"));var r=$L(".selectedBrand").attr("value");if(t||(t="detail_popup"),"interactions"===s)$L(".socMessagesDetAll").addClass("dN"),0===$L(".socInteractionDetAll").removeClass("dN").children().length&&this.getInteractions(null,r,null,null,o,t,null);else if("messages"===s){var a=$L(".socMessagesDetAll").removeClass("dN");$L(".socInteractionDetAll").addClass("dN"),0===a.children().length&&this.getMessagesByProfile(null,r,null,o,t)}},getProfileInfo:function(e){e=$L(e);$L(".socAddToCRM").removeAttr("id"),e.attr("id","socAddToCrmBtn");var t=$L(".socAddToCrmActive");t.find(".socAddLabel").removeClass("dN"),t.find(".socAddLoadingOuter").addClass("dN").removeClass("dIB"),t.removeClass("socAddToCrmActive"),e.find(".socAddLabel").addClass("dN"),e.find(".socAddLoadingOuter").removeClass("dN").addClass("dIB"),e.addClass("socAddToCrmActive"),$L("#socAddToCrmPop").html("");var o=$L(".selectedBrand").attr("value"),s=e.closest(".parentPost"),r=s.attr("network"),a=s.attr("profile_id"),i={brand_id:o},n={};"twitter"===r?n.twitter=a:"facebook"===r&&(n.facebook=a);var c=this;store.findAll("crm_social_info",n,void 0,void 0,i).then((function(e){c.renderCreateEntityProfile(e)}))},renderCreateEntityProfile:function(e){var t=$L(".socAddToCrmActive"),o=$L("#kso_rightPanel_Card");if(e&&!e.error){if(!e.network)(e=e[0])[e.network]=!0,e.profile_id=e.id;e[e.network]=!0,e.profile_id=e.id}if(void 0!==e.module&&void 0!==e.entityid)return 0===t.length?void o.html('<div class="pA socWarningMessageRightPanel aligncenter w100_per"><span class="svgIconsImg socWarningMsgIcon dIB"></span><span class="dB crmNotFoundColor fs crm-base-font-size mT5 mB5" style="width:325px">'+I18n.getMsg("crm.social.integ.profile.save.error1",Crm.getCrmBasePath()+"/EntityInfo.do?id="+e.entityid+"&module="+e.module)+"</span></div>"):(t.remove(),void crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.profile.save.error1",Crm.getCrmBasePath()+"/EntityInfo.do?id="+e.entityid+"&module="+e.module),1e4));t.removeClass("kso_addto_span_hover"),Crm.userDetails.permissions.Crm_Implied_Create_Leads&&Crm.userDetails.MODULE_LIST.Leads.visible&&(e.show_lead=moduleRecordMapping.Leads.singular_label),Crm.userDetails.permissions.Crm_Implied_Create_Contacts&&Crm.userDetails.MODULE_LIST.Contacts.visible&&(e.show_contact=moduleRecordMapping.Contacts.singular_label),Crm.userDetails.permissions.Crm_Implied_Create_Accounts&&Crm.userDetails.MODULE_LIST.Accounts.visible&&(e.show_account=moduleRecordMapping.Accounts.singular_label),e.renderEntityCreation=!0;var s=$L("crm-zso-entity-create");if(s&&s[0]&&s[0].remove(),e[0]&&e[0].error)_cruxUtils.showCustomMessage({params:{ltPropType:"error",ltPropDuration:5e3,ltPropMessage:I18n.getMsg("X handle is not found or no longer active")}}),t.length>0&&t[0].classList.remove("socAddToCrmActive");else var r=Lyte.Component.render("crm-zso-entity-create",e,"body");t.length>0?(t.find(".socAddLabel").removeClass("dN"),t.find(".socAddLoadingOuter").addClass("dN").removeClass("dIB"),$L("#socConvoContent").css("overflow","hidden")):(e.fromDetailView="detailView",r.setData(e),o[0]&&(o[0].innerHTML=""),o.append(r).show()),thirdPartyUtils.titleForEllipsis(".socTwEntName, .socFbEntName, .socGpEntName");var a=e.id,i=e.network;this.fetchAssociation(a,i)},setTopValueForAddToCrmPopup:function(){var e=$L("#socAddToCrmPop"),t=$L(".socAddToCrmActive"),o=$L("#tabLayer"),s=renderingUtils.windowWidth,r=renderingUtils.windowHeight,a=o.offset().top+o.outerHeight(),i=crmui.getOffset(t),n=i.top-80,c=t.outerWidth(!0),l=t.outerHeight(!0),d=e.outerHeight(),p=e.outerWidth(),m=i.top-d+l,u=i.top-d+100,g=i.left+c,f=i.left-p-8,h=r-(i.top+l),_=s-i.left;$L(".socConvoContent").css("overflow","hidden"),h>d?e.css("top",n):u<=a?e.css("top",a):h-28<=100?e.css("top",m):e.css("top",u),Crm.userDetails.RTL_ENABLED?s-_>p+20?e.css({left:f}).removeClass("dN").addClass("socAddToCrmPopOnLeft"):e.css({left:g}).removeClass("dN"):s-g>p+20?e.css({left:g}).removeClass("dN"):e.css({left:f}).removeClass("dN").addClass("socAddToCrmPopOnLeft");var v=e.offset().top;$L(".socAddToCrmBefore").css("top",i.top-v+2)},openDeskTicket:function(e){event&&(event.cancelBubble=!0,event.stopPropagation&&event.stopPropagation());var t=store.peekAll("Social")[0];if(t.configered_desk_detials.desk_supported_user){var o=$L(e).attr("web_link");networkUtils.openUrl(o,"_blank")}else if(t.configered_desk_detials.is_user_in_desk_enabled_profile){var s=(o=$L(e).attr("web_link")).split("dv/")[1];deskInteg.showDeskPopupForWidgets(s)}else crmui.showMsgBand("error",I18n.getMsg("message.code.5004"),3e3)},openCreateDeskTicket:function(e){event&&(event.cancelBubble=!0,event.stopPropagation&&event.stopPropagation());e=$L(e);var t=$L("#socDeskDepartmentDiv"),o=e.offset().top,s=e.offset().left,r=e.outerWidth(),a=e.closest(".parentPost"),i=a.attr("post_id"),n=a.attr("network");thirdPartyUtils.bindSelect2("#socDeskDepartment"),e.closest("div").hasClass("fR")?(s=s+r+7,$L(".socDeskDeptArrow").attr("style","")):(s=e.offset().left,s-=t.outerWidth()+r-5,$L(".socDeskDeptArrow").css({transform:"rotate(180deg)",left:"calc(100% - 1px)"})),"facebook"===n&&""!==a.attr("parent_post_id")&&(i=a.attr("parent_post_id"));var c=a.attr("brand_id");$L(".socDeskIconRotate").removeClass("socDeskIconRotate"),e.addClass("socDeskIconRotate");var l=store.peekAll("Social")[0].configered_desk_detials;if(l.desk_department&&l.desk_department.length>1)e.removeClass("socDeskIconRotate"),$L("#socConvoContent").css("overflow","hidden"),t.removeClass("dN").css({top:o-20,left:s}),this.unbind("createTktBTN"),$L("#createTktBTN").click((function(){var t=e;this.createDeskTicket($L("#socDeskDepartment").val(),i,n,c,t)}));else{var d=e;this.createDeskTicket(l.desk_department[0]?l.desk_department[0].id:void 0,i,n,c,d)}},unbind:function(e){$L("#"+e).unbind("click")},createDeskTicket:function(e,t,o,s,r){if(e&&""!==e){commonUtils.showHideLoadingDiv(!0);var a={};a.post_id=t,a.departmentid=e,a.network=o,a.ele=r,a.createTicket=!0,a.brandId=s;var i={department_id:e},n=this;store.create("crm_social_post",void 0,a,i).then((function(e){n.createDeskTicketcalback(a,e)}))}else crmui.showMsgBand("error",I18n.getMsg("crm.permission.social.choosedepartment"),3e3)},createDeskTicketcalback:function(e,t){commonUtils.showHideLoadingDiv(!1);var o=t.data,s=$L(e.ele),r=e.post_id,a=e.network;if(o&&o.length>0){var i=o[0].ticketNumber;s.text("# "+i).attr({web_link:o[0].webUrl}).removeClass("socDeskIconRotate").removeClass("socialImgsvg socDeskCTkIcon mR8 dIB vaM").addClass("socSupTktCount mR8 socSupTktCountOpen dIB vaM"),$L("#socDeskDepartmentDiv").addClass("dN"),$L("#socConvoContent").removeAttr("style");var n=$L(".parentPost");n.each((function(e){var t=n[e],s=$L(t),c=s.attr("post_id");("facebook"===a&&""!==s.attr("parent_post_id")&&(c=s.attr("parent_post_id")),c===r)&&s.find("#ticketCreate").text("# "+i).attr({web_link:o[0].webUrl}).removeClass("socDeskIconRotate").removeClass("socialImgsvg socDeskCTkIcon mR8 dIB vaM").addClass("socSupTktCount mR8 socSupTktCountOpen dIB vaM")}))}},handleErrorCase:function(e,t,o,s){commonUtils.showHideLoadingDiv(!1);var r=e.responseJSON?e.responseJSON:e.response?JSON.parse(e.response):e,a=void 0!==r.code?r.code:r.status,i=$L(".showmoreNew"),n={USER_NOT_FOUND:I18n.getMsg("crm.social.integ.error.user.notfound1"),USER_SUSPENDED:I18n.getMsg("crm.social.integ.error.user.suspend1"),USER_TOKEN_SUSPENDED:I18n.getMsg("crm.social.integ.reauth.error1"),RATE_LIMIT_REACHED:I18n.getMsg("crm.social.integ.error.internal"),NEED_REAUTH:I18n.getMsg("crm.social.integ.reauth.error1"),TWITTER_OVER_CAPACITY:I18n.getMsg("crm.social.integ.error.internal"),UNKNOWN_ERROR:I18n.getMsg("crm.social.integ.error.internal"),BLOCKED_BY_USER:I18n.getMsg("crm.social.integ.error.user.blocked1.view"),ID_NOT_FOUND:I18n.getMsg("crm.social.integ.error.tweet.notfound1"),DM_FAILED:I18n.getMsg("crm.social.integ.error.dm.failed1"),LIMIT_TO_FOLLOW:I18n.getMsg("crm.social.integ.error.follow.limit1"),BLOCKED_TO_FOLLOW:I18n.getMsg("crm.social.integ.error.user.blocked1"),TWEET_PROTECTED:I18n.getMsg("crm.social.integ.error.tweet.protected"),TWEET_LIMIT_REACHED:I18n.getMsg("crm.social.integ.error.tweet.limit"),DUPLICATE_STATUS:I18n.getMsg("crm.social.integ.error.tweet.dublicate1"),ACCOUNT_LOCKED:I18n.getMsg("crm.social.integ.error.unlock"),MESSAGE_SIZE_EXCEEDS:I18n.getMsg("crm.social.integ.error.message.limit"),DELETED_TWEET:I18n.getMsg("crm.social.integ.error.tweet.deleted1"),ATTACHMENT_LIMIT_EXCEEDS:I18n.getMsg("crm.social.integ.error.attachment.limit1"),NO_PERMISSION:I18n.getMsg("crm.nsocial.contact.admin"),SENT_OUTSIDE_ALLOWED_WINDOW:I18n.getMsg("crm.social.error.directmessage"),DUPLICATE_FAVOURITE:I18n.getMsg("crm.social.error.duplicatelike"),INSUFFICIENT_STORAGE:I18n.getMsg("crm.newfree.limit.exceed"),INVALID_DATA:I18n.getMsg("crm.social.noperm.or.delete"),LIMIT_EXCEEDED:I18n.getMsg("crm.social.social.limit"),USER_BLOCKED:I18n.getMsg("crm.social.integ.error.blocked")};n[a]?"NEED_REAUTH"===a&&r.details?(crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.reauth.error"),3e3),this.updateReAuthStatus(r.details.brand_id,r.details.network)):"NO_PERMISSION"===a?renderingUtils.displayPermissionDenied():crmui.showMsgBand("error",n[a],3e3):"monitor_column"===s&&"POST"===o?"LIMIT_EXCEEDED"===a?crmui.showMsgBand("error",I18n.getMsg("crm.social.social.limit"),3e3):"DUPLICATE_DATA"===a&&crmui.showMsgBand("error",I18n.getMsg("crm.social.filter.exist"),3e3):"GET"!==o||"INVALID_DATA"!==a||"renderMessageDetail"!==t&&"renderParentPostDetail"!==t?"processProfileInfo"===t?this.processProfileInfo(void 0,void 0):crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.error.internal"),3e3):(crmNTCDetailView.hideDetailViewPopup(),crmui.showMsgBand("error",I18n.getMsg("crm.social.noperm.or.delete"),3e3)),i&&i.length>0&&(i.find(".showmoreNewLink").removeClass("dN"),i.find(".showmoreLoadingImg").addClass("dN"))},updateReAuthStatus:function(e,t){var o=this.getAccountByBrandIdAndNetwork(e,t),s=store.peekAll("Social")&&store.peekAll("Social").length>0?store.peekAll("Social")[0]:store.peekAll("social_related_list")[0],r=$L(".socSettingIconOuter").find(".reauthDot");$.each(s.accounts,(function(e,t){t.id===o&&(t.reauth=!0,r.addClass("follow_dot"))})),crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.reauth.error"),3e3)},getNetworkBrandJson:function(e){var t=[],o=store.peekAll("Social")[0].accounts;return $.each(o,(function(o,s){if(s.brand&&s.brand.id===e&&"brand"===s.type){var r=s;switch(r.network){case"twitter":r.parentClass="socTwPosts",r.childClass="socAssoTwIcon";break;case"facebook":r.parentClass="socFbPosts",r.childClass="socAssoFbIcon"}t.push(r)}})),t},processAccount:function(e){$.each(e,(function(e,t){"brand"===t.type&&($.each(t.permissions,(function(e,o){$.each(o.profiles,(function(e,s){s.id===zsoTab.profileId&&(t.perm_type=zsoTab.getPermType(o.type))})),-1!==o.profiles.indexOf(zsoTab.profileId)&&(t.perm_type=o.perm_type)})),zsoTab.accounts[t.id]=t,zsoTab.brandsWithAccounts[t.brand.id]=!0,void 0===zsoTab.brandVsNetwork[t.brand.id]&&(zsoTab.brandVsNetwork[t.brand.id]={}),zsoTab.brandVsNetwork[t.brand.id][t.info.network]=t.id)}))},processAuditLogTime:function(e){if(void 0===e)return json;if(e.title_time=e.disp_time,e.key&&e.diff){var t=[];t.push(e.diff),e.disp_time=I18n.getMsg(e.key,t)}else e.diff?e.key||(e.disp_time=e.diff):e.disp_time=I18n.getMsg(e.key);return e},saveWidgetOrder:function(){var e={};e.csrfParamName=csrfParamName,e.csrfToken=csrfToken;var t=[];$.each($L(".socCustomColumn"),(function(e,o){var s=$L(o).attr("filter_id");s&&t.push(s)})),t.length>1&&(e.order=t.toString(),store.triggerAction("monitor_column","save_order",e).then((function(){})))},applyShadow:function(e,t){$L(e).scrollTop()>50?$L("."+t).addClass("socScrollShadow"):$L("."+t).removeClass("socScrollShadow")},monitorApplySortable:function(){var e=this,t=$L("#socMonitorContentInner");t&&t.length>0&&t.sortable({containment:"#socMonitorContent",tolerance:"pointer",orientation:"horizontal",onDrop:function(){e.saveWidgetOrder()}}),$L("#socMonitorEmpty").removeClass("sortable-element sortable-element-h1")},monitorDestroySortable:function(){var e=$L("#socMonitorContentInner");e&&e.length>0&&e.sortable("destroy")},showMoreLoading:function(e){var t=$L(e).closest(".showmoreNew");t.find(".showmoreNewLink").addClass("dN"),t.find(".showmoreLoadingImg").removeClass("dN")},showMoreRemove:function(e){var t=$L(".showmoreNew");if(e){var o=$L(e).closest(".showmoreNew");o&&o.length>0&&(t=o)}t&&t.length>0&&t[0].remove()},showMessageBox:function(e,t){var o=$L("crm-social-tab-new");o&&o.length>0&&o[0].component.setData({socMsgBandShow:!0,socMsgBandType:e,socMsgBandMessage:t})},setColumnTypeModalHeight:function(e){$L("#"+e)[0].calculateOffset();var t=$L("."+e),o=renderingUtils.windowHeight-30,s=t.find("lyte-modal-header"),r=t.find("lyte-modal-content"),a=t.find("lyte-modal-footer"),i=0;"socColumnTypeModal"===e?i=0===a.length||a.hasClass("dN")?0:a.outerHeight():a.length&&(i=a.outerHeight());var n=o-(s.outerHeight()+i);r.css({"max-height":n+"px",height:n+"px"})},columnTypeHeaderCalc:function(e){$L("#socColumnTypeModal")[0].calculateOffset();var t,o=$L(".socColumnTypeModal"),s=o.find("lyte-modal-header"),r=o.find("lyte-modal-content"),a=o.find("lyte-modal-footer"),i=s.outerHeight(),n=a.outerHeight();"hidden"===e&&(i=0),"show"===e&&(n=0),t=o.find(".lyteModal").outerHeight()-(i+n),r.css({"max-height":t+"px",height:t+"px"})},processAuditLog:function(e){if(e){var t,o=[],s={},r=0,a=0;e&&e.cursor&&(t=e.cursor);for(var i=(e=e.data?e.data:e).length,n=0;n<i;n++){var c=e[n],l=c.auditedtime;if(0===r)r=l.month,a=l.year,(d={date_separator:!0}).month=Utils.getMonth(r),d.year=a,d.auditlogid=Math.floor(1e5*Math.random()+1),o.push(d);else if(l.month!==r){var d;(d={date_separator:!0}).month=Utils.getMonth(r),d.year=a,d.auditlogid=Math.floor(1e5*Math.random()+1),r=l.month,a=l.year,o.push(d)}c.auditedtime=this.processAuditLogTime(c.auditedtime),o.push(c)}s.data=o,s.cursor=t}return s},beforeExitTab:function(){var e=$L("crm-social-right-panel");e&&e.length>0&&e[0].remove();var t=$L("crm-social-post-detail-outer");t&&t.length>0&&t[0].remove();var o=$L("crm-social-quote-tweet-new");o&&o.length>0&&o[0].remove();var s=$L("crm-social-convo-outer-new");s&&s.length>0&&s[0].remove();var r=$L("crm-social-compose-post-new");r&&r.length>0&&r[0].remove();var a=$L("crm-social-right-panel-search");a&&a.length>0&&a[0].remove();var i=$L("crm-zso-entity-create");i&&i.length>0&&i[0].remove()},handleReauth:function(e,t){if("twitter"===t&&void 0!==e){var o=$L("#"+e.network+"_my_col_posts"),s=renderingUtils.createHTML({name:"div",attr:{class:"pA socAccReauth aligncenter"},child:[{name:"span",attr:{class:"dIB svgIcons socAccWarningIcon"}},{name:"span",attr:{class:"dB crmNotFoundColor"},child:[{name:"text",content:I18n.getMsg("crm.social.integ.reauth.error")}]}]});o.empty(),null!==o&&o.append(s),o.closest(".socCustomColumn").find(".socRefresh").removeClass("socRefreshRotate"),this.updateReAuthStatus(e.brand.id,e.network)}},getDetailPage:function(e,t){sE(event);var o=event.target;if(o&&o.className&&"socMsgHandleElement"===o.className)this.processTwitterTagOnclick(o);else{var s=$L(e),r=$L("#socViewConvPopup"),a=s.attr("account_id"),i=s.attr("network"),n=s.attr("parent_post_id"),c=s.attr("brand_id");if("related_list"===t){var l=$L("#socIntDetView");$L("#socIntMsgDiv").fadeOut(),l.fadeIn()}else this.appendPostDetailDiv(),s.parents("#ziaChatbotDiv").length&&r.css("z-index","35");this.getParentPost(c,n,void 0,i,a,void 0,!1,t)}},processFilters:function(e,t){var o={monitor_column:[]},s=this;return $.each(e,(function(e,r){if(void 0!==r.type)switch(r.type){case"mention":r.display_name=I18n.getMsg("crm.social.mentions");break;case"timeline":r.display_name=I18n.getMsg("crm.social.timeline");break;case"like":r.display_name=I18n.getMsg("crm.social.likes");break;case"keyword_search":r.display_name=r.info.keyword,r.title=I18n.getMsg("crm.social.keyword.search");break;case"user_search":r.title=I18n.getMsg("crm.social.user.search"),r.display_name=r.info.name;break;case"page_search":r.title=I18n.getMsg("crm.social.page.search"),r.display_name=r.info.name;break;case"list":r.title=I18n.getMsg("crm.social.lists"),r.display_name=r.info.name;break;default:return}s.getAccountByBrandIdAndNetwork(t,r.network)&&o.monitor_column.push(r)})),o}},{mixins:["crm-social-entity","crm-social-integration"]}),Lyte.Mixin.register("crm-social-tab_actions",{appendPostDetailDiv:function(){commonUtils.showHideLoadingDiv(!0)},getParentPost:function(e,t,o,s,r,a,i,n){var c=Lyte.registeredMixins["crm-social-tab"];if(e||(e=$L(".selectedBrand").attr("value")),!c.checkReauthStatus(e,s,n)){c=this;var l={brand_id:e,network:s,post_id:t,parent_post_id:o,account_id:r,column_id:a,childPost:i,place_type:n};store.findRecord("crm_social_post",t,void 0,void 0,void 0,{brand_id:e,network:s}).then((function(e){commonUtils.showHideLoadingDiv(!1),c.renderParentPostDetail(l,e)}),(function(e){var t=$L("#socViewConvPopup");t&&t[0]&&t[0].remove(),Lyte.registeredMixins["crm-social-tab"].handleErrorCase(e)}))}},renderParentPostDetail:function(e,t){var o=renderingUtils.tabLayerTop()+renderingUtils.tabLayerOuterHeight();if(t&&void 0===t.code){var s=t[0].parent_author_name,r=t[0].reply_text,a="@"+s;r.includes(a)&&(t[0].reply_text=r.replace(a,""));var i=t[0]?t[0]:t.crm_social_post?t.crm_social_post[0]:t,n=i.parent_post_id;i.parent_post_id=null,i.place_type="post_detail";var c=$L(".socViewConvoInner"),l=$L("crm-social-tab-new");if("googleplus"!==e.network&&(i.image=!0),e.childPost){var d=document.createElement("crm-social-my-posts");if(d.setData({data:[i],place_type:i.place_type,child_post:!0,preview:!0}),"related_list"===e.place_type)$L("#socIntDetView").find(".socViewConvChild").append(d);else if(l.length>0){$L(".socViewConvoParent").find(".socViewConvChild")[0].prepend(d)}else{$L("#signalPopupInnerDiv").find(".socViewConvChild").append(d),$L(".socViewConvoClose").hide()}thirdPartyUtils.titleForEllipsis(".socIntName")}else{"twitter"===e.network?i.success_text="REPLY":i.success_text="COMMENT";var p=$L("crm-social-post-detail-outer");p&&p.length>0&&p[0].remove();var m=$L("crm-social-quote-tweet-new");m&&m.length>0&&m[0].remove();var u=document.createElement("crm-social-post-detail-outer");if(u.setData(i),"related_list"===e.place_type){u.setData({related_list:!0});var g=$L("#socIntDetView");g.append(u),g.addClass("socOuterContainer"),$L(".socialBackToColumn").removeClass("dN")}else{if(u.setData("renderPostDetails",!0),l.length>0)l.append(u);else{$L("#loadMsg").hide();var f=$L("#showSignalPop");f.append(u),f.addClass("socOuterContainer"),this.setHeightForConvoPopup("Convo"),$L(".socViewConvoClose").hide()}c.css("top",o),this.setHeightForConvoPopup("Convo")}thirdPartyUtils.titleForEllipsis(".socViewConvoHName, .socViewConvoName")}n&&this.getParentPost(e.brand_id,n,n,e.network,e.account_id,e.column_id,!0,e.place_type)}else{var h=$L("#socViewConvPopup");h&&h[0]&&h[0].remove(),Lyte.registeredMixins["crm-social-integration"].handleErrorCase(t,"GET","posts")}},setHeightForConvoPopup:function(e){var t=$L("#tabLayer"),o=null;o=$L("#signalPopupViewContent").is(":visible")?$L("#signalPopupViewContent .popup-model-content").outerHeight()-($L(".socView"+e+"Header").outerHeight()+$L(".socView"+e+"Reply").outerHeight()):renderingUtils.windowHeight-(t.offset().top+t.outerHeight()+70+$L(".socView"+e+"Header").outerHeight()+$L(".socViewConvoInner").find(".socView"+e+"Reply").outerHeight()),$L(".socView"+e+"Parent").css("max-height",o)},viewConvoClose:function(){var e=$L("crm-social-post-detail-outer");e&&e.length>0&&e[0].component.setData("renderPostDetails",!1)},backToMessages:function(){$L("#socAllMessages").removeClass("dN"),$L("#socMessageDetail").addClass("dN").html(""),$L(".socConvMsgTitle").removeClass("dN"),$L(".socBackToMsgs").addClass("dN"),$L("#socIntDetView").hide().html(""),$L("#socIntMsgDiv").show()},postComment:function(e,t,o,s,r,a,i,n,c){if(!this.checkReauthStatus(s,r,n)){t&&(e=e||"");var l={};l.brand_id=s,l.network=r,l.post_id=o,l.postComments=!0;var d={};if(l.message=e,t)l.file=t,l.fileName=t.name;else if(!e)return;l.fdata=d;var p={brand_id:s,place_type:a,post_id:o,network:r,reply_to_comment:i,account_id:c},m=this;store.unloadAll("crm_social_posts_comment"),store.create("crm_social_posts_comment",d,l,void 0).then((function(e){m.processPostComment(p,e)}),(function(e){Lyte.registeredMixins["crm-social-tab"].handleErrorCase(e)}))}},processPostComment:function(e,t){var o=Lyte.registeredMixins["crm-social-tab"],s=Lyte.registeredMixins["crm-social-tab_actions"],r=Lyte.registeredMixins["crm-social-integration"];if((t=t.crm_social_posts_comment)&&t[0]){if(t=o.processComments(t),"twitter"===e.network&&(t.data[0]=t[0]),-1===e.place_type.indexOf("detail"))s.removeAddedTemplate(),t[0].parent_post_id=null,t[0].perm=4,t.className="",t.no_action=!0;else{var a=$L('[text_id="'+e.place_type+'"]');a[0].ltProp("value",""),this.processText(e.post_id+"_"+e.place_type,e.network);var i=a.parent().find(".socReplyAttImgs");i.length>0&&s.removeImage(i,e.place_type)}t[0].inline_comment=e.reply_to_comment,"facebook"!==e.network&&"googleplus"!==e.network||s.handleComment(e,!0);var n=$L("#comments_"+e.place_type);if("twitter"===e.network){t[0].child_post=!0;var c=document.createElement("crm-social-my-posts");c.setData("data",t),n.append(c),thirdPartyUtils.titleForEllipsis(".socIntName"),r.processTwitterTags()}else{var l={comments:{data:[t[0]]},place_type:e.place_type,inline_comment:e.reply_to_comment,id:e.post_id};Lyte.Component.render("crm-social-comments-outer",l,"#comments_"+e.place_type)}n.removeClass("dN")}else o.handleErrorCase(t,"POST","comments")},handleComment:function(e,t){var o=e.post_id,s=$L('[id="'+o+'_comment_btn"][account_id="'+e.account_id+'"]');$.each(s,(function(e,o){var s=$L(o),r=s.find(".socialImgsvg");0===r.length&&(r=s.find(".socialImg"));var a=r.next("span"),i=a.html();t?i?a.html(parseInt(i)+1):a.html("1"):"1"===i?a.html(""):a.html(parseInt(i)-1)}))},appendReplyTemplate:function(e,t,o,s,r,a,i){var n={},c=$L(".socDetailModal").find("lyte-modal-content");"related_list"===s?(s=o+"_"+s,n=store.peekAll("social_related_list")[0]):"dashboard_feeds"===s?(s=o+"_"+s,n=store.peekAll("Social")[0]):n=store.peekAll("social_related_list")&&store.peekAll("social_related_list").length>0?store.peekAll("social_related_list")[0]:store.peekAll("Social")[0];var l={};$.each(n.accounts,(function(e,o){if(o.id===t)return l.account=o,o.reauth&&crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.reauth.error"),3e3),!1}));var d=$L(e).closest(".SocContentSections"),p=$L(e).closest("crm-social-comments-detail");p&&p.length>0&&(p[0].component.data.inline_comment&&(d=p.closest(".parentComment").find(".SocContentSections")));if(d.hasClass("templateAdded"))this.removeAddedTemplate();else{this.removeAddedTemplate(),l.place_type=s,l.template_name=a,"twitter"===r?(l.image=!0,l.twitter=!0,l.success_text="REPLY",l.reply_text=i,i=void 0):i?l.success_text="REPLY":("googleplus"!==r&&(l.image=!0),l.success_text="COMMENT"),l.id=o,l.reply_to_comment=i,l.network=r,(e=document.createElement("crm-social-reply-template-new")).setData(l);var m=d.closest(".infoDiv");if(m.append(e),d.addClass("templateAdded"),$L(".templateAdded").closest(".socDetailModal").length){var u=c.scrollTop();u+=82,c.scrollTop(u)}var g=m.find("textarea").focus();g.length>0&&g[0].setSelectionRange(g.val().length,g.val().length)}},removeAddedTemplate:function(){var e=$L(".templateAdded"),t=e.closest(".SocContentSections").parent().parent().find("lyte-input");t&&t[0]&&(t=t.closest(".postResponse"))[0].remove(),e.removeClass("templateAdded")},like:function(e,t,o){var s=$L(e).closest(".infoDiv"),r=s.attr("post_id"),a=s.attr("network"),i=s.attr("brand_id");i||(i=$L(".selectedBrand").attr("value"));var n=s.attr("account_id");this.postLike(i,r,a,!t,n,o)},postLike:function(e,t,o,s,r,a){if(!this.checkReauthStatus(e,o,a)){var i=this,n={brand_id:e,account_id:r,network:o,like:s,post_id:t},c=Lyte.registeredMixins["crm-social-tab"];s?store.triggerAction("crm_social_post","like",{brand_id:e,network:o,post_id:t,method:"POST"}).then((function(e){i.renderPostLike(n,e)}),(function(e){c.handleErrorCase(e.response?JSON.parse(e.response):e)})):store.triggerAction("crm_social_post","like",{brand_id:e,network:o,post_id:t,method:"DELETE"}).then((function(e){i.renderPostLike(n,e)}),(function(e){c.handleErrorCase(e.response?JSON.parse(e.response):e)}))}},renderPostLike:function(e,t){if(t.code)this.handleErrorCase(t,"POST","like");else{var o=e.post_id,s=$L('[id="'+o+'_like_btn"][account_id="'+e.account_id+'"]');this.handleCounts(s,e.like);for(var r="twitter"===e.network?"socFavIconActive":"socFbLikeIconActive",a=s.length,i=0;i<a;i++){var n=s.eq(i),c=n.find(".socialImgsvg");0===c.length&&(c=n.find(".socialImg"));var l=n.closest(".socialActions").find(".socIconsActive").find("."+r);e.like?(c.addClass(r),l.addClass("socialImgsvg")):(c.removeClass(r),l.removeClass("socialImgsvg"))}var d=s.closest("crm-social-comments-detail");d&&d.length>0&&(e.like?d[0].component.data.likes.has_liked=!0:d[0].component.data.likes.has_liked=!1);var p=["crm_social_feed","crm_social_post","crm_social_interaction","crm_social_posts_comment","posts"],m=p.length;for(i=0;i<m;i++){var u=p[i],g=store.peekRecord(u,o);g&&(e.like?g.likes?g.likes.has_liked=!0:g.interaction_info&&g.interaction_info.likes?g.interaction_info.likes.has_liked=!0:g.post_info&&g.post_info.likes?g.post_info.likes.has_liked=!0:g.favorited=!0:g.likes?g.likes.has_liked=!1:g.interaction_info&&g.interaction_info.likes?g.interaction_info.likes.has_liked=!1:g.post_info&&g.post_info.likes?g.post_info.likes.has_liked=!1:g.favorited=!1)}}},retweetTweet:function(e,t,o){var s=$L(e).closest(".infoDiv"),r=s.attr("post_id"),a=s.attr("account_id"),i=s.attr("brand_id");i||(i=$L(".selectedBrand").attr("value")),t?this.retweet(i,r,!1,a,o):this.getPostInfoForRetweet(i,r,o)},getPostInfoForRetweet:function(e,t,o){if(!this.checkReauthStatus(e,"twitter",o)){var s=this,r={brand_id:e,network:"twitter",post_id:t},a=store.peekRecord("crm_social_post",t);a?s.renderPostDetailForRetweet(r,a):store.findRecord("crm_social_post",t,void 0,void 0,void 0,{brand_id:e,network:"twitter"}).then((function(e){s.renderPostDetailForRetweet(r,e)}),(function(e){s.handleErrorCase(e)}))}},renderPostDetailForRetweet:function(e,t){if(commonUtils.showHideLoadingDiv(!1),t.code)this.handleErrorCase(t);else{var o=t[0]?t[0]:t.crm_social_post?t.crm_social_post[0]:t,s=$L("crm-social-quote-tweet-new");s&&s.length>0&&s[0].remove();var r=$L("crm-social-right-panel");r&&r.length>0&&$L(".socProfileDetPopup").is(":visible")&&r[0].component.setData("renderRightPanelPopup",!1);var a=$L("crm-social-convo-outer-new");if(a&&a.length>0)a[0].component.data.related_list||a[0].remove();var i=$L("crm-social-direct-message-new");i&&i.length>0&&i[0].remove(),Lyte.Component.render("crm-social-quote-tweet-new",o,"body").setData("renderQouteTweet",!0)}},retweet:function(e,t,o,s,r){if(!this.checkReauthStatus(e,"twitter",r)){var a=this,i={brand_id:e,network:"twitter",post_id:t,account_id:s,retweet:o},n=o?"POST":"DELETE",c=Lyte.registeredMixins["crm-social-tab"];store.triggerAction("crm_social_post","retweet",{brand_id:e,network:"twitter",post_id:t,method:n}).then((function(e){a.renderRetweet(i,e)}),(function(e){c.handleErrorCase(e.response?JSON.parse(e.response):e,"retweet","POST")}))}},renderRetweet:function(e,t){if(commonUtils.showHideLoadingDiv(!1),t.code)zsoTab.handleErrorCase(t,"POST","retweet");else{var o=e.post_id,s=$L('[id="'+o+'_retweet_btn"][account_id="'+e.account_id+'"]');this.handleCounts(s,e.retweet);for(var r=s.length,a=0;a<r;a++){var i=s.eq(a),n=i.find(".socialImgsvg");0===n.length&&(n=i.find(".socialImg"));var c=i.closest(".socialActions").find(".socIconsActive").find(".socRetweetIcon");e.retweet?(n.addClass("socReTwtIconActive"),c.addClass("socialImgsvg")):(n.removeClass("socReTwtIconActive"),c.removeClass("socialImgsvg"))}var l=["crm_social_feed","crm_social_post","crm_social_interaction","crm_social_posts_comment"],d=l.length;for(a=0;a<d;a++){var p=l[a],m=store.peekRecord(p,o);m&&(e.retweet?m.retweets?m.retweets.has_retweeted=!0:m.interaction_info&&m.interaction_info.retweets?m.interaction_info.retweets.has_retweeted=!0:m.post_info&&m.post_info.retweets?m.post_info.retweets.has_retweeted=!0:m.retweeted=!0:m.retweets?m.retweets.has_retweeted=!1:m.interaction_info&&m.interaction_info.retweets?m.interaction_info.retweets.has_retweeted=!1:m.post_info&&m.post_info.retweets?m.post_info.retweets.has_retweeted=!1:m.retweeted=!1)}if(e.retweet){var u=$L("crm-social-quote-tweet-new");u&&u.length>0&&(u[0].component.setData("renderQouteTweet",!1),u[0].remove());var g=$L("crm-social-streams-outer");g&&g.length>0&&g[0].component.setData("renderSocialStreams",!0);var f=$L("crm-social-right-panel");f&&f.length>0&&f[0].component.setData("renderRightPanelPopup",!0)}}},handleCounts:function(e,t){$.each(e,(function(e,o){var s=$L(o),r=s.find(".socialImgsvg");0===r.length&&(r=s.find(".socialImg"));var a=r.next("span"),i=a.html();t?"0"===i||""===i?a.html("1"):a.html(parseInt(i)+1):"1"===i||"0"===i?a.html(""):a.html(parseInt(i)-1)}))},submitRetweet:function(e,t,o,s,r){var a=$L(e).closest(".infoDiv"),i=a.attr("brand_id");if(i||(i=$L(".selectedBrand").attr("value")),i||(i=r),commonUtils.showHideLoadingDiv(!0),s){if(this.checkReauthStatus(i,"twitter"))return;var n=a.attr("screen_name"),c=this,l={brand_id:i,network:"twitter",post_id:t,method:"POST",retweet:!0,account_id:o};store.triggerAction("crm_social_post","retweet",l,{screen_name:n,message:s}).then((function(e){c.renderRetweet(l,e)}),(function(e){c.handleErrorCase(e)}))}else this.retweet(i,t,!0,o)},getProfileDetailPage:function(e){$L(".socTabBody").addClass("dN");var t=$L(e).closest(".infoDiv"),o=t.attr("brand_id"),s=t.attr("profile_id"),r=t.attr("network"),a=$L("#socDashboardDetailView"),i=$L("#socialTabNew").find(".socTabBody").outerHeight(),n=$L("crm-social-detail-outer");n&&n[0]&&n[0].remove(),Lyte.Component.render("crm-social-detail-outer",{},"#socDashboardDetailView"),a.removeClass("dN"),a.css("height",i+"px"),this.getEntityDetails(s,o,r)},getEntityDetails:function(e,t,o){var s={network:o,profile_id:e,brand_id:t},r=this;store.findAll("crm_social_info",void 0,void 0,void 0,{network:o,profile_id:e}).then((function(e){r.renderEntityDetails(s,e)}))},renderEntityDetails:function(e,t){if(t){var o=null,s={},r=t,a=e.brand_id;if(r.twitter&&this.getAccountByBrandIdAndNetwork(a,"twitter")&&(o=r.twitter,s.twitter=r.twitter),r.facebook&&this.getAccountByBrandIdAndNetwork(a,"facebook")&&(o=null===o?r.facebook:o+","+r.facebook,s.facebook=r.facebook),r.googleplus&&this.getAccountByBrandIdAndNetwork(a,"googleplus")&&(o=null===o?r.googleplus:o+","+r.googleplus,s.googleplus=r.googleplus),o)$L(".profileIds").attr("ids",o),this.getInteractions(void 0,e.brand_id,null,void 0,o,"interaction_page"),this.getProfileInfos(s,r),this.getRightPanelInfo(r);else{$L(".profileIds").attr("ids",e.profile_id);var i=e.network;r={network:e.profile_id},this.getInteractions(void 0,e.brand_id,null,void 0,e.profile_id,"interaction_page"),this.getProfileInfos(i+"="+e.profile_id,r)}}},getRightPanelInfo:function(e){delete $$rightPanel.rpCachedList,$$rightPanel.rpCachedList=new Array,delete $$rightPanel.rpTabOrder,"Accounts"===e.module?$$rightPanel.rpTabOrder=["info","timeline"]:$$rightPanel.rpTabOrder=["conversation","info","timeline"],$$rightPanel.currentModule=e.module,$$rightPanel.entityId=e.id,$$rightPanel.newSocial=!0,$$rightPanel.loadSocial=!1,$$rightPanel.caller="Feeds",$$rightPanel.rpParentContainer="social_parent",$$rightPanel.detailRightPanel("krp_tab1",$$rightPanel.rpTabOrder[0],!0)},getProfileInfos:function(e){var t=$L(".selectedBrand").attr("value"),o=this;store.findAll("crm_social_info",e,void 0,void 0,{brand_id:t}).then((function(t){o.renderProfileInfos(e,t)}))},renderProfileInfos:function(e,t){if(t&&t[0]){var o=$L(".socProfileGp");$.each(t,(function(e,t){if(t.network){var s=null;switch(t.network){case"twitter":s=".socProfileTw";break;case"facebook":s=".socProfileFb";break;case"googleplus":s=o}Lyte.Component.render("crm-social-entity-profile-info",{info:t},s),$L(s).removeClass("dN")}}))}},removeImage:function(e){var t=$L(e),o=t.parents(".socialCommonPreviewDiv");(o.addClass("dN"),t.closest(".socIntDetView").length)?$L(".socIntDetView .socViewConvoParent").css("bottom",""):Lyte.registeredMixins["crm-social-tab"].setHeightForConvoPopup("Convo");o.find("img").removeAttr("src").removeAttr("title"),t.parents(".postResponse").find(".socialCommonAttach").val("")},getMoreLikes:function(e,t,o){var s=$L(e),r=s.closest(".infoDiv"),a=r.attr("post_id"),i=r.attr("network"),n=s.attr("place_type"),c=r.attr("brand_id");c||(c=$L(".selectedBrand").attr("value")),this.getLikes(c,a,i,n,t,o)},getLikes:function(e,t,o,s,r,a){if(!this.checkReauthStatus(e,o)){var i={};r&&(i.cursor=r);var n={brand_id:e,place_type:s,post_id:t,network:o,cursor:r,like_count:a},c=this;app.store.makeRequest("findRecord","crm_social_post",t,i,void 0,void 0,{brand_id:e,network:o,like:"/like"}).then((function(e){c.renderGetLikes(n,e)}),(function(e){Lyte.registeredMixins["crm-social-tab"].handleErrorCase(e)}))}},renderGetLikes:function(e,t){if(t&&(e.users=t,e.users.length>20&&(e.paging=t.posts.paging)),e.cursor){$L(".socLikeCountUl").find(".showmoreNew").empty();var o=document.createDocumentFragment();$.each(e.users,(function(e,t){o.append(renderingUtils.createHTML({name:"li",child:[{name:"div",child:[{name:"img",attr:{src:t.image,class:"dIB vaM"}},{name:"span",attr:{class:"dIB vaM mL5 crmNotFoundColor"},child:[{name:"text",content:t.name}]}]}]}))})),e.paging&&o.append(renderingUtils.createHTML({name:"div",attr:{class:"showmoreNew p20 aligncenter"},child:[{name:"a",child:[{name:"text",content:I18n.getMsg("crm.nsocial.tab.show.more")}],attr:{class:"cP","data-zcqa":"cursor",onclick:"sE(event);zsoTab.getMoreLikes(this,'"+JSON.stringify(e.paging)+"')"}}]})),$L("#socLikeCountPopup").find(".socLikeCountUl").append(o)}else{$L("#socLikeCountPopup").empty();var s=document.createElement("crm-social-like-count-popup");s.setData(e),$L("#showSignalPop").after(s)}},dropDownClose:function(){var e=$(".socEntityDropDown");e.is(":visible")&&e.addClass("dN");var t=$(".socEntityInput div[name=ownerNameLookup]");t.is(":visible")&&t.hide()},confirmDelComment:function(e,t,o,s){e=$L(e),$L(".socDeleteIcon").removeAttr("id"),e.attr("id","socDeletePostElement");var r=[],a=e.closest(".parentPost").attr("brand_id");r.push({value:a}),r.push({value:o});var i=null,n=null;s&&""!==s&&o!==s&&"twitter"!==t?(i=I18n.getMsg("crm.nsocial.tab.fb.delete.comment"),r.push({value:s}),n="deleteComment"):(i=I18n.getMsg("crm.nsocial.tab.fb.delete.post"),r.push({value:o}),n="deletePost"),r.push({value:t});var c={message:i,successFn:n,successparams:r},l=document.createElement("crm-social-delete-warning-popup");l.setData(c),$L("#socialDashboard")[0].after(l)},processTextPaste:function(e,t){var o=this;window.setTimeout((function(){o.processText(e,t)}),1)},setModalContentHeight:function(e){Lyte.registeredMixins["crm-social-tab"].setColumnTypeModalHeight(e)}},{mixins:["crm-social-tab","crm-social-integration"]}),Lyte.Mixin.register("crm-social-integration",{getAllAccountsByCriteria:function(e,t,o,s){var r=store.peekAll("social_related_list")[0].accounts,a=[];return $.each(r,(function(r,i){void 0!==e&&e!==i.network||void 0!==t&&t!==i.type||!(void 0===o||o>=i.perm_type)||void 0!==s&&s!==i.status||a.push(i)})),a},saveProfile:function(e,t,o,s,r){var a=$L("#module").val(),i="Crm_Implied_Edit_"+a;if(s||Crm.userDetails.permissions[i]){if(void 0!==r){var n=$L("#zso_AssociateProfile_"+t+"_search");n.addClass("eventNone"),n.find(".socBtnLoadText").css("visibility","hidden"),n.find(".socBtnLoading").removeClass("dN").addClass("dIB")}var c,l,d=this.getFirstAccountIdByNetwork(e),p={network:e,profiles:{id:t},id:d,automate:s},m={network:e,profiles:{id:t},automate:s},u=$L("crm-social-integ-outer-template");u&&u.length>0&&(l=u[0].component.data),c=l&&"canvas"===l.source?l.record_id:$L("#entityID").val();var g=this;if(o)m.id=t,store.create("social-profile",{},{module:a,entityId:c,saveProfile:!0,id:d,network:e,profiles:{id:t},automate:s}).then((function(e){e.data=e["social-profile"],delete e["social-profile"],g.processSaveProfile(p,e)}));else{var f=store.peekRecord("social-profile",d);f&&f.$.deleteRecord(),m.id=d,m.module=a,m.entityId=c,m.saveProfile=!0,commonUtils.showHideLoadingDiv(!0),store.triggerAction("social-profile","deleteProfile",m,void 0,"DELETE",m).then((function(e){commonUtils.showHideLoadingDiv(!1),crmui.hideTooltip(),g.processDeleteProfile(p,e)}))}}else _cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropDuration:5e3,ltPropMessage:I18n.getMsg("crm.zti.error.notauthendication")}})},getFirstAccountIdByNetwork:function(e,t,o){var s=store.peekAll("social_related_list")[0],r=null;return 1===t||void 0===t?s.brandParent&&void 0!==s.brandParent[e]&&(r=s.brandParent[e],void 0!==o&&s.accIdVsPerm[r]>o&&(r=null)):2!==t&&void 0!==t||void 0===s.personalAcc[e]||(r=s.personalAcc[e]),r},processSaveProfile:function(e,t){if(void 0!==t.data&&t.data.length>0){var o=t.data[0],s=o.details;if(s.profile_id=e.profiles.id,e.profile_id=e.profiles.id,e.account_id=e.id,"SUCCESS"===o.code)this.processProfileInfo(e,{profiles:[o.details.profiles]}),this.changeAfterSaveProfile(e.network,e.profiles.id,s.profiles.screen_name),o.record_image_status&&this.handleErrorCase(o,void 0,void 0);else if("DUPLICATE_DATA"===o.code)if(e.automate){document.getElementsByTagName("crm-social-integ-outer-template")[0].component;0}else{"twitter"===e.network&&this.addRemoveTwitterHandle(void 0,!1),crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.profile.save.error1",Crm.getCrmBasePath()+"/EntityInfo.do?id="+o.details.entityid+"&module="+o.details.module),1e4);var r=$L("#zso_AssociateProfile_"+s.profile_id+"_search");r.removeClass("eventNone"),r.find(".socBtnLoadText").css("visibility",""),r.find(".socBtnLoading").addClass("dN").removeClass("dIB"),button.text(I18n.getMsg("crm.social.integ.profile.associate")).removeClass("outlineprimary newbutton").addClass("primarybtn"),this.socContainMsgBandTop()}else"error"===o.status&&this.handleErrorCase(o,void 0,void 0)}},processProfileInfo:function(e,t){if(void 0!==t&&0!==Object.keys(t).length){t.info=t.profiles[0],$L("#"+e.network+"_integ_filter").show(),$L(".socNwSuggList").css({display:"none"}),$L(".socIntMessage").css({display:"block"}),t.account_id=e.account_id,"twitter"===e.network&&void 0===e.profile_id?(t.profile_id=t.info.id,this.saveProfile("twitter",t.profile_id,!0,!0)):t.profile_id=e.profile_id;var o=this.getAllAccountsByCriteria(e.network,void 0,3,1);objectUtils.getLength(o)>1&&(t.moreAccounts=!0);var s=store.peekAll("social_related_list")[0];$.each(s.accounts,(function(e,o){o.id===t.account_id&&(t.brid=o.brid,t.perm=o.perm_type)})),t.info&&(t.following=t.info.follow_request_sent?t.info.follow_request_sent:t.info.following),$L("#"+e.network+"_leftpanel").empty(),t.marking_id=e.marking_id?e.marking_id:t.info.marking_id,Lyte.Component.render("crm-social-profile-info",t,"#"+e.network+"_leftpanel"),thirdPartyUtils.titleForEllipsis(".socNwName"),"twitter"===e.network?$L("#socStreamTw").removeClass("dN").addClass("dIB").find("span:nth-child(1)").text("@"+t.info.screen_name):"facebook"===e.network&&$L("#socStreamFb").removeClass("dN").addClass("dIB").find("span:nth-child(1)").text(t.info.name)}else{var r=document.getElementsByTagName("crm-social-integ-outer-template")[0].component;r.getSearchInfo("twitter",r.getEntityName(),!0)}},changeAfterSaveProfile:function(e,t,o){switch($L("#"+e+"_integ_filter").show(),e){case"twitter":$L("#twProfile").val(t),$L(".socAssoTwList").removeClass("socialActiveInfo").addClass("dN"),this.addRemoveTwitterHandle(o,!0),$L("#socStreamTw").removeClass("dN").addClass("dIB").find("span:nth-child(2)").text(o);var s=this.getAllAccountsByCriteria("twitter",void 0,3,1),r=this.getTwitterIds(s);r.length>0&&(this.showDMSection(r,t),this.showTweetSection());break;case"facebook":$L("#fbProfile").val(t),$L("#socStreamFb").removeClass("dN").addClass("dIB").find("span:eq(1)").text($("#facebook_name").text())}$L("#social_streams_button").show();var a=document.getElementsByTagName("crm-social-integ-outer-template")[0].component;a.updateSocialObj();var i=a.data.SOCIALPROFILES;void 0===i&&(i={}),i[e]=t,a.setData("SOCIALPROFILES",i),a.fetchSocialInteractions("all")},addRemoveTwitterHandle:function(e,t){var o=$L("#subvalue_TWITTER");if(Crm.userDetails.DETAIL_VIEW_LYTE&&o.length>0)t?o[0].setAttribute("cx-prop-value",e):(o[0].setAttribute("cx-prop-value",""),o[0].classList.add("zcicn-cssIcons"),o[0].classList.add("zcicn_grey_mask"),o[0].classList.add("dv_noDataSign"));else if(o.length>0){var s=$L("#value_TWITTER");if(t){o.html(e),o.attr("href",RebrandLinkUtil.getProperty("TW_URL")+"/"+e);var r=JSON.parse(s.parent().attr("data-params"));delete r.dataObj,r.defaultvalue=e,$("#mouseArea__TWITTER").attr("data-params",JSON.stringify(r)),returnJson.entMetaData.TWHandle=e}else{o.html(""),o.attr("href","");var a=JSON.parse(s.parent().attr("data-params"));delete a.dataObj,a.defaultvalue="",$L("#mouseArea__TWITTER").attr("data-params",JSON.stringify(a)),returnJson.entMetaData.TWHandle=""}}},showDMSection:function(e,t,o,s){var r=this.getAllAccountsByCriteria("twitter",void 0,2,1),a=[];if($.each(r,(function(e,t){a.push(t.id)})),a.length>0){var i,n,c,l=$L("crm-social-integ-outer-template");if(l&&l[0]&&(c=l[0].component.data),c&&"canvas"===c.source)i=c.record_id,n=c.module,t=c.SOCIALPROFILES.twitter?c.SOCIALPROFILES.twitter:t;else{var d=store.peekAll("social_related_list")[0];i=d.record_id,n=d.module,t=d.SOCIALPROFILES.twitter,t=$L("#twProfile").val()}var p={first:!0,accounts:e,entity_id:i,profileId:t},m={module:n,entityId:i};o||(o={ids:a.toString(),per_page:1});var u=this;store.findAll("relation",o,void 0,void 0,m).then((function(e){"processFollowInformation"===s?u.processFollowInformation(p,e):(u.processDMSection(p,e),$L("#socialInteractionNew").length>=1&&crmInteraction.addLyteTabInteraction(document.querySelector("#socialInteractionNew")))}))}},showSendDm:function(e){var t=this.getAllAccountsByCriteria("twitter",void 0,2,1),o=[];if($.each(t,(function(e,t){o.push(t.id)})),o.length>0){var s,r;s=$L("#entityID").val(),r=$L("#module").val();var a={first:!0,accounts:e,entity_id:s,profileId:$L("#twProfile").val()},i={module:r,entityId:s},n={ids:o.toString(),per_page:1};store.findAll("relation",n,void 0,void 0,i).then((function(e){Lyte.registeredMixins["crm-social-integration"].checkForDMSection(a,e)}))}},checkForDMSection:function(e,t){var o=[],s=[],r={},a=null,i=store.peekAll("social_related_list")[0],n=i.TWFollowInfo?i.TWFollowInfo:{},c=i.TWDMInfo?i.TWDMInfo:{};$.each(t,(function(t,l){void 0===l.code&&(l.account_id=l.id,$.each(i.accounts,(function(e,t){t.id===l.account_id&&(l.info=t.info,l.info.perm_type=t.perm_type)})),void 0===n[e.profileId]&&(n[e.profileId]={}),n[e.profileId][l.account_id]=l,l.source&&l.source.can_dm?(o.push(l.account_id),l.info.perm_type<3&&(a=l.account_id,r[l.account_id]=l,void 0===c[e.profileId]&&(c[e.profileId]={}),c[e.profileId][l.account_id]=l)):l.account_id?s.push(l.account_id):l.details&&l.details.account_id&&s.push(l.details.account_id))})),o.length>0&&a&&null!==a&&this.sendDm(a,e.profileId)},processDMSection:function(e,t){commonUtils.showHideLoadingDiv(!1);var o,s=[],r=[],a={},i=null,n=store.peekAll("social_related_list")[0],c=n.TWFollowInfo?n.TWFollowInfo:{},l=n.TWDMInfo?n.TWDMInfo:{};$.each(t,(function(t,o){void 0===o.code&&(o.account_id=o.id,$.each(n.accounts,(function(e,t){t.id===o.account_id&&(o.info=t.info,o.info.perm_type=t.perm_type)})),void 0===c[e.profileId]&&(c[e.profileId]={}),c[e.profileId][o.account_id]=o,o.source&&o.source.can_dm?(s.push(o.account_id),o.info.perm_type<3&&(i=o.account_id,a[o.account_id]=o,void 0===l[e.profileId]&&(l[e.profileId]={}),l[e.profileId][o.account_id]=o)):o.account_id?r.push(o.account_id):o.details&&o.details.account_id&&r.push(o.details.account_id))})),n.$.set("TWFollowInfo",c),n.$.set("TWDMInfo",l);var d=$L("crm-social-integ-outer-template");if(d&&d.length>0&&(o=d[0].component.data),!0===e.first&&!o||"canvas"!==o.source){if(s.length>0&&null!==i){var p=$L("crm-detailview-actions");p&&p.length>0&&p[0].setData("showDm",!0);var m=$L("#social_dmm_popup");if(m.empty(),Crm.userDetails.isRelatedListLyteEnabled)var u=$L('<span id="social_sendDM" name="SendDM"  data-zcqa="sendDM" onclick="crmSocialInteg.sendDm(\''+i+"','"+e.profileId+'\');"  class="newbutton mT5   mR0 w100_per dIB mB5 social_sendDMlistitem readOnlyMode alignLeft">'+I18n.getMsg("crm.social.integ.send.dm")+"</span>");else u=$L('<span id="social_sendDM" name="SendDM"  data-zcqa="sendDM" onclick="crmRelatedList.sendDm(\''+i+"','"+e.profileId+'\');"  class="newbutton mT5   mR0 w100_per dIB mB5 social_sendDMlistitem readOnlyMode alignLeft">'+I18n.getMsg("crm.social.integ.send.dm")+"</span>");m[0].append(u[0]),$L("#social_dmm_group input[type=button]").length>0?(m.addClass("socDMPopDD"),$L(".sendmaildropdown").css("display","inline-block"),$L(".sendmailgroupbtn").addClass("sendDMadded")):$L(".sendmailgroupbtn").css("border-right","none")}}else s.length>0&&$L("#twitterDmDrop").show()},showTweetSection:function(){var e=this.getAllAccountsByCriteria("twitter",void 0,1,1);if(objectUtils.getLength(e)>0){$L("#social_sendTweet").empty();var t={name:"input",attr:{id:"social_sendTweet",name:"SendTweet",type:"button","data-zcqa":"SendTweet",onclick:"crmSocialInteg.addPostDiv('twitter');",value:I18n.getMsg("crm.social.integ.send.tweet"),class:"dN newbutton outlinegreenlight readOnlyMode"}};$L("#fixedBtn").append(renderingUtils.createHTML(t))}},processDeleteProfile:function(e,t){var o;if(void 0!==t.data&&t.data.length>0&&"SUCCESS"===t.data[0].code){var s=$L("crm-social-integ-outer-template")[0].component.data.entity_name;if("undefined"!=typeof returnJson&&void 0!==returnJson.entMetaData&&(o=returnJson.entMetaData.saltName),o&&(s=s.replace(o,"")),!s){var r=$L("crm-detailview-section"),a=$L("crm-detailview-header");s=r.length>0?r[0].component.data.Full_name?r[0].component.data.Full_name:"":a.length>0&&a[0].component.data.entityName?a[0].component.data.entityName:""}s=s.trim(),"facebook"===e.network&&$L(".socAssociatedFb").removeClass();var i=document.getElementsByTagName("crm-social-integ-outer-template")[0].component;this.changeAfterDeleteProfile(e.network),i.getSearchInfo(e.network,s)}},changeAfterDeleteProfile:function(e){$L("#"+e+"_integ_filter").hide();var t=document.getElementsByTagName("crm-social-integ-outer-template")[0].component;switch(e){case"twitter":$L("#twProfile").val("null"),this.addRemoveTwitterHandle(void 0,!1),$L("#socStreamTw").removeClass("dN").addClass("dIB").find("span:nth-child(2)").text(""),$L(".socStreamTwFeeds").html(""),$L("#social_sendDM").empty(),$L(".sendmailgroupbtn").removeClass("sendDMadded"),$L(".sendmaildropdown").css("display","none"),$L("#social_sendTweet").empty(),$("#social_streams_button").hide();break;case"facebook":$L("#fbProfile").val("null"),$L(".socStreamFbFeeds").html(""),$L(".socAssociatedFb").removeClass(),t.setData("fbAssociated",!1)}var o=t.updateSocialObj();0===objectUtils.getLength(o)&&$(".socialBackToInter").addClass("dN").removeClass("dIB"),t.setData("dontHighlightSearch",!1),t.setData("interaction",!1);var s=t.data.SOCIALPROFILES;delete s[e],t.setData("SOCIALPROFILES",s),t.fetchSocialInteractions("all")},preventDefaultChar:function(e){$L("#folwSuggestOuter").is(":visible")&&13===e.which&&e.preventDefault()},preventCursor:function(e){$L("#folwSuggestOuter").is(":visible")&&(38!==e.which&&40!==e.which||e.preventDefault())},processTextPaste:function(e,t){var o=this;window.setTimeout((function(){o.processText(e,t)}),1)},processText:function(e,t,o){sE(event);var s=$L('[button_id="'+e+'"]'),r=$L('[limit_id="'+e+'"]'),a=$L('[text_id="'+e+'"]'),i=a.val();""===i&&((i=o)||(i=a.find("#resp_box").val()));var n=/(ht+tp:\/\/www.|ht+tps:\/\/www.|www.|ht+tp:\/\/|ht+tps:\/\/)?[\w]+(\.[a-zA-Z0-9-:;?_#!]+)+(\/[\w-;\-*._?,'/\\+&amp;%$#:=~@!]*)*/gim,c=0,l=0,d=$L(".socNewTweetPopInput").find("textarea");for(d.length&&d.outerHeight(40).outerHeight(d[0].scrollHeight);;){var p=n.exec(i);if(null===p)break;c++,l+=p[0].length}var m=280;c>0?m=m-23*c-(i.length-l):i&&(m-=i.length);r.html(0===m?"0":m);var u=a.length?a:s,g=u.closest(".socAttachInModal"),f=u.closest(".postResponse"),h=g&&g.length>0?g.find(".socReplyAttImg"):f.find(".socReplyAttImg");return m<0&&!0===t?(s.removeClass("cP").prop("disabled",!0).css("opacity","0.5").css("pointer-events","none"),r.attr("style","color: #D42A1C")):280===m&&(0===h.length||h.length&&h.hasClass("dN"))?(s.removeClass("cP").prop("disabled",!0).css("opacity","0.5").css("pointer-events","none"),r.attr("style","color: #000")):(s.removeClass("eventNone op5").addClass("cP").prop("disabled",!1),s.addClass("cP").prop("disabled",!1).css("opacity","1").css("pointer-events",""),r.attr("style","color: #000")),!0},processTwitterSuggestion:function(e,t,o,s){"undefined"!=typeof crmSocial&&crmSocial.processTwitterSuggestion(e,t,o,s)},removeImage:function(e,t,o,s){var r=$L(e),a=r.parents(".socialCommonPreviewDiv"),i=r.closest(".socAttachInModal");a.addClass("dN"),a.find("img").removeAttr("src").removeAttr("title"),i&&i.length>0?i.find(".socialCommonAttach").val(""):r.closest(".postResponse").find(".socialCommonAttach").val(""),this.processText(t,o,s)},onImageSelected:function(e,t,o,s,r){var a=(e=e||window.event).target.files[0],i=$L(t),n=[];if(s)n[s]=!0;else for(var c=s||$L(".socPopPostImg").find(".networkActive"),l=c.length,d=0;d<l;d++){n[s=c[d].getAttribute("network")]=!0}if(a.size>5242880&&n.twitter||a.size>26214400&&n.facebook||!n.twitter&&!n.facebook)return i.val(""),renderingUtils.showCustomAlert(I18n.getMsg("crm.nsocial.tab.image.maximum"),void 0,!0),!1;var p=this.changeFileName(a),m=i.closest(".socAttachInModal"),u=i.closest(".postResponse"),g=m&&m.length>0?m.find(".socReplyAttImg"):u.find(".socReplyAttImg"),f=m&&m.length>0?m.find(".socialCommonPreview"):u.find(".socialCommonPreview");g.removeClass("dN"),f.attr("title",a.name);var h=new FileReader;h.onload=function(e){f.attr("src",e.target.result)},h.readAsDataURL(p);var _=!1;return n.twitter&&(_=!0),"twitter"===s&&(_=!0),this.processText(o,_,r),p},changeFileName:function(e){var t=e.name.split(".");t=t[t.length-1];var o=e.slice(0,e.size,e.type);return new File([o],"name."+t,{type:e.type})},makeApiCallForFile:function(e,t,o,s,r){var a=Lyte.registeredMixins["crm-social-integration"],i={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken};jQuery.ajax({type:e,headers:i,url:t,data:o,processData:!1,contentType:!1,dataType:"json",success:function(e){a[s].apply(window,[r,e])},error:function(o){Lyte.registeredMixins["crm-social-integration"].handleErrorCase(e,t,o.responseJSON)}})},handleErrorCase:function(e,t,o){if(commonUtils.showHideLoadingDiv(!1),e)if(e.record_image_status)crmui.showMsgBand("error",I18n.getMsg("crm.social.ziavision.error"),3e3);else{var s=e.responseJSON?e.responseJSON:e.response?JSON.parse(e.response):e,r=void 0!==s.code?s.code:s.status,a={USER_NOT_FOUND:I18n.getMsg("crm.social.integ.error.user.notfound1"),USER_SUSPENDED:I18n.getMsg("crm.social.integ.error.user.suspend1"),USER_TOKEN_SUSPENDED:I18n.getMsg("crm.social.integ.reauth.error1"),RATE_LIMIT_REACHED:I18n.getMsg("crm.social.integ.error.internal"),NEED_REAUTH:I18n.getMsg("crm.social.integ.reauth.error1"),TWITTER_OVER_CAPACITY:I18n.getMsg("crm.social.integ.error.internal"),UNKNOWN_ERROR:I18n.getMsg("crm.social.integ.error.internal"),BLOCKED_BY_USER:I18n.getMsg("crm.social.integ.error.user.blocked1.view"),ID_NOT_FOUND:I18n.getMsg("crm.social.integ.error.tweet.notfound1"),DM_FAILED:I18n.getMsg("crm.social.integ.error.dm.failed1"),LIMIT_TO_FOLLOW:I18n.getMsg("crm.social.integ.error.follow.limit1"),BLOCKED_TO_FOLLOW:I18n.getMsg("crm.social.integ.error.user.blocked1"),TWEET_PROTECTED:I18n.getMsg("crm.social.integ.error.tweet.protected"),TWEET_LIMIT_REACHED:I18n.getMsg("crm.social.integ.error.tweet.limit"),DUPLICATE_STATUS:I18n.getMsg("crm.social.integ.error.tweet.dublicate1"),ACCOUNT_LOCKED:I18n.getMsg("crm.social.integ.error.unlock"),MESSAGE_SIZE_EXCEEDS:I18n.getMsg("crm.social.integ.error.message.limit"),DELETED_TWEET:I18n.getMsg("crm.social.integ.error.tweet.deleted1"),ATTACHMENT_LIMIT_EXCEEDS:I18n.getMsg("crm.social.integ.error.attachment.limit1"),NO_PERMISSION:I18n.getMsg("crm.nsocial.contact.admin"),SENT_OUTSIDE_ALLOWED_WINDOW:I18n.getMsg("crm.social.error.directmessage"),DUPLICATE_FAVOURITE:I18n.getMsg("crm.social.error.duplicatelike"),INSUFFICIENT_STORAGE:I18n.getMsg("crm.newfree.limit.exceed"),INVALID_DATA:I18n.getMsg("crm.social.noperm.or.delete"),LIMIT_EXCEEDED:I18n.getMsg("crm.social.social.limit"),INVALID_PARAM:"Facebook Error Occured"};if(a[r]){if("INVALID_PARAM"===r&&-1!==o.indexOf("facebook")){var i=$L("#facebook_leftpanel");return i.find(".socFbLeftLoadDiv").addClass("dN").removeClass("clearFix"),void i.find(".socFbApiInfoOuter").removeClass("dN")}if(crmui.showMsgBand("error",a[r],3e3),"NEED_REAUTH"===r)-1!==(o=o.split("?")[0]).indexOf("twitter")?this.showReauth("twitter",1,"socAssoTwOp5Icon"):-1!==o.indexOf("facebook")&&this.showReauth("facebook",2,"socAssoFbOp5Icon");else if("USER_SUSPENDED"===r){var n=$L("crm-social-integ-outer-template")[0].component.data,c=n.entity_info.twitter,l=n.SOCIALPROFILES.twitter;c=void 0!==c?"@"+c:"",$L("#twitter_leftpanel").html('<div><span class="socAsssNwIcon socAssoTwIcon dIB vaM"></span><a onclick="sE(event);"><span class="socNwName dIB vaM crmBaseColor cP ellipsistext pL10" id="twitter_name">'+$ESAPI.encoder().encodeForHTMLAttribute(c)+'</span></a><span data-zcqa="social_profile_dissociate" class="socProfDisassociate cP fR mT10 readOnlyMode" onmouseenter="crmui.showTooltip({content:\''+I18n.getMsg("crm.social.button.deassociate","Twitter")+"',isHTML: false,position: 'center'});\" onmouseleave=\"crmui.hideTooltip();\" onclick=\"sE(event);crmSocialInteg.saveProfile('twitter','"+$ESAPI.encoder().encodeForHTMLAttribute($ESAPI.encoder().encodeForJavaScript(l))+'\',false);" style="top:12px;" ></span></div>'),$L(".socStreamTwFeeds").html(Handlebars.templates.TwitterPosts({showEmpty:!0})),thirdPartyUtils.titleForEllipsis(".socStreamName")}else"TWEET_PROTECTED"!==r&&"BLOCKED_BY_USER"!==r||($L(".socStreamTwFeeds").html(Handlebars.templates.TwitterPosts({showEmpty:!0})),thirdPartyUtils.titleForEllipsis(".socStreamName"))}else crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.error.internal"),3e3)}else crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.error.internal"),3e3)},socContainMsgBandTop:function(){var e=$L(".SOCIALPERSONALITY");if(e.length){var t=e.offset().top-$L("#crm-msg").outerHeight()-30;$L(".socContainMsgBand").css("transform","translate(-50%, "+t+"px)")}},showReauth:function(e,t,o){var s={name:"span",attr:{class:"dB cP readOnlyMode","data-zcqa":e+"_add"},child:[{name:"span",attr:{class:"socialImg socAsssNwIcon "+o+" dIB"}},{name:"span",attr:{class:"dIB vaM crm-base-font-size crmNotFoundColor fs dB mL8"},child:[{name:"text",content:I18n.getMsg("crm.social.button.associate")+" "+e.charAt(0).toUpperCase()+e.slice(1)}]}]};$L("#"+e+"_leftpanel").html(renderingUtils.createHTML(s))},processPost:function(e,t){var o=Lyte.registeredMixins["crm-social-integration"];(t=t.crm_social_comment)[0].id&&(crmui.showMsgBand("success",I18n.getMsg("crm.tw.tweet.success"),3e3),o.socContainMsgBandTop())},processTwitterEntities:function(e){if(void 0!==e.retweeted_status){var t=e.user.name;(e=e.retweeted_status).retweetname=t}return e=this.processTwitter(e)},profileChange:function(e,t){e=$L(e);$L("#socProfileChange").empty();var o=$L("crm-social-change-account");o&&o[0]&&o[0].remove();var s=document.createElement("crm-social-change-account");t.renderAccounts=!0,s.setData(t),"popup"===e.attr("data-attr")?e.closest(".postResponse")[0].after(s):e.closest(".socialCommonImage").append(s)},showTwitterProfiles:function(e,t,o,s){var r=this.getAllAccountsByCriteria("twitter",void 0,t,1),a=$L("#"+s),i=a.closest(".postResponse"),n={accounts:r};n.callbackfn=o,n.param1=s,n.currAccount=i&&i.length?i.attr("account_id"):a.find(".postResponse").attr("account_id"),this.profileChange(e,n),event&&(event.cancelBubble=!0,event.stopPropagation&&event.stopPropagation())},postTweet:function(e,t,o,s,r){var a={},i={},n={content:t};i.content=JSON.stringify({posts:[n]}),a.content=JSON.stringify({posts:[n]}),a.accountId=e,a.network="twitter",o&&(a.file=o,a.fileName=o.fileName),a.newTweet=!0;var c=this;store.create("crm_social_comment",i,a).then((function(e){c.processPost(void 0,e);var t=$L("crm-twitter-post-create");t&&t.length>0&&(t[0].component.setData("renderTweetPost",!1),t[0].remove())}),(function(e){store.unloadAll("crm_social_comment"),Lyte.registeredMixins["crm-social-tab"].handleErrorCase(e)}))},toggleResponse:function(e){var t=$L(e),o=$L("crm-twitter-posts")[0].component;if(o.data.currentElem!==e){o.data.currentElem=e,t.closest(".feeds_li").addClass("socRepBg");var s=t.closest(".parentPost"),r=s.find("#response");r.toggle();var a=s.attr("id"),i=o.data.replyText;this.removeImage(s.find(".socRepImgClose"),a,i);var n=r.find(".socStreamReplyInput"),c=r.find("#resp_box"),l=void 0!==n.attr("reply")?n.attr("reply"):"";c.val(l+" ").focus(),void 0!==c[0]&&c[0].setSelectionRange(c.val().length,c.val().length),this.processText(a,void 0,c.val())}o.data.currentElem===e&&(o.data.currentElem=void 0,t.closest(".feeds_li").removeClass("socRepBg"))},processReply:function(e,t){var o=Lyte.registeredMixins["crm-social-integration"];if(t=t.comments?t.comments[0]:t.crm_social_comment?t.crm_social_comment[0]:void 0){var s=document.createElement("crm-twitter-reply-list");s.setData(o.processTwitterEntities(t)),$L("#"+e+"_replies").append(s),o.toggleResponse($L("#"+e).find(".postResponse"));var r=$L("[text_id="+e+"]"),a=r.closest(".postResponse").find(".socRepImgClose");r.val(""),o.removeImage(a,e)}},menuAnimate:function(e){var t=(e=$(e)).outerWidth(),o=e.position().left;e.siblings().removeClass("sel"),e.addClass("sel"),e.siblings(".tabborder").css({width:t,left:o})},showVideoInFrame:function(e,t,o){event.cancelBubble=!0,event.stopPropagation&&event.stopPropagation();var s=$L(e),r=s.closest(".kso_sharedlink");0===r.length&&(r=s.closest(".socIntFbSmallLinkVideo").parent()),r.find(".socFbSmallLinkVideo, .socIntFbSmallLinkVideo, #imagesvg, #videoimage").hide(),r.find("#videoframe").attr("src",t).show(),"commentDetail"===o&&r.css({width:"315px",padding:"10px"})},getTwitterIds:function(e){var t=[];return $.each(e,(function(e,o){1===o.status&&t.push(o.id)})),t},processFollowInformation:function(e,t){commonUtils.showHideLoadingDiv(!1);var o=store.peekAll("social_related_list")[0];void 0!==t&&this.processDMSection(e,t);var s=$L("crm-follow-list");s&&s.length>0&&s[0].remove(),Lyte.Component.render("crm-follow-list",{data:o.TWFollowInfo[e.profileId]},"#follow_"+e.profileId)},processPersonalAccounts:function(e,t,o,s){t.allAccounts=t.allAccounts?t.allAccounts:[];var r=$L("crm-social-integ-outer-template");r&&r[0]?((r=r[0].component).brandParent=[],r.personalAcc=[],r.brandPages=[],r.personalReauthAcc=[],r.perm=[]):((r=document.createElement("crm-social-integ-outer-template").component).setData(t),r.brandParent={},r.personalAcc={},r.brandPages={},r.personalReauthAcc={},r.perm={}),$.each(t.accounts,(function(e,o){var s=null;0===o.status&&(o.status=1),"Brand_Parent"===o.type&&(o.type="brand"),"Personal"===o.type?s=1===o.status?r.personalAcc:r.personalReauthAcc:"brand"===o.type&&void 0===o.parent_id&&1===o.status?(s=r.brandParent,"twitter"===o.network&&(t.pingsEnabled=!0)):1===o.status&&(s=r.brandPages,t.pingsEnabled=!0),null!==s&&(void 0===s[o.network]&&(s[o.network]=[]),s[o.network].push(o.id),1===o.status&&void 0===o.parent_id&&(t[o.network]=!0)),t.allAccounts[o.id]=o,o.info.id_str=o.info.id,o.info.displayName=o.info.name}));var a=-1!==t.info.permissions.indexOf("Crm_Implied_Social_Integration"),i=-1!==t.info.permissions.indexOf("Crm_Implied_Social_Admin");if(t.integPermission=a,t.socialAdmin=i,t.new_social&&(t.recordtwitterAssociated=t.SOCIALPROFILES?t.SOCIALPROFILES.twitter:void 0,"canvas"===s&&(store.unloadAll("social_related_list"),store.pushPayload("social_related_list",Object.assign({},t))),!o)){t.SOCIALPROFILES&&void 0!==t.SOCIALPROFILES.facebook&&(t.fbAssociated=!0),t.SOCIALPROFILES&&void 0!==t.SOCIALPROFILES.twitter&&(t.twAssociated=!0);var n,c=networkUtils.returnDependencyFiles(["crm-social-related-list.js","crm-social-models.js","crm-social-posts.js","crm-social-post-detail-outer.js","crm-social-helper.js","crm-social-common-models.js","crm-social-common.js","crm-social-tab-rl-common.js","crm-social-post-detail.js","crm-social-convo-inner-new.js"],ResourceConstants.CRMClient),l=networkUtils.returnDependencyFiles(["crm-social-related-list.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT).concat(networkUtils.returnDependencyFiles(["crm-social-common.css"],ResourceConstants.CRMClient)),d=networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("social")],ResourceConstants.CRM);if(Crm.userDetails.RTL_ENABLED){var p=networkUtils.returnDependencyFiles(["crm-social-common-rtl.css","crm-social-related-list-rtl.css"],ResourceConstants.CRMClient);n=c.concat(l).concat(p).concat(d)}else n=c.concat(l).concat(d);Lyte.injectResources(n,void 0,(function(){r.renderPersonalAccounts(t,s)}))}o&&(store.unloadAll("social_related_list"),store.pushPayload("social_related_list",t))},getConfiguredAccounts:function(){var e=store.peekAll("social_related_list");void 0===e||0===e.length?this.getPersonalAccounts():this.processPersonalAccounts(void 0,e[0])},getPersonalAccounts:function(){var e={type:"personal"},t=this;store.findAll("social_related_list",e).then((function(o){t.processPersonalAccounts(e,o)}))},fetchSocialRelatedList:function(e){var t=!0;if(!($L("crm-social-integ-outer-template").length>0)){!1===e&&(t=!1);var o=$L("[name='listrelation']").val();void 0!==o&&(t||this.getConfiguredAccounts(o))}},sendDm:function(e,t){void 0===t&&(t=$L("#twProfile").val());var o=$L("crm-social-direct-message-new");""===t&&(t=o[0].component.data.id);var s=store.peekAll("social_related_list")[0];if(void 0!==s.TWDMInfo[t]){var r=s.record_id?s.record_id:s.id;this.getAllAccountDmStatus(t,void 0,void 0,r),$("#directMessage").remove();var a=s.TWDMInfo[t][e];if(a.thread_id=a.target.id_str+"_"+a.source.id_str,a.type="global",a.id=t,s.new_social)a.place_type="rightpanel_popup",a.renderSendDM=!0,(i=o)&&i[0]&&i[0].remove(),Lyte.Component.render("crm-social-direct-message-new",a,"#showSignalPop");$L("#directMessage").find("input").eq(0).focus();var i,n=s.allAccounts[e];if(2===n.type||"Personal"===n.type)return(i=$L("crm-social-convo-inner"))&&i[0]&&i[0].remove(),void Lyte.Component.render("crm-social-convo-inner-new",{message:!0,personal:!0},".socMsgDetailView");if(s.new_social){var c=s.allAccounts[e].brand.id;return void this.getMessageDetail(void 0,c,"twitter",a.target.id_str+"_"+a.source.id_str+"_twitter",void 0,a.target.id_str,"rightpanel_popup")}}},getAllAccountDmStatus:function(e,t,o,s){var r=this.getAllAccountsByCriteria("twitter",void 0,2,1),a=[];$.each(r,(function(e,t){a.push(t.id)}));var i=store.peekAll("social_related_list")[0];if(a.length>0&&void 0!==i.allAccounts){var n=[];if($.each(a,(function(t,o){(void 0===i.TWDMInfo[e]||void 0===i.TWDMInfo[e][o]||i.TWFollowInfo&&(void 0===i.TWFollowInfo[e]||void 0===i.TWFollowInfo[e][o]))&&n.push(o)})),n.length>0){o=$L("#module").val();var c=$L("#entityID").val();void 0!==s&&(c=s);var l={accounts:n,entity_id:c,profileId:e},d={},p={ids:n.toString(),per_page:1};d.module=o,d.entityId=c;var m=this;store.findAll("relation",p,void 0,void 0,d).then((function(e){void 0!==t?m.callbackfn(l,e):m.processDMSection(l,e)}))}}},getMessageDetail:function(e,t,o,s,r,a,i,n){if("sales_signals"===i){var c=store.peekAll("Social");if(!c||0===c.length){var l=store.findAll("Social",void 0,void 0,void 0,"get_social"),d=store.findAll("crm_social_brand"),p=store.triggerAction("Social","popup_status"),m=Lyte.resolvePromises({deskDetails:l,brandDetails:d,bannerInfo:p}),u={};if(void 0!==m){var g=m.brandDetails.$.meta;if(void 0!==m.brandDetails){m.brands=m.brandDetails,delete m.brandDetails;var f=[],h=[];$.each(m.brands,(function(e,t){$.each(t.accounts,(function(e,t){h.push(t)}))})),m.accounts=h,$.each(m.brands,(function(e,t){$.each(m.accounts,(function(e,o){if(o.brand&&o.brand.id===t.id)return f.push(t),!1}))}));var _=f;o={};if(_.length>0){$.each(m.accounts,(function(e,t){t.brand&&t.brand.id===_[0].id&&(o[t.network]=t.id)}));var v=[{value:"Leads",name:moduleRecordMapping.Leads.singular_label},{value:"Contacts",name:moduleRecordMapping.Contacts.singular_label},{value:"Potentials",name:moduleRecordMapping.Potentials.singular_label},{value:"Customers",name:I18n.getMsg("crm.nsocial.customers")},{value:"Accounts",name:moduleRecordMapping.Accounts.singular_label},{name:I18n.getMsg("crm.social.lead.opp"),value:"Unknown"}];u={brands:_,accounts:m.accounts,filter:v,network:o,social_admin:g.social_admin,configered_desk_detials:m.deskDetails[0].configered_desk_detials,render:m.bannerInfo}}else u={start_page:!0,social_admin:g.social_admin}}}store.unloadAll("Social"),store.pushPayload("Social",u)}}if(this.checkReauthStatus(t,o))"sales_signals"===i&&store.unloadAll("Social");else{if(void 0!==e)(e=$(e)).html(renderingUtils.createHTML({name:"img",attr:{src:networkUtils.getImageUrl("loading.gif",ResourceConstants.CRM)}}));var w={brand_id:t,thread_id:s,network:o,cursor:r,place_type:i,entity_id:a,social_brand_id:n},L=this,C={};C.brand_id=t,C.network=o,C.thread_id=s,store.findAll("crm_social_message",void 0,void 0,void 0,C).then((function(e){L.renderMessageDetail(w,e)}))}},renderMessageDetail:function(e,t){(t=this.processMessageDataForRender(t.messages?t.messages:t.data=t)).network=e.network,t.thread_id=e.thread_id,t.place_type=e.place_type,t.brand={id:e.brand_id},t.social_brand_id=e.social_brand_id;var o=document.createElement("crm-social-convo-inner-new"),s=$L("crm-social-convo-outer-new"),r=$L("crm-social-convo-inner-new");if("rightpanel_popup"!==e.place_type&&"related_list"!==e.place_type&&s&&s.length>0&&s[0].remove(),"rightpanel_popup"!==e.place_type&&"related_list"!==e.place_type&&r&&r.length>0&&r[0].remove(),e.cursor){var a=$L(".socViewMsgParent"),i=a[0].scrollHeight+42,n=$L(".message_"+e.entity_id+"_"+e.place_type);n.find(".showMoreNew").remove(),t.next_page=!0,o.setData(t),n.prepend(o),a.scrollTop(a[0].scrollHeight-i)}else{switch(t.place_type){case"rightpanel_popup":Lyte.Component.render("crm-social-convo-inner-new",t,".message_"+e.entity_id+"_"+e.place_type);var c=document.getElementById("socDirMsgModalContent").scrollHeight;$L("#socDirMsgModalContent").scrollTop(c);break;case"related_list":var l=$L("#socIntDetView");t.related_list=!0,Lyte.Component.render("crm-social-convo-outer-new",t,"#socIntDetView"),l.addClass("socOuterContainer"),$(".socialBackToColumn").removeClass("dN");break;case"sales_signals":t.sales_signal=!0,Lyte.Component.render("crm-social-convo-outer-new",t,"#signalPopupInnerDiv"),$L("#signalPopupViewContent").find("#loadMsg").addClass("dN"),$(".socViewConvoClose").hide(),$("#signalPopupViewContent").find(".popup-model-content").attr("style","overflow: auto");break;default:t.renderMessageDetail=!0,Lyte.Component.render("crm-social-convo-outer-new",t,"#socialDashboard");var d=e.entity_id?e.entity_id:t.entity?t.entity.id:void 0;Lyte.Component.render("crm-social-convo-inner-new",t,".message_"+d+"_"+e.place_type),commonUtils.showHideLoadingDiv(!1)}var p="rightpanel_popup"===t.place_type?"socMsgDetailView":"socViewMsgParent",m=$("."+p),u=m.find("crm-social-convo-inner-new").find("> div");if(0===u.length&&(u=m.find("div").last()),u.length>0){var g=u.position().top+u.outerHeight();m.scrollTop(g)}this.processTwitterTags(),thirdPartyUtils.titleForEllipsis(".socViewMsgName")}},processMessageDetail:function(e){var t;if(e){t={data:[],cursor:e.$&&e.$.meta?e.$.meta.c_cursor:e.cursor};for(var o=(e=e.crm_social_message?e.crm_social_message:e).length-1;o>=0;o--){var s=e[o];s.account&&s.sender.id!==s.account.info.id?s.showRight=!1:s.showRight=!0,Lyte.registeredMixins["crm-social-tab"].processTags(s),t.data.push(s)}}return t},processMessageDataForRender:function(e){var t;if(e){t={data:[],cursor:e.$&&e.$.meta?e.$.meta.c_cursor:e.cursor};for(var o=(e=e.crm_social_message?e.crm_social_message:e).length,s=0;s<o;s++){var r=e[s];void 0===t.account&&(t.account=r.account,t.perm=r.perm,r.showRight?t.entity=r.recipient[0]:t.entity=r.sender),!t.conversation_id&&r.conversation_id&&(t.conversation_id=r.conversation_id),t.data.push(r)}}return t},checkReauthStatus:function(e,t){var o=store.peekAll("Social");o=void 0===o||0===o.length?store.peekAll("social_related_list")[0]:o[0];var s=!1;return $.each(o.accounts,(function(o,r){if(r.brand&&r.brand.id===e&&r.network===t)return r.reauth&&(s=r.reauth),!1})),s&&(crmui.showMsgBand("error",I18n.getMsg("crm.social.integ.reauth.error"),3e3),commonUtils.showHideLoadingDiv(!1)),s},postMessage:function(e,t,o,s,r,a,i,n){if(t||(t=$L(".selectedBrand").attr("value")),!this.checkReauthStatus(t,o)){n&&void 0===i&&(i="");var c={receiver_id:r,message:i},l={brand_id:t,network:o,id:s},d={network:o,id:s,place_type:a,profile_id:r,brand_id:t},p=this;n&&(c.file=n,c.fileName=n.name),l.fData=c,store.create("crm_social_message",c,l).then((function(t){p.renderPostMessage(d,t,e)}),(function(e){store.unloadAll("crm_social_message"),Lyte.registeredMixins["crm-social-tab"].handleErrorCase(JSON.parse(e.response?e.response:e))}))}},renderPostMessage:function(e,t,o){if(t.code)this.handleErrorCase(t,"POST","message");else{(t=this.processMessageDataForRender(t)).network=e.network,t.place_type=e.place_type,t.brand={id:e.brand_id},Lyte.Component.render("crm-social-convo-inner-new",t,".message_"+e.profile_id+"_"+e.place_type);var s=$L("#socDirMsgContent");if(s&&s.length>0){(r=s[0].scrollHeight)&&s.scrollTop(r)}else{var r=document.getElementById("socDirMsgModalContent").scrollHeight;$L("#socDirMsgModalContent").scrollTop(r)}var a=$L(".socAttachInModal");if(a.length>0)a.find(".socReplyAttImg").addClass("dN");var i=$L("#socConvoMessageModal");i.length>0&&i[0].calculateOffset(),$L("#socInContain").length>0&&$L(o).closest(".socViewMsgReply").find(".socialCommonPreviewDiv").addClass("dN"),$L("#socDirMsg").val(""),$L("#socDetailViewMsg").val(""),$L("#dmNoContent").addClass("dN"),this.processText(e.profile_id+"_"+e.place_type,!1,t.data[0].message)}},getAllDmAccounts:function(e){var t=[],o=store.peekAll("social_related_list")[0];return void 0!==o.TWDMInfo[e]&&$.each(o.TWDMInfo[e],(function(e,s){t.push(o.allAccounts[s.account_id])})),t},processReplyToconvo:function(e,t){"object"==typeof t&&(t=t.crm_social_message[0],t=JSON.stringify(t));var o=JSON.parse(t),s=!1;if((o.data&&!o.data.errors||o.dataObj&&!o.dataObj.errors||o.post&&!o.post.erros)&&(s=!0),s){var r=o.data;r.brid=o.brid,r.type||(r.type="message"),r.network||(r.network=e.network),o.data=new Array(r),o.data[0]&&(!o.data[0].message&&o.data[0].text&&(o.data[0].message=o.data[0].text),!o.data[0].created_at&&o.data[0].formatted_time&&(o.data[0].created_at=o.data[0].formatted_time),o.data[0].showRight=!0),$L("#socDirMsg").val("");var a=document.createElement("crm-social-convo-inner-new");a.setData(o),$L("#"+e.uniqueId).append(a),$L("#zso_sendDM").prop("disabled",!1).css("opacity","1").css("pointer-events",""),void 0!==o.data[0]&&(void 0!==o.data[0].id_str||o.data[0].id);var i=document.getElementById("socDirMsgModalContent").scrollHeight;$L("#socDirMsgModalContent").scrollTop(i),$L("#dmNoContent").hide()}},processTwitter:function(e){e.text=e.full_text?e.full_text:e.text;var t=e.type;if(null===e.text.match(/(&#x60;)+|(&#x21;)+|(&#x40;)+|(&#x23;)+|(&#x24;)+|(&#x25;)+|(&#x5e;)+|(&amp;)+|(&#x2a;)+|(&#x28;)+|(&#x29;)+|(&#x2b;)+|(&#x7b;)+|(&#x7d;)+|(&#x3a;)+|(&quot;)+|(&lt;)+|(&gt;)+|(&#x3f;)+|(&#x2f;)+|(&#x3b;)+|(&#x27;)+|(&#x5b;)+|(&#x5d;)+|(&#x3d;)+/gim)&&(e.text=$ESAPI.encoder().encodeForHTML(e.text)),"message"===t)e.convo=!0;else{if((e=this.processRetweets(e)).create){var o=e.watching_profile_id,s=e.user.id_str;e.retweet_allowed=s!==o}e.self&&(e=this.processTweetReplies(e))}return e=this.processTwitterEntitiesData(e)},processRetweets:function(e){var t=e.watching_profile_id;if(e.retweeted_status){var o=[],s=e.retweeted_status;o.push($ESAPI.encoder().encodeForHTML(e.user.name)),e.action=I18n.getMsg("crm.nsocial.tab.retweeted.by",o),e.user=s.user,e.text=$ESAPI.encoder().encodeForHTML(s.text),e.entities=s.entities,e.retweet_id=s.id_str,e.favorited=s.favorited,e.retweeted=s.retweeted,e.favorite_count=s.favorite_count,e.retweet_count=s.retweet_count}return e.retweeted||(e.retweet_id=e.id_str),e.user.id_str!==t?e.retweet_allowed=!0:e.retweet_allowed=!1,e},processTweetReplies:function(e){if(e.replies&&e.replies.data){for(var t=e.replies.data,o=t.length,s=0;s<o;s++){var r=t[s];r.text=$ESAPI.encoder().encodeForHTML(r.text),r=this.processTwitterEntitiesData(r),r=this.processTime(r),e.detail_view&&(r.detail_view=e.detail_view),t[s]=r}if(t.cursor){var a=[];a.push(r.id_str,30,t.cursor),e.replyDiv=I18n.getMsg("crm.nsocial.view.more.replies",a)}e.replies.data=t}return e},processTwitterEntitiesData:function(e){var t=e.text;e.entities=e.extended_tweet?e.extended_tweet.entities:e.entities;var o=t.match(/(&#x60;)+|(&#x21;)+|(&#x40;)+|(&#x23;)+|(&#x24;)+|(&#x25;)+|(&#x5e;)+|(&amp;)+|(&#x2a;)+|(&#x28;)+|(&#x29;)+|(&#x2b;)+|(&#x7b;)+|(&#x7d;)+|(&#x3a;)+|(&quot;)+|(&lt;)+|(&gt;)+|(&#x3f;)+|(&#x2f;)+|(&#x3b;)+|(&#x27;)+|(&#x5b;)+|(&#x5d;)+|(&#x3d;)+/gim);if(t.indexOf("<a onclick='sE(event);' href='")<0){var s=e.entities;if(void 0===s)return e;var r=0;if(s.media){var a=s.media;for(r=a.length-1;r>=0;r--){var i=a[r];if(!e.convo){var n=i.url,c=$ESAPI.encoder().encodeForHTML(n),l='<a onclick="sE(event);" href="'+$ESAPI.encoder().encodeForHTMLAttribute(n)+'" target="_blank">'+$ESAPI.encoder().encodeForHTML(i.display_url)+"</a>";t=null!==o?t.replace(c,l):t.replace(n,l)}"photo"===i.type&&(e.isPic=!0,e.picture=i.media_url_https)}e.text=t}if(s.urls){var d=s.urls;for(r=d.length-1;r>=0;r--){var p=d[r];n=p.url,c=$ESAPI.encoder().encodeForHTML(n),l='<a onclick="sE(event);" href="'+$ESAPI.encoder().encodeForHTMLAttribute(n)+'" target="_blank">'+$ESAPI.encoder().encodeForHTML(p.display_url)+"</a>";t=null!==o?t.replace(c,l):t.replace(n,l)}e.text=t}if(e.convo||void 0===e.user||(e.replytext="@"+e.user.screen_name),s.user_mentions){var m=s.user_mentions;for(r=m.length-1;r>=0;r--){var u=m[r],g=u.screen_name,f="@"+g,h=$ESAPI.encoder().encodeForHTML(f),_=$ESAPI.encoder().encodeForHTMLAttribute(g),v='<a onclick="sE(event);" href="'+RebrandLinkUtil.getProperty("TW_URL")+"/"+_+'" target="_blank">'+h+"</a>";null!==o?(h=new RegExp(h,"i"),t=t.replace(h,v)):(f=new RegExp(f,"i"),t=t.replace(f,v)),e.convo||void 0===e.user||u.screen_name===e.user.screen_name||(e.replytext=e.replytext+" @"+u.screen_name)}e.text=t}if(s.hashtags){var w=s.hashtags;for(r=w.length-1;r>=0;r--){var L="#"+w[r].text,C=$ESAPI.encoder().encodeForHTML(L),y=$ESAPI.encoder().encodeForHTMLAttribute(L),I='<a onclick="sE(event);" href="'+RebrandLinkUtil.getProperty("TW_URL")+"/search?q="+y+'&src=hash" target="_blank">'+C+"</a>";t=null!==o?t.replace(C,I):t.replace(L,I)}e.text=t}if(s.symbols){var k=s.symbols;for(r=k.length-1;r>=0;r--){var $="$"+k[r].text,b=$ESAPI.encoder().encodeForHTML($),M=$ESAPI.encoder().encodeForHTMLAttribute($),A='<a onclick="sE(event);" href="'+RebrandLinkUtil.getProperty("TW_URL")+"/search?q="+M+'&src=ctag" target="_blank">'+b+"</a>";t=null!==o?t.replace(b,A):t.replace($,A)}e.text=t}}return e},processTime:function(e,t){var o=null;if(void 0===(o=t&&e.activity_time?e.activity_time:e.formatted_time))return e;var s=[],r="title_time";return t&&(r="act_"+r),e[r]=o.disp_time,o.key&&o.diff?(s.push(o.diff),e.disp_time=I18n.getMsg(o.key,s)):o.diff?o.key||(e.disp_time=o.diff):e.disp_time=I18n.getMsg(o.key),e},showSocialProfilePanel:function(e,t,o,s){var r=$L(".selectedBrand").attr("value"),a=$L(e).attr("entity_profile_id"),i=$L(e).attr("network"),n=$L(e).attr("isload_partially"),c="rightpanel_popup";$L("#socProfileRightPanelOuter").length<1&&$L("#show").append(renderingUtils.createHTML({name:"div",attr:{id:"socProfileRightPanelOuter",class:"socProfileRightPanelOuter dN"},child:[{name:"div",attr:{id:"socProfileRightPanel",class:"socProfileDetPopup pA"}}]}));var l={};"twitter"===i?l={twitter:a,time:Date.now()}:"facebook"===i&&(l={facebook:a,time:Date.now()}),r||(r=o);var d=[];d.type=t,d.brand_id=r,d.profile_id=a,d.network=i,d.searchQuery="",d.display_name="",d.cursor="",d.place_type=c,d.tab=s;var p=document.createElement("crm-social-interaction-loading");if(void 0!==n&&"true"===n){$L(".socProfPopupDetTab").removeClass("socProfTabActive"),$L(e).addClass("socProfTabActive"),p.setData({index:[1,2,3]});var m=$L("#socProfPopupUsers");m[0].innerHTML="",m.append(p),this.getFilterFeedsCommon(void 0,"",t,i,"",a,"","",c,void 0,s)}else{var u=this;commonUtils.showHideLoadingDiv(!0),store.findAll("crm_social_info",l,void 0,void 0,{brand_id:r}).then((function(e){commonUtils.showHideLoadingDiv(!1),u.showSocialProfilePanelcalback(d,e)}))}},showSocialProfilePanelcalback:function(e,t){var o=Lyte.registeredMixins["crm-social-tab"];if(t&&(t=o.processPostsForRender(t)),t.brand={id:e.brand_id},t.network=e.network,t.place_type=e.place_type,t.type=e.type,t.search=e.search,t.profile_id=e.profile_id,t.id=e.id,t.filter=!0,t.display_name=e.display_name,t&&t.data){var s=t&&t.data.length?t.data[0]:t;s.tabaction=e.type;var r=$L("crm-social-right-panel");r&&r[0]&&r[0].remove(),Lyte.Component.render("crm-social-right-panel",{info:s},"#socProfileRightPanel").setData("renderRightPanelPopup",!0);var a=$L("crm-social-interaction-loading");a&&a.length>0&&a[0].remove();var i="#socProfPopupUsers";0===$L(i).length&&(i="#socProfPopupUserDet"),Lyte.Component.render("crm-social-interaction-loading",{index:[1,2,3]},i),o.getFilterFeedsCommon(void 0,e.filter_id,e.type,e.network,e.searchQuery,e.profile_id,e.display_name,e.cursor,e.place_type,e.brand_id,e.tab)}},sendDmInCanvasView:function(e,t,o,s,r){var a=this;store.findAll("social_related_list",void 0,void 0,void 0,{source:"canvas",module:s,entityId:r}).then((function(i){$.each(i.accounts,(function(s,r){r.id===e&&(o[t][e].info=r.info)})),i.TWDMInfo=o;var n={};$.each(i,(function(e,t){n[e]=t})),n.id||(n.id=i.id?i.id:Math.floor(1e5*Math.random()+1)),store.unloadAll("social_related_list"),store.pushPayload("social_related_list",n);var c=store.peekAll("social_related_list");if(c&&c[0]){var l=c[0];if(void 0!==l.TWDMInfo[t]){a.getAllAccountDmStatus(t,void 0,s,r);var d=$L("#directMessage");d&&d.length>0&&d[0].remove();var p=l.TWDMInfo[t][e];if(p.thread_id=p.target.id_str+"_"+p.source.id_str,p.type="global",p.id=t,p.account_id=e,l.new_social){p.place_type="rightpanel_popup",p.renderSendDM=!0;var m=$L("crm-social-direct-message-new");m&&m[0]&&m[0].remove(),Lyte.Component.render("crm-social-direct-message-new",p,"#showSignalPop")}l.allAccounts=l.allAccounts?l.allAccounts:[],$.each(l.accounts,(function(e,t){l.allAccounts[t.id]=t})),$L("#directMessage").find("input").eq(0).focus();var u=l.allAccounts[e];if(2===u.type||"Personal"===u.type)return void Lyte.Component.render("crm-social-convo-inner-new",{message:!0,personal:!0},".socMsgDetailView");if(l.new_social){var g=l.allAccounts[e].brand.id;return void a.getMessageDetail(void 0,g,"twitter",p.target.id_str+"_"+p.source.id_str+"_twitter",void 0,p.target.id_str,"rightpanel_popup")}}}}))},processTwitterTags:function(){var e=this;$L(document).on("click",".socMsgHandleElement",(function(t){e.stopEvent(t);var o=t.currentTarget;o.lyteState||(e.processTwitterTagOnclick(o),t.stopPropagation())})),$L(document).on("click",".socFbMulLink",(function(t){e.stopEvent(t);var o=t.currentTarget;if(!o.lyteState){var s=o.getAttribute("link");networkUtils.openUrl(s,"_blank"),t.stopPropagation()}}))},processSearchTypeColumn:function(e,t,o,s){var r=null,a=$L(e);if("user_search"===t||"page_search"===t||"list"===t)r={profile_id:a.attr("profile_id"),name:a.attr("display_name")};else if("keyword_search"===t){var i=a.attr("search_query");i||(i=s),r={keyword:i.trim()}}var n=$L(".selectedBrand").attr("value");this.addFilterColumn(n,t,o,r)},addFilterColumn:function(e,t,o,s){if(!this.checkReauthStatus(e,o)){var r={network:o,type:t,brand:{id:e}};s&&(r.details=s);var a=this;commonUtils.showHideLoadingDiv(!0),store.create("monitor_column",r).then((function(e){commonUtils.showHideLoadingDiv(!1),a.renderCreateFilter(r,e)}),(function(e){a.handleErrorCase(e,"POST","monitor_column")}))}},renderCreateFilter:function(e,t){var o=Lyte.registeredMixins["crm-social-tab"],s=this,r=$L("#socMonitorContentInner"),a=$L("#socMonitorContent"),i=document.createElement("crm-social-filter-column"),n=[];$.each(t.monitor_column,(function(e,t){if("SUCCESS"===t.code){var a=t.details,n=void 0!==a.info.name?a.info.name:void 0!==a.info.keyword?a.info.keyword:s.getDisplayNameByType(a.type);a.display_name=n;var c=a.info.name||a.info.keyword?s.getDisplayNameByType(a.type):null;a.title=c;var l=document.createElement("crm-social-filter-head");l.setData(a),r.append(l),o.setMonitorContentWidth(),i.component.addColumnClose("close")}else o.handleErrorCase(t,void 0,"POST","monitor_column")})),$.each(t.monitor_column,(function(e,t){if("SUCCESS"===t.code){var r=t.details,i=void 0!==r.info.name?r.info.name:void 0!==r.info.keyword?r.info.keyword:s.getDisplayNameByType(r.type);r.display_name=i;var c=r.info.name||r.info.keyword?s.getDisplayNameByType(r.type):null;r.title=c;var l=a.scrollLeft(),d=$L("#"+r.id+"_column").offset().left;n.push({height:l+d,jsonId:r.id}),o.getFilterFeeds(r,r.brand.id)}}));for(var c=n.length,l=0;l<c;l++)a.scrollLeft(n[l].height),$L("#"+n[l].jsonId+"_column").addClass("socAddedColumHighlight"),d(l);function d(e){setTimeout((function(){$L("#"+n[e].jsonId+"_column").removeClass("socAddedColumHighlight")}),2e3)}},getDisplayNameByType:function(e){switch(e){case"mention":return I18n.getMsg("crm.social.mentions");case"timeline":return I18n.getMsg("crm.social.timeline");case"like":return I18n.getMsg("crm.social.likes");case"keyword_search":return I18n.getMsg("crm.social.keyword.search");case"user_search":return I18n.getMsg("crm.social.user.search");case"page_search":return I18n.getMsg("crm.social.page.search");case"list":return I18n.getMsg("crm.social.lists")}},stopEvent:function(e){Lyte.registeredMixins["crm-stop-event"].actions.stopEvent(e)},processTwitterTagOnclick:function(e){var t,o=Lyte.registeredMixins["crm-social-tab"],s=e.getAttribute("type"),r=e.getAttribute("replace_text"),a=e.getAttribute("network"),i=$L("crm-social-convo-outer-new");if(e=$L(e),i&&i.length>0&&(t=$L("crm-social-convo-inner-new")[0].component.data.brand.id),!t){var n,c=$L(".socFilterBrandsRadio");c.length>0&&c.each((function(e){(n=this).ltProp("checked")&&(t=n.ltProp("value"))})),commonUtils.showHideLoadingDiv(!0),"Mentions"===s?this.showSocialProfilePanel(e,"user_search",t,"monitor"):"hashtags"===s&&r&&o.getFilterFeedsCommon(void 0,void 0,"keyword_search",a,r,void 0,void 0,void 0,"rightpanel_popup",t,"monitor")}},reloadTwitter:function(e){var t=document.createElement("crm-social-integ-outer-template").component;if(e.includes("#")||""===e){var o=$("#twProfile").val();this.addRemoveTwitterHandle("",!1),""!==o?t.getProfileInfo("twitter",o,void 0):t.getSearchInfo("twitter")}else this.addRemoveTwitterHandle(e,!0),t.getProfileInfo("twitter",void 0,e)},updateModalHeightAfterImageUpload:function(e){$L("#"+e)[0].calculateOffset()},twitterCountVisibility:function(e,t,o){var s=$L(o).closest(".postResponse").find(".socReplyCount");"focus"===e?s.removeClass("vH"):s.addClass("vH")},addIdInDropArrow:function(e){$L(e).find(".dmdropArrow").attr("id","twitterDmDrop")}},{mixins:["crm-social-tab"]}),Lyte.Mixin.register("crm-social-notification",{processWMSNotification:function(e){var t=e.type,o=e.network,s=e.entitytype;s||(s="Unknown");var r=$L(".selectedBrand").attr("value"),a=$L(".selectedNetwork").attr("network"),i=$L(".socFilterInteractions input:checked").val(),n=$L("crm-social-tab-new");""===i&&n&&n.length>0&&(i=n[0].component.data.module,a=n[0].component.data.selectedNetwork);var c=$L(".socNoResAlign");c.addClass("dN"),i="All"===i?s:i,a="All"===a?o:a;var l=Lyte.registeredMixins["crm-social-tab"];if(r===e.brand_id&&a===o&&i===s){l.processTags(e.info),(Crm.userDetails.permissions.Crm_Implied_Create_Leads||Crm.userDetails.permissions.Crm_Implied_Create_Contacts||Crm.userDetails.permissions.Crm_Implied_Create_Accounts)&&(e.add_to_crm=!0);n=document.createElement("crm-social-notification-new");var d=[];if("message"===t){var p=$L("#socAllMessages");if(p.children().length>0){c.addClass("dN"),$("#socNewMessages").show();var m=$L("crm-social-messages-list")[0].component.data.place_type;e.place_type=m,d.push(e),n.setData("data",d),p[0].prepend(n)}}else{if(e.account&&e.info&&e.info.user&&e.account.info&&e.info.user.id===e.account.info.id)return;var u=[];u.has_liked=!1;var g=[];g.has_retweeted=!1,e.likes=u,e.retweets=g,store.pushPayload("crm_social_feed",e),e.post=!0;var f=$L("#socAllConvo");$("#socNewConversation").show();var h=$L("crm-social-posts-new");if(h.length>0){h[0].component.setData("show_empty",!1);m=h[0].component.data.place_type;e.place_type=m}h.setData("show_empty",!1);m=h.data.place_type;e.place_type=m,d.push(e),n.setData("data",d),f[0].prepend(n)}}},handleAddAccount:function(e){if(void 0!==e.errorCode)switch(e.errorCode){case"limit":renderingUtils.showCustomAlert(I18n.getMsg("crm.social.setup.account.limit"),I18n.getMsg("crm.social.setup.error.add.account"),!1);break;case"duplicate":renderingUtils.showCustomAlert(I18n.getMsg("crm.nsocial.setup.account.configured"),I18n.getMsg("crm.social.setup.error.add.account"),!1);break;case"SOCIAL_PERMISSION_DENIED":case"SOCIAL_DUPLICATE":renderingUtils.showCustomAlert(I18n.getMsg("crm.livedesk.error.exp.msg"),I18n.getMsg("crm.social.setup.error.add.account"),!1);break;case"10001":e.name?renderingUtils.showCustomAlert(I18n.getMsg("crm.social.setup.reauth.account",e.name),I18n.getMsg("crm.social.setup.error.add.account"),!1):renderingUtils.showCustomAlert("account not matched",I18n.getMsg("crm.social.setup.error.add.account"),!1)}else if(e.reauth){var t=e.account_info,o=store.peekAll("Social")&&store.peekAll("Social").length>0?store.peekAll("Social")[0]:store.peekAll("social_related_list")[0];$.each(o.accounts,(function(e,o){o.id===t.id&&(o.reauth=!1)}));var s=$L("#reauth_"+t.brand.id+"_"+t.network);if(s&&s.length>0&&s[0].remove(),0===$L("#reauth_accounts").children().length){var r=$L("crm-social-account-reauth");r&&r.length>0&&r[0].remove(),$L(".socSettingIconOuter").find(".reauthDot").removeClass("follow_dot")}}}},{mixins:["crm-social-integration","crm-social-tab"]});
