$L&&($L.prototype.lazyRender=function(e){var t=this[0];if("scrollTop"===e.direction){if(e&&!e.onEnd&&(e.onEnd=function(){}),e&&!e.startLoader&&(e.startLoader=function(){}),e&&!e.endLoader&&(e.endLoader=function(){}),e.dataToRender||(e.dataToRender=[]),e.dataToRender.length<1)for(var a=0,i=e.entireData.length-e.renderConfig.initialRenderCount;a<e.renderConfig.initialRenderCount;a++)Lyte.arrayUtils(e.dataToRender,"push",e.entireData[i+a]),t.scrollTop=t.scrollHeight;function n(){if(t.scrollTop<=50){var a=e.renderConfig.pushCount,i=0;function n(){var o=e.entireData.slice(e.entireData.length-(e.dataToRender.length+e.renderConfig.renderCount),e.entireData.length-e.dataToRender.length);if("undefined"!==e.renderConfig.loader&&!1===e.renderConfig.loader&&Lyte.objectUtils(e.renderConfig,"add","loader",!0),e.startLoader(),Lyte.arrayUtils(e.dataToRender,"insertAt",0,o),"undefined"!==e.renderConfig.loader&&!0===e.renderConfig.loader&&Lyte.objectUtils(e.renderConfig,"add","loader",!1),e.endLoader(),i+=e.renderConfig.renderCount,0==t.scrollTop&&(t.scrollTop=5),i>=a)return o=[],void window.cancelAnimationFrame(n)}if(e.entireData.length<=e.dataToRender.length){var o=e.onEnd();o&&o.then((function(){window.requestAnimationFrame(n)})),e.entireData.length>e.dataToRender.length&&window.requestAnimationFrame(n)}else window.requestAnimationFrame(n)}}$L(this).bindScroll(n)}else{if(e&&!e.onEnd&&(e.onEnd=function(){}),e&&!e.startLoader&&(e.startLoader=function(){}),e&&!e.endLoader&&(e.endLoader=function(){}),e.dataToRender||(e.dataToRender=[]),e.dataToRender.length<1)for(a=0;a<e.renderConfig.initialRenderCount;a++)Lyte.arrayUtils(e.dataToRender,"push",e.entireData[a]);function n(){if(t.offsetHeight+t.scrollTop>=t.scrollHeight){var a=e.renderConfig.pushCount,i=0;function n(){var t=e.entireData.slice(e.dataToRender.length,e.dataToRender.length+e.renderConfig.renderCount);if("undefined"!==e.renderConfig.loader&&!1===e.renderConfig.loader&&Lyte.objectUtils(e.renderConfig,"add","loader",!0),e.startLoader(),Lyte.arrayUtils(e.dataToRender,"push",t),"undefined"!==e.renderConfig.loader&&!0===e.renderConfig.loader&&Lyte.objectUtils(e.renderConfig,"add","loader",!1),e.endLoader(),(i+=e.renderConfig.renderCount)>=a)return t=[],void window.cancelAnimationFrame(n)}if(e.entireData.length<=e.dataToRender.length){var o=e.onEnd();o&&o.then((function(){window.requestAnimationFrame(n)})),e.entireData.length>=e.dataToRender.length&&window.requestAnimationFrame(n)}else window.requestAnimationFrame(n)}}$L(this).bindScroll(n)}}),Lyte.Component.register("crm-zia-call-transcription",{_template:'<template tag-name="crm-zia-call-transcription"> <template is="if" value="{{ziaCallTranscriptAvailable}}"><template case="true"><div> <template is="for" items="{{ziaCallTranscript}}" item="ziaCallTranscriptItem" index="index"> <div class="dIB"> <div class="transcript_pb flexAlignCenter"> <div class="transcriptControl_pb transcriptPadding dIB pR"> <div class="dIB vaM mL5"> <crmutil-icon icon-name="attachment-document" icon-class="zcicn-attachment-document "></crmutil-icon> </div> </div> <div class="dIB ziaCallTransPadding" lt-prop-title="{{fileNameFull}}"> <div class="dIB crm-small-font-size pR maxW200"> <span class="oH tOE wsNowrap vaBottom dIB pT0 maxW110"> {{fileName}} </span> </div> <span class="crm-small-font-size pR5">&nbsp;{{subFileName}}</span> </div> <template is="if" value="{{ziaCallTranscriptItem.is_Preview_Available}}"><template case="true"><div class="transcriptControl_pb crm-call-highlight-hoverIcon flexAlignCenter jcCenter pR tranIcon cP" data-zcqa="ZiaCallTIpreview" lt-prop-title="{{getI18n(\'crm.setup.editor.prevheader\')}}" onclick="{{action(\'openPreview\',ziaCallTranscriptItem.preview_Url,ziaCallTranscriptItem.download_Url)}}"> <div class="dIB vaM"> <template is="if" value="{{isLoading}}"><template case="true"><crm-ui-loaders interaction-name="crmCircleShadowLoader"></crm-ui-loaders></template></template> <template is="if" value="{{expHandlers(isLoading,\'!\')}}"><template case="true"><crmutil-icon icon-name="eye-open" class="mT3" icon-class="zcicn-eye-open zcicn_616E88 "></crmutil-icon></template></template> </div> </div></template></template> <div class="transcriptControl_pb crm-call-highlight-hoverIcon flexAlignCenter jcCenter pR tranIcon cP" lt-prop-title="{{getI18n(\'crm.databackup.link.heading\')}}" data-zcqa="ZiaCallTIDownload" onclick="{{action(\'downloadFile\',ziaCallTranscriptItem.download_Url)}}"> <div class="dIB vaM"><crmutil-icon icon-name="download" icon-class="zcicn-download zcicn_616E88 "></crmutil-icon></div> </div> </div> </div> </template> </div></template></template> <lyte-modal lt-prop-show="{{lbind(showPreviewModule)}}" lt-prop-wrapper-class="crmModalWithoutFooter" lt-prop-width="1000px" lt-prop-max-height="90%" lt-prop-offset="{&quot;top&quot;:&quot;0&quot;,&quot;left&quot;:&quot;center&quot;}" lt-prop-show-close-button="false"> <template is="registerYield" yield-name="modal"> <lyte-modal-header class="br_bottom_border2"> <div class="flexAlignCenter spaceBetween"> <div class="dIB">Call transcript with highlights</div> <div class="flexAlignCenter"> <div class="cP crm-call-highlight-downloadicon flexAlignCenter h16 jcCenter mR20 pR w16" lt-prop-title="{{getI18n(\'crm.databackup.link.heading\')}}" onclick="{{action(\'downloadFile\',downloadUrl)}}"> <span class="zcicncss-download zcicn-cssIcons zcicncss16 cP"></span> </div> <span class="cP zcicn-cssIcons zcicncss-close" onclick="{{action(\'closeModel\')}}" lt-prop-title="{{getI18n(\'Close\')}}"></span> </div> </div> </lyte-modal-header> <lyte-modal-content class="oH flexAlignStart h100_per pT0 pR br0"> <div class="flexOne oA cd_people_image crm-call-conversation br0" id="scrollTrag"> <div class="crm-subheading-font-size crm-font-bold mT20 mB5">{{fileNameConv}}</div> <div class="pR20 mB20"> <template items="{{highlights.conversation_details_sample}}" item="conversation" index="index" is="for"><div class="dF pT15 pB15"> <img class="h30 w30 br50per" src="{{if(conversation.communicator.resource._image_id,conversation.communicator.resource._image_id,getUserImageUrlByZuId())}}" alt="User image"> <div class="flexOne mL10"> <div class="br_border3 pT5 pB6 pL15 pR15 dIB br12 lh24"> <div class="flexAlignCenter gap5 mB5"> <div class="crm-font-semibold"> {{conversation.communicator.resource.name}} </div> <span class="dotIcon_COB"></span> <div class="crmLabelColor">{{if(expHandlers(conversation.communicator.type,\'===\',\'user\'),\'Customer\',\'Agent\')}}</div> </div> <template is="for" items="{{conversation.textValue}}" item="txt" index="index"> <template is="if" value="{{expHandlers(txt.tag,\'===\',\'untyped\')}}"><template case="true"> <span class="p3">{{txt.text}}</span> </template><template case="false"><template is="if" value="{{textHighlight[txt.tag].show}}"><template case="true"> <span class="br10 p3 crm-font-semibold wsNowrap {{if(textHighlight[txt.tag].show,textHighlight[txt.tag].bgClass,\'\')}}">{{txt.text}}</span> </template><template case="false"> <span class="p3">{{txt.text}}</span> </template></template></template></template> </template> </div> </div> </div></template> </div> <template is="if" value="{{expHandlers(isLoadMoreCompleted,\'!\')}}"><template case="true"><div class="waverecommendation pR aligncenter mT15 mB10" id="OnLoading"> <span class="zvoice-dot"></span> <span class="zvoice-dot"></span> <span class="zvoice-dot"></span> </div></template></template> </div> <div class="w240 pL20 oA cd_people_image"> <div class="crm-subheading-font-size crm-font-bold mT20">Key Highlights</div> <template items="{{getKeys(textHighlight)}}" item="highlight" index="index" is="for"><template is="if" value="{{expHandlers(textHighlight[highlight].count,\'!==\',0)}}"><template case="true"><div class="mT25 flexAlignCenter cP" lt-prop-title="{{getI18n(textHighlight[highlight].display_i18n)}}" data-zcqa="CH_preview_{{index}}" onclick="{{action(\'changeHighlight\',highlight)}}"> <div class="w22 h22 br4 flexAlignCenter jcCenter {{textHighlight[highlight].bgClass}}">{{textHighlight[highlight].count}}</div> <div class="mL10 flexOne">{{textHighlight[highlight].display}}</div> <div class="mlAuto cP flexAlignCenter h16"> <span class="zcicn-cssIcons {{if(textHighlight[highlight].show,\'zcicncss-eye\',\'zcicncss-eye-closed\')}}"></span> </div> </div></template></template></template> </div> </lyte-modal-content> </template> </lyte-modal> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[0,1]},{type:"for",position:[0,1],dynamicNodes:[{type:"componentDynamic",position:[1,1,1,1,1]},{type:"attr",position:[1,1,3]},{type:"text",position:[1,1,3,1,1,1]},{type:"text",position:[1,1,3,3,1]},{type:"attr",position:[1,1,5]},{type:"if",position:[1,1,5],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"attr",position:[0,1,1]},{type:"if",position:[0,1,1],cases:{true:{dynamicNodes:[{type:"componentDynamic",position:[0]}]}},default:{}},{type:"attr",position:[0,1,3]},{type:"if",position:[0,1,3],cases:{true:{dynamicNodes:[{type:"componentDynamic",position:[0]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,1,7]},{type:"componentDynamic",position:[1,1,7,1,0]}]}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1,3,1]},{type:"attr",position:[1,1,3,3]},{type:"componentDynamic",position:[1]},{type:"text",position:[3,1,1,0]},{type:"attr",position:[3,1,3,1]},{type:"for",position:[3,1,3,1],dynamicNodes:[{type:"attr",position:[0,1]},{type:"text",position:[0,3,1,1,1,1]},{type:"text",position:[0,3,1,1,5,0]},{type:"attr",position:[0,3,1,3]},{type:"for",position:[0,3,1,3],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}}]}]},{type:"attr",position:[3,1,5]},{type:"if",position:[3,1,5],cases:{true:{dynamicNodes:[]}},default:{}},{type:"attr",position:[3,3,3]},{type:"for",position:[3,3,3],dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"attr",position:[0,1]},{type:"text",position:[0,1,0]},{type:"text",position:[0,3,0]},{type:"attr",position:[0,5,1]}]}},default:{}}]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[3]}],_observedAttributes:["activityId","fileName","fileNameFull","fileNameConv","ziaCallTranscriptAvailable","isPdf","isLoading","isLoadMore","isLoadMoreCompleted","ziaCallTranscript","showPreviewModule","textHighlight"],data:function(){return{activityId:Lyte.attr("string",{default:""}),fileName:Lyte.attr("string",{default:""}),fileNameFull:Lyte.attr("string",{default:""}),fileNameConv:Lyte.attr("string",{default:""}),ziaCallTranscriptAvailable:Lyte.attr("boolean",{default:!1}),isPdf:Lyte.attr("boolean",{default:!1}),isLoading:Lyte.attr("boolean",{default:!1}),isLoadMore:Lyte.attr("boolean",{default:!0}),isLoadMoreCompleted:Lyte.attr("boolean",{default:!1}),ziaCallTranscript:Lyte.attr("array",{default:[]}),showPreviewModule:Lyte.attr("boolean",{default:!1}),textHighlight:Lyte.attr("object",{default:{person:{show:!0,count:0,bgClass:"crm-call-highlight1",values:[],display:"Person",display_i18n:"crm.zia.vision.gallery.person"},organization:{show:!0,count:0,bgClass:"crm-call-highlight2",values:[],display:"Organization",display_i18n:"crm.books.configure.org.label"},location:{show:!0,count:0,bgClass:"crm-call-highlight3",values:[],display:"Location",display_i18n:"crm.ln.lable.location"},date:{show:!0,count:0,bgClass:"crm-call-highlight4",values:[],display:"Date",display_i18n:"crm.label.smallDate"},email:{show:!0,count:0,bgClass:"crm-call-highlight5",values:[],display:"Email",display_i18n:"crm.field.label.email"},phone:{show:!0,count:0,bgClass:"crm-call-highlight6",values:[],display:"Phone",display_i18n:"crm.field.label.phone"},key_phrase:{show:!0,count:0,bgClass:"crm-call-highlight7",values:[],display:"Key Phrase",display_i18n:"zia.call.key_phrase"},key_sentence:{show:!0,count:0,bgClass:"crm-call-highlight8",values:[],display:"Key Sentence",display_i18n:"zia.call.key_sentence"}}})}},getSubName:function(e){return e?`${e.length>10?e.substring(0,10)+"...":e}`:""},init:function(){var e=this;if(e.setData({ziaCallTranscriptAvailable:!1,ziaCallTranscript:[]}),moduleRecordMapping.Calls.isCallTranscriptionEnable){const t=this.getData("activityId");(void 0===store.peekRecord(moduleRecordMapping.Calls.id,t)?store.findRecord(moduleRecordMapping.Calls.id,t):Promise.resolve()).then((function(){const a=store.peekRecord(moduleRecordMapping.Calls.id,t);if(a){const t=a.Call_Transcription__c;if(t&&0!==t.length){let i="Outgoing";returnJson&&returnJson.entMetaData&&returnJson.entMetaData.callDirection&&(i="Outbound"===returnJson.entMetaData.callDirection?"Outgoing":"Incoming");const n=t.map((e=>e.file_Name.split("Zia Call transcription - ")[1]))[0],o=n.replaceAll(".txt","").replaceAll(".pdf",""),l=n.endsWith(".pdf"),s=new CrmDate(o),r=s.dateObject.getTime()+6e4*s.dateObject.getTimezoneOffset(),c=$L.moment(r).format("DD-MM-YYYY")+" at "+$L.moment(r).format("hh:mm A")+(l?".pdf":".txt"),d=$L.moment(r).format("DD-MM-YYYY")+" at "+$L.moment(r).format("hh:mm A");e.setData("subFileName",c);let p=`${a.What_Id?e.getSubName(a.What_Id.name):""}${a.Who_Id?e.getSubName(a.Who_Id.name):""}`,m=`${a.What_Id?a.What_Id.name:""}${a.Who_Id?a.Who_Id.name:""}`,g=`${i} call to ${p} from ${e.getSubName(a.Created_By.name)} transcript ${c}`,h=`${i} Call on ${d}`;e.setData({isPdf:l,fileNameConv:h,fileNameFull:`${i} call to ${m} from ${a.Created_By.name} transcript ${c}`}),g=g.length>=30?g.substring(0,20)+"..."+g.substring(g.length-10):g,e.setData({fileName:g,ziaCallTranscriptAvailable:!0,ziaCallTranscript:1===t.length?t:[t[1]]})}}}))}},didDestroy:function(){this.setData("highlights",void 0);const e=$("#scrollTrag");e.unbind("scroll"),thirdPartyUtils.unbindPerfectScroll(e)},preProcessHighlights:function(e){if(e){const t=this.getData("textHighlight");if(t){let a=(e=>{let t=e.text_highlights.flatMap((e=>e.values.map((t=>({value:t,tag:e.type.toLowerCase()}))))).sort(((e,t)=>t.value.length-e.value.length)),a={};return{messagesRendered:e.conversation_details.map((e=>{let i=e.text;return t.forEach((t=>{let n=t.value.replace(/[-[\]{}()*+.,\\^$|#\s]/g,"\\$&").replace(/\s*$/,"(?:\\s|$|[!?$\\.\\,])?(?:\\s[.,])?"),o=new RegExp(`(${n})`,"gi");i=i.replace(o,`<span class="${t.tag}">$1</span>`);let l=e.text.match(o);l&&(a[t.tag]||(a[t.tag]=0),a[t.tag]+=l.length)})),e.textValue=Array.from(i.matchAll(/(<span class="(\w+)">(.+?)<\/span>)|([^<]+)/g)).map((e=>e[1]?{text:e[3].trim(),tag:e[2]}:{text:e[4].trim(),tag:"untyped"})),e.text=i,e})),overallTagCount:a}})(e);Object.keys(a.overallTagCount).forEach((e=>{let i=t[e];i&&Lyte.objectUtils(i,"add","count",a.overallTagCount[e])})),e.conversation_details=a.messagesRendered,e.conversation_details_sample=[]}}return e},loadPreview:function(e,t){const a=this,i=networkUtils.returnDependencyFiles(["zia_call_analytics_config.js"],ResourceConstants.CRMClient),n=networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("zia-call-analytics")],ResourceConstants.CRM),o=i.concat(n);a.setData("isLoading",!0),(void 0===store.modelFor("zia_call_analytics_config")?Lyte.injectResources(o):Promise.resolve()).then((function(){(void 0===store.peekAll("zia_call_analytics_config")||0===store.peekAll("zia_call_analytics_config").length?store.findAll("zia_call_analytics_config",{type:"call_analytics",category:2}):Promise.resolve()).then((function(){a.setData("ziaCallAnalyticsConfigs",store.peekAll("zia_call_analytics_config").sortBy("order"));const i=Lyte.Router.getRouteInstance().transition.info.dynamicParams,n=i[0],o=i[1];a.setData({module:n,entityId:o});const l=a.getData("ziaCallAnalyticsConfigs").filterBy({type:"call_highlight"});l&&l[0]&&l[0].enabled?Lyte.registeredMixins["zia-insights-utils"].getInsightsV2(moduleRecordMapping[n],a.getData("entityId"),{keys:"call_analytics_data"}).then((i=>{if(i.zia_insights&&i.zia_insights.call_analytics_data){Lyte.deepCopyObject(i.zia_insights.call_analytics_data.output).forEach((i=>{const n=a.preProcessHighlights(i.highlights);a.setData("highlights",n),a.setData({showPreviewModule:!0,downloadUrl:e,isLoading:!1}),$L(".crm-call-conversation").scrollTop(0),n||networkUtils.openUrl(t,"_blank","");const o=a.getData("highlights");o.conversation_details.length>100?$L("#scrollTrag").lazyRender({entireData:o.conversation_details,dataToRender:o.conversation_details_sample,renderConfig:{initialRenderCount:Math.min(o.conversation_details.length,100),pushCount:o.conversation_details.length,renderCount:100},startLoader:function(){a.setData("isLoadMoreCompleted",!1)},endLoader:function(){a.setData("isLoadMoreCompleted",!0)},onEnd:function(){a.setData("isLoadMoreCompleted",!0)}}):(Lyte.arrayUtils(o.conversation_details_sample,"push",o.conversation_details),a.setData("isLoadMoreCompleted",!0))}))}})):(a.setData({highlights:void 0,isLoading:!1}),networkUtils.openUrl(t,"_blank",""))}))}))},actions:{changeHighlight:function(e){const t=this.getData("textHighlight");let a=t[e];a&&(Lyte.objectUtils(a,"add","show",!a.show),Lyte.objectUtils(t,"add",e,a))},closeModel:function(){this.setData("showPreviewModule",!1)},openPreview:function(e,t){if(this.setData("showPreviewModule",!1),this.getData("isPdf"))this.getData("highlights")?(this.setData({showPreviewModule:!0,downloadUrl:t}),$L(".crm-call-conversation").scrollTop(0)):this.loadPreview(t,e);else{const t=this.getData("fileName");Crm.client_tracking("Zia Call Transcript Preview Click",{}),e=this.removeURLParameter(e,"name")+"&name="+encodeURIComponent(t),openSheetForExport(e+"&name="+encodeURIComponent(t))}},downloadFile:function(e){const t=this.getData("fileName");Crm.client_tracking("Zia Call Transcript Download Click",{}),e=this.removeURLParameter(e,"name")+"&name="+encodeURIComponent(t),networkUtils.openUrl(e,"_blank")}},removeURLParameter(e,t){var a=e.split("?");if(a.length>=2){var i=encodeURIComponent(t)+"=",n=a[1].split(/[&;]/g);for(let e=n.length;e-- >0;)-1!==n[e].lastIndexOf(i,0)&&n.splice(e,1);return a[0]+(n.length>0?"?"+n.join("&"):"")}return e}});
