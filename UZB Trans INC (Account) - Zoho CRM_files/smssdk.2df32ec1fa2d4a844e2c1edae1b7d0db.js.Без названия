var ClientFrame=function(){function e(e,t,r){this.frameSelector=e,this.domain=t,this.source=t+r,this.frameId="client-frame-"+e+"_"+Date.now(),this.isRendered=!1,this.callBackFrame=void 0,this._listeners=[]}function t(t,r){t instanceof e&&t.sendMessage(r)}return e.prototype.generateFrame=function(e,t){if(this.$iframeElement)return this.$iframeElement;this.$iframeElement=document.createElement("iframe"),this.$iframeElement.setAttribute("src",this.source),this.$iframeElement.setAttribute("id",this.frameSelector),this.$iframeElement.setAttribute("name",this.frameSelector),Object.assign(this.$iframeElement.style,e);var r=this;return this.$iframeElement.onload=function(){r.isRendered=!0,r.sendMessage({action:"client-frame",data:{status:"loaded",frameId:r.frameId}}),t&&t()},this.$iframeElement},e.prototype.render=function(e,t,r){this.isRendered||(this.generateFrame(t,r),e.appendChild(this.$iframeElement))},e.prototype.sendMessage=function(e){if(!this.isRendered)throw new Error("ClientFrame not rendered");this.$iframeElement.contentWindow.postMessage(e,this.domain)},e.prototype.listenMessage=function(e){this.listenerAdded||(window.addEventListener("message",(e=>{var r=e.data;if(r.frameId===this.frameId)switch(r.action){case"client-frame-render":!function(e,r){e.getRendererFrame((function(e){e.showFrame(),t(e,r)}))}(this,r);break;case"client-renderer-callback":!function(e,r){r.meta.showFrame||e.hideFrame(),t(e.callBackFrame,r)}(this,r);break;default:this._listeners.length>0&&this._listeners.forEach((function(t){try{t(r,e)}catch(e){Lyte.error(e)}}))}})),this.listenerAdded=!0),"function"==typeof e&&this._listeners.push(e)},e.prototype.showFrame=function(){this.$iframeElement&&(this.$iframeElement.style.display="block")},e.prototype.hideFrame=function(){this.$iframeElement&&(this.$iframeElement.style.display="none")},e.prototype.deleteFrame=function(){this.$iframeElement&&this.$iframeElement.parentNode.removeChild(this.$iframeElement)},e.prototype.setRendererFrameProvider=function(e){this.rendererFrameProvider=e},e.prototype.getRendererFrame=function(e){var t=this;if("function"==typeof t.rendererFrameProvider)return t.rendererFrameProvider().then((function(r){r.callBackFrame=t,e(r)}))},e}(),SMS=SMS||{};SMS=function(){var e,t,r,n,i,a,s=!1,o=!1,d=console,c={},l={},m={};function u(e){t.sendMessage({action:"setServiceSMSDetails",data:e})}function f(t){if(t.action)switch(t.action){case"smssdk_ready":o=!0,e&&e(r);break;case"sms_service_client_request":var n=t.data,i=n._meta,s="success"===i.status?c:l;s[i.id]&&(s[i.id](n.response),delete c[i.id],delete l[i.id]);break;case"dltuploader":r.hideFrame();break;case"darkmode":COMMON_UTILS.toggleDarkmode(t.isDarkmode);break;case"sms_integ_status":a=t.data;break;case"reloadsetup":var d=t.data;if("zpbsmssetup"===d.frameName||"zpbsms_sdk"===d.frameName){var m=document.getElementById(d.frameName);m.src=m.src}default:if("function"==typeof callBackZPBSMS){var f=u;callBackZPBSMS({action:t.action,data:t.data,callBackFn:f})}}}function h(){return new Promise(o?function(e){e(r)}:function(t){!function(){var e={action:"service_data",serviceID:n.serviceId,serviceName:n.serviceName,serviceData:n.serviceData,bundleService:n.bundleService,bundleOrgId:n.bundleOrgId,setupPageCssUrl:n.setupPageCssUrl,sdkCssUrl:n.sdkCssUrl,callback:n.callback,displayName:n.displayName,darkmode:n.darkmode,storeOrgId:n.storeOrgId,storeServiceName:n.storeServiceName};n.darkmode&&(SMS.darkmode=n.darkmode);var t=document.location.origin,a="";if(n.bundleService&&""!==n.bundleService){if("ZohoOne"===n.bundleService&&"ZohoOne"!==n.serviceName){var s=document.referrer;window.location!==window.parent.location&&document.referrer&&(s="https://"+(s=(s=document.referrer.split("https://"))[1].substr(0,s[1].indexOf("/")))),t=window.location!==window.parent.location?s+","+document.location.origin:document.location.origin}a="/smsbridge/viewcomponent/sdk?frameorigin="+t+"&serviceName="+n.serviceName+"&serviceID="+n.serviceId+"&bundleService="+n.bundleService+"&bundleOrgId="+n.bundleOrgId}else a="/smsbridge/viewcomponent/sdk?frameorigin="+t+"&serviceName="+n.serviceName+"&serviceID="+n.serviceId+"&darkmode="+SMS.darkmode;["storeOrgId","storeServiceName","displayName"].forEach((e=>{n[e]&&(a+=`&${e}=${n[e]}`)})),(r=new ClientFrame("zpbsms_sdk",i,a)).listenMessage(f),r.render(document.body,{border:"none",position:"fixed",left:"0px",top:"0px",height:"100vh",width:"100vw","z-index":"1200",display:"none"},(function(){r.sendMessage({action:"smssdk_ready",data:e}),r.sendMessage(e)}))}(),e=t})}function v(e,t,n,i){return o?new Promise((function(a,s){var o=e+"_"+performance.now();c[o]=a,l[o]=s,r.sendMessage({action:"sms_service_client_request",method:t,resource:e,params:n,recordid:i,_meta:{id:o,method:t,resource:e}})})):h().then((function(){return v(e,t,n,i)}))}return{init:function(e){if(e&&e.serviceId){if((n=e).smsDomain&&""!==n.smsDomain)i=n.smsDomain;else{var t=location.hostname.split(".").join(".");i=t.includes("tsi")?"https://phonebridge.csez.zohocorpin.com":"https://phonebridge."+t}s=!0,"function"==typeof callBackZPBSMS&&callBackZPBSMS({action:"sdk_ready",data:{}})}},loadSetup:function(e,r,a,o){if(!s)throw"sms service not registered";var d={action:"setupPageReady",serviceID:n.serviceId,serviceName:n.serviceName,serviceData:n.serviceData,bundleService:n.bundleService,bundleOrgId:n.bundleOrgId,serviceSMSDetails:a,setupPageCssUrl:n.setupPageCssUrl,displayName:n.displayName,darkmode:n.darkmode,storeOrgId:n.storeOrgId,storeServiceName:n.storeServiceName},c={border:"none",width:"100%",height:r+"px"};n.darkmode&&(SMS.darkmode=n.darkmode);var l=document.location.origin,m="";if(n.bundleService&&""!==n.bundleService){if("ZohoOne"===n.bundleService&&"ZohoOne"!==n.serviceName){var u=document.referrer;window.location!==window.parent.location&&document.referrer&&(u="https://"+(u=(u=document.referrer.split("https://"))[1].substr(0,u[1].indexOf("/")))),l=window.location!==window.parent.location?u+","+document.location.origin:document.location.origin}m="/smsbridge/viewcomponent/setup?frameorigin="+l+"&serviceName="+n.serviceName+"&serviceID="+n.serviceId+"&bundleService="+n.bundleService+"&bundleOrgId="+n.bundleOrgId}else m="/smsbridge/viewcomponent/setup?frameorigin="+l+"&serviceName="+n.serviceName+"&serviceID="+n.serviceId+"&darkmode="+SMS.darkmode;["storeOrgId","storeServiceName","displayName"].forEach((e=>{n[e]&&(m+=`&${e}=${n[e]}`)})),(t=new ClientFrame("zpbsmssetup",i,m)).setRendererFrameProvider(h),t.listenMessage(f);var v=function(){if(t.sendMessage(d),o){var e=document.getElementById("sms_response"),r=null!==e?e.value:"success";o(r)}};if(e){var p=document.getElementById(e);return p.textContent="",void t.render(p,c,v)}return t.generateFrame(c,v)},setSMSDetails:u,API:{GET:{actions:function(){return v("action","findAll")},template_fields:function(){return v("template_field","findAll")},template:function(e,t){return v("template","findRecord",{data_needed:t},e)}},PUT:{enablePortal:function(e){return v("","enablePortal",{portalID:e})}}},EVENT:{triggerAction:function(e){var t,i=e.event_data;switch(e.event_name){case"sms_sdk_dltuploader_action":t=e.tag,r.showFrame(),r.sendMessage({action:"dltuploader",setupPageCssUrl:n.setupPageCssUrl,tag:t});break;case"sms_sdk_dlt_copycontent_action":return v("","copyDLT",{event_data:i}).then((function(e){return navigator.clipboard.writeText(e.content).then((function(){return new Promise((function(t){t({status:"success",message:e.success_msg,error:""})}))}),(function(t){return new Promise((function(r,n){n({status:"error",message:e.failure_msg,error:t})}))}))}));default:d.error("SMS.Event.triggerAction => Invalid Action Id - "+event_name)}}},UTILS:{hideSDKUI:function(){r.hideFrame()},removeSDKFrame:function(){o=!1,r&&(r.deleteFrame(),r=null)},removeSetupFrame:function(){t&&(t.deleteFrame(),t=null)},process_dlt_file:function(e,t){v("","DLT_meta").then((function(r){FILE.process(e,t,r)}))},toggleTheme:function(e){var n=e.darkmode;SMS.darkmode!==n&&(SMS.darkmode=n,m={action:"toggleDarkmode",isDarkmode:n},t&&t.sendMessage({action:"darkmode",data:m}),r&&r.sendMessage({action:"darkmode",data:m}))}},isEnabled:function(){return a},darkmode:!1}}();var result={status:"success",message:"file processed successfully."},FILE={dltmodifiedArr:[],choosenPlatform:"",process:function(e,t,r){this.DLT_META=r;var n=new FileReader;n.onload=function(){result.data=FILE.parseCsv(n.result,t)},n.readAsText(e)},convertCSVtoJson:function(e){for(var t=[],r=e[0],n=e.length,i=1;i<n;i++)if(e[i]){for(var a={},s=e[i],o=r.length,d=0;d<o;d++)a[r[d]]=this.removeTrailingQuotes(s[d]);t.push(a)}return t},removeTrailingQuotes:function(e){return'"'===e[0]&&'"'===e[e.length-1]||"'"===e[0]&&"'"===e[e.length-1]?e.substring(1,e.length-1):e},parseCsv:function(e,t){var r=e.split(/\r?\n(?=(?:[^"]*"[^"]*")*[^"]*$|[^"]*$)/),n=[],i=[],a=r.length;for(let e=0;e<a;e++)if(""!==r[e]){var s=(n=r[e].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)).length-1;n[s].endsWith("\r")&&(n[s]=n[s].replace(/\r$/,"")),i.push(n)}var o=this.convertCSVtoJson(i);this.setDltPlaformMeta(o),this.dltmodifiedArr&&this.dltmodifiedArr.length>0?(result.choosenPlatform=this.choosenPlatform,result.data=this.dltmodifiedArr,t&&t(JSON.stringify(result))):(result.data="Invalid File",t&&t(JSON.stringify(result)))},setDltPlaformMeta:function(e){var t=this.DLT_META,r=t.chosenDltPlatform,n=t.dltVsFieldMap.chosenPlatform;if(e[0][n])return this.choosenPlatform=r,this.dltmodifiedArr=this.validateAndSetDLTData(e,t[r]),!0;let i=t.dltVsFieldMap;for(let r in i)if(i.hasOwnProperty(r)&&e[0][i[r]])return this.choosenPlatform=r,this.dltmodifiedArr=this.validateAndSetDLTData(e,t[this.choosenPlatform]),!0;return!1},validateAndSetDLTData:function(e,t){for(var r=[],n=e.length,i=0;i<n;i++){for(var a=e[i],s={},o=!1,d=t.length,c=0;c<d;c++){var l=t[c],m=l.default_value?l.default_value:a[l.selector];if(l.regex&&(m=m.replace(new RegExp(l.regex,"g"),"")),l.is_required&&this.isEmpty(m)){o=!0;break}l.relative_path?(s[l.relative_path]||(s[l.relative_path]={}),s[l.relative_path][l.api_name]=m):s[l.api_name]=m}o||r.push(s)}return r},isEmpty:function(e){try{var t=null;if("object"!=typeof e&&"string"==typeof e)t=e.replace(/\ /g,"");else if("object"==typeof e)return Object.keys(e).length<1;return null===e||""===e||void 0===e||"null"===e||"NULL"===e||"empty"===e||"EMPTY"===e||"undefined"===e||"UNDEFINED"===e||""===t}catch(e){return!0}}};