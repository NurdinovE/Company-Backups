Lyte.Component.register("crm-cscript-hotkeys",{_template:'<template tag-name="crm-cscript-hotkeys"> <lyte-modal lt-prop-show="{{show}}" lt-prop-height="auto" lt-prop-max-height="80%" lt-prop-transition="{&quot;animation&quot;:&quot;fadeIn&quot;,&quot;duration&quot;:&quot;0.2&quot;}" lt-prop-offset="{&quot;top&quot;:&quot;center&quot;,&quot;left&quot;:&quot;center&quot;}" lt-prop-width="550px" lt-prop-wrapper-class="cskey-modal" lt-prop-overlay-close="true" lt-prop-show-close-button="false" on-close="{{method(\'onClose\')}}"> <template is="registerYield" yield-name="modal"> <lyte-modal-content class="p0 dF flexDC"> <div class="aiCenter cskey-modal-header dF {{if(and(hasDevAccess,or(and(not(noScriptExist),not(isROMode)),max_script_reached)),\'pR15\',\'\')}}"> <lyte-search id="cskey-search" data-zcqa="commands_script_search" class="pR cs_cmndSearch flexOne" lt-prop-direction="vertical" lt-prop-query-selector="{&quot;scope&quot; : &quot;.cskey-scripts-container&quot;, &quot;search&quot; : &quot;.cskey-name&quot;,&quot;target&quot;:&quot;.cskey-target&quot;}" on-search="{{method(\'onSearch\')}}" lt-prop-disabled="{{noScriptExist}}"> <span class="crm-base-font-size pA left15 crm-medium-large-font-size zi10 cs_commandIcon">&gt;</span> </lyte-search> <template is="if" value="{{expHandlers(hasDevAccess,\'&amp;&amp;\',expHandlers(expHandlers(expHandlers(isROMode,\'!\'),\'&amp;&amp;\',expHandlers(noScriptExist,\'!\')),\'||\',max_script_reached))}}"><template case="true"><crmutil-icon data-zcqa="cscript_commands_manage_icon" lt-prop-title="{{getI18n(\'manage\')}} {{getI18n(\'Commands\')}}" icon-name="settings-reg" icon-class="zcicn-settings-reg zcicn_grey cP" onclick="{{action(\'manageCommands\')}}"></crmutil-icon></template></template> </div> <div class="cskey-scripts-container"> <template is="for" items="{{scriptJSON}}" item="item" index="idx"> <div class="cskey-target" data-zcqa="commands_script_{{item.scriptName}}"> <div class="{{if(expHandlers(idx,\'==\',activeIndex),\'cskey-scripts-col-active\',\'\')}} cskey-scripts-col cP dF spaceBetween aiCenter" onmousemove="{{action(\'handleMouseMove\',this)}}" onclick="{{action(\'itemClicked\',item)}}"> <lyte-text class="cskey-name" lt-prop-value="{{item.scriptName}}"></lyte-text> <div class="dIF"> <template is="if" value="{{item.key_combination}}"><template case="true"><template is="for" items="{{item.key_combination}}" item="key" index="index"><template is="if" value="{{isShortcutEnabled}}"><template case="true"> <span class="cskey-cmd-key br6 mL5">{{unescape(getEncodedVal(key))}}</span> </template></template></template></template></template> </div> </div> </div> </template> <template is="if" value="{{noScriptExist}}"><template case="true"> <template is="if" value="{{expHandlers(hasDevAccess,\'&amp;&amp;\',expHandlers(expHandlers(expHandlers(isROMode,\'||\',is_not_commands_preview_page),\'||\',max_script_reached),\'!\'))}}"><template case="true"> <div class="cskey-not-found aligncenter p20">{{getI18n(\'crm.cscript.commands.create\')}}&nbsp;<span class="crmLinkColor cP" data-zcqa="create_first_commands_script" onclick="{{action(\'openDxEditor\')}}">{{getI18n(\'crm.cscript.command\')}}</span><crmutil-icon data-zcqa="cscript_commands_help_icon" icon-name="help-square" icon-class="zcicn-help-square zcicn_grey mL10 cP" onclick="{{action(\'openHelp\',helpUrl)}}"></crmutil-icon></div> </template><template case="false"> <div class="cskey-not-found aligncenter p20">{{getI18n(\'crm.cscript.commands.noresult\')}}</div> </template></template> </template><template case="false"><template is="if" value="{{noDataFound}}"><template case="true"> <div class="cskey-not-found aligncenter p20">{{getI18n(\'crm.cscript.commands.noresult\')}}</div> </template></template></template></template> </div> </lyte-modal-content> </template> </lyte-modal> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"attr",position:[1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"attr",position:[1,1,3]},{type:"if",position:[1,1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"componentDynamic",position:[0]}]}},default:{}},{type:"attr",position:[1,3,1]},{type:"for",position:[1,3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"attr",position:[1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"attr",position:[1,1,3,1]},{type:"if",position:[1,1,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"for",position:[0],dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}]}},default:{}}]},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]},{type:"attr",position:[1,2]},{type:"text",position:[1,2,0]},{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]}]},false:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1]}],_observedAttributes:["show","scriptJSON","noDataFound","noScriptExist","activeIndex","allList","visibleList","isShortcutEnabled","hasDevAccess","is_not_commands_preview_page","isROMode","helpUrl"],data:function(){return{show:Lyte.attr("boolean"),scriptJSON:Lyte.attr("array"),noDataFound:Lyte.attr("boolean"),noScriptExist:Lyte.attr("boolean"),activeIndex:Lyte.attr("number"),allList:Lyte.attr("array"),visibleList:Lyte.attr("array"),isShortcutEnabled:Lyte.attr("boolean"),hasDevAccess:Lyte.attr("boolean",{default:Crm.userDetails.permissions.hasOwnProperty("Crm_Implied_Advanced_Dev_Access")&&Crm.userDetails.permissions.Crm_Implied_Advanced_Dev_Access}),is_not_commands_preview_page:Lyte.attr("boolean",{default:_cscript._is_preview_frame&&_cscript._preview&&"commands"!==window.parent._cscript._preview_category}),isROMode:Lyte.attr("boolean",{default:Crm.userDetails.ISROMODE}),helpUrl:Lyte.attr("string",{default:"https://www.zoho.com/crm/developer/docs/client-script/commands.html"})}},didConnect:function(){this.setup();let t={ArrowUp:-1,ArrowDown:1};addEventListener("keydown",function(e){this.getData("show")&&(Object.keys(t).includes(e.key)?(this.move(t[e.key]),e.preventDefault()):"Enter"!==e.key||this.getData("noDataFound")||(this.dispatch(this.getData("scriptJSON")[this.getData("activeIndex")].scriptId),this.closeModal()))}.bind(this))},setup:function(){let t=store.peekAll("cscript").filterBy({definition_name:"commands"});this.setData({allList:Array.from($L(".cskey-scripts-container")[0].children).map((t=>t.children[0])),noScriptExist:!this.getData("scriptJSON").length,max_script_reached:t.length&&t[0].snippet_count===Crm.userDetails.CSCRIPT_SNIPPETS_LIMIT}),$L("#cskey-search")[0].setValue("")},move:function(t){let e=this.getData("visibleList"),s=this.getData("allList"),i=e.indexOf(s[this.getData("activeIndex")]),a=i+t;a>=0&&a<e.length&&this.setData({activeIndex:s.indexOf(e[a])});const o=$L(".cskey-scripts-col");1===t&&i<o.length-1&&i>=0?(o.eq(i).removeClass("cskey-scripts-col-active"),o.eq(i+1).addClass("cskey-scripts-col-active"),o.eq(i+1)[0].scrollIntoView({block:"nearest"})):-1===t&&i>0&&(o.eq(i).removeClass("cskey-scripts-col-active"),o.eq(i-1).addClass("cskey-scripts-col-active"),o.eq(i-1)[0].scrollIntoView({block:"nearest"}))},closeModal:function(){this.setData({show:!1});let t=$L("#wmscsdiv .zcicncss-command");t[0]&&t.removeClass("cs_commnd_active")},dispatch:function(t){CScript.Engine.Hot.dispatchEvent("onInvoke",t,void 0,void 0)},actions:{handleMouseMove:function(t){this.setData({activeIndex:this.getData("allList").indexOf(t)})},itemClicked:function(t){this.dispatch(t.scriptId),this.closeModal()},openDxEditor:async function(){let t,e;try{let e=I18n.getMsg("crm.untitled.default.label"),s=store.peekAll("cscript").filterBy({definition_name:"commands"});if(s.length){const t=await store.findAll("cscript_snippets",{page_uuid:s[0].uuid});e=((t,e)=>{const s=[];let i=!1;const a=new RegExp(`^${e}(\\d*)$`,"i");if(t.forEach((t=>{const e=t.name.match(a);e&&(""===e[1]?i=!0:s.push(parseInt(e[1],10)))})),!i)return e;s.sort(((t,e)=>t-e));let o=s.length;for(let t=1;t<=o;t++)if(s[t-1]!==t)return`${e}${t}`;return`${e}${o+1}`})(t,e)}t=await this.addScript({page_unique_name:"commands",selector_info:{},event_info:{event:"onInvoke"},snippet_info:{name:e},duplicate_name_check:!0,is_from_commands_palette:!0},!0)}catch(t){"cscript editor closed"!==t.message&&murphy.error(t)}try{if(t){commonUtils.showHideLoadingDiv(!0);let s=await this.saveScript(t);if("commands"===store.peekRecord("cscript",s.page_uuid).definition_name){_cscript._hotEngine._engine?await CScript.Engine.Hot.Restart():await CScript.InitializeHot();let i=$L("crm-cscript-editor")[0];switch(i&&i.component&&(i.component.setData({is_saving:!1}),i.component.executeMethod("close_editor")),Lyte.Router.getRouteInstance().transition.info.route){case"crm.settings.section.crm-cscript":e=!0,await Lyte.triggerEvent("cscript_save",{...s,is_close:t.is_close,is_from_command_palette:!0});break;case"crm.settings.section.accessibility":let i=$L("crm-keyboard-shortcuts")[0];i&&i.component&&i.component.setData("commands.hideSection",!1)}}_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.auditlog.cscript.msg.add"),ltPropType:"success"}})}}catch(t){murphy.error(t)}commonUtils.showHideLoadingDiv(!1),!e&&this.toggle_command_palette()},manageCommands:function(){networkUtils.openUrl(window.location.origin+Crm.getCrmBasePath()+"/settings/cscript?tab=Commands","_blank")}},methods:{onClose:function(t){t.setData("ltPropReRenderModal",!0),this.closeModal()},onSearch:function(t){if(this.setData({visibleList:Array.from(t).map((t=>t.parentElement))}),t.length){let e=t[0];this.setData({activeIndex:this.getData("allList").indexOf(e.parentElement)})}this.setData({noDataFound:!t.length})}}},{mixins:["crm-open-help","crm-cscript-global-mixin"]});
