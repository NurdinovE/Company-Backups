Lyte.Mixin.register("crm-datahub-global-mixin",{jsonSchemaGenerator:function(e){var t=new Set;const a={string:function(e){return"string"==typeof e},number:function(e){return"number"==typeof e&&isFinite(e)},boolean:function(e){return"boolean"==typeof e},array:function(e){return e instanceof Array},null:function(e){return null===e},object:function(e){return e&&"object"==typeof e&&!(e instanceof Array)&&!(e instanceof Date)}};const r={datetime:/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])[tT ](2[0-4]|[01][0-9]):([0-5][0-9]):(60|[0-5][0-9])(\.\d+)?([zZ]|[+-]([0-5][0-9]):(60|[0-5][0-9]))$/,date:/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])$/,bigint:/^-?\d+(,(\d)+)*$/,email:/^[A-Za-z0-9\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF_]([A-Za-z0-9\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF!#$%&'*+-/=?^_`{|}~.]*)@(?=.{4,256}$)(([A-Za-z0-9\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)(([-_]*[A-Za-z0-9\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*)[.])+[A-Za-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]{2,22}$/,website:new RegExp('^(http:\\/\\/www.|https:\\/\\/www.|ftp:\\/\\/www.|www.|http:\\/\\/|https:\\/\\/|ftp:\\/\\/|){1}[^\0-"-\'*-,.-/:-?[-^`{}- ]+(\\.[^\0-"$-,.-/<>@[-^`{}- ]+)+([/?].*)*$'),percentage:/^\d+(?:\.\d+)?%$/,phone:function(e){const t=e.replace(/(x|ext).*$/i,"").trim(),a=t.replace(/\D/g,"");return!(a.length<1||a.length>12)&&/^(\+?[1-9]{1,4}[-.\s]?)?(\(?\d{1,4}\)?[-.\s]?)?(\d{1,4}[-.\s]?){1,3}\d{1,9}$/.test(t)},text:/.{1,255}/,textarea:/^.{256,}|[\r\n]/},i={stringFormats:Object.keys(r),isFormat:function(e,t){if("string"==typeof e&&void 0!==r[t]){if(r[t]instanceof RegExp)return r[t].test(e);if("function"==typeof r[t])return r[t](e)}return!0},typeNames:["number","string","array","object","boolean","null","date"],getType:e=>i.typeNames.find((t=>a[t](e)))},s=["alpha","alphanumeric"],n=i.stringFormats.filter((e=>s.indexOf(e)<0));function l(e){let t,a=0;for(t of e)t=t.charAt(0).toUpperCase()+t.substr(1),e[a++]=t;return e}class o{getObjectSchema(e,a){const r={type:"object"},i=Object.keys(e);return i.length>0&&(r.properties=i.reduce(((r,i)=>{r[i]={};let s=this.getLabel(i,a);if(t.has(s)){let e=!0,a=1;for(;e;)256===s.length&&(s=s.slice(0,256-(a+"").length)),t.has(s+a)?a+=1:(s+=a,e=!1)}return r[i].label=s,t.add(s),r[i]={...r[i],...this.getSchema(e[i],r[i].label)},r}),{})),r}getLabel(e,t){let a;if(e.indexOf("_")>-1){let r=e.split("_");a=t?t+" > "+l(r).join(" "):l(r).join(" ")}else{let r=e.charAt(0).toUpperCase()+e.slice(1);a=t?t+" > "+r:r}return a.slice(0,256)}getArraySchema(e){const t={type:"array"};return e.length>0&&(t.items=this.getSchema(e[0])),t}getStringSchema(e){const t={type:"string"},a=n.findIndex((t=>i.isFormat(e,t)));return a>=0&&(t.format=n[a]),t}getSchema(e,t){const a=i.getType(e);if(!a)throw new Error("Type of value couldn't be determined");let r;switch(a){case"object":r=this.getObjectSchema(e,t),r.format="map";break;case"array":r=this.getArraySchema(e,t),r.format=e&&e.length>0&&"object"===i.getType(e[0])?"table":"multiselectpicklist";break;case"string":r=this.getStringSchema(e,t),r.format||(r.format="any");break;case"null":r={type:"any",format:"any"};break;case"bigint":r={type:"number",format:"bigint"};break;case"number":r={type:"number",format:"integer"};break;case"boolean":r={type:"boolean",format:"boolean"};break;default:r={type:a,format:"any"}}return r}}function u(e,t=1,a=6){if(Array.isArray(e)&&t>=a)return[];if("object"==typeof e&&null!==e&&t<a)for(const r in e)e[r]=u(e[r],t+1,a);else if("object"==typeof e&&null!==e&&t>=a)return Array.isArray(e)?[]:{};return e}return function(e){let t=JSON.parse(JSON.stringify(e));return t=u(t),(new o).getSchema(t)}(e)},retrieveDynamicParams:async function(e,t=!1){var a=t?e:"";let r=e.details?Lyte.deepCopyObject(e.details):void 0;switch(e.type){case"module":switch(r.filter_by){case"record_id":return await this.retrieveDynamicParams(r.record_id,!0);case"criteria":return await this.retrieveDynamicParamInCriteria(r.criteria)}break;case"coql":a=r.query;break;case"rest_api":let e;for(e in r)if("url_path"===e&&r.url_path&&(a+=r[e].split("/").join(" ")+" "),null!==r[e]&&("params"===e||"headers"===e)){a+=r[e].reduce(((e,t)=>e+=t.name+" "+t.value+" "),"")}}const i=a.match(/\{\{([A-Za-z_\.\[\]\$][A-Za-z0-9_\.\[\]\$]*)\}\}/g);var s=i?i.map((e=>e.match(/\{\{([A-Za-z_\.\[\]\$][A-Za-z0-9_\.\]\[\$]*)\}\}/)[1])):[];return s=s.length>0?[...new Set(s)]:[]},moduleToQuery:function(e){function t(e,a){return null!==e&&(null!==e.left&&(a+="("),a=t(e.left,a),a+=e.value,a=t(e.right,a),null!==e.right&&(a+=")")),a}let a=[];let r=[],i=e.fields.map((e=>`"${e}"`)).join(", ");var s,n,l;if(r.push("SELECT",""===i?"id":i,"FROM",`"${e.module}"`,"WHERE"),"record_id"===e.filter_by||e.record_id)s=e.record_id?`id = ${e.record_id}`:"id is null";else if(e.criteria){!function e(t){"group_operator"===Object.keys(t)[0]?(e(t.group[0]),e(t.group[1])):a.push(function(e){e.field.api_name=`"${e.field.api_name}"`;const t={equal:"=",not_equal:"!=",ends_with:"like",starts_with:"like",contains:"like",not_contains:"not like",less_equal:"<=",less_than:"<",between:"between",not_between:"not between",greater_equal:">=",greater_than:">"},a=Object.keys(t).indexOf(e.comparator),r=Object.values(t)[a];let i=e.value;if(-1!==["starts_with","ends_with","contains","not_contains","between","not_between"].indexOf(e.comparator))switch(e.comparator){case"starts_with":i=`${i}%`;break;case"ends_with":i=`%${i}`;break;case"between":case"not_between":return i=i.map((e=>`'${e}'`)).join(" and "),`${e.field.api_name} ${r} ${i}`;case"contains":case"not_contains":i=`%${i}%`}else{if("value"===e.type&&["equal","not_equal"].includes(e.comparator)&&["${EMPTY}","${NOTEMPTY}"].includes(i)){let t={equal:"is",not_equal:"is not"},a={"${EMPTY}":"null","${NOTEMPTY}":"not null"};return`${e.field.api_name} ${t[e.comparator]} ${a[i]}`}if(Array.isArray(i)){var s=JSON.stringify(i).replace("[","(").replace("]",")"),n={"=":"in","!=":"not in"};return`${e.field.api_name} ${n[r]} ${s}`}}return`${e.field.api_name} ${r} '${i}'`}(t))}(e.criteria);let r=/\d+/g;s=function(e){const a=this;if(e&&Object.keys(e).length>0){try{e=JSON.parse(JSON.stringify(e.criteria?e.criteria:e))}catch(t){e=e.criteria?e.criteria:e}class r{constructor(e,t){e.group_operator&&function(e,t){return!(e.group[0].field&&e.group[1].field&&e.group[0].field.api_name.match(/Tag/)&&"Activity_Type"===e.group[1].field.api_name||e.group[0]&&e.group[0].api_name&&function(e,t,a){let r=e.length;for(let i=0;i<r;i++)if(e[i][t]===a)return i;return-1}(t.cxPropPrefixArray,"apiValue",e.group[0].api_name)>=0)}(e,a)?(this.left=new r(e.group[0],t),this.right=new r(e.group[1],t),this.value=e.group_operator.trim().toLowerCase()):(t.push(e),this.value=t.length,this.left=null,this.right=null),this.criteria=t}}return function(e){for(var t="",a=(e=e.replace(/\s/g,"")).length,r=0;r<a;r++){var i=e.charAt(r);"("===i||"d"===i||"r"===i||"D"===i||"R"===i?t=t+i+" ":")"===i||"a"===i||"o"===i||"O"===i||"A"===i?t=t+" "+i:t+=i}return t}(t(new r(e,[]),""))}}(e.criteria).replace(r,(e=>{const t=Number(e)-1;return a[t]}))}else s="id is not null";if(r.push(s),e.group_by&&e.group_by.length>0&&Lyte.arrayUtils(r,"push",`GROUP BY ${e.group_by.join(", ")}`),e.order_by)if("object"==typeof e.order_by){let t=Object.keys(e.order_by)[0];r.push("ORDER BY",`"${t}"`,e.order_by[t])}else Lyte.arrayUtils(r,"push",`ORDER BY "${e.order_by}"`);if(e.offset){const t=e.offset;var o=e.limit;if(!o){(n=t)>9800?(l=1e4-n)<=0&&(l=200):l=200,o=l}Lyte.arrayUtils(r,"push",`LIMIT ${t} , ${o}`)}else e.limit&&Lyte.arrayUtils(r,"push",`LIMIT ${e.limit}`);return r.join(" ")},invokeDataHub:async function(e,t){let a=e.includes("-")?"uuid":"api_name",r=store.peekAll("datahub").filterBy({[a]:e})[0];if(void 0!==r&&!0===r.active){let e=JSON.parse(JSON.stringify(r));switch(r.type){case"rest_api":const t=(await store.findRecord("datahub_source",r.source.id))[0];e.domain=t.details.url,e.details.params=r.details.params?this.create_obj_from_arr(r.details.params):{},e.details.headers=r.details.headers?this.create_obj_from_arr(r.details.headers):{},t.details.default_headers&&(e.details.default_headers=this.create_obj_from_arr(t.details.default_headers)),t.details.default_params&&(e.details.default_params=this.create_obj_from_arr(t.details.default_params)),t.details.connection&&(e.connection=t.details.connection);break;case"module":if(!(await this.checkValidQuery(r.id)).validQuery)return Promise.reject({err_msg:"INACCESSIBLE_QUERY"})}return await this.executeDatahub(e,t,!1,!0)}if(r){var i={uuid:r.uuid,d_name:r.name,type:r.type,status:"Failure"};return _cscript._dhEngine._execution_logs||(_cscript._dhEngine._execution_logs=[]),Lyte.arrayUtils(_cscript._dhEngine._execution_logs,"unshift",i),"INACTIVE QUERY"}return"INVALID QUERY"},executeDatahub:async function(e,t,a=!0,r,i=!1){"coql"===(e=JSON.parse(JSON.stringify(e))).type&&(e.details.query=e.details.query.replace(/\n/g," ").replaceAll('\\"','"')),_cscript._dhEngine._is_preview=a,e.standalone&&(delete e.standalone,_cscript._dhEngine._dh_record=e);var s={},n={};let l=e.details.headers&&Object.keys(e.details.headers).length>0,o=e.details.params&&Object.keys(e.details.params).length>0;try{if("rest_api"===e.type){if((!a||i)&&t){let a=JSON.parse(JSON.stringify(t));Object.keys(a).forEach((e=>{a["{{"+e+"}}"]=a[e],delete a[e]})),e.details.url_path&&(e.details.url_path=this.replaceDynamicValuesInString(e.details.url_path,t)),o&&(e.details.params=this.replace_dp_obj(e.details.params,a)),l&&(e.details.headers=this.replace_dp_obj(e.details.headers,a))}e.details.default_headers&&(e.details.headers=l?{...e.details.headers,...e.details.default_headers}:e.details.default_headers),e.details.default_params&&(e.details.params=o?{...e.details.params,...e.details.default_params}:e.details.default_params);let r=e.domain;e.details.url_path&&(r+=e.details.url_path);let s=e.details.method,u=e.details.params||[],c=e.details.headers||[],d=e.connection;d?n={query_param:this.objectToQueryString({url:r,method:s,parameters:u&&JSON.stringify(u),headers:c&&JSON.stringify(c)}),connection:d.name,type:"rest_api"}:(n={url:r,method:s,params:u,headers:c,type:"rest_api"},e.details.proxy_server&&(n.proxy_server=!0))}else if("coql"===e.type||"module"===e.type||"graphql"===e.type){var u;let a=e.details;switch(e.type){case"coql":u=this.replaceDynamicValuesInString(a.query,t);break;case"module":switch(a.filter_by){case"record_id":e.details.record_id=this.replaceDynamicValuesInString(a.record_id,t);break;case"criteria":this.replaceDynamicParamInCriteria(e.details.criteria,t)}u=this.construct_query_from_record(e.details)}n={body:u,type:"graphql"===e.type?"graphql":"coql",is_single:!!e.details.record_id}}var c=d();function d(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}a?(n.uuid=c,e.uuid=c):n.uuid=e.uuid;let m=d();var p=await CScript.Engine.DH.ExecuteDatahub(n,m);if(p.response&&Object.keys(p.response).length>0&&e.details.record_id&&(p.response=p.response[0]),s=p,e.serializer&&(e.serializer.source_code||e.serializer.source_code_url)){const t=e.serializer.source_code||e.serializer.source_code_url;let i=s&&JSON.parse(JSON.stringify(s));i=await CScript.Engine.DH.ExecuteScript(t,a?c:e.uuid,i,m),s.serialized_data=i,r&&(s.response=s.serialized_data,delete s.serialized_data)}return s.result=s.response,delete s.response,s}catch(e){throw e}},objectToQueryString:function(e,t=""){return Object.keys(e).map((function(a){return`${encodeURIComponent(t?`${t}.${a}`:a)}=${encodeURIComponent(e[a])}`})).join("&")},opendhpop:function(e,t,a){Lyte.injectResources([...networkUtils.returnDependencyFiles(["lyte-tree.js","lyte-editor.js","lytecombobox.js","crm-help-link.js","crux-criteria-conditions.js","crux-criteria-component.js","crux-form-component.js","crux-parent-form-component.js","datahub-setup/crm-datahub-form.js"],ResourceConstants.CRMClient),...networkUtils.returnDependencyFiles(["crm-datahub-setup.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT),...networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("data-hub")],ResourceConstants.CRM)],void 0,function(){"source"===e&&store.clearCachedQuery("dummy","dh_conn");let r="query"===e?$L("crm-datahub-query"):$L("crm-datahub-source");if(r[0]){let i;"query"!==e&&"source"!==e||(i={landing_page:!1,create_query:"query"===e,create_source:"source"===e,datahub_list_page:!1,is_from_util:!0,promise:t,input_details:a},"query"===e?i.is_dh_query_creat_modal_show=!0:i.is_dh_source_creat_modal_show=!0),r[0].setData(i),e&&!r.hasClass("dN")||(r.toggleClass("dN"),$L(".dh_datahubWmsIcon").toggleClass("dh_iconClr"))}else{let r={};switch(e){case"query":case"source":r.create_query="query"===e,r.create_source="source"===e,r.is_from_util=!0,r.promise=t,"query"===e?(r.is_dh_query_creat_modal_show=!0,r.input_details=a):r.is_dh_source_creat_modal_show=!0,r.is_from_util=!0}"query"===e?Lyte.Component.render("crm-datahub-query",r,"body"):Lyte.Component.render("crm-datahub-source",r,"body")}}.bind(this))},getFieldModuleList:async function(e){let t,a,r,i;"coql"===e.type?(t=e.details.query,a=t.slice(7).split(RegExp(" from ","gi")),r=a[0].split(","),i=a[1].split(RegExp(" where ","gi"))[0]):(i=e.details.module.api_name,r=e.details.fields.map((e=>e.api_name)));var s=new Set,n=[],l={};r.forEach((e=>{const t=e.split(".");1===t.length?(l[i]||(l[i]=[]),l[i].push({api_name:t[0]})):(l[t[0]]||(l[t[0]]=[]),s.add(t[0]),l[t[0]].push({api_name:t[1]}))})),n.push({api_name:i,fields:l[i]||[]});const o=await store.findAll("field",{module:i,type:"all"},!0,!1,{apiVersion:"4.0"});return o.field&&o.field.forEach((function(e){s.has(e.api_name)&&(n[0].fields.push({api_name:e.api_name,module:e.lookup.module&&e.lookup.module.api_name||("Owner"===e.api_name||"Users"===e.api_name||"ownerlookup"===e.data_type)&&"Users"}),n.push({api_name:e.lookup.module&&e.lookup.module.api_name||("Owner"===e.api_name||"Users"===e.api_name||"ownerlookup"===e.data_type)&&"Users",fields:l[e.api_name]}))})),{Module:n}},generate_advance_schema:function(e,t){var a=[];let r={};return t&&(r.parent=t),Object.keys(e.properties).forEach((t=>{var i=e.properties[t];switch(i.type){case"object":let e=this.generate_advance_schema(i,t);a.push({Name:t,format:"Map",children:e,collapsed:!0});break;case"array":"object"===i.items.type?a.push({Name:t,format:"Table"}):a.push({Name:t,format:"List"});break;default:a.push({Name:t,format:i.format&&i.format.capitalize()||("string"!==i.type?i.type.capitalize():"Text"),...r})}})),a},generate_list_with_schema:function(e,t,a,r){var i={};return t.properties&&Object.keys(t.properties).forEach((s=>{var n,l=t.properties[s],o=a?a+"."+s:s;switch(e&&(n=r?r+">"+s:s),l.type){case"object":e&&(l.node=n),l.path=o;let t=this.generate_list_with_schema(e,l,o,n);i={...t,...i},delete l.properties,i[o]=l;break;case"array":if(e&&(l.node=n),l.path=o,l.items&&"object"===l.items.type){let t=this.generate_list_with_schema(e,l.items,o+"[]",n+"[]");i={...t,...i}}delete l.items,i[o]=l;break;default:e&&(l.node=n),l.path=o,i[o]=l}})),i},validate_info:function(e,t,a){t.forEach(((t,r)=>{var i=!0;(t.name.trim().length>0&&this.dynamicRegexValidUtil(t.name.trim())&&t.value.trim().length>0&&this.dynamicRegexValidUtil(t.value.trim())||0===t.name.trim().length&&0===t.value.trim().length)&&(i=!1),i?(t.name&&""!==t.name.trim()?this.dynamicRegexValidUtil(t.name.trim())?Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_key_error:!1,is_key_dp_error:!1}):(Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_key_dp_error:!0}),e.getData("prevent_save")||e.setData("prevent_save",!0)):(Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_key_error:!0}),e.getData("prevent_save")||e.setData("prevent_save",!0)),t.value&&""!==t.value.trim()?this.dynamicRegexValidUtil(t.value.trim())?Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_value_error:!1,is_value_dp_error:!1}):(Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_value_dp_error:!0}),e.getData("prevent_save")||e.setData("prevent_save",!0)):(Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_value_error:!0}),e.getData("prevent_save")||e.setData("prevent_save",!0))):(Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_key_error:!1,is_key_dp_error:!1}),Lyte.arrayUtils(e.getData(a),"replaceAt",r,{...e.getData(a)[r],is_value_error:!1,is_value_dp_error:!1}))}))},filter_info:function(e){return(e=e.filter((e=>{const{name:t,value:a}=e;return""!==t.trim()&&""!==a.trim()}))).length>0&&(e=e.map((e=>({name:e.name.trim(),value:e.value.trim()})))),e},replace_dp_obj:function(e,t){const a=Object.keys(t),r=e=>(a.forEach((a=>{e=e.replaceAll(a,t[a])})),e),i={};return Object.entries(e).forEach((([e,t])=>{i[r(e)]=r(t)})),i},create_obj_from_arr:function(e){return e.reduce(((e,t)=>(e[t.name]=t.value,e)),{})},check_existing_name:function(e,t,a,r){var i=!1;e=e.toLowerCase();var s=store.peekAll(t);if(a){const n=store.peekRecord(t,a);if(n){i=-1!==s.filter((e=>e[r]!==n[r])).map((e=>e[r].toLowerCase())).indexOf(e)}}else for(const t of s)if(t[r].toLowerCase()===e){i=!0;break}return i},checkStandardDHName:function(e){return/^[a-zA-Z0-9_ -]+$/.test(e)},construct_query_from_record:function(e){let t={module:e.module.api_name};if(t.filter_by=e.filter_by,t.fields=e.fields.map((e=>e.api_name)),"record_id"===e.filter_by)t.record_id=e.record_id;else if(e.criteria){let a=Lyte.deepCopyObject(e.criteria);this.criteriaSpecialCaseConversion(a),t.criteria=a}if(e.order_by){var a=e.order_by[0];Lyte.objectUtils(t,"add","order_by",objectUtils.addKeyToGivenObj({},a.field.api_name,a.sort_order))}return this.moduleToQuery(t)},criteriaSpecialCaseConversion:function(e){if(e.hasOwnProperty("group"))for(var t=e.group.length,a=0;a<t;++a)this.criteriaSpecialCaseConversion(e.group[a]);else if(e.hasOwnProperty("field")){var r=e.value;"Tag"===e.field.api_name?Array.isArray(r)?e.value=r.map((e=>e.name)):r.name&&(e.value=[r.name]):"Wizard"===e.field.api_name||"Layout"===e.field.api_name?Array.isArray(r)?e.value=r.map((e=>e.id)):r.id&&(e.value=[r.id]):"picklist"!==e.field.data_type||Array.isArray(r)||["${EMPTY}","${NOTEMPTY}"].includes(r)||(e.value=[r])}},save_record:async function(e,t,a,r,i){try{var s;switch(commonUtils.showHideLoadingDiv(!0),t){case"POST":s=store.createRecord("datahub",e);break;case"PUT":s=store.peekRecord("datahub",e.id),a&&!a.fromSchemaChange&&(s.serializer&&0===a.source_code.length&&(e.serializer=null),"rest_api"===e.type&&(s.details.headers&&a.headers&&0===a.headers.length&&(e.details.headers=null),s.details.params&&a.params&&0===a.params.length&&(e.details.params=null),s.details.url_path&&0===a.url_path.length&&(e.details.url_path=null))),s.$.set(e)}if(await s.$.save(),this.append_list_details("datahub",s,t),"POST"===t&&(s.active=!0),!a.hasOwnProperty("fromSchemaChange")&&"rest_api"===s.type){const e=store.peekRecord("datahub_source",s.source.id);Lyte.objectUtils(s.source,"add",{name:e.name,uuid:e.uuid})}return s.details=e.details,commonUtils.showHideLoadingDiv(!1),r&&i&&(i[r]=s.id),{status:"success",record:s}}catch(e){commonUtils.showHideLoadingDiv(!1),s.$.rollBack();let t=I18n.getMsg("crm.datahub.error.savequery"),a=!1;if(e.response){try{let r=JSON.parse(e.response);if(r&&r.datahubs&&r.datahubs[0]&&r.datahubs[0].code)switch(r.datahubs[0].code){case"NO_PERMISSION":t=I18n.getMsg("crm.label.cf.error.authorization");break;case"INVALID_DATA":"Invalid module api name."===r.datahubs[0].message&&"$.datahubs[0].details.module.api_name"===r.datahubs[0].details.json_path&&(t=I18n.getMsg("crm.datahub.error.module.notAvailable")),"Invalid Datahub Source id  request body"===r.datahubs[0].message&&"$.datahubs[0].source.id"===r.datahubs[0].details.json_path&&(t=I18n.getMsg("crm.datahub.error.sourceNotAvailable"));break;case"LIMIT_EXCEEDED":t=I18n.getMsg("crm.massmail.limit.title"),a=!0}}catch{t=I18n.getMsg("crm.datahub.error.savequery")}return _cruxUtils.showCustomMessage({params:{ltPropMessage:t,ltPropType:"error",ltPropDuration:2e3}}),{status:"failure",reloadNeeded:a}}return _cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.datahub.error.savequery"),ltPropType:"error",ltPropDuration:2e3}}),{status:"failure"}}},resolve_promise:function(e,t,a,r){if("query"===t||"source"===t){const i=e.getData("promise");i&&(i[a?"resolve":"reject"](r),e.setData({promise:void 0}),"query"===t?(e.flush_all(),$L("crm-datahub-query")[0].remove()):(e.flush(),$L("crm-datahub-source")[0].remove()),removeTempFreezeLayer())}},reset_info_error:function(e,t,a,r){var i=r.getData(e);i[a][t]&&Lyte.objectUtils(i[a],"add",t,!1),"is_value_error"===t&&i[a].is_value_dp_error&&Lyte.objectUtils(i[a],"add","is_value_dp_error",!1),"is_key_error"===t&&i[a].is_key_dp_error&&Lyte.objectUtils(i[a],"add","is_key_dp_error",!1)},append_list_details:function(e,t,a){let r={},i=store.peekAll("user");i=i.filter((e=>e.zuid===crmZuid))[0],r.name=i.full_name,r.id=i.id,t.modified_by=r,t.modified_time=$L.moment().i18N(),"POST"===a&&(t.created_by=r,t.created_time=$L.moment().i18N()),store.peekAll(e).sort(((e,t)=>$L.moment(t.created_time).toDate().getTime()-$L.moment(e.created_time).toDate().getTime()))},dynamicRegexValidUtil:function(e){const t=e.match(/\{\{(.*?)\}\}/g),a=t?t.map((e=>e.slice(2,-2))):[];if(a.length>0){const e=/^[A-Za-z_\.\[\]\$][A-Za-z0-9_\.\[\]\$]*$/;return!a.some((t=>t.length>40||!e.test(t)))}return!0},checkValidQuery:async function(e,t,a){const r=store.peekRecord("datahub",e);var i;switch(r.type){case"module":i=r.details.module.api_name;var s,n,l=!0,o=(e,t)=>{let a=["Leads","Contacts","Accounts","Deals","Tasks","Calls","Events","Products","Quotes","Sales_Orders","Purchase_Orders","Invoices","Campaigns","Vendors","Price_Books","Cases","Solutions","users","Services__s","Appointments__s","Notes","Attachments","Visits"],r=t.module.filter((t=>t.api_name===e))[0];return r?!((["custom","linking"].includes(r.generated_type)||a.includes(r.api_name))&&1===r.visibility&&"visible"===r.status&&r.viewable||["subform"].includes(r.generated_type)&&2===r.visibility)&&{code:"Disabled",moduleName:r.plural_label}:{code:"Unavailable"}},u=t&&t.hasOwnProperty("module")?t:Lyte.deepCopyObject(await store.findAll("module",null,!1,!1,{apiVersion:"6"}));const e=o(i,u);if(e&&!0===e.hasOwnProperty("code"))switch(l=!1,e.code){case"Disabled":n=I18n.getMsg("crm.datahub.error.module.accessQuery",e.moduleName);break;case"Unavailable":n=I18n.getMsg("crm.label.invalid.module")}else if(s=a&&!0===a.hasOwnProperty(i)?a[i]:(await store.findAll("field",{module:i,type:"all"},!1,!1,{apiVersion:"4.0"})).field,r.details.lookup_fields){let e=s.filter((e=>"ownerlookup"===e.data_type)).map((e=>e.api_name));var c=s.filter((e=>e.lookup.module&&e.lookup.module.api_name||"ownerlookup"===e.data_type)).map((e=>e.api_name));let t=s.filter((e=>e.lookup&&e.lookup.module&&e.lookup.module.api_name)).reduce(((e,t)=>(e[t.api_name]=t.lookup.module.api_name,e)),{});r.details.lookup_fields.filter((t=>!e.includes(t.api_name))).forEach((e=>{if(c.includes(e.api_name)){const a=o(t[e.api_name],u);a&&!0===a.hasOwnProperty("code")&&(l=!1)}else l=l&&!1})),l||(n=I18n.getMsg("crm.datahub.error.relatedModule.accessQuery"))}return l?{validQuery:!0,fieldsRecords:{[i]:s},moduleRecords:u}:{validQuery:!1,errMessage:n,moduleRecords:u,fieldsRecords:s};case"rest_api":if(!featuresAvailable.QUERY_SOURCES)return{validQuery:!1}}return{validQuery:!0}},updateLandingPageVal:function(e){let t=Crm.userDetails.CUSTOMIZE_INFO.datahub&&Crm.userDetails.CUSTOMIZE_INFO.datahub&&JSON.parse(Crm.userDetails.CUSTOMIZE_INFO.datahub),a=t&&t.query_wlc_disbld,r=t=t&&t.source_wlc_disbld;switch(e){case"query":!a&&updateCustomization("datahub",JSON.stringify({source_wlc_disbld:r,query_wlc_disbld:!0}));break;case"source":!r&&updateCustomization("datahub",JSON.stringify({source_wlc_disbld:!0,query_wlc_disbld:a}))}},retrieveDynamicParamInCriteria:async function(e,t=[]){if(e.hasOwnProperty("group")){var a=e.group.length;for(let r=0;r<a;++r)t=await this.retrieveDynamicParamInCriteria(e.group[r],t)}else if(e.hasOwnProperty("field")&&"dynamic_component"===e.type&&e.value){let a=await this.retrieveDynamicParams(e.value,!0);t=[...new Set([...t,...a])]}return t},replaceDynamicParamInCriteria:function(e,t){if(t&&"object"==typeof t&&Object.keys(t).length>0)if(e.hasOwnProperty("group")){var a=e.group.length;for(let r=0;r<a;++r)this.replaceDynamicParamInCriteria(e.group[r],t)}else if(e.hasOwnProperty("field")){let a=e.value;if("dynamic_component"===e.type){let r=Lyte.deepCopyObject(t),i=Object.keys(r);i.forEach((e=>{r["{{"+e+"}}"]=r[e],delete r[e]})),i=Object.keys(r),i.forEach((e=>{a=null!==r[e]?a.replaceAll(e,r[e]):e.length===a.length?null:a.replaceAll(e,r[e])})),e.value=a}}},replaceDynamicValuesInString:function(e,t){if(t&&"object"==typeof t&&Object.keys(t).length>0){let r=Lyte.deepCopyObject(t);var a=Object.keys(r);return a.forEach((e=>{r["{{"+e+"}}"]=r[e],delete r[e]})),(a=Object.keys(r)).forEach((a=>{e=null!==r[a]?e.replaceAll(a,r[a]):a.length===e.length?null:e.replaceAll(a,t[a])})),e}return e},replace_schema:function(e,t){return(e=Lyte.deepCopyObject(e)).forEach((e=>{let a=e.node&&this.get_path(e.node);if(a&&"result"!==a){let r=this.getValueAtPath(t,a);r.label=e.label.trim(),r.type=e.type,r.format=e.format}else"result"===a&&(t.label=e.label,t.type=e.type,t.format=e.format)})),t},getValueAtPath:function(e,t){return t.split(">").reduce(((e,t)=>e?e[t]:void 0),e)},get_path:function(e){let t=e.split(">");return"[]"===t[0]||"result[]"===t[0]?t[0]="items":"result"===t[0]&&t.length>1&&(t=t.splice(1),t[0]="properties>"+t[0]),e=(e=t.join(">properties>")).replaceAll("[]",">items")}});
