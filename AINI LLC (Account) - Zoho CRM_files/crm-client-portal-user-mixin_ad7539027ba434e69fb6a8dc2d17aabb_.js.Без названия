Lyte.Mixin.register("crm-client-portal-user-util",{renderChangeUserTypePopup:function(e,t,s,r,a,o,n){var i=this;store.findAll("user_type",{include_inner_details:"invitation_field.ui_type,invitation_field.display_label"}).then((function(l){for(var c,u=l.length,d=[],p=store.peekRecord("user_type",a),g=0;g<u;g++){var m=l[g];if(m.personality_module.api_name===moduleApiMapping[e]){var h={};h.id=m.id,h.name=m.name,h.invitation_field=m.invitation_field,m.id!==a?d.push(h):c=m.name}}if(d.length>0){var v={};v.listenerId=n,v.allowed_records=d.filter((e=>e.invitation_field.id===p.invitation_field.id)),v.selected_name=c,v.title="transfer"===s?"custmr.prtl.change.user.type.content.one":"custmr.prtl.bulk.change.user.type.message",v.allowed_records.length>0?(v.isFromUserPage="transfer"!==s,v.current_user_type_id=a,v.selectedFilter=o,v.sourceFilter=!1!==i.data&&void 0!==i.data?i.getData("sourceFilter"):void 0,v.clientIds="transfer"===s?t:r,v.notes=I18n.getMsg("custmr.prtl.change.user.type.note")):(v.headerNotes=I18n.getMsg("custmr.prtl.no.user.type.fnd.sme.invfld"),v.notes=I18n.getMsg("crm.label.note3")+": "+I18n.getMsg("custmr.prtl.change.user.type.invfld.msmtch")),Lyte.Component.render("crm-client-portal-change-user-type",v,"body"),$L("#changeUserTypePop").e.ltProp("show",!0)}else i.showErrorMsg({message:"custmr.prtl.cannot.change.user.type"})}))},renderRemoveUserPopup:function(e,t,s,r,a){var o={};o.listenerId=a,o.clientIds=e,o.userTypeId=t,o.from=s,o.removeUserPopUp=!0,o.selectedFilter=r,o.message="detailView"===s?I18n.getMsg("custmr.prtl.remove.users.confirmation.msg.detailview"):I18n.getMsg("custmr.prtl.delete.users"),o.removeButtonText="detailView"===s?I18n.getMsg("custmr.prtl.yes.proceed"):I18n.getMsg("custmr.prtl.remove.users");var n=$L("crm-client-portal-remove-user-modal")[0];n?n.setData(o):Lyte.Component.render("crm-client-portal-remove-user-modal",o,"body")},showErrorMsg:function(e,t,s,r){_cruxUtils.removeCustomMessage();var a="error",o=5e3;switch(null!=e.message?e.message:e.user_type[0].message){case"Reinvite of portal user whose personality record in recyclebin is not allowed.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.label.reinvite.error.record.in.recyclebin"),o);break;case"Invitation sent has failed as you can invite only clients/customers for this user_type.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.domain.check.msg"),o);break;case"Invitation sent has failed as provided personality record does not have email id.":crmui.showMsgBand(a,I18n.getMsg("invite.failed.email.absent"),o);break;case"Invitation sent has failed as a portal user exists with same invitation value":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("invite.failed.duplicate.email"),ltPropType:"error",ltPropDuration:o}});break;case"You cannot send the portal invitation since the email address has the following characters":var n=e.details.inValidChars;crmui.showMsgBand(a,I18n.getMsg("portal_invite_email_is_not_supported")+" "+n,o);break;case"Entity does not exist.":crmui.showMsgBand(a,I18n.getMsg("invite.entity.doesnot.exist"),o);break;case"License Limit has been exceeded.":case"Transfer of user failed as license limit has been exceeded.":Crm.userDetails.PORTALS_LICENSE_UNIFICATION_ENABLED?this.showPortalUsersPurchaseWidget():crmui.showMsgBand(a,I18n.getMsg("license.exceeded.cannot.perform.action"),o);break;case"custmr.prtl.cannot.send.invite":case"custmr.prtl.no.portal.type.active":case"custmr.prtl.cannot.change.user.type":crmui.showMsgBand(a,I18n.getMsg(e.message),o);break;case"Entity has not approved to invite yet.":crmui.showMsgBand(a,I18n.getMsg("invite.entity.not.approved"),o);break;case"Entity under gdpr process.":crmui.showMsgBand(a,I18n.getMsg("invite.entity.under.gdpr"),o);break;case"Invalid user type.":crmui.showMsgBand("error",I18n.getMsg("portal.user.type.unavailability"),5e3);break;case"You don't have permission to view this module.":crmui.showMsgBand(a,I18n.getMsg("invite.module.permission.doesnot.exists"),o);break;case"no permission to perform an action on this record":crmui.showMsgBand(a,I18n.getMsg("invite.no.entity.permission"),o);break;case"License limit exceeded.":case"Enable portal users addon to perform this action.":crmui.showMsgBand(a,I18n.getMsg("create.usertype.license.limit.exceeded"),o);break;case"No active personality modules exists.":crmui.showMsgBand(a,I18n.getMsg("create.usertype.no.active.personality.module"),o);break;case"Invalid personality module.":crmui.showMsgBand(a,I18n.getMsg("create.usertype.invalid.personality.module"),o);break;case"Invalid layout.":crmui.showMsgBand(a,I18n.getMsg("create.usertype.invalid.layout"),o);break;case"Invalid module.":crmui.showMsgBand(a,I18n.getMsg("portals.invalid.module"),o);break;case"Invalid view":crmui.showMsgBand(a,I18n.getMsg("create.usertype.invalid.view"),o);break;case"Invalid filter":crmui.showMsgBand(a,I18n.getMsg("create.usertype.invalid.filterby"),o);break;case"User type with same name already exists.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.usr.typ.name.alrdy.exist",e.params),o);break;case"The entered portal name is already in use":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.already.exists",e.portalName),o);break;case"Transfer of user failed as you can transfer only clients/customers for default user type.":"custmr.prtl.bulk.change.user.type.message"===e.type?crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.mass.transfer.error.msg"),o):crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.change.user.type.domain.check.failure"),o);break;case"Views object is missing.":case"You cannot remove all the layouts,atleast one layout should be selected.":case"Mandatory layouts are missing.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.views.selection.error"),o);break;case"custmr.prtl.usertype.cannot.be.enabled":crmui.showMsgBand("error",I18n.getMsg("custmr.prtl.usertype.cannot.be.enabled",e.keys),5e3);break;case"Please activate personality module and try again.":crmui.showMsgBand(a,I18n.getMsg("create.usertype.invalid.personality.error",e.personality_module),o);break;case"Please check whether the input values are correct":"PATTERN_NOT_MATCHED"===e.code?crmui.showMsgBand(a,I18n.getMsg("user.type.naming.convention"),o):crmui.showMsgBand(a,I18n.getMsg("please.contact.support"),o);break;case"Activation of portal user whose personality record in recyclebin is not allowed.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.label.activation.error.record.in.recyclebin"),o);break;case"Email address cannot contain the + character":crmui.showMsgBand(a,I18n.getMsg("custm.prtl.plus.email"),o);break;case"Email domain is anonymous.":crmui.showMsgBand(a,I18n.getMsg("custm.prtl.spam.email"),o);break;case"invalid data":if("name"===e.details.api_name){crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.usr.typ.naming.cond.length"),o);break}case"NO_PERMISSION":renderingUtils.displayPermissionDenied(void 0,void 0,void 0,100001);break;case"mandatory fields cannot be removed.":var i=this.getfieldname(clientPortal.currentChanges,e);crmui.showMsgBand(a,I18n.getMsg("custm.prtl.field.mandatory.in.other.layout",i),o);break;case"custmr.prtl.usertype.activation.trial.limit":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.usertype.activation.trial.limit"),o);break;case"Mandatory fields in portals cannot be read only.":i=this.getfieldname(clientPortal.currentChanges,e);crmui.showMsgBand(a,I18n.getMsg("custmr.portal.field.read.only.disabled",i),o);break;case"Invitation mail cannot be sent for disabled portal":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.usr.type.disabled"),o);break;case"custmr.prtl.email.field.permission.denied":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.email.field.permission.denied"),o);break;case"Invalid type for the portal invite":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.bulk.invite.invalid.type"),o);break;case"You can invite maximum of 200 users at a time.":crmui.showMsgBand(a,I18n.getMsg("bulk.invite.max.users.error.message"),o);break;case"Transfer of user failed as personality id does not belongs to any portal user or belongs to portal user, who does not belongs to provided user type.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.change.user.type.already.done",Crm.serviceName),o);break;case"Delete of user failed as personality id does not belongs to any portal user or belongs to portal user, who does not belongs to provided user type.":crmui.showMsgBand(a,I18n.getMsg("client.portal.remove.users.error",Crm.serviceName),o);break;case"portal.cannot.remove.default.custom.view":crmui.showMsgBand(a,I18n.getMsg("portal.cannot.remove.default.custom.view"),o);break;case"Only 5 lookups are allowed in secondary conditions":crmui.showMsgBand(a,I18n.getMsg("portal.only.five.lookups.are.allowed",5),o);break;case"Transfer of user failed since user types primary invitation fields mismatched":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.change.user.type.invfld.msmtch"),ltPropType:a,ltPropDuration:6e3}});break;case"Already in active state only.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.chngsts.alrd.actv"),o);break;case"Already in deactive state only.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.chngsts.alrd.deactv"),o);break;case"No user associated with the provided personality id.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.chngsts.usr.deltd"),o);break;case"Activation/Deactivation of portal user whose personality record in recyclebin is not allowed.":case"The personality is not invited yet.":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.bulk.invite.recycle.bin"),o);break;case"Activation rollbacked since email updation failed":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.chngsts.email.updt.fld"),o);break;case"You cannot activate this user since it is waiting for user's confirmation due to email update":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.chngsts.rstrct.confirm.email"),o);break;case"Provided mobile number was invalid":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.invalid.phn.no"),ltPropType:"error"}});break;case"User Type can't be activated since portal sms is not enabled":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.sms.tmplt.not.apvd"),ltPropType:"error",ltPropDuration:o}});break;case"Provided mobile number was invalid":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.invalid.phn.no"),ltPropType:"error"}});break;case"User Type can't be activated since portal sms is not enabled":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.sms.tmplt.not.apvd"),ltPropType:"error",ltPropDuration:o}});break;case"Sorry, you cannot perform this operation as the record is locked.":_cruxUtils.showCustomMessage({id:"portalLock",params:{ltPropType:"error",ltPropOffset:{top:"56"},ltPropMessage:I18n.getMsg("crm.record.lock.portal",[t]),ltPropDuration:o}});break;case"The given default view ID has been invalid":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("client.portal.default.view.deleted"),ltPropType:"error",ltPropDuration:o}});break;case"The given default view ID has been deactivated":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("client.portal.default.view.deactivated"),ltPropType:"error",ltPropDuration:o}});break;case"Permission to portal has been denied for the given default ID":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("client.portal.default.view.permission.denied"),ltPropType:"error",ltPropDuration:o}});break;case"You cannot activate this user since it is waiting for user's confirmation due to phone number update":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.chngsts.rstrct.confirm.phone"),ltPropType:"error",ltPropDuration:o}});break;case"Invalid phone number kindly check country code or extension should not be present":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.inv.rstrct.phone.invld"),ltPropType:"error",ltPropDuration:o}});break;case"phone field cannot be empty for portal user":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.inv.field.emt",store.peekRecord("user_type",s).invitation_field.display_label),ltPropType:"error",ltPropDuration:o}});break;case"invalid invitation_field id":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.invi.field.invalid"),ltPropType:"error",ltPropDuration:o}});break;case"custmr.prtl.inv.field.permission.denied":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.inv.field.permission.denied",e.field_label),ltPropType:"error",ltPropDuration:o}});break;case"You can't change the invitation field once the user has been added to this user type":_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.inv.fld.chng.usr.exist"),ltPropType:"error",ltPropDuration:o}});break;case"required modules not present":var l=store.peekRecord("user_type",Lyte.Router.getRouteInstance().getDynamicParam());this.checkAndValidateMandatoryModulesForTabConfig(l,e);break;case"Field not supported in criteria":var c=e.user_type[0].details.json_path,u=this.getValueByJsonPath(r,c.slice(2,c.lastIndexOf("."))),d=this.getValueByJsonPath(r,c.slice(2,[...c.matchAll(new RegExp("\\.","gi"))].map((e=>e.index))[2]));_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("portal.field.not.allowed.in.criteria",[u?u.field_label:"",d?store.peekRecord("module",d.id).plural_label:""]),ltPropType:"error",ltPropDuration:o}});break;case"Invalid field":c=e.user_type[0].details.json_path,u=this.getValueByJsonPath(r,c.slice(2,c.lastIndexOf("."))),d=this.getValueByJsonPath(r,c.slice(2,[...c.matchAll(new RegExp("\\.","gi"))].map((e=>e.index))[2]));_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("portal.invalid.field.in.criteria",[u?u.field_label:"",d?store.peekRecord("module",d.id).plural_label:""]),ltPropType:"error",ltPropDuration:o}});break;case"custmr.prtl.invite.module.permission.missing":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.invite.module.permission.missing"),o);break;case"SAML configured for portal so phone field was not allowed for user types":crmui.showMsgBand(a,I18n.getMsg("custmr.prtl.phone.saml.error.msg"),o);break;case"You are allowed to send invite via SMS only when notification SMS feature is enabled.":crmui.showMsgBand(a,I18n.getMsg("client.portal.cus.sms.template.chnl.not.created.invite.users"),o);break;default:crmui.showMsgBand(a,I18n.getMsg("please.contact.support"),o)}},showPortalUsersPurchaseWidget:function(){var e=this;showAnimatePopup("zsAddNewUserPop"),e.zs_store=window.zs_store,zs_widget.init({serviceId:2,customId:Crm.userDetails.ZGID,secretKey:csrfParamName,secretVal:$ESAPI.encoder().encodeForURL(csrfToken),itemList:[{code:"CUSTOMERPORTAL",action:"upgrade",type:"addon"}],settings:{upgradeTitle:I18n.getMsg("custmr.prtl.label.add.portal.users"),upgradeInfo:Crm.userDetails.PORTALS_LICENSE_UNIFICATION_ENABLED?I18n.getMsg("custmr.prtl.user.add.user.msg"):I18n.getMsg("custmr.prtl.add.user.msg"),successTitle:I18n.getMsg("crm.license.success")}}),window.zs_store={onSuccess:function(){$L(".zs_widget").hide(),Utils.windowLocationReload(),window.zs_store=e.zs_store},onCancel:function(){$L(".zs_widget").hide(),hideAnimatePopup("zsAddNewUserPop"),Crm.userDetails.IS_PAID_FOR_CLIENT_PORTAL=!1,window.zs_store=e.zs_store}}},checkAndValidateMandatoryModulesForTabConfig(e,t){for(var s=[],r=["Quotes","Sales_Orders","Purchase_Orders","Invoices"],a=t.user_type[0].details.value,o=e.modules,n=o.length,i=0;i<n;i++){var l=o[i];if(r.includes(l.api_name)&&(l.permissions.create||l.permissions.edit_shared_records)&&"Products"===a)(c={}).source=moduleRecordMapping.Products.plural_label,c.dependent=l.plural_label,s.push(c);else if("Appointments__s"===l.api_name&&"Services__s"===a){var c;(c={}).source=moduleRecordMapping.Services.plural_label,c.dependent=l.plural_label,s.push(c)}}return s.length>0&&(this.showMandatoryModuleErrorPopup(s),!0)},getfieldname(e,t){for(var s=t.user_type[0].details.json_path.replace("$.user_type[0].modules[0].",""),r="",a=e.modules[0].fields.length,o=0;o<a;o++){"fields["+o+"].id"===s&&(r=e.modules[0].fields[o].id)}var n="";return this.data.layout_record.sections.forEach((function(e){e.fields.forEach((function(e){e.id!==r||(n=e.field_label)}))})),n},changeUserType:function(e,t,s,r,a,o){if(t===s)return $("body").remove($L("#changeUserTypePop").e),void crmui.showMsgBand("warning",I18n.getMsg("same.user.type.error"),5e3);var n=this,i="/crm/v6/settings/portals/"+(CLIENT_PORTAL_NAME&&"dummyValue"!==CLIENT_PORTAL_NAME?CLIENT_PORTAL_NAME:Crm.userDetails.CLIENT_PORTAL_NAME)+"/user_type/"+t+"/users/action/transfer",l={params:{transfer_To:s,personality_ids:e}};networkUtils.lyteInitiateRequest(i,"POST",l).then((function(i){$L("#changeUserTypePop").e.remove();for(var l=i.users.length,c=0,u=0,d=e.split(","),p=0;p<l;p++)if("success"===i.users[p].status){var g=i.users[p].details.personality_id;c++,a&&n.removeSelectedId(d,g)}else a&&($L("#"+i.users[p].details.personality_id)[0].ltProp("checked",!1),u=p);if(c===l||c>0){var m=I18n.getMsg("transfer.users.success",[c,l]);if(Crm.userDetails.DETAIL_VIEW_HEADER_LYTE){var h=store.peekRecord("user_type",s),v={id:h.id,name:h.name};Lyte.triggerEvent("updateDetailViewHeaderPortalUserTypeDetails",v),Crm.userDetails.DETAIL_VIEW_LYTE&&Lyte.triggerEvent("detail_view_portal_usetype_id_listener_"+o,h.id)}else{var y=$("#changeUserType");if(y.attr("onClick")){var f=store.peekRecord("user_type",t).personality_module.api_name,M='CPMF.getPortalUserTypesForTransfer("'+(f=moduleDetailedInfo.modules.find((e=>e.api_name===f)).module_name)+'","'+e+'","transfer",undefined,"'+s+'")';y.attr("onClick",M)}}a?n.onFilterOptionSelected(n.getData("selectedFilter"),!0,m,c,"","userStatus"):(crmui.showMsgBand("success",m,5e3),Crm.userDetails.DETAIL_VIEW_HEADER_LYTE||($("#deactivateClient>a").attr("onclick",'CPMF.togglePortalUserStatus("'+e+'","'+s+'","deactivate")'),$("#activateClient>a").attr("onclick",'CPMF.togglePortalUserStatus("'+e+'","'+s+'","activate")'),$("#removePortalUser>a").attr("onclick",'CPMF.removePortalUser("'+s+'","'+e+'")')))}else i.users[u].type=r,a?n.onFilterOptionSelected(n.getData("selectedFilter"),!0,i.users[u],c,!0,"userStatus"):n.showErrorMsg(i.users[u]);"canvas"==Lyte.Router.getRouteInstance().routeName&&Lyte.Router.getRouteInstance().refresh();var _=store.peekAll("user").filter((function(e){return"Client Portal User"===e.type__s}));void 0!==_&&store.unloadAll("user",_)}),(function(e){n.showErrorMsg(e.responseJSON)}))},removePortalUsers:function(e,t,s,r){var a=$L("crm-client-portal-user-type-users")[0],o=$L("crm-client-portal-remove-user-modal")[0];o&&o.component.setData("removeUserPopUp",!1);var n=this;store.findAll("client_user",{ids:e},!1,!1,{user_type_id:t,fromDelete:!0}).then((function(t){var o=t.client_user;if(a&&e){var i=o.length,l=0,c=e.split(",");$L(".cpT_slidecmpTop").removeClass("cpT_animTop");for(var u=!1,d=0;d<i;d++)"success"===o[d].status?(n.removeSelectedId(c,o[d].details.personality_id),l++):"error"===o[d].status&&"Delete of user failed as personality id does not belongs to any portal user or belongs to portal user, who does not belongs to provided user type."===o[d].message&&(n.removeSelectedId(c,o[d].details.personality_id),u=!0,l++);if(l>0&&!u)n.onFilterOptionSelected(n.getData("selectedFilter"),!0,I18n.getMsg("custmr.prtl.remove.users.success"),l,"","userStatus");else{var p={message:"Delete of user failed as personality id does not belongs to any portal user or belongs to portal user, who does not belongs to provided user type."};n.onFilterOptionSelected(n.getData("selectedFilter"),!0,p,l,!0,"userStatus")}}else o.length>0&&"detailView"==s&&("success"==o[0].status?(crmui.showMsgBand("success",I18n.getMsg("custmr.prtl.remove.users.success"),5e3),Crm.userDetails.DETAIL_VIEW_HEADER_LYTE?(Lyte.triggerEvent("updateDetailViewHeaderPortalActions"),Crm.userDetails.DETAIL_VIEW_LYTE&&Lyte.triggerEvent("detail_view_portal_usetype_id_listener_"+r)):($("#portalPreference").hide(),$("#sndInviteCP").show(),delete businessCardJson.userTypeId)):"error"==o[0].status&&"Delete of user failed as personality id does not belongs to any portal user or belongs to portal user, who does not belongs to provided user type."===o[0].message?n.showErrorMsg(o[0]):crmui.showMsgBand("error",I18n.getMsg("please.contact.support"),5e3));commonUtils.showHideLoadingDiv(!1);var g=store.peekAll("user").filter((function(e){return"Client Portal User"===e.type__s}));void 0!==g&&store.unloadAll("user",g)}))},sendPortalsInvite:function(e,t,s,r,a,o){var n=this,i="/crm/v6/"+moduleApiMapping[s]+"/"+e+"/actions/portal_invite",l=r?"invite":"reinvite",c={user_type_id:t,type:l};a&&"reinvite"!==l&&(c.language=a);var u={params:c};networkUtils.lyteInitiateRequest(i,"POST",u).then((function(a){var n=$L("#sendInvitePopUp").e;if(n.ltProp("show",!1),n.remove(),"success"===a.portal_invite[0].status){if($("#sndInviteCP").hide(),null!=detailView&&null!=detailView.changedBCJson&&(detailView.changedBCJson.showInConvert=!0),Crm.userDetails.DETAIL_VIEW_HEADER_LYTE||($("#portalPreference").show(),"undefined"!=typeof businessCardJson&&businessCardJson&&(businessCardJson.userTypeId=t),$("#resndInviteCP").attr("onclick",'CPMF.getClientPortalProfilesRelatedToPersonalityModule("'+s+'","'+e+'","reinvite","'+t+'")'),$("#changeUserType").attr("onclick",'CPMF.getPortalUserTypesForTransfer("'+s+'","'+e+'","transfer",'+void 0+',"'+t+'")'),$("#deactivateClient>a").attr("onclick",'CPMF.togglePortalUserStatus("'+e+'","'+t+'","deactivate")'),$("#activateClient>a").attr("onclick",'CPMF.togglePortalUserStatus("'+e+'","'+t+'","activate")'),$("#removePortalUser>a").attr("onclick",'CPMF.removePortalUser("'+t+'","'+e+'")')),Crm.userDetails.DETAIL_VIEW_LYTE){Lyte.triggerEvent("detail_view_portal_usetype_id_listener_"+o,t);let e=$("crm-detail-view");e&&e[0]&&e[0].component.setData("record_edited",!0)}var i="/crm/v6/settings/portals/"+(CLIENT_PORTAL_NAME&&"dummyValue"!==CLIENT_PORTAL_NAME?CLIENT_PORTAL_NAME:Crm.userDetails.CLIENT_PORTAL_NAME)+"/user_type/"+t+"/users",l={params:{personality_ids:e}};networkUtils.lyteInitiateRequest(i,"GET",l).then((function(e){var t="Invite has been resent to personality"===a.portal_invite[0].message?I18n.getMsg("custmr.prtl.resend.invite.success",$ESAPI.encoder().encodeForHTML(e.users[0].name)):I18n.getMsg("custmr.prtl.snd.invite.success",$ESAPI.encoder().encodeForHTML(e.users[0].name));"canvas"==Lyte.Router.getRouteInstance().routeName?Lyte.Router.getRouteInstance().refresh():"detail"==Lyte.Router.getRouteInstance().routeName&&refreshFollowDiv(),r&&Crm.userDetails.DETAIL_VIEW_HEADER_LYTE&&Lyte.triggerEvent("updateDetailViewHeaderPortalActions"),crmui.showMsgBand("success",t,5e3)}));var c=$L("#usersCount"),u=c.attr("currentid");if(u&&u!==t)c.e.innerText-1>0?c.e.innerText=c.e.innerText-1:$L("#usersCountDiv")[0].style.display="none"}}),(function(e){var r=$L("#sendInvitePopUp").e;r.ltProp("show",!1),r.remove(),n.getData("isStoreURLLoaded")?n.showErrorMsg(e.responseJSON,moduleRecordMapping[s].plural_label,t):Lyte.injectResources([RebrandLinkUtil.getProperty("STORE_JS_STATIC_URL"),RebrandLinkUtil.getProperty("STORE_CSS_STATIC_URL")],void 0,(function(){n.showErrorMsg(e.responseJSON,moduleRecordMapping[s].plural_label,t)}))}))},changePortalUserStatus:function(e,t,s){var r=this,a=store.peekAll("portal")[0];if(a){var o="/crm/v6/settings/portals/"+a.name+"/user_type/"+t+"/users/"+e+"/actions/change_status",n={params:{active:"activate"===s}};return networkUtils.lyteInitiateRequest(o,"PUT",n)}if(!CPMF.portals)return store.findAll("portal").then((function(){return CPMF.portals=!0,r.changePortalUserStatus(e,t,s)}))},canPerformChangeUserType:function(e){var t=!1,s=this;if(Crm.userDetails.permissions.Crm_Implied_Manage_ClientPortal_Users){var r=store.peekAll("user_type");if(r){if(clientPortal.user_types=void 0,r.length>1)for(var a=r.length,o=store.peekRecord("user_type",e),n=0;n<a;n++){var i=r[n];if(i.id!==o.id&&(t=i.personality_module.api_name===o.personality_module.api_name))break}}else clientPortal.user_types||store.findAll("user_type",{include_inner_details:"invitation_field.ui_type,invitation_field.display_label"}).then((function(){return clientPortal.user_types=!0,s.canPerformChangeUserType(e)}))}return t},sendBulkInvite:function(e,t,s,r,a){for(var o={type:"POST"},n=[],i=t.split(";"),l=i.length,c=0;c<l;c++){var u={};u.id=i[c],u.user_type_id=s,u.type=r,a&&(u.language=a),n[c]=u}var d={};d.data=n;var p=[];p[0]=d;var g={};g.portal_invite=p;var m=this;store.findRecord("module",moduleRecordMapping[e].id).then((function(){store.triggerAction(moduleRecordMapping[e].id,"portal_invite",o,{},"POST",g).then((function(){var e=document.querySelector("crm-list-view-modal");if(e){var t=$L("#sendInvitePopUp").e;t&&(t.ltProp("show",!1),t.remove()),e.component.setData({show_modal:!1})}commonUtils.showHideLoadingDiv(!1),crmui.showMsgBand("success",I18n.getMsg("custmr.prtl.bulk.invite.sucess.msg"),3e3)}),(function(e){var t=JSON.parse(e.response),s=document.querySelector("crm-list-view-modal");if(s){s.component.setData({show_modal:!1});var r=$L("#sendInvitePopUp").e;r&&(r.ltProp("show",!1),r.remove())}commonUtils.showHideLoadingDiv(!1),m.showErrorMsg(t.portal_invite?t.portal_invite[0]:t)}))}))},onFilterOptionSelected:function(e,t,s,r,a,o){commonUtils.showHideLoadingDiv(!0);var n=$L("#portalUsersTable .lyteScrollBar"),i=void 0!==this.getData("sourceFilter")?this.getData("sourceFilter"):"all";void 0!==o&&"userStatus"!==!o||(e=this.getData("selectedFilter"));var l=$L("crm-client-portal-user-type-users"),c=t&&l&&l[0]?l[0].component:this,u=c.getData("selectedFilter")!==e,d=c.getData("fromSearch"),p="",g="";"fromSearch"!==o&&(t||u||"userStatus"===o||i)&&($("#searchBar").val(""),$("#cpT_userSearchClose").addClass("hide"),c.setData("showCloseIcn",!1),c.setData("previousSearchWord","")),c.setData("selectedFilter",e),store.findAll("client_user",{type:e,Source__s:i,per_page:200,page:1},!1,!0,{user_type_id:Lyte.Router.getRouteInstance().getDynamicParam()}).then((function(l){(u||t)&&c.showOrHideActionButtons("ResetUsers");var m=c.getData("selectedIds"),h=$L("#portalUsersTable"),v=$L(".cpT_slidecmpTop");p=$L("#portalUsersTable .lyteTableScroll");var y=renderingUtils.windowHeight-h.offset().top-29;if(c.setData("users",void 0===l?[]:l),c.setData("selectedUsersOption",e),p.scrollTo(0,0),n.resetScrollbar(),r&&r>0&&c.setData("totalUsersCount",c.getData("totalUsersCount")-r),l&&l.length){if(c.setData("noResultsFound",!1),l.$&&l.$.meta&&l.$.meta.total_count){var f,M=l.$.meta.total_count;"userStatus"===o&&(c.setData("currentUsersCount",M),c.setData("selectedFilterValue",c.filterTypesWithCount(e,M))),(f=document.getElementById("cpT_sourceDrpDown"))&&f.setData("ltPropDisplayValue",c.filterTypesWithCount(i,M))}}else c.setData("noResultsFound",!0),"all"===i&&(c.setData("currentUsersCount",0),c.setData("selectedFilterValue",c.filterTypesWithCount(e,0))),(f=document.getElementById("cpT_sourceDrpDown"))&&f.setData("ltPropDisplayValue",c.filterTypesWithCount(i,0));if(d&&!u&&!t||d&&!i){var _=m.length;if(_>0){for(var w=$L(".cpT_rowCkbox"),I=w.length,b=0,P=0;P<I;P++)m.contains(w[P].id)&&(w[P].ltProp("checked",!0),b++);0===b&&0===_?v.removeClass("cpT_animTop"):v.addClass("cpT_animTop")}else v.removeClass("cpT_animTop"),c.setData("showSelectedCount",!1),c.setData("selectedUsersCount",0),c.setData("selectedIds",[]);c.setData("userRequestSent",!1),c.setData("fromSearch",!0)}else v.removeClass("cpT_animTop"),c.setData("showSelectedCount",!1),c.setData("selectedUsersCount",0),c.setData("selectedIds",[]),c.setData("fromSearch",!1);h&&p[0]&&(h.css("height","auto"),g=p[0].scrollHeight,y=renderingUtils.windowHeight-h.offset().top-61,g>y&&l&&h.css("height",y+"px"),p.scrollTo(0,0),n.resetScrollbar()),t&&s&&!a?crmui.showMsgBand("success",s,3e3):s&&a&&(c.clearUserSelection(),c.showErrorMsg(s)),commonUtils.showHideLoadingDiv(!1)}))},showOrHideActionButtons:function(e){var t=this;switch(e){case"ActiveConfirmedUsers":t.setData("showOrHideChangeUserTypeButton",!0),t.setData("showOrHideRemoveUsersButton",!0),t.setData("showOrHideActivateUsersButton",!1),t.setData("showOrHideDeactivateUsersButton",!0),t.setData("showOrHideReInviteUsersButton",!1);break;case"InvitationNotAccepted":case"LoginSuspended":t.setData("showOrHideChangeUserTypeButton",!0),t.setData("showOrHideRemoveUsersButton",!0),t.setData("showOrHideActivateUsersButton",!1),t.setData("showOrHideDeactivateUsersButton",!1),t.setData("showOrHideReInviteUsersButton",!0);break;case"NotConfirmedUsers":t.setData("showOrHideChangeUserTypeButton",!0),t.setData("showOrHideRemoveUsersButton",!0),t.setData("showOrHideActivateUsersButton",!1),t.setData("showOrHideDeactivateUsersButton",!1),t.setData("showOrHideReInviteUsersButton",!1);break;case"DeactiveUsers":t.setData("showOrHideChangeUserTypeButton",!0),t.setData("showOrHideRemoveUsersButton",!0),t.setData("showOrHideActivateUsersButton",!0),t.setData("showOrHideDeactivateUsersButton",!1),t.setData("showOrHideReInviteUsersButton",!1);break;case"ResetUsers":t.setData("showOrHideChangeUserTypeButton",!1),t.setData("showOrHideRemoveUsersButton",!1),t.setData("showOrHideActivateUsersButton",!1),t.setData("showOrHideDeactivateUsersButton",!1),t.setData("showOrHideReInviteUsersButton",!1);break;case"WaitingForPortalAccessUsers":t.setData("showOrHideGrantAccessButton",!0);default:t.setData("showOrHideChangeUserTypeButton",!0),t.setData("showOrHideRemoveUsersButton",!0),t.setData("showOrHideActivateUsersButton",!1),t.setData("showOrHideDeactivateUsersButton",!1),t.setData("showOrHideReInviteUsersButton",!1)}},removeSelectedId:function(e,t){for(var s=e.length;s--;)e[s]===t&&e.splice(s,1)},filterTypesWithCount:function(e,t){switch(e){case"AllActiveUsers":return I18n.getMsg("all.users.with.count",t);case"ActiveConfirmedUsers":return I18n.getMsg("active.users.with.count",t);case"ConfirmedUsers":return I18n.getMsg("confirmed.users.with.count",t);case"NotConfirmedUsers":return I18n.getMsg("not.confirmed.users.with.count",t);case"DeactiveUsers":return I18n.getMsg("deactivated.users.with.count",t);case"InvitationNotAccepted":return I18n.getMsg("custmr.prtl.usr.fltr.unconf.invt.not.accepted","("+t+")");case"LoginSuspended":return I18n.getMsg("custmr.prtl.usr.fltr.lgn.spnd","("+t+")");case"WaitingForPortalAccessUsers":return I18n.getMsg("waitingforportalaccess.users.with.count",t);case"invite":return I18n.getMsg("invite.users.with.count",t);case"signup":return I18n.getMsg("portalforms.users.with.count",t);case"all":return I18n.getMsg("custmr.prtl.usr.allsource")}},clearUserSelection:function(){for(var e=$L(".cpT_rowCkbox"),t=e.length,s=0;s<t;s++)e[s].ltProp("checked",!1);this.setData("showSelectedCount",!1),$L(".cpT_slidecmpTop").removeClass("cpT_animTop"),this.setData("showSelectedCount",!1),this.setData("selectedUsersCount",0),this.setData("selectedIds",[])},loadEmailTemplateModal:function(e,t,s){commonUtils.showHideLoadingDiv(!0),this.beforeOpenEmailTemplateModal(e,t,s)},beforeOpenEmailTemplateModal:function(e,t,s){var r=store.peekAll("portal_template_folder").find((function(s){return s.name===e&&s.userTypeId===t}));if(r)this.openEmailTemplateModalByRoute(r.name,t,r.id,s);else{var a=this;store.findAll("portal_template_folder",{profileIds:t}).then((function(r){var o=r.find((function(s){return s.name===e&&s.userTypeId===t}));o?a.openEmailTemplateModalByRoute(o.name,t,o.id,s):crmui.showMsgBand("error",I18n.getMsg("please.contact.support"),3e3)}),(function(e){commonUtils.showHideLoadingDiv(!1);try{e.response&&"NO_PERMISSION"===JSON.parse(e.response).code?renderingUtils.displayPermissionDenied():crmui.showMsgBand("error",I18n.getMsg("please.contact.support"),3e3)}catch(e){crmui.showMsgBand("error",I18n.getMsg("please.contact.support"),3e3)}}))}},openEmailTemplateModalByRoute:function(e,t,s,r){store.findAll("portal_email_template",{name:e+"_"+Crm.userDetails.LOCALE,folderId:s,module:r},!1,!0,"filters").then((function(e){Lyte.Router.getRouteInstance().transitionTo({route:"crm.settings.section.client-portal.user-types.summary.folders.templates",dynamicParams:[t,s,e[0].id],queryParams:e[0].isDefault?{language:Crm.userDetails.LOCALE}:{}})}),(function(e){commonUtils.showHideLoadingDiv(!1),e.response&&"NO_PERMISSION"===JSON.parse(e.response).code?renderingUtils.displayPermissionDenied():crmui.showMsgBand("error",I18n.getMsg("please.contact.support"),3e3)}))},checkUpdatedInvitationValue:function(e,t,s,r){var a=store.peekRecord("user_type",s).invitation_field,o="/crm/v2.2/"+moduleApiMapping[t],n={params:{ids:e.toString(),fields:a.api_name}};networkUtils.lyteInitiateRequest(o,"GET",n).then((function(e){var t=[];if(e)for(var s=e.data?e.data:[],o=s.length,n=0;n<o;n++){var i=store.peekRecord("client_user",s[n].id);i&&s[n][a.api_name]&&i.$.get(33===a.ui_type?"phone":"email").toLowerCase()!==s[n][a.api_name].toLowerCase()&&(s[n].full_name=i.full_name.toLowerCase(),t.push(s[n]))}r(t)}),(function(){r([])}))},openConfirmationModelForSingleActivation:function(e,t,s){let r=s&&33===s.ui_type?I18n.getMsg("custmr.prtl.chngsts.phone.invitation"):I18n.getMsg("custmr.prtl.chngsts.email.invitation"),a=s&&33===s.ui_type?I18n.getMsg("custmr.prtl.chngsts.phone.sngle.upd.nte"):I18n.getMsg("custmr.prtl.chngsts.email.sngle.upd.nte");var o=Lyte.Component.render("lyte-alert",{id:"portalEmailConfirmAlert","lt-prop-show-close-button":"false","lt-prop-wrapper-class":"portalEmailConfirmAlert","lt-prop-top":"0px","lt-prop-type":"confirm","lt-prop-heading":r,"lt-prop-primary-message":a,"lt-prop-button-position":"right"},"#show");o.ltProp("buttons",[{type:"reject",text:I18n.getMsg("crm.button.cancel"),appearance:"default"},{type:"accept",text:I18n.getMsg("custmr.prtl.yes.proceed"),appearance:"primary"}]),o.setMethods({onAccept:e,onReject:t}),o.ltProp("show",!0)},getSelectedIdsFromDOM:function(){for(var e=[],t=document.getElementsByClassName("cpT_rowCkbox"),s=t.length,r=0;r<s;r++)!0===t[r].checked&&e.push(t[r].ltProp("id"));return e},portalConfigUsersPageFunc:function(){var e=$L("#portalUsersTable"),t=$(".cpT_listRow"),s=$L("#portalUsersTable .lyteTableScroll"),r=s[0].scrollHeight,a=renderingUtils.windowHeight-(s.offset().top+29+32);e.css("height","auto"),r>a&&t.length>0&&e.css("height",a+"px"),s.scrollTo(0,0),$L("#portalUsersTable .lyteScrollBar").resetScrollbar()}});
