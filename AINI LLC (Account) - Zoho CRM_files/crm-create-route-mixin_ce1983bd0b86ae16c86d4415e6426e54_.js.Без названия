Lyte.Mixin.register("crm-create-route-mixin",{beforeModelHook:async function(e,t,a){var{transitionInfo:r,targetRoute:i,isThroughQc:o,module_name:n,formViewType:s,entityRecordId:d,lyteConvertionSupported:l,parentModuleName:u,routeGlobalData:m}=e;if(!o&&["crm.tab.module.create.canvas","crm.tab.module.entity.edit.canvas","crm.tab.module.entity.clone.canvas"].includes(i)){if("create"===s||"clone"===s)return;if("edit"===s)return void(Crm.userDetails.RTL_ENABLED&&(this.replaceWith({route:"crm.tab.module.entity.edit",dynamicParams:[n,d],queryParams:{layout_id:a.layoutId}}).data={skipDirtyCheck:!0}))}if(("create"===s||"clone"===s)&&Crm.userDetails.isStorageLimitReached)return renderingUtils.removeFreezeLayer(),Crm.showStorageExceedPopup(),void this.transition.abort();"edit"===s&&(t.isWizardRouteSwitch&&t.previousTrans&&!o&&(app.prevTransition=t.previousTrans),this.permissionDenied=!1,this.isDirtyForm=!1),"create"===s&&(t.isWizard=!(!a||!a.wizardId));var c,p=store.peekRecord("module",moduleRecordMapping[n]&&moduleRecordMapping[n].id);switch(s){case"create":c="Create",o||(this.newTransition=!0);break;case"edit":c="Edit";break;case"clone":c="Clone"}if(void 0!==n&&"Quotes"===n&&Crm.isCpqActivated()&&c&&Crm.client_tracking(`CPQ-Quotes-${c} Quote button in begin page`),"create"===s&&t.isRefresh)return t.isRefresh=!1,o?{isStorageLimitReached:!0,refreshTemplate:!0,transData:t}:(t.skipDirtyCheck=!0,void(Lyte.Router.getRouteInstance().refresh({refreshTemplate:!0}).data=t));const y=e=>{const r=Crm.userDetails.tabsUsedInWizards&&Crm.userDetails.tabsUsedInWizards.includes(p.id)&&("create"===s||"edit"===s&&a.wizardId&&Crm.userDetails.isWizardViewEnabled);t.skipWizardsMeta||!r||window.clientPortalName||(e.wizards=store.findAll("wizard",{module:p.api_name},!1));!(Crm.userDetails.isWizardViewEnabled&&a.wizardId&&["create","edit"].includes(s)&&!o)||Crm.userDetails.RTL_ENABLED||window.clientPortalName||(e.wizardViews=this.getCanvasViewsMetaForWizard(n,1,this)),delete t.skipWizardsMeta};if(-1===["CustomModule5001","CustomModule5002","CustomModule5003","CustomModule5004"].indexOf(n)&&p&&p.api_supported){var h=!!(m&&m.hasOwnProperty("preventCanvasExecution")&&m.preventCanvasExecution);if(l||!a.layoutId){let e={};if(y(e),t.skipModuleReqTrigger){delete t.skipModuleReqTrigger;h=!!(m&&m.hasOwnProperty("preventCanvasExecution")&&m.preventCanvasExecution);return a.layoutId?(!Crm.userDetails.isCanvasFormViewEnabled||a.wizardId||"clone"!==s&&("create"!==s||t.skipviewReqTrigger)||(e.canvasViews=app.store.makeRequest("findAll","canvasview",{module:moduleRecordMapping[n].api_name,feature:"FormView",layout_id:a.layoutId}).then((function(e){return e}),(function(){}))),Lyte.resolvePromises(e)):("create"===s?e.defaultParams=this.setDefaultQueryParamsForCreate({transitionInfo:r,transData:t,queryParams:a,module_name:n,formViewType:s,isThroughQc:o,moduleResponse:moduleRecordMapping[n],parentModuleName:u,routeGlobalData:m}):"edit"!==s&&"clone"!==s||(e.defaultParams=this.chkAndGetRecordForSettingQueryParams({transitionInfo:r,module_name:n,entityRecordId:d,moduleResponse:moduleRecordMapping[n],transData:t,queryParams:a,formViewType:s,isThroughQc:o,parentModuleName:u,routeGlobalData:m})),Lyte.resolvePromises(e))}if(e.modules=app.store.makeRequest("findRecord","module",moduleRecordMapping[n].id,{include:["layouts","lookup_field_properties","custom_view","related_lists","business_card_fields"]}),!Crm.userDetails.isCanvasFormViewEnabled||"clone"!==s&&"create"!==s||!a.layoutId||a.wizardId||h||(e.canvasview=app.store.makeRequest("findAll","canvasview",{module:moduleRecordMapping[n].api_name,feature:"FormView",layout_id:a.layoutId}).then((function(e){return e}),(function(){}))),"create"===s&&moduleRecordMapping[n].layouts&&!o&&!a.layoutId){var f=moduleRecordMapping[n];e.canvasViews=this.setDefaultQueryParamsForCreate({transitionInfo:r,transData:t,queryParams:a,module_name:n,formViewType:s,isThroughQc:o,moduleResponse:f,parentModuleName:u,routeGlobalData:m})}return Lyte.resolvePromises(e).then(function(e){if(e.modules){if(a.layoutId)return e;var i=e.modules;if("create"===s)return this.setDefaultQueryParamsForCreate({transitionInfo:r,transData:t,queryParams:a,module_name:n,formViewType:s,isThroughQc:o,moduleResponse:i,parentModuleName:u,routeGlobalData:m});if("edit"===s||"clone"===s)return this.chkAndGetRecordForSettingQueryParams({transitionInfo:r,module_name:n,entityRecordId:d,moduleResponse:i,transData:t,queryParams:a,formViewType:s,isThroughQc:o,parentModuleName:u,routeGlobalData:m})}}.bind(this))}if(Crm.userDetails.isCanvasFormViewEnabled&&"clone"===s)return delete t.skipModuleReqTrigger,app.store.makeRequest("findAll","canvasview",{module:moduleRecordMapping[n].api_name,feature:"FormView",layout_id:a.layoutId}).then((function(e){return e}),(function(){}))}delete t.skipModuleReqTrigger},chkAndGetRecordForSettingQueryParams:function(e){var{module_name:t,entityRecordId:a,moduleResponse:r,transData:i,queryParams:o,formViewType:n,isThroughQc:s,parentModuleName:d,routeGlobalData:l}=e,u=moduleRecordMapping[t].id;!store.model[u]&&store.registerModel(u,{},{extends:"entity"});var m=store.peekRecord(u,a);return m?this.setDefaultQueryParamsForEditAndClone({moduleResponse:r,record:m,transData:i,queryParams:o,module_name:t,formViewType:n,isThroughQc:s,parentModuleName:d,routeGlobalData:l}):store.findRecord(u,a).then(function(e){return m=e[0],this.setDefaultQueryParamsForEditAndClone({moduleResponse:r,record:m,transData:i,queryParams:o,module_name:t,formViewType:n,isThroughQc:s,parentModuleName:d,routeGlobalData:l})}.bind(this))},setDefaultQueryParamsForCreate:function(e){var{transitionInfo:t,transData:a,queryParams:r,module_name:i,formViewType:o,isThroughQc:n,moduleResponse:s,parentModuleName:d,routeGlobalData:l}=e;if("Activities"===d&&(r.sub_module=i),a.layoutId)r.layoutId=a.layoutId;else{var u=this.getQueryParamsDefaultLayoutId({module_name:i,formViewType:o,routeGlobalData:l});for(var m in u=u||{})r[m]=u[m]}if(a.isWizard=!(!r||!r.wizardId),a.skipDirtyCheck=!0,r.layoutId){if(n)return a.skipWizardsMeta=!0,{transData:a,moduleResponse:s,queryParams:r,skipModuleReqTrigger:!0,destroyAndRefresh:!0};if(Crm.userDetails.isCanvasFormViewEnabled)return app.store.makeRequest("findAll","canvasview",{module:moduleRecordMapping[i].api_name,feature:"FormView",layout_id:r.layoutId}).then(function(e){if(e.length&&"false"!==r.redirect&&"false"!==r.assignment){a.skipModuleReqTrigger=!0,a.skipviewReqTrigger=!0,this.transition.abort();var o=this.transition.info.queryParams||{};o.layoutId=r.layoutId;var n,d="";n=Crm.userDetails.CLIENT_PROFILE_ID?Crm.userDetails.CLIENT_PROFILE_ID:store.peekRecord("user",Crm.userDetails.USER_ID).profile.id;for(var l=e.length,u=0;u<l;u++)if(e[u].profiles.includes(n)){d=e[u].id;break}d?(s&&(a.moduleResponse=s),this.replaceWith({route:"crm.tab.module.create.canvas",dynamicParams:[i,d],queryParams:o}).data=a):(a.skipModuleReqTrigger=!0,a.skipWizardsMeta=!0,a.skipviewReqTrigger=!0,this.replaceWith(t.route,t.dynamicParams[0],r).data=a)}else{r.redirect="false",a.skipModuleReqTrigger=!0,a.skipWizardsMeta=!0;-1===["Visits","Activities","Services__s","Appointments__s","Job_Sheets__s","Consents","Data_Subject_Requests","zohoshowtime__ShowTime_Sessions","zohoshowtime__Zoho_ShowTime","Desk","Forecasts","messages__s","ZohoCPQ__s","Approvals","Tasks","Events","Calls"].indexOf(moduleApiMapping[i])&&(a.skipviewReqTrigger=!0),this.replaceWith(t.route,t.dynamicParams[0],r).data=a}return r.layoutId}.bind(this),function(){a.skipModuleReqTrigger=!0,a.skipviewReqTrigger=!0,a.skipWizardsMeta=!0,this.replaceWith(t.route,t.dynamicParams[0],r).data=a}.bind(this));a.skipModuleReqTrigger=!0,a.skipWizardsMeta=!0,this.replaceWith(t.route,t.dynamicParams[0],r).data=a}},setDefaultQueryParamsForEditAndClone:function(e){var{transData:t,module_name:a,record:r,formViewType:i,parentModuleName:o,isThroughQc:n,moduleResponse:s,queryParams:d,routeGlobalData:l}=e;if("Activities"===o&&(d.sub_module=a),r&&r.Layout&&r.Layout.id)d.layoutId=r.Layout.id;else{var u=this.getQueryParamsDefaultLayoutId({module_name:a,formViewType:i,routeGlobalData:l});for(var m in u=u||{})d[m]=u[m]}if(t.layoutId&&(d.layoutId=t.layoutId),r&&r.Wizard&&r.Wizard.id&&("draft"===r.$state&&(d.state=r.$state),"edit"===i&&(d.wizardId=r.Wizard.id)),n)return{transData:t,moduleResponse:s,queryParams:d,skipModuleReqTrigger:!0,destroyAndRefresh:!0,transitionAbort:!0};if(d.layoutId){var c=this.transition.info;return t.skipModuleReqTrigger=!0,t.skipDirtyCheck=!0,this.transition.abort(),this.replaceWith(c.route,c.dynamicParams[0],c.dynamicParams[1],d).data=t}},getQueryParamsDefaultLayoutId:function(e){for(var t,{module_name:a,formViewType:r}=e,i={},o="team_based"===moduleRecordMapping[a].access_type?moduleRecordMapping[a].private_profile.name:Crm.userDetails.PROFILE_NAME,n=moduleRecordMapping[a].layouts,s=n.length,d=0;d<s;d++)for(var l=n[d].profiles.length,u=0;u<l;u++)if(n[d].profiles[u].default&&n[d].profiles[u].name===o){i.layoutId=n[d].id,"create"===r&&(["U","A","C","Z"].contains(Crm.userDetails.LICENSE_TYPE)||Crm.userDetails.ULTIMATE_ADDON_COUNT>0)&&n[d].profiles[u]._default_view&&"wizard"===n[d].profiles[u]._default_view.type&&(i.wizardId=n[d].profiles[u]._default_view.id,t=n[d].id);break}return"create"===r&&window.clientPortalName&&t&&(i.layoutId=t),i},modelHookInitial:function(e,t,a){var{targetRoute:r,isThroughQc:i,formViewType:o,module_name:n,lyteConvertionSupported:s,parentModuleName:d,entityRecordId:l,routeGlobalData:u}=e,m=a.layoutId;if(!i&&["crm.tab.module.create.canvas","crm.tab.module.entity.edit.canvas","crm.tab.module.entity.clone.canvas"].includes(r)){let e="crm.tab.module.create",t="crm.tab.module.entity.clone",r={breakExecution:!0};if("create"===o||"clone"===o)return Crm.userDetails.RTL_ENABLED&&(this.replaceWith({route:"create"===o?e:t,dynamicParams:[n,l],queryParams:{layout_id:a.layoutId}}).data={skipDirtyCheck:!0}),r;if("edit"===o&&app.prevTransition.route)return r}(a.listRelationId||a.fillupDataDetails)&&"create"===o&&(Object.assign(t,a),a.fillUpModule&&(t.isFillUpModuleFromURL=!0)),"edit"===o&&(this.isWizard=!1);var c,p=t?objectUtils.cloneObject(t):{},y={module:n},h={},f=moduleRecordMapping[n]||{};if(delete p.backOneLevel,delete p.skipviewReqTrigger,delete p.skipDirtyCheck,delete p.skipWizardsMeta,"create"===o){if(delete p.refreshPage,delete p.isCreateChildCampaign,delete p.checkPermission,delete p.isRefresh,h.params=y,!!!(u&&u.hasOwnProperty("preventCanvasExecution")&&u.preventCanvasExecution)&&"false"!==a.redirect&&!a.wizardId){var v=store.peekAll("canvasview"),g=v?v.length:0;if(g){t.skipModuleReqTrigger=!0;var w,_="";w=Crm.userDetails.CLIENT_PROFILE_ID?Crm.userDetails.CLIENT_PROFILE_ID:store.peekRecord("user",Crm.userDetails.USER_ID).profile.id,"team_based"===moduleRecordMapping[n].access_type&&(w=moduleRecordMapping[n].private_profile.id);for(var b=0;b<g;b++)if(v[b].profiles.includes(w)&&"FormView"===v[b].feature&&v[b].layout.id===m){if(_=v[b].id,i)return{transitionReplace:!0,transitionAbort:!0,breakExecution:!0,isCanvas:!0,extraInfo:{route:"crm.tab.module.create.canvas",dynamicParams:D,queryParams:C}};this.transition.abort();break}if(_){var D=[n,_],C={layoutId:m};if(i)return{transitionReplace:!0,breakExecution:!0,isCanvas:!0,extraInfo:{route:"crm.tab.module.create.canvas",dynamicParams:D,queryParams:C}};t.skipDirtyCheck=!0,this.replaceWith({route:"crm.tab.module.create.canvas",dynamicParams:D,queryParams:C}).data=t}}}p.wizardSwitch&&(c=p.wizardSwitch,delete p.wizardSwitch),s||p.isWizard||delete p.isWizard;var I=!!(this.data&&this.data.globalData&&this.data.globalData.forceFormType&&"create"===this.data.globalData.forceFormType),R=!!(u&&u.hasOwnProperty("preventWizardExecution")&&u.preventWizardExecution);I&&R&&a.wizardId&&(p.isWizard=!1),y=Object.assign(y,p)}return"create"!==o&&"clone"!==o||(y.relmodule&&"Deals"===y.relmodule&&(y.relmodule="Potentials"),y.primmodule&&"Products"===y.primmodule&&(y["property(productId)"]=y.entityid)),s||p.isWizard||("clone"!==o&&(crmTab.isZBCustomModule(n)||crmTab.isZSCustomModule(n))?y.newModel=!0:(y.format="json",h.data_type="json"),l&&(y.id=l),"edit"===o?((y=Object.assign(y,p)).tstamp=(new Date).getTime(),p.EditSeries&&(y.EditSeries="true",y.recAct=e.recAct,y.cvid=$("#cvid").val()),delete y.reqFrom,h.params=y,delete h.params.goTo):"clone"===o&&(h.params=y)),"clone"===o&&(delete p.refreshPage,delete p.backOneLevel,delete p.checkPermission,y=Object.assign(y,p)),{clonedTransitionData:p,dataparams:y,wizardSwitch:c,options:h,modInfo:f,module_name:n,parentModuleName:d}},getCurrentLayoutInfo:function(e){var t,{lyteConvertionSupported:a,isThroughQc:r,transData:i,wizardSwitch:o,dataparams:n,layDet:s,transitionData:d,module_data:l,queryParams:u,formViewType:m,routeGlobalData:c}=e,p=e.dataObject,y=l.module_name,h="team_based"===moduleRecordMapping[y].access_type?moduleRecordMapping[y].private_profile.name:Crm.userDetails.PROFILE_NAME,f=l.id,v=this.getLayoutRelatedInfo({layDet:s,module_data:l,pLayoutId:u.layoutId,dLayoutId:n.layoutId,module_name:y,module_id:f,currentuserProfile:h,routeGlobalData:c}),{showInteglayoutoption:g,layoutddValues:w,selected:_,selectedId:b}=v;if(i.wizardSwitch=o,u.layoutId&&u.wizardId?(b=u.layoutId,t=u.wizardId,d.selectedLayoutid=d.selectedLayoutid?d.selectedLayoutid:u.layoutId+";"+u.wizardId):d.isWizard&&(b=d.selectedLayoutid.split(";")[0],t=d.selectedLayoutid.split(";")[1]),t&&window.clientPortalName){var D=l.layouts.filter((function(e){return e.id===b}))[0].profiles.filter((function(e){return e.id===Crm.userDetails.PROFILE_ID}));let e,a=0===D.length,i=D[0]&&D[0]._default_view.id!==t;if(a||i){e=a?I18n.getMsg("crm.label.layoutpermis"):I18n.getMsg("crm.wizard.no.view.permission"),_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:e,ltPropButtons:[{type:"reject",text:I18n.getMsg("crm.button.ok.gotit"),appearance:"primary"}],ltPropButtonPosition:"center",ltPropContentAlign:"center",ltPropShowCloseButton:"false",ltPropWrapperClass:"utilsAlertMsg"}});var C={is_Error:!0,errorId:"2",errorFrom:"wizards",data:{module_name:y}};return r?C:(this.transition.abort(),void this.handleTransitionAbortErrors(C))}}c&&c.hasOwnProperty("showLoading")&&!c.showLoading||commonUtils.showHideLoadingDiv(!0);var I={transData:i,wizardId:t};return I.layoutId=b,I.moduleapi=l.api_name,I.moduleName=y,I.isOldFlow=!a,I.dataObject=p,I.queryParamsInfo=u,I.isThroughQc=r,I.formViewTypeInfo=m,this.getModulePromise(I).then(function(e){const a=Lyte.registeredMixins["crm-view-utils"],o={position:"create_clone"};if(o.layoutId=b,o.moduleName=y,e.custom_button&&e.custom_button.length&&(e.custom_button=a.filterButtonData(e.custom_button,o)),!validationUtils.isEmpty(e.wizard)&&store.peekRecord("layout",b))for(var s,m=store.peekRecord("wizard-container",b),c=m.chart_data.nodes.length,p=[],v=0;v<c;v++){var D=m.chart_data.nodes[v];if(D.start_node){var C=store.peekRecord("wizard-screen",D.screen.id);s=C.segments,p.push({id:C.id,name:C.name,index:0,api_name:C.api_name});break}}var I,R,T=l.wizard,k=T?T.length:0,E=[];for(v=0;v<k;v++){var P=T[v];if(P.active){var L=P.profiles.length,M=P.portal_user_types.length,z=!1;if(window.clientPortalName){for(var A=0;A<M;A++)if(h===P.portal_user_types[A].name){z=!0;break}}else for(var S=0;S<L;S++)if(h===P.profiles[S].name){z=!0;break}if(!z)continue;if(z=l.layouts.filter((e=>P.layouts.some((t=>t.id===e.id)))).some((e=>!!e.profiles.some((e=>e.name===h)))),d.isWizard){var V=d.selectedLayoutid?d.selectedLayoutid.split(";")[0]:u.layoutId,N=T[v].layouts.length;for(S=0;S<N;S++)V===P.layouts[S].id&&(I=P.layouts[S].name)}if(z){if(w&&w.length&&P.layouts&&P.layouts.length){var O=w.mapByKey("id"),F=[];P.layouts.forEach((function(e){O.contains(e.id)&&F.push(e)})),P.layouts=F&&F.length?F:P.layouts;let e=P.layouts.length;for(var x=0;x<e;x++)window.clientPortalName?P.layouts[x].status="inactive":P.layouts[x].status="active"}E.push({uservalue:P.name,layouts:P.layouts,id:P.id,status:"active"})}}}if(window.clientPortalName){var q=l.layouts;let e=q.length;for(var W=0;W<e;W++){let e=q[W].profiles.filter((e=>e.id===Crm.userDetails.PROFILE_ID));if(e&&e.length>0)if(e[0]._default_view&&"layout"===e[0]._default_view.type){var U=w.filter((t=>t.id===e[0]._default_view.id));U&&U.length&&(U[0].status="active")}else if(e[0]._default_view&&"wizard"===e[0]._default_view.type){var B=E.filter((t=>t.id===e[0]._default_view.id))[0].layouts.filter((e=>e.id===q[W].id));B&&B.length&&(B[0].status="active")}}for(var j=E.length,$=0;$<j;$++){var Q=E[$].layouts;let e=Q.length;var H=0;for(W=0;W<e;W++)"active"===Q[W].status&&H++;0===H&&(E[$].status="inactive")}}return b=b||(e.layout&&e.layout[0]?e.layout[0].id:b),n&&n.generatePOactionData&&(n.generatePOactionData=i.generatePOactionData),r||(R=this.fetchCustomGlobalData({moduleName:y,formState:"create",featureInfo:this.loadResourcesOutput.featureInfo})),{initRoute:"create",entityrecordData:e.editEntitydata?e.editEntitydata[0]:{},transitionData:n,showInteglayoutoption:g,layoutRules:e.layout_rule,validationRules:e.validation_rule,customButtons:e.custom_button,moduleData:l,moduleId:f,moduleName:y,currsubformApinames:l.currsubformApinames?l.currsubformApinames:[],layoutddData:w,layoutddSelected:_,selectedLayoutid:t?b+";"+t:b,moduleSections:t?s:e.layout&&e.layout[0]?e.layout[0].sections:[],layoutDet:e.layout,wizardData:E,isWizard:d.isWizard,wizardId:d.selectedLayoutid,wizardName:I,screenHistory:p,surveyDepartments:e.survey_departments?e.survey_departments:[],webinarIntegration:e.webinarIntegration?e.webinarIntegration:void 0,fcCategory:e.fc_category?e.fc_category.stages:[],skyEyeIntegration:!!(e.skyEyeIntegration&&validationUtils.isNotEmpty(e.skyEyeIntegration)&&e.skyEyeIntegration.configured),orgTaxDetails:e.orgTaxDetails&&e.orgTaxDetails.length?e.orgTaxDetails:[],documentScrollNeeded:!0,zorContributingFields:e.zorContributingFields,zorEnabled:e.zorEnabled,map_dependency:e.mapDependency,globalData:R}}.bind(this))},renderTemplateHookInitial:function(e,t,a){var{isThroughQc:r,formViewType:i,module_name:o,targetRoute:n}=e;let s;if("edit"===i&&this.isWizard){var d="draft"===a.entityrecordData.$state;r?t.isWizardDraft=d:Lyte.Router.getRouteInstance().transition.data.isWizardDraft=d}if(!r&&(s=this.isCanvasViewRoute({targetRoute:n}),s.breakExecution))return s;if(CScriptLib&&CScript.Engine.Global.Init(),"create"===i){if(featuresAvailable.NEXTGENUI_ENABLED){var l=document.querySelector("crm-left-menu").component;["modules","requesters"].indexOf(l.getData("selectedMenu"))<0&&l.actions.renderModulesSection()}Lyte._ignoreOnReady=!0;var u,m=objectUtils.cloneObject(t);if(a&&void 0!==a.model)if("Layout_PermissionError"===a.model.error?u=I18n.getMsg("crm.label.layoutpermis"):"Layout_DEACTIVATED"===a.model.error&&(u=I18n.getMsg("crm.label.layoutdelete")),u){var c={is_Error:!0,errorId:"1",errorFrom:"common",data:{i18nKey:u,module_name:o}};return r?c:(this.handleTransitionAbortErrors(c),null)}return a.model&&(a=a.model),{transitionData:m,model:a}}return{transitionData:t,model:a}},handleTransitionAbortErrors:function(e){var t=this&&this.data&&this.data.globalData?this.data.globalData:void 0,a=t&&t.isThroughQc&&"quickCreate"===t.formType;switch(e.errorFrom){case"wizards":switch(e.errorId){case"1":a||(crmHistory.handleAjaxErrorLyte=!0);var r=null;e.data&&e.data.message&&(r=e.data.message),renderingUtils.displayPermissionDenied(null,null,r);break;case"2":a||(crmHistory.handleAjaxErrorLyte=!0,Lyte.Router.transitionTo({route:"crm.tab.module",dynamicParams:[e.data.module_name]}))}break;case"common":switch(e.errorId){case"1":renderingUtils.showCustomAlert(e.data.i18nKey,void 0,!1,(function(){a||Lyte.Router.transitionTo({route:"crm.tab.module",dynamicParams:[e.data.module_name]})}));break;case"2":a?renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("zwebinar.trial.expiry.desc.dynamic",Crm.integrationsAppName.ZOHO_WEBINAR)):Lyte.injectResources(e.data.resources,void 0,(function(){Lyte.Component.render(e.data.component,e.data.componentData,e.data.componentRenderLoc)}));break;case"3":crmui.showMsgBand(errorDetails.data.showMsgBandType,errorDetails.data.showMsgBandContent,errorDetails.data.showMsgBandDelay);break;case"4":a||this.transitionTo({route:e.data.transitionRoute,dynamicParams:e.data.transitionDynamicParams});break;case"5":crmui.showMsgBand(errorDetails.data.showMsgBandType,errorDetails.data.showMsgBandContent,errorDetails.data.showMsgBandDelay),a||this.transitionTo({route:e.data.transitionRoute,dynamicParams:e.data.transitionDynamicParams});break;case"6":a||(crmHistory.handleAjaxErrorLyte=!0);r=null;e.data&&e.data.message&&(r=e.data.message),renderingUtils.displayPermissionDenied(null,null,r);break;case"7":a?renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("crm.record.not.accessible.message.heading",I18n.getMsg("crm.record.not.accessible"))):Lyte.Component.render(e.data.component,e.data.componentData,e.data.componentRenderLoc);break;case"8":Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:[moduleName,id]})}}},beforeExitHook:function(e){var{module_name:t,formViewType:a,wizardId:r,currentFeature:i}=e;i&&(!i||"quickCreate"===i)||"create"!==a&&"edit"!==a||(this.unloadWizardComponents&&this.unloadWizardComponents(moduleRecordMapping[t]&&moduleRecordMapping[t].id),store.unloadAll("guided_selling"),r&&this.onBeforeWizardExecutionRouteExit()),"Tasks"===t&&delete window[t].whoIdModulesArr,Lyte.registeredMixins["crm-keyboard-shortcutsmixin"]&&Lyte.registeredMixins["crm-keyboard-shortcutsmixin"].unbindShortcutsBeforeExit("Record's Create/Edit/Clone Page"),window.removeEventListener("beforeunload",this.createPageUnloadListener)},didDestroyHook:function(e){(e.lyteConvertionSupported||e.isWizard)&&(this.rollBackCreateEntityRecord(e),"edit"===e.formViewType&&this.rollbackRecord(!1)),e.isWizard&&this.onDidDestroyWizardExecutionRoute()},willTransitionHook:function(e){var{formViewType:t,isThroughQc:a,currentTransition:r,nextTransition:i}=e;if(!a){const e=e=>e&&e.data&&e.data.skipDirtyCheck;if(!e(this.transition)&&!e(i)&&i&&this.isRecordModified()){i.pause();const e=$L("crm-create-layout")[0];if(e&&(e.setData("unsavedChangesPopupInfo",{isLayoutSwitch:!1,transition:i}),e.setData("disableFormbuttons",!1)),"edit"!==t||!e||"approval_process_pending"!==e.component.data.dataBind.$approval_state)return void this.displayUnsavedChangesAlert()}const a=e=>e&&e.data&&delete e.data.skipDirtyCheck;if(a(this.transition),a(i),"create"===t&&r&&i){if(Lyte.Router.checkIfSameRoute(r.info,i.info)&&i.data&&i.data.refreshPage){i.data&&i.data.refreshPage&&delete i.data.refreshPage,r.data.skipDirtyCheck=!0,i.data.moduleResponse&&(r.data.moduleResponse=i.data.moduleResponse),this.refresh({refreshTemplate:!0}).data=r.data,$L(window).scrollTo(0,0)}}else if("edit"===t)if(this.permissionDenied&&i&&i.data&&i.data.fromDetailView)delete i.data.fromDetailView,i.data.fromActivityListView=!0;else{var o=i.pause(),n="true"===$("#iskanbanview").val();if(!this.isDirtyForm||(!n||!getElemById("cvEditSave")||"none"===getElemById("cvEditSave").style.display||iskvFollowupTask||"crm.tab.module.entity.detail"!==i.target||i.data&&i.data.backOneLevel)&&(n||!$("#forEditViewScroll").length||i.data&&(i.data.backOneLevel||i.data.fromSave))){if(this.isWizard||this.lyteConvertionSupported){var s=i&&i.data&&i.data.hasOwnProperty("inventoryAutoFillData"),d=i&&"crm.tab.module.entity.edit.canvas"===i.target;this.rollbackRecord(!0,s,d)}o.resume()}else showConfirmBox(void 0,o)}}for(var l=$("crm-image-upload-create"),u=l.length,m=0;m<u;m++)for(var c=l[m].component.data.imageData.length,p=0;p<c;p++){var y=l[m].component.data.imageData[p];URL.revokeObjectURL(y.src)}let h=$L("crm-create-layout"),f=h&&h[0]&&h[0].component&&h[0].component.data,v=f&&f.dataBind;v&&!a&&("create"===t?store.unloadRecord(v.$.model._name,v.id):"edit"===t&&v.$.rollBack())},onErrorActionHook:function(e){var{formViewType:t,isThroughQc:a,lyteConvertionSupported:r,error:i,pausedTrans:o}=e,n=i||{};if("create"===t&&r&&n.status&&200!==n.status&&201!==n.status){var s=n.response?JSON.parse(n.response):void 0;if(400===n.status&&s&&"INVALID_LAYOUT_ID"===s.code){if(this.isInvalidLayoutError=!0,a)return{resumePausedTransition:!0};o.resume()}}else if("edit"===t){var d=i.status===crmConstants.errorStatusCode,l=i.status===crmConstants.limitExceedsCode;if(a)return{isPermissionDenied:d,isLimitExceedsCode:l};if(d)return renderingUtils.displayPermissionDenied(i),$("#cvEditSave").hide(),this.permissionDenied=!0,!1;if(l)Search.displayLookupExceedsMsg(i);else if(403===i.status)_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.delete.error"),ltPropSecondaryMessage:I18n.getMsg("crm.security.error"),ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.button.ok"),appearance:"primary"}],ltPropButtonPosition:"center"},show:function(e){e.childComp.querySelector(".alertPrimaryMsg").style="color:#E20000"}});else{var u='<div onclick=/"sE()" class="w500 p20"><div class="fL pL20 w430"><div class="crm-heading-font-size"><h2 style="color:#E20000";>'+I18n.getMsg("crm.delete.error")+'</h2></div><div class="mT10">'+I18n.getMsg("crm.record.delete.message",[Crm.getCrmBasePath()])+'</div></div><br class="cBoth"><div  class="alignRight mT20"><input type="button" id="popupok" class="primarybtn" value="'+I18n.getMsg("crm.button.ok")+"\" onclick=\"hide('popupnew');renderingUtils.removeFreezeLayer();document.getElementById('popupnew').style.zIndex=30\"></div></div>";renderingUtils.popUpWithFreeze(u)}}},rollbackRecord:function(e,t,a){var r=this.currentModel?this.currentModel.entityrecordData:void 0;if(r&&r.$&&(r.$.isModified||this.rollbackRecordNeeded)){if(!a&&("approval_process_pending"===r.$approval_state||"approval_process_rejected"===r.$approval_state))return;if(!t){if(e)return this.rollbackRecordNeeded=!0,void r.$.rollBack();if(!this.rollbackRecordNeeded)return}for(var i in this.currentModel.originalData){var o=r.$.model.fieldList[i];if("relation"===o.type&&"hasMany"===o.relType)for(var n=this.currentModel.originalData[i],s=n.length,d=0;d<s;d++){var l=r[i].filter((function(e){return e.id===n[d].id}));if(l=l&&l[0]?l[0]:{},validationUtils.isNotEmpty(l)){for(var u in n[d]){var m=l.$.model.fieldList[u];m&&("date"===m.type||"datetime"===m.type||"phone"===m.type||"multi-picklist"===m.type)&&n[d][u]&&(l[u]=Lyte.Transform[m.type].deserialize(n[d][u]))}store.pushPayload(o.relatedTo,l)}}else r[i]=Lyte.Transform[o.type].deserialize(this.currentModel.originalData[i])}store.pushPayload(r.$.model._name,r)}},modelHook:function(e,t,a){var{isThroughQc:r,lyteConvertionSupported:i,formViewType:o,parentTransitionData:n,entityRecordId:s,routeGlobalData:d}=e,l=this.modelHookInitial(e,t,a);if(l&&l.breakExecution)return delete l.breakExecution,r?l:void 0;var{clonedTransitionData:u,dataparams:m,wizardSwitch:c,modInfo:p,options:y,module_name:h}=l;if("create"===o&&(i||t.isWizard)&&(!p||!p.creatable)){var f={is_Error:!0,errorId:"1",errorFrom:"wizards",data:{}};return r?f:(this.handleTransitionAbortErrors(f),void this.transition.abort())}var v={targetRoute:e.targetRoute,dataObject:e.dataObject,transitionData:u,entityRecordId:s,parentTransitionData:n,formViewType:o,dataparams:m,module_name:h,options:y,transData:t,queryParams:a,modInfo:p,wizardSwitch:c,isThroughQc:r,lyteConvertionSupported:i,routeGlobalData:d};return i?this.lyteModelHook(v):("edit"===o&&"gsearch"===u.pfrom&&(crmNavig.removeFeaturCacheObj("gsearch"),m.pfrom="gsearch"),this.nonLyteModelHook(v))},lyteModelHook:function(e){var{formViewType:t,targetRoute:a,dataObject:r,entityRecordId:i,transitionData:o,parentTransitionData:n,queryParams:s,module_name:d,transData:l,modInfo:u,wizardSwitch:m,isThroughQc:c,dataparams:p,lyteConvertionSupported:y,routeGlobalData:h}=e;if("create"===t){var f={layDet:u.layouts&&u.layouts.length?u.layouts:[],transitionData:o,dataObject:r,module_data:u,queryParams:s,dataparams:p,wizardSwitch:m,transData:l,isThroughQc:c,lyteConvertionSupported:y,formViewType:t,routeGlobalData:h};return this.getCurrentLayoutInfo(f)}if("edit"===t){var v,g=(a||c)&&o.isWizard?"wizards":"create";"wizards"!==g&&(g=s&&s.wizardId?"wizards":g),c||(v={loadResourcesOutput:this.loadResourcesOutput,formType:g});var w={dataObject:r,module_name:d,globalDataObject:v,entityRecordId:i,queryParams:s,transData:o,parentTransitionData:n,isThroughQc:c,formViewType:t,routeGlobalData:h},_=!!(h&&h.hasOwnProperty("preventCanvasExecution")&&h.preventCanvasExecution);return!Crm.userDetails.isCanvasFormViewEnabled||s.wizardId||_?this.newEditRequestData(w):app.store.makeRequest("findAll","canvasview",{module:moduleRecordMapping[d].api_name,feature:"FormView",layout_id:s.layoutId}).then(function(){return this.newEditRequestData(w)}.bind(this),function(){return this.newEditRequestData(w)}.bind(this))}if("clone"===t)return this.cloneLCModelhook({globalDataObject:v,dataObject:r,entityRecordId:i,parentTransitionData:n,module_name:d,formViewType:t,transitionData:o,queryParams:s,transData:l,modInfo:u,wizardSwitch:m,isThroughQc:c,dataparams:p,lyteConvertionSupported:y,routeGlobalData:h})},cloneLCModelhook:function(e){var{isThroughQc:t,transData:a,module_name:r,parentTransitionData:i,entityRecordId:o,modInfo:n,dataparams:s,queryParams:d,formViewType:l,dataObject:u,routeGlobalData:m}=e,c=moduleRecordMapping[r].id,p=n;if(!p||!p.creatable)return t?{displayPermissionDenied:!0,abortTransition:!0,handleAjaxErrorLyte:!0}:(crmHistory.handleAjaxErrorLyte=!0,renderingUtils.displayPermissionDenied(),void this.transition.abort());for(var y=p?p.layouts.filter((function(e){return e.status>=0})):[],h=y?y.length:0,f=[],v=0;v<h;v++)f.push({id:y[v].id,name:y[v].name});var g,w,_=[];i&&i.layoutName&&i.layoutId?(_.push({uservalue:i.layoutName,systemvalue:i.layoutId,id:i.layoutId}),g=i.layoutName,w=i.layoutId):1===f.length&&(_.push({uservalue:f[0].name,systemvalue:f[0].id,id:f[0].id}),g=f[0].name,w=f[0].id),m&&m.hasOwnProperty("showLoading")&&!m.showLoading||commonUtils.showHideLoadingDiv(!0);var b={transData:a};return b.layoutId=w,b.moduleapi=p.api_name,b.moduleName=r,b.entityId=o,b.queryParamsInfo=d,b.isThroughQc=t,b.formViewTypeInfo=l,b.dataObject=u,this.getModulePromise(b).then(function(e){var a=store.peekRecord(c,o);if(!a||this.isRecordUnAvailableError)return this.handleRecNotAvailablityError(t);if(a&&a.$converted&&!["SalesOrders","Quotes"].contains(r))return this.handleConvertedRecordError(r,a.id,t);if(e.clonedEntitydata=[],e.clonedEntitydata.push(a),e.layout=[],!w)if(a.Layout)w=a.Layout.id;else{var i=store.peekRecord("module",moduleRecordMapping[r].id).layouts.filter((function(e){return e.status>=0||"active"===e.status}))[0];w=i?i.id:w}e.layout.push(store.peekRecord("layout",w));const n=Lyte.registeredMixins["crm-view-utils"],d={};var l;return d.position="create_clone",d.layoutId=w,d.moduleName=r,e.custom_button&&e.custom_button.length&&(e.custom_button=n.filterButtonData(e.custom_button,d)),t||(l=this.fetchCustomGlobalData({moduleName:r,formState:"clone",featureInfo:this.loadResourcesOutput.featureInfo})),{initRoute:"clone",entityrecordData:e.clonedEntitydata?e.clonedEntitydata[0]:{},transitionData:s,layoutRules:e.layout_rule,validationRules:e.validation_rule,customButtons:e.custom_button,moduleData:p,moduleId:c,moduleName:r,formState:"clone",featureInfo:this&&this.loadResourcesOutput&&this.loadResourcesOutput.featureInfo,currsubformApinames:p.currsubformApinames?p.currsubformApinames:[],layoutddData:_,layoutddSelected:g,selectedLayoutid:w,moduleSections:e.layout[0].sections,layoutDet:e.layout,originalData:e.originalData||{},surveyDepartments:e.survey_departments?e.survey_departments:[],webinarIntegration:e.webinarIntegration?e.webinarIntegration:void 0,skyEyeIntegration:!!(e.skyEyeIntegration&&validationUtils.isNotEmpty(e.skyEyeIntegration)&&e.skyEyeIntegration.configured),orgTaxDetails:e.orgTaxDetails&&e.orgTaxDetails.length?e.orgTaxDetails:[],documentScrollNeeded:!0,fcCategory:e.fc_category?e.fc_category.stages:[],zorContributingFields:e.zorContributingFields,zorEnabled:e.zorEnabled,globalData:l}}.bind(this))},nonLyteModelHook:function(e){var{formViewType:t,dataparams:a,transitionData:r,transData:i,module_name:o,options:n,queryParams:s,modInfo:d,wizardSwitch:l,isThroughQc:u,lyteConvertionSupported:m,routeGlobalData:c}=e;switch(t){case"create":if(r.isWizard){this.currentModel||(r={isWizard:!0,selectedLayoutid:s.layoutId+";"+s.wizardId});var p={formViewType:t,transitionData:r,transData:i,module_name:o,options:n,dataparams:a,queryParams:s,modInfo:d,wizardSwitch:l,isThroughQc:u,lyteConvertionSupported:m,routeGlobalData:c};return this.lyteModelHook(p)}delete r.isWizard,Crm.requestParam=a;var y={};if(r.layoutId||s.layoutId){"Tasks"!==o&&(a.layoutId=r.layoutId?r.layoutId:s.layoutId),(new crmRequestPool).followOrder=!0;var h=(["U","A","C","Z"].contains(Crm.userDetails.LICENSE_TYPE)||Crm.userDetails.ULTIMATE_ADDON_COUNT>0)&&d&&d.api_supported&&Crm.userDetails.tabsUsedInWizards&&!window.clientPortalName&&-1!==Crm.userDetails.tabsUsedInWizards.indexOf(d.id);return(!this.currentModel||this.currentModel&&this.currentModel.model&&this.currentModel.model.module!==o)&&h&&(y.wizard=store.findAll("wizard",{module:moduleRecordMapping[o].api_name},!1)),y.model=networkUtils.lyteInitiateRequest(Crm.getCrmBasePath()+"/Create.do","GET",n),Lyte.resolvePromises(y)}if(!r.layoutId)return y.model=networkUtils.lyteInitiateRequest(Crm.getCrmBasePath()+"/Create.do","POST",n),d&&d.api_supported&&Crm.userDetails.tabsUsedInWizards&&!window.clientPortalName&&-1!==Crm.userDetails.tabsUsedInWizards.indexOf(d.id)&&(y.wizard=store.findAll("wizard",{module:moduleRecordMapping[o].api_name},!1)),Lyte.resolvePromises(y).then((function(e){return e&&e.wizard&&(moduleRecordMapping[o].wizard=e.wizard),e}));break;case"edit":return Crm.requestParam={},Crm.editReqFrom=r.reqFrom?r.reqFrom:r.returnAnchor||r.goTo?"":"listView",this.params=a,(y={}).editDo=networkUtils.lyteInitiateRequest(Crm.getCrmBasePath()+"/Edit.do","POST",n),s&&s.layoutId&&Crm.userDetails.isCanvasFormViewEnabled&&(y.canvasviews=app.store.makeRequest("findAll","canvasview",{module:moduleRecordMapping[o].api_name,feature:"FormView",layout_id:s.layoutId}).then((function(e){return e}),(function(){}))),Lyte.resolvePromises(y).then(function(e){return this.handleEditPromise(e.editDo,a)}.bind(this));case"clone":Crm.requestParam={};let e=Object.assign({},{id:a.id,module:a.module,format:a.format});return this.params=e,n.params=e,networkUtils.lyteInitiateRequest(Crm.getCrmBasePath()+"/Clone.do","GET",n)}},afterModelHook:function(e,t,a,r){a=a||{};var{module_name:i,entityRecordId:o,isThroughQc:n,lyteConvertionSupported:s,formViewType:d,targetRoute:l,routeGlobalData:u}=e;let m;if(n||(m=this.isCanvasViewRoute({targetRoute:l}),!m.breakExecution)){!this.isWizard&&!a.isWizard||s||(s=!0);var c=!!(u&&u.hasOwnProperty("preventCanvasExecution")&&u.preventCanvasExecution);if(!c&&"edit"===d&&Crm.userDetails.isCanvasFormViewEnabled&&!this.isWizard){var p=(w=store.peekAll("canvasview"))?w.length:0,y=r.redirect,h=r.layoutId;if(p&&"false"!==y){a.skipModuleReqTrigger=!0,(_={}).layoutId=h;var f=a.layoutId?a.layoutId:h,v="";b=Crm.userDetails.CLIENT_PROFILE_ID?Crm.userDetails.CLIENT_PROFILE_ID:store.peekRecord("user",Crm.userDetails.USER_ID).profile.id,"team_based"===moduleRecordMapping[i].access_type&&(b=moduleRecordMapping[i].private_profile.id);for(var g=0;g<p;g++)if(w[g].profiles.includes(b)&&"FormView"===w[g].feature&&w[g].layout.id===f){v=w[g].id;break}if(v&&t&&t.entityrecordData&&t.entityrecordData.id){if((D=a||{}).skipRecordFetch=!0,a.layoutId&&a.layoutName&&(D.layoutId=a.layoutId,D.layoutName=a.layoutName),D.skipDirtyCheck=!0,n)return{isAbortTransition:!0,isReplaceRoute:!0,extraInfo:{route:"crm.tab.module.entity.edit.canvas",dynamicParams:[i,t.entityrecordData.id,v],queryParams:_,transitionData:D}};this.transition.abort(),t.moduleData&&(D.moduleResponse=t.moduleData),this.replaceWith({route:"crm.tab.module.entity.edit.canvas",dynamicParams:[i,t.entityrecordData.id,v],queryParams:_}).data=D}}}if(!c&&"clone"===d&&Crm.userDetails.isCanvasFormViewEnabled){var w;p=(w=store.peekAll("canvasview"))?w.length:0,y=r.redirect;if(p&&"false"!==y){var _;a.skipModuleReqTrigger=!0,(_={}).layoutId=r.layoutId;var b;v="";b=Crm.userDetails.CLIENT_PROFILE_ID?Crm.userDetails.CLIENT_PROFILE_ID:store.peekRecord("user",Crm.userDetails.USER_ID).profile.id;for(g=0;g<p;g++)if(w[g].profiles.includes(b)&&"FormView"===w[g].feature&&w[g].layout.id===_.layoutId){v=w[g].id;break}if(v){if(n)return{isAbortTransition:!0,isReplaceRoute:!0,extraInfo:{route:"crm.tab.module.entity.clone.canvas",dynamicParams:[i,o,v],queryParams:_,transitionData:{skipRecordFetch:!0}}};this.transition.abort();var D={skipRecordFetch:!0,skipDirtyCheck:!0};t.moduleData&&(D.moduleResponse=t.moduleData),this.replaceWith({route:"crm.tab.module.entity.clone.canvas",dynamicParams:[i,o,v],queryParams:_}).data=D}}}return s?this.handleLyteCreateAfterModelchanges(t,i,d,e):this.nonLyteAfterModelHook({model:t,formViewType:d,transitionData:a})}},nonLyteAfterModelHook:function(e){var{transitionData:t,model:a,formViewType:r}=e,i=a?a.model&&a.model.title?a.model.title:a.title||"":"";i&&this.setTitle(i);var o={},a=a||{},n=Crm.getCrmBasePath();switch(r){case"create":a.model&&a.model.webinar_trial_expired&&this.handleWebinarTrialExpiry(a),a.model&&"crm.error.services.limit"===a.model.error&&(renderingUtils.showCustomAlert(I18n.getMsg("crm.error.services.limit",moduleRecordMapping.Appointments.singular_label),"",!1),this.transition.abort()),("crm.campaign.integ.sandbox.not.supported"===a.error||a.model&&"crm.campaign.integ.sandbox.not.supported"===a.model.error)&&(crmui.showMsgBand("error",I18n.getMsg("crm.campaign.integ.sandbox.not.supported",crmTab.getDisplayName("Campaigns",!1).toLowerCase()),3e3),this.transition.abort(),this.transitionTo({route:"crm.tab.module.custom-view.list",dynamicParams:app.prevTransition.dynamicParams})),a.model&&(a=a.model),o=Crm.requestParam,a.isCreateChildCampaign=t.isCreateChildCampaign,n+="/Create.do?format=json&module="+o.module;break;case"edit":a.webinar_trial_expired&&this.handleWebinarTrialExpiry(a),n+="/Edit.do?format=json&module="+(o=this.params).module+"&id="+o.id;break;case"clone":"crm.error.services.limit"===a.error&&(renderingUtils.showCustomAlert(I18n.getMsg("crm.error.services.limit",moduleRecordMapping.Appointments.singular_label),"",!1),this.transition.abort()),n+="/Clone.do?format=json&module="+(o=this.params).module+"&id="+o.id}n+=o.layoutId?"&layoutId="+o.layoutId:"",(void 0===Crm.userDetails.VALIDATIONRULEAVAILABLE||!0===Crm.userDetails.VALIDATIONRULEAVAILABLE&&Crm.userDetails.VRINVOLVEDMODULES.contains(o.module))&&Crm.downloadValidationRules(n,o.module)},redirectHook:function(e){var{isThroughQc:t,targetRoute:a,module_name:r,formViewType:i,entityRecordId:o,currentTransition:n}=e;let s,d,l,u;if(!t&&app.prevTransition){switch(i){case"create":u=r,l=0,s="crm.tab.module.create.canvas",d="crm.tab.module.create";break;case"edit":u=o,l=1,s="crm.tab.module.entity.edit.canvas",d="crm.tab.module.entity.edit";break;case"clone":u=o,l=1,s="crm.tab.module.entity.clone.canvas",d="crm.tab.module.entity.clone"}app.prevTransition.route===s&&a===d&&u===app.prevTransition.dynamicParams[l]&&(this.refresh({refreshTemplate:!0}).data=n.data)}},renderTemplateHook:function(e,t,a){var{isThroughQc:r,lyteConvertionSupported:i,module_name:o,formViewType:n,entityRecordId:s}=e,d=this.renderTemplateHookInitial(e,t,a);if(d&&d.breakExecution)return delete d.breakExecution,r?d:void 0;var{transitionData:l,model:a}=d||{},u={module_name:o,isThroughQc:r,lyteConvertionSupported:i,model:a,transitionData:l,formViewType:n,entityRecordId:s};return(l.isWizard||this.isWizard)&&(i=!0,renderingUtils.removeFreezeLayer()),i?this.lyteRenderTemplateHook(u):this.nonLyteRenderTemplateHook(u)},nonLyteRenderTemplateHook:function(e){var t,{module_name:a,model:r,transitionData:i,formViewType:o,entityRecordId:n}=e,s=function(){var e="create"===o?this.currentModel.model.entityMapJson.SMOWNERID:this.currentModel.entityMapJson.SMOWNERID;if(e){var t="#"+ZSEC.Encoder.encodeForHTML(a)+"_fldRow_SMOWNERID";"Products"===a&&(t="#"+ZSEC.Encoder.encodeForHTML(a)+"_fldRow_HANDLER"),this.getRestrictionInfo(a,e.defaultid,"edit"===o&&n?n:void 0).then((function(e){if($("crm-threshold-grant").remove(),!1===e.allow){var r=document.createElement("crm-threshold-grant"),i=$(t+" .labelValCreate"),o=i.position().left,n=i.width();Crm.userDetails.RTL_ENABLED&&(o=-$(t+" .labelTabCreate").outerWidth());var s="position:relative;left:"+o+"px;width:"+n+"px;top:10px";return r.setData("rsGrantStyle",s),r.setData("moduleName",a),i.after(r),void commonUtils.showHideLoadingDiv()}}))}};switch(o){case"create":if("string"==typeof r)return{outlet:"#show",html:r};if(!i.selectedLayoutId)if((u=Crm.getModuleObj(a)).currentStatus="create",u.createTemplate(r),r.productLineItems){if(Crm.userDetails.isLookupAdvancedSearchEnabled){var d=r.productLineItems;d.fieldMeta=r.entityMapJson.PRODUCTDETAILS,productDetails.setValuesForAddedRowForEdit(d,void 0,void 0,void 0,!0)}else productDetails.setValuesForAddedRowForEdit(r.productLineItems,void 0,void 0,void 0,!0);productDetails.grandTaxChanged=!0;var l=$("#productList").find(".pB20");l.show(),l.find(".wrap").show(),$("#addLinesBtnLwr").hide(),loadClassFns1(),loadClassFns2(),productDetails.fillCurrencySymbolsInLineHeaders(),productDetails.fillCurrSymForGrandVals()}s.call(this),t=Crm.requestParam,Crm.executeLayoutRule(Crm.getCrmBasePath()+"/Create.do",t,"edit"),renderingUtils.removeFreezeLayer();break;case"edit":if(t=i,r.responseText)return{outlet:"#show",html:r.responseText};if("string"==typeof r)return{outlet:"#show",html:r};window[a].currentStatus="edit",window[a].entityId=n,(u=Crm.getModuleObj(a)).edit(n,r,t),r.approval_buttons&&0!==r.approval_buttons.length&&$L("#saveAndNew"+a+"Btn").hide(),"Events"!==a&&"true"!==$("#iskanbanview").val()&&(crmTab.updateTabContent(t.module),t.validationRequest&&"true"===t.validationRequest&&($("#saveAndNew"+t.module+"Btn").hide(),$("#save"+t.module+"Btn").val(I18n.getMsg("crm.validation.rule.approve.and.save.entity")).data("fromValidation",!0),$("#saveAndNew"+t.module+"Btn_Bottom").hide(),$("#save"+t.module+"Btn_Bottom").val(I18n.getMsg("crm.validation.rule.approve.and.save.entity")).data("fromValidation",!0))),s.call(this),Crm.executeLayoutRule(Crm.getCrmBasePath()+"/Edit.do",this.params,"edit"),isGlobalSearch(event)&&"Events"!==a&&adSearchClose();break;case"clone":var u;window[a].currentStatus="clone",(u=Crm.getModuleObj(a)).createTemplate(r),Crm.executeLayoutRule(Crm.getCrmBasePath()+"/Clone.do",this.params,"edit"),s.call(this)}},lyteRenderTemplateHook:function(e){var{module_name:t,isThroughQc:a,model:r,transitionData:i,formViewType:o,entityRecordId:n}=e;if("create"===o&&i.isWizard){const e=r.wizardId.split(";")[0],i=r.wizardId.split(";")[1];let o=store.peekRecord("wizard",i);if(o&&!o.active||!o){var s={is_Error:!0,errorId:"1",errorFrom:"common",data:{i18nKey:I18n.getMsg("crm.settings.wizard.not.found.heading"),module_name:t}};return a?s:void this.handleTransitionAbortErrors(s)}let n=store.peekRecord("layout",e);if(!n){s={is_Error:!0,errorId:"1",errorFrom:"common",data:{i18nKey:I18n.getMsg("crm.settings.wizard.layout.not.found.desc"),module_name:t}};return a?s:void this.handleTransitionAbortErrors(s)}var d,l,u=moduleRecordMapping[t];if("team_based"===u.access_type?(d=u.private_profile.name,l=u.private_profile.id):(d=Crm.userDetails.PROFILE_NAME,l=Crm.userDetails.PROFILE_ID),!window.clientPortalName&&(0===n.profiles.filter((function(e){return e.name===d})).length||0===o.profiles.filter((function(e){return e.name===d})).length)||window.clientPortalName&&0===o.portal_user_types.filter((function(e){return e.id===l})).length){s={is_Error:!0,errorId:"1",errorFrom:"common",data:{i18nKey:I18n.getMsg("crm.wizard.no.view.permission"),module_name:t}};return a?s:void this.handleTransitionAbortErrors(s)}}if(("create"===o||"clone"===o)&&(this.isInvalidLayoutError||this.isLayoutPermissionError)){var m=this.isInvalidLayoutError?I18n.getMsg("crm.label.layoutdelete"):I18n.getMsg("crm.label.layoutpermis");delete this.isInvalidLayoutError,delete this.isLayoutPermissionError;s={is_Error:!0,errorId:"1",errorFrom:"common",data:{i18nKey:m,module_name:t}};return a?s:(this.handleTransitionAbortErrors(s),null)}if(window[t]||(window[t]=Object.create(crmCommonModule),window[t].moduleName=t),window[t]&&(window[t].currentStatus=o),n&&"edit"===o&&(window[t].entityId=n),a)return{renderTemplateStatus:"successful"};var c={outlet:"#show",component:"crm-create-entity",reRender:!0};if(commonUtils.showHideLoadingDiv(!1),"edit"===o)return c;app.renderTemplate(this,c),renderingUtils.removeFreezeLayer()},afterRenderHook:function(e,t,a){if(Lyte.registeredMixins["crm-keyboard-shortcutsmixin"]&&Lyte.registeredMixins["crm-keyboard-shortcutsmixin"].bindShortcutsAfterRender("Record's Create/Edit/Clone Page"),requestAnimationFrame((function(){requestAnimationFrame((function(){setTimeout((function(){if(!(!!Crm.userDetails.isAccessibilityConfigSupported&&Lyte.Service.getInjected("globalAccessibilityServices").getVariable("standardNavigationOrder"))){var e=$L(".createSectionsContainer").find("crm-create-sections"),t=e.length;if(e&&t>0)for(var a=0;a<t;a++)if(!e[a].querySelector("crm-create-avatarupload")&&"block"===e[a].querySelector(".crm-cs-inner").style.display){var r=e[a].component.data.layoutData.tab_traversal;if(1!==r)var i=e[a].component.data.layoutData.fields;else i=e[a].querySelectorAll("crm-create-fields");for(var o=i.length,n=0;n<o;n++){var s=i[n].component?i[n].component.data.readonly:i[n].read_only;if(i[n]&&!s){var d=1!==r?"#"+e[a].component.data.moduleName+"_fldRow_"+i[n].column_name:"";d?e[a].querySelector(d+" [data-tabindex]").focus():i[n].querySelector("[data-tabindex]").focus();break}}break}}}),0)}))})),a.fromKanbanView&&a.picklistFieldId&&a.picklistFieldValueId){var r=t.moduleSections.record.fields,i=a.picklistFieldId,o=a.picklistFieldValueId,n=$L("crm-create-layout")[0].component.data.dataBind,s=function(t,a){if(t&&a){var i=r.filterBy({id:t})[0];if(i){var o=i.pick_list_values.find((e=>e.id===a));if(o){n.$.set(i.api_name,o.display_value);var s=e.module_name+"_fldRow_"+i.column_name,d=$L("#"+s);d&&d[0]&&d[0].component.executeMethod("getDropdownvalue",void 0,o.display_value,!1,!1)}}}};if(("Potentials"===t.moduleName||"Deals"===t.moduleName)&&a.showPipeline)s(r.filterBy({api_name:"Pipeline"})[0].id,a.pipelineFieldValueId);s(i,o)}var{lyteConvertionSupported:d,isThroughQc:l,module_name:u,formViewType:m,routeGlobalData:c}=e;e.transData=a,"edit"===m&&"crm.tab.module.entity.edit.canvas"===e.targetRoute||(l||"create"!==m||(Lyte._ignoreOnReady=!1),(a.isWizard||this.isWizard)&&(d=!0),renderingUtils.removeFreezeLayer(),commonUtils.showHideLoadingDiv(!1),"edit"===m&&this.afterRenderHookCommon(e,t),t=t||{},d?this.lyteAfterRenderHook({isThroughQc:l,module_name:u,transData:a,model:t,formViewType:m,routeGlobalData:c}):this.nonLyteAfterRenderHook({module_name:u,transData:a,model:t,formViewType:m,routeGlobalData:c}),"create"===m&&this.afterRenderHookCommon(e,t))},lyteAfterRenderHook:function(e){var{module_name:t,transData:a,model:r,formViewType:i}=e;if("create"===i){if("Campaigns"===t&&r.moduleData&&r.moduleData.layouts.length)for(var o=r.selectedLayoutid,n=r.moduleData.layouts,s=n.length,d=a&&"Campaigns"===a.primmodule&&a.entityid,l=0;l<s;l++){var u=n[l];if(o===u.id){if(d||!u.created_by){var m=d?"Child_Campaign_relatedList":"Campaign_listView";crmListView.trackCampaignCreatePage(m,u.name)}(2===u.status&&"active"===u.status||"campaign_integration"===u.source)&&crmTemplate.handleSenderAddressErrorForZohoCampaigns(u);break}}}else if("edit"===i&&this.currentModel&&this.currentModel.entityrecordData&&this.currentModel.entityrecordData.$zia_visions){var c={};function p(e){switch(e){case"zia_vision_validation":e="image_processing";break;case"zia_vision_pending":e="create_without_image";break;case"zia_vision_rejected":e="do_not_create";break;default:e="image_approval"}return e}(this.currentModel.entityrecordData.$zia_visions.length?this.currentModel.entityrecordData.$zia_visions:[]).forEach(function(e){if(e&&e.field){var t=store.peekRecord("field",e.field.id);if(t){var a=[];if("profileimage"===t.data_type)a.push({failure_action:p(),visionApproval_id:e.vision_approvals.id,vision_id:e.id});else if("imageupload"===t.data_type){var r=this.currentModel.entityrecordData[e.field.api_name];r&&r.length&&r.forEach(function(t){a.push({attachment_id:t.id,failure_action:p(this.currentModel.entityrecordData.$approval_state),visionApproval_id:e.vision_approvals.id,vision_id:e.id})}.bind(this))}a&&a.length&&(c[e.field.api_name]=a)}}}.bind(this)),Object.keys(c).length&&(this.currentModel.vision_approvals=c)}},nonLyteAfterRenderHook:function(e){var{module_name:t,transData:a,model:r,formViewType:i}=e;if(!a.isWizard){if("create"===i){var o=window.location.hash;if(o.length>0)(o=o.substring(1,o.length)).split("#").each((function(e){var t=e.split("=");if(2===t.length){var a,r=t[0],i=t[1];if(i.indexOf("||-||-||")>0){var o=i.split("||-||-||");2===o.length&&(i=o[0],a=o[1])}i=decodeURIComponent(i),(r=$("#"+r)).val(i),a&&r.data("id",a)}}));if("Campaigns"===t&&r.model&&r.model.layout_jsonarrayObj)for(var n=r.model.layout_jsonarrayObj.currLayoutId,s=r.model.layout_jsonarrayObj.layout_jsonarrayObj,d=s.length,l=a&&"Campaigns"===a.primmodule&&a.entityid,u=0;u<d;u++){var m=s[u];if(n===m.LAYOUTID){if(l||"12"===m.SOURCE){var c=l?"Child_Campaign_relatedList":"Campaign_listView";crmListView.trackCampaignCreatePage(c,m.LAYOUTNAME)}"12"===m.SOURCE&&crmTemplate.handleSenderAddressErrorForZohoCampaigns(r.model);break}}}CScriptLib&&CScript.Engine.Global.dispatchEvent("onLoad")}},afterRenderHookCommon:function(e,t){var{module_name:a,transData:r,entityRecordId:i,formViewType:o}=e;if("create"===o){Crm.userDetails.isStorageLimitReached&&Crm.showStorageExceedPopup("new_page");try{if(renderingUtils.windowWidth<=1200&&["Leads","Contacts","Accounts","Potentials"].includes(a)){var n=navigator.userAgent.toLowerCase(),s={place:"Create page - "+a};n.includes("iphone")?s.tab_device="iPhone":n.includes("ipad")?s.tab_device="iPad":n.includes("android")&&(s.tab_device="Android"),renderingUtils.windowWidth<=1200&&renderingUtils.windowWidth>1e3?s.widthRange="below 1200":renderingUtils.windowWidth<=1e3&&renderingUtils.windowWidth>900?s.widthRange="below 1000":renderingUtils.windowWidth<=900&&(s.widthRange="below 900"),renderingUtils.windowWidth>renderingUtils.windowHeight&&(s.isLandscape=!0),Crm.trackSpotLightAction("Tab Device tracking",s)}}catch(e){murphy.error(e)}}else if("edit"===o){if(t.vision_approvals&&t.vision_approvals.Record_Image){var d=$L(".photoUploadSec");d.addClass("cP");var l=Crm.getVisionMyJobsDependency();Lyte.injectResources(l,void 0,(function(){!function(e){var t=$L(".lnPhoto");t.find("img").hide(),"image_processing"===e.vision_approvals.Record_Image[0].failure_action?(t.addClass("lnPhoto_ziaVision lnPhoto_ziaVision_processing"),d.attr({onclick:"detailView.renderVisionErrorPopUp('"+e.vision_approvals.Record_Image[0].failure_action+"')",onmouseover:"crmui.showTooltip('"+I18n.getMsg("crm.zia.vision.processing.image")+"')",onmouseleave:"crmui.hideTooltip();"}),Lyte.Component.render("crm-zia-vision-error-popup",{action:e.vision_approvals.Record_Image[0].failure_action},"#zia-vision-popup")):(t.addClass("lnPhoto_ziaVision"),d.attr({onclick:"detailView.renderVisionErrorPopUp('"+e.vision_approvals.Record_Image[0].failure_action+"','"+e.module+"','"+e.entityId+"','"+e.vision_approvals.Record_Image[0].vision_id+"','"+e.vision_approvals.Record_Image[0].visionApproval_id+"',true,"+!1+")",onmouseover:"crmui.showTooltip('"+I18n.getMsg("crm.zia.vision.validation.failure.msg")+"')",onmouseleave:"crmui.hideTooltip();"}))}(t)}))}var u="/crm/v7/"+moduleRecordMapping[a].api_name+"/"+i+"/actions/zia_insights?keys=vision_data";t.vision_data=void 0,app.store.makeRequest("sendXHR",u,"GET").then((function(e){var a=JSON.parse(e.responseText).zia_insights,r=a.vision_data?a.vision_data:void 0,i=$("crm-create-entity");i&&i[0]&&"edit"===i[0].getData("initRoute")&&i[0].setData("vision_data",r),t.vision_data=r}));var m=!1;if(store.peekAll("module").forEach((function(e){"Projects"===e.api_name&&e.visible&&(m=!0)})),m){var c=Lyte.Router.getRouteInstance(),p=c.parent.getDynamicParam(),y=c.parent&&c.parent.parent?c.parent.parent.getDynamicParam():null;$L(".projectsTaskSyncBtn").hide();var h=$L("#Crm_Tasks_SEID");if($L("#Crm_Tasks_CONTACTID").keyup((function(){var e=$L("#Crm_Tasks_CONTACTID");""===$L("#Crm_Tasks_SEID").val()&&""===e.val()&&$L(".projectsTaskSyncBtn").hide()})),h.keyup((function(){var e=$("#Crm_Tasks_SEID"),t=e.attr("id"),a=$("#Crm_Tasks_CONTACTID").val(),r=$("#Crm_Tasks_CONTACTID_WhoId_select option:selected").val();store.peekRecord("crm-project-sync-task",p).module!==crmModuleConstants.Potentials&&r===crmModuleConstants.Contacts&&""===a&&(""===e.val()||crmLookupAutoComplete.searchModule===crmModuleConstants.Accounts&&null!==t&&t.indexOf("CF")<0)&&$L(".projectsTaskSyncBtn").hide()})),null!==y&&"Activities"===y){var f=$(".projectsTaskSyncBtn"),v=store.peekRecord("crm-project-sync-task",p);void 0!==p&&v?(null!==v.firstSelectedProject&&"TASK_NOT_SYNCED"===v.code?f.show():f.hide(),f.attr("disabled",!!crmTasks.isRecurringSet()).attr("title",crmTasks.isRecurringSet()?"Recurring task cannot be pushed to Projects":"")):f.hide()}}else $(".projectsTaskSyncBtn").hide();var g=(v=objectUtils.cloneObject(r)).reqFrom?v.reqFrom:v.returnAnchor||v.goTo?"":"listView";if(v.fromKv&&crmTab.isZBCustomModule(a)||crmTab.isZSCustomModule(a)){if("true"===$("#iskanbanview").val()){PAGE_CACHE[a]&&PAGE_CACHE[a].New&&delete PAGE_CACHE[a].New;var w=document.getElementById("mapValues");w&&w.parentNode.removeChild(w)}if("kvlistview"===g&&0===TaskKanbanView.kvrecordid){var _=$(targetElem).closest(".kvtlistbgheader").attr("id");$("#kvType").val(_),taskDetailsview.listAnimation("open")}$("#cvEditSave").show()}$("#forEditViewScroll").change(function(){this.isDirtyForm=!0}.bind(this))}},getRestrictionInfo:function(e,t,a){return Lyte.registeredMixins["crm-assignment-threshold-common"].restrictionGrantCheck(e,t,a)},isCanvasViewRoute:function(e){let t={};return e.targetRoute&&["crm.tab.module.entity.clone.canvas","crm.tab.module.entity.edit.canvas","crm.tab.module.create.canvas"].includes(e.targetRoute)&&(t={breakExecution:!0,targetRoute:e.targetRoute,isCanvas:!0}),t},handleWebinarTrialExpiry:function(e,t){var a=networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("zohowebinar")],ResourceConstants.CRM),r=networkUtils.returnDependencyFiles(["crm-webinar-common.js","crm-webinar-data-store.js"],ResourceConstants.CRMClient),i=networkUtils.returnDependencyFiles(["crm-webinar-common.css"],ResourceConstants.CRMClient),o={is_Error:!0,errorId:"2",errorFrom:"common",data:{resources:r.concat(i),component:"crm-webinar-trial-expiry-modal",componentData:e,componentRenderLoc:"#show"}};if(t)return o;this.handleTransitionAbortErrors?this.handleTransitionAbortErrors(o):Lyte.injectResources(a.concat(r.concat(i)),void 0,(function(){Lyte.Component.render("crm-webinar-trial-expiry-modal",e,"#show")})),this.transition.abort()},getCreateRouteBasicDataProps:function(e){let t,a=this.parent.getDynamicParam();return"Activities"===a&&e&&(t=a,a=this.parent.getQueryParams().sub_module),{module_name:a,targetRoute:this.transition.target,parentModuleName:t,formViewType:"create",lyteConvertionSupported:this.lyteConvertionSupported,transitionInfo:this.transition.info,currentTransition:this.transition}},getEditCloneRouteBasicDataProps:function(e,t){let a,r=this.parent.parent.getDynamicParam();return"Activities"===r&&e&&(a=r,r=this.parent.parent.getQueryParams().sub_module),{module_name:r,targetRoute:this.transition.target,transitionInfo:this.transition.info,lyteConvertionSupported:this.lyteConvertionSupported,formViewType:t,entityRecordId:this.parent.getDynamicParam(),parentModuleName:a}}});
