Lyte.Mixin.register("crm-validationrule-utils",{onErrorMsgDisplay:function(e,t,a,r,o){if(o&&o.callback)o.callback.error(e);else{r=r||{};var i=t.isInventoryModule&&t.isInventoryModule(t.data.module);if(!(a||i&&-1!==["DISCOUNT","TAX"].indexOf(t.getData("ajaxEditFieldMeta").column_name)||r.taskClose)){var l=$L("#"+t.getData("ajaxEditFieldMeta").$ids.valueId);a=l[0].component}if(r.taskClose){var s=$L("crm-task-invalid-popup");0===s.length?s.push(Lyte.Component.render("crm-task-invalid-popup",{errArr:e,renderPop:!0,multiError:!0},"#basic")):s[0].setData({errArr:e,renderPop:!0,multiError:!0})}else{t.setData("rules_execution_result.vr_exec_result",{});var n={},d=[];e.forEach((function(e){if("on_primary_field"===e.alert_preference){var r=store.peekRecord("field",e.targetFieldId);if(i&&r&&r.subform&&-1!==["DISCOUNT","TAX"].indexOf(r.column_name))_cruxUtils.showCustomMessage({params:{ltPropType:"error",ltPropDuration:"4000",ltPropMessage:I18n.getMsg("error.database.problem")}});else{a.setData("cxPropErrorMessage"," ");var o=[];o.push(e),n&&n.hasOwnProperty(e.targetFieldId)?((o=n[e.targetFieldId]).push(e),n[e.targetFieldId]=o):n[e.targetFieldId]=o}}else"top_of_page"===e.alert_preference&&(d.push(e.message),t.setData("hasErrOnTopOfPage",!0))})),this.displayTopErrorMessage(d,r.displayType),Object.keys(n).length>0&&t.setData("rules_execution_result.vr_exec_result",n)}}},displayTopErrorMessage:function(e,t){if(t&&e.length>0){var a="<div class=\"crm-small-font-size lh15 w100_per\"><div class='darkSecHead'>"+I18n.getMsg("crm.validation.rule.topLink")+"</div>";let t='<div class="vr_topErrItem errorMsgNew"><span class="crmErrorBullet mT1 dIB mB10">';1===e.length&&(t='<div class="vr_topErrItem errorMsgNew"><span class="mT1 dIB">');let r="</span></div>";for(errorMsg of e)a+=t+$ESAPI.encoder().encodeForHTML(errorMsg)+r;a+="</div>",_cruxUtils.showCustomMessage({params:{ltPropYield:!0,ltPropMessage:a,ltPropType:"error",ltPropShow:!0,ltPropClass:"vr_topErrMsgBox",ltPropCloseManually:!0}})}},checkForLookup:function(e,t,a){var r=!1;"lookup"===store.peekRecord("field",t).data_type&&(r=!0,e.split(".")[0]!==a&&(r=!1));return r},displayCustomErrorMessageOnTop:function(e,t){var a=e&&e.message?e.message:"";if(t&&e){a="";var r=e.length;if(1===r)a='<span class="crmNegativeColor dIB">'+$ESAPI.encoder().encodeForHTML(e[0].message)+"</span>";else{a+='<div class="mT18">';for(var o=0;o<r;o++)a+='<div class="crmErrorBullet mB16">'+$ESAPI.encoder().encodeForHTML(e[o].message)+"</div>";a+="</div>"}}_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.validation.rule.invalid.entry.alertmsg.title"),ltPropYield:!0,ltPropSecondaryMessage:a}})}}),Lyte.Component.register("crm-validation-rule-error",{_template:'<template tag-name="crm-validation-rule-error"> <div class="dF flexDC pRI mT4"> <template is="for" items="{{priErrArr}}" item="item" index="index"> <span class="dIB crm-extra-small-font-size wbBreakWord lh15 {{if(expHandlers(alertShow.length,\'>\',1),\'crmErrorBullet\',\'red\')}} {{if(expHandlers(expHandlers(priErrArr.length,\'-\',1),\'===\',index),\'mB0\',\'mB8\')}}"> <template is="if" value="{{accessibilityConfig.accessibility.vision.custom_error.alert_icon}}"><template case="true"> <span class="zcicncss-warning-triangle zcicn-cssIcons pR top2 mR3 customErrorNegativeIcon"></span> </template></template> {{item.message}} </span> </template> <template is="for" items="{{abaErrArr}}" item="item" index="index"> <span class="dIB vr_revBulletDesc crm-small-font-size maxW95per crmErrorBullet wbBreakAll {{if(expHandlers(expHandlers(abaErrArr.length,\'-\',1),\'===\',index),\'mB0\',\'mB8\')}}"> {{item.message}} </span> </template> </div> </template>',_dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[]}},default:{}},{type:"text",position:[1,3]}]},{type:"attr",position:[1,3]},{type:"for",position:[1,3],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]}],_observedAttributes:["alertDetails","alertShow","fieldId","onPrimary","priErrArr","topErrArr","abaErrArr","accessibilityConfig"],data:function(){return{alertDetails:Lyte.attr("object"),alertShow:Lyte.attr("array",{default:[]}),fieldId:Lyte.attr("string"),onPrimary:Lyte.attr("boolean",{default:!0}),priErrArr:Lyte.attr("array",{default:[]}),topErrArr:Lyte.attr("array",{default:[]}),abaErrArr:Lyte.attr("array",{default:[]}),accessibilityConfig:Lyte.attr("object")}},init:function(){var e=this.getData("alertDetails"),t=this.getData("alertShow"),a=this.getData("fieldId"),r=this.getData("onPrimary");if(e?t=r?a?e[a]:e[e.fieldId]:e.valError:this.setData("alertDetails",void 0),t&&t instanceof Object&&t.length>0){var o=t.filter((function(e){return"on_primary_field"===e.alert_preference})),i=t.filter((function(e){return"top_of_page"===e.alert_preference})),l=t.filter((function(e){return"allow_by_alert"===e.alert_type}));this.setData({priErrArr:o,topErrArr:i,abaErrArr:l})}else if(t.length>0){o=[];var s={};Lyte.objectUtils(s,"add","message",t),Lyte.arrayUtils(o,"push",s),this.setData("priErrArr",o)}this.setData("alertShow",t)},didConnect:function(){let e=$L("#formRuleMandatoryFields"),t=$L("#VRAjaxEdit"),a=$L("#closedWon");e.length&&commonUtils.setErrVerifyContHeightToParent(e,!1,!1),t.length&&commonUtils.setErrVerifyContHeightToParent($L(this.$node).closest(".tabDivCreate"),!0,!1),a.length&&commonUtils.setErrVerifyContHeightToParent(a,!1,!1),Crm.userDetails.isAccessibilityConfigSupported&&this.setData("accessibilityConfig",Lyte.Service.getInjected("globalAccessibilityServices").getVariable("accessibility"))},actions:{},methods:{}}),Lyte.Component.register("crm-validation-allowalert",{_template:'<template tag-name="crm-validation-allowalert"> <div id="valAllowAlert"> <template is="for" items="{{allowAlertDet}}" item="item" index="index"> <div class="vr_vrRevAlertItem {{if(expHandlers(expHandlers(allowAlertDet.length,\'-\',1),\'===\',index),\'\',\'bBccc mB15 pB20\')}}"> <crm-validation-rule-error alert-details="{{item}}" field-id="{{item.id}}" on-primary="false"></crm-validation-rule-error> <div class="mT8 dF aiCenter pL10"> <span class="pR10 crmLabelColor">{{item.field_label}}</span> <template is="if" value="{{expHandlers(expHandlers(expHandlers(item.value,\'===\',&quot;&quot;),\'||\',expHandlers(item.value,\'===\',&quot;-None-&quot;)),\'||\',expHandlers(item.value,\'!\'))}}"><template case="true"> <span class="vr_abaEmpty"> <crmutil-icon icon-name="hyphen" icon-class="zcicn-hyphen zcicn_grey" class="pB2 vaM"></crmutil-icon> </span> </template><template case="false"> <span class="wbBreakWord {{if(item.isValueWithBg,\'vr_abaLabelWithBg br14 pT3 pB3 pL10 pR10\',\'\')}}" style="{{item.color}}">{{item.value}}</span> </template></template> </div> </div> </template> </div> </template>',_dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"componentDynamic",position:[1,1]},{type:"text",position:[1,3,1,0]},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"componentDynamic",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[1],attr:{style:{name:"style",dynamicValue:"item.color"}}},{type:"text",position:[1,0]}]}},default:{}}]}],_observedAttributes:["allowAlertDet","layoutData","isValueWithBg"],data:function(){return{allowAlertDet:Lyte.attr("array"),layoutData:Lyte.attr("object"),isValueWithBg:Lyte.attr("boolean",{default:!1})}},actions:{},methods:{}}),Lyte.Component.register("crm-validation-alert",{_template:'<template id="crm-validation-alert" tag-name="crm-validation-alert"> <template is="if" value="{{alertTOPBool}}"><template case="true"> <span id="vr_topErrBtn{{if(isCQC,\'_QC\',\'\')}}" class="boxBB cP br4 dIF mR12 pR mL10 aiCenter jcCenter crm-small-font-size vr_topErrBtn" onclick="{{action(\'openPopover\')}}"> <span class="zcicncss-warning-triangle zcicn-cssIcons zcicn_red_mask"></span> <span class="pL5 pR5 tdUnderline crm-font-regular">{{getI18n(\'crm.validation.rule.topLink\')}}</span> </span> <lyte-popover id="vr_topErrPopover" lt-prop-origin-elem="#vr_topErrBtn{{if(isCQC,\'_QC\',\'\')}}" lt-prop-duration="400" lt-prop-content-padding="0px 15px 15px" lt-prop-header-padding="15px 15px 10px 15px" lt-prop-footer-padding="6px 30px" lt-prop-window-spacing="{&quot;top&quot;:&quot;30&quot;,&quot;left&quot;:&quot;30&quot;,&quot;bottom&quot;:&quot;30&quot;,&quot;right&quot;:&quot;30&quot;}" lt-prop-type="box" lt-prop-freeze="false" lt-prop-dimmer="{&quot;opacity&quot;:&quot;0&quot;}" lt-prop-placement="{{popoverDirection}}" lt-prop-max-height="300px" lt-prop-max-width="600px" lt-prop-allow-multiple="true" lt-prop-wrapper-class="vr_topErrPopoverWrapper" lt-prop-force-scroll="true" on-close="{{method(&quot;closePopover&quot;)}}" on-show="{{method(&quot;quickCreatClosePop&quot;)}}" lt-prop-show="{{expHandlers(errorsCheck,\'&amp;&amp;\',closedPop)}}"> <template is="registerYield" yield-name="popover"> <lyte-popover-header> <span class="crm-small-font-size dIB mT5 mR40 crmBaseColor">{{getI18n(\'crm.validation.rule.topHeading\')}}</span> </lyte-popover-header> <lyte-popover-content> <div class="oA crm-small-font-size"> <template is="for" items="{{alertTOPMsg}}" item="item" index="index"> <div class="vr_topErrPop"> <span class="mT2 wbBreakWord {{if(expHandlers(alertTOPMsg.length,\'>\',1),\'crmErrorBullet\',\'crmNegativeColor\')}} {{if(expHandlers(expHandlers(alertTOPMsg.length,\'-\',1),\'===\',index),\'mB0\',\'mB8\')}} dB">{{item}}</span> </div> </template> </div> </lyte-popover-content> </template> </lyte-popover> </template></template> <lyte-modal lt-prop-height="auto" lt-prop-transition="{&quot;animation&quot;:&quot;slideFromTop&quot;,&quot;duration&quot;:&quot;0.5s&quot;}" lt-prop-offset="{&quot;top&quot;:&quot;0px&quot;,&quot;left&quot;:&quot;center&quot;}" lt-prop-width="600px" lt-prop-max-height="90%" lt-prop-show="{{allowAlertOnly}}" lt-prop-scrollable="true" lt-prop-show-close-button="false" on-show="{{method(\'onAbaShow\')}}" on-close="{{method(\'onAlertClose\')}}" on-before-close="{{method(\'onAlertBeforeClose\')}}"> <template is="registerYield" yield-name="modal"> <lyte-modal-header class="pB20"> <div class="aiCenter dF gap10"> <span class="zcicncss-warningalert zcicn-cssIcons zcicn_sandal_mask"></span> <h2 class="pB0">{{getI18n(\'crm.validation.rule.abaheading\')}}</h2> </div> <span class="pL33 crm-extra-medium-font-size crm-font-regular crmParagraphColor mT10 dIB">{{getI18n(\'crm.validation.rule.abaContent\')}}</span> </lyte-modal-header> <lyte-modal-content class="pT0 pL65"> <crm-validation-allowalert allow-alert-det="{{allowAlertDet}}" layout-data="{{layoutData}}"></crm-validation-allowalert> <div class="alignLeft crm-font-bold mT20 fwBold">{{getI18n(\'crm.validation.rule.abaConfirm\')}}</div> </lyte-modal-content> <lyte-modal-footer class="right"> <lyte-button data-zcqa="aba_cancel" onclick="{{action(\'alertClose\')}}"> <template is="registerYield" yield-name="text"> {{getI18n(\'Cancel\')}} </template> </lyte-button> <lyte-button data-zcqa="aba_save" onclick="{{action(\'saveRecord\')}}" lt-prop-appearance="primary" id="vr_abaSave"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.label.proceed\')}} </template> </lyte-button> </lyte-modal-footer> </template> </lyte-modal> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,3,0]},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"text",position:[1,1,0]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1,1]},{type:"for",position:[3,1,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,0]}]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[3]}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"text",position:[1,1,3,0]},{type:"text",position:[1,3,0]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1]},{type:"componentDynamic",position:[3,1]},{type:"text",position:[3,3,0]},{type:"componentDynamic",position:[3]},{type:"attr",position:[5,1]},{type:"registerYield",position:[5,1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[5,1]},{type:"attr",position:[5,3]},{type:"registerYield",position:[5,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[5,3]},{type:"componentDynamic",position:[5]}]},{type:"componentDynamic",position:[3]}],_observedAttributes:["alertDetails","layoutData","fieldIds","dontFocus","alertTOPBool","alertOPBool","allowAlertBool","isFromSC","isFromDet","isFromNC","isVRError","isVrerror","isFromQC","isQc","noAlertClose","isWizard","isDetReq","fromPopup","stageClose","isStage","isCanvasStage","isKanban","isCQC","parseFieldDetails","instanceRelatedData","module","alertOP","alertTOP","allowAlert","entityData","saveValObject","recordData","errorsCheck","closedPop","closedCustData","alertTOPMsg","popoverDirection"],data:function(){return{alertDetails:Lyte.attr("object"),layoutData:Lyte.attr("object"),fieldIds:Lyte.attr("array"),dontFocus:Lyte.attr("boolean",{default:!1}),alertTOPBool:Lyte.attr("boolean",{default:!1}),alertOPBool:Lyte.attr("boolean",{default:!1}),allowAlertBool:Lyte.attr("boolean",{default:!1}),isFromSC:Lyte.attr("boolean",{default:!1}),isFromDet:Lyte.attr("boolean",{default:!1}),isFromNC:Lyte.attr("boolean",{default:!1}),isVRError:Lyte.attr("boolean",{default:!1}),isVrerror:Lyte.attr("boolean",{default:!1}),isFromQC:Lyte.attr("boolean",{default:!1}),isQc:Lyte.attr("boolean",{default:!1}),noAlertClose:Lyte.attr("boolean",{default:!1}),isWizard:Lyte.attr("boolean",{default:!1}),isDetReq:Lyte.attr("boolean",{default:!1}),fromPopup:Lyte.attr("boolean",{default:!1}),stageClose:Lyte.attr("boolean",{default:!1}),isStage:Lyte.attr("boolean",{default:!1}),isCanvasStage:Lyte.attr("boolean",{default:!1}),isKanban:Lyte.attr("boolean",{default:!1}),isCQC:Lyte.attr("boolean",{default:!1}),parseFieldDetails:Lyte.attr("object"),instanceRelatedData:Lyte.attr("object"),module:Lyte.attr("string"),alertOP:Lyte.attr("object"),alertTOP:Lyte.attr("object"),allowAlert:Lyte.attr("object"),entityData:Lyte.attr("object"),saveValObject:Lyte.attr("object"),recordData:Lyte.attr("object"),errorsCheck:Lyte.attr("boolean",{default:!1}),closedPop:Lyte.attr("boolean",{default:!0}),closedCustData:Lyte.attr("string",{default:"no-scroll"}),alertTOPMsg:Lyte.attr("array"),popoverDirection:Lyte.attr("string",{default:"bottomRight"})}},didConnect:function(){(this.getData("isVRError")||this.getData("isVrerror"))&&this.dispValError();let e=this.getData("timeout");e&&clearTimeout(e);let t=$L("#vr_topErrBtn");if(t.is(":visible")&&0===t.closest("#VRAjaxEdit,.qcFormPopupWrapper,.valTopAlertCheck_f,.valTopAlertCheck,.topMsgError").length)this.setData("errorsCheck",!0);else{let t=this;e=setTimeout((function(){t&&t.setData("errorsCheck",!0)}),1e3),this.setData("timeout",e)}},didDestroy:function(){let e=this.getData("timeout");e&&clearTimeout(e)},init:function(){this.segValError(),(this.getData("isFromSC")||this.getData("isFromMC"))&&this.dispValError()},segValError:function(){var e=this.getData("fieldIds"),t=this.getData("alertDetails"),a=e?e.length:0,r=this.getData("alertTOP")?this.getData("alertTOP"):{},o=this.getData("alertTOPMsg")?this.getData("alertTOPMsg"):[],i=this.getData("allowAlert")?this.getData("allowAlert"):{},l=this.getData("alertOP")?this.getData("alertOP"):{};if(t){t.isFromSC&&this.setData("isFromSC",!0),t.isFromMC&&this.setData("isFromMC",!0),t.isFromDet&&this.setData("isFromDet",!0),t.isFromQC&&this.setData("isFromQC",!0),t.isFromNC&&this.setData("isFromNC",t.isFromNC),t.module&&this.setData("module",t.module),t.isFromCanvas&&this.setData("isFromCanvas",t.isFromCanvas);for(var s=0;s<a;s++){for(var n=e[s],d=t[n],p=d?d.length:0,c=[],m=[],u=[],v=0;v<p;v++){var y=d[v];"top_of_page"===y.alert_preference?(Lyte.arrayUtils(c,"push",y),Lyte.arrayUtils(o,"push",y.message)):"on_primary_field"===y.alert_preference?Lyte.arrayUtils(m,"push",y):"allow_by_alert"===y.alert_type&&Lyte.arrayUtils(u,"push",y)}c.length>0&&Lyte.objectUtils(r,"add",n,c),u.length>0&&Lyte.objectUtils(i,"add",n,u),m.length>0&&Lyte.objectUtils(l,"add",n,m)}Object.keys(r).length>0&&this.setData("alertTOPBool",!0),Object.keys(l).length>0&&this.setData("alertOPBool",!0),Object.keys(i).length>0&&this.setData("allowAlertBool",!0),this.setData({alertTOP:r,alertTOPMsg:o,alertOP:l,allowAlert:i})}},dispValError:function(){var e,t=this.getData("layoutData"),a=this.getData("fieldIds"),r=this.getData("dontFocus"),o=this.getData("alertOP"),i=this.getData("allowAlert"),l=this.getData("alertOPBool"),s=this.getData("alertTOPBool"),n=this.getData("allowAlertBool"),d=this.getData("isFromSC"),p=this.getData("isFromDet"),c=this.getData("isFromCanvas"),m=this.getData("isQc"),u=this.getData("isStage"),v=this.getData("isWizard"),y=a?a.length:0,g=this.getData("isCanvasStage"),f=[],D=this.getData("stageClose"),h=this.getData("module");if(t||(t=u?$L("crm-quick-create-listing")[0].component:$L("crm-create-layout")[0],this.setData("layoutData",t),e=t&&t.data?t.data.currentInstObjKey:void 0),l||n)for(var b=0;b<y;b++){var _,C,L,E=a[b],P=!1,x=t?t.getData("module"):this.getData("module");if((t&&!x||x instanceof Object)&&((x=t.getData("modulenameUicomp"))||(x=t.getData("moduleName"))),d)_=t.getData("layoutFields").filter((function(e){return e.id==E}))[0],C=void 0!==(L=t.getFieldsIndex("api_name",_.api_name))?$L("#component_"+L)[0]:null;else if(u){_=t.getData("currentLayout.fields").filter((function(e){return e.id==E}))[0];var A=t.getData("moduleName")+"_fldRow_"+_.column_name;C=$L("crm-create-fields#"+A)[0]}else if(!p&&!c&&!m){A=x+"_fldRow_"+(_=t.getData("moduleData.fields").filter((function(e){return e.id==E}))[0]).column_name;(C=$L("crm-create-fields#"+A)[0])||(C=(C=document.querySelectorAll(".aggField."+_.api_name))&&C.length>=1?C[0]:void 0),P=!!C&&!!C.classList.contains("aggField")}if(o[E]&&C){var w={isError:!0};if(!_||202!==_.ui_type&&333!==_.ui_type?w.inFocusNow=!r:w.inFocusNow=!1,w.isVRError=!0,w[E]=o[E],w.fieldId=E,C.setData("verifyText",""),P){w.isVRNewError=!0;var F=$L(C).parents("crm-create-subformsection")[0];F&&!F.component.data.aggerrorDetails&&Lyte.Component.set(F.component.data,"aggerrorDetails",{}),Lyte.Component.set(F.component.data.aggerrorDetails,_.api_name,w),C.querySelector("input").classList.add("cuserrorAborder"),C.classList.add("lcAggError")}else{var O=C?C.component.data:void 0,S="edit"===t.getData("initRoute")?"edit":"create";if(_.view_type[S]&&_.visible&&(!_.read_only||e&&_[e].validate_read_only))if(O){if(C&&C.getData("lyteViewPort")&&C.setData("lyteViewPort",!1),d?(C.setData("cxPropErrorMessage"," "),Lyte.Component.render("crm-validation-rule-error",{alertDetails:w,fieldId:E},"#component_"+L)):Lyte.Component.set(O,"errorDetailsNew",w),!w.inFocusNow)continue;if("picklist"===_.data_type){let e=C.querySelector("lyte-dropdown");e=e?e.querySelector(".lyteDummyEventContainer"):void 0,e&&(e.focus(),setTimeout((function(){$(e).blur()}),500))}else if("userlookup"===_.data_type||"ownerlookup"===_.data_type){var V=C.querySelector("lyte-dropdown");(V=V?V.querySelector(".lyteDummyEventContainer"):void 0)&&V.focus()}else{var B="boolean"===_.data_type?C.querySelector("lyte-checkbox"):C.querySelector("lyte-input");B?B.focus():Crm.userDetails.isPhoneNoNewView&&"phone"===_.data_type&&C.querySelector("input").focus()}}else _.$.set("errorDetails",w)}}if(!l&&i[E]){var N={};if(d)N.value=void 0===C.component.getValue()?"":C.component.getValue(),N.value instanceof Object&&(N.value=N.value.name),N.valError=i[E],(_.colour_code_enabled||_.colour_code_enabled_by_system)&&(N.isValueWithBg=!0,N.color=getPLStyleObj(C.component.getData("propDefaultColorCode"),N.value)),N.apiName=_.api_name,N.field_label=_.field_label,N.id=_.id,Lyte.arrayUtils(f,"push",N);else if(p){var T=i[E][0].targetField;if(!T.length&&i[E][0].taskClose)N.apiName=T.api_name,N.value=void 0!==CVRExec.getFieldVal(T.column_name)?CVRExec.getFieldVal(T.column_name):CVRExec.getTaskCompletedUserValue(),N.valError=i[E],N.field_label=i[E][0].fieldLabel,N.id=T.id;else{var k,I=!!(_=221==T.ui_type?T:T.data()).params;if(_=_.params?_.params:_,i[E][0].nPriField){var q=$("#VRAjaxEdit").find(".fieldsContainer"),R=CVRExec.getElemId("edit",_.colname,h),j=q.find("#"+R);j.length&&(_=j.data(),I=!1,T=j)}if(I&&"STAGE"===_.colname)i[E][0].taskClose?N.value=CVRExec.getFieldVal(_.colname):_.attrObj?N.value=$L("#"+_.attrObj.id).val().split(":")[1]:N.value=""!==T.val()?T.val().split(":")[1]:_.stageValue;else if("DateTime"===_.contentType&&_.dateObj)N.value=T.val()+" "+$("#"+T.attr("id")+"_TimeOption").val();else if("DateTime"===_.type){var M=new CrmDate(_.valueinTS);N.value=M.getDateTimeInUserPattern(!0)}else if("Date"===_.type){M=new CrmDate(CVRExec.getFieldVal(_.colname));N.value=M.getDateInUserPattern(!0)}else if(301==_.uitype||"Boolean"===_.contentType)N.value=T.is(":checked")?"true":"false";else if("User Lookup"===_.contentType||221==_.uitype)if(_.defaultvalue||""===_.defaultvalue)N.value=_.defaultvalue;else{T[0].component||(T=T.next());var U=T[0].component.data,z=U.userName?U.userName:U.userRecord?U.userRecord.full_name:"";N.value=z}else D||!i[E][0].taskClose?N.value=I?_.defaultvalue:"STAGE"===_.colname?T.val().split(":").length>1?T.val().split(":")[1]:T.val().split(":")[0]:T.val():N.value=CVRExec.getFieldVal(_.colname);if(_.colorcode_enabled)if(N.isValueWithBg=!0,"STAGE"===_.colname){var H=_.val?_.val:_.values;if(H){var Q=H.length,W=_.attrObj?$L("#"+_.attrObj.id).val():""!==T.val()?T.val():_.stageValue;(W&&""===W||I&&i[E][0].taskClose)&&(W=N.value);for(var J=0;J<Q;J++)if(W===H[J].value||W===H[J].content||W===H[J].DisplayValue||W===H[J].html){k=H[J].colorCode;break}}!k&&_.colorcode&&(k=_.colorcode),N.color=getPLStyleObj(k,N.value)}else{var Y=_.colorcode?"#"+_.colorcode.split(";")[1]:_.color_code,G=_.picklistmap;if(G){var K=G.filter((function(e){return e.DisplayValue===N.value}));Y=K&&K[0]?K[0].colorCode:Y}N.color=getPLStyleObj(Y,N.value)}N.valError=i[E],N.apiName=_.sysrefname,N.field_label=_.displaylabel?_.displaylabel:i[E][0].fieldLabel,N.id=_.id}Lyte.arrayUtils(f,"push",N)}else if(c){var X=i[E][0].targetField,Z={};g&&X.getData("modalFields")?(Z=X.getData("modalFields").filter((function(e){return e.id==E}))[0],N.value=X.getData("originalRecord")[Z.api_name]):0===Object.keys(X).length?(Z=store.peekRecord("field",i[E][0].targetFieldId),X=$L("crm-detailview-canvas")[0].component,N.value=X.getData("originalRecord")[Z.api_name]):133===(Z=X.getData("cxPropField")).ui_type?N.value=X.getData("value"):301===Z.ui_type||"boolean"===Z.data_type?N.value=X.getData("cxPropValue")?"true":"false":N.value=X.getData("cxPropValue"),N.value instanceof Object&&(N.value=N.value.name),Z.colour_code_enabled&&(N.isValueWithBg=!0,N.color=getPLStyleObj(X.getData("propDefaultColorCode"),N.value)),N.apiName=Z.api_name,N.field_label=Z.field_label,N.id=Z.id,N.valError=i[E],Lyte.arrayUtils(f,"push",N)}else if(m&&!u){this.setData("valEvent",t.getData("valEvent")),this.setData("currentEvent",t.getData("currentEvent"));var ee=this.getData("entityData");N.apiName=i[E][0].targetField,N.id=i[E][0].targetFieldId;var te=store.peekRecord("field",N.id);if(N.field_label=te.field_label,N.valError=i[E],N.value=ee[i[E][0].targetField],N.value instanceof Object&&(N.value=N.value.name),te.colour_code_enabled||te.colour_code_enabled_by_system){var ae;N.isValueWithBg=!0;var re,oe=te.pick_list_values.length>0?te.pick_list_values.length:0;for(re=0;re<oe;re++){var ie=te.pick_list_values[re];ie.display_value===N.value&&(ae=ie.colour_code)}N.color=getPLStyleObj(ae,N.value)}Lyte.arrayUtils(f,"push",N)}else{this.setData("valEvent",t.getData("valEvent")),this.setData("currentEvent",t.getData("currentEvent"));var le=!1;if(!(O=C?C.component.data:void 0)&&v&&(O=t.getData(),le=!0),O){if(P)N.value=O.ltPropValue,N.apiName=O.fldApiname,N.field_label=O.fieldLabel,N.id=_.id;else{var se=O.dataBind;m&&this.setData("entityData",se),N.apiName=le?_.api_name:O.apiName,se[N.apiName]instanceof Object?N.value=se[N.apiName].name?se[N.apiName].name:se[N.apiName].full_name:N.value=void 0===se[N.apiName]?"":se[N.apiName]+"",333===_.ui_type&&(N.value=N.value.replace("TV"," "));var ne=le?_:O.moduledataUicomp;ne&&(ne.colour_code_enabled||ne.colour_code_enabled_by_system)&&(N.isValueWithBg=!0,N.color=getPLStyleObj(ne.color_code,N.value)),N.field_label=le?_.field_label:O.fieldLabel,N.id=le?_.id:O.id}N.valError=i[E],Lyte.arrayUtils(f,"push",N)}}}}f.length>0&&(this.setData("allowAlertDet",f),s||l||!n||this.setData("allowAlertOnly",!0))},actions:{openPopover:function(){this.getData("errorsCheck")||this.setData("errorsCheck",!0),this.setData("closedPop",!0)},alertClose:function(){this.getData("isNewSubformUI")&&$L("crm-detail-view-subform")[0].component.reject();this.executeMethod("onAlertClose")},saveRecord:function(){var e,t=this.getData("layoutData"),a=this.getData("isFromSC"),r=this.getData("isFromMC"),o=this.getData("isFromDet"),i=this.getData("isFromNC"),l=this.getData("isFromQC"),s=this.getData("module"),n=this.getData("isQc"),d=this.getData("isDirectSave"),p=this.getData("parseFieldDetails"),c=this.getData("instanceRelatedData"),m=this.getData("isWizard"),u=this.getData("isStage"),v=this.getData("isFromCanvas"),y=this.getData("isCanvasStage"),g=this.getData("allowAlert"),f=this.getData("recordData"),D=this.getData("fromPopup"),h=this.getData("valEvent"),b=this.getData("stageClose"),_=$L("crm-create-layout")[0],C=this.getData("currentEvent");m&&"saveasdraft"!==C&&(t=$L("crm-create-wizard-buttons")[0].component,this.setData("layoutData",t)),e=t&&t.getData("validationRules")?t.getData("validationRules"):Crm.validationRuleJSONData[s]?Crm.validationRuleJSONData[s].validation_rules:store.peekAll("validation_rule");var L=Object.keys(g),E={},P=[];if(e.forEach((function(e){L.contains(e.field.id)&&g[e.field.id].forEach((function(t){var a={},r={};Lyte.objectUtils(r,"add","id",e.field.id),Lyte.objectUtils(r,"add","api_name",e.field.api_name),Lyte.objectUtils(a,"add","field",r),Lyte.objectUtils(a,"add","queryid",t.query_id),Lyte.objectUtils(a,"add","rule_id",e.id),Lyte.arrayUtils(P,"push",a)}))})),Lyte.objectUtils(E,"add","allow_by_alert",P),t&&!l){if(E)if(n){var x=this.getData("entityData");Lyte.Component.set(x,"$validation_rule_action",JSON.parse(JSON.stringify(E)));var A=$L("crm-kanbanview-component")[0];if(A&&(A=A.component).setData("abaSave",!0),d)return A?A.entitySave(p,x,c):t&&t.entitySave(p,x,c),this.setData("allowAlertOnly",!1),void this.setData("noAlertClose",!0);if(!_||u){var w=$L("crm-create-buttons")[0].component;w.setData("dataBind",x);var F=w.getData("validateVar");return w.validateCreateform.apply(w,F),this.setData("allowAlertOnly",!1),void this.setData("noAlertClose",!0)}t.setData("dataBind",x),t.getData("currsubformApinames")||t.setData("currsubformApinames",[]),t.setData("isQuickCreate",!0)}else if(a){(S=r?$L("crm-mass-convert")[0].component:$L("crm-convert-lead")[0].component).setData("validation_rule_action",JSON.parse(JSON.stringify(E)))}else{var O=t.getData("dataBind");Lyte.Component.set(O,"$validation_rule_action",JSON.parse(JSON.stringify(E))),t.setData("dataBind",O)}if(a)if(r){var S;(S=$L("crm-mass-convert")[0].component).setData("isVrExec",!1);var V=S.getData("allowByAlertMCListenerid");Lyte.triggerEvent("allowByAlertMC"),Lyte.removeEventListener(V)}else{var B=$L("crm-convert-lead")[0].component;B.setData("isVrExec",!1);var N=B.getData("allowByAlertListenerid");Lyte.triggerEvent("allowByAlert"),Lyte.removeEventListener(N)}else{var T=this.executeMethod("submitFunction",t,C),k=!1;"saveasdraft"===C&&(k=!0),n?t.validateCreateform(C,T,t.data.currentEventID,k,void 0,void 0,void 0,!0):t.validateCreateform(C,T,t.data.currentEventID,k,void 0,h,void 0,!0)}}else if(o){var I,q=this.getData("saveValObject"),R=!!Crm.VR&&(Crm.VR.IsQuickCreate&&!Crm.VR.IsSearchCreate&&("Tasks"===s||"Potentials"===s||"Contacts"===s||"Leads"===s||"Calls"===s));if(I=R?$L("#createEntityFormQC")[0]:$L("#createEntityForm")[0],q&&I){var j=document.createElement("input");if(j.setAttribute("type","hidden"),j.setAttribute("name","property($validation_rule_action)"),j.setAttribute("id","abaSaveVal"),j.setAttribute("value",JSON.stringify(E)),I.hasChildNodes("property($validation_rule_action)")){var $=$L("#abaSaveVal");$.length&&$[0].remove()}if(I.appendChild(j),R){var M=Crm.VR.qCVal;delete Crm.VR.qCVal,saveQuickCreatePopup(s,M.operation,I,M.idsArr,M.namesArr,M.from,!0,M.start_index,M.end_index,M.rangeValue,M.relMod)}else handleQuickCreatePopup(q.module,q.cvid,q.saveAndAssociate,q.formName,!1,!0)}else i?("Events"===s?Events.saveEntity(event,!0,!1,void 0,!0,JSON.stringify(E)):"Calls"===s?Calls.saveEntity(event,!0,!0,JSON.stringify(E)):Crm.saveEntity(event,s,void 0,!1,CVRExec.isNew,void 0,!1,void 0,void 0,!0,JSON.stringify(E)),this.setData("isFromNC",!1)):b&&D?savePotentialPopup("popup",E,!0):D?CFRExec.saveFieldsFinally(E):CVRExec.allowByAlertSavePopup(E)}else if(v){var U;if(Lyte.Component.set(f,"$validation_rule_action",JSON.parse(JSON.stringify(E))),y)(U=$L("crm-stage-verify-popup")[0].component).saveStagevalues(f,!0);else if(this.getData("isNewSubformUI"))$L("crm-detail-view-subform")[0].component.resolve();else(U=(U=$L("crm-detailview-canvas")[0])?U.component:$L("crm-detail-view-subform")[0].component).firesavereq(f,!0)}this.setData("allowAlertOnly",!1),this.setData("noAlertClose",!0)}},methods:{onAbaShow:function(){setTimeout((function(){$L("#vr_abaSave").focus()}),1e3)},setValError:function(){this.segValError(),this.dispValError()},isVRPresent:function(){var e=this.getData("layoutData"),t=!e.getData("transitionDone")&&this.getData("alertTOPBool")&&!this.getData("alertOPBool");return e.setData("transitionDone",!1),t},onAlertClose:function(){if(!this.getData("noAlertClose")&&this.data.parseFieldDetails&&this.data.parseFieldDetails.subformAjaxField&&this.data.parseFieldDetails.callback&&this.data.parseFieldDetails.callback.onCancel&&this.data.parseFieldDetails.callback.onCancel(!0),this.data.parseFieldDetails&&this.data.parseFieldDetails.otherPropertyObj&&"stage_strip"===this.data.parseFieldDetails.otherPropertyObj.feature&&this.data.parseFieldDetails.callback.onCancel(),this.getData("noAlertClose"))this.setData("noAlertClose",!1);else{var e=this.getData("layoutData"),t=this.getData("isQc"),a=this.getData("isStage");if(this.setData("noAlertClose",!0),e&&e.$node&&"CRM-DETAIL-VIEW"!==e.$node.nodeName&&t&&!a){e.resetFieldData(),e.retainCard?e.retainCard():this.data.parseFieldDetails&&this.data.parseFieldDetails.callback&&this.data.parseFieldDetails.callback.onCancelAllowByAlert&&this.data.parseFieldDetails.callback.onCancelAllowByAlert();var r=e.getData("stripField");r&&"Stage"===r&&(e.wonLostPopupTriggerd=!1,e.setData("valRuleData",void 0),e.closeAjaxEdit(),e.verifyAndSetStageValues(!0,e.getData("record"),!0)),renderingUtils.removeFreezeLayer()}else e&&e.$node&&"CRM-DETAIL-VIEW"===e.$node.nodeName&&e.setData("save_ajax_edit_in_progress",!1);this.setData("allowAlertOnly",!1)}},onAlertBeforeClose:function(e){if(27===e.keyCode){var t=$("#subSecondaryPopup");t.is(":visible")&&t.find("#cancel").addClass("vr_cancelTrigger");let e=$("#formRuleMandatoryFields");e.is(":visible")&&e.find("#cancel").addClass("vr_cancelTrigger")}},emptyErrorData:function(){var e=this.getData("layoutData"),t=this.getData("fieldIds");this.setData({alertDetails:{},alertTOPBool:!1,alertTOP:void 0,alertTOPMsg:void 0,alertOP:void 0,alertOPBool:!1,fieldIds:void 0});var a=$L("crm-validation-alert"),r=this.getData("isDetReq"),o=t?t.length:0,i=this.getData("isFromSC"),l=this.getData("isVRError"),s=this.getData("isStage"),n=this.getData("isQc"),d=this.getData("isVrerror");if(r&&a.empty(),!l){i&&$L("crm-validation-rule-error").empty();for(var p=0;p<o;p++){var c,m=t[p],u=e?e.getData("module"):this.getData("module");if((e&&!u||u instanceof Object)&&(u=e.getData("modulenameUicomp")?e.getData("modulenameUicomp"):e.getData("moduleName")),i||s||d||n){if(s){c=e.getData("currentLayout.fields").filter((function(e){return e.id==m}))[0];v=e.getData("moduleName")+"_fldRow_"+c.column_name;y=$L("crm-create-fields#"+v)[0]}}else var v=u+"_fldRow_"+(c=e.getData("moduleData.fields").filter((function(e){return e.id==m}))[0]).column_name,y=$L("crm-create-fields#"+v)[0];var g=y?y.component.data:void 0;g&&(y&&y.getData("lyteViewPort")&&y.setData("lyteViewPort",!1),Lyte.Component.set(g,"errorDetailsNew",void 0))}s&&a.empty()}},submitFunction:function(e,t){for(var a=e.data.buttons,r=a?a.length:0,o=0;o<r;o++){var i=a[o];if(i.name===t)return i.onSubmitFunction}},quickCreatClosePop:function(){let e=$L(this.$node).find("#vr_topErrPopover");e=$L(e);let t=e.closest(".quickContHeadInfo");if(t.length){let a=t.parent().find(".fcontent");a.length&&parseInt(a.css("left"))<0&&e.eq(0).find("#vr_topErrPopover")[0].ltProp("show",!1)}},closePopover:function(){"scroll"!==this.getData("closedCustData")?this.setData("errorsCheck",!1):this.setData("closedPop",!1)}}});
