Lyte.Mixin.register("crm-lookup-mixin",{quick_create_unsupported_modules:["Quotes","SalesOrders","PurchaseOrders","Invoices","PriceBooks"],fetchLookupModuleInfo:function(e,i){var o=this,a=this.getData("lookupInfo");return a||(a={}),a.moduleInfo=e.lookup.module,i||(i=a.moduleInfo.id),store.findRecord("module",i,{include:"custom_view,business_card_fields,layouts"}).then((function(e){return o.setData("lookup_module_meta",e),e[0]}))},fetchLookupRecords:async function(e,i,o){let a;var t,r=!1;if(CScriptLib){const i=this.getData("cscript_properties");a=i&&i[e.api_name]&&i[e.api_name].criteria}if("Reporting_To"===e.api_name){var n=this.getData("record"),d=n.id,l=n.Account_Name.id;void 0===o.filters&&(o.filters="(Account_Name:equals:"+l+")and(id:not_equal:"+d+")")}e.lookup&&e.lookup.module&&"Products"===e.lookup.module.api_name&&(r=!0);var s=!!(o.filters||a||r),u=store.peekRecord("field",e.id);if($L("#lookupFldId_"+e.id).closest("lyte-drop-box").removeClass("dNImp"),s){if((t={}).from="Lookup",t.type="Search",t.criteria=o.filters,delete o.filters,u.lookup&&u.lookup.query_details&&u.lookup.query_details.query_id&&(o.query_id=u.lookup.query_details.query_id),"Parent_Account"===u.api_name){var p="(id:not_equal:"+this.getData("record").id+")";t.criteria="("+t.criteria+"and"+p+")"}if(r){var c="(Product_Active:equals:true)";t.criteria?t.criteria="("+t.criteria+"and"+c+")":t.criteria=c}a&&(t.criteria=t.criteria?`(${t.criteria}and${a})`:a)}else o=await this.getactiveProducts(o,e.id),"Parent_Account"===u.api_name&&(o.filters={field:{api_name:"id"},comparator:"not_equal",value:[this.getData("record").id]});return o.approved="both",o.approval_state="approved,approval_process_pending,approval_process_rejected",new Promise((function(e,a){store.findAll(i,o,void 0,void 0,t).then((function(i){e(i)}),(function(e){"NO_PERMISSION"===JSON.parse(e.response).code&&renderingUtils.displayPermissionDenied(),a()}))}))},openQuickCreatePopup_detailview:function(e,i,o,a,t,r){var n=document.querySelector("crux-lookup-component[id='"+a+"']"),d=n.component,l=n.querySelector("#inputId").value;d.setData("tempClose",!0),this.$node.querySelector(d.lookupModalName)?d.close():$L("#lookupFldId_"+e.id).closest("lyte-drop-box").addClass("dNImp");var s="",u=moduleApiVsNameMapping[e.lookup.module.api_name],p=a,c=a,m=u;s=Crm.getCrmBasePath()+"/QuickCreateAction.do?module="+$ESAPI.encoder().encodeForURL(u)+"&searchmodule="+$ESAPI.encoder().encodeForURL(u)+"&fldName="+$ESAPI.encoder().encodeForURL(p)+"&fldId="+$ESAPI.encoder().encodeForURL(c)+"&fldLabel="+$ESAPI.encoder().encodeForURL(m)+"&fldValue="+encodeURIComponent(l)+"&frmzc="+!1+"&newModel="+!0,s=networkUtils.getPortalURL(s),o&&i[o.currency_apiname]&&(s=s+"&currencyISOCode="+i[o.currency_apiname].trim()),t&&(s=s+"&targetForm="+t),Crm.userDetails.isLookupAdvancedSearchEnabled&&(s+="&openInAdvSearch=true"),"Reporting_To"===e.api_name&&i.Account_Name.id&&i.Account_Name.name&&(s+="&accountid="+i.Account_Name.id+"&accountname="+encodeURIComponent(i.Account_Name.name)),renderingUtils.hideFreezeLayer();var _=document.getElementById("lookupPopup");_.classList.remove("zcrm-show"),_.style.top="0px",_.style.display="none",_.style.width="",r?($("#searchCreatePopup").addClass("fromAutoComplete"),commonUtils.openCustomLookup(s,void 0,"searchCreatePopup",void 0,void 0,void 0,void 0,void 0,(function(){if(l){var e=$("#ac-recordname").children().find("input"),i=e.attr("maxlength");l.length>i&&(l=l.substring(0,i)),e.val(l)}}))):($("#searchCreatePopup").removeClass("fromAutoComplete"),commonUtils.openCustomLookup(s,void 0,"searchCreatePopup")),(void 0===Crm.userDetails.VALIDATIONRULEAVAILABLE||!0===Crm.userDetails.VALIDATIONRULEAVAILABLE&&Crm.userDetails.VRINVOLVEDMODULES.contains(u))&&Crm.downloadValidationRules(s,u)},setValueInLookupCompUsingQCSaveResp:function(e,i,o){if("detailviewlyte"===i){var a=document.querySelector("crux-lookup-component[id='"+e+"']").component,t=validationUtils.isJson(o)?JSON.parse(o).msg:o.msg,r=[];if("string"==typeof t&&t.indexOf(";:;")>-1&&(r=t.split(";:;")),a&&r&&r[1]){var n={id:r[1],name:r[0]},d=JSON.parse(o).isInReview;if(!d&&7!==d)if(a.setData("cxPropValue",JSON.stringify(n)),a.$node.querySelector("#inputId").focus(),a.$node.querySelector("lyte-dropdown").close(),$L("crm-blueprint-exec-popup").is(":visible"))a.$node.closest("crm-blueprint-exec-fields").component.executeMethod("getLookupModuleFieldValues",n);else a.$node.closest("crm-detailview-fields").component.executeMethod("onLookupRecordSelect",n)}}},performUserSelect:function(e,i,o,a){var t=this.getData("meta_info.folFieldDetails");if(e&&t[i.id]&&!0===Crm.userDetails.FIELD_OF_LOOKUP_ENABLED&&!0===Crm.userDetails.FIELD_OF_LOOKUP_AVAIALBLE){var r=this.getData("meta_info.fol_user_module_fields"),n=8===i.ui_type,d=[];(t=t[i.id]).child_fields.forEach((function(e){e.visible&&d.push(e)}));var l={};d&&d.length&&(l.fields=d.mapByKey("association_details").mapByKey("related_field").mapByKey("api_name").join()),store.findRecord("user",e.id,l,void 0,void 0,{usersAPIversion:"v2.2"}).then(function(i){i&&i[0]&&(e=i[0],!r?store.findAll("field",{module:"users"},void 0,void 0,{apiVersion:"2.2"}).then(function(i){this.setData("meta_info.fol_user_module_fields",i),this.populateLookupRecordDetailsIntoRecord(t,this.getData("module"),e,i,void 0,o,a,!0,n)}.bind(this)):this.populateLookupRecordDetailsIntoRecord(t,this.getData("module"),e,r,void 0,o,a,!0,n))}.bind(this))}},performRecordSelect:function(e,i,o,a){var t=this.getData("meta_info.folFieldDetails");if(t||"blueprint"!==o||(t=this.getData("folDetails")),e&&t[i.id]&&!0===Crm.userDetails.FIELD_OF_LOOKUP_ENABLED&&!0===Crm.userDetails.FIELD_OF_LOOKUP_AVAIALBLE){var r=!1,n={};"string"==typeof e?(e=JSON.parse(e),n.lookup_record=store.peekRecord(i.lookup.module.id,e.id)):(r=!0,n.lookup_record=store.findRecord(i.lookup.module.id,e.id,Crm.get_params_for_getRecord()));var d=store.peekRecord("module",i.lookup.module.id);(!d||!d.layouts)&&(n.lookup_moduleInfo=store.findRecord("module",i.lookup.module.id,{include:"custom_view,business_card_fields,layouts"})),Lyte.resolvePromises(n).then(function(e){var n=e.lookup_record;r&&(n=n[0]);var l={};l.layoutInfo=this.initiateLayoutRequestForRecord(n,d,void 0,l),Lyte.resolvePromises(l).then(function(e){this.populateLookupRecordDetailsIntoRecord(t[i.id],this.getData("module"),n,d,e.layoutId,o,a,!1,!1)}.bind(this))}.bind(this))}},populateLookupRecordDetailsIntoRecord:function(e,i,o,a,t,r,n,d,l){if(!this.data.record||!this.data.record.$approval_state||"approval_process_pending"!==this.data.record.$approval_state){var s,u=[],p="",c=[];if(!d)store.peekRecord("layout",t).fields.forEach((function(i){i.visible&&e.parent_fields.contains(i.id)&&u.push(i.id)}));s=d?store.modelFor("user")?store.modelFor("user").fieldList:void 0:store.modelFor(a.id).fieldList;var m=[];e.child_fields.forEach((function(e){(e.visible||"blueprint"===r)&&m.push(e)}));var _=store.modelFor(moduleRecordMapping[i].id).fieldList,f={};if(m.forEach(function(e){var i,t,r,n=_[e.api_name],l=e.association_details.related_field,m=s[l.api_name]?s[l.api_name].type:void 0;if(!m&&d){var v=a.filter((function(e){return e.api_name===l.api_name}))[0];v&&(m=Lyte.registeredMixins["crm-module-mixin"].getfieldattributeType(v))}if(d&&a&&a.length&&l){var h=a.filter((function(e){return e.id===l.id}))[0];if(h&&!h.visible)return}if(u.contains(l.id)||d){if("date"===n.type)if(o[l.api_name]){g=(g=o._$&&o._$.original&&o._$.original[l.api_name]?o._$.original[l.api_name]:o[l.api_name]).replace(/[+-]\d{2}:\d{2}/,"");var y=CrmDateUtils.convertDateToUserPattern(CrmDateUtils.getDateObjectFromString(g,"YYYY-MM-DD"));f[e.api_name]=y||void 0}else f[e.api_name]=void 0;else if("datetime"===n.type)if(o[l.api_name]){var g;g=(g=o._$&&o._$.original&&o._$.original[l.api_name]?o._$.original[l.api_name]:o[l.api_name]).replace(/[+-]\d{2}:\d{2}/,"");var C=this.getDateTimeForForm(new Date(g),!0);f[e.api_name]=C||void 0}else f[e.api_name]=void 0;else if(n.type===m||"object"!==m&&"relation"!==m)if("lookup"===e.data_type&&"object"===m)f[e.api_name]=o[l.api_name];else if("userlookup"===e.data_type&&"object"===m){var L=o[l.api_name];L="deleted"===(L&&store.peekRecord("user",L.id)?store.peekRecord("user",L.id).status:"")?void 0:L,f[e.api_name]=L}else if("multi-picklist"===m&&o[l.api_name]){var k;if("string"==typeof o[l.api_name]&&-1===o[l.api_name].indexOf(";")){var D=JSON.parse(o[l.api_name]);k=D&&D.length?constructMultiSelString(D):""}else"string"!=typeof o[l.api_name]&&o[l.api_name].length?(i=o[l.api_name],t="",r=i?i.length:0,i.forEach((function(e,i){t+=e+(i!==r-1?";":"")})),k=t):k=o[l.api_name];f[e.api_name]=k}else if("currency"===n.fieldType&&o&&o[l.api_name])if(this.data.record.Currency&&o.Currency&&o.Currency!==this.data.record.Currency){var I=this.getuserCurrencydata(this.data.record.Currency),R=o.Exchange_Rate;R=R||Crm.userDetails.CURRENCY_DETAILS[o.Currency].er;var A=this.convertToCurrentCurrency(o[l.api_name],R,I.er);A=isNaN(A)?o[l.api_name]:A,A=Number(A).toFixed(e.decimal_place),f[e.api_name]=A}else if(!o.Currency&&this.data.record.Currency&&_this.data.record.Currency!==Crm.userDetails.BASE_CURRENCY&&Crm.userDetails.BASE_CURRENCY){I=this.getuserCurrencydata(this.data.record.Currency);var b=this.getuserCurrencydata(Crm.userDetails.BASE_CURRENCY);A=this.convertToCurrentCurrency(o[l.api_name],b.er,I.er);A=isNaN(A)?o[l.api_name]:A,A=Number(A).toFixed(e.decimal_place),f[e.api_name]=A}else f[e.api_name]=Number(o[l.api_name]).toFixed(e.decimal_place);else f[e.api_name]=o&&void 0!==o[l.api_name]?o[l.api_name]:void 0;else"string"===n.type?o[l.api_name]&&validationUtils.isNotEmpty(o[l.api_name])?f[e.api_name]=o[l.api_name].name:f[e.api_name]="":void 0===o[l.api_name]&&(f[e.api_name]=o[l.api_name]);250===n.uiType&&o[l.api_name]&&(p+=l.api_name+",",c.push(l.api_name))}}.bind(this)),m.length>0&&("detail_view"===r||"blueprint"===r)){var v=c.length;v>0?(commonUtils.showHideLoadingDiv(!0),p=p.slice(0,-1),store.findAll("dummy",null,!1,!1,{url:"crm/v6/"+moduleApiMapping[a.api_name]+"/"+o.id+"/actions/fetch_full_data?fields="+p}).then((function(e){for(var o=0;o<v;o++){var a=m.filter((function(e){return e.association_details.related_field.api_name===c[o]}))[0].api_name;f[a]=e.data[0][c[o]]}commonUtils.showHideLoadingDiv(!1),"blueprint"===r?Lyte.triggerEvent("bp_setFieldData",{fieldVsValue:f,feature:"field_of_lookup",fromOwnerLookup:l,fieldModuleSelector:this.data.field.related_details?field.related_details.api_name:i}):Lyte.triggerEvent("detail_view_open_fieldEditPopup_listener_"+n,{fieldVsValue:f,feature:"field_of_lookup",fromOwnerLookup:l})}))):"blueprint"===r?Lyte.triggerEvent("bp_setFieldData",{fieldVsValue:f,feature:"field_of_lookup",fromOwnerLookup:l,fieldModuleSelector:this.data.field.related_details?field.related_details.api_name:i}):Lyte.triggerEvent("detail_view_open_fieldEditPopup_listener_"+n,{fieldVsValue:f,feature:"field_of_lookup",fromOwnerLookup:l})}}},show_lookup_bc_tooltip_info:function(e,i,o,a){var t;if("Messages"===a)return Lyte.registeredMixins["crm-msg-common"].showContactDetails(),!1;if("multi_module_lookup"===i.component_data_type)return!0;var r=e[i.api_name];if("Calls"===a&&"activity_mml"===i.component_data_type&&"Who_Id"===i.api_name&&(t=r||"Leads"!==e.$se_module?"Contacts":"Leads",r=r||"Leads"!==e.$se_module?r:e.What_Id),r)if($("#"+o).find("link-to").is(":hover")){var n={};t?n.module=t:"SEID"===i.column_name&&"Activities"===Crm.activityGrp[a]?n.module=e.$se_module:"multi_module_lookup"===i.data_type?n.module=r.module.api_name:n.module=i.lookup.module.api_name,n.id=r.id,n.module=moduleApiVsNameMapping[n.module],setTimeout((function(){var i=$("#"+o).find("link-to");if(i.is(":hover"))if("Calls"!==a||Crm.renderDVLyteFlow("Calls"))crmui.hideTooltip(),crmLookupBusinessCard.getRecordJSon(n.module,n.id,i);else{i.addClass("eidtrueHeader");var t=$L("crm-detailview-header")[0],r=t.component;if(t.querySelector(".bCardPop").ltProp("show",!0),!r.getData("bCard")){var d=r.getData("entityName"),l=d.name;r.setData("bCard",!0);var s=void 0===e.$phone_number||isCallerInfoDisabled?l:l+" ( "+e.$phone_number+" )";Lyte.Component.render("static-businesscard",{module:d.module.api_name,entityId:d.id,headerName:s,highlightedText:e.$phone_number},".bCardPopTempHeader")}}else crmui.hideTooltip()}),500)}else crmui.hideTooltip()}});
