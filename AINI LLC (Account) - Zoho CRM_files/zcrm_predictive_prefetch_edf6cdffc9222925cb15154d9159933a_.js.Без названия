var PrefetchDisable=null===localStorage.getItem("PrefetchDisable")?"0":localStorage.getItem("PrefetchDisable");if("0"===PrefetchDisable){var Rft={dbPromise:new Promise(((e,t)=>{const r=window.indexedDB.open("PredictivePrefetchDB",3);r.onerror=()=>{window.indexedDB.deleteDatabase("PredictivePrefetchDB");const r=window.indexedDB.open("PredictivePrefetchDB",1);r.onerror=()=>{t("Error with IndexedDB")},r.onsuccess=()=>{e(r.result)},r.onupgradeneeded=e=>{const t=e.target.result;try{t.deleteObjectStore("requests")}catch(e){}t.createObjectStore("requests",{keyPath:"pageUrl"}).createIndex("networkRequests","networkRequests",{unique:!1})}},r.onsuccess=()=>{e(r.result)},r.onupgradeneeded=e=>{const t=e.target.result;try{localStorage.removeItem("PredictivePrefetchlastTrain"),localStorage.removeItem("locationlogs"),localStorage.removeItem("transitionToNumberMap"),localStorage.removeItem("historyCount"),localStorage.removeItem("maxSequenceLength"),localStorage.removeItem("AccuratePreds"),localStorage.removeItem("PastTrains"),localStorage.removeItem("TotalPreds"),localStorage.removeItem("PrefetchDisable"),indexedDB.deleteDatabase("tensorflowjs"),t.deleteObjectStore("requests")}catch(e){}t.createObjectStore("requests",{keyPath:"pageUrl"}).createIndex("networkRequests","networkRequests",{unique:!1})}})),processUrlString:function(e){return e=(e=(e=(e=-1===(e=(e=(e=e.split("?")[0]).replace(/^\/|\/$/g,"")).replace(/\/(\d+)\//g,"/idx/")).indexOf("idx")?e.replace(/\/(\d+)/g,"/idx"):e.replace(/\/(\d+)/g,"/idy")).replace(/crm\/[a-zA-Z0-9]+\//,"")).replace(/\/CustomModule\d+/,"/CustomModuleX")).replace(/\/WebTab\d+/,"/WebTabX")},cachedFiles:[],addRequestsToDB:function(e,t){Rft.dbPromise.then((r=>{const a=r.transaction(["requests"],"readwrite").objectStore("requests"),o=a.get(e);o.onsuccess=()=>{const r=o.result||{pageUrl:e,networkRequests:[]};for(let e of t){let t=e.split("?")[0],a=t.includes("javascript")?t.includes("/i18n/")||t.includes("/help/")?"":t.split("javascript/").slice(-1)[0].split("/").slice(0,-1).join("/"):t.includes("compiled-css")?"":t.split("css/").slice(-1)[0].split("/").slice(0,-1).join("/"),o=t.replace(/_([^_]+)_\.([^.]+)$/,".$2").split("/").slice(-1)[0],s=!!t.includes("CRMClient"),n=!!t.includes("compiled-css"),i=t.includes("javascript/i18n")||t.includes("javascript/help")?t.split("/").slice(-2)[0]+"/i18n":s||n?n?o+"/compiled-css":o+"/CRMClient":o;i=""===a?i:a+"/"+i,!1===r.networkRequests.includes(i)&&(r.networkRequests=[...r.networkRequests,i]),Rft.cachedFiles.push(i)}a.put(r)}}))},observer:new MutationObserver((e=>{const t=[];if(e.forEach((e=>{if("childList"===e.type){const r=Array.from(e.addedNodes),a=r.filter((e=>"SCRIPT"===e.tagName)),o=r.filter((e=>"LINK"===e.tagName&&"stylesheet"===e.rel));a.forEach((e=>{const r=e.getAttribute("src");r&&(r.endsWith(".js")||r.match(/\.js\?[^\s"]+/))&&null!==r.match("/crm/")&&null===r.match("/addons/")&&t.push(r)})),o.forEach((e=>{const r=e.getAttribute("href");r&&r.endsWith(".css")&&null!==r.match("/crm/")&&t.push(r)}))}})),t.length>0){const e=Rft.processUrlString(window.location.pathname);Rft.addRequestsToDB(e,t)}}))};Rft.observer.observe(document.documentElement,{childList:!0,subtree:!0})}if(!0===FingerPrint.isCdnEnabled&&!1===Crm.env.isDevelopment&&speedBenchmarkEnd-speedBenchmarkStart>10){var payload_JSON={cvlogs:[{type:"speedbenchmark",sysspeed:speedBenchmarkEnd-speedBenchmarkStart,zgid:crmZgid,zuid:crmZuid}]},obj={type:"POST",url:RebrandLinkUtil.getProperty("LOGS_API_URL")+"?logtype=jslogs",data:JSON.stringify(payload_JSON),headers:{"content-type":"application/json"},dataType:"json",success:function(){},error:function(){}};if(navigator.sendBeacon){var data=obj.data,headers={"content-type":"application/json","x-remote-user":""},options={method:obj.type,headers:headers,body:data};navigator.sendBeacon(obj.url,options.body)}else{var xmlreq=new XMLHttpRequest,isAsync=obj.async||!0;xmlreq.open(obj.type,obj.url,isAsync),xmlreq.addEventListener("load",obj.success),xmlreq.addEventListener("error",obj.error),xmlreq.setRequestHeader("content-type","application/json"),xmlreq.setRequestHeader("x-remote-user",""),xmlreq.send(obj.data)}}if(!0===FingerPrint.isCdnEnabled&&!1===Crm.env.isDevelopment&&speedBenchmarkEnd-speedBenchmarkStart<=10&&"0"===PrefetchDisable){void 0===window.preFetchAllowed&&(performance.mark("fetch-start"),fetch(networkUtils.getImageUrl("crm_logo_white.svg",ResourceConstants.CRM),{cache:"reload","Cache-Control":"max-age=10"}).then((()=>{performance.mark("fetch-end"),performance.measure("fetch","fetch-start","fetch-end");var e=performance.getEntriesByName("fetch")[0];e.duration>500?window.preFetchAllowed=!1:window.preFetchAllowed=!0,Ppf.logQueue({type:"networkbenchmark",zuid:crmZuid,zgid:crmZgid,sysspeed:speedBenchmarkEnd-speedBenchmarkStart,netspeed:e.duration})}))),window.trainingInProgress=!1,"aundefined"===localStorage.getItem("fixedWordIndex")&&(localStorage.removeItem("PredictivePrefetchlastTrain"),localStorage.removeItem("ppfLocationLogs"),localStorage.removeItem("ppfHistoryCount"),localStorage.removeItem("ppfMaxSequenceLength"),localStorage.removeItem("AccuratePreds"),localStorage.removeItem("PastTrains"),localStorage.removeItem("TotalPreds"),localStorage.removeItem("PrefetchDisable"),localStorage.removeItem("fixedWordIndex"),indexedDB.deleteDatabase("tensorflowjs"));var Ppf={worker:new Worker(window.location.protocol+"//"+window.location.host+"/crm/javascript/PrefetchWorker.js?"+crmConstants.staticVersion),prevlocation:null,PredRecordQueue:null,AccuratePreds:Number(localStorage.getItem("AccuratePreds")),TotalPreds:Number(localStorage.getItem("TotalPreds")),PastTrains:null===localStorage.getItem("PastTrains")?null:localStorage.getItem("PastTrains").split(",").map(Number),fixedWordIndex:null===localStorage.getObject("fixedWordIndex")?{"<oov>":0}:localStorage.getObject("fixedWordIndex"),PredRecord:{type:"route",backendtime:0,zgid:crmZgid,zuid:crmZuid,tabid:0,currenturl:"",prevurl:"",predictedurl:"",predictionscore:0,actualnexturl:"",navigationtime:0,navigationsize:0,modelLastTrainedTime:0,predsequence:[],sessionid:0,sessioniddata:0,predictedValue:0},requestSend:function(e){if(navigator.sendBeacon){var t=e.data,r={method:e.type,headers:{"content-type":"application/json","x-remote-user":""},body:t};navigator.sendBeacon(e.url,r.body)}else{var a=new XMLHttpRequest,o=e.async||!0;a.open(e.type,e.url,o),a.addEventListener("load",e.success),a.addEventListener("error",e.error),a.setRequestHeader("content-type","application/json"),a.setRequestHeader("x-remote-user",""),a.send(e.data)}},pushRouteLog:function(e){var t={cvlogs:e};try{Ppf.requestSend({type:"POST",url:RebrandLinkUtil.getProperty("LOGS_API_URL")+"?logtype=jslogs",data:JSON.stringify(t),headers:{"content-type":"application/json"},dataType:"json",success:function(){},error:function(){}}),Ppf.PredRecordQueue=null,sessionStorage.removeItem("lastLogTime")}catch(e){return}},logQueue:function(e){null!==sessionStorage.getItem("lastLogTime")&&void 0!==sessionStorage.getItem("lastLogTime")||sessionStorage.setItem("lastLogTime",$L.moment("").toDate().valueOf()),null===Ppf.PredRecordQueue?Ppf.PredRecordQueue=[JSON.parse(JSON.stringify(e))]:Ppf.PredRecordQueue.push(JSON.parse(JSON.stringify(e))),$L.moment("").toDate().valueOf()-sessionStorage.getItem("lastLogTime")>3e5&&null!==Ppf.PredRecordQueue&&Ppf.pushRouteLog(Ppf.PredRecordQueue),0===e.tabid&&(Ppf.PredRecord.actualnexturl="",Ppf.PredRecord.backendtime=0,Ppf.PredRecord.currenturl="",Ppf.PredRecord.predictedurl="",Ppf.PredRecord.prevurl="",Ppf.PredRecord.predictionscore=0,Ppf.PredRecord.predsequence=[],Ppf.PredRecord.sessionid=0,Ppf.PredRecord.sessioniddata=0,Ppf.PredRecord.predictedValue=0)},PredWorker:function(e,t){if("0"===PrefetchDisable){"[object Object]"===localStorage.getItem("ppfLocationLogs")&&(localStorage.removeItem("PredictivePrefetchlastTrain"),localStorage.removeItem("ppfLocationLogs"),localStorage.removeItem("ppfHistoryCount"),localStorage.removeItem("ppfMaxSequenceLength"),localStorage.removeItem("AccuratePreds"),localStorage.removeItem("PastTrains"),localStorage.removeItem("TotalPreds"),localStorage.removeItem("fixedWordIndex"),localStorage.removeItem("PrefetchDisable"),indexedDB.deleteDatabase("tensorflowjs"));let p=Rft.processUrlString(t.url),u=Ppf.navigationtime();if(0!==Ppf.PredRecord.backendtime&&(Ppf.PredRecord.actualnexturl=p,Ppf.PredRecord.navigationtime=u.time,Ppf.PredRecord.navigationsize=u.size,Ppf.AccuratePreds=null===Ppf.AccuratePreds?Ppf.PredRecord.actualnexturl===Ppf.PredRecord.predictedurl?1:0:Ppf.PredRecord.actualnexturl===Ppf.PredRecord.predictedurl?Ppf.AccuratePreds+1:Ppf.AccuratePreds,Ppf.TotalPreds=null===Ppf.TotalPreds?1:Ppf.TotalPreds+1,Ppf.logQueue(Ppf.PredRecord),Ppf.AccuratePreds/Ppf.TotalPreds<.6&&Ppf.TotalPreds>500&&Ppf.PredWorker("Train",t)),null!==localStorage.getObject("ppfLocationLogs")&&void 0!==localStorage.getObject("ppfLocationLogs")){if(null===sessionStorage.getItem("currentSession")||void 0===sessionStorage.getItem("currentSession")){var r=$L.moment("").time(),a=r+crmZgid;sessionStorage.setItem("currentSession",a),sessionStorage.setItem("currentSessionID",r),sessionStorage.setItem("Zgid",crmZgid)}var o=localStorage.getObject("ppfLocationLogs")[sessionStorage.getItem("currentSession")];if(null!=o&&(Ppf.prevlocation=o.pop()),"Train"===e){var s=!0,n=0;void 0!==navigator.getBattery?navigator.getBattery().then((t=>{n=t.level,t.level<.2&&!1===t.charging&&(s=!1),Ppf.logQueue({type:"TrainStart",zuid:crmZuid,zgid:crmZgid,battery:n,time:$L.moment("").toDate().valueOf(),LastTrain:localStorage.getItem("PredictivePrefetchlastTrain"),AccuratePreds:Ppf.AccuratePreds,TotalPreds:Ppf.TotalPreds,TraininginProgress:window.trainingInProgress,Proceed:s}),!0===s&&!1===window.trainingInProgress&&(Ppf.PastTrains=null===Ppf.PastTrains&&Ppf.TotalPreds>0?[Number((Ppf.AccuratePreds/Ppf.TotalPreds).toFixed(2))]:null===Ppf.PastTrains&&0===Ppf.TotalPreds?[0]:0===Ppf.TotalPreds&&Ppf.PastTrains.length<5?Ppf.PastTrains.concat([0]):0===Ppf.TotalPreds&&Ppf.PastTrains.length>=5?Ppf.PastTrains.concat([0]).slice(1):Ppf.PastTrains.length<5?Ppf.PastTrains.concat(Number((Ppf.AccuratePreds/Ppf.TotalPreds).toFixed(2))):Ppf.PastTrains.concat(Number((Ppf.AccuratePreds/Ppf.TotalPreds).toFixed(2))).slice(1),localStorage.setItem("PastTrains",Ppf.PastTrains),Ppf.AccuratePreds=0,Ppf.TotalPreds=0,window.trainingInProgress=!0,Ppf.worker.postMessage({process:e,historyLogs:localStorage.getObject("ppfLocationLogs")}))})):(Ppf.logQueue({type:"TrainStart",zuid:crmZuid,zgid:crmZgid,battery:n,time:$L.moment("").toDate().valueOf(),LastTrain:localStorage.getItem("PredictivePrefetchlastTrain"),AccuratePreds:Ppf.AccuratePreds,TotalPreds:Ppf.TotalPreds,TraininginProgress:window.trainingInProgress}),!0===s&&!1===window.trainingInProgress&&(Ppf.PastTrains=null===Ppf.PastTrains&&Ppf.TotalPreds>0?[Number((Ppf.AccuratePreds/Ppf.TotalPreds).toFixed(2))]:null===Ppf.PastTrains&&0===Ppf.TotalPreds?[0]:0===Ppf.TotalPreds&&Ppf.PastTrains.length<5?Ppf.PastTrains.concat([0]):0===Ppf.TotalPreds&&Ppf.PastTrains.length>=5?Ppf.PastTrains.concat([0]).slice(1):Ppf.PastTrains.length<5?Ppf.PastTrains.concat(Number((Ppf.AccuratePreds/Ppf.TotalPreds).toFixed(2))):Ppf.PastTrains.concat(Number((Ppf.AccuratePreds/Ppf.TotalPreds).toFixed(2))).slice(1),localStorage.setItem("PastTrains",Ppf.PastTrains),Ppf.AccuratePreds=0,Ppf.TotalPreds=0,window.trainingInProgress=!0,Ppf.worker.postMessage({process:e,historyLogs:localStorage.getObject("ppfLocationLogs")})))}}if("Predict"===e&&Ppf.prevlocation!==p){var i=sessionStorage.getItem("currentSession"),c=localStorage.getObject("ppfLocationLogs"),d=Ppf.fixedWordIndex,l=!window.trainingInProgress;Ppf.worker.postMessage({historyLogs:localStorage.getItem("ppfLocationLogs"),prevlocation:Ppf.prevlocation,sequence:null!==c&&null!==i&&void 0!==c[i]?c[i]:[],transitionToNumberMap:d,maxSequenceLength:localStorage.getItem("ppfMaxSequenceLength"),process:e,historyCount:localStorage.getItem("ppfHistoryCount"),transitionurl:t.url,currentSessionID:sessionStorage.getItem("currentSessionID"),currentSession:i,modelLastTrainedTime:localStorage.getItem("PredictivePrefetchlastTrain"),zgid:sessionStorage.getItem("Zgid"),zgidactual:crmZgid,predict:l})}Ppf.worker.onmessage=function(e){if("Train"===e.data.process&&(window.trainingInProgress=!1),"Train"===e.data.process&&!0===e.data.result){localStorage.setItem("ppfMaxSequenceLength",e.data.maxSequenceLength);let t={type:"Train",backendtime:$L.moment("").toDate().valueOf(),zgid:crmZgid,zuid:crmZuid,size:e.data.modelsize,time:e.data.time,predictionscore:e.data.accuracy,validationscore:e.data.valaccuracy,tabid:e.data.historyCount,totalTokenCount:e.data.totalTokenCount,maxSequenceLength:e.data.maxSequenceLength,trainingDataLength:e.data.trainingDataLength,epochsCompleted:e.data.epochsCompleted,sessioncount:e.data.sessioncount,pastTrains:Ppf.PastTrains,wordIndex:JSON.parse(JSON.stringify(Ppf.fixedWordIndex)),modelLastTrainedTime:e.data.modelLastTrainedTime};localStorage.setItem("PredictivePrefetchlastTrain",e.data.modelLastTrainedTime),Ppf.logQueue(t)}else if("Predict"===e.data.process){var r=e.data.historyCount,a=e.data.historyLogs;if(void 0===e.data.wordIndex||null===e.data.wordIndex){let t={type:"UndefValue",backendtime:$L.moment("").toDate().valueOf(),zgid:crmZgid,zuid:crmZuid,currentSession:e.data.currentSessionZuid,histCount:r,historyLogs:JSON.parse(JSON.stringify(a))};Ppf.logQueue(t)}else{Ppf.fixedWordIndex=e.data.wordIndex,localStorage.setObject("fixedWordIndex",Ppf.fixedWordIndex);var o=e.data.currentSession,s=e.data.currentSessionId,n=e.data.zgid;localStorage.setItem("ppfHistoryCount",r),localStorage.setItem("ppfLocationLogs",a),localStorage.setItem("PredictivePrefetchlastTrain",e.data.modelLastTrainedTime),sessionStorage.setItem("currentSession",o),sessionStorage.setItem("currentSessionID",s),sessionStorage.setItem("Zgid",n);let i=localStorage.getItem("ppfHistoryCount");Number(i)/2e3>=1&&Number(i)%2e3==0&&!0!==window.trainingInProgress&&Ppf.PredWorker("Train",t),null!==e.data.predresult&&(Ppf.PredRecord.backendtime=$L.moment("").toDate().valueOf(),Ppf.PredRecord.currenturl=Rft.processUrlString(t.url),Ppf.PredRecord.predictedurl=void 0===e.data.predresult||NaN===e.data.predresult?"Notdef":e.data.predresult,Ppf.PredRecord.prevurl=Ppf.prevlocation,Ppf.PredRecord.predictionscore=e.data.predictionscore,Ppf.PredRecord.predsequence=e.data.sequence,Ppf.PredRecord.modelLastTrainedTime=e.data.modelLastTrainedTime,Ppf.PredRecord.sessionid=s,Ppf.PredRecord.sessioniddata=e.data.currentSessionId,Ppf.PredRecord.predictedValue=e.data.predictedValue)}}}}else localStorage.removeItem("PredictivePrefetchlastTrain"),localStorage.removeItem("ppfLocationLogs"),localStorage.removeItem("ppfHistoryCount"),localStorage.removeItem("ppfMaxSequenceLength"),localStorage.removeItem("AccuratePreds"),localStorage.removeItem("PastTrains"),localStorage.removeItem("TotalPreds"),indexedDB.deleteDatabase("tensorflowjs")},clearResourceTimings:function(){performance.clearResourceTimings()},navigationtime:function(){var e=performance.getEntriesByType("resource"),t=null,r=null,a=0;return e.forEach((e=>{"link"!==e.initiatorType&&"script"!==e.initiatorType||(a+=e.transferSize),null===t&&(t=e.connectStart),null===r&&(r=e.responseEnd),t>e.connectStart&&(t=e.connectStart),r<e.responseEnd&&(r=e.responseEnd)})),{time:r-t,size:a}},routedatapush:function(){null!==Ppf.PredRecordQueue&&Ppf.pushRouteLog(Ppf.PredRecordQueue),localStorage.setItem("AccuratePreds",Ppf.AccuratePreds),localStorage.setItem("TotalPreds",Ppf.TotalPreds)}};Ppf.worker.postMessage({process:"Initial",TF_url:networkUtils.returnDependencyFiles(["zcrm_tf.js"],ResourceConstants.CRM)}),window.addEventListener("visibilitychange",Ppf.routedatapush),window.addEventListener("click",Ppf.clearResourceTimings,{capture:!0})}