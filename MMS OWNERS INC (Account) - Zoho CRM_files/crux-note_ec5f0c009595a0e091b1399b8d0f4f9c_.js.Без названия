Lyte.Component.register("crux-note",{_template:'<template tag-name="crux-note"> <div class="cxNoteNewUI cruxNotesCompWrap pR" style="{{if(cxPropNoteWidth,concat(\'width: \',concat(cxPropNoteWidth,\'px\')),\'\')}}"> <div class="cxNoteHeadingSection"> <div class="cxNoteHeadingInnerDiv"> <template is="if" value="{{cxPropNoteHeaderYield}}"><template case="true"> <lyte-yield yield-name="cxNoteHeaderYield"></lyte-yield> </template><template case="false"> <div class="ntit cxNoteHeading showHideCruxNote {{if(cxPropPreventHeaderNotesHide,\'\',cP)}} " onclick="{{action(\'showHideCruxNote\')}}"> {{cxPropNoteHeaderTitle}} <template is="if" value="{{cxPropNoteCountNeeded}}"><template case="true"> <span class="cxNoteCount">{{cxPropNotesMetaData.count}}</span> </template></template> </div> </template></template> <span data-zcqa="notesOrderChange" class="cruxNoteToggleArrow mT5 mB3"></span> <div class="cxNoteHeaderSuffixWrap"> <template is="if" value="{{cxPropNoteHeaderSuffixYield}}"><template case="true"> <lyte-yield class="cxNoteHeaderSuffixYield" yield-name="cxNoteHeaderSuffixYield"></lyte-yield> </template></template> <lyte-dropdown class="cxNotesSortDropdown" data-zcqa="notesOrderChange" on-before-add="{{method(\'setSelectionClass\')}}" on-show="{{method(\'noteFilterShow\')}}" lt-prop-type="multiple"> <template is="registerYield" yield-name="yield"> <lyte-drop-button> <span> {{cxPropNotesOrder}} </span> </lyte-drop-button> <lyte-drop-box> <lyte-drop-body class="cruxNoteToggleOptions"> <lyte-drop-group class="moduleBasedGroup"> <template is="for" items="{{notesFilters}}" item="notesFilter" index="index"> <template is="if" value="{{expHandlers(notesFilter.api_name,\'===\',&quot;All&quot;)}}"><template case="true"> <lyte-drop-item class="{{if(ifEquals(cxPropSelectedFilter,\'All\'),\'cruxNoteSelectedToggle\',\'\')}} moduleBasedSorting" data-value="{{notesFilter.api_name}}">{{cruxGetI18n(\'crm.globalsearch.option.all\')}}</lyte-drop-item> </template><template case="false"> <lyte-drop-item class="moduleBasedSorting {{if(ifEquals(cxPropSelectedFilter,notesFilter.api_name),\'cruxNoteSelectedToggle\',\'\')}}" data-value="{{notesFilter.api_name}}">{{cruxGetI18n(\'crm.territory.label.only\',notesFilter.display)}} <template is="if" value="{{expHandlers(notesFilter.api_name,\'==\',\'Projects\')}}"><template case="true"> <span class="cxVam cxInfoIcon mL5" lt-prop-title="{{cruxGetI18n(\'crm.project.sync.notes.info\')}}"></span> </template></template> </lyte-drop-item> </template></template> </template> </lyte-drop-group> <lyte-drop-group> <lyte-drop-item class="timeBasedSorting {{if(ifEquals(cxPropNotesOrder,cruxGetI18n(\'crm.note.recent.first\')),\'cruxNoteSelectedToggle\',\'\')}}" data-value="{{cruxGetI18n(\'crm.note.recent.first\')}}">{{cruxGetI18n(\'crm.note.recent.first\')}}</lyte-drop-item> <lyte-drop-item class="timeBasedSorting {{if(ifEquals(cxPropNotesOrder,cruxGetI18n(\'crm.note.recent.last\')),\'cruxNoteSelectedToggle\',\'\')}}" data-value="{{cruxGetI18n(\'crm.note.recent.last\')}}">{{cruxGetI18n(\'crm.note.recent.last\')}}</lyte-drop-item> </lyte-drop-group> </lyte-drop-body> </lyte-drop-box> </template> </lyte-dropdown> </div> </div> </div> <div class="cruxNotes"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(cxPropNotesOrder,\'===\',cruxGetI18n(\'crm.note.recent.first\')),\'&amp;&amp;\',expHandlers(newTextbox,\'!\')),\'&amp;&amp;\',cxPropShowAddNote)}}"><template case="true"> <div class="notesTextInputBoxWrap"> <div class="titleInputSection" style="display: none;"> <lyte-input class="cxNoteTitleInput pL20 noteTitle" lt-prop-placeholder="{{cruxGetI18n(\'crm.general.addtitle\')}}..." lt-prop-maxlength="120" onkeyup="{{action(\'saveNoteOnEnter\',event,this)}}" lt-prop-class="cxNoteTitleInputElem" onfocusout="{{action(\'hideTitleInputBox\',event)}}"></lyte-input> </div> <lyte-input data-zcqa="notesProcess" class="inputBeforeNote" lt-prop-class="cxNoteBeforeOpenInput" onfocus="{{action(\'openNotesTextarea\')}}" lt-prop-placeholder="{{cruxGetI18n(\'crm.general.addnote\')}}..." lt-prop-readonly="{{if(cxPropEntity.id,false,true)}}"></lyte-input> <div class="notesTextArea" style="display: none;"> <lyte-input data-zcqa="notesContentTxt" class="cxNotesTextarea notesTextInputBox" id="noteTextarea{{instanceNo}}" lt-prop-type="textarea" lt-prop-placeholder="{{cruxGetI18n(\'crm.general.addnote\')}}" lt-prop-class="cxNotesTextareaElem" lt-prop-text-area-resize="{&quot;horizontal&quot;:false, &quot;vertical&quot;: true}" ontransitionend="{{action(\'onTextAreaTransition\',this)}}"></lyte-input> <div class="cxNotesFooter notesTextAreaWrap"> <div class="cxNotesFooterLeft"> <span data-zcqa="notesAttachFile" class="dIB cxVam attachementActionArea{{instanceNo}} cxNotesAttachIcon cP notesOtherAction cxNotesAttachActionArea" style="{{if(cruxOr(ifEquals(currentNoteUploadedAttachments.length,5),cxPropDisableAttachmentActions),\'display: none\')}}"></span> <span data-zcqa="notesaddTitle" class="notesOtherAction cxNotesAddTitle" onclick="{{action(\'addTitleForThisNote\',event)}}"> {{cruxGetI18n(\'crm.general.addtitle\')}} </span> <template is="if" value="{{expHandlers(expHandlers(expHandlers(isClientPortalUser,\'!\'),\'&amp;&amp;\',cxPropEntity.$client_portal_permission),\'&amp;&amp;\',cxPropEntity.$client_portal_permission.notes)}}"><template case="true"> <lyte-checkbox data-zcqa="notesShareToCustomer" class="cxNoteCheckbox notesOtherAction" lt-prop-disabled="{{disableShare}}" lt-prop-label-class="cxNoteCkboxLabel" lt-prop-label="{{cruxGetI18n(&quot;custmr.prtl.notes.shr.to.custmr&quot;)}}" on-changed="{{method(\'updateShareToCustomer\')}}"></lyte-checkbox> </template></template> </div> <div class="cxMlAuto cxNotesFooterRight"> <div class="cxFooterRightPrefixYield"> <template is="if" value="{{cxPropFooterRightPrefixYield}}"><template case="true"> <lyte-yield yield-name="cxNoteRightPrefixYield"></lyte-yield> </template></template> </div> <lyte-button data-zcqa="notesCancelComment" lt-prop-size="small" class="cruxNoteCancelBtn{{instanceNo}} cxCancelbtn" onclick="{{action(\'closeNotesTextarea\')}}"> <template is="registerYield" yield-name="text"> {{cruxGetI18n(\'crm.button.cancel\')}} </template> </lyte-button> <lyte-button data-zcqa="notesSaveComment" lt-prop-size="small" class="mR0 cruxNoteSaveBtn{{instanceNo}}" lt-prop-appearance="primary" onclick="{{action(\'saveNote\')}}"> <template is="registerYield" yield-name="text"> {{cruxGetI18n(\'crm.button.save\')}} </template> </lyte-button> </div> </div> <div id="noteMoreFiles" class="noteMoreFiles cxNoteMoreFiles cruxNoteFiles{{instanceNo}} attachzone" style="{{if(showAttachments,&quot;display: block&quot;,&quot;display: none&quot;)}}"> <template is="for" items="{{currentNoteUploadedAttachments}}" item="attachment" index="index"> <div class="cxAtt_{{attachment.id}} cxNotesAttachmentWrap"> <span class="dIB cx-{{attachment.mappedFileExtn}}-icon cxNotesAttachmentIcons cxVam mR5"></span> <span class="cxVam dIB cxLink cxNotesAttachedListName">{{attachment.File_Name}}</span> <span class="cxVam dIB"> {{concat(\' ( \',attachment.formattedSize,\' ) \')}} </span> <template is="if" value="{{expHandlers(cxPropDisableAttachmentActions,\'!\')}}"><template case="true"> <span class="cP cxNotesAttachmentRemoveIcon dIB mL5" onclick="{{action(\'removeAttachment\',event)}}"></span> </template></template> </div> </template> </div> </div> </div> </template></template> <template is="if" value="{{expHandlers(expHandlers(cxPropNotesLoading,\'!\'),\'&amp;&amp;\',expHandlers(expHandlers(notesDownloaded,\'&amp;&amp;\',expHandlers(allNotesCount,\'>\',defaultDisplayedNotesCount)),\'&amp;&amp;\',expHandlers(cxPropNotesOrder,\'===\',cruxGetI18n(\'crm.note.recent.last\'))))}}"><template case="true"> <div class="cxShowMoreNotes showMoreNotes recentLastLink" id="showPreviousNote" onclick="{{action(\'showMoreNotes\')}}"> <div> <div class="cxNotesCommonLinkColor cxNotesSmallFont ">{{cruxGetI18n(\'crm.note.view.previous\')}}</div> </div> <div class="cxNotesGraytxt"> <span class="displayedNotesCount">{{defaultDisplayedNotesCount}}</span> <span class="cxNotesGreyColorWithoutHover cxNotesSmallFont ">{{cruxGetI18n(\'of\')}}</span> <span class="totalNotesCount">{{allNotesCount}}</span> </div> </div> </template></template> <ul class="cruxNotesList cxNotesUl {{if(ifEquals(cxPropNotesOrder,cruxGetI18n(\'crm.note.recent.first\')),\'cxNoteRecentFirst\',\'cxNoteRecentLast\')}}" data-zcqa="cruxNotesListHolder"> <template is="if" value="{{cxPropNotesLoading}}"><template case="true"> <crux-note-loading></crux-note-loading> </template><template case="false"><template is="if" value="{{expHandlers(expHandlers(cxPropEmptyNoteMessage,\'&amp;&amp;\',expHandlers(expHandlers(allNotes,\'!\'),\'||\',expHandlers(allNotes.length,\'==\',0))),\'&amp;&amp;\',expHandlers(cxPropShowAddNote,\'!\'))}}"><template case="true"> <div class="cxNotesNoRecord"> {{cxPropEmptyNoteMessage}} </div> </template><template case="false"><template is="for" items="{{allNotes}}" item="note" index="index"><template is="if" value="{{note.Parent_Id}}"><template case="true"> <li class="pR cx_{{note.id}} cxNotesLi" data-zcqa="cx_zcqa_{{note.id}}"> <template is="if" value="{{expHandlers(note.imageLink,\'==\',\'noPhoto\')}}"><template case="true"> <span class="cxNotesAddedUserImg cxNoteDefaultUserImage dIB"></span> </template><template case="false"> <img class="cxNotesAddedUserImg mT7" src="{{note.imageLink}}"> </template></template> <div class="cxNotesContentWrap"> <template is="if" value="{{cxPropPrefixYield}}"><template case="true"> <lyte-yield yield-name="cxNotePrefixYield" note-data="{{note}}"></lyte-yield> </template></template> <div id="noteMainDiv" class="cxNotesAddressWrapper"> <template is="if" value="{{note.Note_Title}}"><template case="true"> <lyte-text class="cxNoteTitleSpan dB" lt-prop-value="{{note.Note_Title}}"></lyte-text> </template></template> <template is="if" value="{{note.Parent_Id.Check_In_City}}"><template case="true"> <span class="map-marker-greenbg"></span> <span class="cxNotesAddressLookupWrap"> <span class="cxVat">{{getI18n(\'crm.label.checkedin\')}}</span> <template is="if" value="{{cxPropEntity.What_Id}}"><template case="true"> <template is="if" value="{{cxPropEntity.Who_Id}}"><template case="true"> <crux-lookup-component cx-prop-value="{{cxPropEntity.What_Id.name}}" cx-prop-route-name="crm.tab.module.entity.detail" cx-prop-dynamic-params="[&quot;{{if(ifEquals(getModuleNameByApiName(cxPropEntity.$se_module),&quot;Deals&quot;),&quot;Potentials&quot;,getModuleNameByApiName(cxPropEntity.$se_module))}}&quot;, &quot;{{cxPropEntity.What_Id.id}}&quot;]" onclick="{{action(\'stopPropagation\',event)}}" cx-prop-icon-class="{{concat(getModuleNameForIcon(recordObj.$se_module),\'Small\')}}" cx-prop-zcqa="{{recordObj[fieldObj.api_name].name}}"></crux-lookup-component> ( <crux-lookup-component cx-prop-value="{{cxPropEntity.Who_Id.name}}" cx-prop-route-name="crm.tab.module.entity.detail" cx-prop-dynamic-params="[&quot;Contacts&quot;, &quot;{{cxPropEntity.Who_Id.id}}&quot;]" onclick="{{action(\'stopPropagation\',event)}}" cx-prop-zcqa="{{recordObj[fieldObj.api_name].name}}"></crux-lookup-component> ) </template><template case="false"> <crux-lookup-component cx-prop-value="{{cxPropEntity.What_Id.name}}" cx-prop-route-name="crm.tab.module.entity.detail" cx-prop-dynamic-params="[&quot;{{if(ifEquals(getModuleNameByApiName(cxPropEntity.$se_module),&quot;Deals&quot;),&quot;Potentials&quot;,getModuleNameByApiName(cxPropEntity.$se_module))}}&quot;, &quot;{{cxPropEntity.What_Id.id}}&quot;]" onclick="{{action(\'stopPropagation\',event)}}" cx-prop-icon-class="{{concat(getModuleNameForIcon(recordObj.$se_module),\'Small\')}}" cx-prop-zcqa="{{recordObj[fieldObj.api_name].name}}"></crux-lookup-component> </template></template> </template></template> <span class="notesbluetxt ">@</span> <span class="notesbluetxt " onclick="{{action(\'openMap\',note)}}" title="{{concat(if(note.Parent_Id.Check_In_Sub_Locality,concat(note.Parent_Id.Check_In_Sub_Locality,\', \'),\'\'),note.Parent_Id.Check_In_City)}}"> {{concat(if(note.Parent_Id.Check_In_Sub_Locality,concat(note.Parent_Id.Check_In_Sub_Locality,\', \'),\'\'),note.Parent_Id.Check_In_City)}} </span> </span> </template></template> <template is="if" value="{{expHandlers(expHandlers(note.actualContent.length,\'>\',cxPropNoteContentLimit),\'&amp;&amp;\',expHandlers(currentSavedNote,\'!=\',note.id))}}"><template case="true"> <pre class="cxNotesAddedContent notesAddedContent showSeeMore" data-zcqa="cruxNoteContent"><template is="if" value="{{expHandlers(expHandlers(note.hasLinks,\'===\',&quot;true&quot;),\'&amp;&amp;\',expHandlers(note.startPos[0],\'<\',cxPropMaxNoteContentLength))}}"><template case="true">{{cruxStringSeg(note.unformattedNoteContent,0,note.startPos[0])}}<template is="for" items="{{note.startPos}}" item="startIndex" index="index"><template is="if" value="{{expHandlers(note.endPosIdx,\'>=\',note.endPos[index])}}"><template case="true"><template is="if" value="{{expHandlers(index,\'===\',0)}}"><template case="true">{{unescape(cruxStringSeg(note.unformattedNoteContent,note.startPos[index],note.endPos[index]))}}</template><template case="false">{{cruxStringSeg(note.unformattedNoteContent,cruxGetItemAtIndex(note.endPos,expHandlers(index,\'-\',1)),note.startPos[index])}}{{unescape(cruxStringSeg(note.unformattedNoteContent,note.startPos[index],note.endPos[index]))}}</template></template></template></template></template><template is="if" value="{{note.seeMoreLastIdx}}"><template case="true">{{cruxStringSeg(note.actualContent,note.seeMoreLastIdx,cxPropMaxNoteContentLength)}}</template></template></template><template case="false">{{cruxSubstr(note.unformattedNoteContent,cxPropMaxNoteContentLength)}}</template></template> <span class="cruxNoteSeeMore cxNotesCommonLinkColor" onclick="{{action(\'showFullNoteContent\',note.id)}}">{{cruxGetI18n("crm.label.More")}}</span></pre> </template></template> <pre class="cxNotesAddedContent notesAddedContent showFullContent" data-zcqa="cruxNoteContent" style="{{if(cruxAnd(cruxIfGt(note.actualContent.length,cxPropNoteContentLimit),ifNotEquals(currentSavedNote,note.id)),\'display: none\',\'\')}}"><template is="if" value="{{expHandlers(note.hasLinks,\'===\',&quot;true&quot;)}}"><template case="true">{{cruxStringSeg(note.unformattedNoteContent,0,note.startPos[0])}}<template is="for" items="{{note.startPos}}" item="startIndex" index="index"><template is="if" value="{{expHandlers(index,\'===\',0)}}"><template case="true">{{unescape(cruxStringSeg(note.unformattedNoteContent,note.startPos[index],note.endPos[index]))}}</template><template case="false">{{cruxStringSeg(note.unformattedNoteContent,cruxGetItemAtIndex(note.endPos,expHandlers(index,\'-\',1)),note.startPos[index])}}{{unescape(cruxStringSeg(note.unformattedNoteContent,note.startPos[index],note.endPos[index]))}}</template></template></template>{{cruxStringSeg(note.unformattedNoteContent,note.lastIndex)}}</template><template case="false"><template is="if" value="{{expHandlers(note.hasLinks,\'===\',&quot;false&quot;)}}"><template case="true">{{note.unformattedNoteContent}}</template></template></template></template></pre> <template is="if" value="{{note.$attachments}}"><template case="true"> <div class="cxNotesAttachementWrap mT10 mB30"> <ul class="m0 p0 cxNotesAttachementUl"> <template is="for" items="{{note.$attachments}}" item="attachment" index="index"> <li class="cxNotesAttachementList"> <div class="cxNotesAttachElem pR dIB cP"> <template is="if" value="{{attachment.isImage}}"><template case="true"> <a title="{{attachment.File_Name}}" class="cxNotesAttachElemImgWrap cxNotesAttachImage dIB oH" href="{{cruxGetCrmBasePath()}}/ViewImage?fileId={{cruxEncodeURL(attachment.$file_id)}}&amp;name={{cruxEncodeURIComponent(attachment.File_Name)}}&amp;downLoadMode=default&amp;creatorId={{cruxEncodeURL(attachment.Created_By.id)}}&amp;parentId={{cruxEncodeURL(note.entity.id)}}&amp;nId={{cruxEncodeURL(note.id)}}&amp;module={{cruxEncodeURL(cxPropModule)}}"> <img title="{{attachment.File_Name}}" class="cxNotesAttachElemImg" src="{{cruxGetCrmBasePath()}}/EntityImageAttach.do?&amp;actionName=readImage&amp;fileId={{cruxEncodeURL(attachment.encAttachFileId)}}&amp;entityId={{cruxEncodeURL(note.entity.id)}}&amp;action_module={{cruxEncodeURL(cxPropModule)}}"> </a> </template><template case="false"><template is="if" value="{{attachment.downLoadMode}}"><template case="true"> <a title="{{attachment.File_Name}}" class="cxNotesAttachNameWrap dIB oH" onclick="{{action(\'openSheetForExport\',event,cruxGetCrmBasePath(),cruxEncodeURL(attachment.$file_id),cruxEncodeURL(cxPropModule),cruxEncodeURL(note.id),cruxEncodeURL(note.entity.id),cruxEncodeURL(attachment.Created_By.id),cruxEncodeURL(attachment.id),cruxEncodeURIComponent(attachment.File_Name),attachment.downLoadMode)}}"> {{cruxShortFileNameLength(attachment.File_Name,12)}} </a> </template><template case="false"> <a title="{{attachment.File_Name}}" class="cxNotesAttachNameWrap dIB oH" href="{{cruxGetCrmBasePath()}}/specific/ViewAttachment?fileId={{cruxEncodeURL(attachment.$file_id)}}&amp;module={{cruxEncodeURL(cxPropModule)}}&amp;nId={{cruxEncodeURL(note.id)}}&amp;parentId={{cruxEncodeURL(note.entity.id)}}&amp;creatorId={{cruxEncodeURL(attachment.Created_By.id)}}&amp;id={{cruxEncodeURL(attachment.id)}}&amp;name={{cruxEncodeURIComponent(attachment.File_Name)}}&amp;downLoadMode=default"> {{cruxShortFileNameLength(attachment.File_Name,12)}} </a> </template></template></template></template> <div class="cxNotesAttachActions cxAlignCenter"> <template is="if" value="{{attachment.isImage}}"><template case="true"> <a class="svgIcons cxNotePreviewIcon" data-zcqa="{{concat(\'cxNotePreview\',attachment.File_Name)}}" lt-prop-title="{{cruxGetI18n(\'crm.label.view\')}}" onclick="{{action(\'fireClickEvent\',event)}}" href="{{cruxGetCrmBasePath()}}/ViewImage?fileId={{cruxEncodeURL(attachment.$file_id)}}&amp;name={{cruxEncodeURIComponent(attachment.File_Name)}}&amp;downLoadMode=default&amp;creatorId={{cruxEncodeURL(attachment.Created_By.id)}}&amp;parentId={{cruxEncodeURL(note.entity.id)}}&amp;nId={{cruxEncodeURL(note.id)}}&amp;module={{cruxEncodeURL(cxPropModule)}}"></a> </template><template case="false"><template is="if" value="{{attachment.downLoadMode}}"><template case="true"> <a class="dIB oH svgIcons cxNotePreviewIcon" data-zcqa="{{concat(\'cxNotePreview\',attachment.File_Name)}}" lt-prop-title="{{cruxGetI18n(\'crm.label.view\')}}" onclick="{{action(\'openSheetForExport\',event,cruxGetCrmBasePath(),cruxEncodeURL(attachment.$file_id),cruxEncodeURL(cxPropModule),cruxEncodeURL(note.id),cruxEncodeURL(note.entity.id),cruxEncodeURL(attachment.Created_By.id),cruxEncodeURL(attachment.id),cruxEncodeURIComponent(attachment.File_Name),attachment.downLoadMode)}}"></a> </template><template case="false"> <a class="dIB oH" data-zcqa="{{concat(\'cxNotePreview\',attachment.File_Name)}}" lt-prop-title="{{cruxGetI18n(\'crm.label.view\')}}" href="{{cruxGetCrmBasePath()}}/specific/ViewAttachment?fileId={{cruxEncodeURL(attachment.$file_id)}}&amp;module={{cruxEncodeURL(cxPropModule)}}&amp;nId={{cruxEncodeURL(note.id)}}&amp;parentId={{cruxEncodeURL(note.entity.id)}}&amp;creatorId={{cruxEncodeURL(attachment.Created_By.id)}}&amp;id={{cruxEncodeURL(attachment.id)}}&amp;name={{cruxEncodeURIComponent(attachment.File_Name)}}&amp;downLoadMode=default"></a> </template></template></template></template> <a lt-prop-title="{{cruxGetI18n(\'crm.view.attachment.download\')}}" class="svgIcons cxNoteDownloadIcon" data-zcqa="{{concat(\'cxNoteDownload\',attachment.File_Name)}}" href="{{cruxGetCrmBasePath()}}/specific/ViewAttachment?fileId={{cruxEncodeURL(attachment.$file_id)}}&amp;module={{cruxEncodeURL(cxPropModule)}}&amp;nId={{cruxEncodeURL(note.id)}}&amp;parentId={{cruxEncodeURL(note.entity.id)}}&amp;creatorId={{cruxEncodeURL(attachment.Created_By.id)}}&amp;id={{cruxEncodeURL(attachment.id)}}&amp;name={{cruxEncodeURIComponent(attachment.File_Name)}}&amp;downLoadMode=default"></a> </div> </div> <p class=" cxImageNameContent cxAlignCenter p5 cxImageName" title="{{concat(attachment.File_Name,\' -(\',attachment.formattedSize,\')\')}}"> {{cruxShortFileNameLength(attachment.File_Name,12)}} </p> </li> </template> </ul> </div> </template></template> <div class="cxFlex mT5 cxNotesNoteActionDetails notesOtherActionDetails"> <span class="notesModdet"> <span class="cxNotesModuleName fL" lt-prop-title="{{note.moduleSingularLabel}}"> {{note.moduleSingularLabel}} </span> <span class="pL5 pR5 fL">-</span> <a class="cxNotesCommonLinkColor cxNotesModuleRecordName" id="moduleRecordName{{note.id}}{{instanceNo}}" onmouseover="{{action(\'showModuleRecordTooltip\',true,this,note)}}" onmouseout="{{action(\'showModuleRecordTooltip\',false,this)}}" target="_blank" href="{{cruxGetCrmBasePath()}}/EntityInfo.do?module={{note.module}}&amp;id={{note.entity.id}}" lt-prop-title="{{note.Parent_Id.name}}"> {{note.Parent_Id.name}} </a> <lyte-popover data-zcqa="notesModule" lt-prop-origin-elem="#moduleRecordName{{note.id}}{{instanceNo}}" id="moduleTooltip{{note.id}}{{instanceNo}}" lt-prop-wrapper-class="cruxBCContent" on-show="{{method(\'setPopoverPosition\')}}" lt-prop-freeze="false" lt-prop-show-close-button="false" lt-prop-placement="right left" lt-prop-max-width="436px" lt-prop-duration="300" lt-prop-auto-align="true"> <template is="registerYield" yield-name="popover"> <lyte-popover-content onmouseover="{{action(\'updateFlagData\')}}" onmouseout="{{action(\'updateFlagData1\',note.id)}}"> <div class="cruxNoteOwnerTooltip"> <template is="if" value="{{userInfoRevoked}}"><template case="true"> {{cruxGetI18n("crm.security.error")}} </template><template case="false"> <div class="cruxNoteOwnerProfileInfo"> <template is="if" value="{{expHandlers(cruxGetPhotoField(note.entity),\'===\',&quot;photoField&quot;)}}"><template case="true"> <span class="cruxNoteOwnerImg mR10 dIB cxVam"> <img src="{{cruxGetCrmBasePath()}}/EntityImageAttach.do?action_module={{cruxEncodeURL(note.module)}}&amp;entityId={{note.entity.id}}&amp;actionName=readImage&amp;fileId={{note.entity.Record_Image}}"> </span> </template><template case="false"><template is="if" value="{{expHandlers(cruxGetPhotoField(note.entity),\'===\',&quot;fullNameFirstChar&quot;)}}"><template case="true"> <span class="cruxNoteOwnerNameImg mR10 dIB cxVam">{{cruxStringSeg(note.Parent_Id.name,0,1)}}</span> </template></template></template></template> <div class="dIB cxVam crm-font-bold cruxNoteOwnerName"> <span class="cxLink f15 dB lh20 cruxNoteOnwerSecInfoLink"> <template is="if" value="{{useAnchor}}"><template case="true"> <a href="{{cruxGetCrmBasePath()}}/EntityInfo.do?module={{note.module}}&amp;id={{note.entity.id}}" onclick="{{action(\'trackSpotLight\')}}"> {{cruxGetFieldValue(note.$se_module,note.entity,businessCardFields[0],true)}} </a> </template><template case="false"><template is="if" value="{{useSpan}}"><template case="true"> <span class="yes"></span> </template><template case="false"> {{cruxGetFieldValue(note.$se_module,note.entity,businessCardFields[0],true)}} </template></template></template></template> </span> <template is="if" value="{{expHandlers(businessCardFields[1].businesscard_supported,\'===\',false)}}"><template case="true"> <span class="cruxNoteOnwerSecInfoBC"> <template is="if" value="{{expHandlers(businessCardFields[2].businesscard_supported,\'===\',false)}}"><template case="true"><template is="if" value="{{expHandlers(businessCardFields[1].api_name,\'===\',&quot;Start_DateTime&quot;)}}"><template case="true"> {{cruxGetEventStart_EndTime(note.entity,businessCardFields[1],businessCardFields[2])}} </template><template case="false"> {{cruxGetFieldValue(note.$se_module,note.entity,businessCardFields[1],false)}} - {{cruxGetFieldValue(note.$se_module,note.entity,businessCardFields[2],false)}} </template></template></template><template case="false"> {{cruxGetFieldValue(note.$se_module,note.entity,businessCardFields[1],false)}} </template></template> </span> </template></template> </div> <div class="cxClearLeft"></div> </div> <div class="cruxNoteOwnerDetailedInfo"> <table class="lookupExtraDetailsTbl"> <tbody> <tr is="if" lyte-if="true" value="{{expHandlers(businessCardFields[1].api_name,\'===\',&quot;Start_DateTime&quot;)}}"></tr> <tr is="for" lyte-for="true" items="{{businessCardFields}}" item="bcField" index="index" depth="2"></tr> </tbody> </table> </div> </template></template> </div> </lyte-popover-content> </template> </lyte-popover> </span> <span class="cxNotesListDot"></span> <span data-zcqa="notesAdd" class="cxNotesGreyColor cxNotesAddAnotherNote cP dIB" onclick="{{action(\'openNotesTextarea\',note.entity,note.$se_module)}}"> {{cruxGetI18n(\'crm.label.add.note\')}} </span> <span class="cxNotesListDot"></span> <span class="pR5 cxNotesGreyColor dIB cxNotesModifiedTimeInfo" data-title="{{note.modified_time_full}}" lt-prop-tooltip-config="{&quot;position&quot;: &quot;bottom&quot;, &quot;appearance&quot;: &quot;box&quot;, &quot;margin&quot;: 0, &quot;showdelay&quot;: 0, &quot;hidedelay&quot;: 0, &quot;maxdisplaytime&quot;: 5000 }" lt-prop-title="{{note.modified_time_full}}"> <span class="timerIcon-notes mT4 fL mR5"></span> {{note.modified_time}} </span> <span class="pR5 cxNotesGreyColorWithoutHover dIB">{{cruxGetI18n(\'crm.label.simply.by\')}}</span> <span class="pR5 cxNotesGreyColor dIB" data-title="{{note.Modified_By.name}}" lt-prop-tooltip-config="{&quot;position&quot;: &quot;bottom&quot;, &quot;appearance&quot;: &quot;box&quot;, &quot;margin&quot;: 0, &quot;showdelay&quot;: 0, &quot;hidedelay&quot;: 0, &quot;maxdisplaytime&quot;: 5000 }" lt-prop-title="{{note.Modified_By.name}}"> {{note.Modified_By.name}} </span> <template is="if" value="{{note.$voice_note}}"><template case="true"> <a class=" cxVoiceNoteContent dIB cP" id="voice_{{note.id}}">{{note.$voice_note.file_name}}<span class="cxNoteVoiceFileIcon dIB cxVam"> </span></a> <lyte-menu lt-prop-yield="true" lt-prop-query="#voice_{{note.id}}" lt-prop-freeze="false" id="downloadVoice_{{note.id}}"> <template is="registerYield" yield-name="yield"> <lyte-menu-body id="callMoreOption" class="callMoreOptionLyteNew cscript-attachment-menubody" data-zcqa="callMoreOption"> <lyte-menu-item id="downloadAttach" onclick="{{action(\'downloadVoice\',note)}}" data-zcqa="lnk_download_voice" class="crm-font-regular">{{getI18n(\'crm.view.attachment.download\')}}</lyte-menu-item> </lyte-menu-body> </template> </lyte-menu> <span class="cP mL5 icon_play dIB" onclick="{{action(\'playVoiceNote\',this,note.id)}}" lt-prop-title="Play"></span> <audio id="audio_{{note.id}}" class="mt10" hidden="true" src="{{idVsVoice[note.id]}}" controls="" preload="none"></audio> </template></template> <template is="if" value="{{expHandlers(isClientPortalUser,\'!\')}}"><template case="true"> <template is="if" value="{{note.isPortalUser}}"><template case="true"> <span class="fL pR5 notesgray dIB pL5 mR3 cxPortalErrorNote portal_roll_name h20 boxBB crm-base-font-size">{{cruxGetI18n("custmr.prtl.user.role")}}</span> </template><template case="false"><template is="if" value="{{note.$is_shared_to_client}}"><template case="true"> <span class="cxNotesGreyColor">{{cruxGetI18n("custmr.prtl.notes.shrd.with.custmr")}}</span> </template></template></template></template> </template></template> </div> <template is="if" value="{{expHandlers(note.Parent_Id.Check_In_City,\'!\')}}"><template case="true"> <div class="addedNotesActionArea cxNoteEditDeleteWrap"> <template is="if" value="{{expHandlers(note._showEditable,\'&amp;&amp;\',cxPropShowNotesEdit)}}"><template case="true"> <div data-zcqa="notesEdit" class="cxNoteEditIconWrap editAddedNote {{if(note._editable,\'\',\'cxDisableEditBtn\')}}" lt-prop-title="{{if(note._editable,cruxGetI18n(\'Edit\'),cruxGetI18n(\'crm.security.error\'))}}" lt-prop-tooltip-config="{&quot;showdelay&quot;: 1000}" onclick="{{action(\'editNote\',note.id)}}"> <span class="cxNoteEditIcon"></span> </div> </template></template> <template is="if" value="{{expHandlers(note._showDeletable,\'&amp;&amp;\',cxPropShowNotesDelete)}}"><template case="true"> <div data-zcqa="notesDelete" class="cxNoteDeleteIconWrap deleteAddedNote {{if(note._deletable,\'\',\'cxDisableDeleteBtn\')}}" lt-prop-title="{{if(note._deletable,cruxGetI18n(\'crm.button.mass.delete\'),cruxGetI18n(\'crm.security.error\'))}}" lt-prop-tooltip-config="{&quot;showdelay&quot;:1000}" onclick="{{action(\'showDeleteConfirmationModal\',note.id,note.Note_Title,note.Note_Content)}}"> <span class="cxNoteDeleteIcon"></span> </div> </template></template> </div> </template></template> </div> </div> </li> </template></template></template></template></template></template></template> </ul> <template is="if" value="{{expHandlers(expHandlers(cxPropNotesLoading,\'!\'),\'&amp;&amp;\',expHandlers(expHandlers(notesDownloaded,\'&amp;&amp;\',expHandlers(allNotesCount,\'>\',defaultDisplayedNotesCount)),\'&amp;&amp;\',expHandlers(cxPropNotesOrder,\'===\',cruxGetI18n(\'crm.note.recent.first\'))))}}"><template case="true"> <div class="cxShowMoreNotes showMoreNotes recentFirstLink" id="showPreviousNote" onclick="{{action(\'showMoreNotes\')}}"> <div> <div class="cxNotesCommonLinkColor cxShowMoreNotesContent ">{{cruxGetI18n(\'crm.note.view.previous\')}}</div> </div> <div class="cxNotesGraytxt"> <span class="displayedNotesCount">{{defaultDisplayedNotesCount}}</span> <span class="cxNotesGreyColorWithoutHover cxNotesGrayTxtContent ">{{cruxGetI18n(\'of\')}}</span> <span class="totalNotesCount">{{allNotesCount}}</span> </div> </div> </template></template> <template is="if" value="{{expHandlers(expHandlers(expHandlers(cxPropNotesOrder,\'===\',cruxGetI18n(\'crm.note.recent.last\')),\'&amp;&amp;\',expHandlers(newTextbox,\'!\')),\'&amp;&amp;\',cxPropShowAddNote)}}"><template case="true"> <div class="notesTextInputBoxWrap"> <div class="titleInputSection" style="display: none;"> <lyte-input class="cxNoteTitleInput pL20 noteTitle" lt-prop-placeholder="{{cruxGetI18n(\'crm.general.addtitle\')}}..." lt-prop-maxlength="120" onkeyup="{{action(\'saveNoteOnEnter\',event,this)}}" lt-prop-class="cxNoteTitleInputElem" onfocusout="{{action(\'hideTitleInputBox\',event)}}"></lyte-input> </div> <lyte-input data-zcqa="notesProcess" class="inputBeforeNote" lt-prop-class="cxNoteBeforeOpenInput" onfocus="{{action(\'openNotesTextarea\')}}" lt-prop-placeholder="{{cruxGetI18n(\'crm.general.addnote\')}}..." lt-prop-readonly="{{if(cxPropEntity.id,false,true)}}"></lyte-input> <div class="notesTextArea" style="display: none;"> <lyte-input data-zcqa="notesContentTxt" class="cxNotesTextarea notesTextInputBox" id="noteTextarea{{instanceNo}}" lt-prop-type="textarea" lt-prop-placeholder="{{cruxGetI18n(\'crm.general.addnote\')}}" lt-prop-class="cxNotesTextareaElem" lt-prop-text-area-resize="{&quot;horizontal&quot;:false, &quot;vertical&quot;: true}" ontransitionend="{{action(\'onTextAreaTransition\',this)}}"></lyte-input> <div class="cxNotesFooter notesTextAreaWrap"> <div class="cxNotesFooterLeft"> <span data-zcqa="notesAttachFile" tabindex="0" role="button" lt-prop-aria-keydown="true" class="dIB cxVam attachementActionArea{{instanceNo}} cxNotesAttachIcon cP notesOtherAction cxNotesAttachActionArea" style="{{if(cruxOr(ifEquals(currentNoteUploadedAttachments.length,5),cxPropDisableAttachmentActions),\'display: none\')}}"></span> <span data-zcqa="notesaddTitle" tabindex="0" role="button" lt-prop-aria-keydown="true" class="notesOtherAction cxNotesAddTitle" onclick="{{action(\'addTitleForThisNote\',event)}}"> {{cruxGetI18n(\'crm.general.addtitle\')}} </span> <template is="if" value="{{expHandlers(expHandlers(expHandlers(isClientPortalUser,\'!\'),\'&amp;&amp;\',cxPropEntity.$client_portal_permission),\'&amp;&amp;\',cxPropEntity.$client_portal_permission.notes)}}"><template case="true"> <lyte-checkbox data-zcqa="notesShareToCustomer" class="cxNoteCheckbox notesOtherAction" lt-prop-disabled="{{disableShare}}" lt-prop-label="{{cruxGetI18n(&quot;custmr.prtl.notes.shr.to.custmr&quot;)}}" on-changed="{{method(\'updateShareToCustomer\')}}"> </lyte-checkbox> </template></template> </div> <div class="cxMlAuto cxNotesFooterRight"> <div class="cxFooterRightPrefixYield"> <template is="if" value="{{cxPropFooterRightPrefixYield}}"><template case="true"> <lyte-yield yield-name="cxNoteRightPrefixYield"></lyte-yield> </template></template> </div> <lyte-button data-zcqa="notesCancelComment" lt-prop-size="small" class="cruxNoteCancelBtn{{instanceNo}} cxCancelbtn" onclick="{{action(\'closeNotesTextarea\')}}"> <template is="registerYield" yield-name="text"> {{cruxGetI18n(\'crm.button.cancel\')}} </template> </lyte-button> <lyte-button data-zcqa="notesSaveComment" lt-prop-size="small" class="mR0 cruxNoteSaveBtn{{instanceNo}}" lt-prop-appearance="primary" onclick="{{action(\'saveNote\')}}"> <template is="registerYield" yield-name="text"> {{cruxGetI18n(\'crm.button.save\')}} </template> </lyte-button> </div> </div> <div id="noteMoreFiles" class="noteMoreFiles cxNoteMoreFiles cruxNoteFiles{{instanceNo}} attachzone" style="{{if(showAttachments,&quot;display: block&quot;,&quot;display: none&quot;)}}"> <template is="for" items="{{currentNoteUploadedAttachments}}" item="attachment" index="index"> <div class="cxAtt_{{attachment.id}} cxNotesAttachmentWrap"> <span class="dIB cx-{{attachment.mappedFileExtn}}-icon cxNotesAttachmentIcons cxVam mR5"></span> <span class="cxVam dIB cxLink cxNotesAttachedListName">{{attachment.File_Name}}</span> <span class="cxVam dIB"> {{concat(\' ( \',attachment.formattedSize,\' ) \')}} </span> <template is="if" value="{{expHandlers(cxPropDisableAttachmentActions,\'!\')}}"><template case="true"> <span class="cP cxNotesAttachmentRemoveIcon dIB mL5" onclick="{{action(\'removeAttachment\',event)}}"></span> </template></template> </div> </template> </div> </div> </div> </template></template> <lyte-modal class="deleteConfirmationModal" lt-prop-show-close-button="false" lt-prop-wrapper-class="cxBoxModal" lt-prop-offset="{&quot;top&quot;:&quot;0px&quot;,&quot;left&quot;:&quot;center&quot;}" lt-prop-transition="{&quot;animation&quot;:&quot;slideFromTop&quot;,&quot;duration&quot;:&quot;0.1&quot;}" on-close="{{method(\'deleteConfirmationModalClosed\')}}"> <template is="registerYield" yield-name="modal"> <lyte-modal-header> {{cruxGetI18n(\'crm.warning.delete.record\',cruxSubstr(if(currentNoteTitle,currentNoteTitle,currentNoteContent),35))}} </lyte-modal-header> <lyte-modal-footer class="center"> <lyte-button lt-prop-appearance="failure" class="confirmNoteDeleteButton" onclick="{{action(\'deleteNote\')}}"> <template is="registerYield" yield-name="text"> {{cruxGetI18n(\'crm.label.yes\')}} </template> </lyte-button> <lyte-button onclick="{{action(\'hideDeleteconfirmationModal\')}}"> <template is="registerYield" yield-name="text"> {{cruxGetI18n(\'crm.button.cancel\')}} </template> </lyte-button> </lyte-modal-footer> </template> </lyte-modal> <lyte-modal class="noteDataStorageLimit" lt-prop-show-close-button="false" lt-prop-offset="{&quot;top&quot;:&quot;40px&quot;}" lt-prop-close-on-escape="false" lt-prop-wrapper-class="cxNoteStorageLimitModalWrapper"> <template is="registerYield" yield-name="modal"> <lyte-modal-content class="cxNoteStorageLimitContent"> <div class="cxNotesStorageLimitShadow"></div> <div class="cxNotesStorageLimitWarnIcon"></div> <div class="cxNotesStorageLimitInfo"> <div class=" cxNotesStorageLimitInfoContent "> <template is="if" value="{{isClientPortalUser}}"><template case="true"> {{unescape(cruxGetI18n("crm.storage.create.error.client",cruxGetI18n("crm.feed.group.admin")))}} </template><template case="false"> {{unescape(cruxGetI18n("crm.storage.create.error"))}} </template></template> <div class="cxNotesStorageLimitWarnMsg"> {{cruxGetI18n("crm.storage.avail.info",cruxNumToStorage(0,2,if(ifEquals(storageCalcType,"count"),true,false)),cruxNumToStorage(maxStorage,2,if(ifEquals(storageCalcType,"count"),true,false)))}} </div> </div> </div> <template is="if" value="{{expHandlers(isClientPortalUser,\'!\')}}"><template case="true"> <lyte-button data-zcqa="dS_manage_data_storage" lt-prop-appearance="primary" class="cxNoteStorageLimitManageBtn"> <template is="registerYield" yield-name="text"> <a data-zcqa="data_storageUsage" href="{{concat(cruxGetCrmBasePath(),&quot;/settings/storage&quot;)}}" class="cxNotesStorageLimitLink" rel="noopener noreferrer" target="_blank"> {{cruxGetI18n(\'crm.storage.error.key.manage\')}} </a> </template> </lyte-button> </template></template> <div class="cxNotesStorageLimitClose" onclick="{{action(\'closeDSInfoPopup\')}}"></div> </lyte-modal-content> </template> </lyte-modal> </div> </div> </template>',_dynamicNodes:[{type:"attr",position:[1],attr:{style:{name:"style",helperInfo:{name:"if",args:["cxPropNoteWidth",{type:"helper",value:{name:"concat",args:["'width: '",{type:"helper",value:{name:"concat",args:["cxPropNoteWidth","'px'"]}}]}},"''"]}}}},{type:"attr",position:[1,1,1,1]},{type:"if",position:[1,1,1,1],cases:{true:{dynamicNodes:[{type:"insertYield",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,1,1,5,1]},{type:"if",position:[1,1,1,5,1],cases:{true:{dynamicNodes:[{type:"insertYield",position:[1]}]}},default:{}},{type:"attr",position:[1,1,1,5,3]},{type:"registerYield",position:[1,1,1,5,3,1],dynamicNodes:[{type:"text",position:[1,1,1]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1,1,1]},{type:"for",position:[3,1,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]},{type:"attr",position:[1,2]},{type:"if",position:[1,2],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"componentDynamic",position:[1]}]}},default:{}}]},{type:"componentDynamic",position:[3,1,1]},{type:"attr",position:[3,1,3,1]},{type:"text",position:[3,1,3,1,0]},{type:"componentDynamic",position:[3,1,3,1]},{type:"attr",position:[3,1,3,3]},{type:"text",position:[3,1,3,3,0]},{type:"componentDynamic",position:[3,1,3,3]},{type:"componentDynamic",position:[3,1,3]},{type:"componentDynamic",position:[3,1]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[1,1,1,5,3]},{type:"attr",position:[1,3,1]},{type:"if",position:[1,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]},{type:"attr",position:[1,5,1]},{type:"componentDynamic",position:[1,5,1]},{type:"attr",position:[1,5,3,1,1],attr:{style:{name:"style",helperInfo:{name:"if",args:[{type:"helper",value:{name:"cruxOr",args:[{type:"helper",value:{name:"ifEquals",args:["currentNoteUploadedAttachments.length",5]}},"cxPropDisableAttachmentActions"]}},"'display: none'"]}}}},{type:"attr",position:[1,5,3,1,3]},{type:"text",position:[1,5,3,1,3,1]},{type:"attr",position:[1,5,3,1,5]},{type:"if",position:[1,5,3,1,5],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,5,3,3,1,1]},{type:"if",position:[1,5,3,3,1,1],cases:{true:{dynamicNodes:[{type:"insertYield",position:[1]}]}},default:{}},{type:"attr",position:[1,5,3,3,3]},{type:"registerYield",position:[1,5,3,3,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,5,3,3,3]},{type:"attr",position:[1,5,3,3,5]},{type:"registerYield",position:[1,5,3,3,5,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,5,3,3,5]},{type:"attr",position:[1,5,5],attr:{style:{name:"style",helperInfo:{name:"if",args:["showAttachments","'display: block'","'display: none'"]}}}},{type:"attr",position:[1,5,5,1]},{type:"for",position:[1,5,5,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"text",position:[1,3,0]},{type:"text",position:[1,5,1]},{type:"attr",position:[1,7]},{type:"if",position:[1,7],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}]}},default:{}},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,1,0]},{type:"text",position:[1,3,1,0]},{type:"text",position:[1,3,3,0]},{type:"text",position:[1,3,5,0]}]}},default:{}},{type:"attr",position:[1,3,5]},{type:"attr",position:[1,3,5,1]},{type:"if",position:[1,3,5,1],cases:{true:{dynamicNodes:[{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"for",position:[0],dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[]},false:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[1,3,1]},{type:"if",position:[1,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"insertYield",position:[1]}]}},default:{}},{type:"attr",position:[1,3,3,1]},{type:"if",position:[1,3,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,3,3,3]},{type:"if",position:[1,3,3,3],cases:{true:{dynamicNodes:[{type:"text",position:[3,1,0]},{type:"attr",position:[3,3]},{type:"if",position:[3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"componentDynamic",position:[3]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}},{type:"attr",position:[3,7]},{type:"text",position:[3,7,1]}]}},default:{}},{type:"attr",position:[1,3,3,5]},{type:"if",position:[1,3,3,5],cases:{true:{dynamicNodes:[{type:"attr",position:[1,0]},{type:"if",position:[1,0],cases:{true:{dynamicNodes:[{type:"text",position:[0]},{type:"attr",position:[2]},{type:"for",position:[2],dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[0]}]},false:{dynamicNodes:[{type:"text",position:[0]},{type:"text",position:[1]}]}},default:{}}]}},default:{}}]},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"text",position:[0]}]}},default:{}}]},false:{dynamicNodes:[{type:"text",position:[0]}]}},default:{}},{type:"attr",position:[1,2]},{type:"text",position:[1,2,0]}]}},default:{}},{type:"attr",position:[1,3,3,7],attr:{style:{name:"style",helperInfo:{name:"if",args:[{type:"helper",value:{name:"cruxAnd",args:[{type:"helper",value:{name:"cruxIfGt",args:["note.actualContent.length","cxPropNoteContentLimit"]}},{type:"helper",value:{name:"ifNotEquals",args:["currentSavedNote","note.id"]}}]}},"'display: none'","''"]}}}},{type:"attr",position:[1,3,3,7,0]},{type:"if",position:[1,3,3,7,0],cases:{true:{dynamicNodes:[{type:"text",position:[0]},{type:"attr",position:[2]},{type:"for",position:[2],dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[0]}]},false:{dynamicNodes:[{type:"text",position:[0]},{type:"text",position:[1]}]}},default:{}}]},{type:"text",position:[3]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[0]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3,3,9]},{type:"if",position:[1,3,3,9],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"for",position:[1,1,1],dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"if",position:[1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,1,3,1]},{type:"if",position:[1,1,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,1,3,3]},{type:"attr",position:[1,3]},{type:"text",position:[1,3,1]}]}]}},default:{}},{type:"attr",position:[1,3,3,11,1,1]},{type:"text",position:[1,3,3,11,1,1,1]},{type:"attr",position:[1,3,3,11,1,5]},{type:"text",position:[1,3,3,11,1,5,1]},{type:"attr",position:[1,3,3,11,1,7]},{type:"registerYield",position:[1,3,3,11,1,7,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1]},{type:"if",position:[1,1,1],cases:{true:{dynamicNodes:[{type:"text",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3,1,1]},{type:"if",position:[1,3,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[]},false:{dynamicNodes:[{type:"text",position:[1]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1]}]},false:{dynamicNodes:[{type:"text",position:[1]},{type:"text",position:[3]}]}},default:{}}]},false:{dynamicNodes:[{type:"text",position:[1]}]}},default:{}}]}},default:{}},{type:"attr",position:[3,1,1,1]},{type:"if",position:[3,1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,1,1,0]}]}},default:{},actualTemplate:'<template is="if" value="{{note.entity.All_day}}"><template case="true" depth="2"><table><tbody> <tr> <td> <span class="dIB cxNotesOnwerLookupLabel">{{cruxGetAlldayEvent(note.entity,businessCardFields)}}</span> </td> <td> <span class="dIB"> <span class="yes"></span> </span> </td> </tr> </tbody></table></template></template>'}]}},default:{},actualTemplate:'<template is="if" value="{{businessCardFields[1].api_name === &quot;Start_DateTime&quot;}}"><template case="true" depth="2"><table><tbody><tr is="if" lyte-if="true" value="{{note.entity.All_day}}"></tr></tbody></table></template></template>'},{type:"attr",position:[3,1,1,3]},{type:"for",position:[3,1,1,3],dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,1,1,1]},{type:"text",position:[1,3,1,1]}]}},default:{},actualTemplate:'<template is="if" value="{{bcField.businesscard_supported === true &amp;&amp; bcField.column_name !== &quot;ISCALLBILLABLE&quot;}}"><template case="true" depth="2"><table><tbody> <tr> <td> <span class="dIB cxNotesOnwerLookupLabel"> {{bcField.field_label}} </span> </td> <td> <span class="dIB cxNotesOnwerLookupValue"> {{cruxGetFieldValue(note.$se_module,note.entity,bcField,false)}} </span> </td> </tr> </tbody></table></template></template>'}],actualTemplate:'<template is="for" items="{{businessCardFields}}" item="bcField" index="index" depth="2"><table><tbody><tr is="if" lyte-if="true" value="{{expHandlers(expHandlers(bcField.businesscard_supported,\'===\',true),\'&amp;&amp;\',expHandlers(bcField.column_name,\'!==\',&quot;ISCALLBILLABLE&quot;))}}"></tr></tbody></table></template>',tagName:"TBODY"}]}},default:{}},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,3,3,11,1,7]},{type:"attr",position:[1,3,3,11,5]},{type:"text",position:[1,3,3,11,5,1]},{type:"attr",position:[1,3,3,11,9]},{type:"text",position:[1,3,3,11,9,3]},{type:"text",position:[1,3,3,11,11,0]},{type:"attr",position:[1,3,3,11,13]},{type:"text",position:[1,3,3,11,13,1]},{type:"attr",position:[1,3,3,11,15]},{type:"if",position:[1,3,3,11,15],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,0]},{type:"componentDynamic",position:[1,1]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[3]},{type:"attr",position:[5]},{type:"attr",position:[7]}]}},default:{}},{type:"attr",position:[1,3,3,11,17]},{type:"if",position:[1,3,3,11,17],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3,3,13]},{type:"if",position:[1,3,3,13],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}},default:{}}]}},default:{}}]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3,7]},{type:"if",position:[1,3,7],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,1,0]},{type:"text",position:[1,3,1,0]},{type:"text",position:[1,3,3,0]},{type:"text",position:[1,3,5,0]}]}},default:{}},{type:"attr",position:[1,3,9]},{type:"if",position:[1,3,9],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]},{type:"attr",position:[1,5,1]},{type:"componentDynamic",position:[1,5,1]},{type:"attr",position:[1,5,3,1,1],attr:{style:{name:"style",helperInfo:{name:"if",args:[{type:"helper",value:{name:"cruxOr",args:[{type:"helper",value:{name:"ifEquals",args:["currentNoteUploadedAttachments.length",5]}},"cxPropDisableAttachmentActions"]}},"'display: none'"]}}}},{type:"attr",position:[1,5,3,1,3]},{type:"text",position:[1,5,3,1,3,1]},{type:"attr",position:[1,5,3,1,5]},{type:"if",position:[1,5,3,1,5],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,5,3,3,1,1]},{type:"if",position:[1,5,3,3,1,1],cases:{true:{dynamicNodes:[{type:"insertYield",position:[1]}]}},default:{}},{type:"attr",position:[1,5,3,3,3]},{type:"registerYield",position:[1,5,3,3,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,5,3,3,3]},{type:"attr",position:[1,5,3,3,5]},{type:"registerYield",position:[1,5,3,3,5,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,5,3,3,5]},{type:"attr",position:[1,5,5],attr:{style:{name:"style",helperInfo:{name:"if",args:["showAttachments","'display: block'","'display: none'"]}}}},{type:"attr",position:[1,5,5,1]},{type:"for",position:[1,5,5,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"text",position:[1,3,0]},{type:"text",position:[1,5,1]},{type:"attr",position:[1,7]},{type:"if",position:[1,7],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}]}},default:{}},{type:"attr",position:[1,3,11]},{type:"registerYield",position:[1,3,11,1],dynamicNodes:[{type:"text",position:[1,1]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1]},{type:"registerYield",position:[3,1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[3,1]},{type:"attr",position:[3,3]},{type:"registerYield",position:[3,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[3,3]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[1,3,11]},{type:"registerYield",position:[1,3,13,1],dynamicNodes:[{type:"attr",position:[1,5,1,1]},{type:"if",position:[1,5,1,1],cases:{true:{dynamicNodes:[{type:"text",position:[1]}]},false:{dynamicNodes:[{type:"text",position:[1]}]}},default:{}},{type:"text",position:[1,5,1,3,1]},{type:"attr",position:[1,7]},{type:"if",position:[1,7],cases:{true:{dynamicNodes:[{type:"registerYield",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,9]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,3,13]}],_observedAttributes:["cxPropModule","noteModule","cxPropEntity","allNotes","cxPropNotesOrder","contactServerUrl","currentNoteContent","currentNoteTitle","currentNoteUploadedAttachments","defaultDisplayedNotesCount","allNotesCount","businessCardFields","useAnchor","useSpan","cxPropNoteWidth","notesFilters","cxPropSelectedFilter","isClientPortalUser","showAttachments","cxPropNoteContentLimit","cxPropMaxNoteContentLength","instanceNo","notesDownloaded","cxPropNotesMetaData","cxPropNoteCountNeeded","newTextbox","cxPropQueryParam","cxPropForcedFetch","cxPropMentionQueryParam","disableShare","storageCalcType","maxStorage","userInfoRevoked","idVsVoice","cxPropNotesLoading","cxPropPrefixYield","cxPropPreventHeaderNotesHide","cxPropScrollPosition","cxPropShowNotesEdit","cxPropShowNotesDelete","cxPropShowAddNote","cxPropDisableAttachmentActions","cxPropRelatedList","cxPropEmptyNoteMessage","cxPropNoteHeaderYield","cxPropNoteHeaderTitle","cxPropFooterRightPrefixYield","cxPropNoteHeaderSuffixYield","currentSavedNote","cxPropBoundary"],data:function(){return{cxPropModule:Lyte.attr("string",{default:""}),noteModule:Lyte.attr("object",{default:"undefined"!=typeof moduleRecordMapping?moduleRecordMapping.Notes:{creatable:!0,editable:!0,deletable:!0}}),cxPropEntity:Lyte.attr("object",{default:{}}),allNotes:Lyte.attr("array",{default:[]}),cxPropNotesOrder:Lyte.attr("string",{default:_cruxUtils.getI18n.apply(void 0,["crm.note.recent.last"])}),contactServerUrl:Lyte.attr("string",{default:"undefined"!=typeof Crm?Crm.userDetails.contactServerUrl:""}),currentNoteContent:Lyte.attr("string",{default:""}),currentNoteTitle:Lyte.attr("string",{default:""}),currentNoteUploadedAttachments:Lyte.attr("array",{default:[]}),defaultDisplayedNotesCount:Lyte.attr("number",{default:3}),allNotesCount:Lyte.attr("number",{default:0}),businessCardFields:Lyte.attr("array",{default:[]}),useAnchor:Lyte.attr("boolean",{default:!1}),useSpan:Lyte.attr("boolean",{default:!1}),cxPropNoteWidth:Lyte.attr("string",{default:""}),notesFilters:Lyte.attr("array",{default:[]}),cxPropSelectedFilter:Lyte.attr("string",{default:"All"}),isClientPortalUser:Lyte.attr("boolean",{default:!("undefined"==typeof Crm||!Crm.userDetails.CLIENT_ACCOUNT)&&Crm.userDetails.CLIENT_ACCOUNT}),showAttachments:Lyte.attr("boolean",{default:!1}),cxPropNoteContentLimit:Lyte.attr("number",{default:200}),cxPropMaxNoteContentLength:Lyte.attr("number",{default:140}),instanceNo:Lyte.attr("number",{default:1}),notesDownloaded:Lyte.attr("boolean",{default:!1}),cxPropNotesMetaData:Lyte.attr("object",{default:{page:1,per_page:200,count:0}}),cxPropNoteCountNeeded:Lyte.attr("boolean",{default:!1}),newTextbox:Lyte.attr("boolean",{default:!1}),cxPropQueryParam:Lyte.attr("object",{default:{}}),cxPropForcedFetch:Lyte.attr("boolean",{default:!1}),cxPropMentionQueryParam:Lyte.attr("object",{default:{}}),disableShare:Lyte.attr("boolean",{default:!1}),storageCalcType:Lyte.attr("string",{default:"undefined"!=typeof Crm&&void 0!==Crm.userDetails.data_storage?Crm.userDetails.data_storage.calculation_type:""}),maxStorage:Lyte.attr("number",{default:0}),userInfoRevoked:Lyte.attr("boolean",{default:!1}),idVsVoice:Lyte.attr("object",{default:{}}),cxPropNotesLoading:Lyte.attr("boolean",{default:!0}),cxPropPrefixYield:Lyte.attr("boolean",{default:!1}),cxPropPreventHeaderNotesHide:Lyte.attr("boolean",{default:!1}),cxPropScrollPosition:Lyte.attr("object"),cxPropShowNotesEdit:Lyte.attr("boolean",{default:!0}),cxPropShowNotesDelete:Lyte.attr("boolean",{default:!0}),cxPropShowAddNote:Lyte.attr("boolean",{default:!0}),cxPropDisableAttachmentActions:Lyte.attr("boolean",{default:!1}),cxPropRelatedList:Lyte.attr("object"),cxPropEmptyNoteMessage:Lyte.attr("string"),cxPropNoteHeaderYield:Lyte.attr("boolean",{default:!1}),cxPropNoteHeaderTitle:Lyte.attr("string",{default:_cruxUtils.getI18n("crm.label.notes")}),cxPropFooterRightPrefixYield:Lyte.attr("boolean",{default:!1}),cxPropNoteHeaderSuffixYield:Lyte.attr("boolean",{default:!1}),currentSavedNote:Lyte.attr("string",{default:""}),cxPropBoundary:Lyte.attr("object")}},init:function(){this.$node.openNoteEditor=function(){this.component.openNotesTextareaFn()},this.$node.setNoteContent=function(e,t){var o=this.getData("instanceNo");$L("#noteTextarea"+o,this.$node).cruxMention("setMessage",{message:e,collection:t})},this.$node.getNoteContent=function(){return this.component.formattedNoteText},this.$node.setColorBox=function(){this.component.setColorBox()},this.formattedNoteText="",this.title="",this.isMentionPluginBound=!1,this.currentNoteId="",this.unModifiedNotes=[],this.isEdit=!1,this.attachmentObj=[],this.editingNoteId="",this.shareToCustomer=!1,this.pageQuery={per_page:200,page:1};var e="undefined"!=typeof moduleRecordMapping&&moduleRecordMapping[this.data.cxPropModule]?moduleRecordMapping[this.data.cxPropModule].api_name:"";if(this.moduleApi=e,this.batchNo=0,"undefined"!=typeof moduleApiMapping)for(var t in moduleApiMapping)this.apiModuleMapping[moduleApiMapping[t]]=t;var o=this.getData("cxPropEntity");if(o.$notes_view&&o.$notes_view.length>0){var a=o.$notes_view;a.splice(a.indexOf("All"),1);var i=[];a.forEach((function(e,t){i.push({api_name:e,display:moduleRecordMapping[e]?moduleRecordMapping[e].plural_label:e})})),a.unshift("All"),i.unshift({api_name:"All",display:"All"}),this.getMethods("setNotesFilter")&&(i=this.executeMethod("setNotesFilter",i)),this.setData("notesFilters",i)}if(o.id){var s=Lyte.registeredGlobalEvents.noteAddedOrDeleted,n=!1;if(s)for(var r=s.listeners?s.listeners.length:0,l=0;l<r;l++)if(s.listeners[l]){n=!0;break}if(!n||this.getData("cxPropForcedFetch"))store.findAll("note",Object.assign(this.pageQuery,this.getData("cxPropQueryParam")),!1,!0,{module:e,entityId:o.id}).then(function(t){this.pageQuery.page=this.pageQuery.page?this.pageQuery.page+1:2;var a=document.querySelectorAll(".cxNoteElem");r=a.length;var i,s,n=t.length,l=[o.id],c={},d=[],p=[],u=[],m=0;this.data.moreNotes=t.$&&t.$.meta.more_records,d.push(this.getNoteCount(this.data.moreNotes,t)),"undefined"!=typeof Crm&&(c.user=[Crm.userDetails.USER_ID]);for(var h=0;h<n;h++)e=t[h].$se_module,t[h].Parent_Id?"undefined"!=typeof moduleRecordMapping&&-1===l.indexOf(t[h].Parent_Id.id)?(l.push(t[h].Parent_Id.id),s=moduleRecordMapping[this.apiModuleMapping[e]].id,store.modelFor(s)?(t[h].entity=store.peekRecord(s,t[h].Parent_Id.id),t[h].entity||(c[s]||(c[s]=[]),c[s].push(t[h].Parent_Id.id))):-1===p.indexOf(s)&&(p.push(s),c[s]||(c[s]=[]),c[s].push(t[h].Parent_Id.id))):t[h].Parent_Id.id===o.id&&(t[h].entity=o):m++;function x(o){Lyte.resolvePromises(o).then(function(o){for(var s=0;s<n;s++)e=t[s].$se_module,t[s].Parent_Id&&"undefined"!=typeof moduleRecordMapping&&!t[s].entity&&(t[s].entity=store.peekRecord(moduleRecordMapping[this.apiModuleMapping[e]].id,t[s].Parent_Id.id));for(s=0;s<r;s++)if(i=a[s].component){if(o[1]&&o[1].length){var l=o[1][0].customize_info;i.setData("cxPropNotesOrder",l&&!1===l.notes_desc?_cruxUtils.getI18n.apply(void 0,["crm.note.recent.first"]):_cruxUtils.getI18n.apply(void 0,["crm.note.recent.last"]))}i.createExtensionMap(),t&&!i.getData("notesDownloaded")&&(i.processNotes(t),i.unModifiedNotes=t,i.setData("notesDownloaded",!0))}}.bind(this))}this.setData("hiddenNotesCount",m);var y=Object.keys(c).length;if(y>0){var f=p.length;if(f>0){for(h=0;h<f;h++)u.push(store.findRecord("module",p[h],{},!1,!0,{allowMultiple:!0}));Lyte.resolvePromises(u).then(function(){for(var e in c)d.push(store.findAll(e,{ids:c[e].join(",")}));x.call(this,d)}.bind(this))}else{for(var N in c)d.push(store.findAll(N,{ids:c[N].join(",")}));x.call(this,d)}}if(0===y)for(h=0;h<r;h++)(i=a[h].component)&&(i.createExtensionMap(),t&&!i.getData("notesDownloaded")&&(i.processNotes(t),i.unModifiedNotes=t,i.setData("notesDownloaded",!0)))}.bind(this),function(e){this.getMethods("onNotesRequestError")&&this.executeMethod("onNotesRequestError",e)}.bind(this));else{var c=store.peekAll("note");c.length>0&&!this.getData("notesDownloaded")&&(this.createExtensionMap(),this.processNotes(c),this.unModifiedNotes=c,this.setData("notesDownloaded",!0))}}Lyte.registeredCustomComponent["crux-note-loading"]||Lyte.createCustomElement("crux-note-loading",{static:{observedAttributes:{get:function(){return[]}}},connectedCallback:function(){this.innerHTML='<div class="cxNotesAddedNotesLoader">\n\t\t\t\t\t\t<div class="cxNotesLoaderCircle">\n\t\t\t\t\t\t\t<div class="cxNotesCircleLoaderRunner"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="cxNotesLoaderRightSection">\n\t\t\t\t\t\t\t<div class="cxNotesLoaderLine cxNotesLoaderLine1">\n\t\t\t\t\t\t\t\t<div class="cxNotesLoaderRunner"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="cxNotesLoaderLine cxNotesLoaderLine2">\n\t\t\t\t\t\t\t\t<div class="cxNotesLoaderRunner"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>'}}),this.noteLoadingElement=document.createElement("crux-note-loading")},didConnect:function(){this.$node.classList.add("cxNoteElem"),this.setData("instanceNo",document.querySelectorAll(".cruxNotes").length),this.listenerId=Lyte.addEventListener("noteAddedOrDeleted",this.refreshNotes.bind(this))},getNoteCount:function(e,t){if(e&&"undefined"!=typeof Crm&&Crm.userDetails.isRLCountQuerySupported)try{return this.data.cxPropEntity.$.triggerAction("get_related_records_count",{type:"POST",version:4},"","",{get_related_records_count:[{related_list:{id:this.data.cxPropRelatedList.id}}]}).then(function(e){this.setData("allNotesCount",e.get_related_records_count[0].count)}.bind(this))}catch(e){this.setData("allNotesCount",t.length)}else this.setData("allNotesCount",t.length)},refreshNotes:function(e){if(this.data)if((0!=Object.keys(this.data.cxPropQueryParam).length&&this.data.cxPropQueryParam.filters||e&&e.queryParam&&e.queryParam.filters)&&(!e||!e.queryParam||this.data.cxPropQueryParam!=e.queryParam))this.processNotes(this.unModifiedNotes,void 0,!0);else{this.setData("defaultDisplayedNotesCount",e.defaultDisplayedNotesCount);var t=this.getNoteCount(e.allNotes.length>=200,e.allNotes);t instanceof Promise?t.then(function(){this.processNotes(e.allNotes,void 0,!0)}.bind(this)):this.processNotes(e.allNotes,void 0,!0)}},didDestroy:function(){this.data.cxPropShowAddNote&&$L(this.$node.querySelector("#noteTextarea"+this.getData("instanceNo"))).cruxMention({destroy:!0}),store.unloadAll("note"),Lyte.removeEventListener(this.listenerId)},createExtensionMap:function(){this.extensionMap={png:["jpeg","jpg","gif","png","webp","bmp","svg"],word:["doc","docx","odt","rtf"],excel:["csv","xls","xlsx","ods","xlsm","sxc","tsv"],ppt:["odp","pps","pot","pptx","ppt"],movie:["avi","wmv","mp4","mpeg","mpg","mov","flv","mkv","webm"],mp3:["mp3","ogg","oga","wma","m4p","m4a","au","3gp"],zip:["zip","zipx","tar","gz","z","cab","rar","bz2","lzh","7z","img","iso"],pdf:["pdf"],txt:["txt"],htm:["htm"],html:["html"],sxw:["sxw"]}},apiModuleMapping:{},notesBatchCount:10,processNotes:function(e,t,o){e.$?this.setData("cxPropNotesMetaData",e.$.meta):Lyte.Component.set(this.getData("cxPropNotesMetaData"),"count",e.length);var a=this.getData("cxPropNotesOrder"),i=this.getData("cxPropSelectedFilter"),s=this.moduleApi,n=e.length;function r(e){var t=e.File_Name.substr(e.File_Name.lastIndexOf(".")+1).toLowerCase(),o=!1,a=e.Size;for(var i in a>1e3?(a/=1e3)>1e3?(a/=1e3,a=parseFloat(a).toFixed(1)+" "+I18n.getMsg("MB")):0!=a&&(a=parseFloat(a).toFixed(2)+" "+I18n.getMsg("KB")):a=parseFloat(a).toFixed(1)+" "+I18n.getMsg("B"),e.formattedSize=a,this.extensionMap)if(-1!==this.extensionMap[i].indexOf(t)){if(o=!0,e.mappedFileExtn=i,e.isImage=!1,"png"===i){"svg"!==t&&(e.isImage=!0),e.downLoadMode="";break}if("excel"===i){e.downLoadMode="sheet";break}if("ppt"===i){e.downLoadMode="show";break}if("word"===i||"txt"===i||"htm"===i||"html"===i||"sxw"===i){e.downLoadMode="writer";break}if("pdf"===i){e.downLoadMode="pdfViewPlugin";break}}o||(e.mappedFileExtn="file")}n="All"===i?n-this.data.hiddenNotesCount:n;for(var l=0;l<n;l++)if(s=e[l].$se_module?e[l].$se_module:e[l].Parent_Id.module.api_name,e[l].module=this.apiModuleMapping[s],e[l].Parent_Id&&"undefined"!=typeof moduleRecordMapping&&(e[l].entity=e[l].entity?e[l].entity:store.peekRecord(moduleRecordMapping[this.apiModuleMapping[s]].id,e[l].Parent_Id.id),e[l].moduleSingularLabel=e[l].moduleSingularLabel?e[l].moduleSingularLabel:moduleRecordMapping[this.apiModuleMapping[s]].singular_label),e[l].$attachments&&e[l].$attachments.forEach(r.bind(this)),e[l].$voice_note){var c=e[l].$voice_note,d=Crm.getCrmBasePath()+"/specific/ViewAttachment?fileId="+$ESAPI.encoder().encodeForURL(c.file_id)+"&module="+$ESAPI.encoder().encodeForURL(this.data.cxPropModule)+"&parentId="+$ESAPI.encoder().encodeForURL(this.getData("cxPropEntity").id)+"&id="+$ESAPI.encoder().encodeForURL(e[l].id)+"&name="+$ESAPI.encoder().encodeForURL(c.file_name);Lyte.Component.set(this.data.idVsVoice,e[l].id,d)}var p=this.getData("defaultDisplayedNotesCount");(p>n||p<3&&n<=3)&&(p=n,this.setData("defaultDisplayedNotesCount",n));var u=1===this.batchNo?2*this.notesBatchCount:this.batchNo*this.notesBatchCount+this.notesBatchCount;if(a===_cruxUtils.getI18n.apply(void 0,["crm.note.recent.first"]))e.sort((function(e,t){return new Date(t.Created_Time)-new Date(e.Created_Time)})),e=t?e.slice(0,n>=u?u:n):e.slice(0,p);else if(a===_cruxUtils.getI18n.apply(void 0,["crm.note.recent.last"])){e.reverse(),e.sort((function(e,t){return new Date(e.Created_Time)-new Date(t.Created_Time)}));var m=t?n-u:n-p;m=m<0?0:m,e=e.slice(m,n)}n=(e=e.slice(0)).length,this.setData("defaultDisplayedNotesCount",n),this.setData("cxPropNotesLoading",!1),this.setData("allNotes",e);for(var h,x,y=store.peekAll("user"),f=(y=y||[]).map((function(e){return e.id})),N=!0,g=[],v=(l=0,0);l<n;l++)h=e[l].Owner.id,x=e[l].Modified_By.id,-1===g.indexOf(h)&&-1===f.indexOf(h)?(g[v++]=h,N=!1):-1===g.indexOf(x)&&-1===f.indexOf(x)&&(g[v++]=x,N=!1);if(N)this.setAllNotes(e,o);else{var C=[];if(g.length>100)for(var P=0;P<userIds.length;P+=100)C.push(store.findAll("user",{type__s:"Regular User,Client Portal User,Lite User",type:"ActiveConfirmedUsers",ids:g.slice(P,P+100).join()}));else C.push(store.findAll("user",{type__s:"Regular User,Client Portal User,Lite User",type:"ActiveConfirmedUsers",ids:g.join()}));Lyte.resolvePromises(C).then(function(t){this.setAllNotes(e,o)}.bind(this))}this.setColorBox()},setColorBox:function(){$.colorbox&&$(".cxNotesAttachImage").colorbox({photo:!0,rel:"photonavigation"})},convertTextUrlToLink:function(e){for(var t,o,a,i,s,n,r,l,c,d,p=new RegExp(/((https?|ftps?|mailto)(:|&#x3a;)(\/\/|&#x2f;&#x2f;))((www\.){0,1}[a-zA-Z0-9-_]+(\.[a-z0-9]+)+)((:|&#x3a;)[0-9]*(\.[a-z0-9]+)*)*(((\/|&#x2f;)[^\s]*)*)|www\.([a-zA-Z0-9-_]+(\.[a-z0-9]+)+)((:|&#x3a;)[0-9]*(\.[a-z0-9]+)*)*(((\/|&#x2f;)[^\s]*)*)/),u=new RegExp("(https?|ftps?|mailto)://"),m="",h=e.split(" "),x=h.length,y=0;y<x;y++){d=(c=h[y].split("\n")).length,[];for(var f=0;f<d;f++){if(s="","",r=(a=p.exec(c[f]))?a.index:-1,l=a?a[0].length+a.index:0,n=c[f].substring(l>0?l:c[f].length),c[f]=c[f].substring(0,l>0?l:c[f].length),p.test(c[f])&&c[f].indexOf("mailto://")>-1)s=c[f].substring(0,r),i=(i=c[f].substring(r,l>0?l:c[f].length)).replace("mailto://","mailto:"),t=s+c[f].replace(c[f],'mailto://<a href="'+i+'" target="_blank">'+i.replace("mailto:","")+"</a>")+(n||"");else if(p.test(c[f])){s=c[f].substring(0,r),i=c[f].substring(r,l>0?l:c[f].length);var N=u.exec(c[f]);N=(N?"":"//")+i;var g=document.createElement("a");g.setAttribute("href",N),g.setAttribute("rel","noreferrer noopener"),g.setAttribute("target","_blank"),g.innerText=i,t=s+c[f].replace(c[f],g.outerHTML)+(n||"")}else t=c[f]+(n||"");c[f]=t}o=c.join("\n"),m+=o=0===y?o:" "+o}return m},uniqueReplText1:" cruxNoteAnchorOpen",uniqueReplText2:" cruxNoteAnchorClose",findOccurrencesOfLinks:function(e){for(var t,o,a=new RegExp("<a href=","g"),i=[],s=[],n=0,r=0;(t=a.exec(e))&&(o=t.index,-1===i.indexOf(o));)e.substring(r,o).indexOf(this.uniqueReplText1)>-1&&(o=o-(n+1)*(this.uniqueReplText1.length-"<a ".length)-n*(this.uniqueReplText2.length-"</a>".length)),r=o,i.push(o),n++;for(a=new RegExp("</a>","g"),n=0,r=0;(t=a.exec(e))&&(o=t.index+4,-1===s.indexOf(o));)e.substring(r,o).indexOf(this.uniqueReplText1)>-1&&(o=o-(n+1)*(this.uniqueReplText1.length-"<a ".length)-n*(this.uniqueReplText2.length-"</a>".length)),r=o,s.push(o),n++;return{startPos:i,endPos:s}},setAllNotes:function(e,t){for(var o,a,i,s,n,r,l,c=this.getData("isClientPortalUser"),d=this.getData("cxPropMaxNoteContentLength"),p=this.getData("noteModule"),u=e.length,m=("undefined"!=typeof Crm&&Crm.userDetails.TIME_FORMAT.toLowerCase(),!0),h=!0,x=0;x<u;x++){i=e[x].Modified_Time,o=new Date(i);var y=new Date,f="",N=Math.floor((y.getTime()-o.getTime())/1e3),g=Math.floor(N/60),v=Math.floor(g/60),C=!0;if(N<60)f=_cruxUtils.getI18n("crm.lower.now");else if(g<60)f=1===g?_cruxUtils.getI18n("crm.time.min.ago",g):_cruxUtils.getI18n("crm.time.mins.ago",g);else if(v<24)f=1===v?_cruxUtils.getI18n("crm.time.hr.ago",v):_cruxUtils.getI18n("crm.time.hrs.ago",v);else{var P=o.getFullYear(),b=y.getFullYear()-P,_=o.getMonth(),I=o.getDate(),A=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];f=0===b?_cruxUtils.getI18n(A[_])+" "+I:_cruxUtils.getI18n(A[_])+" "+I+" "+P,C=!1}if(Lyte.Component.set(e[x],"modified_time",e[x].Created_Time===e[x].Modified_Time?f:_cruxUtils.getI18n.apply(void 0,[C?"crm.label.edited":"crm.label.edited.on"])+" "+f),"undefined"!=typeof CrmDate){s="undefined"!=typeof Crm&&Crm.userDetails.COUNTRY_LOCALE.indexOf("GB")>-1?"dd MMM":"MMM dd";var L=new CrmDate(i);a=L.getDateInPattern(s)+" "+L.getTimeInUserPattern(!1);var S="MMM dd"==s?a.slice(0,3):a.slice(3,6);a=a.replace(S,I18n.getMsg(S))}Lyte.Component.set(e[x],"modified_time_full",e[x].Created_Time===e[x].Modified_Time?a:_cruxUtils.getI18n.apply(void 0,["crm.label.edited.on"])+" "+a)}var D=e.map((function(e){return e.Note_Content})),M=D.length,q=this.unformatNoteContents(D);function T(e,t,o,a,i){for(var s=d,n=o.length,r=0;r<n&&o[r]<d;r++)s=a[r];return!s&&e.length<d&&(s=e[x].length),s}if(q.constructor===Promise)q.then(function(){this.getData("maxNoteContentLength");for(var t=new RegExp("crm[[aA-zZ]*#[0-9]*#[0-9]*]crm","gi"),o=0;o<M;o++){var a="",i="";if(D[o]){D[o]=D[o].replaceAll("<a ",this.uniqueReplText1),D[o]=D[o].replaceAll("</a>",this.uniqueReplText2),D[o]=D[o].replace("&#x5b;","["),D[o]=D[o].replace("&#x23;","#"),D[o]=D[o].replace("&#x5d;","]"),a=D[o].slice(),D[o]=this.convertTextUrlToLink(D[o]);for(var s=D[o].match(t),u=s?s.length:0,x=0;x<u;x++){var y,f=s[x].indexOf("#"),N=s[x].lastIndexOf("#"),g=s[x].slice(f+1,N);-1!==s[x].indexOf("user")?(i=(y=store.peekRecord("user",g))?y.full_name:"",D[o]=D[o].replace(s[x],i?"<a href='javascript:;' class='cxLink'>"+$ESAPI.encoder().encodeForHTML(i)+",</a>":""),a=a.replace(s[x],i?i+",":"")):-1!==s[x].indexOf("role")?(i=(y=store.peekRecord("role",g))?y.name:"",D[o]=D[o].replace(s[x],i?"<a href='javascript:;' class='cxLink'>"+i+",</a>":""),a=a.replace(s[x],i?i+",":"")):-1!==s[x].indexOf("group")&&(i=(y=store.peekRecord("user_group",g))?y.name:"",D[o]=D[o].replace(s[x],i?"<a href='javascript:;' class='cxLink'>"+i+",</a>":""),a=a.replace(s[x],i?i+",":""))}}var v=store.peekRecord("user",e[o].Owner.id),C=store.peekRecord("user",e[o].Modified_By.id);e[o].disableShare=!c&&!v,Lyte.Component.set(e[o],"imageLink",C&&C.image_link?C.image_link:"noPhoto"),Lyte.Component.set(e[o],"isPortalUser",C&&"Client Portal User"==C.type__s),r=!1!==p.editable&&!(c&&(!C||C.id!=Crm.userDetails.USER_ID)),l=!1!==p.deletable&&!(c&&(!C||C.id!=Crm.userDetails.USER_ID)),void 0!==typeof moduleRecordMapping&&moduleRecordMapping[this.data.cxPropModule]&&"team_based"===moduleRecordMapping[this.data.cxPropModule].access_type&&(r=!!Crm.userDetails.permissions["Crm_Implied_Edit_Notes_"+this.data.cxPropModule]),void 0!==typeof moduleRecordMapping&&moduleRecordMapping[this.data.cxPropModule]&&"team_based"===moduleRecordMapping[this.data.cxPropModule].access_type&&(l=!!Crm.userDetails.permissions["Crm_Implied_Delete_Notes_"+this.data.cxPropModule]),Crm.userDetails.permissions.Crm_Implied_Edit_By_Owner_Notes&&(m=Crm.userDetails.USER_ID==e[o].Owner.id),Crm.userDetails.permissions.Crm_Implied_Delete_By_Owner_Notes&&(h=Crm.userDetails.USER_ID==e[o].Owner.id);var P,b=[],_=[],I=0;D[o]&&(b=(P=this.findOccurrencesOfLinks(D[o])).startPos,_=P.endPos,I=T(D[o],0,b,_),D[o]=D[o].replaceAll(this.uniqueReplText1,"<a "),D[o]=D[o].replaceAll(this.uniqueReplText2,"</a>")),Lyte.Component.set(e[o],{unformattedNoteContent:D[o],actualContent:a,lastIndex:_.length>0?_[_.length-1]:0,endPosIdx:I,startPos:b,endPos:_,seeMoreLastIdx:a.length<d?a:d,hasLinks:b.length>0?"true":"false",_creatable:n,_editable:r,_deletable:l,_showEditable:m,_showDeletable:h})}this.setData("allNotes",e),this.getMethods("onAfterRender")&&this.executeMethod("onAfterRender",this,e)}.bind(this));else if("hasNoMention"===q){for(x=0;x<u;x++){var E=store.peekRecord("user",e[x].Owner.id),w=store.peekRecord("user",e[x].Modified_By.id);e[x].disableShare=!c&&!E,Lyte.Component.set(e[x],"imageLink",w&&w.image_link?w.image_link:"noPhoto"),Lyte.Component.set(e[x],"isPortalUser",w&&"Client Portal User"==w.type__s),r=!1!==p.editable&&!(c&&(!w||w.id!=Crm.userDetails.USER_ID)),l=!1!==p.deletable&&!(c&&(!w||w.id!=Crm.userDetails.USER_ID)),void 0!==typeof moduleRecordMapping&&moduleRecordMapping[this.data.cxPropModule]&&"team_based"===moduleRecordMapping[this.data.cxPropModule].access_type&&(r=!!Crm.userDetails.permissions["Crm_Implied_Edit_Notes_"+this.data.cxPropModule]),void 0!==typeof moduleRecordMapping&&moduleRecordMapping[this.data.cxPropModule]&&"team_based"===moduleRecordMapping[this.data.cxPropModule].access_type&&(l=!!Crm.userDetails.permissions["Crm_Implied_Delete_Notes_"+this.data.cxPropModule]),Crm.userDetails.permissions.Crm_Implied_Edit_By_Owner_Notes&&(m=Crm.userDetails.USER_ID==e[x].Owner.id),Crm.userDetails.permissions.Crm_Implied_Delete_By_Owner_Notes&&(h=Crm.userDetails.USER_ID==e[x].Owner.id);var R,F=[],B=[],k=0,U="";D[x]&&(D[x]=D[x].replaceAll("<a ",this.uniqueReplText1),D[x]=D[x].replaceAll("</a>",this.uniqueReplText2),U=D[x],D[x]=this.convertTextUrlToLink(D[x]),F=(R=this.findOccurrencesOfLinks(D[x])).startPos,B=R.endPos,k=T(D[x],0,F,B),D[x]=D[x].replaceAll(this.uniqueReplText1,"<a "),D[x]=D[x].replaceAll(this.uniqueReplText2,"</a>")),Lyte.Component.set(e[x],{unformattedNoteContent:D[x],actualContent:U,lastIndex:B.length>0?B[B.length-1]:0,endPosIdx:k,startPos:F,endPos:B,hasLinks:R&&R.startPos.length>0?"true":"false",_creatable:n,_editable:r,_deletable:l,_showEditable:m,_showDeletable:h})}this.setData("allNotes",e),this.getMethods("onAfterRender")&&this.executeMethod("onAfterRender",this,e)}},unformatNoteContents:function(e){for(var t=[],o=[],a=[],i=e.length,s=new RegExp("crm[[aA-zZ]*#[0-9]*#[0-9]*]crm","gi"),n=0;n<i;n++)if(e[n]){e[n]=e[n].replace("&#x5b;","["),e[n]=e[n].replace("&#x23;","#"),e[n]=e[n].replace("&#x5d;","]");for(var r=e[n].match(s),l=r?r.length:0,c=0;c<l;c++){var d=r[c].indexOf("#"),p=r[c].lastIndexOf("#"),u=r[c].slice(d+1,p);-1!==r[c].indexOf("user")?t.push(u):-1!==r[c].indexOf("role")?o.push(u):-1!==r[c].indexOf("group")&&a.push(u)}}return this.makeBatchRequest(t,o,a)},makeBatchRequest:function(e,t,o){var a=e.length>0,i=t.length>0,s=o.length>0,n=[];if(a)if(e.length>100)for(var r=0;r<e.length;r+=100)n.push(store.findAll("user",{type__s:"Regular User,Client Portal User,Lite User",type:"ActiveConfirmedUsers",ids:e.slice(r,r+100).join()}));else n.push(store.findAll("user",{type__s:"Regular User,Client Portal User,Lite User",type:"ActiveConfirmedUsers",ids:e.join()}));return i&&n.push(store.findAll("role",{ids:t.join()})),s&&n.push(store.findAll("user_group",{ids:o.join()})),a||i||s?Lyte.resolvePromises(n):"hasNoMention"},hideNoteTitle:function(){var e=this.$node.querySelector(".titleInputSection"),t=this.$node.querySelector(".notesTextInputBoxWrap .notesTextArea .notesTextAreaWrap .cxNotesAddTitle");e&&(e.querySelector("lyte-input input").value="",e.style.display="none"),t&&(t.style.display="",t.previousElementSibling.classList.remove("cxAttachFilesWithoutBorder"))},closeNotesTextbox:function(){var e=this.$node,t=$L(e),o=this.currentNoteId;o&&(e.querySelector(".cruxNotesList .cx_"+o).querySelector("#noteMainDiv").style.display=""),this.hideNoteTitle();var a=t.find(".notesTextInputBoxWrap"),i=e.querySelector(".notesTextInputBoxWrap .notesTextArea"),s=i.querySelector("lyte-input textarea");s.value="",s.style.height="",i.style.display="none",this.title="",e.querySelector(".notesTextInputBoxWrap .inputBeforeNote").style.display="",a.removeClass("cxNoteTextareaOpen"),this.getMethods("onNotesEditorClose")&&this.executeMethod("onNotesEditorClose"),this.currentNoteId="",this.formattedNoteText="",this.setData("currentNoteUploadedAttachments",[])},bindMentionPlugin:function(e,t){var o=this;if(!0===t)$L("#noteTextarea"+this.getData("instanceNo")).cruxMention({destroy:!0});else{var a=this.getData("cxPropMentionQueryParam"),i=this.getData("instanceNo");$L("#noteTextarea"+i).cruxMention({textboxSelector:"#noteTextarea"+i,cxPropContent:function(e){o.formattedNoteText=e,o.checkSaveButtonStatus()},existingMentions:e||[],queryParam:a})}},alreadyAttachedFilesCount:0,uploadFile:function(e){var t=this,o=this.getData("cxPropEntity").id,a=this.moduleApi,i=this.currentNoteId,s=this.isEdit;if(i){var n=store.peekRecord("note",i).$attachments;t.alreadyAttachedFilesCount=n?n.length:0,e&&(t.alreadyAttachedFilesCount-=1)}else t.alreadyAttachedFilesCount=0;if(!this.isFileUploadPluginBound){this.isFileUploadPluginBound=!0,this.uploaderObj={previewsContainer:".cruxNoteFiles"+t.getData("instanceNo"),createImageThumbnails:!0,needWMSFallback:!0,needVirusFilter:!0,virusFilter:{okMessage:function(){var e=this.getFilesWithMaliciousContents();return this.files.length===e.length?_cruxUtils.getI18n("crm.fileuploader.message.savenoteswithoutattachments"):this.files.length-e.length<2?_cruxUtils.getI18n("crm.fileuploader.message.noteattachremainingfile"):_cruxUtils.getI18n("crm.fileuploader.message.noteattachremainingfiles")}},clickable:".attachementActionArea"+t.getData("instanceNo"),previewTemplate:'<div class="dz-preview dz-file-preview cB"><div class="dz-details"><div class="dz-filename"><span data-dz-name></span></div><div class="dz-size"><span data-dz-size></span></div></div><div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div><div class="dz-error-message"><span class="virusAlert"></span>&nbsp;<span data-dz-errormessage></span></div><div class="dz-remove cxNotesAttachmentRemoveIcon cxVam" data-dz-remove></div>',uploadMethod:"normal",autoProcessQueue:!s,url:s?"/crm/v2/Notes/"+i+"/Attachments":"/crm/v2/files",needFolderUpload:!1,maxFiles:5-t.alreadyAttachedFilesCount,totalFilesize:(2e7-Notes.alreadyAttachSize)/1e6,maxAllowedFiles:5,parallelUploads:1,progressRatio:s?1:.9,save:".cruxNoteSaveBtn"+t.getData("instanceNo"),cancel:".cruxNoteCancelBtn"+t.getData("instanceNo"),init:function(){var e,o=this;t.uploaderIns=this,o.on("proceed",(function(e){e.preventDefault(),e.stopPropagation();var o=t.$node.querySelector(".titleInputSection .noteTitle input"),a=t.$node.querySelector(".notesTextInputBoxWrap .notesTextInputBox textarea");if(a&&o){var i=a.value.trim(),s=o.value.trim();if(""==i&&""==s)return a.focus(),!1}})),$("#alreadyAttached").click((e=o,function(o){o.preventDefault(),o.stopPropagation(),e.maxFiles=5-t.alreadyAttachedFilesCount,e.totalFilesize=(2e7-Notes.alreadyAttachSize)/1e6})),o.on("error",(function(e){if(e.previewElement){e.virus&&$(e.previewElement).find(".virusAlert").css("display","inline-block");var t=e.previewElement.querySelector("[data-dz-errormessage]");t&&t.innerHTML.length>20&&$(t).attr("title",t.innerHTML)}})),o.on("success",(function(e,o){t.isEdit;try{t.uploaderObj.cancelledFiles-=1;o=JSON.parse(o);e.attachmentId=o.data[0].details.id}catch(o){var a=e.previewElement.querySelector(".dz-error-message");a&&a.innerHTML.length>20&&$(a).attr("title",a.innerHTML),e.previewElement.classList.add("dz-error"),a&&a.children[1]&&(a.children[1].innerHTML=_cruxUtils.getI18n.apply(void 0,["crm.fileuploader.message.responseerror"])),t.checkSaveButtonStatus()}})),o.on("canceled",(function(){t.uploaderObj.cancelledFiles>0&&(t.uploaderObj.cancelledFiles-=1),t.uploaderObj.cancelledFiles<1&&(t.requestResolved=!0,t.checkSaveButtonStatus())})),o.on("batchclientcomplete",(function(e){t.uploaderObj.cancelledFiles=0,t.uploaderObj.newUploadCount=0;for(var o,a=e.length,i=!0,s=[],n=0,r=0;n<a;n++){if("error"===(o=e[n]).status){i=!1;break}s[r++]={id:o.attachmentId}}if(t.requestResolved=!0,i&&t.isEdit){var l=t.currentNoteId;store.peekRecord("note",l).$.isModified?t.updateNote(l):t.updateCurrentNote(l)}else t.attachmentObj=s,t.checkSaveButtonStatus()})),o.on("removedfile",(function(e){var o=t.isEdit;if(o&&t.uploaderObj.newUploadCount>0&&(t.uploaderObj.newUploadCount-=1),"error"!==e.status&&!o){var a=t.attachmentObj;a=a.filter((function(t){return t.id!==e.attachmentId})),t.attachmentObj=a,t.checkSaveButtonStatus()}})),o.on("clean",(function(){t.isFileUploadPluginBound=!1,t.uploaderObj.newUploadCount=0,t.uploaderObj.cancelledFiles=0,t.requestResolved=!0})),o.on("customizepreviewtemplate",(function(e){var t=e.previewElement.querySelector("[data-dz-name]"),o=$(t),a=e.name;a&&a.length>20&&o.attr("title",a);var i="";a&&""!==a&&-1!==a.lastIndexOf(".")&&(i=a.slice(a.lastIndexOf(".")+1)),(t=e.previewElement.querySelector(".dz-filename"))&&o.prepend(FileUploader.createElement('<span class="mR5 cxVam dIB cxNotesAttachmentIcons cx-'+Notes.getExtensionGroup(i)+'-icon"></span>')),(t=e.previewElement.querySelector("[data-dz-size]"))&&(t.innerHTML="("+this.options.getFileSize(e.size)+")")})),o.on("addedfile",(function(e){if(t.uploaderObj.newUploadCount?t.uploaderObj.newUploadCount+=1:t.uploaderObj.newUploadCount=1,t.uploaderObj.cancelledFiles?t.uploaderObj.cancelledFiles+=1:t.uploaderObj.cancelledFiles=1,t.isEdit){this.options.autoProcessQueue=!1;var o=e.previewElement;o.classList.add("dz-callbackcomplete","dz-complete","dz-success"),o.querySelector(".dz-progress .dz-upload").style.width="100%"}setTimeout((()=>{t.checkSaveButtonStatus()}),10),t.$node.querySelector(".noteMoreFiles").style.display="block"}))},uploadBean:{crmHandback:{entityId:o,module:a,action:"notes"},user:{zgid:"undefined"!=typeof Crm?Crm.userDetails.ZGID:""},uploadTo:"EntityAttachments",folderId:"WS_ATTACHMENT_LIBRARY"}};for(var r,l=$(".cruxNotes"),c=l.length,d=0;d<c;d++)if(l[d].parentElement.parentElement.component===this){r=l[d];break}r&&$(r).FileUploader(this.uploaderObj);var p,u=FileUploader.instances,m=u.length;for(d=0;d<m;d++)(p=u[d]?u[d].element:void 0)&&p.classList.contains("cruxNotes")&&p!==r&&p.querySelector(".cxCancelbtn").click()}},methods:{noteFilterShow:function(e,t){t.childComp.querySelector(".lyteDropdownSelection").classList.remove("lyteDropdownSelection"),t.childComp.querySelector(".cruxNoteSelectedToggle").classList.add("lyteDropdownSelection")},updateNoteListCall:function(e,t){this.updateCurrentNote(e,t)},setSelectionClass:function(e,t,o,a,i){if(this.getMethods("onNotesOrderToggle")&&this.executeMethod("onNotesOrderToggle",e,t),!i.classList.contains("cruxNoteSelectedToggle"))for(var s,n=document.querySelectorAll(".cxNoteElem"),r=n.length,l=0;l<r;l++)(s=n[l].component)&&s.toggleCruxNote(t);return a.$node.close(),!1},setPopoverPosition:function(e){var t=e.childComp.querySelector(".cruxBCContent .lytePopover"),o=t.getBoundingClientRect(),a=t.querySelector(".lytePopoverArrowIcon"),i=a.getBoundingClientRect(),s=o.width+o.left+13>window.innerWidth;t.style.display="none",t.style.left=s?o.left-13+"px":o.left+13+"px",i.top+o.height-39<=window.innerHeight?(t.style.top=i.top-39+"px",a.style.top="39px"):(t.style.top=i.top+i.height/2+39-o.height+"px",a.style.top=o.height-(39+i.height/2)+"px"),t.style.display="block"},updateShareToCustomer:function(e,t,o){this.shareToCustomer=t.data.ltPropChecked,this.checkSaveButtonStatus()},deleteConfirmationModalClosed:function(){this.currentNoteId="",this.setData("currentNoteContent",""),this.setData("currentNoteTitle","")}},toggleCruxNote:function(e){this.unModifiedNotes;var t=!1,o=e===_cruxUtils.getI18n.apply(void 0,["crm.note.recent.first"])||e===_cruxUtils.getI18n.apply(void 0,["crm.note.recent.last"]);function a(){this.batchNo=0,this.setData("defaultDisplayedNotesCount",3),this.setData("currentNoteUploadedAttachments",[]),o?this.setData("cxPropNotesOrder",e):this.setData("cxPropSelectedFilter",e),store.unloadAll("note"),this.pageQuery={per_page:200,page:1},this.setData("cxPropNotesLoading",!0);var t={},a={module:this.moduleApi,entityId:this.getData("cxPropEntity").id};"All"!==this.data.cxPropSelectedFilter&&(t={filters:{comparator:"not_equal",field:{api_name:"Parent_Id->"+this.data.cxPropSelectedFilter+".id"},value:"${EMPTY}"}},a.apiVersion="v6"),store.findAll("note",Object.assign(this.pageQuery,Object.assign(t,this.getData("cxPropQueryParam"))),!1,!0,a).then(function(e){this.setData("cxPropNotesLoading",!1),this.unModifiedNotes=e,this.getNotesCount(e),this.data.moreNotes=e.$&&e.$.meta.more_records,Lyte.triggerEvent("noteAddedOrDeleted",{allNotes:e,defaultDisplayedNotesCount:this.getData("defaultDisplayedNotesCount"),queryParam:this.data.cxPropQueryParam})}.bind(this),function(e){this.getMethods("onNotesRequestError")&&this.executeMethod("onNotesRequestError",e)}.bind(this))}if(o){if("undefined"!=typeof Crm){var i=store.peekRecord("user",Crm.userDetails.USER_ID);i&&(this.setData("cxPropNotesLoading",!0),i.$.set("customize_info",{notes_desc:e===_cruxUtils.getI18n.apply(void 0,["crm.note.recent.last"])}),t=!0,i.$.save().then(function(e){a.call(this)}.bind(this)))}this.isMentionPluginBound=!1}!1===t&&a.call(this)},currentNoteEntityId:"",currentNoteModuleApi:"",closeNewTextbox:function(e){var t=this.$node,o=this.isEdit?this.editingNoteId:this.currentNoteId;o&&(this.bindMentionPlugin([],!0),t.querySelector(".notesTextInputBoxWrap").remove(),e||(t.querySelector(".cruxNotesList .cx_"+o).querySelector("#noteMainDiv").style.display="")),e||(this.currentNoteId="",this.formattedNoteText="",this.setData("currentNoteUploadedAttachments",[])),this.setData("newTextbox",!1)},clearRemovedFilesFromNote:function(e){var t=store.createRecord("dummy",{});url="crm/v2/Notes/"+e+"/Attachments?ids="+this.removedAttachments.join(","),this.requestResolved=!1;var o=this.$node.querySelector(".cruxNoteSaveBtn"+this.getData("instanceNo"));this.uploaderObj&&this.uploaderObj.newUploadCount>0&&o.ltProp("disabled",!0),t.$.save({url:url,method:"DELETE"}).then(function(){this.removedAttachments=[],this.requestResolved=!0;var t=store.peekRecord("note",e);this.uploaderObj&&this.uploaderObj.newUploadCount>0?this.uploadNewFiles(e):t.$.isModified?this.updateNote(e):this.updateCurrentNote(e)}.bind(this)).catch(function(e){if(this.uploaderObj&&this.uploaderObj.newUploadCount>0&&o.ltProp("disabled",!0),this.requestResolved=!0,e&&403===e.status){var t=JSON.parse(e.response);"NO_PERMISSION"!==(t=t.data?t.data[0]:t).code&&"CANNOT_PERFORM_ACTION"!=t.code||_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}})}}.bind(this))},uploadNewFiles:function(e){this.requestResolved=!1,this.$node.querySelector(".cruxNoteSaveBtn"+this.getData("instanceNo")).ltProp("disabled",!0),this.uploaderIns.options.autoProcessQueue=!0,this.uploaderIns.processQueue()},updateCurrentNote:function(e,t){return store.unloadRecord("note",e),store.findRecord("note",e,{},!0,!0,{module:this.moduleApi,entityId:this.getData("cxPropEntity").id}).then(function(o){var a;this.requestResolved=!0,this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click(),!t&&e&&(this.$node.querySelector(".cruxNotesList .cx_"+e).style.display=""),this.setData("currentNoteUploadedAttachments",[]),this.setData("showAttachments",!1),this.isEdit=!1;var i=this.unModifiedNotes.cruxFindIndexOfObject("id",o[0].id);if(-1==i?(Lyte.arrayUtils(this.unModifiedNotes,"push",o),this.setData("allNotesCount",this.data.allNotesCount+1)):Lyte.arrayUtils(this.unModifiedNotes,"replaceAt",i,o[0]),a=this.unModifiedNotes){var s=this.getData("defaultDisplayedNotesCount");t&&s<a.length&&this.setData("defaultDisplayedNotesCount",s+1),this.unModifiedNotes=a,Lyte.triggerEvent("noteAddedOrDeleted",{allNotes:this.unModifiedNotes,defaultDisplayedNotesCount:this.getData("defaultDisplayedNotesCount"),queryParam:this.data.cxPropQueryParam})}e&&this.getMethods("onNoteEdited")&&this.executeMethod("onNoteEdited"),t&&this.getMethods("onNoteAdded")&&this.executeMethod("onNoteAdded");var n=this.$node.querySelector(".cruxNotesList .cx_"+e).querySelector(".cxNotesNoteActionDetails");if(n&&!n.cxVisbleInViewPort(this.data.cxPropBoundary)){n.scrollIntoView();var r=$L(n).cxGetScrollParent();r&&$L.fastdom.measure((function(){var e=r.scrollTop+n.clientHeight-170;e=this.data.cxPropScrollPosition&&this.data.cxPropScrollPosition.top?e-this.data.cxPropScrollPosition.top:e,$L.fastdom.mutate((function(){r.scrollTop=e})).bind(this)})).bind(this)}}.bind(this))},updateNote:function(e){var t=store.peekRecord("note",e);this.getMethods("onBeforeAddNote")&&(t=this.executeMethod("onBeforeAddNote",t)),t&&t.$.isModified?t.$.save({noteId:e}).then(function(t){this.updateCurrentNote(e)}.bind(this),function(e){if(t.$.rollBack(),e){var o=JSON.parse(e.response);"CANNOT_PERFORM_ACTION"==(o=o.data?o.data[0]:o).code||"NO_PERMISSION"===o.code&&("permission denied"===o.message||o.details&&"Crm_Implied_Create_Attachments"===o.details.permissions[0])?_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}}):"MAX_RECORDS_LIMIT_REACHED"===o.code&&(this.setData("maxStorage",e.details.size),this.$node.querySelector(".noteDataStorageLimit").ltProp("show",!0))}else this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click(),this.currentNoteId=""}.bind(this)):(this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click(),this.$node.querySelector(".cruxNotesList .cx_"+e).style.display="")},actions:{onTextAreaTransition:function(e){e||(e=$L(".cxNotesTextarea")[0]),e.scrollIntoView();var t=$L(e).cxGetScrollParent();t&&(t.scrollTop=t.scrollTop+e.clientHeight-170,this.data.cxPropScrollPosition&&this.data.cxPropScrollPosition.top&&(t.scrollTop=t.scrollTop-this.data.cxPropScrollPosition.top))},openNotesTextarea:function(e,t){this.openNotesTextareaFn(e,t)},closeNotesTextarea:function(){var e;this.isEdit&&(this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).ltProp("disabled",!1),store.peekRecord("note",this.editingNoteId).$.rollBack(),(e=this.$node.querySelector(".cruxNotesList .cx_"+this.editingNoteId))&&!e.cxVisbleInViewPort(this.data.cxPropBoundary)&&e.scrollIntoView());this.currentNoteEntityId="",this.currentNoteModuleApi="",this.setData("showAttachments",!1),this.removedAttachments=[],this.title="",this.getData("newTextbox")?this.closeNewTextbox(!1):(this.bindMentionPlugin([],!0),this.closeNotesTextbox());var t=this.getData("cxPropEntity");!this.getData("isClientPortalUser")&&t.$client_portal_permission&&t.$client_portal_permission.notes&&this.$node.querySelector(".notesTextInputBoxWrap .cxNoteCheckbox").ltProp("checked",!1);this.isEdit||(e=this.$node.querySelector(".notesTextInputBoxWrap"))&&!e.cxVisbleInViewPort(this.data.cxPropBoundary)&&e.scrollIntoView(),this.isEdit=!1,this.editingNoteId="",this.setData("disableShare",!1)},addTitleForThisNote:function(e){e.stopPropagation(),e.preventDefault(),e.target.style.display="none",e.target.previousElementSibling.classList.add("cxAttachFilesWithoutBorder");var t=this.$node.querySelector(".notesTextInputBoxWrap .titleInputSection");t.style.display="",t.querySelector("lyte-input input").focus()},hideTitleInputBox:function(e){e&&e.relatedTarget&&setTimeout((function(){e.relatedTarget.click()}),100),this.$node.querySelector(".titleInputSection .noteTitle input").value||(this.hideNoteTitle(),this.checkSaveButtonStatus())},saveNote:function(){var e=this.currentNoteId,t=(this.getData("allNotes"),this.formattedNoteText);t=t||"";var o=this.$node.querySelector(".titleInputSection lyte-input input").value;if((o=o?o.trim():"")||t.trim())if(t.length>65535)_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.message.limit.exceed","65535","Content"])}});else if(e||!o&&!t||!1!==this.checkPermission("create",e)){if(void 0===this.requestResolved||this.requestResolved){var a,i=!0,s=!!this.getData("isClientPortalUser")||this.shareToCustomer;if(e&&(a=store.peekRecord("note",e))){var n=a.Note_Title?a.Note_Title:"",r=a.Note_Content?a.Note_Content:"";o||t?(a.$.set("$is_shared_to_client",s),o===n&&t===r&&!1===a.$.isDirty()?i=!1:(a.$.set("Note_Title",o),a.$.set("Note_Content",t)),this.removedAttachments.length>0?(i=!1,this.clearRemovedFilesFromNote(e)):this.uploaderObj&&this.uploaderObj.newUploadCount>0&&(i=!1,this.uploadNewFiles(e))):i=!1}if(i){var l=this.moduleApi,c=this.getData("cxPropEntity").id;if(!e&&(o||t)){var d=!e,p={Parent_Id:{id:this.currentNoteEntityId?this.currentNoteEntityId:c},$se_module:this.currentNoteModuleApi?this.currentNoteModuleApi:l,Note_Title:o,Note_Content:t,$attachments:this.attachmentObj,$is_shared_to_client:s};a=store.createRecord("note",p),this.getMethods("onBeforeAddNote")&&(a=this.executeMethod("onBeforeAddNote",a))}if(a&&(a.$.isDirty()||a.$.isNew)){this.requestResolved=!1;var u=$L(".cruxNoteSaveBtn1")[0];u.ltProp("disabled",!0),this.saveNoteLoading=setTimeout((()=>{e||this.data.cxPropNotesOrder==_cruxUtils.getI18n("crm.note.recent.first")?Lyte.Component.insertBefore($L(".cruxNotesList",this.$node)[0].firstChild,this.noteLoadingElement):Lyte.Component.appendChild($L(".cruxNotesList",this.$node)[0],this.noteLoadingElement)}),650),a.$.save({noteId:e}).then(async function(t){u.ltProp("disabled",!1);var o=d?t.note.id:e;this.setData("currentSavedNote",o),await this.updateCurrentNote(o,d),clearTimeout(this.saveNoteLoading);var a=$L("crux-note-loading",this.$node)[0];a&&a.remove()}.bind(this),function(e){a.$.rollBack(),clearTimeout(this.saveNoteLoading);var t=$L("crux-note-loading",this.$node)[0];if(t&&t.remove(),u.ltProp("disabled",!1),this.requestResolved=!0,e){var o=JSON.parse(e.response);(o=o.data?o.data[0]:o).details&&"id"===o.details.api_name?(_cruxUtils.showCustomMessage({params:{ltPropMessage:_cruxUtils.getI18n("crm.translation.refresh.cases"),ltPropType:"error"}}),this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click()):"INVALID_DATA"===o.code||"CANNOT_PERFORM_ACTION"===o.code||"NO_PERMISSION"===o.code&&("permission denied"===o.message||o.details&&"Crm_Implied_Create_Attachments"===o.details.permissions[0])?_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}}):"MAX_RECORDS_LIMIT_REACHED"===o.code&&(this.setData("maxStorage",e.details.size),this.$node.querySelector(".noteDataStorageLimit").ltProp("show",!0))}else this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click(),this.currentNoteId=""}.bind(this))}}else a&&!1===a.$.isDirty()&&this.uploaderObj&&!this.uploaderObj.newUploadCount&&!this.removedAttachments.length&&(this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click(),this.$node.querySelector(".cruxNotesList .cx_"+e).style.display="")}}else _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}})},editNote:function(e){if(!event.target.classList.contains("cxDisableEditBtn")&&!event.target.parentElement.classList.contains("cxDisableEditBtn")&&!1!==this.checkPermission("edit",e)){this.currentNoteId=e,this.editingNoteId=e,this.isEdit=!0;for(var t,o=this.$node.querySelectorAll(".cruxNotesList .cxNotesLi"),a=o.length,i=0;i<a;i++)o[i].classList.contains("cx_"+e)?(o[i].querySelector("#noteMainDiv").style.display="none",t=i):o[i].querySelector("#noteMainDiv").style.display="";var s={},n=this.getData("allNotes"),r=n.length;for(i=0;i<r;i++)if(n[i].id===e){s=n[i];break}this.setData("disableShare",!(this.getData("isClientPortalUser")||!s.Owner||store.peekRecord("user",s.Owner.id)));this.getData("cxPropNotesOrder");var l=void 0;this.getData("newTextbox")&&this.closeNewTextbox(!0),l=this.createTextbox(s),this.$node.querySelector(".cruxNotes").querySelector(".notesTextInputBoxWrap").style.display="none",o[t].querySelector(".cxNotesContentWrap").appendChild(l),this.setData("newTextbox",!0),this.isFileUploadPluginBound&&(this.uploaderIns.destroy(),this.isFileUploadPluginBound=!1),this.isMentionPluginBound=!1;var c=this.getData("instanceNo");l.querySelector(".inputBeforeNote input").addEventListener("focus",this.actions.openNotesTextarea.bind(this)),l.querySelector(".cxNotesAddTitle").addEventListener("click",this.actions.addTitleForThisNote.bind(this));var d=l.querySelector(".cruxNoteCancelBtn"+c),p=l.querySelector(".cruxNoteSaveBtn"+c);d.querySelector("lyte-yield").innerText=_cruxUtils.getI18n.apply(void 0,["crm.button.cancel"]),p.querySelector("lyte-yield").innerText=_cruxUtils.getI18n.apply(void 0,["crm.button.save"]),d.addEventListener("click",this.actions.closeNotesTextarea.bind(this)),p.addEventListener("click",this.actions.saveNote.bind(this)),this.setData("showAttachments",!0);var u=l?l.querySelector(".noteMoreFiles"):this.$node.querySelector(".noteMoreFiles"),m=u.querySelectorAll(".dz-preview"),h=m.length;for(i=0;i<h;i++)m[i].classList.remove("dz-processing"),m[i].style.display="none";var x=[];s.$attachments&&(x=s.$attachments.slice()),this.setData("currentNoteUploadedAttachments",x),u.style.display="block";var y=l||this.$node.querySelector(".notesTextInputBoxWrap"),f=this.getData("cxPropEntity");if(!this.getData("isClientPortalUser")&&f.$client_portal_permission&&f.$client_portal_permission.notes&&s.$is_shared_to_client)y.querySelector(".cxNoteCheckbox").ltProp("checked",!0);y.querySelector(".inputBeforeNote").focus();var N=y.querySelector(".notesTextArea"),g=s.Note_Content;this.formattedNoteText=g;var v=[],C=[],P=[];if(g)for(var b,_=new RegExp("crm[[aA-zZ]*#[0-9]*#[0-9]*]crm","gi"),I=(g=(g=(g=g.replace("&#x5b;","[")).replace("&#x23;","#")).replace("&#x5d;","]")).match(_),A=I?I.length:0,L=0;L<A;L++){var S=I[L].indexOf("#"),D=I[L].lastIndexOf("#"),M=I[L].slice(S+1,D);-1!==I[L].indexOf("user")?(b=store.peekRecord("user",M),g=g.replace(I[L],b?"@"+b.full_name:""),b&&(b.$setype="Users",v.push(b))):-1!==I[L].indexOf("role")?(b=store.peekRecord("role",M),g=g.replace(I[L],b?"@"+b.name:""),b&&(b.$setype="Roles",C.push(b))):-1!==I[L].indexOf("group")&&(b=store.peekRecord("user_group",M),g=g.replace(I[L],b?"@"+b.name:""),b&&(b.$setype="Groups",P.push(b)))}var q,T=v.concat(C).concat(P),E=N.querySelector("lyte-input textarea");if(E.value=g,"function"==typeof Event?q=new Event("change"):(q=document.createEvent("Event")).initEvent("change",!0,!0),E.dispatchEvent(q),s.Note_Title){var w=l?l.querySelector(".titleInputSection"):this.$node.querySelector(".titleInputSection");w.style.display="",w.querySelector("lyte-input input").value=s.Note_Title,this.title=s.Note_Title,(l?l.querySelector(".cxNotesAddTitle"):this.$node.querySelector(".notesTextAreaWrap .cxNotesAddTitle")).style.display="none",(l?l.querySelector(".cxNotesAttachActionArea"):this.$node.querySelector(".notesTextAreaWrap .cxNotesAttachActionArea")).classList.add("cxAttachFilesWithoutBorder")}if(this.bindMentionPlugin(T,!1),E.focus(),!E.cxVisbleInViewPort(this.data.cxPropBoundary)){E.scrollIntoView();var R=$L(E).cxGetScrollParent();R&&(R.scrollTop=R.scrollTop+E.clientHeight-150,this.data.cxPropScrollPosition&&this.data.cxPropScrollPosition.top&&(R.scrollTop=R.scrollTop-this.data.cxPropScrollPosition.top))}this.getMethods("onEditNoteRendered")&&this.executeMethod("onEditNoteRendered",s)}},showDeleteConfirmationModal:function(e,t,o){if(!event.target.classList.contains("cxDisableDeleteBtn")&&!event.target.parentElement.classList.contains("cxDisableDeleteBtn")&&!1!==this.checkPermission("delete",e)){var a=this.$node.querySelector(".cruxNotes lyte-modal.deleteConfirmationModal");if(a.ltProp("show",!0),this.currentNoteId=e,this.setData("currentNoteTitle",t),o)for(var i=new RegExp("crm[[aA-zZ]*#[0-9]*#[0-9]*]crm","gi"),s=(o=(o=(o=o.replace("&#x5b;","[")).replace("&#x23;","#")).replace("&#x5d;","]")).match(i),n=s?s.length:0,r=0;r<n;r++){var l,c=s[r].indexOf("#"),d=s[r].lastIndexOf("#"),p=s[r].slice(c+1,d);-1!==s[r].indexOf("user")?(l=store.peekRecord("user",p),o=o.replace(s[r],l?l.full_name+",":"")):-1!==s[r].indexOf("role")?(l=store.peekRecord("role",p),o=o.replace(s[r],l?l.name+",":l)):-1!==s[r].indexOf("group")&&(l=store.peekRecord("user_group",p),o=o.replace(s[r],l?l.name+",":""))}a.component.childComp.querySelector(".confirmNoteDeleteButton").focus(),this.setData("currentNoteContent",o)}},hideDeleteconfirmationModal:function(){this.$node.querySelector(".cruxNotes lyte-modal.deleteConfirmationModal").ltProp("show",!1)},deleteNote:function(){if(void 0===this.deleteReqResolved||this.deleteReqResolved){var e=this.$node.querySelector(".cruxNotes lyte-modal.deleteConfirmationModal"),t=this.currentNoteId,o=store.peekRecord("note",t);if(!o)return e.ltProp("show",!1),void _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}});this.deleteReqResolved=!1,o.$.destroyRecord({noteId:t}).then(function(t){if(this.deleteReqResolved=!0,t&&(t.note&&"success"===t.note[0].status||"error"===t.note[0].status||t.data&&"success"===t.data[0].status||"error"===t.data[0].status)){this.moduleApi,this.getData("cxPropEntity");if(e.ltProp("show",!1),t.note&&"error"===t.note[0].status||t.data&&"error"===t.data[0].status)return void _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}});(s=this.getData("defaultDisplayedNotesCount"))>0&&this.setData("defaultDisplayedNotesCount",s-1),this.data.allNotesCount>0&&this.setData("allNotesCount",this.data.allNotesCount-1);var a=this.editingNoteId;Lyte.arrayUtils(this.data.allNotes,"removeObjects",o),a&&(this.currentNoteId=a,this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click());var i=store.peekAll("note");this.unModifiedNotes=i;this.unModifiedNotes;var s=this.getData("defaultDisplayedNotesCount");if(a){var n=this.$node.querySelector(".cruxNotesList .cx_"+a).querySelector(".editAddedNote");this.currentNoteId=a,n.click()}this.getMethods("onNoteDeleted")&&this.executeMethod("onNoteDeleted",this)}}.bind(this),function(t){if(o.$.rollBack(),e.ltProp("show",!1),t){var a=JSON.parse(t.response);a=a.data?a.data[0]:a,403===t.status&&("CANNOT_PERFORM_ACTION"===a.code||"NO_PERMISSION"===a.code&&"permission denied"===a.message)&&_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}}),"record not deleted"===a.message&&_cruxUtils.showCustomMessage({params:{ltPropMessage:_cruxUtils.getI18n("crm.translation.refresh.cases"),ltPropType:"error"}})}this.deleteReqResolved=!0,this.currentNoteId="",this.setData("currentNoteTitle",""),this.setData("currentNoteContent",""),this.getMethods("onNotesRequestError")&&this.executeMethod("onNotesRequestError",res)}.bind(this))}},showModuleRecordTooltip:function(e,t,o){var a=this.$node.querySelector("crux-lookup-view-popup");if(e){t.classList.add("cxLookupBc");var i=this.apiModuleMapping[o.$se_module?o.$se_module:o.Parent_Id.module.api_name],s=[i,o.Parent_Id.id];a?a.setData({entityId:o.Parent_Id.id,cxPropTypeMapping:crmConstants.defaultUiTypeToCruxMapping,module:i,cxPropRouteName:"crm.tab.module.entity",cxPropDynamicParams:s,lookupComp:t}):a=Lyte.Component.render("crux-lookup-view-popup",{entityId:o.Parent_Id.id,cxPropTypeMapping:crmConstants.defaultUiTypeToCruxMapping,module:i,lookupComp:t,cxPropRouteName:"crm.tab.module.entity",cxPropDynamicParams:s},this.$node),a.setData("show",!0)}else a.setData("show",!1)},showMoreNotes:function(){var e=this.moduleApi,t=this.getData("cxPropEntity");if(!this.reqPending){this.batchNo+=1;var o=[];this.reqPending=!0,(1===this.batchNo?2*this.notesBatchCount:this.batchNo*this.notesBatchCount+this.notesBatchCount)+30>=this.unModifiedNotes.length&&this.data.moreNotes&&o.push(store.findAll("note",Object.assign(this.pageQuery,this.getData("cxPropQueryParam")),!1,!0,{module:e,entityId:t.id}).then(function(e){this.pageQuery.page=this.pageQuery.page?this.pageQuery.page+1:2,this.data.moreNotes=e.$.meta.more_records}.bind(this))),Lyte.resolvePromises(o).then(function(){this.reqPending=!1;var e=store.peekAll("note");e=Array.from(e);var t=this.currentNoteId;(t&&this.$node.querySelector(".cruxNoteCancelBtn"+this.getData("instanceNo")).click(),this.processNotes(e,!0),t)&&this.$node.querySelector(".cruxNotesList .cx_"+t).querySelector(".editAddedNote").click()}.bind(this),function(e){this.reqPending=!1,this.getMethods("onNotesRequestError")&&this.executeMethod("onNotesRequestError",e)}.bind(this))}},trackSpotLight:function(){var e=this.moduleApi;Crm.trackSpotLightAction("Lookup Hover Click",{Module:e})},showHideCruxNote:function(){if(!(event&&event.target.classList.contains("cxNoteCount")||this.data.cxPropPreventHeaderNotesHide)){var e=this.$node.querySelector(".cruxNotes");""===e.style.display?e.style.display="none":e.style.display=""}},openSheetForExport:function(e,t,o,a,i,s,n,r,l,c){e&&(e.preventDefault(),e.stopPropagation()),openSheetForExport(t+"/specific/ViewAttachment?fileId="+o+"&module="+a+"&nId="+i+"&parentId="+s+"&creatorId="+n+"&id="+r+"&name="+l+"&downLoadMode="+c,c)},fireClickEvent:function(e){e.preventDefault(),e.stopPropagation(),e.target.parentElement.parentElement.querySelector(".cxNotesAttachImage").click()},removeAttachment:function(e){var t=e.target.parentElement;t.style.display="none";for(var o=t.classList,a=o.length,i=void 0,s=0;s<a;s++)if(-1!==o[s].indexOf("cxAtt_")){i=o[s].substring(6);break}i&&-1===this.removedAttachments.indexOf(i)&&(this.removedAttachments.push(i),this.checkSaveButtonStatus(),this.$node.querySelector(".attachementActionArea"+this.getData("instanceNo")).setAttribute("style","display: inline-block"));!this.isFileUploadPluginBound&&FileUploader?this.uploadFile(!0):"undefined"!=typeof FileUploader&&this.uploaderObj.maxFiles<this.uploaderObj.maxAllowedFiles&&(this.uploaderObj.maxFiles+=1,this.uploaderIns.options.maxFiles=this.uploaderObj.maxFiles)},showFullNoteContent:function(e){var t=this.$node.querySelector(".cx_"+e+" .notesAddedContent.showFullContent");this.$node.querySelector(".cx_"+e+" .notesAddedContent.showSeeMore").style.display="none",t.style.display="block"},saveNoteOnEnter:function(e){this.title=arguments[0].target.value,this.checkSaveButtonStatus(),e&&13===e.keyCode&&this.actions.saveNote.call(this)},closeDSInfoPopup:function(){this.$node.querySelector(".noteDataStorageLimit").ltProp("show",!1)},playVoiceNote:function(e,t){var o=$L("#audio_"+t,this.$node)[0];e.classList.contains("icon_pause")?o.pause():o.play(),$L(e).toggleClass("icon_pause")},downloadVoice:function(e){var t=document.createElement("a");t.style="display: none",this.$node.appendChild(t),t.href=this.data.idVsVoice[e.id],t.click(),t.remove()},openMap:function(e){var t=httpprotocol+"maps.google.com/maps?q="+e.Parent_Id.Location_Latitude+","+e.Parent_Id.Location_Longitude;window.open(t)}},removedAttachments:[],getNotesCount:function(e,t){if(e.$&&e.$.meta.more_records&&"undefined"!=typeof Crm&&Crm.userDetails.isRLCountQuerySupported)try{this.data.cxPropEntity.$.triggerAction("get_related_records_count",{type:"POST",version:4},"","",{get_related_records_count:[{related_list:{id:this.data.cxPropRelatedList.id}}]}).then(function(e){this.setData("allNotesCount",e.get_related_records_count[0].count)}.bind(this))}catch(t){this.setData("allNotesCount",e.length)}else this.setData("allNotesCount",e.length)},checkPermission:function(e,t){var o,a=store.peekRecord("note",t),i=this.getData("noteModule");switch(e){case"create":o=a?a._creatable:i.creatable;break;case"edit":o=a?a._editable:i.editable;break;case"delete":o=a?a._deletable:i.deletable}return void 0!==typeof moduleRecordMapping&&moduleRecordMapping[this.data.cxPropModule]&&"team_based"===moduleRecordMapping[this.data.cxPropModule].access_type&&((o=!!Crm.userDetails.permissions["Crm_Implied_"+("delete"==e?"Delete":"create"==e?"Create":"Edit")+"_Notes_"+this.data.cxPropModule])||_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:_cruxUtils.getI18n.apply(void 0,["crm.security.error"]),ltPropWrapperClass:"crmCenterAlert"}})),this.getMethods("getNotesPermisison")&&(o=!!this.executeMethod("getNotesPermisison",o,"opName",a,this.data.cxPropEntity,this.data.cxPropModule)),o},checkSaveButtonStatus:function(){var e=this.$node.querySelector(".cruxNoteSaveBtn"+this.getData("instanceNo"));if(this.uploaderIns&&this.uploaderIns.files&&this.uploaderIns.files.cruxFilterBy({status:"uploading"}).length)e.ltProp("disabled",!0);else{var t=this.title?this.title.trim():"",o=this.formattedNoteText?this.formattedNoteText.trim():"";if(""!=t||""!=o)if(this.isEdit){var a=this.data.allNotes.cruxFilterBy({id:this.editingNoteId})[0],i=a.Note_Title?a.Note_Title:"",s=a.Note_Content?a.Note_Content:"";(t||""===t)&&t!==i||(o||""===o)&&o!==s||this.removedAttachments.length||this.uploaderObj&&this.uploaderObj.newUploadCount>0||a.$is_shared_to_client!==this.shareToCustomer?e.ltProp("disabled",!1):e.ltProp("disabled",!0)}else e.ltProp("disabled",!1);else e.ltProp("disabled",!0)}},createTextbox:function(e){var t=e.$attachments?e.$attachments:[],o=this.getData("instanceNo"),a=this.getData("showAttachments"),i=this.getData("cxPropEntity"),s=document.createElement("div"),n=document.createElement("span"),r=document.createElement("lyte-button"),l=document.createElement("template"),c=document.createElement("lyte-input"),d=s.cloneNode();d.setAttribute("class","notesTextInputBoxWrap");var p=s.cloneNode();p.setAttribute("class","titleInputSection"),p.setAttribute("style","display: none");var u=c.cloneNode();u.setAttribute("class","cxNoteTitleInput pL20 noteTitle"),u.setAttribute("lt-prop-placeholder",_cruxUtils.getI18n.apply(void 0,["crm.general.addtitle"])+"..."),u.setAttribute("lt-prop-maxlength","120"),u.setAttribute("lt-prop-class","cxNoteTitleInputElem"),u.addEventListener("keyup",this.actions.saveNoteOnEnter.bind(this)),u.addEventListener("focusout",this.actions.hideTitleInputBox.bind(this)),p.appendChild(u);var m=c.cloneNode();m.setAttribute("data-zcqa","notesProcess"),m.setAttribute("class","inputBeforeNote"),m.setAttribute("lt-prop-placeholder",_cruxUtils.getI18n.apply(void 0,["crm.general.addnote"])+"..."),m.setAttribute("lt-prop-readonly",i?"true":"false");var h=s.cloneNode();h.setAttribute("class","notesTextArea"),h.setAttribute("style","display: none");var x=c.cloneNode();x.setAttribute("data-zcqa","notesContentTxt"),x.setAttribute("class","cxNotesTextarea notesTextInputBox"),x.setAttribute("lt-prop-class","cxNotesTextareaElem"),x.setAttribute("id","noteTextarea"+o),x.setAttribute("lt-prop-type","textarea"),x.setAttribute("lt-prop-placeholder",_cruxUtils.getI18n.apply(void 0,["crm.general.addnote"])),x.setAttribute("lt-prop-text-area-resize",'{"horizontal" : false, "vertical" : true }'),x.addEventListener("ontransitionend",this.actions.onTextAreaTransition.bind(this));var y=s.cloneNode();y.setAttribute("class","cxNotesFooter notesTextAreaWrap");var f=s.cloneNode();f.setAttribute("class","cxNotesFooterLeft");var N=n.cloneNode();N.setAttribute("data-zcqa","notesAttachFile"),N.setAttribute("class","dIB vam cxNotesAttachIcon attachementActionArea"+o+" notesOtherAction cxNotesAttachActionArea"),N.setAttribute("tabindex","0");var g=n.cloneNode();if(g.setAttribute("data-zcqa","notesaddTitle"),g.setAttribute("class","notesOtherAction cxNotesAddTitle"),g.setAttribute("tabindex","0"),g.innerText=_cruxUtils.getI18n.apply(void 0,["crm.general.addtitle"]),!this.getData("isClientPortalUser")&&i.$client_portal_permission&&i.$client_portal_permission.notes){var v=document.createElement("lyte-checkbox");v.setAttribute("class","cxNoteCheckbox notesOtherAction"),v.setAttribute("lt-prop-label",_cruxUtils.getI18n.apply(void 0,["custmr.prtl.notes.shr.to.custmr"])),v.setAttribute("lt-prop-disabled",e.disableShare),v.setMethods("onChanged",this.getMethods("updateShareToCustomer").bind(this))}var C=s.cloneNode();C.setAttribute("class","cxMlAuto cxNotesFooterRight");var P=r.cloneNode();P.setAttribute("data-zcqa","notesCancelComment"),P.setAttribute("class","cruxNoteCancelBtn"+o+" cxCancelbtn"),P.setAttribute("lt-prop-size","small");var b=l.cloneNode();b.setAttribute("is","registerYield"),b.setAttribute("yield-name","text"),P.appendChild(b);var _=r.cloneNode();_.setAttribute("data-zcqa","notesSaveComment"),_.setAttribute("class","cruxNoteSaveBtn"+o),_.setAttribute("lt-prop-appearance","primary"),_.setAttribute("lt-prop-size","small");var I=l.cloneNode();I.setAttribute("is","registerYield"),I.setAttribute("yield-name","text"),_.appendChild(I);var A=s.cloneNode();A.setAttribute("class","cxFooterRightPrefixYield"),C.appendChild(A),C.appendChild(P),C.appendChild(_);var L=s.cloneNode();L.setAttribute("class","clearB"),y.appendChild(f),f.appendChild(N),(t.length>=5||this.data.cxPropDisableAttachmentActions)&&N.setAttribute("style","display: none"),f.appendChild(g),!this.getData("isClientPortalUser")&&i.$client_portal_permission&&i.$client_portal_permission.notes&&f.appendChild(v),y.appendChild(C),y.appendChild(L);var S=s.cloneNode();return S.setAttribute("id","noteMoreFiles"),S.setAttribute("class","noteMoreFiles cxNoteMoreFiles cruxNoteFiles"+o+" attachzone"),S.setAttribute("style",a?"display: block":"display: none"),t.forEach(function(e){var t=s.cloneNode();t.setAttribute("class","cxAtt_"+e.id+" cxNotesAttachmentWrap");var o=n.cloneNode();o.setAttribute("class","cx-"+e.mappedFileExtn+"-icon mR5 cxVam dIB cxNotesAttachmentIcons");var a=n.cloneNode();a.setAttribute("class","cxVam dIB cxLink cxNotesAttachedListName"),a.innerText=e.File_Name;var i=n.cloneNode();i.setAttribute("class","cxVam dIB"),i.innerText=" ("+e.formattedSize+")";var r=n.cloneNode();r.setAttribute("class","cP cxNotesAttachmentRemoveIcon dIB cxVam mL5"),r.setAttribute("arg-data",e.id),r.addEventListener("click",this.actions.removeAttachment.bind(this)),t.appendChild(o),t.appendChild(a),t.appendChild(i),this.data.cxPropDisableAttachmentActions||t.appendChild(r),S.appendChild(t)}.bind(this)),h.appendChild(x),h.appendChild(y),h.appendChild(S),d.appendChild(p),d.appendChild(m),d.appendChild(h),d},openNotesTextareaFn:function(e,t){if(e&&(this.currentNoteEntityId=e.id,this.currentNoteModuleApi=t),this.$node.querySelector(".cruxNoteSaveBtn"+this.getData("instanceNo")).ltProp("disabled",!0),this.getData("cxPropEntity").id){this.getData("currentNoteUploadedAttachments").length<5&&"undefined"!=typeof FileUploader&&this.uploadFile();var o=$L(this.$node).find(".notesTextInputBoxWrap"),a=this.$node.querySelector(".notesTextInputBoxWrap .notesTextArea");a.style.display="",this.$node.querySelector(".notesTextInputBoxWrap .inputBeforeNote").style.display="none",this.isEdit||(this.shareToCustomer=!1,this.bindMentionPlugin([],!1)),a.querySelector("lyte-input textarea").focus(),a.querySelector("lyte-input textarea").style.height="",o.addClass("cxNoteTextareaOpen"),this.getMethods("onNotesEditorOpen")&&this.executeMethod("onNotesEditorOpen")}}}),Lyte.Component.registerHelper("cruxNumToStorage",(function(e,t,o){if(!e&&0!==e||"NaN"===e)return"-";if(o)return(e<0?0:e)+" "+_cruxUtils.getI18n.apply(void 0,["Records"]);if(0===e||e<0||"0"===e)return"0 Bytes";var a=t||2,i=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,i)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][i]}));
