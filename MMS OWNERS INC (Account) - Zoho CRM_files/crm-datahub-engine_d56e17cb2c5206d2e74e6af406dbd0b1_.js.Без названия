store.registerModel("datahub_source",{id:Lyte.attr("string",{primaryKey:!0}),uuid:Lyte.attr("string"),name:Lyte.attr("string"),type:Lyte.attr("string",{default:"rest_api"}),details:Lyte.attr("object"),created_time:Lyte.attr("string"),modified_time:Lyte.attr("string"),created_by:Lyte.attr("object")}),store.registerAdapter("datahub_source",{namespace:"crm/v7/settings",buildURL:function(e,t,i,r,s){return"update"===t||"delete"===t?s+"/"+r[0].id:s},methodForRequest:function(e){return"PATCH"===e?"PUT":e}}),store.registerSerializer("datahub_source",{serialize:function(e,t){return"createRecord"!==e&&"updateRecord"!==e||(t.datahub_sources=[t.datahub_source],delete t.datahub_source),t},normalize:function(e,t,i){return"update"!==t&&"create"!==t&&"delete"!==t||(i.id=i.details.id),i},payloadKey:function(e){return e+"s"},normalizeResponse:function(e,t,i){return"createRecord"===t?(i.datahub_sources[0].id=i.datahub_sources[0].details.id,i.datahub_sources[0].uuid=i.datahub_sources[0].details.uuid,i.datahub_sources=i.datahub_sources[0]):"updateRecord"===t?((i=i.datahub_sources[0]).id=i.details.id,i.uuid=i.details.uuid):0===Object.keys(i).length&&(i={datahub_sources:[]}),i}}),store.registerModel("datahub",{id:Lyte.attr("string",{primaryKey:!0}),uuid:Lyte.attr("string"),name:Lyte.attr("string"),api_name:Lyte.attr("string"),active:Lyte.attr("boolean"),serializer:Lyte.attr("object"),json_schema:Lyte.attr("object"),json_schema_url:Lyte.attr("object"),type:Lyte.attr("string"),details:Lyte.attr("object"),source:Lyte.attr("object"),created_by:Lyte.attr("object"),created_time:Lyte.attr("string"),modified_time:Lyte.attr("string"),modified_by:Lyte.attr("object"),context_uid:Lyte.attr("string",{default:null})}),store.registerAdapter("datahub",{namespace:"crm/v7/settings",buildURL:function(e,t,i,r,s){return"update"===t||"delete"===t?s+"/"+r[0].id:("createRecord"===t||"deleteRecord"===t?i.context_uid=r.context_uid||"public":"updateRecord"===t?i.context_uid=store.peekRecord("datahub",r.id).context_uid||"public":"findAll"!==t&&"findRecord"!==t||i.context_uid||(i.context_uid="public"),s)},headersForRequest:function(){return{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid}},methodForRequest:function(e){return"PATCH"===e?"PUT":e}}),store.registerSerializer("datahub",{serialize:function(e,t){return"createRecord"!==e&&"updateRecord"!==e||(t.datahubs=[t.datahub],delete t.datahub),t},normalize:function(e,t,i){return"update"!==t&&"create"!==t&&"delete"!==t||(i.id=i.details.id),i},payloadKey:function(e){return e+"s"},normalizeResponse:function(e,t,i,r,s,a,n){return"createRecord"===t?(i.datahubs=i.datahubs[0],i.datahubs.id=i.datahubs.details.id,i.datahubs.uuid=i.datahubs.details.uuid,i.datahubs.context_uid=n.context_uid):"updateRecord"===t?((i=i.datahubs[0]).id=i.details.id,i.uuid=i.details.uuid):0===Object.keys(i).length&&(i={datahubs:[]}),"findAll"!==t&&"findRecord"!==t||i.datahubs.forEach((e=>{e.context_uid=n.context_uid})),i}}),CScript.Engine.DH={Init:async function(e){window.Worker&&(_cscript._dhEngine._isOnInit||(clearTimeout(this.callEngineInit),_cscript._dhEngine._isOnInit=!0,!_cscript._dhEngine.init&&await CScript.Boot(_cscript._dhEngine,!0,!0),_cscript._dhEngine._handlers=["RequestHandler"],!0===e&&featuresAvailable.QUERY_SOURCES&&await store.findAll("trusted_domains"),await _cscript._dhEngine._engine.onStart((async function(){await this.loadVariables("trusted_domains",store.peekAll("trusted_domains").filter((function(e){return e.active})).map((function(e){return e.url}))),await _cscript._dhEngine._engine.importScripts((Crm.env.isDevelopment?document.location.origin:"")+networkUtils.returnDependencyFiles(["devex/libraries/datahub-library.js"],ResourceConstants.CRMClient)[0])})).start()),_cscript._dhEngine._isOnInit=!1)},ExecuteDatahub:async function(e,t){let i=e.uuid?e.uuid:"datahubapi";i=i+"#"+t;let r={[i]:{args:[],event_type:null,namespace:"",event:"ExecuteDatahub",content:`return ExecuteApi('${t}')`,precedence:1}};await _cscript._dhEngine._engine.loadScripts(r),await _cscript._dhEngine._engine.loadVariables("req_data_"+t,e,{configurable:!0});let s=await CScript.Engine.DH.dispatchEvent("ExecuteDatahub");return"coql"===e.type?s=this.manipulate_coql_reponse(s,e.is_single):e.hasOwnProperty("connection")&&s.response&&s.response.details&&s.response.details.statusMessage&&(s.response=s.response.details.statusMessage),s.headers&&(s.headers=this.parse_headers(s.headers),(s.headers["Content-Type"]||s.headers["content-type"])&&this.allowed_response_type(s.headers["Content-Type"]||s.headers["content-type"])||204===s.status_code||(s.response="unsupported response content type"),s.$response||(s.$response={}),s.$response.headers=s.headers,delete s.headers),s.status_code&&(s.$response||(s.$response={}),s.$response.status_code=s.status_code,delete s.status_code),s.response&&(s.response=this.parse_response(s.response)),await _cscript._dhEngine._engine.unloadVariable("req_data"+t),delete s.event_input,s},allowed_response_type:function(e){return 0!==["text/plain","application/xml","text/html","application/json"].filter((t=>e.includes(t))).length},manipulate_coql_reponse:function(e,t){let i={};return i.response=e.response&&e.response.data||e.response||(t?{}:[]),i.headers=e.headers,i.status_code=e.status_code,i},parse_headers:function(e){const t={};if("string"!=typeof e)return e;e.trim().split("\n").forEach((e=>{const[i,r]=e.split(": ").map((e=>e.trim()));t[i]=r}));return t},parse_response:function(e){try{"string"==typeof e&&(e=JSON.parse(e))}catch(t){return e}return e},ExecuteScript:async function(e,t,i,r){let s;var a;if(_cscript._dhEngine._is_preview)a=t+"_serializer",s=e;else{a=t;let i=await fetch(e);s=await i.text()}let n={[a=a+"#"+r]:{args:["$response","result"],event_type:null,namespace:"",event:"onExecute",content:s,precedence:1}};return await _cscript._dhEngine._engine.loadScripts(n),new Promise(((e,t)=>{CScript.Engine.DH.dispatchEvent("onExecute",void 0,{headers:i.$response&&i.$response.headers,status_code:i.$response&&i.$response.status_code},i&&i.response),_cscript._dhEngine._result_promise[r]={resolve:e,reject:t}}))},Destroy:function(){CScript.Engine.DH.Flush()},Restart:function(){CScript.Engine.DH.Flush(),CScript.Engine.DH.Init(!0)},Flush:function(){_cscript._dhEngine._engine&&(_cscript._dhEngine._engine.terminateNow(),_cscript._dhEngine._engine.flushListeners("started")),delete _cscript._wP,_cscript._dhEngine._info=void 0,_cscript._ehc_counter=15},ErrorHandler:function(e){murphy.error(e)},ExecutionHandler:function(e){const[t,i]=e.snippet_id.split("#");switch(e.type){case"execution_start":case"execution_end":case"execution_error":case"execution_timeout":if(_cscript._dhEngine._is_preview)Lyte.triggerEvent("engine_response",e,_cscript._dhEngine._dh_record);else{var r=store.peekAll("datahub").filterBy({uuid:t})[0],s={id:i,uuid:t,d_name:r.name,type:r.type,status:e.type.split("_")[1],start_time:Utils.getDateTimeInUserFormat($L.moment().toDate(),!0),time:"execution_start"===e.type?"":e.execution_time.toFixed(2)};if("execution_start"===e.type)_cscript._dhEngine._execution_logs||(_cscript._dhEngine._execution_logs=[]),-1===_cscript._dhEngine._execution_logs.findIndex((e=>e.id===i&&e.uuid===t))&&Lyte.arrayUtils(_cscript._dhEngine._execution_logs,"unshift",s);else{const r=_cscript._dhEngine._execution_logs.findIndex((e=>e.id===i&&e.uuid===t));-1!==r&&"execution_end"===e.type&&_cscript._dhEngine._execution_logs[r].time.length>0&&(s.time=(parseFloat(s.time)+parseFloat(_cscript._dhEngine._execution_logs[r].time)).toFixed(2)),-1!==r&&Lyte.arrayUtils(_cscript._dhEngine._execution_logs,"replaceAt",r,s)}}switch(e.type){case"execution_error":delete e.originalEvent.data.event_input,_cscript._dhEngine._result_promise[i]&&_cscript._dhEngine._result_promise[i].resolve(e.originalEvent.data),delete _cscript._dhEngine._result_promise[i];break;case"execution_end":case"execution_timeout":_cscript._dhEngine._result_promise[i]&&_cscript._dhEngine._result_promise[i].resolve(e.response),delete _cscript._dhEngine._result_promise[i]}}},dispatchEvent:function(...e){return _cscript._dhEngine._engine.dispatchEvent({intercept:!0,serialize:!0},e)},TrackerHandler:function(e){if(e.value){let t=e.value.snippet_id.split("#")[0];const i={status:e.value.status,query_uuid:t,speed:e.value.speed};Crm.client_tracking("data_hub_execution",i)}}};class DataHub{static async getQueries(e,t){var i;if((i=e?await store.findRecord("datahub",e):await store.findAll("datahub"))&&0!==Object.keys(i).length){if(i=i.filter((e=>e.active)),t)switch(t){case"coql":case"module":i=i.filter((e=>e.type===t));break;default:i=i.filter((e=>e.source&&e.source.id===t))}var r=[];return i.forEach((e=>{r.push(new DataHubQuery(e))})),r}return[]}static async getSources(e){var t,i=[];if(void 0!==e)"coql"===e||"module"===e?i.push(new DataHubSource({name:e,type:e,id:e,uuid:e})):(t=await store.findRecord("datahub_source",e))&&i.push(new DataHubSource(t[0]));else{t=featuresAvailable.QUERY_SOURCES?await store.findAll("datahub_source"):[];[{name:"coql",type:"coql",id:"coql",uuid:"coql"},{name:"module",type:"module",id:"module",uuid:"module"}].forEach((e=>i.push(new DataHubSource(e)))),t.forEach((e=>{i.push(new DataHubSource(e))}))}return i}static async createSource(){if(Crm.userDetails.IS_CONFIRMED_IN_IAM&&Crm.userDetails.isAdvancedDeveloper)return addTempFreezeLayer(),new Promise(((e,t)=>{Lyte.Mixin.get("crm-datahub-global-mixin").opendhpop("source",{resolve:e,reject:t})}));Promise.reject("No Permission")}static async createQuery(e){if(Crm.userDetails.IS_CONFIRMED_IN_IAM&&Crm.userDetails.isAdvancedDeveloper)return addTempFreezeLayer(),new Promise(((t,i)=>{Lyte.Mixin.get("crm-datahub-global-mixin").opendhpop("query",{resolve:t,reject:i},e)}));Promise.reject("No Permission")}}class DataHubQuery{constructor(e){const t={name:e.name,type:e.type,api_name:e.api_name,schema_url:e.json_schema_url,schema:e.json_schema,uuid:e.uuid,source:e.source,modified_by:e.modified_by,method:e.details.method,serialization:!!e.serializer};Object.defineProperties(this,{UUID:{get:()=>t.uuid},name:{get:()=>t.name},config:{get:()=>({get type(){return t.type},get source(){return"rest_api"===t.type?{UUID:t.source.uuid,name:t.source.name}:{UUID:"coql"===t.type?"coql":"module",name:"coql"===t.type?"COQL":"Module"}},get method(){return t.method},get serialization(){return t.serialization},get _details(){return"module"===t.type?Lyte.registeredMixins["crm-datahub-global-mixin"].checkValidQuery(e.id).then((t=>{if(t.validQuery)return Lyte.registeredMixins["crm-datahub-global-mixin"].getFieldModuleList(e)})):Promise.resolve(void 0)},get query(){if("coql"===t.type)return e.details.query}})},modified_by:{get:()=>({name:t.modified_by.name,id:t.modified_by.id})},api_name:{get:()=>t.api_name},schema:{get:async()=>{let e;return t.schema_url?(e=await fetch(t.schema_url),Promise.resolve(await e.json())):t.schema?Promise.resolve(t.schema):void 0}},nodes:{get:async()=>{let e,i;t.schema_url?(e=await fetch(t.schema_url),i=await e.json()):t.schema&&(i=t.schema);let r=[],s=Lyte.registeredMixins["crm-datahub-global-mixin"].generate_list_with_schema(!1,{type:"object",format:"map",properties:{result:i}});for(const e in s){const t=s[e];Lyte.arrayUtils(r,"push",t)}return Promise.resolve(r)}},variables:{get:async()=>Promise.resolve(await Lyte.registeredMixins["crm-datahub-global-mixin"].retrieveDynamicParams(e))},invoke:{get:()=>async e=>new Promise((async(i,r)=>{try{const r=await Lyte.registeredMixins["crm-datahub-global-mixin"].invokeDataHub(t.api_name,e);i(new Response(r,this))}catch(e){r(e)}}))}})}}class Response{constructor(e,t){Object.defineProperties(this,{$response:{get:()=>({headers:e.$response.headers,status_code:e.$response.status_code})},result:{get:()=>e.result},$hub:{get:()=>({...e.$hub,config:t.config})}})}}class DataHubSource{constructor(e){const t={id:e.id,uuid:e.uuid,name:e.name,type:e.type};Object.defineProperties(this,{UUID:{get:()=>t.uuid},name:{get:()=>t.name},type:{get:()=>t.type},queries:{get:async()=>Promise.resolve(await DataHub.getQueries(void 0,t.id))},create_query:{get:()=>{if(Crm.userDetails.IS_CONFIRMED_IN_IAM&&Crm.userDetails.isAdvancedDeveloper)return async e=>(addTempFreezeLayer(),new Promise(((i,r)=>{Lyte.Mixin.get("crm-datahub-global-mixin").opendhpop("query",{resolve:i,reject:r},{...e,source_id:t.id})})));Promise.reject("No Permission")}}})}}
