Lyte.Mixin.register("series_common",{initDefAPI:function(){return store.findAll("dummy",{resource:"series"},!1,!1,{url:"/crm/v2/definition",method:"GET"})},highlightSavedWFRule:function(e){var t="row_"+e.ruleId;this.highlightSavedRule(t),setTimeout((function(){$("#"+t).removeClass("srsLastactiveRow")}),5e3)},highlightSavedRule:function(e){var t=$L("#"+e);if(t[0]){var s=$("#seriesTable .cdsTableHeight .lyteScrollBar");s.on("mousedown wheel keyup touchmove",(function(){$("#setup_new_ContentDiv").stop()})),s.animate({scrollTop:t.position().top-50},"5000","linear",(function(){s.off("mousedown wheel keyup touchmove")})),t.addClass("srsLastactiveRow")}},hideseriesErrorMSg:function(){renderingUtils.hideLyteErrorMessages("#srRuleName")},setRecordsCount:function(e,t,s,a,r){for(var i=e.length,n="",o={},l=s*=50;l<i;l++){var c=e[l].id;t[c]&&(o[t[c]]=c,c=t[c]),n=""===n?c:n+","+c,e[l].records_count="0"}a.parentvsIdsDraft=o,a.series_rules=e,0!==i&&store.findAll("dummy",{ids:n},!1,!1,{url:"/crm/v4/settings/automation/cadences/actions/records_count",method:"GET"}).then(function(t){for(var n=a.parentvsIdsDraft,o=e,l=t.series_records_count.length,c=0;c<l;c++)for(var d=s;d<i;d++)n[t.series_records_count[c].cadences.id]&&(t.series_records_count[c].cadences.id=n[t.series_records_count[c].cadences.id]),o[d].id===t.series_records_count[c].cadences.id&&(o[d].records_count=t.series_records_count[c].count,Lyte.objectUtils(o[d],"add","records_count",t.series_records_count[c].count),Lyte.arrayUtils(o,"replaceAt",d,o[d]));a.series_rules=o,a.rendering=!0,void 0!==r&&this.highlightSavedWFRule(r)}.bind(this))},constructGetAllfilter:function(e){var t=[],s=(e=e||this).getData("searchKeyWord");if(s&&s.length>0){var a={field:{api_name:"name"},comparator:"contains",value:s};t.push(a)}return t.length>0?this.constructCriteria(t):{}},getModuleLabelFromApiName:function(e,t){if(void 0!==e){var s=Utils.inverseKeyValues(moduleApiMapping)[e];if(void 0!==s)return 1===t?moduleRecordMapping[s].singular_label:moduleRecordMapping[s].plural_label}return e},setFilterDataInCurrRoute:function(e){if(e.target.indexOf("cadence")>0&&(e.data||(e.data={}),this.transition.data&&this.transition.data.historyData)){var t={};if(e.data.historyData=this.transition.data.historyData,"crm.settings.section.cadences.index-series"===e.target&&this.transition.info.route!==e.target){var s=!0;if(e.extraDetails){var a=this.transition.data.historyData.module,r=e.extraDetails.module;r&&"undefined"!==r&&a&&a!==r&&(s=!0),t=e.extraDetails}s&&(this.setQueryParams(e.data.historyData).extraDetails=t)}}},getBussinessRecord:function(){var e=this.getData("staticRefDropDown"),t={name:"Business hour(s)"};t.value=I18n.getMsg("wf.business.hours"),e.push(t),(t={}).name="Business day(s)",t.value=I18n.getMsg("wf.business.days"),e.push(t),this.setData("staticRefDropDown",e);var s=$L("#oepnSelect")[0];s&&s.component.init()},registerResizeObserver:function(e){const t=document.querySelector("#setup_new_ContentDiv"),s=new ResizeObserver((()=>e()));return s.observe(t),s},getRecord:function(e,t,s){var a={},r=(a={},{});t&&(r.hostUrl=t,t.headers&&(r.headers=t.headers,r.isSandboxDiff=!0));var i=this;return store.findRecord("cadence",e.dynamicParam,{},"","",r).then(function(e){if(0===Object.keys(e).length){if(s)return;i.redirectToListView({type:"error",msg:I18n.getMsg("crm.series.rule.not.exists")}),this.transition.abort()}a.isSandBox=!1,void 0!==s&&"sandbox"===s&&(a.isSandBox=!0),a.series_data_arr=e,a.seriesId=e[0].id,a.mergeFields=new Promise((t=>{let s=Object.keys(moduleRecordMapping).find((t=>moduleRecordMapping[t].api_name===e[0].module.api_name));wfmergefield.checkAvailabilityAndFetchMergeFieldAPIJSON(s,void 0,(()=>t()))})),a.taskFieldMappings=store.findAll("field",{module:"Tasks",type:"all"},!1,!0,{apiVersion:"2.2"}).then((e=>(a.taskFieldMapping=e,a.taskFieldMapping)),(function(){commonUtils.showHideLoadingDiv()})),a.callFieldMappings=store.findAll("field",{module:"Calls",type:"all"},!1,!0,{apiVersion:"2.2"}).then((e=>(a.callFieldMappings=e,a.callFieldMappings)),(function(){commonUtils.showHideLoadingDiv()})),commonUtils.showHideLoadingDiv();var t={resource:"series"};return e[0].custom_view&&(t.id=e[0].custom_view.id),a.definition=store.findAll("dummy",t,!1,!1,{url:"/crm/v2/definition",method:"GET"}),Lyte.resolvePromises(a)}.bind(this),(function(e){commonUtils.showHideLoadingDiv(),void 0===s&&(400===e.status?i.errorHandlingForStatusChange(e):i.routeErrorHandling(e,!0))}))},convertTriggerArray(e){var t=[];if(e)for(var s=e.length,a=0;a<s;a++)t.push(e[a].type);return t},removeComponent:function(){var e=document.querySelector("crm-series-detail");null!==e&&e.remove();var t=document.querySelector("crm-series-config");null!==t&&t.remove()},renderForSideMenu:function(){var e=$L("#mainMenuTabDiv");$L(".setupleftmenutd , #setupInnerLinks").hide(),$L(".new_setupview").addClass("newSetupRightShow"),e.css("display","")},getTriggerDetails(e){var t=[];if(e)for(var s=(e=JSON.parse(e)).length,a=0;a<s;a++){var r={};r.type=e[a],t.push(r)}return t},getCamelCaseVlaue:e=>("Trigger Date "!==e&&"Trigger Date"!==e||(e="Trigger date"),"Last Enriched Time s"!==e&&"Last Enriched Time "!==e&&"Last Enriched Time  s"!==e||(e="Last enriched time"),"Unsubscribed Time"!==e&&"Unsubscribed Time "!==e||(e="Unsubscribed time"),"Created Time"!==e&&"Created Time "!==e||(e="Created time"),"Modified Time"!==e&&"Modified Time "!==e||(e="Modified time"),"Last Activity Time "!==e&&"Last Activity Time"!==e||(e="Last activity time"),e),removeAllDisabledBtns:function(){$L(".wfSeriesContent").removeClass("disabled"),$L(".deleteBtns").removeClass("hide"),$L("#srsDfHide").removeClass("hide"),$L(".saveBtns").addClass("hide");var e=$L("#srsName");e.length>0&&(e.find(".lyteInputBox").removeClass("lyteInputFocus"),e.removeClass("w350"),e[0].cxProp("readonly",!0))},setActionObjectsi18Data(e){var t={};t[I18n.getMsg("crm.zcampaign.opened")]="Opened",t[I18n.getMsg("crm.zcampaign.clicked")]="Clicked",t[I18n.getMsg("crm.workflow.rule.label.OnOutgoingMailReplied")]="Replied",t[I18n.getMsg("crm.workflow.rule.label.OnOutgoingMailBounced")]="Bounced",t[I18n.getMsg("crm.zcampaign.optout")]="Unsubscribed",t[I18n.getMsg("zb.sent")]="Sent",t[I18n.getMsg("crm.workflow.rule.label.NotesCreated.listing")]="Created",t[I18n.getMsg("crm.mstask.not.caps.started")]="Not Started",t[I18n.getMsg("crm.mstask.deferred")]="Deffered",t[I18n.getMsg("crm.zia.vision.in.progress")]="In Progress",t[I18n.getMsg("crm.mstask.completed")]="Completed",t[I18n.getMsg("crm.series.action.task.waiting")]="Waiting For Input",t[I18n.getMsg("crm.tpi.ctiapi.answered")]="Answered",t[I18n.getMsg("crm.besttime.unanswered")]="Unanswered",t[I18n.getMsg("salesinbox.folder.scheduled")]="Scheduled";var s={};s.Opened=I18n.getMsg("crm.zcampaign.opened"),s.Clicked=I18n.getMsg("crm.zcampaign.clicked"),s.Replied=I18n.getMsg("crm.workflow.rule.label.OnOutgoingMailReplied"),s.Bounced=I18n.getMsg("crm.workflow.rule.label.OnOutgoingMailBounced"),s.Unsubscribed=I18n.getMsg("crm.zcampaign.optout"),s.Sent=I18n.getMsg("zb.sent"),s.Created=I18n.getMsg("crm.workflow.rule.label.NotesCreated.listing"),s["Not Started"]=I18n.getMsg("crm.mstask.not.caps.started"),s.Deffered=I18n.getMsg("crm.mstask.deferred"),s["In Progress"]=I18n.getMsg("crm.zia.vision.in.progress"),s.Completed=I18n.getMsg("crm.mstask.completed"),s["Waiting For Input"]=I18n.getMsg("crm.series.action.task.waiting"),s.Scheduled=I18n.getMsg("salesinbox.folder.scheduled"),s.Answered=I18n.getMsg("crm.tpi.ctiapi.answered"),s.Unanswered=I18n.getMsg("crm.besttime.unanswered"),e.setData("actionObject",t),e.setData("revactionObject",s)},getTargetLines(e,t){for(var s=$L(".lyteConnectionElement").connection("getConnections",document.getElementById(e)),a=s.src,r=s.target,i=void 0!==a?a.length:0,n=void 0!==r?r.length:0,o=0;o<i;o++)t?a[o].addClass("srsFlpColorline"):a[o].removeClass("srsFlpColorline");for(o=0;o<n;o++)t?r[o].addClass("srsFlpColorline"):r[o].removeClass("srsFlpColorline")},afterHeight:function(e,t){var s=e.getData("seriesFollowUps_arr");for(var a in s)if("0"!==a)for(var r=s[a],i=r.length,n={},o=0;o<i;o++){var l=r[o],c=[];c.push(l+"_plus"),n[l]=c;var d=$("#srsInnerWrap_"+l);if(t.hasOwnProperty(l)){var u=e.heightGiven(t,l,a);e.methods.updateDiffHeight(d,u,1)}else e.methods.updateDiffHeight(l,d,3);l="id1_"+l+"_plus"}e.refreshLineConection(e.getData("isSandBox"))},getreplaceExcludeTriggers:function(e,t){var s=this.getData("excludeTriggers").indexOf(t);-1!==s&&Lyte.arrayUtils(this.getData("excludeTriggers"),"removeAt",s,1)},setvalueChecked:function(e,t){var s=$L("#open_unit"),a=$L("#minuteid");"Immediately"!==t&&"Minute(s)"!==t?(s.removeClass("hide"),a.addClass("hide")):("Minute(s)"===t?a.removeClass("hide"):a.addClass("hide"),s.addClass("hide"))},exactRefreshLineForSeeDiff(e,t){for(var s=e.length-1;s>=0;s--)t.indexOf(e[s])>-1&&e.splice(s,1);return e},refreshLineConection(e,t){if(e){var s=$L(".sandboxlineConnection .lyteConnectionContainer"),a=(l=s.length,$L(".sandboxlineConnection"));for(c=0;c<l;c++)a.connection("updateConnection",s.eq(c))}else{var r=$L(".lyteConnectionContainer"),i=$L(".lyteConnectionElement");if(2===i.length&&!t){var n=i.eq(1);if(void 0!==i[1].className)if(1!==i[1].className.split("sandboxlineConnection").length&&(n=i.eq(0),void 0!==e)){var o=$L(".sandboxlineConnection .lyteConnectionContainer");o.length>0&&(r=this.exactRefreshLineForSeeDiff(r,o))}i=n}t&&(i=$L(".lineConnection"));for(var l=r.length,c=0;c<l;c++)i.connection("updateConnection",r.eq(c))}},calcTableHeight:function(e){var t=$L("#setup_new_ContentDiv").outerHeight(),s=$L("#seriesTable");t-=s.position().top,52.2*e.length+44>t?s.css("height",t):s.css("height","auto")},previousAction:function(e,t){for(var s=t[0].follow_ups,a=s.length,r=0;r<a;r++)if(s[r].id===e)return s[r].action.type},previousActionForEdit:function(e,t){return t[e].action},previousActionForEditSubject:function(e,t){return t[e].subject},calcDetailHeight:function(){var e=$L("#setup_new_ContentDiv").height();e-=$L(".seriesHeader").outerHeight()+75,$L(".srsSectionCont").css("height",e)},calcDetailHeightFunnel:function(){var e=$L("#setup_new_ContentDiv").height();e-=$L(".seriesHeader").outerHeight()+43,$L(".srsDiv").css("height",e)},calcReportsHeight:function(){var e=$L("#setup_new_ContentDiv").outerHeight();e-=70,$L(".srshAuto").css("height",e)},editSeries:function(e){var t={route:"crm.settings.section.cadences.edit-series-config",dynamicParams:[e]};Lyte.Router.transitionTo(t),data.setData("isEdit",!0)},redirectToListView:function(e){var t={},s=$L("crm-series-detail")[0];if(s){var a=(s=s.component).getData("seriesId");s.getData("parentSeriesId")&&(a=s.getData("parentSeriesId")),e&&(t.data=e)}t="error"!==e.type?Lyte.Router.transitionTo({route:"crm.settings.section.cadences.index-series"}).extraDetails={from:"save",highlight:!0,ruleId:a,ruleName:s.getData("name"),module:s.getData("module"),data:e}:Lyte.Router.transitionTo({route:"crm.settings.section.cadences.index-series"}).extraDetails={data:e}},isInternalRouteChange:function(e){if(e.target){var t=e.target;if(t.includes("edit-series-config")||t.includes("crm-series-view-reports")||t.includes("crm-series-showfunnel"))return!0}return!1},viewReports:function(e,t,s,a,r,i){var n={route:"crm.settings.section.cadences.crm-series-view-reports",dynamicParams:[e],queryParams:{action:t}};Lyte.Router.transitionTo(n).data={type:t,serId:e,module:s,name:a,createdBy:r,isListPage:i}},getReports:function(e,t,s,a,r){var i=store.peekRecord("cadence",e),n={};(c={}).followup_action_type=t,s&&(c.from=s,c.to=a);var o="",l=$L("crm-series-reports")[0];if(void 0!==l&&(o=l.component,r&&o.setData("fromSameDate",r)),void 0===i){var c={},d="/crm/v4/settings/automation/cadences/"+e+"/actions/analytics?followup_action_type="+t;void 0!==s&&(d=d+"&from="+s+"&to="+a);var u={};return u.url=d,u.method="GET",store.findAll("dummy",{},!1,!1,u).then((e=>{if(commonUtils.showHideLoadingDiv(!1),e.hasOwnProperty("cadences")?(n.series_rules=e.cadences[0].follow_ups,n.module=e.cadences[0].module.api_name,n.name=e.cadences[0].name,n.createdBy=e.cadences[0].created_by.name,n.seriesId=e.cadences[0].id,n.isReload=!0,o&&(n.selectedDate=o.getData("selectedDate"))):n.series_rules=[],o&&o.getData("fromSameDate")){var t=n.series_rules.length;o.setData("series_rules",e.cadences[0].follow_ups);var s=Lyte.Router.getRouteInstance().__ltp.queryParams.action;return"Call"===s?o.reportsCall(t,o):"Task"===s?o.reportsTask(t,o):o.reportsAlert(t,o),Lyte.resolvePromises(n)}return Lyte.resolvePromises(n)}),function(){commonUtils.showHideLoadingDiv(!1),Lyte.registeredMixins.series_common.redirectToListView({type:"error",msg:I18n.getMsg("crm.series.rule.not.exists")})}.bind(o))}return i.$.triggerAction("analytics","",c,"","").then((function(e){if(commonUtils.showHideLoadingDiv(!1),e.hasOwnProperty("cadences")?n.series_rules=e.cadences[0].follow_ups:n.series_rules=[],o&&o.getData("fromSameDate")){var t=n.series_rules.length;o.setData("series_rules",e.cadences[0].follow_ups);var s=Lyte.Router.getRouteInstance().__ltp.queryParams.action;return"Call"===s?o.reportsCall(t,o):"Task"===s?o.reportsTask(t,o):o.reportsAlert(t,o),Lyte.resolvePromises(n)}return Lyte.resolvePromises(n)}),function(e){i.$.rollBack(),Lyte.objectUtils(fetchedRule,"add","active",!selectedStatus),o.errorHandlingForStatusChange(e,i)}.bind(o))},getFunnelData:function(e){var t=store.peekRecord("cadence",e),s={};if(void 0===t){var a="/crm/v4/settings/automation/cadences/"+e+"/actions/analytics",r={};return r.url=a,r.method="GET",store.findAll("dummy",{},!1,!1,r).then((e=>(e.hasOwnProperty("cadences")?(s.series_rules=e,s.module=e.cadences[0].module.api_name,s.name=e.cadences[0].name,s.createdBy=e.cadences[0].created_by.name,s.seriesId=e.cadences[0].id):s.series_rules=[],Lyte.resolvePromises(s))))}return t.$.triggerAction("analytics","","","","").then((function(e){return s.series_rules=e,Lyte.resolvePromises(s)}))},routeErrorHandling:function(e,t){var s=e.status;403!==s&&400!==s||(t&&Lyte.Router.getRouteInstance().transitionTo("crm.settings.index"),setTimeout((function(){renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("crm.security.error"))}),10))},checkValidationSymbol:function(e,t){var s=getClrTxtPtnResChars(e.getData("ruleName").trim()).join(", ");if(""!==s){var a=1===s.length?I18n.getMsg("crm.clearTextPattern.validationFail.alert",[I18n.getMsg("crm.lar.name"),s]):I18n.getMsg("crm.clearTextPattern.validationFail.alert.moreThanOneChar",[I18n.getMsg("crm.lar.name"),s]);return renderingUtils.showLyteErrorMessage(a,$L("#"+t+" .lyteField"),"series_name"),!1}return!0},checkCvDetails:function(e){if("custom_view"===e.getData("seriesType")){var t=e.getData("cvidDetails");return!(!t||!t.name)}return!0},checkSelectedCV:function(e,t){return"custom_view"===e.getData("seriesType")&&void 0===t},parsexhrObj:function(e){var t=JSON.parse(e.responseText);return Array.isArray(t.cadence)?t.cadence[0]:Array.isArray(t.cadences)?t.cadences[0]:t.cadences?t.cadences:t.cadence?t.cadence:t},getErrorFieldRecord:function(e,t){var s=e.details.json_path.substr(2);s=s.substr(0,s.lastIndexOf("."));var a=this.getFieldApiNameFromJsonPath(t.newRequestBody,s);return a=store.peekRecord("field",a.id)},getFieldApiNameFromJsonPath:function(e,t){for(var s=this.getPathArr(t),a=e,r=s.length,i=0;i<r;i++){if(!a[s[i]])return;a=a[s[i]]}return a},checkLimitCount:function(e,t){var s=0;for(var a in e){if(e[a].module===t&&++s>Crm.seriesLimit){var r=I18n.getMsg("crm.series.limit.exceed",Crm.seriesLimit);return this.setData("showCreateModal",!1),this.displayMsgBox(r,"error"),!0}a++}return!1},errorHandlingForStatusChange:function(e,t,s){commonUtils.showHideLoadingDiv();var a=this.parsexhrObj(e);if("triggerType already added"!==a.code)if("the given module doesn't exist"!==a.message)if("Stop the Cadence on a particular date has passed"!==a.message)if("No Followup actions associated with this cadence, Associate any action to  activate"!==a.message){if("Calls Action Not Supported in this Edition"===a.message){u="crm.cadences.activate.calls.message";return s&&"published"===s&&(u="crm.cadences.activate.calls.message.publish"),void this.displayActiveMessag(u,"error")}if("Task Action Not Supported in this Edition"===a.message){u="crm.cadences.activate.task.message";return s&&"published"===s&&(u="crm.cadences.activate.task.message.publish"),void this.displayActiveMessag(u,"error")}if("Task action Configured more than allowed limit"===a.message){u="crm.cadences.activate.task.limit.message";return s&&"published"===s&&(u="crm.cadences.activate.task.limit.message.publish"),void this.displayActiveMessag(u,"error")}if("Email action Configured more than allowed limit"===a.message){u="crm.cadences.activate.alert.limit.message";return s&&"published"===s&&(u="crm.cadences.activate.alert.limit.message.publish"),void this.displayActiveMessag(u,"error")}if("Calls action Configured more than allowed limit"===a.message){u="crm.cadences.activate.call.limit.message";return s&&"published"===s&&(u="crm.cadences.activate.call.limit.message.publish"),void this.displayActiveMessag(u,"error")}if("Associated Custom View is not available"!==a.message){if("Cadence stop date should be greater than or equal to the current date"===a.message||"the given format is invalid please provide the value as MM/DD/YYYY"===a.message){u="crm.series.cadnces.stop.date",m=I18n.getMsg(u);return $L("crm-series-detail")[0].component.setData("progressIndicator",""),void this.displayMsgBox(m,"error")}if("Cadences limit exceeded"!==a.code)if("Cadences action limit exceeded"!==a.code)if("Cadences active limit exceeded"!==a.code)if("Cadences inactive limit exceeded"!==a.code)if("DUPLICATE_DATA"!==a.code)if("MANDATORY_NOT_FOUND"!==a.code){if("invalid data"===a.code){if("You cannot update a read only rule"===a.message)return void this.displayMsgBox(I18n.getMsg("scoring.invalid.layout"),"error");if("Layout id seems to be invalid"===a.message)return void this.displayMsgBox(I18n.getMsg("scoring.layout.notexists"),"error");if("The id given seems to be invalid"===a.message)return void this.displayMsgBox(I18n.getMsg("crm.series.rule.not.exists"),"error");if("The given type in trigger_detils is invalid"===a.message)return void this.displayMsgBox(I18n.getMsg("crm.series.rule.not.exists"),"error");if("The given api_name seems to be invalid"===a.message){var r=this.getErrorFieldRecord(a,s);this.displayMsgBox(I18n.getMsg("score.field.unused.error.any",r.field_label),"error")}}if("FEATURE_NOT_SUPPORTED"===a.code&&this.displayMsgBox(I18n.getMsg("score.rule.active.msg"),"error"),"INVALID_MODULE"===a.code||"NOT_SUPPORTED"===a.code)if("Given field is not available with the given layout"===a.message){r=this.getErrorFieldRecord(a,s);var i=t.layout?"score.field.unused.error.layout":"score.field.unused.error.any",n=[r.field_label];t.layout&&n.push(Lyte.Component.registeredHelpers.getTranslatedLayoutName(t.layout.api_name)),this.displayMsgBox(I18n.getMsg(i,n),"error")}else if("Layout or Score Fields are not supported in the criteria"===a.message){"LAYOUTID"===(r=this.getErrorFieldRecord(a,s)).column_name?this.displayMsgBox(I18n.getMsg("score.layout.invalid.criteria"),"error"):this.displayMsgBox(I18n.getMsg("score.invalid.criteria"),"error")}else{var o;if("The custom_view with campaign criteria are not supported"===a.message)return t.$.isNew?(l=I18n.getMsg("crm.cadences.cv.campaign.create"),o=I18n.getMsg("crm.cadences.created")):(o="clone"===s?I18n.getMsg("crm.cadences.cloned"):t.parent_series?I18n.getMsg("crm.cadences.republished"):I18n.getMsg("crm.cadences.published"),l=I18n.getMsg("crm.cadences.cv.campaign",o)),void _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.cadences.cv.campaign.pmsg",[t.name,o]),ltPropSecondaryMessage:l,ltPropType:"error",ltPropWrapperClass:"admc_customAlert"},accept:this.popupClose});this.displayMsgBox(I18n.getMsg("scoring.invalid.module"),"error")}"the given id seems to be invalid"===a.message&&this.redirectToListView({type:"error",msg:I18n.getMsg("crm.series.rule.not.exists")}),403!==e.status||this.routeErrorHandling(e)}else{var l=I18n.getMsg("Cadence")+" "+I18n.getMsg("email.con.invalid.nm");renderingUtils.showLyteErrorMessage(l,$L("#srRuleName .lyteField"),"series_name")}else renderingUtils.showLyteErrorMessage(I18n.getMsg("duplicate.rule.series.name"),$L("#srRuleName .lyteField"),"series_name");else{u="crm.series.limit.exceed.deactivated",c=a.details.limit,m=I18n.getMsg(u,c);this.displayMsgBox(m,"error")}else{u="crm.series.limit.exceed.activated",c=a.details.limit,m=I18n.getMsg(u,c);this.displayMsgBox(m,"error")}else{u="crm.series.action.limit.exceed";var c=a.details.limit,d=a.details.type;m=I18n.getMsg(u,[d,d]);this.displayMsgBox(m,"error")}else{var u="crm.series.limit.exceed",c=a.details.limit,g=$L("#cloneSeries")[0];g&&g.component.setData("ltPropShow",!1),this.setData("showCreateModal",!1);m=I18n.getMsg(u,c);this.displayMsgBox(m,"error")}}else{var u="crm.series.cadnces.deact.nocv",m=I18n.getMsg(u,[t.name,t.custom_view.name]);this.displayMsgBox(m,"error")}}else{var u="crm.series.cadnces.deact.noaction",m=I18n.getMsg(u);this.displayMsgBox(m,"error")}else{var u="crm.series.cadnces.activate.stop.date",m=I18n.getMsg(u);this.displayMsgBox(m,"error")}else this.routeErrorHandling(e,!0);else{var m=I18n.getMsg("crm.series.trigger.present.msg");this.displayMsgBox(m,"error")}},checkValidName:function(e,t,s){if(""===t.getData("ruleName").trim()){var a=I18n.getMsg("Cadence")+" "+I18n.getMsg("email.con.invalid.nm");return renderingUtils.showLyteErrorMessage(a,$L("#"+s+" .lyteField"),"series_name"),!1}if(t.getData("ruleName").trim().length>51)return renderingUtils.showLyteErrorMessage(I18n.getMsg("sr.rule.name.exceed",50),elem,"Cadences"),!1;for(var r=e.length,i=0;i<r;i++)if(t.getData("ruleName").trim()===e[i].name)return t.setData("showCreateBtn",!1),!1;return!0},displaySuccessOrErrorMsg:function(e,t){this.displayMsgBox(e,t)},displayActiveMessag:function(e){var t="<a href='"+commonUtils.getHelpUrl("help.automation.cadences")+"'  rel='noopener noreferrer' target='_blank'>link</a> ",s="<a href='"+Crm.userDetails.manageSubscriptionUrl+"'  rel='noopener noreferrer' target='_blank'>link</a> ",a=$L("#seriesActivateMsg").e;a.ltProp("show",!1),this.setData("activeErrorMessage",I18n.getMsg(e,[Crm.userDetails.TRAIL_TYPE,t,s])),a.ltProp("show",!0)},displayMsgBox:function(e,t){var s=$L("#seriesMsgBox").e;s.ltProp("show",!1),s.ltProp("message",e),s.ltProp("type",t),s.ltProp("show",!0)},getRecIndex:function(e){var t=0,s=this.getData("series_rules");for(var t in s){if(s[t].id===e)return t;t++}},openSeriestext:function(e){"Immediately"!==e&&$L("#open_unit").removeClass("hide")},checkItisChanged:function(e,t,s){for(var a=t.length,r=0;r<a;r++)if(!t[r].hasOwnProperty("id")&&t[r].hasOwnProperty("reference_id")&&"{{Followup_1}}"===t[r].reference_id&&(t[r].id=e),t[r].id===e){if(!t[r].triggers.hasOwnProperty("execute_after")){var i={unit:"1",period:"immediately"};t[r].triggers.execute_after=i}void 0!==t[r].schedule&&t[r].schedule.hasOwnProperty("execute_after")&&t[r].schedule.execute_after.hasOwnProperty("id")&&(s.execute_after.id=t[r].schedule.execute_after.id);var n=t[r].triggers.execute_after;return n.unit!==s.execute_after.unit||n.period!==s.execute_after.period||t[r].triggers!==s}},changeValinFlps:function(e,t,s,a,r){for(var i=t.follow_ups,n=i.length,o=0;o<n;o++){var l=i[o];if(i[o].id===e){if(void 0!==a){var c=l.action.details.id;l.action.details=a,l.action.details.id=c}void 0!==r&&r&&(l.action.details={},l.action.details.id=r,s&&s.execute_after&&s.execute_after.id&&delete s.execute_after.id);var d=[];return l.triggers=s,s&&s.execute_after&&(void 0===l.schedule||"immediately"===s.execute_after.period?("immediately"===s.execute_after.period&&l.schedule&&l.schedule.execute_after&&"immediately"!==l.schedule.execute_after&&"immediately"!==l.schedule.execute_after.period&&"immediatelys"!==l.schedule.execute_after.period&&void 0===r&&delete l.action.details.id,l.schedule={},l.schedule.execute_after=s.execute_after):l.schedule&&void 0!==a?(l.schedule.execute_after.unit=s.execute_after.unit,l.schedule.execute_after.period=s.execute_after.period):l.schedule&&l.triggers.execute_after&&(l.schedule={},l.schedule.execute_after=l.triggers.execute_after)),Lyte.arrayUtils(i,"replaceAt",o,l),d.push(l),t.$.set("follow_ups",d),i}}},setCheckedValueForOpen:function(e){var t=$L("#open_unit"),s=$L("#minuteid");"Immediately"!==e&&"Minute(s)"!==e?(t.removeClass("hide"),s.addClass("hide")):("Minute(s)"===e?s.removeClass("hide"):s.addClass("hide"),t.addClass("hide"))},getDays:function(e){return"days"===e?e="Day(s)":"minutes"===e?e="Minute(s)":"months"===e?e="Month(s)":"hours"===e?e="Hour(s)":"immediatelys"===e||"immediately"===e?e="Immediately":"business days"===e?e="Business day(s)":"business hours"===e&&(e="Business hour(s)"),e},initializCallCommon:function(){var e=this.getData("prevType"),t=[],s=$L("crm-series-detail").e[0].component;if(""===e){var a=void 0!==s.getData("seriesId");this.setData("isSeriesEdit",a),this.setData("prevType",s.getData("previousAction")),e=s.getData("previousAction")}var r=s.getData("splitId");if(s.getData("isFromActionEdit")&&(r=s.getParentid(s.getData("parentvsrefId"),r)),void 0!==r){var i=(h=s.getData("series_data_arr")[0].follow_ups).length;if(void 0===(f=s.getData("parentvsrefId")[r])){var n=s.getData("parentId"),o="";if(void 0===n)o=s.getParentid(s.getData("parentvsrefId"),r);else o=n.split("_")[1];f=s.getData("parentvsrefId")[o]}if(void 0!==f)for(var l=f.length,c=0;c<l;c++){var d=f[c];if(d&&2!==d.split("plus").length){for(var u=0;u<i;u++)if(h[u].id===d){var g=h[u].triggers;if(g)for(var m=g.length,p=0;p<m;p++)t.push(g[p].type)}}else 1===i&&2===d.split("plus").length&&(e="")}}""===e&&this.setData("isTriggerPopNeeded",!1),void 0===e&&this.setData("isTriggerPopNeeded",!1);var h,v=s.getData("editedId");i=(h=s.getData("series_data_arr")[0].follow_ups).length;if(v&&i>1)for(u=0;u<i;u++)h[u].id===v&&null===h[u].parent_follow_up&&this.setData("isTriggerPopNeeded",!1);else if(v&&1===i){var f;void 0===(f=s.getData("parentvsrefId")[v])&&this.setData("isTriggerPopNeeded",!1)}var _=[],D=s.getData("seriesTaskField"),y=s.getData("seriesCallsField");"alert"===(e=void 0!==e?e.toLowerCase():e)||"email"===e?(y=s.getData("seriesEmailField"),this.setData("prevType","email")):"task"!==e&&"Task"!==e||(y=D);for(l=y.length,c=0;c<l;c++){var I={};"-None-"!==y[c]&&(I.value=I18n.getMsg(y[c]),I.name=y[c],_.push(I))}void 0!==s.getData("editedObjectForAction").type&&this.setData("selectTypeTriggers",s.getData("editedObjectForAction").type),_&&_.sort(),this.setData("triggerDataType",_),this.setData("excludeTriggers",t)},getTriggerFields:function(e,t){switch(t){case"Email":return e.getData("seriesEmailField");case"Task":return e.getData("seriesTaskField");case"Call":return e.getData("seriesCallsField")}},getRemainingTriggers:function(e){var t=e.getData("parentvsrefId"),s=e.getData("actionDetails");for(var a in t)if(t.hasOwnProperty(a)){for(var r=t[a],i=r.length,n=[],o=0;o<i;o++){var l=r[o];if(!l.endsWith("_plus")){var c=n.slice();n=[],(!c||c.length<=0)&&(c=this.getTriggerFields(e,s[l].previousAction)).filter((e=>"-None-"!==e));var d=s[l].triggers;for(var u of c){var g=!1;for(var m of d)if(u===m){g=!0;break}g||"-None-"===u||n.push(u)}}}Lyte.objectUtils(this.getData("parentIdVsRemTriggers"),"add",a+"_plus",n)}},reportsCall:function(e,t){var s={totalCalls:0,total_calls_completed:0,total_calls_failed:0,total_calls_schedule:0,total_calls_canceled:0,total_calls_missed:0,total_calls_overdue:0,total_calls_created:0};if(0!==e){var a=0,r=0,i=0,n=0,o=0,l=0,c=0,d=t.getData("series_rules");d=this.orderReports(d,e),t.setData("series_rules",d);for(var u=0;u<e;u++){var g=d[u].analytics;void 0===g.created_calls_count&&(g.created_calls_count=0),void 0===g.completed_calls_count&&(g.completed_calls_count=0),void 0===g.missed_calls_count&&(g.missed_calls_count=0),void 0===g.overdue_calls_count&&(g.overdue_calls_count=0),void 0===g.cancelled_calls_count&&(g.cancelled_calls_count=0),void 0===g.failed_calls_count&&(g.failed_calls_count=0),void 0===g.scheduled_calls_count&&(g.scheduled_calls_count=0),n+=parseInt(g.completed_calls_count),n+=parseInt(g.missed_calls_count),i+=parseInt(g.failed_calls_count),c+=parseInt(g.overdue_calls_count),o+=parseInt(g.cancelled_calls_count),l+=parseInt(g.scheduled_calls_count),r+=parseInt(g.created_calls_count)}a=n+0+o+r+l+c;s.total_calls_created=a,a+=i,s.totalCalls=a,0===a?(s.totalCalls=0,s.total_calls_completed=0,s.total_calls_failed=0,s.total_calls_schedule=0,s.total_calls_canceled=0,s.total_calls_missed=0,s.total_calls_overdue=0):(s.total_calls_completed=this.setDecimalVal(n/a*100),s.total_calls_failed=this.setDecimalVal(i/a*100),s.total_calls_schedule=this.setDecimalVal(l/a*100),s.total_calls_canceled=this.setDecimalVal(o/a*100),s.total_calls_missed=this.setDecimalVal(0/a*100),s.total_calls_overdue=this.setDecimalVal(c/a*100))}if(t.setData("percentage",s),t.getData("fromSameDate")){d=t.getData("series_rules");0===e?(t.setData("isRulesAvailInFilter",!1),t.setData("series_rules",[])):t.setData("isRulesAvailInFilter",!0),t.setData("fromSameDate",!t.getData("fromSameDate"))}},parentVsRefiDdeleteCheck:function(e,t,s){if(e[t]&&e[t].length>2){for(var a=e[t],r=[],i=a.length,n=0;n<i;n++)a[n]!==s&&r.push(a[n]);e[t]=r}else delete e[t]},orderReports:function(e,t){for(var s=[],a=0;a<t;a++){var r=parseInt(e[a].follow_up_number);s.push(r)}var i=[],n=[];s.sort((function(e,t){return e-t}));for(a=0;a<t;a++)for(var o=0;o<t;o++)if(parseInt(e[o].follow_up_number)===s[a]&&-1===i.indexOf(e[o].id)){n.push(e[o]),i.push(e[o].id);break}return n},reportsTask:function(e,t){var s={totalEtasks:0,total_task_completed:0,total_task_failed:0,total_task_opened:0};if(0!==e){var a=0,r=0,i=0,n=t.getData("series_rules");n=this.orderReports(n,e),t.setData("series_rules",n);for(var o=0;o<e;o++){var l=n[o].analytics;r+=parseInt(l.completed_tasks_count),a+=parseInt(l.failed_tasks_count),i+=parseInt(l.open_tasks_count)}var c=r+a+i;(s={}).totalEtasks=c,0===c?(s.totalEtasks=0,s.total_task_completed=0,s.total_task_failed=0,s.total_task_opened=0):(s.total_task_completed=this.setDecimalVal(r/c*100),s.total_task_failed=this.setDecimalVal(a/c*100),s.total_task_opened=this.setDecimalVal(i/c*100))}if(t.getData("fromSameDate")){n=t.getData("series_rules");0===e?(t.setData("isRulesAvailInFilter",!1),t.setData("series_rules",[])):t.setData("isRulesAvailInFilter",!0),t.setData("fromSameDate",!t.getData("fromSameDate"))}t.setData("percentage",s)},setDecimalVal:function(e){return e%1!=0?e.toFixed(2):e.toFixed(0)},reportsAlert:function(e,t){var s={sent:0,unsent:0,bounceCount:0,clickCount:0,replyCount:0,openCount:0,unsubscribed:0,totalCount:0};if(0!==e){var a=0,r=0,i=0,n=0,o=0,l=0,c=0,d=0,u=t.getData("series_rules");e=(u=this.orderReports(u,e)).length,t.setData("series_rules",u);for(var g=0;g<e;g++){var m=u[g].analytics;a+=parseInt(m.clicked_email_count),i+=parseInt(m.bounced_email_count),n+=parseInt(m.replied_email_count),o+=parseInt(m.sent_email_count),d+=parseInt(m.email_count),l+=parseInt(m.unsent_email_count),r+=parseInt(m.opened_email_count),c+=parseInt(m.unsubscribed_email_count)}var p=l+d;s.sent=this.setDecimalVal(o/p*100),s.unsent=this.setDecimalVal(l/p*100),s.bounceCount=this.setDecimalVal(i/p*100),s.clickCount=this.setDecimalVal(a/p*100),s.replyCount=this.setDecimalVal(n/p*100),s.openCount=this.setDecimalVal(r/p*100),s.unsubscribed=this.setDecimalVal(c/p*100),s.totalCount=p}if(t.getData("fromSameDate")){u=t.getData("series_rules");0===e?(t.setData("isRulesAvailInFilter",!1),t.setData("series_rules",[])):t.setData("isRulesAvailInFilter",!0),t.setData("fromSameDate",!t.getData("fromSameDate"))}t.setData("percentage",s)},actions:{validateNumInp:function(e,t){var s=e.which?e.which:e.keyCode;return 69===s||189===s||190===s||187===s||110===s||48===s&&""===t.getData("cxPropValue")?(e.preventDefault(),!1):void 0}}});
