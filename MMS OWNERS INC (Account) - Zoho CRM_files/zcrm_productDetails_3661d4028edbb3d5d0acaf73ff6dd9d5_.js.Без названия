var searchStats={searchText:"",scrollEnd:!1,fetchedAll:!1,scrollPageIndex:1,lineInFocus:"",textBoxId:"",previousSearchResults:[],previousSearchTerm:"",previousVendorStatus:!1},productDetails={debugVar:"",linesInPop:0,linesInPopInBp:{},prdIdVsDetailsMap:"",currencySymbol:"",roundOff:2,roundOffPrecision:Math.pow(10,2),module:"",discStatus:"percent",allTaxes:"",newAllTaxes:"",sortedOrgTax:[],taxIdVsName:{},autoPopulateTax:!0,canEditTaxValue:!0,grandTaxChanged:!1,bcCols:"",layoutVsBCfieldDetails:"",layoutIdVsLayoutName:"",fieldsInBC:"",bcUiTypes:"",taxNameVsId:{},isInited:!1,hideListPrice:!0,invModuleVsLineItemSfTabId:[],sfFldIdSuffix:"",init:function(t,e,a,i,r){var l=!1;if("blueprint"===a)$("#multipleFieldsEditPop #"+i.relListId+"_rlContainer");var s=$("#searchCreateDiv");productDetails.module=e,Crm.userDetails.hideProductLineItemsSummary&&$("#summary").remove(),Crm.userDetails.TAX_MIGRATION_COMPLETED||1!=t.TAX_MIGRATION_COMPLETED||(Crm.userDetails.TAX_MIGRATION_COMPLETED=!0),$("#popup1").append(s);var n=$("#popup1"),o=document.getElementsByName("createEntityNewForm");if($(o).parent().append(n),productDetails.fillTaxDetails(t),productDetails.autoPopulateTax=t.autoPopulateTax,productDetails.canEditTaxValue=t.canEditTaxValue,t.fieldsInBC&&(productDetails.fieldsInBC=t.fieldsInBC,productDetails.fieldsInBC=productDetails.fieldsInBC.replace("[",""),productDetails.fieldsInBC=productDetails.fieldsInBC.replace("]",""),productDetails.fieldsInBC=productDetails.fieldsInBC.split(", ")),t.colNamesInBC&&(productDetails.bcCols=t.colNamesInBC,productDetails.bcCols=productDetails.bcCols.replace("[",""),productDetails.bcCols=productDetails.bcCols.replace("]",""),productDetails.bcCols=productDetails.bcCols.split(", ")),t.uiTypesInBC&&(productDetails.bcUiTypes=t.uiTypesInBC,productDetails.bcUiTypes=productDetails.bcUiTypes.replace("[",""),productDetails.bcUiTypes=productDetails.bcUiTypes.replace("]",""),productDetails.bcUiTypes=productDetails.bcUiTypes.split(", ")),t.layoutVsBCfieldDetails&&(productDetails.layoutVsBCfieldDetails=t.layoutVsBCfieldDetails),productDetails.fillCurrencyAndRoundOffDetail(l,i),"edit"==window[e].currentStatus||"clone"==window[e].currentStatus){var d=$("#productList");if($(".lnk_inv_whatsnew").parent().show(),Crm.userDetails.isLookupAdvancedSearchEnabledInLineItem){var c=t.productLineItems;c.fieldMeta=t.entityMapJson.PRODUCTDETAILS,productDetails.setValuesForAddedRowForEdit(c,void 0,void 0,void 0,r)}else productDetails.setValuesForAddedRowForEdit(t.productLineItems,void 0,void 0,void 0,r);productDetails.grandTaxChanged=!0,d.find(".pB20").show(),d.find(".pB20").find(".wrap").show(),$("#addLinesBtnLwr").hide(),loadClassFns1(),loadClassFns2(),loadClassFns3()}else{productDetails.grandTaxChanged=!1;var u=JSON.parse(t.newAllTaxes),p="",v="<div>";if(null!=u)for(var m=objectUtils.getKeys(u),f=m.length-1,h=0;h<=f;h++){var g=u[m[h]];productDetails.canEditTaxValue?v+='<div class="taxRow"> <p class="crm-small-font-size crm-font-bold crmBaseColor taxName"> '+g[0]+' </p> <div class="pT10 pB10 br_bottom_border4 mB10"><input type="text" size="5" class="newinputText1 decimalFld editTax alignRight" value="'+g[1]+'"> <b class="pL5">%</b> <input type="text" class="newinputText1 mL10 taxVal alignRight decimalFld" readonly="true" size="5" value="0"> <label class="pL5"> </label></div> </div>':v+='<div class="taxRow"> <p class="crm-small-font-size crm-font-bold crmBaseColor taxName"> '+g[0]+' </p> <div class="pT10 pB10 br_bottom_border4 mB10"><input type="text" size="5" class="newinputText1 decimalFld editTax alignRight" style="cursor: not-allowed;" readonly="true" value="'+g[1]+'"> <b class="pL5">%</b> <input type="text" class="newinputText1 mL10 taxVal alignRight decimalFld" readonly="true" size="5" value="0"> <label class="pL5"> </label></div> </div>',Crm.userDetails.TAX_MIGRATION_COMPLETED||(p+=g[0]+"===0:::0;;;")}v+="</div>",$("#grandTaxPop").append(v),$("#recordTaxDet").val(p)}(productDetails.fillCurrencySymbolsInLineHeaders(),productDetails.fillCurrSymForGrandVals(),"PurchaseOrders"!=e?$("#vendPrdsSpan").remove():($("#vendPrds").prop("checked",!1),"create"==window[e].currentStatus&&productDetails.fillBillingAddressForPO()),Crm.userDetails.isLookupAdvancedSearchEnabledInLineItem)&&(loadClassFns1(l,null!=i?i.relListId:void 0),loadClassFns2(l),loadClassFns3(void 0,l));moduleRecordMapping.PriceBooks&&moduleRecordMapping.PriceBooks.visible&&moduleRecordMapping.PriceBooks.viewable&&store.findRecord("module",moduleRecordMapping.Products.id,void 0,void 0,void 0,{getMeta:!0}).then((function(t){for(var e=t[0].related_lists,a=e.length,i=0;i<a;i++)if("Price_Books"===e[i].api_name&&!0===e[i].visible&&"default"===e[i].type){productDetails.hideListPrice=!1;break}}))},fillTaxDetails:function(t){t.allTaxes?productDetails.allTaxes=t.allTaxes:(productDetails.allTaxes=null,t.allTaxes=null),t.newAllTaxes?productDetails.newAllTaxes=t.newAllTaxes:(productDetails.newAllTaxes=null,t.newAllTaxes=null),t.sortedOrgTax&&(productDetails.sortedOrgTax=t.sortedOrgTax),t.taxIdVsName?productDetails.taxIdVsName=JSON.parse(t.taxIdVsName):productDetails.taxIdVsName={}},fillCurrencyAndRoundOffDetail:function(t,e){if(objectUtils.getKeys(Crm.userDetails.CURRENCY_DETAILS).length>0){var a=t?$("#Crm_"+productDetails.module+"_"+e.relListId+"_CURRENCYISOCODE").val():$("#Crm_"+productDetails.module+"_CURRENCYISOCODE").val();a||(a=Crm.userDetails.BASE_CURRENCY);var i=Crm.userDetails.CURRENCY_DETAILS[a];i&&(productDetails.currencySymbol=i.symbol,productDetails.roundOff=i.decimals)}else productDetails.currencySymbol=Crm.userDetails.defaultOrgCurrency,isNaN(Crm.userDetails.productRoundOff)||(productDetails.roundOff=Crm.userDetails.productRoundOff,productDetails.roundOff>5&&(productDetails.roundOff=5));productDetails.roundOffPrecision=Math.pow(10,productDetails.roundOff)},initSFLineItem:function(t,e,a,i){productDetails.isInited=!0,productDetails.module=e,productDetails.autoPopulateTax=t.autoPopulateTax,productDetails.canEditTaxValue=t.canEditTaxValue,productDetails.sestatus=t.sestatus;var r=productDetails.invModuleVsLineItemSfTabId[e],l=$("#totalProductCount"),s=$("#subform_"+r),n=s.closest(".secContent").get(0);for(key in s.length>0&&Crm.userDetails.TAX_MIGRATION_COMPLETED?productDetails.createDiscPopupSFLineItem(n):productDetails.createDiscountPop(n),productDetails.createTaxPopsSFLineItem(n),$(window).off("click").on("click",(function(){$("#discountPop").css({display:"none"}),$("#grandTaxPop").css({display:"none"}),$("#taxPop").css({display:"none"})})),productDetails.fillTaxDetails(t),productDetails.taxIdVsName){var o=productDetails.taxIdVsName[key];productDetails.taxNameVsId[o[1]]=key}productDetails.fillCurrencyAndRoundOffDetail(a,i);var d=t.RECORDTAXDET;if(d||"edit"===window[e].currentStatus||"clone"===window[e].currentStatus){if(productDetails.grandTaxChanged=!0,d=t.RECORDTAXDET,Crm.requestParam["property(recordTaxDet)"]=d,void 0!==d&&d.length>0){var c={},u=d.split(";;;");d="";for(var p=u.length-1,v=0;v<p;v++){var m=u[v],f=m.split("===")[0],h=productDetails.taxIdVsName[f];void 0!==h&&h.length>0&&(f=h[1]),f=f.trim();var g=m.split("===")[1],D=parseFloat(void 0===g?0:g.split(":::")[0]),T=parseFloat(void 0===g?0:g.split(":::")[1]);c[f]=f+"==="+D+":::"+T+";;;",d+=c[f]}$("#grandTaxValueMap").val(JSON.stringify(c))}}else{productDetails.grandTaxChanged=!1;c={},g=JSON.parse(productDetails.newAllTaxes);var x=productDetails.sortedOrgTax?productDetails.sortedOrgTax.length:0,I='<div class="selectTaxdiv mB2"><div class="crm-small-font-size crm-font-bold mB10">'+I18n.getMsg("crm.tax.select")+"</div>";for(v=0;v<x;v++){var P=g[f=productDetails.sortedOrgTax[v]];I+=productDetails.constructTaxPopSFLineItem(P[1],f,0,!0,!1,v+1)}$("#grandTaxValueMap").val(JSON.stringify(c)),I+="</div>",$("#grandTaxPop").append(I)}$("#recordTaxDet").val(d);var C="#Crm_"+e+"_"+(r=s.data("data-subformid"))+"_";productDetails.sfFldIdSuffix=C;for(var b=l.val(),y=1;y<=b;y++){var _=$(C+"PRODUCTID_"+y),S=_.length,O=_.closest("tr");productDetails.bindPBIconShowOrHideSFLineItem(O);var F=$(C+"BOOKID_"+y),N=F.closest("td"),E=N.find(".PriceBooks-small"),R=N.find(".clear_lookupfield");null!==S?E.css({display:"block"}):E.css({display:"none"}),R.css({display:"none"});var L=$(C+"LINETAX_"+y),w=$(C+"TOTAL_"+y),A=$(C+"TOTALAFTERDISCOUNT_"+y),k=$(C+"DISCOUNT_"+y);Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted||(F.length>0&&F.val().length>0?k.attr("discType","fromPb"):k.attr("discType","percent")),w.attr("temp-value",""===w.val()?0:w.val()),A.attr("temp-value",""===A.val()?0:A.val());var M=w.val();M=parseFloat(M&&M.length>0?M:0),M=isNaN(M)?0:M;var V=k.val();V=V&&V.length>0?V:0,V=isNaN(V)?0:V;var U=M/100;Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted||k.attr("percentage",0===U?0:V/U);var B=L.val();L.attr("old",void 0!==B&&B.length>0),L.val(productDetails.convertTaxIdToTaxDispName(B,y))}var z=a?$("#Crm_"+productDetails.module+"_"+i.relListId+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT"),Q=a?$("#Crm_"+productDetails.module+"_"+i.relListId+"_TAX"):$("#Crm_"+productDetails.module+"_TAX"),G=a?$("#Crm_"+productDetails.module+"_"+i.relListId+"_SUBTOTAL"):$("#Crm_"+productDetails.module+"_SUBTOTAL"),H=G.val()-(z.length>0?z.val():0);H=parseFloat(""===H?0:H);var X=""===Q.val()?0:Q.val();Q.attr("percentage",productDetails.getRoundOffValue(X/(H/100),!0));var Y=G.val();Y=parseFloat(""===Y?0:Y);var q=""===z.val()?0:z.val();U=Y/100;Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted||z.attr({percentage:productDetails.getRoundOffValue(0===U?0:q/U,!0),discType:"percent"}),"PurchaseOrders"===e&&"create"===window[e].currentStatus&&productDetails.fillBillingAddressForPO(),G.off("change").on("change",(function(){var t=$("#multipleFieldsEditPop").is(":visible");if(t)var e=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];var a=t?$("#Crm_"+productDetails.module+"_"+e+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT");if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted)var i=t?$("#Crm_"+productDetails.module+"_"+e+"_DISCOUNT_TYPE"):$("#Crm_"+productDetails.module+"_DISCOUNT_TYPE"),r=t?$("#Crm_"+productDetails.module+"_"+e+"_DISCOUNT_PERCENTAGE"):$("#Crm_"+productDetails.module+"_DISCOUNT_PERCENTAGE");var l=t?$("#Crm_"+productDetails.module+"_"+e+"_TAX"):$("#Crm_"+productDetails.module+"_TAX"),s=$(this),n=parseFloat(""===l.val()?0:l.val()),o=parseFloat(""===s.val()?0:s.val()),d=parseFloat(a.length<1||""===a.val()?0:a.val());if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted){var c=r.val();c=parseFloat(void 0===c||0===c.length||isNaN(c)?0:c),c=productDetails.getRoundOffValue(c,!0,r.data("decimalLength"))}else{c=a.attr("percentage");c=parseFloat(void 0===c||0===c.length||isNaN(c)?0:c),c=productDetails.getRoundOffValue(c,!0)}var u=l.attr("percentage");u=parseFloat(void 0===u||0===u.length||isNaN(u)?0:u),u=productDetails.getRoundOffValue(u,!0);var p=s.attr("temp-value");parseFloat(void 0===p||0===p.length||isNaN(p)?0:p)!==o&&(d=Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted?"Direct Price"!==productDetails.getDiscountTypeSystemValueForUserValue(i)?c*o/100:d:"dirPrice"!==a.attr("discType")?c*o/100:d,(n||0===n)&&(n=u*(o-d)/100)),a.val(parseFloat(productDetails.getRoundOff(a,d)).toString()).trigger("change"),s.attr("temp-value",o),l.val(parseFloat(productDetails.getRoundOff(l,n)).toString()).trigger("change")}))},getDiscountTypeSystemValueForUserValue:function(t){var e,a=$(t);if(0===a.length)return e;for(var i=a.data("params")?a.data("params").picklistmap:a.data("picklistmap"),r=a.data("params")?a.data("params").defaultvalue:a.val(),l=i.length,s=0;s<l;s++){var n=i[s];if(n.uservalue===r){e=n.systemvalue;break}}return e},getDiscountTypeUserValueForSystemValue:function(t,e){for(var a,i=$(t),r=i.data("params")?i.data("params").picklistmap:i.data("picklistmap"),l=r.length,s=0;s<l;s++){var n=r[s];if(n.systemvalue===e){a=n.uservalue;break}}return a},getRoundOff:function(t,e){var a=t.data("colname"),i=t.data("subformdisplaylabel");if(Crm.userDetails.lineItemFormulaCalcFlow&&objectUtils.getKeys(Crm.userDetails.lineItemFormulaCalcFlow).length>0&&(!i&&Crm.userDetails.lineItemFormulaCalcFlow[productDetails.module].aggrFields[a]||i&&Crm.userDetails.lineItemFormulaCalcFlow[productDetails.module][a]))return productDetails.getRoundOffValue(e,!0);var r=t.data("uitype"),l=t.data("decimalLength");l=void 0===l?0:l;var s=Math.pow(10,l);if(e&&e.toString().indexOf("e")>-1||e.toString().indexOf("E")>-1)e=Number(Math.round(e,s));else switch(r){case 36:case 143:case 144:case 145:e=Number(productDetails.getRoundOffValue(e,!0,l))}return void 0===e?0:parseFloat(currencyUtils.getWholeOrDecimalValue(e,l))},bindPBIconShowOrHideSFLineItem:function(t){t.off("mouseover").on("mouseover",(function(){productDetails.priceBookIconHideOrShowSFLineItem($(this),!1)})),t.off("mouseout").on("mouseout",(function(){productDetails.priceBookIconHideOrShowSFLineItem($(this),!0)}))},priceBookIconHideOrShowSFLineItem:function(t,e){var a=t.data("data-rowid"),i=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+a),r=i.length>0?i.val().length:0,l=$(productDetails.sfFldIdSuffix+"LISTPRICE_"+a);if(!l.attr("readonly")){var s=l.closest("td"),n=s.find(".PriceBooks-small.lookup_hIconO");r>0&&!e?n.removeClass("hide"):n.addClass("hide"),s.find(".clear_lookupfield.lookup_hIconO").css({display:"none"})}},convertTaxIdToTaxDispName:function(t,e){var a=$(productDetails.sfFldIdSuffix+"TAX_"+e),i=$(productDetails.sfFldIdSuffix+"TOTAL_"+e),r=$(productDetails.sfFldIdSuffix+"TOTALAFTERDISCOUNT_"+e),l=r.val();l=isNaN(l)||0==l.length?0:parseFloat(l);var s=a.val();if(s=isNaN(s)?0:parseFloat(s),"clone"===window[productDetails.module].currentStatus){s=0;var n=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+e),o=n.length>0?n.attr("prdDetails"):"";o=void 0!==o&&o.length>0?JSON.parse(o):"";var d=productDetails.getTaxVsIdSFLineItem(o.Tax),c=d.length,u=(t=t||"").split(";;;");t="";for(var p=u.length,v=0;v<p;v++){var m=u[v];if(""!==m){var f=m.split("===")[0].trim(),h=productDetails.taxIdVsName[f];if(void 0!==h&&h.length>0&&(f=h[1]),0==c||c>0&&d.indexOf(f)<0)continue;var g=m.split("===")[1],D=parseFloat(void 0===g?0:g.split(":::")[0]),T=l*D/100;s+=T,t=t+f+"==="+D+":::"+T+";;;"}}}var x=r.length>0?r.val():i.val();return x=parseFloat(""===x?0:x),a.val(parseFloat(productDetails.getRoundOff(a,s).toString())),a.attr("percentage",s/(x/100)),t},getTaxVsIdSFLineItem:function(t){if(void 0!==t&&t.length>0)for(var e=(t=t.split(";")).length,a=0;a<e;a++){var i=productDetails.taxIdVsName[t[a]];void 0!==i&&i.length>0&&(t[a]=i[1])}else t="";return t},showGrandTaxNewSFLineItemPop:function(t){var e=$("#grandTaxPop"),a=$("#taxPop"),i=$("#multipleFieldsEditPop"),r=i.is(":visible");if(r)var l=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];if(e.hide(),a.hide(),productDetails.isInited){var s,n,o,d=$(t),c=d.closest("tr"),u=c.data("data-rowid"),p=d.closest("table").hasClass("aggFldTabl"),v=p?e:a;p?(s=r?$("#Crm_"+productDetails.module+"_"+l+"_SUBTOTAL"):$("#Crm_"+productDetails.module+"_SUBTOTAL"),o=r?$("#Crm_"+productDetails.module+"_"+l+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT"),n=r?$("#Crm_"+productDetails.module+"_"+l+"_TAX"):$("#Crm_"+productDetails.module+"_TAX")):(s=$(productDetails.sfFldIdSuffix+"TOTALAFTERDISCOUNT_"+u),o=$(productDetails.sfFldIdSuffix+"DISCOUNT_"+u),n=$(productDetails.sfFldIdSuffix+"TAX_"+u));var m,f,h=d.position(),g=d.offset(),D=d.innerHeight(),T=v.innerWidth(),x=r?h.left:g.left,I=r?h.top:g.top,P=parseFloat(s.val());if(P=isNaN(P)?0:P,r){var C=$(".subFrmTablWrapper"),b=C.scrollLeft(),y=$L("#multipleFieldsEditPop .pp-content").scrollTop(),_=i.offset().left,S=d.closest(".labelValCreate");if(p)m=S.offset().left,f=S.offset().top+y;else{m=S.offset().left-b;var O=v[0].id;"taxPop"===O?(m=S.position().left+C.position().left,f=S.position().top+C.position().top+y):f=S.position().top}var F,N,E=S.closest(".labelValCreate"),R=E.outerHeight(),L=E.outerWidth(),w=i.offset().left,A=i.outerWidth()}if(""===o.val()&&o.val(0),p){var k=n.val();productDetails.grandTaxChanged=""!==k&&null!==k}var M=o.length>0?o.val():0;M=isNaN(M)||0===M.length?0:parseFloat(M);var V=p?P-M:P,U=Crm.userDetails.TAX_MIGRATION_COMPLETED?'<div class="selectTaxdiv mB2"><div class="crm-small-font-size crm-font-bold mB10">'+I18n.getMsg("crm.tax.select")+"</div>":"<div>",B=$(productDetails.sfFldIdSuffix+"LINETAX_"+u),z=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+u),Q=z.length>0?z.attr("prdDetails"):"";Q=void 0!==Q&&Q.length>0?JSON.parse(Q):"";var G=p?[]:productDetails.getTaxVsIdSFLineItem(Q.Tax),H=!0,X=p?$("#recordTaxDet").val():B.val();if(productDetails.addLoggerForTaxIssue(X.toString(),"Action triggered when tax icon is clicked"),(0===parseInt(X)||""===X||"create"===window[productDetails.module].currentStatus&&!productDetails.grandTaxChanged)&&p){var Y=productDetails.sortedOrgTax?productDetails.sortedOrgTax.length:0;X=JSON.parse(productDetails.newAllTaxes);for(var q=0;q<Y;q++){var J=productDetails.sortedOrgTax[q];void 0!==(ot=productDetails.taxIdVsName[J])&&ot.length>0&&(J=ot[1]);var j=V*(dt=X[J])[1]/100;U+=productDetails.constructTaxPopSFLineItem(dt[1],J,j,p,!1,q+1)}}else{var W=0,K=n,Z=(H=!!p||0!==z.val().length&&Q.Taxable,X.split(";;;")),tt=Z.length-1,et=[];for(q=0;q<tt;q++){var at=Z[q];J=at.split("===")[0].trim();void 0!==(ot=productDetails.taxIdVsName[J])&&ot.length>0&&(J=ot[1]),et[q]=J;X=at.split("===")[1];var it=V*(dt=parseFloat(void 0===X?0:X.split(":::")[0]))/100;it=productDetails.getRoundOff(K,it),U+=productDetails.constructTaxPopSFLineItem(dt,J,it,p,!0,++W),G.indexOf(J)>-1&&G.splice(G.indexOf(J),1)}if(H){var rt=1===G.length&&""===G[0]?0:H?G.length:0,lt=JSON.parse(productDetails.newAllTaxes);if(Crm.userDetails.TAX_MIGRATION_COMPLETED)if(p){var st=objectUtils.getKeys(lt),nt=st.length-1;for(q=0;q<=nt;q++){J=st[q].trim();void 0!==(ot=productDetails.taxIdVsName[J])&&ot.length>0&&(J=ot[1]);j=V*(dt=void 0!==lt[J]?lt[J]:[J,JSON.parse(productDetails.allTaxes)[J]])[1]/100;p&&et.toString().indexOf(J)<=-1&&(U+=productDetails.constructTaxPopSFLineItem(dt[1],J,productDetails.getRoundOff(K,j),p,!1,++W))}}else{for(q=0;q<rt;q++){J=G[q].trim();void 0!==(ot=productDetails.taxIdVsName[J])&&ot.length>0&&(J=ot[1]);j=V*(dt=void 0!==lt[J]?lt[J]:[J,JSON.parse(productDetails.allTaxes)[J]])[1]/100;G.indexOf(J)>-1&&et.toString().indexOf(J)<=-1&&(U+=productDetails.constructTaxPopSFLineItem(dt[1],J,productDetails.getRoundOff(K,j),p,!1,++W))}0===rt&&tt<=0&&(H=!1,U=Crm.userDetails.TAX_MIGRATION_COMPLETED?"<div><span>"+I18n.getMsg("crm.tax.association.check")+"</span>":"<span>"+I18n.getMsg("crm.tax.association.check")+"</span>")}else{for(q=0;q<rt;q++){var ot;J=G[q].trim();void 0!==(ot=productDetails.taxIdVsName[J])&&ot.length>0&&(J=ot[1]);var dt;j=V*(dt=lt[J])[1]/100;U+=productDetails.constructTaxPopSFLineItem(dt[1],J,productDetails.getRoundOff(K,j),p,!1,q+1)}0===rt&&tt<=0&&(H=!1,U=Crm.userDetails.TAX_MIGRATION_COMPLETED?"<div><span>"+I18n.getMsg("crm.tax.association.check")+"</span>":"<span>"+I18n.getMsg("crm.tax.association.check")+"</span>")}}else if(tt<1){H=!1,U=(""==Q.Tax.split(";;;")?0:Q.Tax.split(";;;").length)>=1?Crm.userDetails.TAX_MIGRATION_COMPLETED?"<div><span>"+I18n.getMsg("crm.tax.selected.check")+"</span>":"<span>"+I18n.getMsg("crm.tax.selected.check")+"</span>":Crm.userDetails.TAX_MIGRATION_COMPLETED?"<div><span>"+I18n.getMsg("crm.tax.association.check")+"</span>":"<span>"+I18n.getMsg("crm.tax.association.check")+"</span>"}else H=!0}var ct=p?"saveGrandTaxBtn":"saveRowTaxBtn";Crm.userDetails.TAX_MIGRATION_COMPLETED?U+=H?'<div class="grandTaxButtons"><input type="button" data-zcqa="tax_save" id="'+ct+'" class="primarybtn btn_sml" value="'+I18n.getMsg("crm.button.done")+'"><input data-zcqa="tax_cancel" class="newgraybtn btn_sml" type="button" onclick="productDetails.cancelGrandTaxSFLineItem('+p+')" value="'+I18n.getMsg("crm.button.cancel")+'"/></div></div>':"</div>":U+=p?'<input type="button"  id="'+ct+'" class="primarybtn btn_sml" value="'+I18n.getMsg("crm.button.done")+'"></div>':"</div>",v.children().remove(),v.append(U),$(p?"#grandTaxRnd.grandTaxRnd":"#lineTaxRnd.lineTaxRnd").off("click").on("click",(function(){var t=c;productDetails.addOrRemoveTaxSFLineItem($(this),p?"grand":"inline",t)}));var ut=Crm.userDetails.TAX_MIGRATION_COMPLETED?v.find(".grandTaxButtons"):v.find(".primarybtn");if(p||Crm.userDetails.TAX_MIGRATION_COMPLETED?(ut.css({display:"block"}),$("#"+ct).off("click").on("click",(function(){for(var t=c,e=p?$("#grandTaxPop .editTax"):$("#taxPop .editTax"),a=p?".grandTaxRnd":".lineTaxRnd",i=e.length,r=!1,l=0;l<i;l++){var s=e.eq(l),n=s.closest(".taxRow").find(a).get(0),o=s.val(),d=p?$("#grandTaxValError"+(l+1)):$("#inlineTaxValError"+(l+1));d.addClass("dN"),n.checked&&(isNaN(o)||!o||o>100)&&(d.removeClass("dN"),r=!0)}if(r)return!1;if(p){productDetails.grandTaxChanged=!0;var u=$("#grandTaxValueMap").val(),v=JSON.parse(u.length>0?u:"{}"),m="";for(var l in v)m+=v[l];$("#recordTaxDet").val(m),Crm.requestParam["property(recordTaxDet)"]=m,productDetails.calculateGrandTotalSFLineItem(this,t),$("#grandTaxPop").css({display:"none"}),productDetails.addLoggerForTaxIssue(m,"Action triggered when save button is clicked")}else{var f=t.data("data-rowid"),h=$(productDetails.sfFldIdSuffix+"LINETAX_"+f),g=$(productDetails.sfFldIdSuffix+"TAX_"+f),D=$(this).closest(".grandTaxButtons").attr("tax-expr");void 0!==D&&h.val(0===D.length?"":D),h.attr("old",!1),void 0!==D&&0===D.length&&g.val("0").trigger("change");var T=$("#taxPop");T.find(".editTax").each((function(e,a){var i=t;Crm.userDetails.TAX_MIGRATION_COMPLETED&&$(a).closest(".taxRow").find(".lineTaxRnd")[0].checked?ft($(a),i):Crm.userDetails.TAX_MIGRATION_COMPLETED||ft($(a),i)})),T.css({display:"none"})}}))):Crm.userDetails.TAX_MIGRATION_COMPLETED||ut.css({display:"none"}),$("#discountPop").hide(),v.removeClass("hide"),productDetails.canEditTaxValue||(v.find(".newinputText1.editTax").each((function(t,e){$(e).css({cursor:"not-allowed"}).attr("readonly","true")})),productDetails.bindMouseOverActionForRestrictTaxEdit()),r)F=v.outerWidth(),N=v.height(),A-(S.offset().left-w)>F+20?v.css({left:m,top:f+N+R-15}).show():v.css({left:m+L/2-F,top:f+N+R-15}).show(),p?Crm.userDetails.RTL_ENABLED?v.css({left:m-_,top:f-(R+30)}).show():v.css({left:m-(_+F/2),top:f-(R+25)}).show():"taxPop"===O&&(Crm.userDetails.RTL_ENABLED?v.css({left:m,top:f+N+R-15}).show():v.css({left:m-(F/2+L/2),top:f+N+R-15}).show());else{var pt,vt=x+T/2;pt=renderingUtils.windowWidth<vt?x-T:x-T/2,v.css({left:pt,top:I+D+10}).show();var mt=document.querySelector("html, body");crmui.animateScrollTop(mt,I-115,200)}function ft(t,e){var a=t.val(),i=e.data("data-rowid"),r=$(productDetails.sfFldIdSuffix+"TAX_"+i);r.attr("percentage",a),(isNaN(a)||""===a)&&(a=0);var l=s.val();l=isNaN(l)?0:l;var n=M;n=isNaN(n)?0:n;var o=parseFloat(l)-parseFloat(n),d=o*a/100,c=t.closest(".taxRow").find(".taxName").text().trim();if(c=Crm.userDetails.TAX_MIGRATION_COMPLETED?productDetails.getTaxDisplayName(c,a):c,d=isNaN(d)?0:d,d=productDetails.getRoundOff(r,d),p){var u=$("#grandTaxValueMap"),v=objectUtils.getKeys(JSON.parse(productDetails.newAllTaxes)),m=""===u.val()?{}:JSON.parse(u.val());if(Crm.userDetails.TAX_MIGRATION_COMPLETED){var f=[];t.closest("table").find(".taxName").each((function(t,e){if($(e.parentNode).find("#grandTaxRnd")[0].checked){var a=e.parentNode.getElementsByClassName("editTax")[0].value;f.push(productDetails.getTaxDisplayName(e.innerText,a))}})),Object.keys(f).forEach((function(t){m[t]=t===c?t+"==="+a+":::"+d+";;;":m[t]}))}else m[c]=c+"==="+a+":::"+d+";;;";v.forEach((function(t){Object.keys(m).indexOf(t)<=-1&&(m[t]=t+"===0:::0;;;")})),u.val(JSON.stringify(m))}else{var h=$(productDetails.sfFldIdSuffix+"LINETAX_"+i),g=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+i),D=JSON.parse(g.attr("prdDetails")),T=g.length>0?productDetails.getTaxVsIdSFLineItem(D.Tax):"",x=T.length-1,I=h.val();if(productDetails.grandTaxChanged=!0,""===I)h.val(c+"==="+a+":::"+d+";;;"),r.val(parseFloat(d).toString()).trigger("change");else{var P=I.split(";;;"),C=P.length-1,b=0,y="",_=!1;if(Crm.userDetails.TAX_MIGRATION_COMPLETED)for(S=0;S<C;S++){N=(O=P[S]).split("===")[0].trim(),E=O.split("===")[1];void 0!==(F=productDetails.taxIdVsName[N])&&F.length>0&&(N=F[1]);L=o*(R=parseFloat(E.split(":::")[0]))/100;b=parseFloat(b)+parseFloat(L),y=y+N+"==="+R+":::"+L+";;;"}else{for(var S=0;S<C;S++){var O,F,N=(O=P[S]).split("===")[0].trim(),E=O.split("===")[1];void 0!==(F=productDetails.taxIdVsName[N])&&F.length>0&&(N=F[1]);var R=parseFloat(E.split(":::")[0]),L=parseFloat(E.split(":::")[1]);c===N&&(_=!0,R=a,L=d),b=parseFloat(b)+parseFloat(L),y=y+N+"==="+R+":::"+L+";;;"}_||(y=y+c+"==="+a+":::"+d+";;;",b=parseFloat(b)+parseFloat(d));for(var S=0;S<x;S++)y.indexOf(T[S])<=-1&&(y=y+T[S]+"===0:::0;;;")}r.val(parseFloat(productDetails.getRoundOff(r,b)).toString()).trigger("change"),h.val(y)}s.trigger("change"),productDetails.calculateGrandTotalSFLineItem(this,e)}}$(".editTax").off("keyup").on("keyup",(function(){var t=$(this),e=c,a=e.data("data-rowid"),i=t.parent(),r=t.val(),l=$(productDetails.sfFldIdSuffix+"TAX_"+a),n=e.closest("table").hasClass("aggFldTabl");l.attr("percentage",r),(isNaN(r)||""===r)&&(r=0);var o=s.val();o=isNaN(o)?0:o;var d=M;d=isNaN(d)?0:d;var u=(parseFloat(o)-parseFloat(d))*r/100,v=i.closest(".taxRow"),m=Crm.userDetails.TAX_MIGRATION_COMPLETED?v.find(".taxVal"):i.find(".taxVal");u=productDetails.getRoundOff(l,u);var f=n?".grandTaxRnd":".lineTaxRnd",h=v.find(f).get(0);Crm.userDetails.TAX_MIGRATION_COMPLETED&&h.checked?$(m).text(u):$(m).val(u),Crm.userDetails.TAX_MIGRATION_COMPLETED?Crm.userDetails.TAX_MIGRATION_COMPLETED&&productDetails.canEditTaxValue&&productDetails.addOrRemoveTaxSFLineItem($(h),p?"grand":"inline",e):ft(t,e)}))}},getTaxDisplayNameSFLineItem:function(t){return t.indexOf("-")>-1&&t.indexOf("%")>-1?t.substr(0,t.indexOf("-")).trim():t},checkMaxLengthSFLineItem:function(t,e,a,i){if(8!==t.which&&(t.which<37||t.which>40)){var r,l,s=$("#multipleFieldsEditPop").is(":visible");if(s)var n=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];if($(e).hasClass("editTax"))r=5,l=5;else{var o=i?s?$("#Crm_"+productDetails.module+"_"+n+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT"):$(productDetails.sfFldIdSuffix+"DISCOUNT_1")[0];r=a?i?o.data("maxLength"):o.dataset.maxlength:5,l=a?i?o.data("decimalLength"):o.dataset.decimalLength:5}var d=$(e).val().trim(),c=d.indexOf(".")>-1;if(d&&d.length>=r)t.preventDefault();else if(c){l<=d.split(".")[1].length&&t.preventDefault()}d.indexOf("-")>1&&t.preventDefault()}},checkAlphabatePresence:function(t,e){var a=$(e).val().trim().indexOf(".")>-1;return!(/^[0-9\.\-]+$/.test(t.key)&&("."!==t.key||!a))&&(t.preventDefault(),!0)},validateQtyFld:function(t){var e=$(t),a=e.val(),i=e.closest("div"),r=I18n.getMsg("crm.field.valid.check",[$ESAPI.encoder().encodeForHTML(e.data("displaylabel"))]),l=i.find(".errorMsgDesc");l.text()===r&&l.remove(),a&&isNaN(a)&&commonUtils.showErrorMsg(I18n.getMsg("crm.field.valid.check",[$ESAPI.encoder().encodeForHTML(e.data("displaylabel"))]),e,productDetails.module)},addOrRemoveTaxSFLineItem:function(t,e,a){var i,r=a.data("data-rowid"),l=t.attr("btn-num"),s=t.closest(".taxRow"),n=t.closest(".newpopup"),o=s.find(".editTax"),d=s.find(".taxVal"),c=s.find(".taxPercentage_box"),u=n.find(".grandTaxButtons").eq(0),p=parseFloat(o.val().trim()),v="",m=$("#multipleFieldsEditPop").is(":visible"),f=$(t).is(":checked");f?t.checked=!0:(("inline"===e?$("#inlineTaxValError"+l):$("#grandTaxValError"+l)).addClass("dN"),o.addClass("taxPercentage_box_bg"),c.addClass("taxPercentage_box_bg"));if(productDetails.canEditTaxValue&&(f?(o.removeAttr("readonly"),o.removeClass("taxPercentage_box_bg"),c.removeClass("taxPercentage_box_bg")):o.attr("readonly",!0)),(isNaN(p)||""===p)&&(p=0),"inline"===e){var h=$(productDetails.sfFldIdSuffix+"TOTALAFTERDISCOUNT_"+r),g=h&&h.val()?h.val():0,D=$(productDetails.sfFldIdSuffix+"TAX_"+r);f?(i=g*p/100,i=productDetails.getRoundOff(D,i)):i="-";v="";n.find(".taxRow").each((function(t,a){var i=g;i=isNaN(i)?0:i;var r=parseFloat(a.getElementsByClassName("editTax")[0].value);r=isNaN(r)?0:r;var l=productDetails.getRoundOff(D,parseFloat(i*r/100)),s=$(a).find("inline"===e?".lineTaxRnd":".grandTaxRnd")[0],n=s.value;s.checked&&(v=v+n+"==="+r+":::"+l+";;;")})),u.attr("tax-expr",v)}else{if(m)var T=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];var x=m?$("#Crm_"+productDetails.module+"_"+T+"_SUBTOTAL").val():$("#Crm_"+productDetails.module+"_SUBTOTAL").val();D=m?$("#Crm_"+productDetails.module+"_"+T+"_TAX"):$("#Crm_"+productDetails.module+"_TAX");x=void 0===x||x.length<1?0:x;var I=m?$("#Crm_"+productDetails.module+"_"+T+"_DISCOUNT").val():$("#Crm_"+productDetails.module+"_DISCOUNT").val();I=void 0===I?0:I;var P=parseFloat(x)-parseFloat(I);f?(i=P*p/100,i=productDetails.getRoundOff(D,i)):i="-";var C=$("#grandTaxValueMap"),b={};n.find(".taxRow").each((function(t,a){P=isNaN(P)?0:P;var i=parseFloat(a.getElementsByClassName("editTax")[0].value);i=isNaN(i)?0:i;var r=productDetails.getRoundOff(D,parseFloat(P*i/100)),l=$(a).find("inline"===e?".lineTaxRnd":".grandTaxRnd")[0],s=l.value;l.checked&&(b[s]=s+"==="+i+":::"+r+";;;")})),C.val(JSON.stringify(b)),productDetails.addLoggerForTaxIssue(C.val(),"Action triggered when checkbox is clicked")}d.text(i)},taxCalcTriggerSFLineItem:function(t){var e=t.data("data-rowid"),a=$(productDetails.sfFldIdSuffix+"LINETAX_"+e),i=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+e),r=i.length>0?i.attr("prdDetails"):"";r=void 0!==r&&r.length>0?JSON.parse(r):"";var l=productDetails.getTaxVsIdSFLineItem(r.Tax).length,s=$(productDetails.sfFldIdSuffix+"TOTALAFTERDISCOUNT_"+e),n=s.length>0?parseFloat(s.val()):0;n=isNaN(n)?0:n;var o=$(productDetails.sfFldIdSuffix+"TAX_"+e);if(l>0&&(r.Taxable&&(productDetails.autoPopulateTax&&o.length>0||o.length>0))){for(var d="",c=a.val().split(";;;"),u=c.length-1,p=0,v=0;v<=u&&0!==u;v++)if(c[v].length>0){var m=c[v].split("===")[0].trim(),f=c[v].split("===")[1],h=productDetails.taxIdVsName[m];void 0!==h&&h.length>0&&(m=h[1]);var g=f.split(":::")[0],D=n*g/100;d=d+m+"==="+g+":::"+D+";;;",p+=D}a.val(d),o.val(parseFloat(productDetails.getRoundOff(o,p)).toString()).trigger("change")}},showGrandDiscNewSFLineItemPop:function(t){Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted&&productDetails.constructDiscountPopup(t);var e=$("#discountPop"),a=$("#multipleFieldsEditPop"),i=$(t),r=a.is(":visible"),l=i.offset().left,s=i.offset().top,n=i.innerHeight(),o=i.closest("tr").data("data-rowid");if(event.stopPropagation(),r)var d=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];var c=$(t).closest("table").hasClass("aggFldTabl"),u=c?r?$("#Crm_"+productDetails.module+"_"+d+"_SUBTOTAL"):$("#Crm_"+productDetails.module+"_SUBTOTAL"):$(productDetails.sfFldIdSuffix+"TOTAL_"+o),p=c?r?$("#Crm_"+productDetails.module+"_"+d+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT"):$(productDetails.sfFldIdSuffix+"DISCOUNT_"+o);if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted)var v=o?$(productDetails.sfFldIdSuffix+"DISCOUNT_TYPE_"+o):r?$("#Crm_"+productDetails.module+"_"+d+"_DISCOUNT_TYPE"):$("#Crm_"+productDetails.module+"_DISCOUNT_TYPE"),m=o?$(productDetails.sfFldIdSuffix+"DISCOUNT_PERCENTAGE_"+o):r?$("#Crm_"+productDetails.module+"_"+d+"_DISCOUNT_PERCENTAGE"):$("#Crm_"+productDetails.module+"_DISCOUNT_PERCENTAGE");var f=$(t).parent().find("input").val();if(r){var h=$(".subFrmTablWrapper"),g=$L("#multipleFieldsEditPop .pp-content").scrollTop(),D=a.offset().left,T=i.closest(".labelValCreate"),x=T.closest(".aggFldTabl").length>0;x?(l=T.offset().left,s=T.offset().top+g):(s=T.position().top,l=T.position().left+h.position().left);var I,P,C=T.closest(".labelValCreate"),b=C.outerHeight(),y=C.outerWidth(),_=a.offset().left,S=a.outerWidth()}f=parseFloat(""===f||isNaN(f)?0:f);var O=0;O=u.val(),O=parseFloat(""===O||isNaN(O)?0:O);var F=Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted?parseFloat(m.val()):parseFloat(p.attr("percentage"));if(isNaN(F)||0!==O&&0===F){if(F=f/O*100+"",Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted){var N=F.substring(F.indexOf(".")+1,F.length).length,E=F.length-5;F=N-E>=0?productDetails.getRoundOffValue(F,!0,N-E):productDetails.getRoundOffValue(F,!0,3)}else F=productDetails.getRoundOffValue(F,!0,3),F=isNaN(F)?0:F;F=parseFloat(F),F=isNaN(F)?0:F}var R=e.find(".discPc"),L=e.innerWidth();if(R.val(F.toString()),void 0!==u&&0===u.length&&void 0!==R&&R.length>0){var w=e.find(".br_bottom_border4.p15");w.length>0&&w[0].remove()}var A=e.find(".directPrice");function k(t){$("#dirPcErr").addClass("dN"),$("#discPercErr").addClass("dN");var e=t.closest(".noEventDiv"),a=$("#multipleFieldsEditPop").is(":visible"),i=e.find(".decimalFld"),r=i.parent();if(0==r.find(".resultValue").length){var l=$('<span class="resultValue hide"></span>');l.attr("data-valueRes",""),r.append(l)}"percent"===t.attr("id")?i.attr({"data-decimal-length":"5",maxlength:"5"}):"dirPrice"===t.attr("id")&&i.attr({"data-decimal-length":p.attr("data-decimal-length"),maxlength:p.attr("data-maxlength")}),i.off("keypress keyup blur").on("keypress keyup blur",(function(t){crmTemplate.calculatorOperation(this,t,!0)})),e.parent().parent().find(".decimalFld").parent().css("visibility","hidden"),r.css("visibility","visible"),a||i.select()}A.val(f.toString()),$("#dirPcErr").addClass("dN"),$("#discPercErr").addClass("dN"),$("#taxesPop").find("div").hide(),Crm.userDetails.TAX_MIGRATION_COMPLETED?($("#saveDiscountType").off("click").on("click",(function(){var t=null,e=$("#multipleFieldsEditPop").is(":visible"),a=i;if(e){t=$("#multipleFieldsEditPop #duringTabDivs div.current");var l=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0]}var s=e?t.find("#discountPop"):$("#discountPop"),n=$("#inventrydiscountPop:checked").val(),o=document.getElementById("discountPop"),d=o.getElementsByClassName("discPc")[0].value,c=o.getElementsByClassName("directPrice")[0].value,u=a.closest("tr").data("data-rowid");if("fromPb"!==n&&u){var p=$(productDetails.sfFldIdSuffix+"BOOKID_"+u);p.val(""),p.removeAttr("pricingDetails")}var v=u?$(productDetails.sfFldIdSuffix+"DISCOUNT_"+u):r?$("#Crm_"+productDetails.module+"_"+l+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT");if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted){var m=u?$(productDetails.sfFldIdSuffix+"DISCOUNT_TYPE_"+u):r?$("#Crm_"+productDetails.module+"_"+l+"_DISCOUNT_TYPE"):$("#Crm_"+productDetails.module+"_DISCOUNT_TYPE"),f=u?$(productDetails.sfFldIdSuffix+"DISCOUNT_PERCENTAGE_"+u):r?$("#Crm_"+productDetails.module+"_"+l+"_DISCOUNT_PERCENTAGE"):$("#Crm_"+productDetails.module+"_DISCOUNT_PERCENTAGE");populatePicklist(m,"",!0)}else v.attr({percentage:d,discType:n});if("percent"===n){if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted){if(!function(t,e){var a=$("#discPercErr"),i=(e+="").substring(e.indexOf(".")+1,e.length).length,r=5,l=3,s=t.data("oldValue");if(("edit"===window[productDetails.module].currentStatus||"clone"===window[productDetails.module].currentStatus)&&""!==s&&parseFloat(s)>0&&(r<(s+="").length&&(r=s.length),s.indexOf(".")>-1)){var n=s.substring(s.indexOf(".")+1,s.length).length;l<n&&(l=n)}if(isNaN(e)||!e)return a.text(I18n.getMsg("crm.subform.lineitem.discount.percentage.validation.error",[$ESAPI.encoder().encodeForHTML(t.data("displaylabel"))])),!1;return e.length>r?(a.text(I18n.getMsg(Crm.getErrorKey(productDetails.module,t.data("displaylabel"),"maxLen"),[$ESAPI.encoder().encodeForHTML(t.data("displaylabel")),t.data("decimalLength")])),!1):!(i>l)||(a.text(I18n.getMsg(Crm.getErrorKey(productDetails.module,t.data("displaylabel"),"type","decimal"),[$ESAPI.encoder().encodeForHTML(t.data("displaylabel")),t.data("decimalLength")])),!1)}(f,d))return $("#discPercErr").removeClass("dN"),!1;f.val(d),m.val(productDetails.getDiscountTypeUserValueForSystemValue(m,"Percentage")).trigger("change")}productDetails.calcGrandDiscSFLineItem($(s.find(".discPc")),a)}else if("dirPrice"===n){if(isNaN(c)||!c)return $("#dirPcErr").removeClass("dN"),!1;Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted&&(f.val("0"),m.val(productDetails.getDiscountTypeUserValueForSystemValue(m,"Direct Price")).trigger("change")),productDetails.calcGrandDiscSFLineItem($(s.find(".directPrice")),a)}s.hide()})),$("#cancelDiscountType").off("click").on("click",(function(){$("#discountPop").hide()}))):(R.off("keyup"),R.keyup((function(){var t=i,e=t.closest("tr").data("data-rowid");$(productDetails.sfFldIdSuffix+"BOOKID_"+e).val(""),$(productDetails.sfFldIdSuffix+"DISCOUNT_"+e).attr({percentage:$(this).val(),discType:"percent"}),productDetails.calcGrandDiscSFLineItem(this,t)})),A.off("keyup"),A.keyup((function(){var t=i,e=t.closest("tr").data("data-rowid");$(productDetails.sfFldIdSuffix+"BOOKID_"+e).val(""),productDetails.calcGrandDiscSFLineItem(this,t),$(productDetails.sfFldIdSuffix+"DISCOUNT+"+e).attr({percentage:$("#discountPop").find(".discPc").val(),discType:"dirPrice"})}))),$(".discType").off("click").on("click",(function(){k($(this))})),$(".noEventDiv").off("click").on("click",(function(){var t=$(this);t.hasClass("roundCheck")?t.prop("checked",!0):t.find(".roundCheck").prop("checked",!0),k(t)}));var M=$("#frmBook"),V=$(productDetails.sfFldIdSuffix+"BOOKID_"+o),U=V.length>0?V.val().length:0,B=u.length>0,z=$("#percent");B?z.closest("div").removeClass("hide"):z.closest("div").addClass("hide");var Q=Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted?"Price Book"===productDetails.getDiscountTypeSystemValueForUserValue(v):"fromPb"===p.attr("discType"),G=Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted?"Direct Price"===productDetails.getDiscountTypeSystemValueForUserValue(v):"dirPrice"===p.attr("discType");if(U>0&&Q?(M.parent().show(),M.find(".roundCheck").trigger("click")):G||!B?(M.parent().hide(),$("#dirPrice").find(".roundCheck").trigger("click")):(M.parent().hide(),z.find(".roundCheck").trigger("click")),r)I=e.outerWidth(),P=e.height(),S-(T.offset().left-_)>I+20?e.css({left:l,top:s+P+b-15}).show():e.css({left:l+y/2-I,top:s+P+b-15}).show(),x&&(Crm.userDetails.RTL_ENABLED?e.css({left:l-D,top:s-(b+30)}).show():e.css({left:l-(D+I/2),top:s-(b+25)}).show());else{var H,X=l+L/2;H=renderingUtils.windowWidth<X?l-L:l-L/2,e.css({left:H,top:s+n+10}).show();var Y=document.querySelector("html, body");crmui.animateScrollTop(Y,s-115,200),e.find(".decimalFld").focus()}},constructDiscountPopup:function(t){var e=$(t),a=$("#multipleFieldsEditPop").is(":visible"),i=e.closest("table").hasClass("aggFldTabl"),r=e.closest("tr").data("data-rowid");if(a)var l=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];for(var s=i?a?$("#Crm_"+productDetails.module+"_"+l+"_DISCOUNT_TYPE"):$("#Crm_"+productDetails.module+"_DISCOUNT_TYPE"):$(productDetails.sfFldIdSuffix+"DISCOUNT_TYPE_"+r),n=i?a?$("#Crm_"+productDetails.module+"_"+l+"_DISCOUNT_PERCENTAGE"):$("#Crm_"+productDetails.module+"_DISCOUNT_PERCENTAGE"):$(productDetails.sfFldIdSuffix+"DISCOUNT_PERCENTAGE_"+r),o=s.data("picklistmap"),d=o.length,c=$("#discountPop"),u="<div class='p30'><div class=\"crm-font-bold pB15\">"+I18n.getMsg("crm.discount.pop.title")+"</div>",p=0;p<d;p++){var v,m,f,h,g=o[p];switch(g.systemvalue){case"Percentage":v="percent",m="percent",f="discPercErr",h=I18n.getMsg("crm.subform.lineitem.discount.percentage.validation.error",$ESAPI.encoder().encodeForHTML(n.data("displaylabel")));break;case"Direct Price":v="dirPrice",m="dirPrice",f="dirPcErr",h=I18n.getMsg("crm.subform.lineitem.discount.directprice.validation.error");break;case"Price Book":v="frmBook",m="fromPb"}u=u+'<div class="pB10"> <div class="noEventDiv" id="'+v+'"><label class="rbCheckHtml"> <input type="radio" data-zcqa="discount_'+g.uservalue+'_radio" id="inventrydiscountPop" name="discType" value="'+m+'" class="roundCheck discType cP"><span class="rbHtml"></span> <span class="rbHtmlLb mL5">'+g.uservalue+"</span></label>","Percentage"!==g.systemvalue&&"Direct Price"!==g.systemvalue||(u+='<span class="',"Percentage"===g.systemvalue&&(u+="pL15 "),u=u+'vH"> <input type="text" data-zcqa="discount_'+g.uservalue+'_input" class="w40 ',"Percentage"===g.systemvalue?u+="discPc":u+="directPrice",u+=" decimalFld newinputText1","Percentage"===g.systemvalue?u+=' alignRight"> <b class="pL5">%</b> </span></div>':u+='"> </span></div>',u=u+'<div style="padding: 5px 20px 0px 20px;"><span id="'+f+'" style="font-size: 11px;color: red;" class="vaT dN taxValError">'+h+"</span></div>",u+="</div>")}i||(u+="</div> </div>"),u=u+'<div class="pT10"><input type="button" data-zcqa="discount_save" id="saveDiscountType" class="primarybtn btn_sml" value="'+I18n.getMsg("crm.button.done")+'"><input type="button" data-zcqa="discount_cancel" id="cancelDiscountType" class="newgraybtn btn_sml" value="'+I18n.getMsg("crm.button.cancel")+'"></div></div>',c.html(u)},calculateGrandTotalSFLineItem:function(t,e){var a=$("#multipleFieldsEditPop").is(":visible");if(a)var i=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];var r=a?$("#Crm_"+productDetails.module+"_"+i+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT"),l=a?$("#Crm_"+productDetails.module+"_"+i+"_SUBTOTAL"):$("#Crm_"+productDetails.module+"_SUBTOTAL"),s=a?$("#Crm_"+productDetails.module+"_"+i+"_ADJUSTMENT"):$("#Crm_"+productDetails.module+"_ADJUSTMENT"),n=a?$("#Crm_"+productDetails.module+"_"+i+"_TAX"):$("#Crm_"+productDetails.module+"_TAX");if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted)var o=a?$("#Crm_"+productDetails.module+"_"+i+"_DISCOUNT_TYPE"):$("#Crm_"+productDetails.module+"_DISCOUNT_TYPE"),d=a?$("#Crm_"+productDetails.module+"_"+i+"_DISCOUNT_PERCENTAGE"):$("#Crm_"+productDetails.module+"_DISCOUNT_PERCENTAGE");e.closest("table").hasClass("aggFldTabl");var c=l.val();c=c&&c.length>0?c:"";var u=parseFloat(r.length>0?r.val():0);if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted)var p=d.val();else p=r.attr("percentage");var v=parseFloat(void 0===p||0===p.length||isNaN(p)?0:p);(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted?"Direct Price"!==productDetails.getDiscountTypeSystemValueForUserValue(o):"dirPrice"!==r.attr("discType"))&&(u=0!==v?c*v/100:parseFloat(void 0===u||0===u.length||isNaN(u)?0:u));for(var m=0,f=$("#recordTaxDet").val(),h=f?f.split(";;;"):"",g=h.length-1,D=0,T=0;T<g;T++){var x=h[T].split("===")[1],I=parseFloat(x.split(":::")[0]),P=(c-u)*I/100;m+=parseFloat(productDetails.getRoundOff(n,P)),D+=I}var C=parseFloat(s.val());(isNaN(C)||""===C)&&(C=""),m=productDetails.getRoundOff(n,m),c=""!==c?productDetails.getRoundOff(l,c):c,C=""!==C?productDetails.getRoundOff(s,C):C,u=productDetails.getRoundOff(r,u),l.val(""===c||isNaN(c)?"":c).trigger("change"),s.val(""!==C?parseFloat(C).toString():C).trigger("change"),l.attr("temp-value",c),n.attr("percentage",D),r.val(parseFloat(u).toString()).trigger("change"),n.val(parseFloat(m).toString()).trigger("change"),productDetails.grandTaxChanged=!1},showTaxToolTipForSFLineItem:function(t){var e=$(t).closest("tr").data("data-rowid"),a=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+e),i=0===a.length?0:a.val().length;if(!$(t).closest("table").hasClass("aggFldTabl")&&i>0){var r=JSON.parse(a.attr("prdDetails")),l=r.Taxable+""=="true",s=$(productDetails.sfFldIdSuffix+"LINETAX_"+e),n=s.attr("old"),o=s.val(),d="<table>";if(""!==(o=l&&0===o.length?"":o)&&(l||n))for(var c=o.split(";;;"),u=c.length-1,p=0;p<u;p++){var v=c[p],m=(o=v.split("===")[1],v.split("===")[0].trim()),f=productDetails.taxIdVsName[m];void 0!==f&&f.length>0&&(m=f[1]);var h=o.split(":::")[0];d=d+"<tr> <td> "+productDetails.getTaxDisplayNameSFLineItem(m)+" </td> <td> : </td> <td> &nbsp; "+h+"% </td></tr>"}else d=""!=r.Tax&&r.Tax.split("-").length>=1?d+"<tr> <td>"+I18n.getMsg("crm.tax.selected.check")+"</td> </tr>":d+"<tr> <td>"+I18n.getMsg("crm.tax.association.check")+"</td> </tr>";d+="</table>",""!==$(d).html()&&renderingUtils.zctt.showtt(d)}},showDiscToolTipForSFLineItem:function(t){if(!$(t).closest("table").hasClass("aggFldTabl")){var e=$(t).closest("tr").data("data-rowid"),a=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+e),i=a.length>0?a.val().length:0,r=$(productDetails.sfFldIdSuffix+"TOTALAFTERDISCOUNT_"+e).val();r=r||0,i>0&&renderingUtils.zctt.showtt(I18n.getMsg("TotalAfterDiscount")+" : "+productDetails.currencySymbol+" "+r)}},showPrdToolTipSFLineItem:function(t){var e=$(t).closest("tr").data("data-rowid"),a=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+e);if(a.val().length>0&&void 0!==a.attr("prdDetails")){var i=JSON.parse(a.attr("prdDetails")),r=i.Unit_Price;if(!isNaN(r)&&null!=r&&String(i.Unit_Price).length>0){var l=1,s=$("#Crm_"+productDetails.module+"_CURRENCYISOCODE").val(),n=Crm.userDetails.BASE_CURRENCY;null!=s&&null!=n&&s!=n&&(l=Crm.userDetails.CURRENCY_DETAILS[s]?Crm.userDetails.CURRENCY_DETAILS[s].er:Crm.userDetails.CURRENCY_DETAILS[n].er),r*=l,r=productDetails.getRoundOffValue(r,!0)}else r=0;r=productDetails.currencySymbol+" "+r;var o=isNaN(i.Qty_in_Stock)||0===i.Qty_in_Stock.length?"-":i.Qty_in_Stock;i.isNumberSeparatorEnabledForQInS&&(o=Search.formatNumber(o.toString()));var d=null==i.Product_Code?"-":$ESAPI.encoder().encodeForHTML(i.Product_Code.toString()),c='<table class="crm-small-font-size nowrap pli_tooltipzc crm-font-bold"><tr> <td class="pli_tooltipTd pli_tooltipLbl">'+I18n.getMsg("crm.label.Product Code")+'</td> <td class="pli_tooltipTd"> : </td> <td class="pli_tooltipTd" id="prdCode"> &nbsp; '+d+" </td></tr>";c=(c=c+'<tr> <td class="pli_tooltipTd pli_tooltipLbl">'+I18n.getMsg("Qty in Stock")+'</td> <td class="pli_tooltipTd"> : </td> <td class="pli_tooltipTd" id="qtyInStk"> &nbsp; '+o+" </td></tr>")+'<tr><td class="pli_tooltipTd pli_tooltipLbl">'+I18n.getMsg("Unit Price")+'</td> <td class="pli_tooltipTd"> : </td> <td class="pli_tooltipTd" id="unitPrice"> &nbsp; '+r+" </td> </tr></table>",renderingUtils.zctt.showtt(c)}},calcGrandDiscSFLineItem:function(t,e){var a,i,r,l,s=$(t),n=0,o=0,d=e.closest("tr"),c=d.data("data-rowid"),u=d.closest("table").hasClass("aggFldTabl"),p=$("#multipleFieldsEditPop").is(":visible"),v="edit"===window[productDetails.module].currentStatus||"clone"===window[productDetails.module].currentStatus;if(p)var m=$("#duringTabs").find(".sel").attr("data-tab").split("_")[0];u?(a=p?$("#Crm_"+productDetails.module+"_"+m+"_SUBTOTAL"):$("#Crm_"+productDetails.module+"_SUBTOTAL"),i=p?$("#Crm_"+productDetails.module+"_"+m+"_DISCOUNT"):$("#Crm_"+productDetails.module+"_DISCOUNT"),r=p?$("#Crm_"+productDetails.module+"_"+m+"_TAX"):$("#Crm_"+productDetails.module+"_TAX"),Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted&&(l=p?$("#Crm_"+productDetails.module+"_"+m+"_DISCOUNT_PERCENTAGE"):$("#Crm_"+productDetails.module+"_DISCOUNT_PERCENTAGE"))):(a=$(productDetails.sfFldIdSuffix+"TOTAL_"+c),i=$(productDetails.sfFldIdSuffix+"DISCOUNT_"+c),r=$(productDetails.sfFldIdSuffix+"TAX_"+c),Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted&&(l=$(productDetails.sfFldIdSuffix+"DISCOUNT_PERCENTAGE_"+c)));var f=parseFloat(a.val());if(f=isNaN(f)?0:f,s.attr("class").indexOf("discPc")<0){if((""===(n=s.val())||isNaN(n))&&(n=0),n=productDetails.getRoundOff(i,parseFloat(n)),o=0===f?0:100*n/f,Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted){o+="";var h=5,g=3,D=l.data("oldValue");if(v&&""!==D&&parseFloat(D)>0&&(h<(D+="").length&&(h=D.length),D.indexOf(".")>-1)){var T=D.substring(D.indexOf(".")+1,D.length).length;g<T&&(g=T)}if((o=productDetails.getRoundOffValue(o,!0,l&&v?g:3)).length>(v?h:5)){g=o.substring(o.indexOf(".")+1,o.length).length;var x=o.length-(v?h:5);o=g-x>=0?productDetails.getRoundOffValue(o,!0,g-x):productDetails.getRoundOffValue(o,!0,3)}o=parseFloat(o)}else o=productDetails.getRoundOff(i,o);s.parent().parent().parent().parent().find(".discPc").val(o)}else(""===(o=s.val())||isNaN(o))&&(o=0),n=f*o/100,n=productDetails.getRoundOff(i,n),s.parent().parent().parent().parent().find(".directPrice").val(n);var I=$(productDetails.sfFldIdSuffix+"TOTALAFTERDISCOUNT_"+c);if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted||i.attr("percentage",o),i.val(parseFloat(n).toString()).trigger("change"),I.val(parseFloat(productDetails.getRoundOff(I,parseFloat(f-n))).toString()).trigger("change"),r.length>0){var P=u?a.val()-n:I.length>0?I.val():a.val(),C=$(productDetails.sfFldIdSuffix+"LINETAX_"+c),b=u?$("#recordTaxDet").val():C.val(),y=0;if(u||""!==b){var _=b.split(";;;"),S=_.length-1;for(w=0;w<S;w++){b=_[w].split("===")[1];y+=P*(k=parseFloat(b.split(":::")[0]))/100}}else{b=JSON.parse(productDetails.newAllTaxes);var O=$(productDetails.sfFldIdSuffix+"PRODUCTID_"+c),F=O.length>0&&void 0!==O.attr("prdDetails")?JSON.parse(O.attr("prdDetails")):{},N=productDetails.getTaxVsIdSFLineItem(F.Tax),E=void 0!==C&&C.length>0?N:"";if(null!==b&&F.Taxable)for(var R=objectUtils.getKeys(b),L=R.length-1,w=0;w<=L;w++){var A=R[w],k=b[A];E.length>0&&E.indexOf(A)>-1&&!u&&productDetails.autoPopulateTax&&(y+=P*k[1]/100)}}r.val(parseFloat(productDetails.getRoundOff(r,y)).toString()).trigger("change")}Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotalSFLineItem(s,d)},constructTaxPopSFLineItem:function(t,e,a,i,r,l){t=parseFloat(t);var s="",n=productDetails.getTaxDisplayNameSFLineItem(e);if(Crm.userDetails.TAX_MIGRATION_COMPLETED){var o=n+"_"+t+"_percentage",d=i?"grandTaxRnd":"lineTaxRnd",c=i?"grandTaxValError":"inlineTaxValError";s=(s=(s=(s=(s='<div class="taxRow clearFix">')+'<label class="newCustomchkbox-md fL w130 mT3 dIB vaM"><input type="checkbox" id='+d+' class="'+d+'" style="width: 25px;height: 15px;" value="'+e+'" data-zcqa="'+(n+"_"+t+"_tax_checkbox")+'" btn-num="'+l+'"'+(r?" checked":"")+'><span class="chkbxIcon vaM mR10"></span><span class="ellipsistext w100 dIB vaM taxName">'+n+"</span></label>")+'<div class="fL clearFix"><div class="taxPercentage_box fL wAuto '+(r&&productDetails.canEditTaxValue?"":"taxPercentage_box_bg")+'"><input type="number" max="5" class="'+(r&&productDetails.canEditTaxValue?"":"taxPercentage_box_bg")+" decimalFld editTax alignRight borderNone w40 "+(productDetails.canEditTaxValue?"":"cantEditTax")+'" data-zcqa="'+o+'" value="'+t+'" onkeydown="productDetails.checkMaxLengthSFLineItem(event,this,false,'+i+')" '+(productDetails.canEditTaxValue&&r?"":'readonly="true" ')+(productDetails.canEditTaxValue?"":'style="-moz-appearance: textfield"')+'><b class="pL5">%</b></div>')+'<div class="mL10 taxVal alignRight decimalFld fR w100 mT6" size="5" style="font-size: smaller;">'+(r?parseFloat(a):"-")+"</div></div>")+'</div><div class="mB10"><span id="'+c+l+'" style="font-size: 11px;color: red;margin-left: 130px;" class="vaT dN taxValError">'+I18n.getMsg("crm.field.valid.check",I18n.getMsg("crm.label.tax.value"))+"</span></div>"}else s=s+'<div class="taxRow"> <p class="crm-small-font-size crm-font-bold crmBaseColor taxName"> '+n+' </p> <div class="pT10 pB10 br_bottom_border4 mB10"><input type="text" size="5" class="newinputText1 decimalFld editTax alignRight" value="'+t+'"> <b class="pL5">%</b> <input type="text" class="newinputText1 mL10 taxVal alignRight decimalFld" readonly="true" size="5" value="'+parseFloat(a)+'"> <label class="pL5"> </label></div> </div>';return s},createDiscPopupSFLineItem:function(t){var e=document.createElement("div");if(e.id="discountPop",e.setAttribute("class","newpopup w320"),e.setAttribute("style","display: none;z-index: 2"),e.setAttribute("onclick","sE(event)"),t.appendChild(e),!Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted){var a="discount_"+I18n.getMsg("percentage")+"_radio",i="discount_"+I18n.getMsg("crm.label.direct.dicount")+"_radio",r="discount_"+I18n.getMsg("crm.inventory.discount.frompb")+"_radio",l="discount_"+I18n.getMsg("percentage")+"_input",s="discount_"+I18n.getMsg("crm.label.direct.dicount")+"_input",n="<div class='p30'><div class=\"crm-font-bold pB15\">"+I18n.getMsg("crm.discount.pop.title")+"</div>";n=(n=(n=(n=(n=(n+='<div class="pB10">')+'<div class="noEventDiv" id="percent"><label class="rbCheckHtml"> <input type="radio" data-zcqa="'+a+'" id="inventrydiscountPop" name="discType" value="percent" class="roundCheck discType cP"><span class="rbHtml"></span> <span class="rbHtmlLb mL5">'+I18n.getMsg("percentage")+'</span></label> <span class="pL15 vH">')+'<input type="text" data-zcqa="'+l+'" class="w40 discPc decimalFld newinputText1 alignRight"> <b class="pL5">%</b> </span></div><div><span id="discPercErr" style="font-size: 11px;color: red;margin-left: 20px;" class="vaT dN taxValError">'+I18n.getMsg("crm.subform.lineitem.discount.percentage.validation.error")+"</span></div> </div>")+'<div class="pB10">  <div class="noEventDiv" id="dirPrice"> <label class="rbCheckHtml"><input type="radio" data-zcqa="'+i+'" id="inventrydiscountPop" name="discType" value="dirPrice" class="roundCheck discType cP"><span class="rbHtml"></span> <span class="rbHtmlLb mL5">'+I18n.getMsg("crm.label.direct.dicount")+"</span></label>")+'<span class="vH"> <input type="text" data-zcqa="'+s+'" class="w40 directPrice decimalFld newinputText1"> </span> </div><div><span id="dirPcErr" style="font-size: 11px;color: red;margin-left: 20px;" class="vaT dN taxValError">'+I18n.getMsg("crm.subform.lineitem.discount.directprice.validation.error")+"</span></div> </div>")+'<div class="pB10"> <div class="noEventDiv" id="frmBook">  <label class="rbCheckHtml"><input type="radio" data-zcqa="'+r+'" id="inventrydiscountPop" name="discType" value="fromPb" class="discType roundCheck cP"><span class="rbHtml"></span><span class="rbHtmlLb mL5">'+I18n.getMsg("crm.inventory.discount.frompb")+"</span></label>",n=(n+="</div> </div>")+'<div class="pT10"><input type="button" data-zcqa="discount_save" id="saveDiscountType" class="primarybtn btn_sml" value="'+I18n.getMsg("crm.button.done")+'"><input type="button" data-zcqa="discount_cancel" id="cancelDiscountType" class="newgraybtn btn_sml" value="'+I18n.getMsg("crm.button.cancel")+'"></div></div>',e.innerHTML=n}},createTaxPopsSFLineItem:function(t){var e=document.createElement("div");e.id="taxesPop",t.appendChild(e);var a='<div class="newpopup '+(Crm.userDetails.TAX_MIGRATION_COMPLETED?"p30 w350":"p15 w190")+' bg_white hide" style="top: 128px; display: block; left: 963px;" id="taxPop" onclick="sE(event)"> </div>';a=a+'<div class="newpopup '+(Crm.userDetails.TAX_MIGRATION_COMPLETED?"p30 w350":"p15 w190")+' bg_white hide" style="top: 128px; display: block; left: 963px;" id="grandTaxPop" onclick="sE(event)"> </div>',a+='<input id="grandTaxValueMap" type="text" style="display:none"/>',e.innerHTML=a},cancelGrandTaxSFLineItem:function(t){event.stopPropagation(),(t?$("#grandTaxPop"):$("#taxPop")).empty().hide()},fillBillingAddressForPO:function(){var t=Crm.userDetails.orgAddress;null!=t&&""!=t&&(t=t.split("|"),$("#Crm_PurchaseOrders_BILLINGSTREET").val(t[0]),$("#Crm_PurchaseOrders_BILLINGCITY").val(t[1]),$("#Crm_PurchaseOrders_BILLINGSTATE").val(t[2]),$("#Crm_PurchaseOrders_BILLINGCODE").val(t[3]),$("#Crm_PurchaseOrders_BILLINGCOUNTRY").val(t[4]))},createLinesTable:function(t){var e=document.createElement("div");e.id="productList",t.appendChild(e);var a='<div class="pT0 pB20" style="display:none"> <div class="wrap"> <table width="100%" border="0" cellspacing="0" cellpadding="0" class="invoiceTable" id="linesTable"> ';a+='<thead><tr id="lineHeaderRow"><th width="30%" class="crm-font-bold">'+I18n.getMsg("Product Details")+'</th> <th width="12%" class="aligncenter crm-font-bold">'+I18n.getMsg("List Price")+'</th><th width="12%" class="aligncenter crm-font-bold">'+I18n.getMsg("Quantity")+'</th><th width="12%" class="aligncenter crm-font-bold">'+I18n.getMsg("Amount")+"</th>",a+='<th width="12%" class="aligncenter crm-font-bold">'+I18n.getMsg("Discount")+'</th><th width="12%" class="aligncenter crm-font-bold">'+I18n.getMsg("Tax")+'</th><th width="12%" class="aligncenter crm-font-bold">'+I18n.getMsg("Total")+'</th><th width="2%"></th><th width="5%"></th></tr></thead>',a+='<tbody id="linesTbody"> </tbody> <tfoot> <tr> <td colspan="5" style="border-bottom:none"><input type="button" value="'+I18n.getMsg("crm.button.inventory.add.lineitems")+'" onclick="productDetails.showpop()" class="newgraybtn mT40 cP"></td> ',Crm.userDetails.hideProductLineItemsSummary||(a+='<td colspan="2"  style="border-bottom:none"> <table class="fR"> <tr> <td class="borderNone"> <label class="fL w100 alignRight">'+I18n.getMsg("Sub Total")+'</label> </td> <td class="borderNone alignRight"> <span class="fL w100 grandVals"> </span> <input type="hidden" id="subTotal" name="property(Sub Total)" value="0"> </td> <td class="borderNone"> </td> </tr>',a+='<tr> <td class="borderNone"> <label class="fL w100 alignRight">'+I18n.getMsg("Discount")+'</label> </td> <td onmouseover=\'productDetails.showCellIcon(this, true,false)\' onmouseout=\'productDetails.hideCellIcon(this, true)\' class="borderNone alignRight"> <span class="w100 pL40"> <label class="grandVals"> </label> <input type="hidden" id="txtDiscount" name="property(Discount)" value="0"> <input type="hidden" class="discPc" id="discPc" name="property(hdnDiscPc)" value="0"> </span> </td> <td onmouseover=\'productDetails.showCellIcon(this,undefined,false)\' onmouseout=\'productDetails.hideCellIcon(this)\' class="borderNone"> <i class="neweditIcon dIB vaM mL5 lineicon cP" style="visibility: hidden;" onclick="productDetails.showGrandDiscPop(this);sE(event)"></i> </td> </tr>',a+='<tr> <td class="borderNone"> <label class="fL w100 alignRight">'+I18n.getMsg("Tax")+'</label> </td> <td id=\'recordTaxDetTD\' onmouseover=\'productDetails.showCellIcon(this, true,false)\' onmouseout=\'productDetails.hideCellIcon(this, true)\' class="borderNone alignRight"> <span class="w100 pL40"><label class="grandVals"> </label> <input type="hidden" id="txtTax" name="property(Tax)" value="0"> </span> <input type="hidden" id="recordTaxDet" name="property(recordTaxDet)" class="recordTaxDet"> </td> <td onmouseover=\'productDetails.showCellIcon(this,undefined,false)\' onmouseout=\'productDetails.hideCellIcon(this)\' class="borderNone"> <i class="icon_roundNxtarw mL5 cP lineicon" style="visibility: hidden;" onclick="productDetails.showGrandTaxPop(this);sE(event)"></i> </td> </tr>',a+='<tr> <td> <label class="fL w100 alignRight">'+I18n.getMsg("Adjustment")+'</label> </td> <td class="alignRight"> <input type="text" size="8" class="textFieldEdit decimalFld cP textInLineItem alignRight mL15 invValidate" onkeyup="productDetails.calculateGrandTotal()" onmouseover="$(this).addClass(\'bg_crmBg3\')" onmouseout="$(this).removeClass(\'bg_crmBg3\')" onclick="$(this).select()" id="txtAdjustment" name="property(Adjustment)" value="0" style="box-shadow: none;"> </td> <td  class="borderNone"> </td> </tr>',a+='<tr style="border-top:1px solid #eee; border-bottom:1px solid #eee;" class="oH p5"> <td> <label class="fL w100 alignRight crm-font-bold">'+I18n.getMsg("Grand Total")+'</label> </td> <td class="alignRight"> <span class="fL w100 alignRight grandVals crm-font-bold"> </span> <input type="hidden" id="grandTotal" name="property(Grand Total)" value="0"> </td> <td  class="borderNone"> </td> </tr> </table> </td><td  style="border-bottom:none"></td><td  style="border-bottom:none"></td> </tr>',a+='</tfoot> </table> </div> </div> <div id="addLinesBtnLwr" class="pB10 fL cP invAddLinesBtn" onclick="productDetails.showpop()" > <div class=""> +  '+I18n.getMsg("crm.button.inventory.add.lineitems")+'<span class="errMsg crmNegativeColor pR20 crm-extra-small-font-size fR" id="errorMsg_Crm_'+this.module+'_PRODUCTDETAILS" style="color: rgb(221, 0, 0); display: none; top:0px !important"> * '+I18n.getMsg("crm.inventory.alert.lineitems.empty")+" </span> </div> </div>",a+=" </table> </div> <input type='hidden' name='property(totalProductCount)' id='totalProductCount' value='0'> </div>"),e.innerHTML=a},createProductsPop:function(t){var e=document.createElement("div");e.id="popup1",e.setAttribute("class","newpopup p30 w720 minW680"),e.setAttribute("style","left: 25%; top: 40%; height: 400px; z-index: 30; display: none;"),t.appendChild(e);var a='<div class="pR"> <div class="ui-front" id="invLinesAutoComplete"> </div> <div id="productPopup" style="max-height:750px"><div class="pL0"><div class="crm-medium-large-font-size crm-font-regular txtClrBlack"> <div style="float: right;"> <a href="javascript:;" class="icon_close mT6 fR" onclick="productDetails.closepop()">&nbsp;</a> <span class="fR" id="vendPrdsSpan"> <input type="checkbox" id="vendPrds"> <span> '+I18n.getMsg("crm.vendor.products.show")+' </span> </span></div> <h2 class="crm-heading-font-size mB10 borderBottomNone"> '+I18n.getMsg("crm.inventory.select.products")+" </h2>";a+='<table width="100%" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse;"><thead><tr class="bdrdouble">',a+='<th class="crm-small-font-size pT20 pB5 crm-font-regular alignLeft" width="65%" style="float: left;">'+I18n.getMsg("Product Details")+'</th> <th class="crm-small-font-size pT20 pB5 crm-font-regular" width="25%" style="float: left;">'+I18n.getMsg("Quantity")+'</th> <th class="" width="5%" style="float: left;">&nbsp;</th> </tr>  </thead>',a+='<tbody id="linesInPop" class="minH250 maxH250 oA" style="display: block;"> <tr> <td colspan="3" style="float: left;"> <div class="crm-base-font-size pT20"><a href="javascript:;" id="addAnotherLine" class="crmLinkColor cP addAnotherLine vH" tabindex="1002" onclick="productDetails.addLineInPop()">'+I18n.getMsg("zb.invoice.AddAnotherLine")+"</a></div> </td> </tr> </tbody>",a+='<tfoot style="display: block;"> <tr> <td>',a+='<div class="mT20"> <a href="javascript:;" class="primarybtn addFinal hauto dIB" id="addPrdbtn" onclick="productDetails.addSave()"> '+I18n.getMsg("crm.button.inventory.add.products")+" </a>",a+='<input type="button" id="cancelAddPrdbtn" class="newgraybtn hauto" value="'+I18n.getMsg("crm.button.cancel")+'" onclick="productDetails.closepop()"> <input type="hidden" id="linesInPop" name="linesInPop"> </div> </td> </tr> </tfoot> </table> </div> <br class="cBoth"> </div> </div> </div>',e.innerHTML=a},createDiscountPop:function(t){var e=document.createElement("div");e.id="discountPop",e.setAttribute("class","newpopup w300 hide"),e.setAttribute("style","left: 865.5px; top: 128px; display: block;"),e.setAttribute("onclick","sE(event)"),t.appendChild(e);var a='<div><div class="br_bottom_border4 p15" onmouseover="$(this).addClass(\'bg_crmBg3\')" onmouseout="$(this).removeClass(\'bg_crmBg3\')">';a+='<div class="noEventDiv"> <input type="radio" id="inventrydiscountPop" name="discType" value="percent" class="roundCheck discType cP"> <span class="crm-small-font-size crm-font-regular crmBaseColor cP">'+I18n.getMsg("percentage")+'</span> <span class="pL15 vH">',a+='<input type="text" size="5" class="discPc decimalFld newinputText1 alignRight"> <b class="pL5">%</b> </span></div></div>',a+='<div class="br_bottom_border4 p15" onmouseover="$(this).addClass(\'bg_crmBg3\')" onmouseout="$(this).removeClass(\'bg_crmBg3\')">  <div class="noEventDiv"> <input type="radio" id="inventrydiscountPop" name="discType" value="dirPrice" class="roundCheck discType cP"> <span class="crm-small-font-size crm-font-regular crmBaseColor cP">'+I18n.getMsg("crm.label.direct.dicount")+"</span>",a+='<span class="vH"> <input type="text" size="5" class="directPrice decimalFld newinputText1"> <label class="pL5"> </label> </span> </div> </div>',a+='<div class="p15" onmouseover="$(this).addClass(\'bg_crmBg3\')" onmouseout="$(this).removeClass(\'bg_crmBg3\')"> <div class="noEventDiv" id="frmBook"> <input type="radio" id="inventrydiscountPop" name="discType" value="fromPb" class="discType roundCheck cP">',a+='<span class="crm-small-font-size crm-font-regular crmBaseColor pL5 cP">'+I18n.getMsg("crm.inventory.discount.frompb")+"</span> </div> </div> </div> ",e.innerHTML=a},createTaxPops:function(t){var e=document.createElement("div");e.id="taxesPop",t.appendChild(e);e.innerHTML='<div class="newpopup p15 w300 bg_white hide" style="top: 128px; display: block; left: 963px;" id="taxPop" onclick="sE(event)"> </div><div class="newpopup p15 w190 bg_white hide" style="top: 128px; display: block; left: 963px;" id="grandTaxPop" onclick="sE(event)"> </div>'},createNewProductForm:function(t){var e=document.createElement("div");e.id="searchCreateDiv",e.setAttribute("style","position: absolute; width:660px; display:none; z-index:31"),t.appendChild(e),e.innerHTML='<input type="hidden" id="invNewProductForm" value="true"> '},showpop:function(){var t,e,a="",i=!1,r=$("#multipleFieldsEditPop");if(Crm.userDetails.isLookupAdvancedSearchEnabledInLineItem){r.is(":visible")&&(i=!0,a=(t=$("#multipleFieldsEditPop #duringTabs").find("li.sel").attr("id").split("_")[0])+"_",e=$L("#multipleFieldsEditPop #"+t+"_rlContainer"));var l=i?e.find("#linesTbody"):$("#linesTbody"),s=l.find("tr");if(200==s.length)return void Crm.showAlertMsg(I18n.getMsg("crm.lineitem.exceeds.alert","Line Items"));var n=l.find("#hrow1").find("input.ui-autocomplete-input").data();n.rowNumber=s.length+1,n.TAX_MIGRATION_COMPLETED=Crm.userDetails.TAX_MIGRATION_COMPLETED,n.autoPopulateTax=productDetails.autoPopulateTax;var o=Handlebars.templates.productDetailsRow(n);l.append(o);var d=l.find("#hrow"+n.rowNumber);d.addClass("hide"),i?e.find("#totalProductCount").val(s.length+1):$("#totalProductCount").val(s.length+1),$(".icon_close").removeClass("hide");var c=$(l.find("input.ui-autocomplete-input")[n.rowNumber-1]);c.length>0&&!c.data().readonly&&(crmLookupAutoComplete.initAutoCompletePlugin(c,"createPageLookup"),c.click((function(){$(this).autocomplete("search")}))),loadClassFns1(i,t),loadClassFns2(i),loadClassFns3(void 0,i),d.find(".productLookup").click()}else{r.is(":visible")&&(r.css("z-index","31"),r.find(".bPPopupFreezLayer").show());var u=$("#Crm_PurchaseOrders"+a+"_VENDORID");linesInPop=0,linesInPopInBp={},i&&(linesInPopInBp.relId=0);var p=i?parseInt($("#"+t+"_rlContainer #totalProductCount")[0].value)+1:parseInt(document.getElementById("totalProductCount").value)+1;if(p>200)return void alert(I18n.getMsg("crm.lineitem.exceeds.alert","Line Items"));if(1==p&&loadClassFns1(i,t),i?e.find("#addAnotherLine").addClass("vH"):$("#addAnotherLine").addClass("vH"),productDetails.addLineInPop(i,t),6!=$("#popup1").find("tr").length&&$(".addedRow").is(":hidden")||6==$("#popup1").find("tr").length&&0==$(".addedRow").is(":hidden")?(document.getElementById("addpbtn").style.opacity=1,showAnimatePopup("popup1"),$("#codein"+linesInPop).focus()):(i?e.find("#popup1").eq(0).css("display","block"):showAnimatePopup("popup1"),i?e.find("#codein"+linesInPopInBp.relId).focus():$("#codein"+linesInPop).focus()),"PurchaseOrders"==this.module){var v=$("#vendPrdsSpan");if(null!=v)if(u.length>0){var m=u.data().id;null==m||""==m?($(v).hide(),$("#vendPrds").prop("checked",!1)):($(v).show(),$("#vendPrds").prop("checked",!0))}else $(v).hide(),$("#vendPrds").prop("checked",!1)}else $("#vendPrdsSpan").remove();i&&e.scrollTo($L("#popup1"))}},addLineInPop:function(t,e){var a;t?a=$("#multipleFieldsEditPop #"+e+"_rlContainer"):(t=$("#multipleFieldsEditPop").is(":visible"),(t=!1)&&(a=$("#multipleFieldsEditPop #duringTabDivs div.current")));var i=t?a.find("#addAnotherLine"):$("#addAnotherLine"),r=t?a.find("#prdDet"+linesInPopInBp.relId):document.getElementById("prdDet"+linesInPop);if(t&&r.length>0&&""==r.val())return a.find("#codein"+linesInPopInBp.relId).focus(),void a.find("#codein"+linesInPopInBp.relId).select();if(!t&&r&&(null==r.value||""==r.value))return $("#codein"+linesInPop).focus(),void $("#codein"+linesInPop).select();if((t?linesInPopInBp.relId:linesInPop)>200)alert(I18n.getMsg("crm.lineitem.exceeds.alert","Line Items"));else{var l,s;t?(l=2*linesInPopInBp.relId+1e4,linesInPopInBp.relId++,s=linesInPopInBp.relId):(l=2*linesInPop+1e4,linesInPop++,s=linesInPop);var n='<tr id="lineInPop'+s+'" class="" onmouseover="productDetails.popLineHover(this)" onmouseout="productDetails.popLineOut(this)"><td class="crm-base-font-size pT15 pR" style="width: 345px;"> <input type="text" id="codein'+s+'" tabindex="'+(l+1)+'" class="cP popTxtBox newTextBx h20 dB" size="50" onclick="$(this).select()" placeholder="'+I18n.getMsg("crm.inventory.search.placeholder")+'">';n+='<span class="errMsg helper vH pA mT2" style="color: rgb(221, 0, 0); font-size: var(--crm-extra-medium-font-size); top: 100%;"> '+I18n.getMsg("crm.inventory.newline.codename.placeholder")+" </span> </td>",n+='<td class="aligncenter pT15 pR" valign="top" style="padding-right: 0px;"> <div class="aligncenter">  <input type="text" size="5" id="qtyin'+s+'" value="" tabindex="'+(l+2)+'" class="cP newTextBx popTxtBox h20 popQty decimalFld" onclick="$(this).select()");"> </div> <div style="width: 30%;" class="fL alignLeft prodInfoIc">  <i class="icon_roundinfo mL10 mT6 hide cP" onmouseover="productDetails.showQtyInfo(this);" onmouseout="renderingUtils.zctt.hidett();" style="visibility: hidden;"></i> </div> </td>',n+='<td valign="top" class="pT15 pR0" style="width: 56px;"> <div>',n+='<table><tr><td class="p0"><div id="removeProd_'+s+'" onclick="productDetails.deleteRowInPop('+s+', true)" class="fL"><span class=""></span></div></td>',n+='<td class="p0"><div class="iconAddItem fL" data-zcqa="addProductInc" id="addProd_'+s+'" onclick="productDetails.addLineInPop()"><span data-zcqa="addProductIncIcon"></span></div></td></tr></table>',n+='<input type="hidden" class="hdnPrdDet" id="prdDet'+s+'" name="prdDet'+s+'"> <input type="hidden" class="stkQty" id="stkQty'+s+'" name="stkQty'+s+'"> </td></tr>',t?a.find("#linesInPop").find("tr").last().before(n):$("#linesInPop").find("tr").last().before(n),i.attr("tabindex",l+3),t?a.find("#addPrdbtn").attr("tabindex",l+4):$("#addPrdbtn").attr("tabindex",l+4),t?a.find("#cancelAddPrdbtn").attr("tabindex",l+5):$("#cancelAddPrdbtn").attr("tabindex",l+5),searchStats.scrollEnd=!1,searchStats.fetchedAll=!1,searchStats.scrollPageIndex=1,searchStats.textBoxId="codein"+s,s>1&&($("#removeProd_1").addClass("iconRemoveItem"),$("#removeProd_"+s).addClass("iconRemoveItem"),$("#linesInPop").find(".iconAddItem").each((function(){var t=$(this).prop("id").split("_")[1];linesInPop!=t&&$(this).removeClass("iconAddItem")})));var o=t?a.find("#"+searchStats.textBoxId):$("#"+searchStats.textBoxId);$(o).autocomplete({source:function(t,e){var a=$(o).data("ui-autocomplete").menu.element;if($L(a).scrollTop(0),commonUtils.showHideLoadingDiv(!0),searchStats.searchText=t.term.trim(),searchStats.searchText.length<3)0==searchStats.searchText.length?$(o).parent().parent().find(".hdnPrdDet").val(""):setTimeout((function(){$(o).parent().find(".helper").addClass("vH");var t=productDetails.searchForProducts(searchStats.searchText,!1,0);e(t)}),500);else{$(o).parent().find(".helper").addClass("vH");var i=productDetails.searchForProducts(searchStats.searchText,!1,0);e(i)}commonUtils.showHideLoadingDiv()},minLength:0,appendTo:t?"#multipleFieldsEditPop #"+e+"_rlContainer #invLinesAutoComplete":"body",delay:500,search:function(t,e){$(o).val().length<3&&$(o).autocomplete("close")},open:function(){$(this).autocomplete("widget").css({width:316,height:"auto","max-height":250,overflow:"auto","z-index":1e3}).addClass("addlineitemNew")},select:function(t,e){productDetails.debugVar+=" lineInFocus obj in autocomplete select ----\x3e "+searchStats.lineInFocus+" ;;; ",productDetails.debugVar+=" lineInFocus id in autocomplete select ----\x3e "+$(searchStats.lineInFocus).attr("id")+" ;;; ","001"!=e.item.id?($(this).val($("<div/>").html($ESAPI.encoder().encodeForHTML(e.item.value)).text()),t.preventDefault(),$(this).parent().parent().find(".popQty").focus(),productDetails.getProductDetails(e.item.id,this),$(this).parent().parent().find(".icon_roundinfo").removeClass("hide"),$(this).next().addClass("ui-helper-hidden-accessible"),$(o).parent().find(".helper").remove(),i.removeClass("vH")):(e.item.value=null,productDetails.requestNewProductForm(),(void 0===Crm.userDetails.VALIDATIONRULEAVAILABLE||!0===Crm.userDetails.VALIDATIONRULEAVAILABLE&&Crm.userDetails.VRINVOLVEDMODULES.contains("Products"))&&Crm.downloadValidationRules(Crm.getCrmBasePath()+"/QuickCreateAction.do?module=Products","Products"))}}).on("focus",(function(){searchStats.scrollPageIndex=1,$(this).autocomplete("search")})).data("ui-autocomplete");var d=$(o).data("ui-autocomplete");d._renderMenu=function(t,e){searchStats.scrollPageIndex=1,searchStats.scrollEnd=!1,$(t).off("scroll"),productScroll._scrollMenu(t,e,d)},d._renderItem=function(t,e){return"001"!=e.id?$("<li>").data("ui-autocomplete-item",e).attr("data-value",e.value).attr("data-zcqa","product_"+e.value).attr("class","ui-menu-item").mouseenter((function(){$(this).find(".icon_roundinfo").removeClass("vH")})).mouseleave((function(){$(this).find(".icon_roundinfo").addClass("vH")})).append('<a class="ui-corner-all"><span class="productNameLengthExtend wbBreakAll dIB oH">'+$ESAPI.encoder().encodeForHTML(e.value)+"</span><i class=\"icon_roundinfo cP fR vH\"onmouseover=\" $(this).removeClass('vH'); productDetails.showBCDetails(this, '"+e.id+"');\" onmouseout=\"$('#prdBCTip').remove(); renderingUtils.zctt.hidett();\"></i> </a>").appendTo(t):$("<li>").data("ui-autocomplete-item",e).attr("data-value",e.value).attr("data-zcqa","product_newItem").attr("class","ui-menu-item").append('<a class="ui-corner-all">'+$ESAPI.encoder().encodeForHTML(e.value)+"</a>").appendTo(t)},$(o).focus((function(){productDetails.debugVar+=" lineInFocus obj before changing in codein.focus ----\x3e "+searchStats.lineInFocus+" ;;; ",productDetails.debugVar+=" lineInFocus id before changing in codein.focus ----\x3e "+$(searchStats.lineInFocus).attr("id")+" ;;; ",searchStats.lineInFocus=o,productDetails.debugVar+=" lineInFocus obj after changing in codein.focus ----\x3e "+searchStats.lineInFocus+" ;;; ",productDetails.debugVar+=" lineInFocus id after saving in codein.focus ----\x3e "+$(searchStats.lineInFocus).attr("id")+" ;;; ",searchStats.scrollEnd=!1,searchStats.textBoxId!=$(o).attr("id")&&(searchStats.fetchedAll=!1),searchStats.textBoxId=$(o).attr("id");var t=$(this).data("ui-autocomplete");t&&$L(t.menu.element).scrollTop(0)})),loadClassFns3(),$(o).focus()}},showBCDetails:function(t,e){var a,i=productDetails.prdIdVsDetailsMap[e],r=i.LAYOUTID,l='<i class="invSetDDPopupAbG leftA right8"><i class="invSetDDPopupA"></i></i> </div> <table>',s=productDetails.bcCols.length;productDetails.layoutVsBCfieldDetails&&(s=(a=productDetails.layoutVsBCfieldDetails[r]).length);for(var n=0;n<s;n++){var o=productDetails.bcCols[n],d=productDetails.fieldsInBC[n],c=productDetails.bcUiTypes[n];if(a){var u=a[n];o=u.columnname,d=u.fieldlabel,c=u.uitype}var p=i[o];if("LAYOUTID"===o&&(p=productDetails.layoutIdVsLayoutName[p]),null==p||null==p?p="-":p.length>50&&(p=p.substring(0,45)+"..."),96===c||"96"===c){var v=p;for(var m in p="",v)p=p+m+";";-1!=p.indexOf(";")&&(p=p.substring(0,p.lastIndexOf(";")))}if("object"==typeof p&&!Array.isArray(p)){var f=[];for(var m in p)f.push(m+":"+p[m]);p=f.join(" ,")}l+="<tr> <td> "+$ESAPI.encoder().encodeForHTML(d)+" </td> <td> </td> <td> </td> <td> "+p+" </td> </tr> "}l+="</table>";var h=document.createElement("div"),g=$(t),D=g.offset().top,T=g.offset().left;h.setAttribute("class","tooltipzcdefault"),h.setAttribute("id","prdBCTip"),h.style.display="block",h.style.position="absolute",h.style.zIndex="100",document.body.appendChild(h),$(h).append(l),$(h).show().css({left:T+45,top:D-80}),$("#prdBCArrow").css({top:D-50})},requestNewProductForm:function(){if(Crm.userDetails.isStorageLimitReached)Crm.showStorageExceedPopup();else{$("#FreezeLayer");var t=$("#layoutdetails");productDetails.debugVar+=" lineInFocus obj in requestNewProductForm ----\x3e "+searchStats.lineInFocus+" ;;; ",productDetails.debugVar+=" lineInFocus id in requestNewProductForm ----\x3e "+$(searchStats.lineInFocus).attr("id")+" ;;; ";var e=Crm.getCrmBasePath()+"/QuickCreateAction.do?module=Products&frmInvLineItem=true";e=networkUtils.getPortalURL(e),null!=t.val()&&(e=e+"&layoutId="+t.val());var a=getHTTPObject();a.open("POST",e,!1);a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),a.onreadystatechange=function(){if(4==a.readyState){if(a.status==crmConstants.errorStatusCode){return renderingUtils.displayPermissionDenied(a,(function(){$L("crux-permission-denied-alert")[0].component.setMethods({onAccept:function(){var t=$("#FreezeLayer");productDetails.showProductPopFromFreeze(),t.css({"z-index":1550,opacity:.9})}})})),void productDetails.cancelNewProduct(!0)}var t=a.responseText;$("#searchCreatePopup").html(t),showAnimatePopup("searchCreatePopup",(function(){setTimeout((function(){var t=$(document.getElementsByName("property(Product Name)"));t.val(searchStats.searchText),t.select()}),600)}));!1}},a.send("")}},searchForProducts:function(t,e,a){var i=[],r="",l=$("#Crm_PurchaseOrders_VENDORID"),s=$("#vendPrds").prop("checked");if(t=t.trim(),searchStats.previousSearchTerm==t&&!e&&searchStats.previousVendorStatus==s)return searchStats.previousSearchResults;searchStats.previousSearchTerm!=t?(searchStats.isFull=!1,searchStats.previousSearchResults=[]):e||(searchStats.previousSearchResults=[]),searchStats.previousSearchTerm=t,searchStats.previousVendorStatus=s;var n=Crm.getCrmBasePath()+"/autocomplete.do?searchtext="+encodeURIComponent(t)+"&entity=items&newlineitem=true";if(n=networkUtils.getPortalURL(n),null!=a&&null!=a&&(n+="&offset="+a),s&&l.length>0){var o=l.data().id;null!=o&&(n+="&vendorId="+o)}if(t.length>=1){var d=0,c=getHTTPObject();c.open("POST",n,!1),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),c.onreadystatechange=function(){if(4==c.readyState){var t=c.responseText;if(""!=t){var e=(r=JSON.parse(t))[1];if(""==productDetails.prdIdVsDetailsMap&&(productDetails.prdIdVsDetailsMap=e),productDetails.layoutIdVsLayoutName=r[2],r[3])for(var a,l=(a=r[3]).length,s=0;s<l;s++){var n=e[f=a[s]],o=(p=n.PRODUCTNAME)+"  ("+n.PRODUCTCODE+")";n.PRODUCTCODE||(o=p),i[d]={id:f,value:o},searchStats.previousSearchResults.push(i[d]),productDetails.prdIdVsDetailsMap[f]=e[f],d++}else if(null!=(a=r[0]))for(var u in a){var p=a[u],v=u.lastIndexOf(";;;;"),m=[u.substring(0,v),u.substring(v+4)],f=m[1];o=p+"  ("+m[0]+")";null!=m[0]&&""!=m[0]||(o=p),i[d]={id:f,value:o},searchStats.previousSearchResults.push(i[d]),productDetails.prdIdVsDetailsMap[f]=e[f],d++}}}i.length<50&&(searchStats.isFull=!0,!Crm.userDetails.permissions.Crm_Implied_Create_Products||0!=searchStats.previousSearchResults.length&&"001"==searchStats.previousSearchResults[searchStats.previousSearchResults.length-1].id||(i[d]={id:"001",value:"+ "+I18n.getMsg("crm.inventory.add.new.product")},searchStats.previousSearchResults.push(i[d])))},c.send("")}return i},getProductDetails:function(t,e){var a=$(e).parent().parent().find(".hdnPrdDet"),i=productDetails.prdIdVsDetailsMap[t];i=JSON.stringify(i),$(a).val(i),i=JSON.parse(i),$(e).parent().parent().find(".stkQty").val(i.QUANTITY_IN_STOCK)},showQtyInfo:function(t){var e=$(t).parent().parent().parent().find(".hdnPrdDet").val(),a=null!=(e=JSON.parse(e)).QUANTITY_IN_DEMAND?e.QUANTITY_IN_DEMAND:e["Qty in Demand"],i=null!=e.QUANTITY_IN_STOCK?e.QUANTITY_IN_STOCK:e["Qty in Stock"],r=null!=e.QUANTITY?e.QUANTITY:e["Qty Ordered"];null==a&&(a=""),null==i&&(i=""),null==r&&(r=""),renderingUtils.zctt.showtt("<table> <tr> <td> "+I18n.getMsg("Qty in Stock")+" </td> <td> "+i+" </td> </tr> <tr> <td> "+I18n.getMsg("Qty in Demand")+" </td> <td> "+a+" </td> </tr> <tr> <td> "+I18n.getMsg("Qty Ordered")+" </td> <td> "+r+" </td> </tr>")},deleteRowInPop:function(t,e,a,i){var r=null;a&&(r=$("#multipleFieldsEditPop #duringTabDivs div.current")),a?r.find("#lineInPop"+t).remove():$("#lineInPop"+t).remove();var l=a?linesInPopInBp.relId:linesInPop;if(1==l&&1==t&&productDetails.closepop(),e&&t!=l)for(var s=t+1;s<=l;s++){var n=$("#removeProd_"+s);a?r.find("#codein"+s).attr("id","codein"+(s-1)):$("#codein"+s).attr("id","codein"+(s-1)),a?r.find("#descin"+s).attr("id","descin"+(s-1)):$("#descin"+s).attr("id","descin"+(s-1)),a?r.find("#qtyin"+s).attr("id","qtyin"+(s-1)):$("#qtyin"+s).attr("id","qtyin"+(s-1)),a?r.find("#prdDet"+s).attr("name","prdDet"+(s-1)):$("#prdDet"+s).attr("name","prdDet"+(s-1)),a?r.find("#prdDet"+s).attr("id","prdDet"+(s-1)):$("#prdDet"+s).attr("id","prdDet"+(s-1)),n.attr({onclick:"productDetails.deleteRowInPop("+(s-1)+", true)",id:"removeProd_"+(s-1)}),$("#addProd_"+s).attr("id","addProd_"+(s-1)),a?r.find("#lineInPop"+s).attr("id","lineInPop"+(s-1)):$("#lineInPop"+s).attr("id","lineInPop"+(s-1))}t==linesInPop&&t>1&&$("#addProd_"+(t-1)).addClass("iconAddItem");a?linesInPopInBp.relId--:linesInPop--,1===linesInPop&&$("#removeProd_1").removeClass("iconRemoveItem")},validatePopLines:function(t,e){for(var a=!0,i=t?linesInPopInBp.relId:linesInPop,r=1;r<=i;r++){var l=getObj("codein"+r);if(null!=l.value&&""!=l.value){var s=getObj("qtyin"+r);null!=s.value&&""!=s.value||$(s).val(1);var n=$("#prdDet"+r).val();null!=n&&""!=n||(a&&(alert(I18n.getMsg("crm.inventory.alert.invalid.product")),$(l).focus()),a=!1)}else{if(1==r)return $("#codein"+r).focus(),!1;$(l).parent().parent().remove(),i--}}return t?linesInPopInBp.relId=i:linesInPop=i,a},closepop:function(){var t=null,e=!1,a=$("#multipleFieldsEditPop");if(a.is(":visible")){e=!1,t=$("#multipleFieldsEditPop #duringTabDivs div.current"),relId=t.attr("id").split("_")[0];var i=$("#addLinesBtnLwr").offset().top}for(var r=e?linesInPopInBp.relId:linesInPop,l=1;l<=r;l++){var s=e?t.find("#lineInPop"+l)[0]:getObj("lineInPop"+l);$(s).remove()}linesInPop=0,e&&(linesInPopInBp.relId=0),hideAnimatePopup("popup1"),e&&$L(window).scrollTo(0,i),a.is(":visible")?(a.css("z-index",""),a.find(".bPPopupFreezLayer").hide()):renderingUtils.removeFreezeLayer(),searchStats.lineInFocus=null},addSave:function(t){t&&(linesInPop=1);var e,a=$("#multipleFieldsEditPop"),i=!1;a.is(":visible")&&$("#multipleFieldsEditPop #duringTabDivs div.current");var r=$("#totalProductCount"),l=parseInt(r.val()),s=$("#productList"),n=$("#linesTable");n.offset().top;if(t||productDetails.validatePopLines(i,e)){for(var o=l+linesInPop,d=l+1,c=1;d<=o;d++,c++)productDetails.addARow(d,i,e),productDetails.setValuesForAddedRow(d,c,t,i),productDetails.deleteRowInPop(c,!1,i,e);n.parent().parent().show(),s.find(".pB20").show(),s.find(".pB20").find(".wrap").show(),r.val(o),$("#popup1").hide(),$("#addLinesBtnLwr").hide(),$(".lnk_inv_whatsnew").parent().show(),n.show();var u=$("#hdnSinglePbId").val(),p=$("#singlePbTable");null==u||""==u?p.hide():(p.children(0).children(0).find(".PriceBooks-Small").hide(),p.children(0).children(0).find(".clear_lookupfield").hide()),loadClassFns2(i),loadClassFns3(i),a.is(":visible")?(a.css("z-index",""),a.find(".bPPopupFreezLayer").hide(),renderingUtils.hideFreezeLayer()):hideAnimatePopup("popup1"),searchStats.lineInFocus=null}},addARow:function(t,e,a){var i="<tr id='hrow"+t+"' class='pl_"+t+" cTax sort helperBG' onmouseover='productDetails.invLineHover(this)' onmouseout='productDetails.invLineOut(this)'>";i+='<td> <input type="hidden" id="hdnProductId'+t+'" name="property(hdnProductId'+t+")\"> <div class='cP' onmouseover='productDetails.showPrdDetInEdit("+t+")' onmouseout='renderingUtils.zctt.hidett()'> <h3 id='txtProductSpan"+t+"' class=\"dI crm-base-font-size crm-font-bold\"> </h3> <span id='txtProductCodeSpan"+t+"' class='crmNotFoundColor isBpCheck'>  </span> <input type='hidden' id='hdnProductCode"+t+"' name='property(hdnProductCode"+t+')\'> </div> <input type="hidden" id="hdnInvRelId'+t+'" name="property(hdnInvRelId'+t+")\"> <input type='hidden' id='txtProduct"+t+"' name='property(hdnProductName"+t+")'> <textarea id='itemDescription"+t+"' name='property(itemDescription"+t+')\' cols="45" rows="3" maxlength="32000" class="itemDescription resizeNone" style="margin-top:5px;margin-left:-5px; padding:3px 5px; border:1px solid #efefef !important;border-radius: 3px !important" onmouseover="$(this).attr(\'placeholder\',\''+I18n.getMsg("PrdDescription")+"')\" onmouseout=\"$(this).attr('placeholder','')\"> </textarea></td>",i+='<td class="crm-small-font-size alignLeft" onmouseover=\'productDetails.showCellIcon(this,undefined,true)\' onmouseout=\'productDetails.hideCellIcon(this)\'> <div style="width:90%" class="fL alignRight">  <input type="text" class="cP alignRight textFieldEdit textInLineItem decimalFld pT3 pB3 crm-small-font-size invValidate" size="20" onmouseover="$(this).addClass(\'bg_crmBg3\')" style="width:100%; margin-top:-4px; box-shadow: none;" onmouseout="$(this).removeClass(\'bg_crmBg3\')" onclick="$(this).select()" id=\'txtListPrice'+t+"' data-label=\"List Price\" name='property(txtListPrice"+t+")' onblur='productDetails.calculateForLine("+t+", true)'> <input type='hidden' id='hdnPriceBookId"+t+"' name='property(hdnPriceBookId"+t+")'> <input type='hidden' id='hdnPriceBookIdClone"+t+"' name='property(hdnPriceBookIdClone"+t+")'> <input type='hidden' id='hdnPriceBookName"+t+"' name='property(hdnPriceBookName"+t+')\'> </div> <div style="width:10%" class="fL alignLeft">  <i class="icon_list cP lineicon vH pR" id="pbIcon'+t+'" title="'+I18n.getMsg("PriceBookNameLookUp")+'" onclick="Crm.showLookUp(\''+productDetails.module+"','property(txtListPrice"+t+")','hdnPriceBookId"+t+"','Product Details','PriceBooks','','','property(hdnProductId"+t+")')\" style=\"visibility: hidden;\"></i> <input type='hidden' id='hdnUnitPrice"+t+"' name='property(hdnUnitPrice"+t+")'> </div> </td>",i+='<td class="crm-small-font-size alignRight"> <input type="text" id=\'txtQty'+t+"' name='property(txtQty"+t+")' onblur='productDetails.calculateForLine("+t+', true)\' class="cP alignRight textFieldEdit textInLineItem decimalFld mL10 pT3 pB3 crm-small-font-size invValidate" size="10" onmouseover="$(this).addClass(\'bg_crmBg3\');" onmouseout="$(this).removeClass(\'bg_crmBg3\')" onclick="$(this).select()" style="margin-top:-4px; box-shadow: none;"> <input type=\'hidden\' id=\'hdnOldQty'+t+"' name='property(hdnOldQty"+t+")'> <input type='hidden' id='hdnQtyStock"+t+"' name='property(hdnQtyStock"+t+")'> </td>",i+='<td class="crm-small-font-size alignRight"> <span class="amntFP"> </span> <input type="hidden" id="total'+t+'" name="property(hdnTotal'+t+')"> </td>',i+='<td class="crm-small-font-size alignRight" onmouseover=\'productDetails.showCellIcon(this,undefined,false)\' onmouseout=\'productDetails.hideCellIcon(this)\'> <span style="width:75%" class="alignRight"> <span class="discVal" onmouseover="productDetails.showDiscForLine(this)" style=\'cursor:pointer\' onmouseout="renderingUtils.zctt.hidett()">  </span> <input type="hidden" id="totalAfterDiscount'+t+'" name="property(hdnTotalAfterDiscount'+t+')" class="getAftrDisc"> <input type="hidden" class="discAmt" id="discount'+t+'" name="property(hdnDiscount'+t+')"> <input type="hidden" class="discPc" id="discPc'+t+'" name="property(hdnDiscPc'+t+')" value="0"> </span> <i class="neweditIcon dIB vaM mL5 vH lineicon cP" onclick="productDetails.showDiscountPop(this);sE(event)" style="visibility: hidden;"></i> </td>',i+="<td class=\"crm-small-font-size alignRight\" onmouseover='productDetails.showCellIcon(this,undefined,false)' onmouseout='productDetails.hideCellIcon(this)'> <span class=\"taxClickelement\" id='inlineValueContainer"+t+'\'> <span class="taxval" onmouseover="productDetails.showTaxForLine(this)" style=\'cursor:pointer\' onmouseout="renderingUtils.zctt.hidett()">  </span> <input type="hidden" id="tax'+t+'" name="property(hdnTax'+t+')"> <input type="hidden" id="prdTaxDet'+t+'" name="property(hdnPrdTaxDet'+t+')" class="prdTaxDet"> <input type="hidden" id="prdAllTax'+t+'" class="prdAllTax"> </span> <div style="width:22px" class="alignRight dIB">',!0===Crm.userDetails.TAX_MIGRATION_COMPLETED?i+='<i class="neweditIcon lineicon mL5 dIB vaM vH cP" onclick="productDetails.editLineItemTax(this,'+t+');sE(event)" style="visibility: hidden;" id=\'taxInlineEditIcon'+t+"'></i> </div> </td>":i+='<i class="neweditIcon lineicon mL5 dIB vaM vH cP" onclick="productDetails.showtaxPop(this);sE(event)" style="visibility: hidden;"></i> </div> </td>',i+='<td class="crm-small-font-size alignRight"> <span class="netTot">  </span> <input type="hidden" id="netTotal'+t+'" name="property(hdnNetTotal'+t+')" class="eachTotVal"> </td>',i+='<td class="alignRight"> <i class="icon_close cP" onclick="productDetails.deleteARow(this)" style="visibility: hidden;"></i></td> <td class="alignRight"style="cursor:move;"><i class="icon_reorder dragdrop"></i> <input type="hidden" class="isTaxable" id="isTaxable'+t+'"> </td>',i+="</tr>",$("#multipleFieldsEditPop").is(":visible")&&(actContainer=$("#multipleFieldsEditPop #"+a+"_rlContainer")),e?actContainer.find("#linesTbody").append(i):$("#linesTbody").append(i),e?actContainer.find("#hdnPriceBookId"+t).data("colname","BOOKID"):$("#hdnPriceBookId"+t).data("colname","BOOKID")},setValuesForAddedRow:function(t,e,a,i){var r=null;i&&(r=$("#multipleFieldsEditPop #duringTabDivs div.current")),null==a&&(a=i?r.find("#prdDet"+e).val():$("#prdDet"+e).val());var l=a;try{a=JSON.parse(a)}catch(t){a=l}var s="<div/>";(i?r.find("#hdnProductId"+t):$("#hdnProductId"+t)).val(validationUtils.isUndefined(a,"PRODUCTID")?validationUtils.isUndefined(a,"seId")?a.SEID:a.seId:a.PRODUCTID);var n=null!=a.PRODUCTNAME?a.PRODUCTNAME:a["Product Name"],o=i?r.find("#txtProductSpan"+t):$("#txtProductSpan"+t),d=$(s).html($ESAPI.encoder().encodeForHTML(n)).text();o.text(d),(i?r.find("#txtProduct"+t):$("#txtProduct"+t)).val(d);var c=null!=a.PRODUCTCODE?a.PRODUCTCODE:null!=a["Product Code"]?a["Product Code"]:"";(i?r.find("#txtProductCodeSpan"+t):$("#txtProductCodeSpan"+t)).text(""==c?"":"("+$(s).html(c).text()+")"),(i?r.find("#hdnProductCode"+t):$("#hdnProductCode"+t)).val(null!=a.PRODUCTCODE?a.PRODUCTCODE:a["Product Code"]);var u=i?r.find("#itemDescription"+t):$("#itemDescription"+t),p=null==a.DESCRIPTION?a.Description:a.DESCRIPTION;u.val($(s).html(p).text());var v=parseFloat(null!=a.UNITPRICE?a.UNITPRICE:a["Unit Price"]);isNaN(v)&&(v=0);var m=$("#Crm_"+productDetails.module+"_CURRENCYISOCODE").val(),f=Crm.userDetails.BASE_CURRENCY,h=1;null!=m&&null!=f&&m!=f&&null!=Crm.userDetails.CURRENCY_DETAILS[m]&&null!=Crm.userDetails.CURRENCY_DETAILS[f]&&(h=Crm.userDetails.CURRENCY_DETAILS[m]?Crm.userDetails.CURRENCY_DETAILS[m].er:Crm.userDetails.CURRENCY_DETAILS[f].er),v*=h,v=productDetails.getRoundOffValue(v,!0),i?r.find("#txtListPrice"+t).val(v):$("#txtListPrice"+t).val(v),i?r.find("#hdnUnitPrice"+t).val(v):$("#hdnUnitPrice"+t).val(v);var g=void 0,D=i?r.find("#qtyin"+e):$("#qtyin"+e);g=0===D.length?parseFloat(a.QUANTITY):parseFloat(D.val()),i?r.find("#txtQty"+t).val(g):$("#txtQty"+t).val(g),i?r.find("#hdnOldQty"+t).val(g):$("#hdnOldQty"+t).val(g);var T=void 0,x=i?r.find("#stkQty"+e):$("#stkQty"+e);T=0===x.length?a.QUANTITY_IN_STOCK:x.val(),i?r.find("#hdnQtyStock"+t).val(T):$("#hdnQtyStock"+t).val(T);var I=v*g;I=productDetails.getRoundOffValue(I,!0);var P=i?r.find("#total"+t):$("#total"+t);P.val(I),P.parent().find(".amntFP").text(I);var C=i?r.find("#discount"+t):$("#discount"+t);C.val(0),C.parent().find(".discVal").text(0);var b=I-0;b=productDetails.getRoundOffValue(b,!0);i?r.find("#totalAfterDiscount"+t).val(b):$("#totalAfterDiscount"+t).val(b);var y=a.TAX;y||(y={});var _=[];!productDetails.autoPopulateTax&&Crm.userDetails.TAX_MIGRATION_COMPLETED||!y||(_=Object.keys(y));var S=0,O=a.ISTAXABLE;i?r.find("#isTaxable"+t).val(O):$("#isTaxable"+t).val(O);var F="",N={};for(var E in 0==O||"false"==O?(O=!1,y={}):O=!0,y){var R;if(Crm.userDetails.TAX_MIGRATION_COMPLETED?(R=y[E][1],N[E]=y[E][0]):R=y[E],_.contains(E)){var L=b*parseFloat(R)/100;S+=L,F+=E+"==="+R+":::"+L+";;;"}}var w=i?r.find("#prdTaxDet"+t):$("#prdTaxDet"+t);w.val(F),w.data("serviceIdVsName",N);var A=i?r.find("#prdAllTax"+t):$("#prdAllTax"+t);A.val(JSON.stringify(y)),A.data("sortedTaxNames",a.hdnPrdSortedTaxs),S=productDetails.getRoundOffValue(S,!0);var k=i?r.find("#tax"+t):$("#tax"+t);k.val(S),k.parent().find(".taxval").text(S);var M=parseFloat(b)+parseFloat(S);M=productDetails.getRoundOffValue(M,!0);var V=i?r.find("#netTotal"+t):$("#netTotal"+t);V.val(M),V.parent().find(".netTot").text(M),Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal(t,i)},getTaxDisplayName:function(t,e){return e=isNaN(e)?"0.0":-1==(e+"").indexOf(".")?e?(e+"").trim()+".0":"0.0":(e+"").trim(),parseFloat(e)<0?t.trim()+" - ("+e+" %)":t.trim()+" - "+e+" %"},isTaxDisplayName:function(t){return t&&t.indexOf("%")>-1&&t.indexOf("-")>-1},getTaxTypeAndValue:function(t){var e=[],a=t.lastIndexOf("-"),i=t.substring(a);return-1!=i.indexOf("%)")?(t=t.substring(0,t.lastIndexOf("-")),e[0]=t.substring(0,t.lastIndexOf("-")-1),e[1]=i.substring(0,i.indexOf("%")).trim()):(e[0]=t.substring(0,a).trim(),e[1]=t.substring(a+1,t.lastIndexOf("%")).trim()),e},setValuesForAddedRowNew:function(t,e,a){var i=null;$("#hrow"+t).removeClass("hide"),a&&(i=$("#multipleFieldsEditPop #duringTabDivs div.current"));var r=e;try{e=JSON.parse(e)}catch(t){e=r}(a?i.find("#hdnProductId"+t):$("#hdnProductId"+t)).val(e.id),(a?i.find("#txtProductSpan"+t):$("#txtProductSpan"+t)).text(e.Product_Name),(a?i.find("#txtProduct"+t):$("#txtProduct"+t)).val(e.Product_Name);var l=null!=e.Product_Code?e.Product_Code:"";(a?i.find("#txtProductCodeSpan"+t):$("#txtProductCodeSpan"+t)).text(""==l?"":"("+l+")"),(a?i.find("#hdnProductCode"+t):$("#hdnProductCode"+t)).val(l),(a?i.find("#itemDescription"+t):$("#itemDescription"+t)).val(e.Description);var s=parseFloat(e.Unit_Price);isNaN(s)&&(s=0),(a?i.find("#pbIcon"+t):$("#pbIcon"+t)).attr("style","visibility:hidden");var n=$("#Crm_"+productDetails.module+"_CURRENCYISOCODE").val(),o=Crm.userDetails.BASE_CURRENCY,d=1;null!=n&&null!=o&&n!=o&&null!=Crm.userDetails.CURRENCY_DETAILS[n]&&null!=Crm.userDetails.CURRENCY_DETAILS[o]&&(d=Crm.userDetails.CURRENCY_DETAILS[n]?Crm.userDetails.CURRENCY_DETAILS[n].er:Crm.userDetails.CURRENCY_DETAILS[o].er),s*=d,s=productDetails.getRoundOffValue(s,!0),a?i.find("#txtListPrice"+t).val(s):$("#txtListPrice"+t).val(s),a?i.find("#hdnUnitPrice"+t).val(s):$("#hdnUnitPrice"+t).val(s);var c=parseFloat(1);a?i.find("#txtQty"+t).val(c):$("#txtQty"+t).val(c),a?i.find("#hdnOldQty"+t).val(c):$("#hdnOldQty"+t).val(c);var u=e.Qty_in_Stock;a?i.find("#hdnQtyStock"+t).val(u):$("#hdnQtyStock"+t).val(u);var p=s*c;p=productDetails.getRoundOffValue(p,!0);var v=a?i.find("#total"+t):$("#total"+t);v.val(p),v.parent().find(".amntFP").text(p);var m=a?i.find("#discount"+t):$("#discount"+t);m.val(0),m.parent().find(".discVal").text(0);var f=p-0;f=productDetails.getRoundOffValue(f,!0);var h=e.TaxDetails;h||(h={});var g=0,D=e.Taxable;a?i.find("#isTaxable"+t).val(D):$("#isTaxable"+t).val(D);var T="",x=h?Object.keys(h):[],I=productDetails.autoPopulateTax||!Crm.userDetails.TAX_MIGRATION_COMPLETED?x:[];0==D||"false"==D?(D=!1,h={}):D=!0;var P={};for(var C in h){var b;if(Crm.userDetails.TAX_MIGRATION_COMPLETED?(b=h[C][1],P[C]=h[C][0]):b=h[C],I.contains(C)){var y=f*parseFloat(b)/100;g+=y,T+=C+"==="+b+":::"+y+";;;"}}var _=a?i.find("#prdTaxDet"+t):$("#prdTaxDet"+t);_.val(T),_.data("serviceIdVsName",P);var S=a?i.find("#prdAllTax"+t):$("#prdAllTax"+t);S.val(JSON.stringify(h)),S.data("sortedTaxNames",e.Tax?e.Tax:[]),g=productDetails.getRoundOffValue(g,!0);var O=a?i.find("#tax"+t):$("#tax"+t);O.val(g),O.parent().find(".taxval").text(g);var F=parseFloat(f)+parseFloat(g);F=productDetails.getRoundOffValue(F,!0);var N=a?i.find("#netTotal"+t):$("#netTotal"+t);N.val(F),N.parent().find(".netTot").text(F),Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal(t,a)},isListPriceEmpty:function(){for(var t=1;t<500;t++){var e=$("#txtListPrice"+t);if(!(e.length>0))return!1;if(""==e.val().trim())return!0}return!1},calculateForLine:function(t,e,a){$("#multipleFieldsEditPop").is(":visible")&&$("#multipleFieldsEditPop #duringTabDivs div.current");var i=$("#txtListPrice"+t).val(),r=$("#txtQty"+t).val();(isNaN(r)||""==r)&&(r=1,$("#txtQty"+t).val(r)),$("#hdnOldQty"+t).val(r),(isNaN(i)||""==i)&&(i=0);var l=parseFloat(r)*parseFloat(i);l=productDetails.getRoundOffValue(l,!0),$("#total"+t).val(l),$("#total"+t).parent().find(".amntFP").text(l);var s=$("#hdnPriceBookId"+t).val(),n=0,o=l;if(1==e)if("fromPb"==productDetails.discStatus&&null!=s&&""!=s&&null!=i&&""!=i&&null!=r&&""!=r){var d=Crm.getCrmBasePath()+"/CreateInventory.do?action=getReductionPrice&quantity="+r+"&listPrice="+i+"&bookId="+s+"&isload=true";new crmRequestPool;mR(d,(function(e){if(null!=e){if(-1!=e.toString().indexOf("PRICEBOOK_NOT_ACCESSIBLE"))return void renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("crm.security.error"));i=productDetails.getRoundOffValue(e,!1),n=l-i,n=productDetails.getRoundOffValue(n,!0),$("#discount"+t).val(n),$("#discount"+t).parent().find(".discVal").text(n);var i=l-n;i=productDetails.getRoundOffValue(i,!0),$("#totalAfterDiscount"+t).val(i);var r=0,s="";if(null!=(p=$("#prdTaxDet"+t).val())&&""!=p)for(var o=p.split(";;;"),d=o.length-1,c=0;c<d;c++){var u=o[c],p=u.split("===")[1],v=parseFloat(p.split(":::")[0]),m=i*v/100;r+=m,s+=u.split("===")[0]+"==="+v+":::"+m+";;;"}r=productDetails.getRoundOffValue(r,!0),$("#prdTaxDet"+t).val(s),$("#tax"+t).val(r),$("#tax"+t).parent().find(".taxval").text(r);var f=parseFloat(i)+parseFloat(r);a&&(f=i),f=productDetails.getRoundOffValue(f,!0),$("#netTotal"+t).val(f),$("#netTotal"+t).parent().find(".netTot").text(f),Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal()}}))}else if("percent"==productDetails.discStatus||"fromPb"==productDetails.discStatus&&(null==s||""==s)){var c=productDetails.getRoundOffValue($("#discPc"+t).val(),!0);n=l*c/100}else"dirPrice"==productDetails.discStatus&&(n=$("#discount"+t).val());else n=$("#discount"+t).val();if("fromPb"!=productDetails.discStatus||null==e||"fromPb"==productDetails.discStatus&&(null==s||""==s)){n=productDetails.getRoundOffValue(n,!0),$("#discount"+t).val(n),$("#discount"+t).parent().find(".discVal").text(n);o=l-n;o=productDetails.getRoundOffValue(o,!0),$("#totalAfterDiscount"+t).val(o);var u=0,p="";if(null!=(g=$("#prdTaxDet"+t).val())&&""!=g)for(var v=g.split(";;;"),m=v.length-1,f=0;f<m;f++){var h=v[f],g=h.split("===")[1],D=parseFloat(g.split(":::")[0]),T=o*D/100;u+=T,p+=h.split("===")[0]+"==="+D+":::"+T+";;;"}u=productDetails.getRoundOffValue(u,!0),$("#prdTaxDet"+t).val(p),$("#tax"+t).val(u),$("#tax"+t).parent().find(".taxval").text(u);var x=parseFloat(o)+parseFloat(u);a&&(x=o),x=productDetails.getRoundOffValue(x,!0),$("#netTotal"+t).val(x),$("#netTotal"+t).parent().find(".netTot").text(x),Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal()}},fillCurrSymForGrandVals:function(){var t=productDetails.currencySymbol,e=$("#subTotal"),a=$("#grandTotal"),i=$("#txtDiscount"),r=$("#txtTax"),l=$("#txtAdjustment");e.parent().find(".grandVals").text(t+" "+e.val()),a.parent().find(".grandVals").text(t+" "+a.val()),i.parent().parent().find(".grandVals").text(t+" "+i.val()),r.parent().parent().find(".grandVals").text(t+" "+r.val()),l.parent().parent().find(".grandVals").text(t+" "+l.val())},calculateGrandTotal:function(t,e){var a=null;(e=!e&&$("#multipleFieldsEditPop").is(":visible"))&&(a=$("#multipleFieldsEditPop #duringTabDivs div.current"));var i=e?a.find("#txtDiscount"):$("#txtDiscount");null==t&&(t=e?a.find("#totalProductCount").val():$("#totalProductCount").val());for(var r=0,l=1;l<=t;l++)r+=parseFloat(e?a.find("#netTotal"+l).val():$("#netTotal"+l).val());var s,n=parseFloat(e?a.find("#discPc").val():$("#discPc").val());s=0!=(n=productDetails.getRoundOffValue(n,!0))?r*n/100:parseFloat(i.val());var o=0,d=e?a.find("#recordTaxDet").val():$("#recordTaxDet").val(),c=(d=d||"").split(";;;"),u=c.length-1;for(l=0;l<u;l++){var p=c[l].split("===")[1],v=(r-s)*parseFloat(p.split(":::")[0])/100;o+=parseFloat(productDetails.getRoundOffValue(v,!0))}var m=parseFloat(e?a.find("#txtAdjustment").val():$("#txtAdjustment").val());(isNaN(m)||""==m)&&(m=0),o=productDetails.getRoundOffValue(o,!0);var f=r-s+parseFloat(o)+m;r=productDetails.getRoundOffValue(r,!0),s=productDetails.getRoundOffValue(s,!0),f=productDetails.getRoundOffValue(f,!0);var h=e?a.find("#subTotal"):$("#subTotal");h.val(r).trigger("change"),h.parent().find(".grandVals").text(productDetails.currencySymbol+" "+r),i.val(s).trigger("change"),i.parent().find(".grandVals").text(productDetails.currencySymbol+" "+s);var g=e?a.find("#txtTax"):$("#txtTax");g.val(o).trigger("change"),g.parent().find(".grandVals").text(productDetails.currencySymbol+" "+o);var D=e?a.find("#grandTotal"):$("#grandTotal");D.val(f).trigger("change"),D.parent().find(".grandVals").text(productDetails.currencySymbol+" "+f)},showDiscForLine:function(t,e){if(e){var a=$(t).closest("tr").find("#subvalue_TOTALAFTERDISCOUNT").text().trim();a=void 0!==a&&a.length>0?a:parseFloat("0.00"),$("#pbDiscInfo").is(":visible")||renderingUtils.zctt.showtt(I18n.getMsg("TotalAfterDiscount")+" : "+productDetails.currencySymbol+" "+a)}else renderingUtils.zctt.showtt(I18n.getMsg("TotalAfterDiscount")+" : "+productDetails.currencySymbol+" "+$(t).parent().find(".getAftrDisc").val())},showTaxForLine:function(t){var e=$(t).parent().find(".prdTaxDet"),a=e.val(),i=e.data().serviceIdVsName,r="<table>",l=0;if(null!=a&&""!=a){var s=a.split(";;;");l=s.length-1;for(var n=0;n<l;n++){var o=s[n],d=(a=o.split("===")[1],o.split("===")[0]),c=a.split(":::")[0];!0===Crm.userDetails.TAX_MIGRATION_COMPLETED?r+="<tr><td> "+productDetails.getTaxDisplayName(i[d],c)+" </td></tr>":r+="<tr> <td> "+d+" </td> <td> : </td> <td> &nbsp; "+c+"% </td></tr>"}}0===l&&(r+="<tr> <td>"+I18n.getMsg("crm.tax.association.check")+"</td> </tr>"),r+="</table>",renderingUtils.zctt.showtt(r)},getRoundOffValue:function(t,e,a){if(void 0!==a){var i=Math.pow(10,a),r=Math.sign(parseFloat(t)*i)*Math.round(Math.abs((parseFloat(t)*i).toFixed(a)));return e?(r/i).toFixed(a):r/i}r=Math.sign(parseFloat(t)*productDetails.roundOffPrecision)*Math.round(Math.abs((parseFloat(t)*productDetails.roundOffPrecision).toFixed(productDetails.roundOff)));return e?(r/productDetails.roundOffPrecision).toFixed(productDetails.roundOff):r/productDetails.roundOffPrecision},calcDisc:function(t,e){var a=0,i=parseFloat($("#total"+e).val());if($(t).attr("class").indexOf("discPc")<0){a=$(t).val(),(isNaN(a)||""==a)&&(a=0);var r=0;r=productDetails.getRoundOffValue(r,!0),$(t).parent().parent().parent().parent().find(".discPc").val(r)}else{(r=$(t).val())||(r=0),a=i*r/100,a=productDetails.getRoundOffValue(a,!0),$(t).parent().parent().parent().parent().find(".directPrice").val(a),$("#discPc"+e).val(r)}$("#discount"+e).val(a),productDetails.calculateForLine(e)},calcTax:function(t){for(var e=$("#taxPop").find(".taxRow"),a=0,i="",r=e.length,l=0;l<r;l++){var s=e[l],n=$(s).children()[0],o=$(n).text(),d=$(s).find(".editTax").val();(isNaN(d)||""==d)&&(d=0),d=parseFloat(d);var c=parseFloat($(s).find(".taxVal").val());a+=c,i+=o+"==="+d+":::"+c+";;;"}a=productDetails.getRoundOffValue(a,!0),$("#tax"+t).val(a),$("#prdTaxDet"+t).val(i),productDetails.calculateForLine(t),$("#editRowTaxPop").hide()},showGrandDiscPop:function(t){var e=$("#discountPop"),a=$(t),i=$("#multipleFieldsEditPop").is(":visible"),r=i?a.position().left:a.offset().left,l=i?a.position().top:a.offset().top,s=a.innerHeight();event.stopPropagation();var n=parseFloat($("#txtDiscount").val()),o=parseFloat($("#subTotal").val()),d=0;0!=o&&(d=productDetails.getRoundOffValue(n/o*100,!0));var c=e.find(".discPc"),u=e.innerWidth(),p=$(c);p.val(d);var v=e.find(".directPrice");$(v).val(n),$("#taxesPop").find("div").hide(),e.removeClass("hide");var m=$("#frmBook");m.parent().hide(),e.show().css({left:r-u/2,top:l+s+10});var f=e.find(".roundCheck");f.filter(":visible").last().parent().parent().removeClass("br_bottom_border4"),Crm.userDetails.TAX_MIGRATION_COMPLETED?($("#saveDiscountType").off("click").on("click",(function(){var t=$("#discountPop");"percent"===$("#inventrydiscountPop:checked").val()?productDetails.calcGrandDisc($(t.find(".discPc"))):productDetails.calcGrandDisc($(t.find(".directPrice"))),t.hide()})),$("#cancelDiscountType").off("click").on("click",(function(){$("#discountPop").hide()}))):(p.off("keyup"),p.keyup((function(){productDetails.calcGrandDisc(this)})),$(v).off("keyup"),$(v).keyup((function(){productDetails.calcGrandDisc(this)})),m.find(".roundCheck").click((function(){$("#txtQty"+id).focus()}))),$(".discType").click((function(){var t=$(this).parent(),e=t.find(".decimalFld");t.parent().parent().find(".decimalFld").parent().css("visibility","hidden"),e.parent().css("visibility","visible"),e.focus()})),$(".noEventDiv").click((function(){var t=$(this),e=t.parent(),a=e.find(".decimalFld");t.find(".discType").prop("checked",!0),e.parent().parent().find(".decimalFld").parent().css("visibility","hidden"),a.parent().css("visibility","visible"),a.focus()})),f.first().trigger("click")},calcGrandDisc:function(t){var e=$(t),a=0,i=0,r=parseFloat($("#subTotal").val());e.attr("class").indexOf("discPc")<0?((a=e.val())||(a=0),i=100*(a=productDetails.getRoundOffValue(a,!0))/r,i=productDetails.getRoundOffValue(i,!0),$("#discPc").val(0),e.parent().parent().parent().parent().find(".discPc").val(i)):((i=e.val())||(i=0),$("#discPc").val(i),a=r*i/100,a=productDetails.getRoundOffValue(a,!0),e.parent().parent().parent().parent().find(".directPrice").val(a)),$("#txtDiscount").val(a),Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal()},showGrandTaxPop:function(t){var e=$("#grandTaxPop"),a=$("#subTotal"),i=$("#txtDiscount");event.stopPropagation();var r=$(t),l=$("#multipleFieldsEditPop").is(":visible"),s=l?r.position().left:r.offset().left,n=l?r.position().top:r.offset().top,o=r.innerHeight(),d=e.outerWidth(),c=parseFloat(a.val())-parseFloat(i.val()),u="<div>";if(null==(I=$("#recordTaxDet").val())||""==I||"create"==window[productDetails.module].currentStatus&&!productDetails.grandTaxChanged){if(null!=(I=JSON.parse(productDetails.newAllTaxes)))for(var p=objectUtils.getKeys(I),v=p.length-1,m=0;m<=v;m++){x=(D=I[x=p[m]])[0];var f=c*(D=D[1])/100;u+='<div class="taxRow"> <p class="crm-small-font-size crm-font-bold crmBaseColor taxName"> '+$ESAPI.encoder().encodeForHTML(x)+' </p> <div class="pT10 pB10 br_bottom_border4 mB10"><input type="text" size="5" class="newinputText1 decimalFld editTax alignRight" value="'+$ESAPI.encoder().encodeForHTMLAttribute(D)+'"> <b class="pL5">%</b> <input type="text" class="newinputText1 mL10 taxVal alignRight decimalFld" readonly="true" size="5" value="'+f+'"> <label class="pL5"> </label></div> </div>'}}else{var h=I.split(";;;"),g=h.length-1;for(m=0;m<g;m++){var D,T=h[m],x=T.split("===")[0],I=T.split("===")[1],P=c*(D=parseFloat(I.split(":::")[0]))/100;u+='<div class="taxRow"> <p class="crm-small-font-size crm-font-bold crmBaseColor taxName"> '+$ESAPI.encoder().encodeForHTML(x)+' </p> <div class="pT10 pB10 br_bottom_border4 mB10"><input type="text" size="5" class="newinputText1 decimalFld editTax alignRight" value="'+D+'"> <b class="pL5">%</b> <input type="text" class="newinputText1 mL10 taxVal alignRight decimalFld" readonly="true" size="5" value="'+P+'"> <label class="pL5"> </label></div> </div>'}}u+='<input type="button" onclick="productDetails.calcGrandTax()" class="primarybtn" value="'+I18n.getMsg("crm.button.apply")+'"> </div>',e.children().remove(),e.append(u),$("#discountPop").hide(),e.removeClass("hide"),e.show().css({left:s-70-d/2,top:n+o+10}),$(".editTax").keyup((function(){var t=$(this).val();(isNaN(t)||""==t)&&(t=0);var e=t/100*(parseFloat(a.val())-parseFloat(i.val())),r=$(this).parent().find(".taxVal");e=productDetails.getRoundOffValue(e,!0),$(r).val(e)}))},editGrandTax:function(t){productDetails.serviceIdVsPercent&&delete productDetails.serviceIdVsPercent;var e=$("#grandTaxPop"),a=e.outerWidth(),i=$(t),r=i.innerHeight(),l=$("#multipleFieldsEditPop").is(":visible")?i.position():i.offset(),s=l.left-70,n=l.top;$("#discountPop").hide(),$("#taxPop").empty().hide(),event.stopPropagation();var o=[],d=[],c={},u=0,p=parseFloat($("#subTotal").val())-parseFloat($("#txtDiscount").val()),v=$("#recordTaxDet").val(),m='<div class="selectTaxdiv"><div class="crm-heading-font-size crm-font-bold mB10">'+I18n.getMsg("crm.tax.select")+"</div>";if(v)for(var f=v.split(";;;"),h=f.length-1,g=0;g<h;g++){u++;var D=(_=f[g]).split("==="),T=D[0],x=D[0];productDetails.isTaxDisplayName(x)?x=productDetails.getTaxTypeAndValue(x)[0]:(x=productDetails.taxIdVsName[x][0],o.push(T));var I=D[1].split(":::")[0],P=productDetails.isTaxDisplayName(D[0])?D[0]:productDetails.getTaxDisplayName(x,I);d.push(P.toLowerCase());var C=p*(I=parseFloat(I))/100;C=productDetails.getRoundOffValue(C,!0),m+=productDetails.constructTaxRow(!0,x.trim(),I+"",C,-1,u,"grand",T),null==c[T]&&(c[T]=I)}var b=productDetails.sortedOrgTax?productDetails.sortedOrgTax.length:0,y=JSON.parse(productDetails.newAllTaxes);for(g=0;g<b;g++){var _,S=y[_=productDetails.sortedOrgTax[g]];o.contains(S[2])||(d.contains(_.toLowerCase())||(u++,d.push(_.toLowerCase()),m+=productDetails.constructTaxRow(!1,S[0],S[1],void 0,-1,u,"grand",_),null==c[_]&&(c[_]=parseFloat(S[1]))))}m+='<div class="selectTaxbtnSec mT10"><input type="button" onclick="productDetails.saveGrandTax()" class="primarybtn btn_sml" value="'+I18n.getMsg("crm.button.done")+'"> <input class="newgraybtn btn_sml" type="button" onclick="productDetails.cancelGrandTax()" value="'+I18n.getMsg("crm.button.cancel")+'"/></div></div>',e.html(m).removeClass("hide").show().css({left:s-a/2,top:n+r+10}),$(".taxActiveElement").removeClass("taxActiveElement"),$("#grandTaxDispSpan").addClass("taxActiveElement"),loadClassFns3(),productDetails.canEditTaxValue||productDetails.bindMouseOverActionForRestrictTaxEdit(),productDetails.serviceIdVsPercent=c},saveGrandTax:function(){event.stopPropagation();var t=!1,e=$("input.grandTax:checked"),a="",i=e.length;$(".taxValError").addClass("dN");for(var r=0;r<i;r++){var l=$(e[r]),s=l.val().trim(),n=$("#grandTaxVal"+l.attr("id")).text().trim();if(n=productDetails.getTaxPercentString(n),isNaN(n)||n>100||n<-100)$("#grandTaxValError"+l.attr("id")).removeClass("dN"),t=!0;else if(!t){if(null==productDetails.serviceIdVsPercent[s]||!productDetails.canEditTaxValue&&productDetails.serviceIdVsPercent[s]!=parseFloat(n))continue;a+=s+"==="+n+";;;"}}if(t)return!1;$("#recordTaxDet").val(a),productDetails.grandTaxChanged=!0,Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal(),productDetails.cancelGrandTax()},cancelGrandTax:function(){event.stopPropagation(),$("#grandTaxPop").empty().hide(),productDetails.serviceIdVsPercent&&delete productDetails.serviceIdVsPercent,$("#grandTaxDispSpan").removeClass("taxActiveElement")},getTaxPercentString:function(t){return isNaN(t)||(-1==(t+"").indexOf(".")?t+=".0":0==(t+"").indexOf(".")&&(t="0"+t)),t},calcGrandTax:function(){for(var t=$("#grandTaxPop"),e=t.find(".editTax"),a="",i=e.length,r=0;r<i;r++){var l=e[r],s=$(l).val();(isNaN(s)||""==s)&&(s=0),a+=$(l).parent().parent().find(".taxName").text()+"==="+s+":::"+$(l).parent().find(".taxVal").val()+";;;"}$("#recordTaxDet").val(a),t.hide(),productDetails.grandTaxChanged=!0,Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal()},deleteARow:function(t){var e=$("#totalProductCount"),a=$("#linesTbody");if(confirm(I18n.getMsg("crm.inventory.alert.delete.lineitem"))){var i=$(t).parent().parent(),r=$(i).attr("id");r=parseInt(r.split("hrow")[1]);var l=parseInt(e.val());if(r!=l)for(var s=r+1;s<=l;s++){var n=a.find("#hrow"+s);productDetails.reorderRow(n,s-1)}delete Crm.requestParam["property(hdnProductId"+r+")"],delete Crm.requestParam["property(hdnInvRelId"+r+")"],delete Crm.requestParam["property(hdnProductCode"+r+")"],delete Crm.requestParam["property(hdnProductName"+r+")"],delete Crm.requestParam["property(itemDescription"+r+")"],delete Crm.requestParam["property(txtListPrice"+r+")"],delete Crm.requestParam["property(hdnPriceBookId"+r+")"],delete Crm.requestParam["property(hdnUnitPrice"+r+")"],delete Crm.requestParam["property(txtQty"+r+")"],delete Crm.requestParam["property(hdnOldQty"+r+")"],delete Crm.requestParam["property(hdnQtyStock"+r+")"],delete Crm.requestParam["property(hdnTotal"+r+")"],delete Crm.requestParam["property(hdnTotalAfterDiscount"+r+")"],delete Crm.requestParam["property(hdnDiscount"+r+")"],delete Crm.requestParam["property(hdnTax"+r+")"],delete Crm.requestParam["property(hdnPrdTaxDet"+r+")"],delete Crm.requestParam["property(hdnNetTotal"+r+")"],$(t).parent().parent().remove();var o=l-1;e.val(o);var d=$("#singlePbTable");0==o&&($("#linesTable").parent().hide(),$("#productList").find(".pB20").hide(),d.show(),d.children(0).children(0).find(".PriceBooks-Small").show(),d.children(0).children(0).find(".clear_lookupfield").show(),$("#addLinesBtnLwr").show()),Crm.userDetails.isLookupAdvancedSearchEnabledInLineItem&&1===o&&$(".icon_close").addClass("hide"),Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal()}},reorderRow:function(t,e){var a=$(t).children(),i=$(t).children()[0];if(Crm.userDetails.isLookupAdvancedSearchEnabledInLineItem&&t.length>0){var r=$(t),l=r.find("input.ui-autocomplete-input"),s=l.data(),n=s.rownumber;l.attr("id","Crm_"+s.module+"_"+s.colname+"_"+e),l.attr("data-zcqa","lookup_"+s.colname+"_"+e),l.data("zcqa","lookup_"+s.colname+"_"+e),l.attr("data-rownumber",e),l.data("rownumber",e);var o=r.find("#hdnProductId"+n);o.attr("id","hdnProductId"+e),o.attr("name","property(hdnProductId"+e+")");var d=r.find("#hdnProductCode"+n);d.attr("id","hdnProductCode"+e),d.attr("name","property(hdnProductCode"+e+")");var c=r.find("#hdnInvRelId"+n);c.attr("id","hdnInvRelId"+e),c.attr("name","property(hdnInvRelId"+e+")");var u=r.find("#txtProduct"+n);u.attr("id","txtProduct"+e),u.attr("name","property(hdnProductName"+e+")");var p=r.find(".Products-small");p.attr("id","Crm_"+s.module+"_"+s.colname+"_"+e+"_img"),p.attr("data-label","Crm_"+s.module+"_"+s.colname+"_"+e),p.data("label","Crm_"+s.module+"_"+s.colname+"_"+e),p.attr("data-zcqa","lookup_"+s.colname+"_"+e),p.data("zcqa","lookup_"+s.colname+"_"+e);var v=r.find(".clear_lookupfield");v.attr("id","Crm_"+s.module+"_"+s.colname+"_"+e+"_img"),v.attr("data-zcqa","lookup_"+s.colname+"_"+e+"_close"),v.data("zcqa","lookup_"+s.colname+"_"+e+"_close"),r.find(".lookuploader").attr("id","Crm_"+s.module+"_"+s.colname+"_"+e+"_loadimg");var m=r.find("#itemDescription"+n);m.attr("id","itemDescription"+e),m.attr("name","property(itemDescription"+e+")")}else{var f=$(i).children()[0];$(f).attr("name","property(hdnProductId"+e+")"),$(f).attr("id","hdnProductId"+e),f=$(i).find(".bold"),$(f).parent().attr("onmouseover","productDetails.showPrdDetInEdit("+e+")"),$(f).attr("id","txtProductSpan"+e),f=$(f).next(),$(f).attr("id","txtProductCodeSpan"+e),f=$(f).next(),$(f).attr("name","property(hdnProductCode"+e+")"),$(f).attr("id","hdnProductCode"+e),f=$(i).children()[2],$(f).attr("name","property(hdnInvRelId"+e+")"),$(f).attr("id","hdnInvRelId"+e),f=$(i).children()[3],$(f).attr("name","property(hdnProductName"+e+")"),$(f).attr("id","txtProduct"+e),f=$(i).children()[4],$(f).attr("name","property(itemDescription"+e+")"),$(f).attr("id","itemDescription"+e)}var h=$(t).children()[1];i=$(h).children()[0],f=$(i).children()[0],$(f).attr("name","property(txtListPrice"+e+")"),$(f).attr("onblur","productDetails.calculateForLine("+e+", true)"),$(f).attr("id","txtListPrice"+e),f=$(i).children()[1],$(f).attr("name","property(hdnPriceBookId"+e+")"),$(f).attr("id","hdnPriceBookId"+e),f=$(i).children()[2],$(f).attr("name","property(hdnPriceBookIdClone"+e+")"),$(f).attr("id","hdnPriceBookIdClone"+e),f=$(i).children()[3],$(f).attr("name","property(hdnPriceBookName"+e+")"),$(f).attr("id","hdnPriceBookName"+e),i=$(h).children()[1],f=$(i).children()[0],$(f).attr("onclick","Crm.showLookUp('"+productDetails.module+"','property(txtListPrice"+e+")','hdnPriceBookId"+e+"','Product Details','PriceBooks','','','property(hdnProductId"+e+")')"),$(f).attr("id","pbIcon"+e),f=$(i).children()[1],$(f).attr("name","property(hdnUnitPrice"+e+")"),$(f).attr("id","hdnUnitPrice"+e),i=$(t).children()[2],f=$(i).children()[0],$(f).attr("name","property(txtQty"+e+")"),$(f).attr("onblur","productDetails.calculateForLine("+e+", true)"),$(f).attr("id","txtQty"+e),f=$(i).children()[1],$(f).attr("name","property(hdnOldQty"+e+")"),$(f).attr("id","hdnOldQty"+e),f=$(i).children()[2],$(f).attr("name","property(hdnQtyStock"+e+")"),$(f).attr("id","hdnQtyStock"+e),i=$(t).children()[3],f=$(i).children()[1],$(f).attr("name","property(hdnTotal"+e+")"),$(f).attr("id","total"+e),i=$(t).children()[4];h=$(i).children()[0];f=$(h).children()[1],$(f).attr("name","property(hdnTotalAfterDiscount"+e+")"),$(f).attr("id","totalAfterDiscount"+e),f=$(h).children()[2],$(f).attr("name","property(hdnDiscount"+e+")"),$(f).attr("id","discount"+e),f=$(h).children()[3],$(f).attr("name","property(hdnDiscPc"+e+")"),$(f).attr("id","discPc"+e);var g=$(a[5]).children(),D=$(g[0]),T=D.children();f=T[1],$(D).attr("id","inlineValueContainer"+e),$(f).attr("name","property(hdnTax"+e+")"),$(f).attr("id","tax"+e),$(T[2]).attr({name:"property(hdnPrdTaxDet"+e+")",id:"prdTaxDet"+e}),$(T[3]).attr("id","prdAllTax"+e),Crm.userDetails.TAX_MIGRATION_COMPLETED&&$($(g[1]).children()[0]).attr({id:"taxInlineEditIcon"+e,onclick:"productDetails.editLineItemTax(this,"+e+");sE(event)"}),i=$(t).children()[6],f=$(i).children()[1],$(f).attr("name","property(hdnNetTotal"+e+")"),$(f).attr("id","netTotal"+e),i=$(t).children()[8],f=$(i).children()[1],$(f).attr("id","isTaxable"+e),$(t).attr("class","pl_"+e+" cTax sort helperBG"),$(t).attr("id","hrow"+e)},fillCurrencySymbolsInLineHeaders:function(t,e){var a,i=t?$("#multipleFieldsEditPop #"+e+"_rlContainer #lineHeaderRow"):$("#lineHeaderRow"),r=productDetails.currencySymbol,l=i.children()[1];(a=$(l).text()).indexOf("(")>-1&&(a=a.substring(0,a.indexOf("("))),$(l).html(a+' <span class="crm-font-regular"> ('+r+") </span>"),l=i.children()[3],(a=$(l).text()).indexOf("(")>-1&&(a=a.substring(0,a.indexOf("("))),$(l).html(a+' <span class="crm-font-regular"> ('+r+") </span>"),l=i.children()[4],(a=$(l).text()).indexOf("(")>-1&&(a=a.substring(0,a.indexOf("("))),$(l).html(a+' <span class="crm-font-regular"> ('+r+") </span>"),l=i.children()[5],(a=$(l).text()).indexOf("(")>-1&&(a=a.substring(0,a.indexOf("("))),$(l).html(a+' <span class="crm-font-regular"> ('+r+") </span>"),l=i.children()[6],(a=$(l).text()).indexOf("(")>-1&&(a=a.substring(0,a.indexOf("("))),$(l).html(a+' <span class="crm-font-regular"> ('+r+") </span>")},saveNewProduct:function(t,e,a){productDetails.debugVar+=" lineInFocus obj in saveNewProduct ----\x3e "+searchStats.lineInFocus+" ;;; ",productDetails.debugVar+=" lineInFocus id in saveNewProduct ----\x3e "+$(searchStats.lineInFocus).attr("id")+" ;;; ",productDetails.debugVar+="Searched value ---\x3e "+searchStats.searchText+" ;;; ",productDetails.debugVar+="Value in text box before save product -----\x3e "+$(searchStats.lineInFocus).val()+" ;;; ";var i=$(".comboSelect");if(i.length>0)for(var r=i.length,l=0;l<r;l++){var s=i[l],n=$(s).val();if(null!=n){for(var o="",d=n.length,c=0;c<d;c++)o+=n[c],c!=n.length-1&&(o+=";");var u=$(s).next();"input"===u[0].tagName?u.val(o):u.next().val(o)}}var p=!0;try{p=validationUtils.formValidate("newQCProductForm",t,e,a,"inline")}catch(t){}p&&new Promise((function(t){t(CVRExec.evalRules("edit","Products"))})).then((function(t){if(t){var e=getObj("newQCProductForm"),a=e.action,i="";-1!=a.indexOf("?")&&(i=a.substring(a.indexOf("?")+1),a=a.substring(0,a.indexOf("?"))),i=(i=i+"&targetForm="+e.target+"&"+csrfParamName+"="+encodeURIComponent(csrfToken))+"&"+commonUtils.formData2QueryString(e);var r=getHTTPObject();r.open("POST",a,!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),r.onreadystatechange=function(){if(4==r.readyState){if(r.status==crmConstants.errorStatusCode)return void renderingUtils.displayPermissionDenied(r);var t=r.responseText,e=JSON.parse(t);if("DUPLICATE"===e.STATUS){commonUtils.hideDuplicateErrorMsg("newQCProductForm");for(var a=e.INFO.length,i=0;i<a;i++){var l=e.INFO[i],s=l.FIELDLABEL,n=l.MODULE,o=commonUtils.getDuplicateErrorMsg(l,!1),d=l.ISCF&&"1"==l.ISCF?l.COLUMNNAME:s,c=$("#property\\("+d+"\\)");c&&0!==c.length||(c=$("[name='property\\("+d+"\\)']"))&&0!==c.length||(c=$("#Crm_"+n+"_"+d)),commonUtils.showErrorMsg(o,c,n),c.focus()}return void commonUtils.showHideLoadingDiv()}if((e=e.newPrdDet).ISAPPROVED&&7==e.ISAPPROVED){Lyte.Component.render("crm-reviewprocess-reviewpop",{moduleName:e.module},"#tabLayer");var u=$L("#rpRecordInReview")[0];return u.ltProp("message",I18n.getMsg("crm.reviewprocess.record.entered.lookup.customview.msg",e.module)),u.ltProp("show",!0),hideAnimatePopup("searchCreatePopup"),void($L("#codein1")[0].value="")}var p=e["Product Name"],v=e["Product Code"],m=p+" ("+v+")";null!=v&&""!=v||(m=p);var f=$(searchStats.lineInFocus);productDetails.debugVar+="Value in text box just before changing it -----\x3e "+f.val()+" ;;; ",f.val(m),productDetails.debugVar+="Value in text box after changing -----\x3e "+f.val()+" ;;; ",f.attr("style","border : 1px solid #fff");var h=f.parent().parent();e=JSON.stringify(e),h.find(".hdnPrdDet").val(e),h.find(".icon_roundinfo").removeClass("hide"),$(searchStats.lineInFocus).next().addClass("ui-helper-hidden-accessible"),$(searchStats.lineInFocus).parent().find(".helper").remove(),$("#addAnotherLine").removeClass("vH"),productDetails.cancelNewProduct(!1)}},r.send(i)}}))},cancelNewProduct:function(t){$("#multipleFieldsEditPop").is(":visible");$("#productPopup").animate({left:"700px"}).show(),$("#addpbtn").show(),$("#cancelbtn").show(),$("#searchCreateDiv").hide().animate({left:"500px"}).html(""),hideAnimatePopup("searchCreatePopup"),renderingUtils.showFreezeLayer(),$("#searchCreatePopup").html(""),$(searchStats.lineInFocus).parent().parent().find(".popQty").focus(),1==t&&($(searchStats.lineInFocus).val(""),$(searchStats.lineInFocus).focus())},showProductPopFromFreeze:function(){var t=$("#FreezeLayer");renderingUtils.freezeBackground(),t.css("z-index",20),t.css("opacity","0.2"),$(searchStats.lineInFocus).val(""),$(searchStats.lineInFocus).parent().parent().find(".hdnPrdDet").val(""),$(searchStats.lineInFocus).focus()},showPrdDetInEdit:function(t){renderingUtils.zctt.showtt('<table cellpadding="5" cellspacing="0" border="0" width="100%"> <tbody><tr><td class="crm-small-font-size">'+I18n.getMsg("Unit Price")+'</td> <td class="crm-small-font-size crm-font-bold">'+productDetails.currencySymbol+" "+$("#hdnUnitPrice"+t).val()+'</td></tr>  <tr><td class="crm-small-font-size">'+I18n.getMsg("Qty in Stock")+'</td><td class="crm-small-font-size crm-font-bold">'+$("#hdnQtyStock"+t).val()+"</td></tr></tbody></table>")},showPrdDetInView:function(t){renderingUtils.zctt.showtt('<table cellpadding="5" cellspacing="0" border="0" width="100%"> <tbody><tr><td class="crm-small-font-size">'+I18n.getMsg("Unit Price")+'</td> <td  class="crm-small-font-size crm-font-bold">'+productDetails.currencySymbol+" "+$("#value_hdnUnitPrice"+t).text()+'</td></tr>  <tr><td class="crm-small-font-size">'+I18n.getMsg("Qty in Stock")+'</td><td class="crm-small-font-size crm-font-bold">'+$("#value_hdnQtyStock"+t).text()+"</td></tr></tbody></table>")},showDiscountScheme:function(t,e){event.stopPropagation();var a=$("#pbDiscInfo"),i=$(t),r=i.position().left,l=i.position().top,s=i.closest("td");s.hasClass("rPsubFormTd")&&(r+=s.position().left,l+=s.position().top);var n,o=i.innerHeight(),d=a.hasClass("newDeialViewDiscPop"),c=a.innerWidth();d&&(l=i.closest(".subFrmTablWrapper").position().top+l-15);var u,p,v=i.closest("tr"),m=v.find(".mouseArea___BOOKID"),f=m.length>0?m.data("params").id:"";null==f?f=void 0!==(f=v.find("#subvalue_BOOKID").attr("data-params"))&&f.length>0?JSON.parse(f).id:"":f=void 0!==f&&f.length>0?f:"";if(n=void 0!==(n=m.length>0?m.data("params").pricingDetails:"")?n.pricingRange:"",Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted&&(u=v.find(".mouseArea___DISCOUNT_TYPE"),p=productDetails.getDiscountTypeSystemValueForUserValue(u)),""===f||""===n&&"Price Book"!==p){var h=v.find(".mouseArea___TOTALAFTERDISCOUNT").data("params").rawFormulaCurrency;h=parseFloat(void 0!==h&&h.length>0?h:"0");var g=v.find(".mouseArea___DISCOUNT").data("params").defaultvalue;g=parseFloat(void 0!==g&&g.length>0?g:"0");var D=parseFloat(h)+parseFloat(g);if(0===D||0===g){var T=!1;void 0!==e&&!0===Crm.isCpqActivated()&&("string"==typeof e&&e===moduleRecordMapping.Quotes.api_name||"string"!=typeof e&&void 0!==e.value&&e.value===moduleRecordMapping.Quotes.api_name)&&(T=!0),n=!0===T?I18n.getMsg("cpq.pr.nodiscount"):I18n.getMsg("crm.inventory.lineitem.no.pricebook.new",[moduleRecordMapping.PriceBooks.plural_label])}else{var x=parseFloat(D),I=0===x?0:100*parseFloat(g)/x;if(Crm.userDetails.isDiscountFieldEnhancementMigrationCompleted)I=v.find(".mouseArea___DISCOUNT_PERCENTAGE").data("params").defaultvalue,n="Direct Price"===p?"<span class='dIB'>"+productDetails.getDiscountTypeUserValueForSystemValue(u,p)+"</span>":"<span class='dIB'>"+productDetails.getDiscountTypeUserValueForSystemValue(u,p)+"</span> <span>"+I+"%</span>";else I=productDetails.getRoundOffValue(I,!0),n="<span class='dIB'>"+I18n.getMsg("Discount Percentage")+"</span> <span>"+I+"%</span>"}}a.html(n),a.removeClass("hide"),a.css({left:r-c/2,top:l+o+10}).show(),renderingUtils.zctt.hidett(!0)},showDiscountPop:function(t){event.stopPropagation();var e,a=$(t).position().left,i=$(t).position().top,r=$(t).offset().left,l=$(t).offset().top,s=$(t).innerHeight(),n=null,o=$("#multipleFieldsEditPop");(e=o.is(":visible"))&&(n=$("#multipleFieldsEditPop #duringTabDivs div.current"));var d=e?n.find("#discountPop"):$("#discountPop"),c=d.innerWidth(),u=e?n.find("#frmBook"):$("#frmBook"),p="#hdnPriceBookId",v=$(t).parent(),m=v.parent(),f=parseFloat(m.find(".discAmt").val()),h=parseFloat(m.find(".amntFP").text()),g=0;0!=h&&(g=productDetails.getRoundOffValue(f/h*100,!0));var D=d.find(".discPc"),T=$(D);T.val(g);var x=d.find(".directPrice"),I=$(x);I.val(f);var P=m.attr("id");P=P.split("hrow")[1];var C=e?n.find(p+P):$(p+P),b=!1,y=u.find(".roundCheck");if(null!=C.val()&&""!=C.val()){u.parent().show();var _=e?n.find("#hdnPriceBookId"+P):$("#hdnPriceBookId"+P);null!=_.val()&&""!=_.val()&&y.prop("checked",!0),u.parent().prev().addClass("br_bottom_border4")}else u.parent().hide(),"dirPrice"==productDetails.discStatus?(d.find(".roundCheck").filter(":visible").last().prop("checked",!0),d.find(".roundCheck").filter(":visible").last().css("visibility","visible")):(d.find(".roundCheck").first().prop("checked",!0),d.find(".decimalFld").first().parent().css("visibility","visible")),b=!0;if(e)var S=a,O=i;else S=r,O=l;e?n.find("#taxPop").hide():$("#taxPop").hide(),d.removeClass("hide"),d.show().css({left:S-c/2,top:O+s+10}),$(t).closest("tr").find(".icon_list,.icon_roundNxtarw,.icon_close,.neweditIcon").css("visibility","hidden"),$(t).css("visibility","visible"),b&&u.parent().parent().find(".decimalFld").first().select(),d.find(".roundCheck").filter(":visible").last().parent().parent().removeClass("br_bottom_border4"),Crm.userDetails.TAX_MIGRATION_COMPLETED?($("#saveDiscountType").off("click").on("click",(function(){var t=null,e=$("#multipleFieldsEditPop").is(":visible");e&&(t=$("#multipleFieldsEditPop #duringTabDivs div.current"));var a=e?t.find("#discountPop"):$("#discountPop"),i=$("#inventrydiscountPop:checked").val();"percent"===i?productDetails.calcDisc($(a.find(".discPc")),P):"dirPrice"===i?productDetails.calcDisc($(a.find(".directPrice")),P):(e?t.find("#hdnPriceBookId"+P).val(C.val()):$("#hdnPriceBookId"+P).val(C.val()),e?t.find("#txtQty"+P).focus():$("#txtQty"+P).focus()),a.hide()})),$("#cancelDiscountType").off("click").on("click",(function(){d.hide()}))):(T.off("keyup"),T.keyup((function(){productDetails.calcDisc(this,P)})),I.off("keyup"),I.keyup((function(){productDetails.calcDisc(this,P)})),y.click((function(){e?n.find("#hdnPriceBookId"+P).val(C.val()):$("#hdnPriceBookId"+P).val(C.val()),e?n.find("#txtQty"+P).focus():$("#txtQty"+P).focus()}))),(e?n.find(".discType"):$(".discType")).click((function(){productDetails.discStatus=$(this).val(),$(this).parent().parent().parent().find(".decimalFld").parent().css("visibility","hidden"),$(this).parent().find(".decimalFld").parent().css("visibility","visible"),$(this).parent().find(".decimalFld").select(),"fromPb"!=productDetails.discStatus?e?n.find("#hdnPriceBookId"+P).val(null):$("#hdnPriceBookId"+P).val(null):(e?n.find("#hdnPriceBookId"+P).val(C.val()):$("#hdnPriceBookId"+P).val(C.val()),e?n.find("#txtQty"+P).focus():$("#txtQty"+P).focus())})),(e?n.find(".noEventDiv"):$(".noEventDiv")).click((function(){$(this).find(".discType").prop("checked",!0),productDetails.discStatus=$(this).find(".discType").val(),$(this).parent().parent().parent().find(".decimalFld").parent().css("visibility","hidden"),$(this).parent().find(".decimalFld").parent().css("visibility","visible"),$(this).parent().find(".decimalFld").select(),"fromPb"!=productDetails.discStatus?(e?n.find("#hdnPriceBookId"+P).val(null):$("#hdnPriceBookId"+P).val(null),"percent"==productDetails.discStatus&&(e?n.find("#discPc"+P).val($(this).parent().find(".decimalFld").val()):$("#discPc"+P).val($(this).parent().find(".decimalFld").val()))):(e?n.find("#hdnPriceBookId"+P).val(C.val()):$("#hdnPriceBookId"+P).val(C.val()),e?n.find("#txtQty"+P).focus():$("#txtQty"+P).focus())})),$(".taxActiveElement").removeClass("taxActiveElement"),v.children("span.alignRight").addClass("taxActiveElement")},showtaxPop:function(t){event.stopPropagation();var e=$(t),a=e.parent().parent(),i=e.offset(),r=e.position(),l=(i.left,i.top,r.left),s=r.top,n=a.find(".prdTaxDet").val(),o="<div>",d=e.innerHeight(),c=a.parent().attr("id");if(c=c.split("hrow")[1],n)for(var u=n.split(";;;"),p=u.length-1,v=0;v<p;v++){var m=u[v],f=(n=m.split("===")[1],m.split("===")[0]),h=n.split(":::")[0];g=n.split(":::")[1];var g=Number(g);g=productDetails.getRoundOffValue(g,!0),o+='<div class="taxRow"> <p class="crm-small-font-size crm-font-regular crmBaseColor"> '+$ESAPI.encoder().encodeForHTML(f)+' </p> <div class="pT10 pB10 br_bottom_border4 mB10"><input type="text" size="5" class="newinputText1 editTax decimalFld alignRight" value="'+$ESAPI.encoder().encodeForHTMLAttribute(h)+'"> <b class="arial pL5">%</b> <input type="text" class="newinputText1 decimalFld taxVal mL10 alignRight" readonly="true" size="5" value="'+g+'"> <label class="pL5"> </label></div> </div>'}else o+=I18n.getMsg("crm.tax.association.check");o+="</div>";var D=$("#taxPop"),T=D.outerWidth();D.children().remove(),D.append(o),D.find(".taxRow").last().find(".br_bottom_border4").removeClass("br_bottom_border4");var x=l,I=s;$("#discountPop").hide(),D.removeClass("hide"),D.show().css({left:x-T/2,top:I+d+10}),e.closest("tr").find(".icon_list,.icon_roundNxtarw,.icon_close,.neweditIcon").css("visibility","hidden"),e.css("visibility","visible"),loadClassFns3(),$(".editTax").keyup((function(){var t=$(this),e=t.val();(isNaN(e)||""==e)&&(e=0);var a=e/100*parseFloat($("#totalAfterDiscount"+c).val());a=productDetails.getRoundOffValue(a,!0),t.parent().find(".taxVal").val(a),productDetails.calcTax(c)}))},bindMouseOverActionForRestrictTaxEdit:function(){$(".cantEditTax").on("mouseover",(function(){crmui.showTooltip(I18n.getMsg("crm.restrict.edit.tax.value.info"),!1,"center",$(this))})).on("mouseout",(function(){crmui.hideTooltip()}))},saveAddTaxInline:function(t){event.stopPropagation();var e="",a=0,i=parseFloat($("#totalAfterDiscount"+t).val()),r=(Math.pow(10,productDetails.roundOff),!1),l=$("input.inlineTax:checked"),s=l.length;$(".taxValError").addClass("dN");for(var n=0;n<s;n++){var o=$(l[n]),d=o.val().trim(),c=$("#inlineTaxVal"+o.attr("id")).text().trim();if(c=productDetails.getTaxPercentString(c),isNaN(c)||c>100||c<-100)$("#inlineTaxValError"+o.attr("id")).removeClass("dN"),r=!0;else if(!r){if(null==productDetails.serviceIdVsPercent[d]||!productDetails.canEditTaxValue&&productDetails.serviceIdVsPercent[d]!=parseFloat(c))continue;var u=parseFloat(c)/100*i;a+=u=productDetails.getRoundOffValue(u,!0),e+=d+"==="+c+";;;"}}if(r)return!1;$("#tax"+t).val(productDetails.getRoundOffValue(a,!0)),$("#prdTaxDet"+t).val(e),productDetails.calculateForLine(t),productDetails.cancelInlineTax()},cancelInlineTax:function(){$("#taxPop").empty().hide(),productDetails.serviceIdVsPercent&&delete productDetails.serviceIdVsPercent,$(".taxActiveElement").removeClass("taxActiveElement")},editLineItemTax:function(t,e){productDetails.serviceIdVsPercent&&delete productDetails.serviceIdVsPercent;var a=$(t),i=a.position(),r=i.left-70,l=i.top,s=a.innerHeight(),n=$("#taxPop"),o=n.outerWidth();$("#discountPop").hide(),$("#grandTaxPop").empty().hide(),event.stopPropagation();var d=$("#isTaxable"+e).val();"false"===d&&(d=!1);var c=$("#prdTaxDet"+e),u=c.data().serviceIdVsName,p=c.val(),v={},m=[],f=[],h=[],g="",D=$("#prdAllTax"+e),T=0;if(d&&(h=D.data().sortedTaxNames),p)for(var x=parseFloat($("#totalAfterDiscount"+e).val()),I=(Math.pow(10,productDetails.roundOff),p.split(";;;")),P=I.length-1,C=0;C<P;C++){T++;var b=I[C].split("==="),y=b[0],_=u[y],S=b[1].split(":::")[0],O=Number(x*S/100);O=productDetails.getRoundOffValue(O,!0),productDetails.isTaxDisplayName(y)?N=y:(N=productDetails.getTaxDisplayName(_,S),m.push(y)),f.push(N.toLowerCase()),g+=productDetails.constructTaxRow(!0,_.trim(),S+"",O,e,T,"inline",y),null==v[y]&&(v[y]=parseFloat(S))}if(h&&D.val()){var F=JSON.parse(D.val());for(P=h.length,C=0;C<P;C++){var N,E=h[C],R=F[E];_=R[0],S=R[1];if(productDetails.isTaxDisplayName(E))N=E;else{if(m.contains(E))continue;N=productDetails.getTaxDisplayName(_,S)}f.contains(N.toLowerCase())||(T++,g+=productDetails.constructTaxRow(!1,_.trim(),S+"",void 0,e,T,"inline",E),f.push(N.toLowerCase()),null==v[E]&&(v[E]=parseFloat(S)))}}var L='<div class="selectTaxdiv">';T>0?(L+='<div class="crm-heading-font-size crm-font-bold mB10">'+I18n.getMsg("crm.tax.select")+"</div>",L+=g,L+='<div class="selectTaxbtnSec mT10"><input class="primarybtn btn_sml" type="Button" onclick="productDetails.saveAddTaxInline('+e+')" value="'+I18n.getMsg("crm.button.done")+'"/><input class="newgraybtn btn_sml" type="Button" onclick="productDetails.cancelInlineTax()" value="'+I18n.getMsg("crm.button.cancel")+'"/></div>'):L+=I18n.getMsg("crm.tax.association.check"),L+="</div>",n.html(L),n.find(".taxRow").last().find(".br_bottom_border4").removeClass("br_bottom_border4"),n.removeClass("hide"),n.show().css({left:r-o/2,top:l+s+10}),a.closest("tr").find(".icon_list,.icon_roundNxtarw,.icon_close,.neweditIcon").css("visibility","hidden"),a.css("visibility","visible"),$(".taxActiveElement").removeClass("taxActiveElement"),$("#inlineValueContainer"+e).addClass("taxActiveElement"),loadClassFns3(),productDetails.canEditTaxValue||productDetails.bindMouseOverActionForRestrictTaxEdit(),productDetails.serviceIdVsPercent=v},addOrRemoveTax:function(t,e,a,i){if($(t).is(":checked")){var r=$("#"+e+"TaxVal"+i);productDetails.canEditTaxValue&&(r.attr({contenteditable:!0,onkeydown:"productDetails.checkMaxLength(event,this)",onkeyup:"productDetails.changeTaxValue(this,'"+e+"',"+a+","+i+")"}),$("#taxValContainer"+i).removeClass("taxPercentage_box_bg"));var l,s=r.text().trim();if((isNaN(s)||""==s)&&(s=0),"inline"===e)l=parseFloat($("#totalAfterDiscount"+a).val())*s/100;else l=(parseFloat($("#subTotal").val())-parseFloat($("#txtDiscount").val()))*s/100;l=productDetails.getRoundOffValue(l,!0),$("#"+e+"taxAmount"+i).val(l)}else productDetails.canEditTaxValue&&($("#"+e+"TaxVal"+i).removeAttr("onkeyup").removeAttr("onkeydown").removeAttr("contenteditable"),$("#taxValContainer"+i).addClass("taxPercentage_box_bg")),$("#"+e+"taxAmount"+i).val("-")},checkMaxLength:function(t,e){if(8!=t.which&&(t.which<37||t.which>40)){var a=$(e).text().trim();a&&(a.length>=5||"."===t.key&&a.indexOf(".")>-1)&&t.preventDefault()}},changeTaxValue:function(t,e,a,i){var r=$(t).text().trim();(isNaN(r)||""==r)&&(r=0);var l="0.0";"inline"===e?l=r/100*parseFloat($("#totalAfterDiscount"+a).val()):l=r/100*(parseFloat($("#subTotal").val())-parseFloat($("#txtDiscount").val()));l=productDetails.getRoundOffValue(l,!0),$("#"+e+"taxAmount"+i).val(l)},constructTaxRow:function(t,e,a,i,r,l,s,n){null==i&&(i="-"),n=$ESAPI.encoder().encodeForHTMLAttribute(n);var o='<div class="taxRow clearFix"> <label class="newCustomchkbox-md fL w130 mT3">',d=!1,c=productDetails.canEditTaxValue&&t?"":"taxPercentage_box_bg";return t?(d=!0,o+='<input type="checkbox" onclick="productDetails.addOrRemoveTax(this,\''+s+"',"+r+","+l+')" id="'+l+'" class="'+s+'Tax" checked value="'+n+'">'):o+='<input type="checkbox" onclick="productDetails.addOrRemoveTax(this,\''+s+"',"+r+","+l+')" id="'+l+'" class="'+s+'Tax" value="'+n+'">',o+='<span class="chkbxIcon vaM mR10"></span><span class="ellipsistext w100 dIB vaM">'+$ESAPI.encoder().encodeForHTML(e)+'</span> </label> <div class="fL clearFix"><div id="taxValContainer'+l+'" class="taxPercentage_box fL '+c+'">',productDetails.canEditTaxValue?o+='<div type="text" onkeydown="productDetails.checkMaxLength(event,this)" onkeyup="productDetails.changeTaxValue(this,\''+s+"',"+r+","+l+')" contenteditable="'+d+'" size="5" class="borderNone editTax decimalFld" value="'+a+'" id="'+s+"TaxVal"+l+'">'+a+"</div>":o+='<div type="text" size="5" class="borderNone cantEditTax editTax" value="'+a+'" id="'+s+"TaxVal"+l+'" readonly="true" style="cursor: not-allowed;">'+a+"</div>",o+='<b class="arial pL5">%</b></div> <input type="text" id="'+s+"taxAmount"+l+'" class="borderNone taxVal mL10 mT4 alignRight fR w100" readonly="true" value="'+i+'">',o+='<label class="pL5"> </label></div> </div><div class="mB10"><span id="'+s+"TaxValError"+l+'" style="font-size: var(--crm-extra-medium-font-size);color: red;margin-left: 130px;" class="vaT dN taxValError">'+I18n.getMsg("crm.field.valid.check",I18n.getMsg("crm.label.tax.value"))+"</span></div>"},invLineHover:function(t){$(t).find(".icon_close").css("visibility","visible"),$(t).find(".itemDescription").css({border:"1px solid #EDF0F4",resize:"vertical"}).attr("placeholder",I18n.getMsg("PrdDescription"))},invLineOut:function(t){$(t).find(".icon_close").css("visibility","hidden"),$(t).find(".itemDescription").css("border","1px solid #fff"),$(t).find(".itemDescription").attr("placeholder",""),$(t).find(".itemDescription").css("resize","none")},popLineHover:function(t){$(t).find(".icon_close, .icon_roundinfo").css("visibility","visible")},popLineOut:function(t){$(t).find(".icon_close, .icon_roundinfo").css("visibility","hidden")},showCellIcon:function(t,e,a){a&&productDetails.hideListPrice||(e?$(t).next().find(".lineicon").css("visibility","visible"):$(t).find(".lineicon").css("visibility","visible"))},hideCellIcon:function(t,e){e?$(t).next().find(".lineicon").css("visibility","hidden"):$(t).find(".lineicon").css("visibility","hidden")},setValuesForAddedRowForEdit:function(t,e,a,i,r){var l=null;a&&(l=$("#multipleFieldsEditPop #"+i.relListId+"_rlContainer"));Math.pow(10,productDetails.roundOff);if(t){var s=Crm.userDetails.isLookupAdvancedSearchEnabledInLineItem,n=t.totalProductCount;if(a?l.find("#totalProductCount").val(n):$("#totalProductCount").val(n),s){var o=t.fieldMeta;o.module=this.module;for(var d=a?l.find("#linesTbody"):$("#linesTbody"),c=2;c<=n;c++){o.rowNumber=c,o.TAX_MIGRATION_COMPLETED=Crm.userDetails.TAX_MIGRATION_COMPLETED,o.autoPopulateTax=productDetails.autoPopulateTax;var u=Handlebars.templates.productDetailsRow(o);d.append(u);var p=d.find("#Crm_"+this.module+"_PRODUCTDETAILS_"+c);p.length>0&&!p.data().readonly&&crmLookupAutoComplete.initAutoCompletePlugin(p,"createPageLookup")}d.find("input.ui-autocomplete-input").click((function(){$(this).autocomplete("search")})),n>1&&$(".icon_close").removeClass("hide"),d.find(".pbIcon").attr("style","visibility:hidden")}else for(c=1;c<=n;c++)productDetails.addARow(c,a,a?i.relListId:void 0);for(c=1;c<=n;c++){s&&(a?l.find("#Crm_"+this.module+"_PRODUCTDETAILS_"+c).val(t["hdnProductName"+c]):$("#Crm_"+this.module+"_PRODUCTDETAILS_"+c).val(t["hdnProductName"+c])),a?l.find("#hdnProductId"+c).val(t["hdnProductId"+c]):$("#hdnProductId"+c).val(t["hdnProductId"+c]),a?l.find("#hdnInvRelId"+c).val(t["hdnInvRelId"+c]):$("#hdnInvRelId"+c).val(t["hdnInvRelId"+c]),a?l.find("#txtProductSpan"+c).text(t["hdnProductName"+c]):$("#txtProductSpan"+c).text(t["hdnProductName"+c]),a?l.find("#txtProduct"+c).val(t["hdnProductName"+c]):$("#txtProduct"+c).val(t["hdnProductName"+c]),(a?l.find("#txtProductCodeSpan"+c):$("#txtProductCodeSpan"+c)).text(null==t["hdnProductCode"+c]?"":"("+t["hdnProductCode"+c]+")"),a?l.find("#hdnProductCode"+c).val(t["hdnProductCode"+c]):$("#hdnProductCode"+c).val(t["hdnProductCode"+c]),a?l.find("#itemDescription"+c).val(t["itemDescription"+c]):$("#itemDescription"+c).val(t["itemDescription"+c]);var v=parseFloat(t["txtListPrice"+c]);if(null!=v&&"NaN"!=v.toString()||(v=parseFloat(t["hdnUnitPrice"+c])),v.toString().indexOf(".")<0&&(v=productDetails.getRoundOffValue(v,!0)),a?l.find("#txtListPrice"+c).val(v):$("#txtListPrice"+c).val(v),null!=t["hdnUnitPrice"+c]&&!isNaN(t["hdnUnitPrice"+c])){var m=1,f=a?$("#Crm_"+productDetails.module+"_"+i.relListId+"_CURRENCYISOCODE").val():$("#Crm_"+productDetails.module+"_CURRENCYISOCODE").val(),h=Crm.userDetails.BASE_CURRENCY;null!=f&&null!=h&&f!=h&&(m=Crm.userDetails.CURRENCY_DETAILS[f]?Crm.userDetails.CURRENCY_DETAILS[f].er:Crm.userDetails.CURRENCY_DETAILS[h].er);var g=t["hdnUnitPrice"+c];g*=m,g=productDetails.getRoundOffValue(g,!0),a?l.find("#hdnUnitPrice"+c).val(g):$("#hdnUnitPrice"+c).val(g)}a?l.find("#hdnPriceBookId"+c).val(t["hdnPriceBookId"+c]):$("#hdnPriceBookId"+c).val(t["hdnPriceBookId"+c]),a?l.find("#hdnPriceBookIdClone"+c).val(t["hdnPriceBookId"+c]):$("#hdnPriceBookIdClone"+c).val(t["hdnPriceBookId"+c]),a?l.find("#hdnQtyStock"+c).val(t["hdnQtyStock"+c]):$("#hdnQtyStock"+c).val(t["hdnQtyStock"+c]);var D=parseFloat(t["txtQty"+c]);a?l.find("#txtQty"+c).val(D):$("#txtQty"+c).val(D),a?l.find("#hdnOldQty"+c).val(t["txtQty"+c]):$("#hdnOldQty"+c).val(t["txtQty"+c]);var T=v*D;T=productDetails.getRoundOffValue(T,!0),a?l.find("#total"+c).val(T):$("#total"+c).val(T),a?l.find("#total"+c).parent().find(".amntFP").text(T):$("#total"+c).parent().find(".amntFP").text(T),null!=(M=parseFloat(t["hdnDiscount"+c]))&&"NaN"!=M.toString()||(M=0),M=productDetails.getRoundOffValue(M,!0);var x=0;0!=T&&(x=productDetails.getRoundOffValue(M/T*100,!0)),a?l.find("#discount"+c).val(M):$("#discount"+c).val(M),a?l.find("#discPc"+c).val(x):$("#discPc"+c).val(x),a?l.find("#discount"+c).parent().find(".discVal").text(M):$("#discount"+c).parent().find(".discVal").text(M);var I=T-M;if(I=productDetails.getRoundOffValue(I,!0),a?l.find("#totalAfterDiscount"+c).val(I):$("#totalAfterDiscount"+c).val(I),!r&&("create"===Lyte.Router.getRouteInstance().routeName||"clone"===Lyte.Router.getRouteInstance().routeName)){for(var P=t["hdnPrdAllTax"+c],C=t["hdnPrdTaxDet"+c],b="",y=0,_=(I=parseFloat(I),Math.pow(10,productDetails.roundOff),C.split(";;;")),S=_.length-1,O=0;O<S;O++){if(P[G=(Q=(X=_[O]).split("==="))[0]]){var F=Q[1].split(":::")[0];if(!productDetails.canEditTaxValue&&parseFloat(P[G][1])!=parseFloat(F))continue;var N=Number(F/100*I);y+=N=productDetails.getRoundOffValue(N,!1),b+=G+"==="+F+";;;"}}t["hdnTax"+c]=y,t["hdnPrdTaxDet"+c]=b}var E=a?l.find("#prdTaxDet"+c):$("#prdTaxDet"+c);E.val(t["hdnPrdTaxDet"+c]),E.data("serviceIdVsName",t["lineTaxNames"+c]);var R=a?l.find("#prdAllTax"+c):$("#prdAllTax"+c);R.val(JSON.stringify(t["hdnPrdAllTax"+c])),R.data("sortedTaxNames",t["hdnPrdSortedTaxs"+c]),a?l.find("#isTaxable"+c).val(t["isTaxable"+c]):$("#isTaxable"+c).val(t["isTaxable"+c]),null!=(N=parseFloat(t["hdnTax"+c]))&&"NaN"!=N.toString()||(N=0),N=productDetails.getRoundOffValue(N,!0),a?l.find("#tax"+c).val(N):$("#tax"+c).val(N),a?l.find("#tax"+c).parent().find(".taxval").text(N):$("#tax"+c).parent().find(".taxval").text(N);var L=parseFloat(I)+parseFloat(N);L=productDetails.getRoundOffValue(L,!0),a?l.find("#netTotal"+c).val(L):$("#netTotal"+c).val(L),a?l.find("#netTotal"+c).parent().find(".netTot").text(L):$("#netTotal"+c).parent().find(".netTot").text(L),e&&(Crm.userDetails.hideProductLineItemsSummary||productDetails.calculateGrandTotal(c),productDetails.grandTaxChanged=!1)}if(!e){var w=a?l.find("#subTotal"):$("#subTotal"),A=a?l.find("#txtDiscount"):$("#txtDiscount"),k=productDetails.getRoundOffValue(t.INVENTORYTOTALVALUES.SUBTOTAL,!0);w.val(k),w.parent().find(".grandVals").text(k);var M=productDetails.getRoundOffValue(t.INVENTORYTOTALVALUES.DISCOUNT,!0);A.val(M);x=0;if(0!=k&&(x=productDetails.getRoundOffValue(M/k*100,!0)),a?l.find("#discPc").val(x):$("#discPc").val(x),A.parent().find(".grandVals").text(M),!r&&("create"===Lyte.Router.getRouteInstance().routeName||"clone"===Lyte.Router.getRouteInstance().routeName))if(b=t.INVENTORYTOTALVALUES.RECORDTAXDET){var V=JSON.parse(productDetails.newAllTaxes),U="",B=(y=0,I=parseFloat(k)-parseFloat(M),b.split(";;;")),z=B.length-1;for(O=0;O<z;O++){var Q,G;if(V[G=(Q=(X=B[O]).split("==="))[0]]){F=Q[1].split(":::")[0];if(!productDetails.canEditTaxValue&&parseFloat(V[G][1])!=parseFloat(F))continue;var H=(F=parseFloat(F))/100*I;y+=H=productDetails.getRoundOffValue(H,!1),U+=G+"==="+F+";;;"}}t.INVENTORYTOTALVALUES.TAX=y,t.INVENTORYTOTALVALUES.RECORDTAXDET=U}var X=productDetails.getRoundOffValue(t.INVENTORYTOTALVALUES.TAX,!0),Y=a?l.find("#txtTax"):$("#txtTax");Y.val(X),Y.parent().find(".grandVals").text(X),a?l.find("#recordTaxDet").val(t.INVENTORYTOTALVALUES.RECORDTAXDET):$("#recordTaxDet").val(t.INVENTORYTOTALVALUES.RECORDTAXDET);var q=productDetails.getRoundOffValue(t.INVENTORYTOTALVALUES.ADJUSTMENT,!0),J=a?l.find("#txtAdjustment"):$("#txtAdjustment");J.val(q),J.parent().find(".grandVals").text(q);var j=productDetails.getRoundOffValue(t.INVENTORYTOTALVALUES.GRANDTOTAL,!0),W=a?l.find("#grandTotal"):$("#grandTotal");W.val(j),W.parent().find(".grandVals").text(j)}if(!r&&("create"===Lyte.Router.getRouteInstance().routeName||"clone"===Lyte.Router.getRouteInstance().routeName)){for(c=1;c<=n;c++)productDetails.calculateForLine(c);productDetails.calculateGrandTotal()}}},initInventoryView:function(t){if(t.entMetaData.isConverted&&$('[id="btnConvert"]').parent().remove(),objectUtils.getKeys(Crm.userDetails.CURRENCY_DETAILS).length>0){var e=$("#subvalue_CURRENCYISOCODE").text();null!=e&&""!=e||(e=Crm.userDetails.BASE_CURRENCY),productDetails.currencySymbol=Crm.userDetails.CURRENCY_DETAILS[e]?Crm.userDetails.CURRENCY_DETAILS[e].symbol:void 0,productDetails.roundOff=Crm.userDetails.CURRENCY_DETAILS[e].decimals}else productDetails.currencySymbol=Crm.userDetails.defaultOrgCurrency,isNaN(Crm.userDetails.productRoundOff)||(productDetails.roundOff=Crm.userDetails.productRoundOff,productDetails.roundOff>5&&(productDetails.roundOff=5));productDetails.roundOffPrecision=Math.pow(10,productDetails.roundOff)},clickMore:function(t){var e=$("#value_itemDescription"+t),a=$("#value_itemDescriptionClone"+t),i=renderingUtils.highlightUrlInText($ESAPI.encoder().encodeForHTML(a.val()));i+=' <a href="javascript:;" class="fR crm-small-font-size crmLinkColor cP vH moreLess" onclick="productDetails.clickLess('+t+')"> '+I18n.getMsg("crm.label.less")+" </a> ",e.html(i)},clickLess:function(t){var e=$("#value_itemDescription"+t),a=$("#value_itemDescriptionClone"+t).val(),i=a.substring(85),r=a.substring(0,85);if((r=renderingUtils.highlightUrlInText($ESAPI.encoder().encodeForHTML(r))).endsWith("</a>")&&!i.startsWith(" ")){var l=-1===i.indexOf(" ")?86+i.length:85+i.indexOf(" ");r=a.substring(0,l),r=renderingUtils.highlightUrlInText($ESAPI.encoder().encodeForHTML(r))}a=r+'...  <a href="javascript:;" class="fR crm-small-font-size crmLinkColor cP vH moreLess" onclick="productDetails.clickMore('+t+')"> '+I18n.getMsg("crm.login.more")+" </a> ",e.html(a)},create:function(t){this.productDetails=!0,this.module=t;var e=document.createDocumentFragment();return this.createLinesTable(e),this.createProductsPop(e),this.createDiscountPop(e),this.createTaxPops(e),this.createNewProductForm(e),this.productDetails=!1,e},convertQuote:async function(t,e,a,i,r){var l,s=I18n.getMsg("convertAlert"),n=!0===Crm.userDetails.DETAIL_VIEW_LYTE&&!0===Crm.userDetails.timelineRevamp;if(store.peekRecord(moduleRecordMapping[t].id,a)&&(l=store.peekRecord(moduleRecordMapping[t].id,a)),"Invoices"==e){var o,d,c,u=!1,p=$(".lineItemSubformRow").length,v=$(".mouseArea___PRODUCTID"),m=$(".mouseArea___QUANTITY"),f=Crm.userDetails.isSubformNewComponentEnabled;if("detail"===Lyte.Router.getRouteInstance().routeName&&(f||n)){if("SalesOrders"===t?(d="Ordered_Items",c="OrderedItems"):"Quotes"===t&&(d="Quoted_Items",c="QuotedItems"),p=(o=l[d]).length,n){commonUtils.showHideLoadingDiv(!0),await store.findRecord("module",moduleRecordMapping.Products.id);var h=[];o.forEach((function(t){t.Product_Name&&t.Product_Name.id&&h.pushUniqValues(t.Product_Name.id)}));var g=h.join(","),D={};await store.findAll(moduleRecordMapping.Products.id,{fields:"Unit_Price,Qty_in_Stock",ids:g}).then((function(t){t&&t.forEach((function(t){D[t.id]=t}))})),v=[];for(var T=0;T<p;T++){var x=o[T],I=D[x.Product_Name.id];I=I||{},v.push(I)}commonUtils.showHideLoadingDiv(!1)}else v=returnJson[t].subforms.section.filter((function(t){return t.subFormName===c}))[0].FL.map((function(t){return t.filter((function(t){return"PRODUCTID"===t.colname}))[0].prdDetails}));m=o.map((function(t){return t.Quantity+""}))}if(m.length>0)for(T=0;T<p;T++){var P=f||n?v[T]:v.eq(T).data().params.prdDetails,C=P?P.LAYOUTID:P.Layout?P.Layout:void 0;if(!(!(C=C?C.id?C.id:C:void 0)&&0===Crm.userDetails.QuantityInStockAvailableLayoutIds.length||C&&!Crm.userDetails.QuantityInStockAvailableLayoutIds.contains(C))){var b=P?P.Qty_in_Stock:0,y=f||n?m[T]:m.eq(T).data().params.defaultvalue;if(y.length>0&&(b<=0||b<y)){u=!0;break}}}if("canvas"===Lyte.Router.getRouteInstance().routeName&&r&&(u=!0),u&&!window.confirm(s))return!1}if("list"!==Lyte.Router.getRouteInstance().routeName?$u.isEmpty(returnJson)?l.$converted:returnJson.entMetaData.isConverted:l.$converted)return"canvas"==Lyte.Router.getRouteInstance().routeName?renderingUtils.showCustomAlert(I18n.getMsg("crm.noquote.convert",I18n.getMsg("Quotes"))):alert(I18n.getMsg("crm.noquote.convert",I18n.getMsg("Quotes"))),!1;i&&(i.click=null),detailView.isWFExecInKafka=!1,detailView.refreshInWms=!1;var _=Crm.getCrmBasePath()+"/FillEntityObject.do?operation=convert&destModule="+e+"&sourceModule="+t+"&sourceId="+a;mR(_,(function(e){var a=JSON.parse(e);if("DELETED"===a.STATUS){var i='<div onclick=/"sE()" class="w500 p20"><div class="fL pL20 w430"><div class="crm-heading-font-size"><h2 style="color:#E20000";>'+I18n.getMsg("crm.delete.error")+'</h2></div><div class="mT10">'+I18n.getMsg("crm.record.delete.message",[Crm.getCrmBasePath()])+'</div></div><br class="cBoth"><div  class="alignRight mT20"><input type="button" id="popupok" class="primarybtn" value="'+I18n.getMsg("crm.button.ok")+"\" onclick=\"hide('popupnew');renderingUtils.removeFreezeLayer();document.getElementById('popupnew').style.zIndex=30\"></div></div>";return renderingUtils.popUpWithFreeze(i),!1}if("ALREADY_CONVERTED"===a.STATUS)return renderingUtils.showCustomAlert(I18n.getMsg("crm.convert.lead.converted.error.popup"),"",!1,void 0),!1;if("INTERNAL_ERROR"===a.STATUS)return renderingUtils.showCustomAlert(I18n.getMsg("crm.copy.error.mail.internal.error"),"",!0,void 0),!1;if("DUPLICATE"===a.STATUS)return renderingUtils.showCustomAlert(commonUtils.getDuplicateErrorMsg(a.INFO[0],!0),"",!0,void 0),!1;if("INACTIVEOWNER"===a.STATUS)return renderingUtils.showCustomAlert(I18n.getMsg("crm.alert.assign.active.user"),"",!1,void 0),!1;if("PERMISSION_DENIED"==a.STATUS)return renderingUtils.displayPermissionDenied(),!1;detailView.isWFExecInKafka=a.isWFExecInKafka,detailView.refreshInWms=a.callWMS,detailView.prevModule=a.module;var r=a.URL,l=networkUtils.parseUrl(r).params;"list"===Lyte.Router.getRouteInstance().routeName&&store.unloadAll(moduleRecordMapping[t].id),Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:[l.module,l.id]})}),crmReports.csrf())},convertQuoteFromCanvas:function(t,e,a){var i,r=store.peekRecord(moduleRecordMapping[t].id,$L("#entityId")[0].value);if((i=r.Ordered_Items?r.Ordered_Items:r.Quoted_Items)&&i.length>0&&"Invoices"===e){var l=[];i.filter((function(t){l.push(t.Product_Name.id)})),(store.modelFor(moduleRecordMapping.Products.id)?Promise.resolve(store.peekRecord("module",moduleRecordMapping.Products.id)):store.findRecord("module",moduleRecordMapping.Products.id)).then((function(){var i={};i.ids=l.join(),i.approved="both",store.findAll(moduleRecordMapping.Products.id,i).then((function(i){i.filter((function(t){return t.Qty_in_Stock<=0})).length>0?productDetails.convertQuote(t,e,a,void 0,!0):productDetails.convertQuote(t,e,a,void 0,!1)}))}))}else productDetails.convertQuote(t,e,a,void 0)},addLoggerForTaxIssue:function(t,e){if("20070216817"===Crm.userDetails.ZGID.toString()){var a={type:"custom event"};a.message=t,murphy.addCustomTracking(a),murphy.error(new Error(e))}},setPrdDetailsForWidget:function(t,e){if(e.Product_Name&&e.Product_Name.id&&e.Product_Name.name){var a={};a.id=e.Product_Name.id,a.Taxable=e.Taxable,a.Tax=e.Tax,a.Product_Name=e.Product_Name.name,a.Qty_Ordered=e.Quantity,a.Qty_in_Stock=e.Qty_in_Stock,a.Unit_Price=e.List_Price,a.Product_Code=e.Product_Code,$(t).attr("prdDetails",JSON.stringify(a))}}};function loadClassFns1(t,e){$(t?"#multipleFieldsEditPop #"+e+"_rlContainer #cancelNewProduct":"#cancelNewProduct").click((function(){$("#searchCreateDiv").animate({right:"700px"}).hide(),$("#productPopup").show().animate({right:"0px"}),$("#addpbtn").show(),$("#cancelbtn").show()})),t?$("#multipleFieldsEditPop #"+e+"_rlContainer ").find("#taxPop,#discountPop,#moreop,#editGrandDiscPop,#grandTaxPop").attr("data-close","true"):$("#taxPop,#discountPop,#moreop,#editGrandDiscPop,#grandTaxPop").attr("data-close","true"),$(".subDiscTot").click((function(){$(this).siblings(".editCentDesc").hide(),$(this).siblings(".s").show(),$(this).siblings(".s").children(".textField").focus(),$(this).closest("tr").siblings("tr").find(".editCentDesc").show(),$(this).closest("tr").siblings("tr").find(".s").hide(),document.getElementsByClassName("wrap").style.display="block"})),$(".subDisc").keyup((function(){var t=0,e=parseFloat($("#subTotal").val());if("grandDiscPc"==$(this).attr("id")){t=e*(a=$(this).val())/100,$("#grandDiscDir").val(t),t=productDetails.getRoundOffValue(t,!0)}else{var a=0;0!=(t=$(this).val())&&(a=t/e*100),$("#grandDiscPc").val(a)}$("#txtDiscount").val(t),"0"!=$("#txtTax").val()?calcGrandTax():Crm.userDetails.hideProductLineItemsSummary||calculateGrandTotal()}))}function loadClassFns3(t,e){var a=null;e&&(a=$("#multipleFieldsEditPop #duringTabDivs div.current"));e?a.find(".decimalFld"):$(".decimalFld");$(".decimalFld").keypress((function(t){return(8==t.which||0==t.which||46==t.which||45==t.which||!(t.which<48||t.which>57))&&((null==$(this).attr("id")||!($(this).attr("id").indexOf("Qty")>-1&&$(this).val().length>=9||$(this).attr("id").indexOf("ListPrice")>-1&&$(this).val().length>=20))&&void 0)}))}function loadClassFns2(t){var e=null;t&&(e=$("#multipleFieldsEditPop #duringTabDivs div.current"));var a=t?e.find("#linesTbody"):$("#linesTbody");a.sortable({placeholder:"ui-sortable-placeholder",cursor:"move",helper:function(t,e){return e.children().each((function(){$(this).width($(this).width())})),e},stop:function(t,e){var a=0;$("#linesTbody .sort").each((function(){a++,productDetails.reorderRow(this,a)}))}}),a.mousedown((function(){document.activeElement.blur()})),(t?e.find(".showCode"):$(".showCode")).change((function(){this.checked?t?e.find(".codeList").show():$(".codeList").show():t?e.find(".codeList").hide():$(".codeList").hide()})),(t?e.find(".showDisc"):$(".showDisc")).change((function(){this.checked?t?e.find(".discList").show():$(".discList").show():t?e.find(".discList").hide():$(".discList").hide()}))}var productScroll={_scrollMenu:function(t,e,a){var i=[],r=Math.ceil(e.length/10);i=e.slice(0,10);var l=a.options.position;r>1&&$(t).scroll((function(){if(isScrollbarBottom($(t))){if(searchStats.scrollEnd)return null;if(searchStats.scrollPageIndex>=r){if(searchStats.isFull)return null;var e=searchStats.previousSearchResults.length+1;(i=productDetails.searchForProducts(searchStats.searchText,!0,e)).length<10&&(searchStats.scrollEnd=!0,searchStats.isFull=!0)}else i=(i=productDetails.searchForProducts(searchStats.searchText,!1,0)).slice(10*searchStats.scrollPageIndex,10*searchStats.scrollPageIndex+10);++searchStats.scrollPageIndex,i.each((function(e){null!=e&&a._renderItem(t,e)})),a.menu.refresh(),t.show(),a._resizeMenu(),t.position($.extend({of:a.element},l)),a.options.autoFocus&&a.menu.next(new $.Event("mouseover"))}})),i.each((function(e){null!=e&&a._renderItem(t,e)}))}};function isScrollbarBottom(t){var e=(t=$L(t)).outerHeight(),a=t[0].scrollHeight;return t.scrollTop()>=a-e}