Lyte.Mixin.register("crm-tag-mixin",{validatetags:function(e,t,a,s,r,i,o){if("add"===i){var n=this.editionlimit(s,r),d=this.recordlimit(t,a,i,o),l=this.validate_spl_char(e);return!(d||n||l)}return!(d=this.recordlimit(t,a,i,o))},recordlimit:function(e,t,a,s){if(t>e){var r=I18n.getMsg("crm.tags.records.limit.reached",e);return"remove"!==a||"list"!==s&&"bp"!==s&&"wf"!==s||(r=I18n.getMsg("crm.tags.remove.custom.limit.reached",e)),this.data.inputData&&"workflow"===this.data.inputData.featureType?_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:r}}):_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:r,ltPropContentAlign:"center"}}),$(".lyteAlertBtn").focus(),!0}return!1},editionlimit:function(e,t){return t>e&&(_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.edition.limit.exceeded")}}),setTimeout((function(){var e=$("crux-tag")[0];e.toggle("off"),e.resetSearch()}),400),!0)},validate_spl_char:function(e){var t=!1;if(e.match(/[/\\!@#$%^&*()[\].?":{}~`;'|]/)||e.indexOf("+")>-1||e.indexOf("-")>-1){for(var a=e.length,s=0;s<a&&(t=!(!e[s].match(/[/\\!@#$%^&*()[\].?":{}~`;'|]/)&&"+"!==e[s]&&"-"!==e[s]));s++);if(t)return document.querySelector("crux-tag").toggle("close"),_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.need.alphanumeric.characters"),ltPropContentAlign:"center"}}),$(".lyteAlertBtn").focus(),!0}return!1},notagselected:function(e){if(0===e)return _cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.no.tag.selected"),ltPropContentAlign:"center"}}),!0},createtagRec:function(e,t){for(var a=e.length,s=0;s<a;s++){var r=e[s].name.replace(/  +/g," ");t.contains(r)||store.createRecord("tag",{name:r,color_code:e[s].color_code})}},createtags:function(e,t,a){var s,r=this;s=void 0===t||"dv"===t||"list-view"===t?"view":"wf"===t?"workflow":t,store.create("tag",void 0,!1,{module:e,fromPage:s}).then((function(s){var i=s,o=r.check_emoji(s,r,e),n=i?i.tag:i;if("blueprint"===t&&r.populatemapping(n),!o)if("list-view"!==t)if("workflow"!==t&&"wf"!==t){if("dv"!==t)return s;r.aftercreate_dv(r,n)}else r.aftercreate_wf(r,n,a);else r.aftercreate_list(r,n,a,e)}),(function(a){if(void 0!==a&&void 0!==a.response&&(-1!==a.response.indexOf("symbols are not allowed")||-1!==a.response.indexOf("tags edition limit exceeded")))return r.check_emoji(JSON.parse(a.response),r,e),void("blueprint"===t&&(r.setData("disableDone",!0),r.setData("disableCancel",!0),r.populatemapping(JSON.parse(a.response))));if("dv"===t){var s={},i=r.data.selectedtags;a&&a.response&&(s=JSON.parse(a.response)),"NO_PERMISSION"===s.code&&"permission denied"===s.message&&(CrmTags.clientJSON.permission=void 0,r.setData("tagged_icon",!1),$(".tagged_icon").hide(),r.setData("add_tag",!1),r.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")));for(var o=Object.keys(i).length,n=[],d=0;d<o;d++)JSON.stringify(i[d]).includes('"isNewTag":true')&&n.push(i[d]);if(void 0!==s.tags){var l=Object.keys(s.tags).length,g="";for(d=0;d<l;d++){"DUPLICATE_DATA"===s.tags[d].code&&(g=g+n[d].name+",")}return renderingUtils.showCustomAlert(I18n.getMsg("crm.tags.records.duplicate.tag",g.substring(0,g.length-1)),I18n.getMsg("crm.label.small.tags"),!1),void commonUtils.showHideLoadingDiv(!1)}}else if("list-view"===t)return r.ShowTagErrorMsg(a),commonUtils.showHideLoadingDiv(!1),void r.closeModal();commonUtils.showHideLoadingDiv(!1),_cruxUtils.showCustomAlert({params:{ltPropType:"warning",ltPropSecondaryMessage:I18n.getMsg("crm.tag.unable.to.process"),ltPropPrimaryMessage:I18n.getMsg("crm.label.small.tags")}})}))},addtagstoRec:function(e,t,a,s,r,i,o,n,d,l){e=this;var g='["'+a.toString()+'"]';if(t.ids=g,"add"===o){var c={affected_data:!0};store.triggerAction("entity","add_tags",{tag_names:t,ids:g,over_write:s,type:"POST",fromPage:"view",module:r,from:"detailvew"},c).then((function(t){if("detailview"===i&&e.afteradd_detailview(e,t,d,l,n),"canvas"===i){var a=e,s=t.data;if(s&&s.length>0&&-1!==s[0].message.indexOf("tags updated successfully")){a.validatingCanvasRule(a.getData("module"),a.getData("recordId"));var o=a.processTagStrings(s[0].details.tags);a.setData("tags",o.slice()),a.addToExistingTags(),a.fetchAllTags(),a.setData("showDropDown",!1);var g=$("crm-tag")[0].component.data.tags;if(store.peekRecord(moduleRecordMapping[r].id,detailView.entityId).Tag=g,n&&n.resolvefn&&n.resolvefn(),CScriptLib&&(!n||n.trigger)){var c=l||[],m=d||[],p=m.diff(c)||[],u=c.diff(m)||[];m=m.map((function(e){return{name:e}})),p=p.map((function(e){return{name:e}})),u=u.map((function(e){return{name:e}})),CScript.Engine.Global.dispatchEvent("onTagChanged",void 0,p,u)}if(featuresAvailable.DATA_HUB){var v=$L("crm-detailview-canvas")[0];v&&v.component&&v.component.staticRecordUpdate("Tag",g)}}else n&&n.resolvefn&&n.rejectfn(),crmui.showMsgBand("info",I18n.getMsg("crm.tags.add.unsuccessful"),1e3,"")}}),(function(t){if("detailview"===i){var a={};if(t&&t.response&&(a=JSON.parse(t.response)),"NO_PERMISSION"===a.code&&"permission denied"===a.message&&(CrmTags.clientJSON.permission=void 0,e.setData("tagged_icon",!1),$(".tagged_icon").hide(),e.setData("add_tag",!1),e.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"))),void 0!==a.data){if("CANNOT_PROCESS"===a.data[0].code&&"The record is in stop processing."===a.data[0].message)return renderingUtils.showCustomAlert(I18n.getMsg("crm.tags.records.stop.processing"),I18n.getMsg("crm.label.small.tags"),!1),void commonUtils.showHideLoadingDiv(!1);if("RECORD_LOCKED"===a.data[0].code&&"Sorry, you cannot perform this operation as the record is locked."===a.data[0].message||"RECORD_IN_APPROVAL_PROCESS"===a.data[0].code&&"The record is in approval process."===a.data[0].message)return _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.label.small.tags"),ltPropSecondaryMessage:I18n.getMsg("crm.lock.tag.restricted"),ltPropContentAlign:"center"}}),void commonUtils.showHideLoadingDiv(!1)}renderingUtils.showCustomAlert(I18n.getMsg("crm.tag.unable.to.process"),I18n.getMsg("crm.label.small.tags"),!1),e.setData("saveEnabled",!1),commonUtils.showHideLoadingDiv(!1)}else if("canvas"===i){a={};if(t&&t.response&&(a=JSON.parse(t.response)),"NO_PERMISSION"===a.code&&"permission denied"===a.message&&(CrmTags.clientJSON.permission=void 0,e.setData("tagged_icon",!1),$(".tagged_icon").hide(),e.setData("add_tag",!1),e.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"))),void 0!==a.data){if("CANNOT_PROCESS"===a.data[0].code&&"The record is in stop processing."===a.data[0].message)return _cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tags.records.stop.processing"),ltPropContentAlign:"center"}}),void commonUtils.showHideLoadingDiv(!1);if("RECORD_LOCKED"===a.data[0].code&&("Sorry, you cannot perform this operation as the record is locked."===a.data[0].message||"record under merge is locked"===a.data[0].message))return _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.label.small.tags"),ltPropSecondaryMessage:I18n.getMsg("crm.lock.tag.restricted"),ltPropContentAlign:"center"}}),void commonUtils.showHideLoadingDiv(!1)}_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.unable.to.process"),ltPropContentAlign:"center"}})}}))}else store.triggerAction("entity","remove_tags",{tag_names:t,ids:"["+a+"]",over_write:s,type:"POST",fromPage:"view",module:r,from:"detailvew"}).then((function(t){"detailview"===i&&e.afteradd_detailview(e,t,d,l,n)}),(function(t){if("detailview"===i){var a={};if(t&&t.response&&(a=JSON.parse(t.response)),commonUtils.showHideLoadingDiv(!1),"NO_PERMISSION"===a.code&&"permission denied"===a.message)CrmTags.clientJSON.permission=void 0,e.setData("tagged_icon",!1),$(".tagged_icon").hide(),e.setData("add_tag",!1),e.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"));else if("INVALID_DATA"===a.code&&"tags not found"===a.message)return void e.setData("saveEnabled",!0);e.setData("saveEnabled",!1),_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.unable.to.process"),ltPropContentAlign:"center"}})}}))},check_emoji:function(e,t,a){var s=!1;if(void 0!==e){var r=e.tag;void 0===r&&(r=e.tags);var i=JSON.stringify(r);if(-1!==i.indexOf("tags edition limit exceeded"))return _cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.edition.limit.exceeded"),ltPropContentAlign:"center"}}),void commonUtils.showHideLoadingDiv(!1);if(-1!==i.indexOf("symbols are not allowed")){s=!0,t.tagnames=[],t.setData("tagarray",[]);var o=t.getData("selectedtags"),n=[];if(o)for(var d=o.length,l=0;l<d;l++){var g=o[l].name;n.push(g)}return t.setData("selectedtags",[]),store.findAll("tag",{module:a}).then((function(e){for(var a=e.length,s=0;s<a;s++){var r=e[s].name;void 0!==r&&(Lyte.arrayUtils(t.tagnames,"push",r),Lyte.arrayUtils(t.getData("tagarray"),"push",{name:r,color_code:e[s].color_code}),n.contains(r)&&Lyte.arrayUtils(t.getData("selectedtags"),"push",{name:r,color_code:e[s].color_code}))}})),commonUtils.showHideLoadingDiv(!1),_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.name.invalid.emoji"),ltPropContentAlign:"center"}}),s}}},calculateTagsComponentWidth:function(e){var t=$L(".dv_profileTitle_cont");t.css({width:"500px"});var a=$L(".crm-detailview-tag")[0],s=$L("crm-detailview-actions")[0];if(a&&s){var r=a.getBoundingClientRect();if(Crm.userDetails.RTL_ENABLED){if("Events"!==e||Crm.renderDVLyteFlow(e)){o=s.getBoundingClientRect(),l=Math.round(r.right-o.right-150);return t.css({width:l+50+"px"}),l}var i=$L(".dvmo.send_mailbtndetailpage div:visible")[0];if(i){g=i.getBoundingClientRect();return Math.round(r.right-g.right-150)}}else{if("Events"!==e||Crm.renderDVLyteFlow(e)){var o=s.getBoundingClientRect(),n=Math.round(o.left-r.left-150);return t.css({width:n+50+"px"}),n}var d=$L(".dvmo.send_mailbtndetailpage div:visible")[0];if(d){var l,g=d.getBoundingClientRect();return l=Math.round(g.left-r.left-150)}}}}});
