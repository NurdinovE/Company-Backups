Lyte.Component.register("crm-canvas-churn-prediction-result",{_template:'<template tag-name="crm-canvas-churn-prediction-result"> <template is="if" value="{{isTitleNeeded}}"><template case="true"> <span id="title" class="crm-font-bold pL10 pR10">{{getI18n(\'crm.zia.prediction.churn\')}}</span> </template></template> <template is="if" value="{{isChurnAvailable}}"><template case="true"> <crm-churn-prediction-result churn_prediction="{{churn_prediction}}" iscanvas="true"></crm-churn-prediction-result> </template><template case="false"> <div class="rl_NoRec">{{getI18n(\'crm.zia.no.record.churn\')}}</div> </template></template> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}],_observedAttributes:["churn_prediction","isTitleNeeded","isChurnAvailable","isKioskComponent","module","record"],data:function(){return{churn_prediction:Lyte.attr("array",{default:[]}),isTitleNeeded:Lyte.attr("boolean",{default:!1}),isChurnAvailable:Lyte.attr("boolean",{default:!0}),isKioskComponent:Lyte.attr("boolean",{default:!1}),module:Lyte.attr("string"),record:Lyte.attr("object")}},didConnect:function(){var t=this,e=t.getData("isTitleNeeded")?1:0,o=t.$node.children[e],a=t.getData("module"),n=t.getData("record");if(o){var i=t.getInsightsV2(moduleRecordMapping[a],n.id,{keys:"churn_predictions_data",include_inner_details:"predictions_data.output.critical_fields.field_label"},null,"churn_prediction");i?i.then((function(e){if(e&&e.zia_insights&&e.zia_insights.churn_predictions_data)for(var i=e.zia_insights.churn_predictions_data,r=i.length,s=0;s<r;s++){var l=i[s].churn_prediction,c={};c.id=l.id,c.name=l.name,l.prediction_field&&n[l.prediction_field.api_name]&&(c.label=n[l.prediction_field.api_name]instanceof Object?n[l.prediction_field.api_name].name:n[l.prediction_field.api_name],c.label=c.label+" "+I18n.getMsg("crm.zia.prediction.churn.result.sub")),(n[l.score_field.api_name]||0===n[l.score_field.api_name])&&(c.label=c.label?c.label:I18n.getMsg("crm.zia.prediction.churn.result.nonsub"),c.value=n[l.score_field.api_name]);var d=!l.prediction_field||c.label!==I18n.getMsg("crm.zia.prediction.churn.result.nonsub");(c.value||0===c.value&&d)&&Lyte.arrayUtils(o.component.getData("churn_prediction"),"push",c),o.component.setData("module",a),o.component.setData("record",n),o.component.setData("isKioskComponent",t.getData("isKioskComponent"))}else o.component.setData("isChurnAvailable",!1),t.setData("isChurnAvailable",!1)})):(o.component.setData("isChurnAvailable",!1),t.setData("isChurnAvailable",!1))}}},{mixins:["zia-insights-utils"]}),Lyte.Component.register("crm-churn-prediction-result",{_template:'<template tag-name="crm-churn-prediction-result"> <template is="if" value="{{expHandlers(churn_prediction.length,\'>\',0)}}"><template case="true"> <div class="w100_per mB15 dIB"> <template is="if" value="{{expHandlers(iscanvas,\'!\')}}"><template case="true"> <div class=" mR5 vaM"> <div class="dIB crm-subheading-font-size crm-font-bold crmHeadingColor">{{getI18n("crm.zia.prediction.churn")}}</div> </div> </template></template> <template is="for" items="{{churn_prediction}}" item="prediction" index="index"> <div class="mT20 dF aiCenter w100_per" lt-prop-title="{{getI18n(\'crm.zia.configuration.name\')}}: {{prediction.name}}"> <div class="dIB crmBaseColor crm-base-font-size cDefault vaM wbBreakWord">{{prediction.label}}</div> <div class="churnscorecss dIB crm-small-font-size vaM mL10 lh20 wsNowrap">{{getI18n("crm.label.scoring.rules.score")}} {{prediction.value}}</div> </div> <div class="crmLinkColor crm-font-regular mT20 cP dIB" data-zcqa="churnReasoningLink" id="getChurnReasoning{{predi.id}}" onclick="{{action(\'getChurnReasons\',prediction.id)}}">{{getI18n("crm.label.setup.banner.label")}}</div> </template> </div> </template></template> <lyte-modal lt-prop-show="{{lbind(showReasoningPopup)}}" on-show="{{method(\'onShow\')}}" lt-prop-height="auto" lt-prop-transition="{&quot;animation&quot;:&quot;slideFromTop&quot;,&quot;duration&quot;:&quot;0.5s&quot;}" lt-prop-offset="{&quot;top&quot;:&quot;0&quot;,&quot;left&quot;:&quot;center&quot;}" lt-prop-width="869px" lt-prop-max-height="99%" on-close="{{method(\'closeChart\')}}" data-zcqa="closeChurnReasoningPopup"> <template is="registerYield" yield-name="modal"> <lyte-modal-header> <div class="flexAlignCenter"> <lyte-text lt-prop-tooltip-config="{ &quot;position&quot; : &quot;bottom&quot; }" class="crm-font-semibold" lt-prop-value="{{reasoningHeader}}"></lyte-text> <div class="br999 crm-font-regular crm-small-font-size dIB infoCont lh20 mL10 mR20 wsNowrap pL10 pR10 vaM">{{getI18n("crm.label.scoring.rules.score")}} {{currentPrediction.value}}</div> </div> <div class="flexAlignCenter mT25"> <div class=" {{isImageAvailable}} mR20"> <img class="h40 w40 br50per" src="{{record_image}}" alt="{{entity_name}}"> </div> <div class="crm-base-font-size crm-font-regular flexOne oH w100_per"> <div class="oH flexAlignCenter mB5 crmBaseColor"> <lyte-text lt-prop-tooltip-config="{ &quot;position&quot; : &quot;bottom&quot; }" class="crm-font-semibold crm-subheading-font-size mR8" lt-prop-value="{{entity_name}}"></lyte-text> <span class="br4 br_border1 pL10 pR10 pT2 pB2 wsNowrap crm-small-font-size mR40">{{module_name}}</span> </div> <lyte-text class="crmLabelColor" lt-prop-tooltip-config="{ &quot;position&quot; : &quot;bottom&quot; }" lt-prop-value="{{record_owner_name}}"></lyte-text> </div> </div> </lyte-modal-header> <lyte-modal-content class="pB30"> <div class="crm-font-semibold crm-medium-large-font-size mB15"> {{getI18n("crm.zia.prediction.churn.reasoning.title")}} </div> <div class="br_border2 br10 pL10 pB5 pR20 pT20 mB20"> <span class="crm-font-bold crm-subheading-font-size mL20">{{getI18n("crm.zia.inducing")}}</span> <div class="flexAlignCenter mT15 {{showInducingFactors}}"> <div class="w200 h200 mR10" id="placeInducingFactors"></div> <ul class="flexOne m0 p0"> <template is="for" items="{{inducingFactors}}" item="factor" index="index"> <li class="dF flexAlignStart mB15 p0"> <template is="if" value="{{expHandlers(ifEquals(preventingFactors.length,1),\'||\',ifEquals(inducingFactors.length,1))}}"><template case="true"><div class="h20 pR flexAlignCenter br_border3 br20 prediction-chart {{chartColours[index]}} {{if(ifEquals(inducingFactors.length,1),\'w65 mR10\',\'w55 mR20\')}}"> <span class="pT3 pB3 pL20 pR10 crm-small-font-size">{{factor.score}}%</span> </div></template><template case="false"><div class="h20 mR10 w55 pR flexAlignCenter br_border3 br20 prediction-chart {{chartColours[index]}}"> <span class="pT3 pB3 pL20 pR10 crm-small-font-size">{{factor.score}}%</span> </div></template></template> <div class="lh22 flexOne crmParagraphColor">{{factor.reason}}</div> </li> </template> </ul> </div> <div class="flexAlignCenter jcCenter mL10 mT15 mB15 {{showNoInducingFactors}}"> <div class="crmNotFoundColor"> <div class="flexAlignCenter jcCenter"> <span class="churnNoFactorImg dIB"></span> </div> <div class="mT15">{{getI18n("crm.zia.noFactors")}}</div> </div> </div> </div> <div class="br_border2 br10 pR20 pB5 pL10 pT20"> <span class="crm-font-bold crm-subheading-font-size mL20">{{getI18n("crm.zia.preventing")}}</span> <div class="flexAlignCenter mT15 {{showPreventingFactors}}"> <div class="w200 h200 mR10" id="placePreventingFactors"></div> <ul class="flexOne m0 p0"> <template is="for" items="{{preventingFactors}}" item="factor" index="index"> <li class="dF flexAlignStart mB15 p0"> <template is="if" value="{{expHandlers(ifEquals(preventingFactors.length,1),\'||\',ifEquals(inducingFactors.length,1))}}"><template case="true"><div class="h20 pR flexAlignCenter br_border3 br20 prediction-chart {{chartColours[index]}} {{if(ifEquals(preventingFactors.length,1),\'w65 mR10\',\'w55 mR20\')}}"> <span class="pT3 pB3 pL20 pR10 crm-small-font-size">{{factor.score}}%</span> </div></template><template case="false"><div class="h20 mR10 w55 mR10 pR flexAlignCenter br_border3 br20 prediction-chart {{chartColours[index]}}"> <span class="pT3 pB3 pL20 pR10 crm-small-font-size">{{factor.score}}%</span> </div></template></template> <div class="lh22 flexOne crmParagraphColor">{{factor.reason}}</div> </li> </template> </ul> </div> <div class="flexAlignCenter jcCenter mL10 mT15 mB15 {{showNoPreventingFactors}}"> <div class="crmNotFoundColor"> <div class="flexAlignCenter jcCenter"> <span class="churnNoFactorImg dIB"></span> </div> <div class="mT15">{{getI18n("crm.zia.noFactors")}}</div> </div> </div> </div> </lyte-modal-content> </template> </lyte-modal> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"text",position:[1,1,0]}]}},default:{}},{type:"attr",position:[1,3]},{type:"for",position:[1,3],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,0]},{type:"text",position:[1,3,0]},{type:"text",position:[1,3,2]},{type:"attr",position:[3]},{type:"text",position:[3,0]}]}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"text",position:[1,1,3,0]},{type:"text",position:[1,1,3,2]},{type:"attr",position:[1,3,1]},{type:"attr",position:[1,3,1,1]},{type:"attr",position:[1,3,3,1,1]},{type:"componentDynamic",position:[1,3,3,1,1]},{type:"text",position:[1,3,3,1,3,0]},{type:"attr",position:[1,3,3,3]},{type:"componentDynamic",position:[1,3,3,3]},{type:"componentDynamic",position:[1]},{type:"text",position:[3,1,1]},{type:"text",position:[3,3,1,0]},{type:"attr",position:[3,3,3]},{type:"attr",position:[3,3,3,3,1]},{type:"for",position:[3,3,3,3,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"text",position:[0,1,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"text",position:[0,1,0]}]}},default:{}},{type:"text",position:[1,3,0]}]},{type:"attr",position:[3,3,5]},{type:"text",position:[3,3,5,1,3,0]},{type:"text",position:[3,5,1,0]},{type:"attr",position:[3,5,3]},{type:"attr",position:[3,5,3,3,1]},{type:"for",position:[3,5,3,3,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"text",position:[0,1,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"text",position:[0,1,0]}]}},default:{}},{type:"text",position:[1,3,0]}]},{type:"attr",position:[3,5,5]},{type:"text",position:[3,5,5,1,3,0]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[3]}],_observedAttributes:["churn_prediction","currentPrediction","iscanvas","popoverOrigin","showReasoningPopup","isKioskComponent","chartShow","record_id","entity_name","record_owner_name","isImageAvailable","record_image","module_name","showPreventingFactors","showInducingFactors","showNoPreventingFactors","showNoInducingFactors","preventingFactors","inducingFactors","reasoningHeader","chartColours","module","record"],data:function(){return{churn_prediction:Lyte.attr("array",{default:[]}),currentPrediction:Lyte.attr("object"),iscanvas:Lyte.attr("boolean",{default:!1}),popoverOrigin:Lyte.attr("string"),showReasoningPopup:Lyte.attr("boolean",{default:!1}),isKioskComponent:Lyte.attr("boolean",{default:!1}),chartShow:Lyte.attr("boolean",{default:!0}),record_id:Lyte.attr("string"),entity_name:Lyte.attr("string"),record_owner_name:Lyte.attr("string"),isImageAvailable:Lyte.attr("string",{default:"hide"}),record_image:Lyte.attr("string"),module_name:Lyte.attr("string"),showPreventingFactors:Lyte.attr("string",{default:"hide"}),showInducingFactors:Lyte.attr("string",{default:"hide"}),showNoPreventingFactors:Lyte.attr("string",{default:"hide"}),showNoInducingFactors:Lyte.attr("string",{default:"hide"}),preventingFactors:Lyte.attr("array"),inducingFactors:Lyte.attr("array"),reasoningHeader:Lyte.attr("string"),chartColours:Lyte.attr("array",{default:["chart-warning","chart-secondary","chart-success","chart-primary","chart-danger"]}),module:Lyte.attr("string"),record:Lyte.attr("object")}},actions:{getChurnReasons:function(t){var e;this.getData("churn_prediction").filter((function(o){o.id===t&&(e=o)}));var o,a=document.querySelector("crm-detailview-canvas"),n=this.getData("iscanvas");if(this.getData("isKioskComponent")){var i=this.getData("record");o=moduleRecordMapping[this.getData("module")],this.setData({currentPrediction:e,reasoningHeader:e.name.concat(" - ").concat(I18n.getMsg("crm.churn.reasoning.header")),module_name:o.singular_label,record_id:i.id,entity_name:i.name,record_owner_name:i.Owner.name})}else{if(void 0===this.getData("module")){if(n)o=moduleRecordMapping[a.getData("module")];else{var r=returnJson.tabId;o=store.peekRecord("module",r)}var s=n?a.getData("entityDetails"):returnJson[o.module_name],l=s.entityName,c=n?a.getData("record").Owner.name:returnJson.entityMapJson.SMOWNERID.defaultvalue,d=n?a.getData("entityId"):s.entityid;this.setData({currentPrediction:e,reasoningHeader:e.name.concat(" - ").concat(I18n.getMsg("crm.churn.reasoning.header")),module_name:o.singular_label,record_id:d,entity_name:l,record_owner_name:c})}else{i=this.getData("record");o=moduleRecordMapping[this.getData("module")],this.setData({currentPrediction:e,reasoningHeader:e.name.concat(" - ").concat(I18n.getMsg("crm.churn.reasoning.header")),module_name:o.singular_label,record_id:i.id,entity_name:void 0===i.Name?i.Full_Name:i.Name,record_owner_name:i.Owner.name})}var p=document.querySelector("crm-detail-view-avatarupload");if(p){var u=p.component.getData("avatar"),m=p.component.getData("ziaVisionStage");m&&"image_approval"===m||this.setData({record_image:u,isImageAvailable:""})}}commonUtils.showHideLoadingDiv(!0);var _=this;Crm.client_tracking("Churn Reason click"),store.findRecord("dummy",t,{},void 0,!1,{url:"crm/v5/"+o.api_name+"/"+this.getData("record_id")+"/actions/zia_reasoning?feature=churn_prediction&config_id="+t}).then((function(t){if(t.zia_reasoning&&t.zia_reasoning.churn_prediction){var e=t.zia_reasoning.churn_prediction;_.setData({preventingFactors:e.positive_facts.field_reasonings,inducingFactors:e.negative_facts.field_reasonings}),_.setData({showPreventingFactors:e.positive_facts.field_reasonings.length>0?"":"hide",showInducingFactors:e.negative_facts.field_reasonings.length>0?"":"hide"}),_.setData({showNoPreventingFactors:""===_.getData("showPreventingFactors")?"hide":"",showNoInducingFactors:""===_.getData("showInducingFactors")?"hide":""})}_.methods.constructChartData(_),_.setData("showReasoningPopup",!0),commonUtils.showHideLoadingDiv(!1)}),(function(){_.setData("showReasoningPopup",!0),commonUtils.showHideLoadingDiv(!1)}))},customAlignX:function(t,e,o){var a=o.getBoundingClientRect();return t.plotarea.left+t.plotarea.width/2-a.width/2},customAlignY:function(t,e,o){var a=o.getBoundingClientRect();return t.plotarea.top+t.plotarea.height/2-a.height/2}},methods:{onShow:function(t){let e=t.childComp;var o=$L(e).find("lyte-modal-content"),a=o.scrollTop(0),n=$L(e).find("lyte-modal-header");a>0&&n.addClass("chartBoxShadow"),o.on("scroll",(function(){var t=$L(e).find("lyte-modal-content").scrollTop(),o=$L(e).find("lyte-modal-header");0===t?o.removeClass("chartBoxShadow"):o.addClass("chartBoxShadow")}))},closeChart:function(){var t=$L("#placeInducingFactors .d3container");t.length&&t[0].__data__.destroy();var e=$L("#placePreventingFactors .d3container");e.length&&e[0].__data__.destroy(),this.setData("showReasoningPopup",!1)},constructChartData:function(t){for(var e=t,o=[],a=[],n=e.getData("preventingFactors"),i=e.getData("inducingFactors"),r=n.length,s=i.length,l=e.getData("currentPrediction").value,c=0;c<r;c++){(d=[]).push(n[c].reason),d.push(n[c].score),o.push(d)}for(c=0;c<s;c++){var d;(d=[]).push(i[c].reason),d.push(i[c].score),a.push(d)}e.methods.preventingFactorsChart(o,100-l,e),e.methods.inducingFactorsChart(a,l,e)},preventingFactorsChart:function(t,e,o){setTimeout((function(){var a={chart:{plot:{plotoptions:{pie:{outerPadding:10,innerRadius:"80%",startAngle:-3.14,endAngle:3.14,strokeColor:"transparent",gradients:{type:"radial",options:{radial:{radius:100,stopOffset:["60%","70%","71%","100%"],colorGamma:[.25,.25,0,0]}}},animation:{easingType:"back-out",type:"inner"},events:{enabled:!1}}},border:{show:!1}},marginTop:0,marginLeft:0},metadata:{axes:{x:[0],y:[[1]],tooltip:["<div style='text-align:center;'><span style='font-size:18px;'>{{val(0)}}</span><br>{{col(1)}} : {{val(1)}}</div>"]},columns:[{dataindex:0,columnname:"Status",datatype:"ordinal"},{dataindex:1,columnname:"Bugs count",datatype:"numeric"}]},seriesdata:{chartdata:[{type:"pie",data:[t]}]},notes:{enabled:!0,chartValues:[{x:o.actions.customAlignX,y:o.actions.customAlignY,type:"customNote",htmlEl:"<div class='aligncenter'><div class='crm-font-bold crmBaseColor crm-heading-font-size'>"+e+"</div><div class='mT10 crm-base-font-size crmBaseColor crm-font-regular'>"+I18n.getMsg("crm.label.scoring.rules.score")+"</div></div>",description:I18n.getMsg("crm.label.scoring.rules.score"),id:"chart_left_brace__double_quote_x_double_quote__colon__double_quote_customAnnotationX_double_quote__comma__double_quote_y_double_quote__colon__double_quote_customAnnotationY_double_quote__comma__double_quote_type_double_quote__colon__double_quote_customNote_double_quote__comma__double_quote_htmlEl_double_quote__colon__double_quote_customAnnotationHTML1_double_quote__comma__double_quote_description_double_quote__colon__double_quote_All_underscore_space_underscore_Bugs_double_quote__right_brace"}]},canvas:{subtitle:{show:!1},title:{show:!1},border:{show:!1},shadow:{show:!1}},legend:{colors:["#E89D25","#9775FA","#00B894","#0884E3","#F14949"],vAlign:"center",hAlign:"right",colorBox:{shape:"circle"},enabled:!1},tooltip:{enabled:!1}};CrmChartUtil.renderChart(document.getElementById("placePreventingFactors"),a,!0)}),500)},inducingFactorsChart:function(t,e,o){setTimeout((function(){var a={chart:{plot:{plotoptions:{pie:{outerPadding:10,innerRadius:"80%",startAngle:-3.14,endAngle:3.14,strokeColor:"transparent",gradients:{type:"radial",options:{radial:{radius:100,stopOffset:["60%","70%","71%","100%"],colorGamma:[.25,.25,0,0]}}},animation:{easingType:"back-out",type:"inner"},events:{enabled:!1}}}},marginTop:0,marginLeft:0},metadata:{axes:{x:[0],y:[[1]],tooltip:["<div style='text-align:center;'><span style='font-size:18px;'>{{val(0)}}</span><br>{{col(1)}} : {{val(1)}}</div>"]},columns:[{dataindex:0,columnname:"Status",datatype:"ordinal"},{dataindex:1,columnname:"Bugs count",datatype:"numeric"}]},seriesdata:{chartdata:[{type:"pie",data:[t]}]},notes:{enabled:!0,chartValues:[{x:o.actions.customAlignX,y:o.actions.customAlignY,type:"customNote",htmlEl:"<div class='aligncenter'><div class='crm-font-bold crmBaseColor crm-heading-font-size'>"+e+"</div><div class='mT10 crm-base-font-size crmBaseColor crm-font-regular'>"+I18n.getMsg("crm.label.scoring.rules.score")+"</div></div>",description:I18n.getMsg("crm.label.scoring.rules.score"),id:"chart_left_brace__double_quote_x_double_quote__colon__double_quote_customAnnotationX_double_quote__comma__double_quote_y_double_quote__colon__double_quote_customAnnotationY_double_quote__comma__double_quote_type_double_quote__colon__double_quote_customNote_double_quote__comma__double_quote_htmlEl_double_quote__colon__double_quote_customAnnotationHTML1_double_quote__comma__double_quote_description_double_quote__colon__double_quote_All_underscore_space_underscore_Bugs_double_quote__right_brace"}]},canvas:{subtitle:{show:!1},title:{show:!1},border:{show:!1},shadow:{show:!1}},legend:{colors:["#E89D25","#9775FA","#00B894","#0884E3","#F14949"],vAlign:"center",hAlign:"right",colorBox:{shape:"circle"},enabled:!1},tooltip:{enabled:!1}};CrmChartUtil.renderChart(document.getElementById("placeInducingFactors"),a,!0)}),500)}}});
