Lyte.Mixin.register("crm-email-auth-util",{getResources:function(){var e=[];e=(e=e.concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("emaildeliverability")],ResourceConstants.CRM))).concat(networkUtils.returnDependencyFiles(["crm-email-deliverability-handling.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT)).concat(networkUtils.returnDependencyFiles(["crm-email-deliverability-handling.js"],ResourceConstants.CRMClient)),Lyte.injectResources(e,void 0,void 0)},setMessageForFromAddress:function(e,t,i,a,s,o,r,n){var l,d="",m="NA",c={};c.email=t,c.source=a,c.isAdmin=Crm.userDetails.IS_ADMIN,e="email_compose"===a?e.parents(".etSenderdetails"):e;try{l=e.parents("tr")}catch(t){l=e}var p="#emailInfoSection",u="email_compose"===a?e.next("crm-email-deliverability-handling"):a&&a.toLowerCase().includes("autoresponder")?l.next(p):$L("crm-email-deliverability-handling"),f="email_compose"===a?e.next("crm-email-deliverability-handling"):a&&a.toLowerCase().includes("autoresponder")?l.next(p):$L(p),v=!0,g=$L(e),h=$L("#removeReplyTo"),L=!1;if(void 0!==i&&""!==t){if(t&&(t.value&&!t.value.includes("@")||!t.value&&!t.includes("@"))&&i.user_auth_reqd){if(m="user",!Crm.userDetails.isEmailAuthCheckEnabled){var y=I18n.getMsg("crm.emailauth.paid.user.domain.deadline",Crm.appName);c.heading=y.split(":")[0],c.message=y.split(":")[1]}}else if(d=(d=t.split("@")[1])?d.toLowerCase():d,i.hasOwnProperty(d)){var _=i[d];if(_.relayConfigForDomain&&"meeting_creation"!==a&&(L=!!_.relayConfigForDomain.includes("ALL")||(_.relayConfigForDomain.includes("AUTOMATED")&&(void 0===a||["emailNotifList","emailActionList","bluePrintNotifList","webform","blueprint"].includes(a))||_.relayConfigForDomain.includes("MASS_MAIL")&&["massEmail","massMailList","autoResponder","macro","autoResponder_Pop","autoResponder_rules","campaign"].includes(a)||_.relayConfigForDomain.includes("INDIVIDUAL")&&["email_compose","activity_compose"].includes(a))),!L&&(_.public_domain?m="free":"not_verified"!==_.DKIM_status&&"not_configured"!==_.DKIM_status&&"verified"===_.email_verified||(m="required"),_.message)){y=_.message;c.heading=y.split(":")[0],c.message=y.split(":")[1]}"massEmail"!==a&&"massMailList"!==a||null!==_.DMARC_status||!Crm.userDetails.isAutoSyncNDmarcFeatureEnabled||(c.isDMARCInfoNeeded=!0)}var D=!1;try{D=$L.moment().toDate().getTime()>Crm.userDetails.emailAuthDate}catch(e){D=!0}Crm.userDetails.isEmailAuthCheckEnabled||!D||!c.message&&!c.heading||!n&&"massEmail"!==a&&"massMailList"!==a||(delete c.message,delete c.heading);var C=event&&event.target&&"SCRIPT"!==event.target.tagName&&("LI"===event.target.tagName||"SPAN"===event.target.tagName||"massEmail"!==a&&"blueprint"!==a&&"WebForm"!==a&&"autoResponder_rules"!==a&&"LINK"===event.target.tagName||"LYTE-DROP-ITEM"===event.target.tagName||"macro"===a&&"LYTE-YIELD"===event.target.tagName);if(!(u.length>0)||$("#wf_Container_p").length>0&&$L("#existAlertList").is(":visible")&&void 0!==a||"bluePrintNotifList"===a||"emailActionList"===a||a&&a.toLowerCase().includes("autoresponder")&&!C||(u.length>0&&u.get(0).remove(),f.length>0&&f.get(0).remove()),"NA"!==m||c.isDMARCInfoNeeded){if(e=$L(e),c.domain=d,c.statusStr=m,r&&(c.sendMailEleIdForMeeting=r),(u=document.createElement("crm-email-deliverability-handling")).setData(c),"emailNotifList"===a){$L("#saveAlert").prop("disabled",!1);var A=$($.parseHTML('<td colspan="'+e.children().length+'" class="pR0 pT0 pB20"> ')).html(u);u=T=$($.parseHTML('<tr class="eaWfInfoDiv" id="emailInfoSection">')).html(A)}else if("emailActionList"===a){A=$($.parseHTML('<td colspan="'+e.children().length+'" class="pLR40"> ')).html(u);u=T=$($.parseHTML('<tr class="eaWfInfoDiv" id="emailInfoSection">')).html(A)}else if("bluePrintNotifList"===a){e=e.parents("div.pb_associateDiv"),u=$($.parseHTML('<div class="pR zi1 eaElement">')).html(u)}else if("email_compose"===a){var R=$(e.find("select"));if(EmailComposeUtil&&(EmailComposeUtil.configuredEmail===t||null!=EmailComposeUtil.configuredEmail&&""!=EmailComposeUtil.configuredEmail)&&R&&"true"!==R.find("option:selected").attr("isorgemail"))return}else if("massEmail"===a||"massMailList"===a||"autoResponder"===a||"autoResponder_Pop"===a||"autoResponder_rules"===a||"campaign"===a){var b=$($.parseHTML("<td>")),T=$($.parseHTML('<tr id="emailInfoSection">')).append(b);e.is(":visible")||(T=$($.parseHTML('<tr id="emailInfoSection" class="dN">')).append(b));A=$($.parseHTML('<td style="border: none;padding:0 !important;"> ')).html(u);if(u=T=T.append(A),e.is(":visible")&&!o.is(":visible")||(v=!1),e=l.length>1?$(l[0]):l,"autoResponder_Pop"===a){var M=e.next(p);M.length>0&&M.get(0).remove()}}else if("activity_compose"===a)$L("#eAInfoDiv").css("display","block"),e=$L(".from.simpleEmail_text");else if(a&&"webform"===a.toLowerCase()){var I="none",w="display",E=$(".autoRespTempId_fromTR"),P=E.length>0?E:$(".defaultRespTempId_fromTR"),N="dN",S=!P.is(":visible")?N:"";P.append($($.parseHTML('<div id="emailInfoSection" class="'+S+'">')).html(u)),e.is(":visible")||(v=!1),$(".defaultRespTempId_fromTR .wbr_configInnerLbl").addClass("eAKeyVal"),E.next("div").addClass("eAKeyVal")}else if("blueprint"===a){I="none",w="display",N="dN",S=e.css(w)===I?N:"";var F=$($.parseHTML('<div class="wf_form_lab alignRight">')),U=$($.parseHTML('<fieldset id="emailInfoSection" class="'+S+' mB10">'));U.append(F),u=U.append(u),e.is(":visible")&&o.length>0&&!o.is(":visible")||(v=!1)}else if("meeting_creation"===a){if(!c.message)return window.onpopstate=function(){$("crm-email-deliverability-handling").remove()},document.body.appendChild(u),!0}else e.is(":visible")||(v=!1);if(v&&"email_compose"!==a&&"emailNotifList"!==a&&s&&(s.click(),"macro"!==a||o&&0!==o.length||$L("crm-macro-ce")[0].component.setData("emailReplyTo",g[0].component.data.cxPropSelected)),o&&o.length>0){if(o[0].component){if(o[0].ltProp("disabledList",["none"]),"macro"===a&&o[0].component.setData("cxPropDisabledList",["None"]),"portal"===a&&h.hide(),C||"none"===o[0].ltProp("selected")||""===o[0].ltProp("selected")){if((x=o.parents("crm-alert-addresswrapper"))&&x.length>0){var k=x[0].component.data.addressDetails;x[0].component.executeMethod("setAddressType",event,e[0].ltProp("selected"),o[0].component,$L("#"+k.addressIdentifier+"Body").find("lyte-drop-item[data-value='"+e[0].ltProp("selected")+"']")),x[0].component.data.addressDetails.address=e[0].ltProp("selected")}o[0].ltProp("selected",g[0].ltProp("selected")),"AutoResponse"===a&&o[0].ltProp("displayValue",g[0].ltProp("displayValue")),"macro"===a&&o[0].component.setData("cxPropSelected",g[0].component.data.cxPropSelected)}}else(H=$(o.children().eq(0))).data().data?H.data().data.disabled=!0:H.prop("disabled",!0),(C||""===$(o).val()||null===$(o).val())&&$(o).val(g.val()).change();$L(o).addClass("mandatory")}}else{if(o&&C){var x,H;if(o.length>0&&o[0].component){if(o[0].ltProp("disabledList",[]),"portal"===a&&h.css("display","block"),o[0].ltProp("selected","none"),(x=o.parents("crm-alert-addresswrapper"))&&x.length>0){k=x[0].component.data.addressDetails;x[0].component.executeMethod("setAddressType",event,"none",o[0].component,$L("#"+k.addressIdentifier+"Body").find("lyte-drop-item[data-value='none']")),x[0].component.data.addressDetails.address="none"}}else(H=$(o.children().eq(0))).data().data?H.data().data.disabled=!1:H.prop("disabled",!1),$(o).val("").change();$L(o).removeClass("mandatory")}$("#wf_Container_p").length>0&&"emailNotifList"===a||("email_compose"!==a&&f.length>0&&f.get(0).remove(),u.length>0&&u.get(0).remove())}("NA"!==m||c.isDMARCInfoNeeded)&&(0===$L("crm-email-deliverability-handling").length||"emailNotifList"===a||"emailActionList"===a||"email_compose"===a||"bluePrintNotifList"===a||a&&a.toLowerCase().includes("autoresponder"))&&$(e).after(u),"AutoResponse"===a&&$L(e).closest(".arr_ownCriteriaViewBox")[0].scrollIntoView({block:"end",behavior:"smooth"})}},getDomainsAuthNPolicy:function(e,t,i,a,s,o,r){var n=RebrandLinkUtil.getProperty("DeploymentLocation"),l=["US","AU","EU","China","JP","IN","CA","SA"].includes(n);$L.moment("").toDate();if(Crm.userDetails.isEmailAuthCheckEnabled||l){var d=store.peekRecord("user",Crm.userDetails.USER_ID)?store.peekRecord("user",Crm.userDetails.USER_ID).domain_auth_status:void 0,m=this;if(void 0===d||void 0===e)Lyte.resolvePromises({userDetails:store.peekRecord("user",Crm.userDetails.USER_ID)?store.peekRecord("user",Crm.userDetails.USER_ID):store.findAll("user",Crm.userDetails.USER_ID),authStatus:store.findAll("dummy",void 0,!1,!1,{url:"/crm/email/v2/settings/emails/authentication/actions/domain_auth_status"})}).then(function(n){n=n.authStatus;var l=[];l=(l=l.concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("emaildeliverability")],ResourceConstants.CRM))).concat(networkUtils.returnDependencyFiles(["crm-email-deliverability-handling.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT)).concat(networkUtils.returnDependencyFiles(["crm-email-deliverability-handling.js"],ResourceConstants.CRMClient)),Lyte.injectResources(l,void 0,(function(){networkUtils.lyteInitiateRequest("/crm/email/v3/settings/emails/relays","GET").then((function(l){if(n){l&&(n.relayConfig=l.email_relays);var d=m.setEmailAuthResponse(n);if(e)return m.setMessageForFromAddress(e,t,d,i,a,s,o,r)}}),(function(){var l=m.setEmailAuthResponse(n);if(e)return m.setMessageForFromAddress(e,t,l,i,a,s,o,r)}))}))}.bind(this));else if(e)return this.setMessageForFromAddress(e,t,d,i,a,s,o,r)}},setEmailAuthResponse:function(e,t){var i=e.email_auth,a={},s=[],o=e.relayConfig?e.relayConfig:[];return i.forEach((function(e){var t=e.domain_name;delete e.domain_name;var i=o?o.filter((e=>e.domain===t)):null;e.relayConfigForDomain=i&&i.length>0&&i[0].active&&i[0].mail_sending_availability?i[0].features:[],a[t]=e;var r=e.DKIM_status,n=e.public_domain;"not_verified"!==r&&"not_configured"!==r&&"not_verified"!==e.email_verified||n?n&&"user"===e.type&&!a.hasOwnProperty("user_auth_reqd")&&(a.user_auth_reqd=!0):("not_configured"===r&&s.push(t),"user"!==e.type||a.hasOwnProperty("user_auth_reqd")||(a.user_auth_reqd=!0))})),store.peekRecord("user",Crm.userDetails.USER_ID).domain_auth_status=a,"emailAuth"===t&&(a.domainNotConfigured=s),a},setReplyToDropAfterTemplateSelect:function(e){var t=$L("#emailInfoSection");if(t.length>0&&"livechat"!==e){var i=$L("#replyToLink"),a=$L("#fromAddress"),s=$L("#replyToAddress");if("AutoResponderDynamic"!==e&&"AutoResponder_Pop"!==e&&t.removeClass("dN"),"WorkFlowAlert"===e)a=$("#fromAddressDropDown"),s=$L("#replyToAddressDropDown");else if("email_notification"===e)a=$L("#from_dropdown"),s=$L("#reply_dropdown");else if("WebFormAck"===e||"WebForm"===e)a=$L("#fromAddresDropDown"),s=$L("#replyAddresDropDown");else if("ProcessFlow"===e)a=$("#fromAddresDropDown"),s=$L("#replyToAddresDropDown");else if("MassMail"===template.featureName||"ConsentMail"===template.featureName){var o=$(a).find("option:selected"),r=o.text(),n=o.attr("type");"1"===n?r=o.attr("email"):"3"===n&&(r=o.val()),Lyte.registeredMixins["crm-email-auth-util"].getDomainsAuthNPolicy(a,r,"campaign",i,s)}else if("MassMail_unification"===e)a=$("#mm-fromAddress"),s=$L("#replToSec");else if("AutoResponderDynamic"===e){i=$L("#dynamicreplyToLink"),a=$("#dynamicfromAddress"),s=$L("#dynamicreplyToAddress");var l="#emailInfoSection";$L(".dynamictemplateId_fromTR").next(l).removeClass("dN")}else if("AutoResponder_Pop"===e){i=$L("#pop_replyToLink"),a=$("#pop_fromAddress"),s=$L("#pop_replyToAddress");l="#emailInfoSection";$L(".pop_templateId_fromTR").next(l).removeClass("dN")}"WorkFlowAlert"===e?template.showReplyTo(i,"replyToTR"):"email_notification"===e?(i[0].classList.add("dN"),$L("email-notification")[0].component.setData("showReplyTo",!0),template.showReplyTo(i,"replyToTR")):i.click(),s.length>0&&a.length>0&&(!s[0].component||"none"!==s[0].ltProp("selected")&&""!==s[0].ltProp("selected")?"none"!==s.val()&&""!==s.val()||$(s).val(a.val()).change():s[0].ltProp("selected",a[0].ltProp("selected")))}},showPopUpForEventModule:function(e,t){var i=$("#eventCreateDelPopup");if((event&&event.currentTarget&&$(event.currentTarget).attr("id")||t)&&(0===i.length||i.length>0&&!i[0].ltProp("show"))&&Lyte.registeredMixins["crm-email-auth-util"].getDomainsAuthNPolicy($("<div>"),$("<div/>").html(Crm.userDetails.EMAIL).text(),"meeting_creation",void 0,void 0,e))return!0;$("crm-email-deliverability-handling").remove()}});
