Lyte.Component.register("crm-notes",{_template:'<template tag-name="crm-notes"><template is="if" value="{{lyteViewPort}}"><template case="true"><dummy-port-element></dummy-port-element> <div class="rl_NoRec"> <div class="mR5 dvNoRecordsText">{{getI18n(\'crm.admin.loading\')}}</div> </div> <dummy-port-element></dummy-port-element></template><template case="false"> <crux-note id="{{uniqueClass}}" all-notes-count="{{lbind(totalNotesCount)}}" cx-prop-related-list="{{cxPropRelatedList}}" cx-prop-footer-right-prefix-yield="{{cxPropFooterRightPrefixYield}}" cx-prop-note-header-suffix-yield="{{lbind(cxPropNoteHeaderSuffixYield)}}" cx-prop-entity="{{cxPropEntity}}" cx-prop-module="{{cxPropModule}}" relid="{{relid}}" cx-prop-selected-filter="{{lbind(cxPropSelectedFilter)}}" class="crm_zia_notes_summary_comp" cx-prop-prefix-yield="{{cxPropPrefixYield}}" cx-prop-show-notes-edit="{{cxPropShowNotesEdit}}" cx-prop-show-notes-delete="{{cxPropShowNotesDelete}}" cx-prop-show-add-note="{{cxPropShowAddNote}}" cx-prop-note-count="{{cxPropNoteCount}}" cx-prop-forced-fetch="{{cxPropForcedFetch}}" on-note-added="{{method(\'onNotedAddedMethod\')}}" on-note-edited="{{method(\'onNoteEditedMethod\')}}" on-note-deleted="{{method(\'onNoteDeletedMethod\')}}" on-after-render="{{method(\'onAfterRenderMethod\')}}" cx-prop-mention-query-param="{{cxPropMentionQueryParam}}" cx-prop-empty-note-message="{{cxPropEmptyNoteMessage}}" cx-prop-query-param="{{cxPropQueryParam}}" cx-prop-disable-attachment-actions="{{cxPropDisableAttachmentActions}}"> <template is="if" value="{{expHandlers(expHandlers(activityModule,\'!\'),\'&amp;&amp;\',expHandlers(isPortalUser,\'!\'))}}"><template case="true"><template is="registerYield" yield-name="cxNotePrefixYield"> <template is="if" value="{{expHandlers(timelineDataAvailable,\'&amp;&amp;\',expHandlers(noteData.Associated_Id__s,\'!=\',null))}}"><template case="true"> <div id="nid_{{noteData.id}}" class="cP" onclick="{{action(\'navigateToTimeline\',this)}}"> <crm-timeline-log-notes record-id="{{cxPropEntity.id}}" module="{{cxPropModule}}" n-id="{{getValueFromInnerObject(timelineIdVsObj,noteData.Associated_Id__s,&quot;nId&quot;)}}" item="{{getValueFromInnerObject(timelineIdVsObj,noteData.Associated_Id__s,&quot;timelineLog&quot;)}}" fromcanvas="{{fromCanvas}}" log-available="{{getValueFromInnerObject(timelineIdVsObj,noteData.Associated_Id__s,&quot;logAvailable&quot;)}}"></crm-timeline-log-notes> </div> </template></template> </template></template></template> <template is="registerYield" class="cxFooterRightPrefixYield" yield-name="cxNoteRightPrefixYield"> <template is="if" value="{{getUserDetail(\'IS_SMART_PROMPT_AVAILABLE\')}}"><template case="true"> <crm-zia-smart-prompt-icon class="mR10 dB" icon-type="link" focused-area="notes" id="notesSmartPromptIcon" note-type="content" from-crux="true" crux-notes-id="{{uniqueClass}}" record="{{cxPropEntity}}"> </crm-zia-smart-prompt-icon> </template></template> </template> <template is="registerYield" yield-name="cxNoteHeaderSuffixYield"> <div id="summarizeNotesDetail_{{uniqueClass}}"> </div> <span id="summarizeNotes" class="cP crmLinkColor mR12" data-zcqa="summarize_notes" onclick="{{action(\'injectNotesSummaryComponent\')}}"> {{getI18n(\'crm.zia.summary.summarize\')}}</span> </template> </crux-note> </template></template></template>',_dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"componentDynamic",position:[0]},{type:"text",position:[2,1,0]},{type:"componentDynamic",position:[4]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"registerYield",position:[0],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"componentDynamic",position:[1,1]}]}},default:{}}]}]}},default:{}},{type:"registerYield",position:[1,3],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}}]},{type:"registerYield",position:[1,5],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[3]},{type:"text",position:[3,1]}]},{type:"componentDynamic",position:[1]}]}},default:{}}],_observedAttributes:["uniqueClass","cxPropFooterRightPrefixYield","fromNewDetail","fromCanvas","cxPropNoteHeaderSuffixYield","totalNotesCount","cxPropEntity","cxPropModule","relid","cxPropSelectedFilter","cxPropPrefixYield","cxPropNoteCount","cxPropForcedFetch","cxPropMentionQueryParam","cxPropFooterRightPrefixYield","cxPropRelatedList","cxPropShowNotesEdit","cxPropShowNotesDelete","cxPropShowAddNote","cxPropQueryParam","cxPropRelatedList","activityModule","isPortalUser","cxPropShowAddNote","lyteViewPort","cxPropDisableAttachmentActions","cxPropEmptyNoteMessage","timelineDataAvailable","timelineIdVsObj"],data:function(){return{uniqueClass:Lyte.attr("string"),cxPropFooterRightPrefixYield:Lyte.attr("boolean"),fromNewDetail:Lyte.attr("boolean",{default:!1}),fromCanvas:Lyte.attr("boolean",{default:!0}),cxPropNoteHeaderSuffixYield:Lyte.attr("boolean",{default:!1}),totalNotesCount:Lyte.attr("number",{default:0}),cxPropEntity:Lyte.attr("object",{default:{}}),cxPropModule:Lyte.attr("string",{default:""}),relid:Lyte.attr("string",{default:""}),cxPropSelectedFilter:Lyte.attr("string",{default:""}),cxPropPrefixYield:Lyte.attr("string",{default:""}),cxPropNoteCount:Lyte.attr("string",{default:""}),cxPropForcedFetch:Lyte.attr("string",{default:""}),cxPropMentionQueryParam:Lyte.attr("string",{default:""}),cxPropFooterRightPrefixYield:Lyte.attr("boolean",{default:!1}),cxPropRelatedList:Lyte.attr("object"),cxPropShowNotesEdit:Lyte.attr("string",{default:""}),cxPropShowNotesDelete:Lyte.attr("string",{default:""}),cxPropShowAddNote:Lyte.attr("string",{default:""}),cxPropQueryParam:Lyte.attr("object",{default:{}}),cxPropRelatedList:Lyte.attr("object"),activityModule:Lyte.attr("boolean",{default:!1}),isPortalUser:Lyte.attr("boolean",{default:!!clientPortalName}),cxPropShowAddNote:Lyte.attr("boolean",{default:!0}),lyteViewPort:Lyte.attr("boolean",{default:!0}),cxPropDisableAttachmentActions:Lyte.attr("string",{default:!1}),cxPropEmptyNoteMessage:Lyte.attr("string"),timelineDataAvailable:Lyte.attr("boolean",{default:!1}),timelineIdVsObj:Lyte.attr("object",{default:{}})}},actions:{navigateToTimeline:function(e){this.data.fromNewDetail&&detailView.navigateToTimeline(e)},injectNotesSummaryComponent:function(){var e=this,t=o(e);function o(e){var t="#summarizeNotesDetail_"+e.getData("uniqueClass");return $L(t)[0]&&$L(t)[0].querySelector("crm-zia-notes-summary")}t?(t.component.executeMethod("showNotesSummaryModal"),t=void 0):Lyte.injectResources([networkUtils.returnDependencyFiles(["crm-zia-notes-summary.js","crm-zia-feedback.js"],ResourceConstants.CRMClient),networkUtils.returnDependencyFiles(["crm-zia-notes-summary.css","crm-zia-feedback.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT),networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("ZiaSummary")],ResourceConstants.CRM)],void 0,(function(){Lyte.Component.render("crm-zia-notes-summary",{module:e.getData("cxPropModule"),recordId:e.getData("cxPropEntity.id"),fromCanvas:!0},"#summarizeNotesDetail_"+e.getData("uniqueClass")),(t=o(e)).component.executeMethod("showNotesSummaryModal"),t=void 0}))}},init:function(){this.loadDependencyFiles();var e=100*Math.random(),t=Math.random()*e,o=Math.floor(e*t);this.setData({uniqueClass:"uniqueClass"+o,cxPropDisableAttachmentActions:!!(!Crm.userDetails.permissions||!Crm.userDetails.permissions.Crm_Implied_Create_Attachments)}),["Tasks","Events","Meetings","Calls"].includes(this.data.cxPropModule)&&this.setData("activityModule",!0)},loadDependencyFiles:function(){Lyte.injectResources(networkUtils.returnDependencyFiles(["crm-global-search.js"],ResourceConstants.CRMClient))},updateTimeLine(){this.getData("fromNewDetail")?(Lyte.triggerEvent("refreshTimelineInteractions"),Lyte.triggerEvent("detail_view_data_listener_"+this.getData("unique_listener_id"),{isrecordEdited:!0})):Crm.userDetails.timelineRevamp?Lyte.triggerEvent("ajaxEditTimeline"):refreshFollowDiv()},methods:{onNotedAddedMethod:function(){if(this.setData("timelineDataAvailable",!1),this.getMethods("onNoteAdded")&&this.executeMethod("onNoteAdded"),this.updateTimeLine(),Crm.userDetails.IS_SMART_PROMPT_AVAILABLE){var e=$L("#advancePromptModel")[0];e&&e.ltProp("show",!1)}featuresAvailable.ZIA_SUMMARY&&Crm.userDetails.permissions.Crm_Implied_View_Zia_Notes_Summary&&this.getData("totalNotesCount")>0&&!this.getData("cxPropNoteHeaderSuffixYield")&&this.setData("cxPropNoteHeaderSuffixYield",!0)},onNoteEditedMethod:function(){if(this.setData("timelineDataAvailable",!1),this.getMethods("onNoteEdited")&&this.executeMethod("onNoteEdited"),this.updateTimeLine(),Crm.userDetails.IS_SMART_PROMPT_AVAILABLE){var e=$L("#advancePromptModel")[0];e&&e.ltProp("show",!1)}},onNoteDeletedMethod:function(e){e.setData("timelineDataAvailable",!1),this.getMethods("onNoteDeleted")&&this.executeMethod("onNoteDeleted",e),this.updateTimeLine(),Crm.userDetails.isRelatedListLyteEnabled&&Lyte.triggerEvent("notesCount",{comp:e}),featuresAvailable.ZIA_SUMMARY&&Crm.userDetails.permissions.Crm_Implied_View_Zia_Notes_Summary&&0===this.getData("totalNotesCount")&&this.getData("cxPropNoteHeaderSuffixYield")&&this.setData("cxPropNoteHeaderSuffixYield",!1)},onAfterRenderMethod:function(e,t){if(Crm.userDetails.isRelatedListLyteEnabled){var o=this;Crm.userDetails.IS_SMART_PROMPT_AVAILABLE&&e.setMethods({onEditNoteRendered:function(e){Lyte.Component.render("crm-zia-smart-prompt-icon",{iconType:"link",focusedArea:"notes",id:"notesSmartPromptIcon",noteType:"content",record:e,fromCrux:!0,cruxNotesId:o.data.uniqueClass},".cxMlAuto.cxNotesFooterRight .cxFooterRightPrefixYield")}})}if(Crm.userDetails.timelineRevamp){var i=this,a=this.getData("cxPropEntity").id,r=(t=e.data.allNotes).map((function(e){if(e.Associated_Id__s)return e.Associated_Id__s})).filter((e=>void 0!==e)),s=r.filter((function(e){if(null!==e)return e})),n={};if(r.length>0){if(s&&s.length>0){var l={field:{api_name:"id"},comparator:"in",value:s};n.filters=l}n.include_inner_details="navigation_token,field_history.field_label,field_history.data_type,field_history.enable_colour_code,field_history.pick_list_values,field_history.actual_value,done_by.type__s,done_by.profile",n.include_timeline_types="signals",n.include="extension,type",i.setData("timelineDataAvailable",!1);var d=Crm.moduleInfo[this.getData("cxPropModule")].Id;store.triggerAction(d,"timelines",{recordId:a},n).then((function(o){var a=o.timelines,r={};a&&a.forEach((function(e){var t=e.id;r[t]=e}),r);for(var s=i.getData("timelineIdVsObj"),n=t.length,l={timelineId:"",nId:"",timelineLog:"",logAvailable:""},d=0;d<n;d++){var c={...l},m=t[d];if(null!==m.Associated_Id__s){var p=r[m.Associated_Id__s];c.timelineId=m.Associated_Id__s,c.nId=m.id,c.timelineLog=p||null,c.logAvailable=!!p,s[m.Associated_Id__s]=c}}i.setData({timelineDataAvailable:!0,timelineIdVsObj:s}),e.setColorBox()}))}}if(Crm.userDetails.IS_SMART_PROMPT_AVAILABLE){var c=$L(e.$node),m=c[0].getBoundingClientRect().width,p="link";m<=450&&(p="box",c.addClass("cxNoteMinWidth"));var u=this;this.setData("smartPromptIconType",p),e.setMethods({onEditNoteRendered:function(e){var t=u.getData("uniqueClass");Lyte.Component.render("crm-zia-smart-prompt-icon",{class:"dB mR8",iconType:p,focusedArea:"notes",id:"notesSmartPromptIcon",noteType:"content",cruxNotesId:t,record:e},".cxMlAuto.cxNotesFooterRight .cxFooterRightPrefixYield")}})}this.getMethods("onAfterRender")&&this.executeMethod("onAfterRender",e,t),featuresAvailable.ZIA_SUMMARY&&Crm.userDetails.permissions.Crm_Implied_View_Zia_Notes_Summary&&Crm.isSupportedModuleForZiaSummary(Lyte.Router.getRouteInstance().transition.info.dynamicParams[0])&&this.getData("totalNotesCount")>0&&!this.getData("cxPropNoteHeaderSuffixYield")&&this.setData("cxPropNoteHeaderSuffixYield",!0)}}});
