Lyte.Mixin.register("crm-services-appointments-mixin",{serviceAppointmentsHiddenFields:["SERVICESTATUS","UNAVAILABLE_FROM","UNAVAILABLE_TILL","APPOINTMENTSTATUS","SOURCEID"],showQuickCreatePopupUsingSectionName:function(e){var t=this;commonUtils.showHideLoadingDiv(!0);var i=e.moduleName,r=moduleApiMapping[i],s={layoutAPIData:store.findAll("layout",{module:r,mode:"all"},!1,!0,{apiVersion:"2.2",moduleSet:!0,from:"lyteCreate"})};e.apiCalls&&(s=Object.assign(s,e.apiCalls)),Lyte.resolvePromises(s).then((function(i){e.getBusinessHoursAndHolidays&&e.getBusinessHoursAndHolidays(i);var r,s=i.layoutAPIData,a=s[0].sections,n=a.length,o=[],l=!1;if(e.changeFieldFunc)l=!0,o.push(e.changeFieldFunc.call(t,a));else for(var m=0;m<n;m++)a[m].name===e.sectionName&&(l=!0,o.push(t.generateQuickCreateFieldsObj.call(t,a[m])));e.getRequiredData&&(r=e.getRequiredData.call(t,a,e.sectionName,i,e)),l?Lyte.triggerEvent("quickCreate",{moduleName:e.moduleName,type:e.type,displayDetails:{isCustom:!0,showSectionHeader:!1,showSectionOnDemand:!1},fieldsList:o,quickCreateWrapperClass:e.wrapperClass,recordId:e.recordId,headerName:e.headerName,footerButtons:e.footerButtons,viewType:"modal",disableQuickCreate:!0,sectionName:e.sectionName,callbacks:{onSave:e.onSave,onCancel:e.onCancel,onCustomSave:e.preventSaveFunc,delaySaveFunc:e.delaySaveFunc,onSaveFailure:e.serverErrorfunc,onBeforeValidate:e.setCustomData,beforeReady:e.beforeReady,beforeRender:e.beforeRender,afterRender:e.afterRender,onRecValueChange:e.onRecValueChange?(t,i,r)=>e.onRecValueChange(t,r,i,!0):void 0,onDestroy:e.onDestroy,updateZindexes:()=>e.zindexDetails},updateRecDetails:e.recordData,allowSections:!1,preventSaveFunc:!!e.preventSaveFunc,delaySaveFunc:!!e.delaySaveFunc,getRequiredData:r,source:e.source,updateZindexes:e.zindexDetails,cloneOnEdit:e.cloneOnEdit,cssList:e.cssList,jsList:e.jsList,lessList:e.lessList,skipInstObjDeletion:e.skipInstObjDeletion,popoverDetails:e.popoverDetails,viewType:e.viewType,modalMaxHeight:e.modalMaxHeight,unique_listener_id:e.unique_listener_id,initialReqDetail:{layoutRulesResponse:void 0,validationRuleResponse:void 0,moduleObject:void 0,layoutResponse:[{layouts:s}],entityResponse:void 0}}):Lyte.registeredMixins["crm-appointments-mixin"](e.createdSource)}))},generateQuickCreateFieldsObj:function(e){for(var t=[],i=e.fields.length,r=0;r<i;r++){var s=e.fields[r],a={};this.serviceAppointmentsHiddenFields.includes(s.column_name)||(a.fieldRecord=s,a.fieldCustomDetails={},"REMINDER"===s.column_name&&(a.fieldCustomDetails.reqYield=!0),t.push(a))}return this.generateQuickCreateSectionObj(e,t)},generateQuickCreateSectionObj:function(e,t){var i={};return i.sectionRecord=e,i.sectionCustomDetails={display_label:e.display_label,sequence_number:e.sequence_number,fields:t},i},generateSectionFieldsApiVsColumn:function(e){var t={apiVSColObj:{}};return Object.keys(e).forEach((i=>{var r=e[i].name;Object.assign(t.apiVSColObj,this.getApiVsColname(e,r))})),t},getApiVsColname:function(e,t){for(var i=e.length,r={},s=0;s<i;s++)if(e[s].name===t){for(var a=e[s].fields,n=e[s].fields.length,o=0;o<n;o++){var l=a[o];r[l.column_name]=l.api_name}break}return r},getTimeValueInUserFormat:function(e){var t;if("HH:mm"===Crm.userDetails.TIME_FORMAT)t=Utils.formatTimeVal(e.getHours())+":"+Utils.formatTimeVal(e.getMinutes());else{var i=Utils.convertTo12HoursFormatTimeObj(e);t=i.hrs+":"+i.mins+" "+I18n.getMsg(i.meridiem.toUpperCase())}return t},getDatewithsuffix:function(e){if(e){var t=$L.moment(e).i18N("DD MMM YYYY").split(" "),i=Number(t[0]),r=i%10;return(i+=1===r&&11!==i?I18n.getMsg("st"):2===r&&12!==i?I18n.getMsg("nd"):3===r&&13!==i?I18n.getMsg("rd"):I18n.getMsg("th"))+" "+I18n.getMsg(t[1])+" "+t[2]}},getCurrentOrgDateInDbFormat:function(){var e=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE),t=(new Date).getTime()+e,i=new Date(t),r=i.getUTCDate().toString(),s=(i.getUTCMonth()+1).toString(),a=i.getUTCFullYear().toString();return r.length<=1&&(r="0"+r),s.length<=1&&(s="0"+s),a+"-"+s+"-"+r},removeExtraComma:function(e){return e=e.slice(0,e.length-2),e+="."},getTimeVal:function(e){var t;if("HH:mm"===Crm.userDetails.TIME_FORMAT)t=Utils.formatTimeVal(e.getHours())+":"+Utils.formatTimeVal(e.getMinutes());else{var i=Utils.convertTo12HoursFormatTimeObj(e);t=i.hrs+":"+i.mins+" "+I18n.getMsg(i.meridiem.toUpperCase())}return t}}),Lyte.Mixin.register("crm-services-appointments-old-mixin",{setStartDateAndTime:function(e,t){var i,r=!1;"HH:mm"===Crm.userDetails.TIME_FORMAT&&(r=!0);var s=t.find("#Crm_Appointments_APPOINTMENTDATEANDTIME_TimeOption"),a=t.find("#Crm_Appointments_APPOINTMENTDATEANDTIME");if(e)i=$L.moment(e).toDate();else{i=$L.moment(a.data("dateObj")).toDate();var n=trimBoth(s.val().split(" ")[0]),o=s.timeEntry("getTime");if(o){var l=Utils.getMeridiem(o).toUpperCase();r?i.setHours(parseInt(n.split(":")[0],10)):i.setHours(Utils.convertTimeTo24HoursFormat(parseInt(n.split(":")[0],10),l)),i.setMinutes(parseInt(n.split(":")[1],10))}}if(r)s.val(Utils.formatTimeVal(i.getHours())+":"+Utils.formatTimeVal(i.getMinutes()));else{var m=Utils.convertTo12HoursFormatTimeObj(i);s.val(m.hrs+":"+m.mins+" "+I18n.getMsg(m.meridiem.toUpperCase()))}a.val(crmCalendar.convertToUserDatePattern(i.getDate()+" "+i.getMonth()+" "+i.getFullYear())),a.data("dateObj",i)},setAppointmentRelatedDataOldFlow:function(e,t,i,r,s){var a=$("#Crm_Appointments_SERVICEID"),n=$("#Crm_Appointments_SEID_RELATEDTO"),o=n.val(),l=$("#Crm_Appointments_APPOINTMENTNAME");if(!i&&!s&&""!=o&&null!=o&&l.data("autopopulate")){var m=e.Service_Name+" - "+o;l.val(m.substring(0,255))}a.attr("serviceJSON",JSON.stringify(e));var c=$("#Crm_Appointments_APPOINTMENTLOCATION"),d=$("#Crm_Appointments_APPOINTMENTADDRESS");if(c.length>0){var p=[],u=c.data().picklistmap,v=u.length,g=0;t||(t=e.Location,r=e.Location);var h=c.val();if(r!==I18n.getMsg("Business Address")||i&&h!==r)if(r!==I18n.getMsg("Client Address")||i&&h!==r){for(var A=0;A<v;A++)"-None-"!=u[A].uservalue&&(p[g++]=u[A].uservalue);if(!i&&!s){var f=c.val();renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Client Address")===f?(d.removeAttr("disabled"),d.val(""),$("#Appointments_fldRow_APPOINTMENTADDRESS").removeClass("readonlyF")):renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Business Address")===f&&this.constructAppointmentAddressForBusiness()}}else{var C;p[0]=t,$("#select2-Crm_Appointments_APPOINTMENTLOCATION-container").text(t),(C=$(document.createElement("option"))).attr("value",t).prop("text",t),c.html(C),d.removeAttr("disabled"),$("#Appointments_fldRow_APPOINTMENTADDRESS").removeClass("readonlyF"),$("#Crm_Appointments_APPOINTMENTADDRESS_label").addClass("newmandatory"),!n.data("id")||""==n.data("id")||i||s||d.val("")}else p[0]=t,$("#select2-Crm_Appointments_APPOINTMENTLOCATION-container").text(t),(C=$(document.createElement("option"))).attr("value",t).prop("text",t),c.html(C),this.constructAppointmentAddressForBusiness(),$("#Crm_Appointments_APPOINTMENTADDRESS_label").removeClass("newmandatory");"Business Address"!==t&&renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Business Address")===c.val()&&this.constructAppointmentAddressForBusiness(),this.getAppointmentLocationValues(),c.data().values=p,c.data().mapval=p,c.removeClass("dataPopulated")}if(e&&e.Duration){var D=Lyte.registeredMixins["crm-services-mixin"].methods.convertTimeInHrMinsToDouble(e.Duration),_=$("#Crm_Appointments_APPOINTMENTDURATION"),y="edit"===Events.currentStatus?_.val():D,M=Number(D);_.val(M&&Number.isInteger(M)?Handlebars.helpers.setServiceDuration(y):y)}crmCommonModule.serviceLookupDisabled=!1},setAddressValueForAppointment:function(e){var t,i=$("#Crm_Appointments_SERVICEID").val(),r=$("#Crm_Appointments_APPOINTMENTNAME"),s=$("#Crm_Appointments_SEID_RELATEDTO").val();(""!=i&&"edit"!=Events.currentStatus&&r.data("autopopulate")||""!=i&&"edit"!=Events.currentStatus&&"calendar"==Events.createSource)&&(t=i+" - "+s,r.val(t.substring(0,255)));var a=[];crmCommonModule.customerAddress=[];var n=["BILLINGSTREET","BILLINGCITY","BILLINGSTATE","BILLINGCODE","BILLINGCOUNTRY"],o=["SHIPPINGSTREET","SHIPPINGCITY","SHIPPINGSTATE","SHIPPINGCODE","SHIPPINGCOUNTRY"],l="",m="";if(e)for(var c=0;c<5;c++)e[n[c]]&&(l=l+e[n[c]]+","),e[o[c]]&&(m=m+e[o[c]]+",");if(l&&a.push(Lyte.registeredMixins["crm-services-appointments-mixin"].removeExtraComma(l)),m&&a.push(Lyte.registeredMixins["crm-services-appointments-mixin"].removeExtraComma(m)),crmCommonModule.customerAddress=a,crmCommonModule.serviceModuleLooked){var d=$("#Crm_Appointments_APPOINTMENTLOCATION").val();if(renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Client Address")===d){var p=$("#Crm_Appointments_APPOINTMENTADDRESS");p.removeAttr("disabled"),$("#Appointments_fldRow_APPOINTMENTADDRESS").removeClass("readonlyF"),p.val(""),this.constructAppointmentAddressValue(a)}else renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Business Address")===d&&this.constructAppointmentAddressForBusiness()}},constructAppointmentAddressForBusiness:function(){var e="",t=Crm.userDetails.orgAddress;if(void 0!==t){for(var i=t.split("|"),r=0;r<5;r++)i[r]&&(e=e+i[r]+",");e=e.substring(0,e.length-1)}var s=$("#Crm_Appointments_APPOINTMENTADDRESS");s.val(e),s.attr("disabled","disabled"),$("#Appointments_fldRow_APPOINTMENTADDRESS").addClass("readonlyF")},onAppointmentLocationChange:function(e){var t=$(e).val(),i=$("#Crm_Appointments_APPOINTMENTADDRESS"),r=$("#Crm_Appointments_SERVICEID");if(r.data("id")&&""!=r.data("id"))if(t===renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Business Address"))this.constructAppointmentAddressForBusiness(),$("#Appointments_fldRow_APPOINTMENTADDRESS").addClass("readonlyF");else if(t===renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Client Address")){i.val(""),i.removeAttr("disabled"),$("#Appointments_fldRow_APPOINTMENTADDRESS").removeClass("readonlyF");var s=$("#Crm_Appointments_SEID_RELATEDTO");s.data("id")&&""!=s.data("id")&&this.constructAppointmentAddressValue(crmCommonModule.customerAddress)}},hideAppointmentLocationPop:function(){setTimeout((function(){$("#locationDataDiv").hide()}),500)},setAppointmentLocation:function(){var e=$("#Crm_Appointments_APPOINTMENTLOCATION").val(),t=$("#Crm_Appointments_SEID_RELATEDTO");t.data("id")&&""!=t.data("id")&&renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Appointments_APPOINTMENTLOCATION","Client Address")===e&&$("#locationDataDiv").find("li").length>0&&$(".evtLocationDD").slideDown(300)},hideAppointment_calendar:function(){if("calendar"===Events.createSource)$("#qCreate").removeClass("appointment_calendar").empty().hide(),$("html").css("overflow",""),renderingUtils.removeFreezeLayer();else{var e=$("#appointmentCreate");crmui.hidePopup("appointmentCreate"),e.empty().remove()}},cancelAppointmentBTN:function(){this.resetValues();var e=$("#appointmentCreate");crmui.hidePopup("appointmentCreate"),e.empty().remove(),$("html").css("overflow","")},setAppMenu:function(e,t,i,r){if("Reschedule Information"===Crm.isAppAction){Events.isAppointmentReschedule=!0;var s=$("#appointmentRescheduleDivFields"),a=$("#secDiv_Reschedule_Information").find("#secContent_Reschedule_Information");!1===s.is(":empty")&&s.empty(),s.append(a),a.removeClass("secContent");var n=s.find("select");n&&n.length&&thirdPartyUtils.bindSelect2(n);var o=$("#Appointments_fldRow_SMOWNERID");o.removeClass("tabDivCreate newmandatory"),o.attr("style","display:none");var l=$("#Appointments_fldRow_CURRENCYISOCODE");detailView.rescheduleAppSection.isCurrency&&l.length&&l.remove();var m=$("#Crm_Appointments_APPOINTMENTDATEANDTIME"),c=$("#Crm_Appointments_APPOINTMENTDATEANDTIME_TimeOption"),d=$("#Crm_Appointments_RESCHEDULEDFROM"),p=$("#Crm_Appointments_RESCHEDULEDFROM_TimeOption");$("#Appointments_fldRow_RESCHEDULEDFROM").addClass("readonlyF"),d.attr({readonly:!0,disabled:!0}),p.attr({readonly:!0,disabled:!0}),p.val(c.val()),d.val(m.val());var u=$L.moment().toDate(),v=Events.getRoundedDateTime(u);v.setSeconds(0),v.setMilliseconds(0);var g=crmCalendar.convertToUserDatePattern(v.getDate()+" "+v.getMonth()+" "+v.getFullYear()),h=Lyte.registeredMixins["crm-services-appointments-mixin"].getTimeVal(v);return c.val(h),m.val(g).attr("serviceJSON",JSON.stringify(e.Service_needed_Details)),m.data().dateObj=v,Events.isAppointmentReschedule=!0,"appointmentRescheduleDiv"}if("Cancellation Information"===Crm.isAppAction){var A=$("#appointmentCancelDivFields");!1===A.is(":empty")&&A.empty();l=$("#Appointments_fldRow_CURRENCYISOCODE");detailView.cancelAppSection.isCurrency&&l.length&&l.remove();var f=$("#secContent_Cancellation_Information");return A.append(f),f.removeClass("secContent"),A.find(".labelTabCreate").addClass("columnCal1"),"appointmentCancelDiv"}if("appointmentCompletePopup"===Crm.isAppAction){var C=!!e.entityMapJson.ISJOBSHEETCREATED&&e.entityMapJson.ISJOBSHEETCREATED.defaultvalue;return $L("#appointmentCompletePopupSave").attr("onclick","Lyte.registeredMixins['crm-services-appointments-old-mixin'].setAppMenu('"+JSON.stringify(e.Service_needed_Details.Job_Sheet_Section__s)+"','appointmentCompletePopupSave','"+i+"',"+C+")"),"appointmentCompletePopup"}if("appointmentCompletePopupSave"!==t)return t;Lyte.registeredMixins["crm-appointments-mixin"].appointmentPreferences.show_job_sheet&&!r&&e&&"undefined"!==e&&JSON.parse(e).uservalue?(crmui.hidePopup("appointmentCompletePopup"),Lyte.registeredMixins["crm-appointments-mixin"].showAppointmentSectionPopup(Events.entityId,JSON.parse(e).uservalue,void 0,void 0,"edit")):Lyte.registeredMixins["crm-appointments-mixin"].markAsCompleteAppointment(Events.entityId)},cancelJobSheetBTN:function(){Crm.requestApp&&$("#appointmentCreate")&&$("#saveAppointmentsBtn").attr("value")===I18n.getMsg("crm.appointments.add.job.sheet")?(renderingUtils.removeDummyBackground(),delete Crm.requestApp,delete Crm.requestApp2,crmui.showPop("appointmentCreate",!1),Events.moduleName="Appointments",Events.module="Appointments",Events.currentStatus="Create",CFRExec=Crm.appFormRule.rule,CFRExec.relatedEntityMap=Crm.appFormRule.relatedId,delete Crm.appFormRule,$("#saveEventsBtn").removeAttr("disabled"),crmui.hidePopup("jobSheetCreateDiv",!0),$("#calendarCont").is(":visible")?$("#FreezeLayer").css("z-index","19"):$("#FreezeLayer").css("z-index","28")):(crmui.hidePopup("jobSheetCreateDiv"),$("#FreezeLayer").css("z-index","28"))},getAppointmentRemindersAsJson:function(){for(var e="{",t=[],i=1,r=1;r<=20;r++){var s=$("#Crm_Appointments_REMINDER"+r),a=$("#Crm_Appointments_REMINDAT"+r);(s=s.length>0?s:a).length&&"none"!=s.attr("data-value")&&-1==$.inArray(s.attr("data-value"),t)&&(t.push(s.attr("data-value")),e=e+'"'+i+'":"'+s.attr("data-value")+'",',i++)}return e=e.substring(0,e.length-1),e+="}"},setMemberDataForAppointment:function(e){var t="";if(e){for(var i=e.length,r=0;r<i;r++)t+=e[r].Members.id+",";i>0&&(t=t.slice(0,t.length-1))}else{var s;if((s=$("#Crm_Appointments_SERVICEID")).attr("serviceJSON"))if((s=s.attr("serviceJSON")).length>0&&(s=JSON.parse(s))&&s.Members){var a=s.Members.length;try{for(r=0;r<a;r++)t+=s.Members[r].Members.id+",";a>0&&(t=t.slice(0,t.length-1))}catch(e){t=s.Members}}}if(""!==t){var n=document.getElementById("changeOwnerPopUp");(n=null==n?document.getElementById("Crm_Appointments_SMOWNERID"):n)&&(n.setData("userIdList",t),setTimeout((function(){n.setData("cxPropCustomRequest",!0)}),0))}},setAppointmentScroll:function(){var e=document.getElementById("secContent_Appointment_Information");$(e).scroll((function(){e.scrollHeight<$L(e).scrollTop()+$(e).outerHeight()+15?($("#appointmentCreate .pp-footer").addClass("hideShLine"),$(".appointment_cal_btn").addClass("borTopRemove")):($("#appointmentCreate .pp-footer").removeClass("hideShLine"),$(".appointment_cal_btn").removeClass("borTopRemove"))}))},getRescheduleHistory:function(){$("crm-appointment-reschedulehistory").remove();var e="/crm/v2/Appointments__s/"+detailView.entityId+"/_rescheduled_history";networkUtils.lyteInitiateRequest(e,"GET").then((function(e){var t=networkUtils.returnDependencyFiles(["appointment-reschedulehistory.js"],ResourceConstants.CRMClient);t=t.concat(networkUtils.returnDependencyFiles(["appointment-reschedulehistory.css"],ResourceConstants.CRMClient)),Lyte.injectResources(t,void 0,(function(){Lyte.Component.render("crm-appointment-reschedulehistory",{rescheduled_history:e.rescheduled_history,modalShow:!0,resCount:$("#subvalue_RESCHEDULECOUNT").text()},"#show")}))}))},createAlertDivElementForAppointment:function(){return renderingUtils.createHTML({name:"div",attr:{style:"margin-left: 185px;",id:"checkDuplicateEvent",class:"timeAlert dIB mB15"},child:[{name:"div",attr:{},child:[{name:"div",css:{background:"var(--orangeLightBg)",padding:"4px",border:"1px solid var(--orangeLightBr)","border-radius":"4px",color:"--crmWarningColor"},child:[{name:"table",attr:{cellpadding:"3",cellspacing:"0",border:"0"},child:[{name:"tbody",child:[{name:"tr",child:[{name:"td",attr:{valign:"top"},child:[{name:"span",attr:{class:"zcicncss-alert-filled zcicn-cssIcons zcicn_red_mask mT2"}}]},{name:"td",attr:{id:"appointmentAlert",class:"crm-small-font-size"},html:""}]}]}]}]}]}]})},getServiceTimingOldFlow:function(e,t,i,r){var s,a,n,o,l,m,c,d,p,u,v,g;if(i&&returnJson.entityMapJson){var h;d=(h=returnJson.entityMapJson.SERVICEAVAILABILITY).defaultvalue;var A=h.picklistmap;if(A)for(var f=A.length,C=0;C<f;C++){switch(A[C].systemvalue){case"Specific Date Range":c=A[C].uservalue;break;case"Specific Date(s)":l=A[C].uservalue;break;case"Specific Day(s)":m=A[C].uservalue}}var D=(h=returnJson.entityMapJson.AVAILABLE_CUSTOM_TIMING).defaultvalue;if(D){var _=JSON.parse(D);s=_[0].From,a=_[0].To,_.length>1&&(n=_[1].From,o=_[1].To)}var y=(h=returnJson.entityMapJson.STARTING_DATE).defaultvalue;""!==y&&(v=CrmDateUtils.convertdateToDBformat($L.moment(y).toDate(),!0));var M=(h=returnJson.entityMapJson.CLOSING_DATE).defaultvalue;""!==M&&(g=CrmDateUtils.convertdateToDBformat($L.moment(M).toDate(),!0)),h=returnJson.entityMapJson.AVAILABLE_DATES,p=JSON.parse(h.defaultvalue),u=(h=returnJson.entityMapJson.AVAILABLE_DAYS).defaultvalue.split(";")}else{var T=$("#timechange1_0"),b=$("#timechange1_1"),S=$("#timechange2_0"),I=$("#timechange2_1");s=T.val(),a=S.val(),n=b.val(),o=I.val(),l=renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Services_SERVICEAVAILABILITY","Specific Date(s)"),m=renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Services_SERVICEAVAILABILITY","Specific Day(s)"),c=renderingUtils.getPickListDisplayValuebyDomAndSysValue("Crm_Services_SERVICEAVAILABILITY","Specific Date Range"),d=$("#Crm_Services_SERVICEAVAILABILITY").val()}$("#errorMsg_timechange1_0").remove(),$("#errorMsg_timechange1_1").remove(),$("#errorMsg_CustomTimingClear").remove();var E=T,L=b,R=E,N=L;1==$("#timeField1").prev().find("#timechange1_1").length&&(s=b.val(),a=I.val(),n=T.val(),o=S.val(),R=L,N=E);var P,O,w=[];if(null!=s&&null!=a&&!i){if(""==s||""==a)return Lyte.registeredMixins["crm-services-mixin"].focus=R,commonUtils.showErrorMsg(I18n.getMsg("crm.service.servicetiming.emptyalert",moduleRecordMapping.Services.singular_label),R,e),!1;if(CrmDateUtils.checkTimeValue(s)||CrmDateUtils.checkTimeValue(a))return Lyte.registeredMixins["crm-services-mixin"].focus=R,commonUtils.showErrorMsg(I18n.getMsg("bh.label.inavlid.time.1"),R,e),!1}if(s&&a){if(s=Utils.convertTimeValueTo24HourFormat(s),a=Utils.convertTimeValueTo24HourFormat(a),!CrmDateUtils.compareTime(s,a))return Lyte.registeredMixins["crm-services-mixin"].focus=R,commonUtils.showErrorMsg(I18n.getMsg("crm.service.servicetiming.alert"),R,e),!1;w.push({From:s,To:a})}if(null!=n&&null!=o&&!i){if(""==n||""==o)return Lyte.registeredMixins["crm-services-mixin"].focus=N,commonUtils.showErrorMsg(I18n.getMsg("crm.service.servicetiming.emptyalert",moduleRecordMapping.Services.singular_label),N,e),!1;if(CrmDateUtils.checkTimeValue(n)||CrmDateUtils.checkTimeValue(o))return Lyte.registeredMixins["crm-services-mixin"].focus=N,commonUtils.showErrorMsg(I18n.getMsg("bh.label.inavlid.time.1"),N,e),!1;if(n=Utils.convertTimeValueTo24HourFormat(n),o=Utils.convertTimeValueTo24HourFormat(o),a==n)(w=[]).push({From:s,To:a=o}),n=void 0,o=void 0;else{if(!CrmDateUtils.compareTime(n,o))return Lyte.registeredMixins["crm-services-mixin"].focus=N,commonUtils.showErrorMsg(I18n.getMsg("crm.service.servicetiming.alert"),N,e),!1;w.push({From:n,To:o})}}if("custom"==Crm.businessJSON.type){if(t?d=r[0].Availability_Type:i&&!d?Lyte.registeredMixins["crm-services-mixin"].serviceAvailabilityEditAction(detailView.serviceAvailabiltyData.serviceAvailabiltySection,detailView.serviceAvailabiltyData.detailViewJson,"Services"):d||(d=Crm.requestParam["property(Availability_Type)"]),1==Crm.businessJSON.same_as_everyday)P=Crm.businessJSON.details[0],O=Crm.businessJSON.details[1];else if(0==Crm.businessJSON.same_as_everyday)if(d==m){if(t)u=r[0].Available_Days;else if(i&&!u)u=$("#Crm_Services_AVAILABLE_DAYS").val();else if(!u){u=(J=Crm.requestParam["property(Available_Days)"]).split(";")}if(u.length>0&&(P=Lyte.registeredMixins["crm-services-mixin"].getDayMinTime(u),O=Lyte.registeredMixins["crm-services-mixin"].getDayMaxTime(u),!CrmDateUtils.compareTime(P,O)))return commonUtils.showErrorMsg(I18n.getMsg("crm.service.custom.alert.commonbus"),R,e),!1}else if(d==l){if(t?p=r[0].Available_Dates:i&&!p?p=JSON.parse($("#Crm_Services_AVAILABLE_DATES").attr("arr_date")):p||(p=JSON.parse(Crm.requestParam["property(Available_Dates)"])),p&&p.length>0&&(P=Lyte.registeredMixins["crm-services-mixin"].getDatesMinTime(p),O=Lyte.registeredMixins["crm-services-mixin"].getDatesMaxTime(p),!CrmDateUtils.compareTime(P,O)))return commonUtils.showErrorMsg(I18n.getMsg("crm.service.custom.alert.commonbus"),R,e),!1}else if(d==c){if(t?(v=r[0].Available_From,g=r[0].Available_Till):!i||v||g?v||g||(v=CrmDateUtils.convertdateToDBformat(Crm.requestParam["property(Starts From)"],!0),g=CrmDateUtils.convertdateToDBformat(Crm.requestParam["property(Ends On)"],!0)):(v=CrmDateUtils.convertdateToDBformat($("#Crm_Services_STARTING_DATE").val(),!0),g=CrmDateUtils.convertdateToDBformat($("#Crm_Services_CLOSING_DATE").val(),!0)),v&&g){var U=Lyte.registeredMixins["crm-services-mixin"].getDateRangeMinMaxTime(new Date(v+"T00:00:00"),new Date(g+"T00:00:00"));if(P=U[0],O=U[1],!CrmDateUtils.compareTime(P,O))return Lyte.registeredMixins["crm-services-mixin"].focus=R,commonUtils.showErrorMsg(I18n.getMsg("crm.service.custom.alert.commonbus"),R,e),!1}}else if(!i&&(P=Lyte.registeredMixins["crm-services-mixin"].getMinValueFrom(Crm.businessJSON.details),O=Lyte.registeredMixins["crm-services-mixin"].getMaxValueTo(Crm.businessJSON.details),!CrmDateUtils.compareTime(P,O)))return R[0]?commonUtils.showErrorMsg(I18n.getMsg("crm.service.custom.alert.commonbus"),R,e):commonUtils.showErrorMsg(I18n.getMsg("crm.service.custom.alert.commonbus"),N,e),!1;if(!i){if(s&&a&&!CrmDateUtils.compareTime(P,s,!0)||!CrmDateUtils.compareTime(a,O,!0))return Lyte.registeredMixins["crm-services-mixin"].focus=R,commonUtils.showErrorMsg(I18n.getMsg("crm.service.servicetiming.bushours"),R,e),!1;if(n&&o&&!CrmDateUtils.compareTime(P,n,!0)||!CrmDateUtils.compareTime(o,O,!0))return Lyte.registeredMixins["crm-services-mixin"].focus=N,commonUtils.showErrorMsg(I18n.getMsg("crm.service.servicetiming.bushours"),N,e),!1}}if(a&&n&&!CrmDateUtils.compareTime(a,n,!0))return commonUtils.showErrorMsg(I18n.getMsg("crm.service.servicetiming.slotalt"),N,e),Lyte.registeredMixins["crm-services-mixin"].focus=N,!1;var x=null,V=null,k=[];if(s&&a||n&&o){if(s&&a&&(x=CrmDateUtils.timeTomilliseconds(a)-CrmDateUtils.timeTomilliseconds(s),k.push(x)),n&&o&&(V=CrmDateUtils.timeTomilliseconds(o)-CrmDateUtils.timeTomilliseconds(n),k.push(V)),(F=Crm.requestParam["property(Duration)"])&&!t){var F=60*F*1e3;if(this.serviceDurationValidator(k,F)>0){var B=$("#CustomTimingClear");return Lyte.registeredMixins["crm-services-mixin"].focus=R,commonUtils.showErrorMsg(I18n.getMsg("crm.service.avail.less.dur",moduleRecordMapping.Services.singular_label),B,e),!1}}if(t&&(F=60*$("#value_SERVICEDURATION").parent().data().params.defaultvalue*1e3,this.serviceDurationValidator(k,F)>0))return commonUtils.showErrorMsg(I18n.getMsg("crm.service.avail.less.dur",moduleRecordMapping.Services.singular_label),R,e),!1}if(i){if(F=60*$("#Crm_Services_SERVICEDURATION").attr("data-value")*1e3,x&&this.serviceDurationValidator(k,F)>0)return!1;if(0==Crm.businessJSON.same_as_everyday){var J;if(!u||!p)u=(J=$("#Crm_Services_AVAILABLE_DAYS").attr("data-old-value")).split(";"),p=JSON.parse($("#Crm_Services_AVAILABLE_DATES").attr("arr_date"));if(u&&"custom"===Crm.businessJSON.type&&Lyte.registeredMixins["crm-services-mixin"].checkServiceDurationAvailable(F,u))return!1;if(p&&p.length>0&&"custom"==Crm.businessJSON.type){var j=[],q=p.length;for(C=0;C<q;C++)j.push(new Date(p[C]+"T00:00:00").getDay());if(Lyte.registeredMixins["crm-services-mixin"].checkServiceDurationAvailable(F,j))return!1}if(!J&&!p.length>0&&"custom"==Crm.businessJSON.type&&Lyte.registeredMixins["crm-services-mixin"].checkServiceDurationAvailable(F,Crm.businessJSON.business_days))return!1}else if(1==Crm.businessJSON.same_as_everyday&&F>CrmDateUtils.timeTomilliseconds(Crm.businessJSON.details[1])-CrmDateUtils.timeTomilliseconds(Crm.businessJSON.details[0]))return!1}return w},serviceDurationValidator:function(e,t){for(var i=e.length,r=0;r<i;r++)if(t-e[r]>0)return!0;return!1},removeDateField:function(e){var t=e.parentElement,i=e.previousSibling,r=i.value;r&&Crm.holidays.selectedDate.removeFirstOccurenceOfElement(CrmDateUtils.convertdateToDBformat(r,!0));var s=$(t).next();if("Crm_Services_AVAILABLE_DATES"==i.id||"Crm_Services_setup_AVAILABLE_DATES"===i.id){if($(i).val(s.find("input").val()),s.remove(),0==$(t).next().length){var a=this.plusicon(0);$(i).after(a),$(e).remove()}}else{var n=t.previousSibling;if(0==s.length){var o=0,l=n.lastElementChild.id.split("_");l[1]&&(o=l[l.length-1]);a=this.plusicon(o);$(n.lastElementChild).after(a);var m=n.firstElementChild.id;"Crm_Services_AVAILABLE_DATES"!=m&&"Crm_Services_setup_AVAILABLE_DATES"!==m||$("#Services_fldRow_AVAILABLE_DATES").find(".ico_minus-lg").remove()}$(t).remove()}if($("div").find(".customDatefield").length<20){a=this.plusicon(0);$(".infoAlert_services").addClass("dN"),$(a).addClass("disable")}},plusicon:function(e){var t=document.createElement("a");return t.setAttribute("id","addDate_"+e),t.setAttribute("class","svgIcons dIB ico_plus-lg mL10 vaM mT5 fR"),t.setAttribute("onclick","Lyte.registeredMixins['crm-services-appointments-old-mixin'].addDateField(this);"),t},minusicon:function(e){var t=document.createElement("a");return t.setAttribute("id","removeDate_"+e),t.setAttribute("class","svgIcons dIB ico_minus-lg mL10 vaM mT5 fL"),t.setAttribute("onclick","Lyte.registeredMixins['crm-services-appointments-old-mixin'].removeDateField(this);"),t},editDate:function(e,t,i){this.createDate(e,i,i);var r=$("#Crm_Services_AVAILABLE_DATES_"+i);r.val(t),r.data("oldvalue",CrmDateUtils.convertdateToDBformat(t,!0)),Crm.holidays.selectedDate.push(CrmDateUtils.convertdateToDBformat(t,!0))},createDate:function(e,t,i){var r=document.createElement("div");if(r.setAttribute("class","customDatefield clearFix pR"),r.setAttribute("id","AvailDates"),"Services_fldRow_AVAILABLE_DATES"==e.parentElement.parentElement.id){var s=$("#Crm_Services_AVAILABLE_DATES_label").find(".customDate");$L(s).append(r)}else $(e.parentElement).after(r);var a=document.createElement("input");a.setAttribute("id","Crm_Services_AVAILABLE_DATES_"+t),a.setAttribute("placeholder",Crm.userDetails.DATE_PATTERN.toUpperCase()),a.setAttribute("onblur","Lyte.registeredMixins['crm-services-appointments-old-mixin'].enableAdddate(this);"),a.setAttribute("onchange","Lyte.registeredMixins['crm-services-appointments-old-mixin'].enableAdddate(this);Lyte.registeredMixins['crm-services-mixin'].validateDate(this);"),a.setAttribute("class","fL"),a.setAttribute("type","text"),$(a).each(crmTemplate.bindEventsToDateField),r.appendChild(a);var n=this.minusicon(t);if($(a).after(n),i<=19){var o=this.plusicon(t);$(n).after(o)}e.remove()},enableAdddate:function(e){var t=$(e),i=$(e).val().trim(),r=t.closest(".customDatefield").find(".ico_plus-lg"),s=t.closest(".customDate").find(".customDatefield").length;""==i||s>19?$L(r).addClass("disable"):$L(r).removeClass("disable")},addDateField:function(e){var t=$("div").find(".customDatefield").length;if(t<20){var i=e.id,r=1+Number(i.slice(8)),s=$(e).siblings().val();if($L.moment(s,Crm.userDetails.DATE_PATTERN.toUpperCase(),!0).validate()){if(0==$(e.parentElement).find(".ico_minus-lg").length){var a=Lyte.registeredMixins["crm-services-appointments-old-mixin"].minusicon(r-1);$(a).insertBefore(e)}this.createDate(e,r,t,!0)}}t>=19&&($(".infoAlert_services").removeClass("dN"),$(e).addClass("disable"))}}),Lyte.Mixin.register("crm-appointments-mixin",{isAppointmentPopup:!1,createdSource:null,appointmentPreferences:void 0,showAppointmentSectionPopup:function(e,t,i,r,s,a,n){this.createdSource=i||Events.createSource,Crm.menu.globalHideMenuExit=!1;var o,l=e?store.peekRecord(moduleRecordMapping.Appointments.id,e):void 0;r=r||(l?l.Service_Name.id:void 0),store.registerModel[moduleRecordMapping.Appointments.id]||store.registerModel(moduleRecordMapping.Appointments.id,{},{extends:"entity"}),store.registerModel[moduleRecordMapping.Services.id]||store.registerModel(moduleRecordMapping.Services.id,{},{extends:"entity"});var m="Appointments";switch(t){case"Appointment Information":var c=$L("#appointmentCreate")[0];c&&c.remove();var d=this;Lyte.injectResources(networkUtils.returnDependencyFiles(["servapp_preferences_model.js","business_hours-model.js"],ResourceConstants.CRMClient).concat(networkUtils.returnDependencyFiles(["zohocrm_services.js",networkUtils.getI18nJSUrl("businesshours")],ResourceConstants.CRM)),void 0,(function(){var n=store.peekAll("servapp_preferences")[0],l={};l.appPref=n||store.findAll("servapp_preferences",{},!1,!0,{module:"Appointments"}),"edit"!==s&&"clone"!==s||(l.appointmentRecord=e?store.findRecord(moduleRecordMapping.Appointments.id,e,{},void 0,!0,{}):void 0,l.serviceModule=store.findRecord("module",moduleRecordMapping.Services.id),l.serviceRecord=r?store.findRecord(moduleRecordMapping.Services.id,r,{},void 0,!0,{}):void 0),Lyte.resolvePromises(l).then((function(r){o={sectionName:t,moduleName:m,recordId:e,type:s,source:i,params:a,viewType:a.viewType,popoverDetails:a.popoverDetails,onRecValueChange:d.setAppointmentsFieldValues.bind(d),delaySaveFunc:"edit"!==s?d.validateRescheduleApp.bind(d):void 0,getRequiredData:d.getAppointmentRequiredData,zindexDetails:{preventUpdate:!1,location:i},wrapperClass:"quickCreateAppointmentsPopup",recordData:d.setAppointmentRelatedData(r,s,a),beforeReady:d.changeAppointmentFieldVisibility.bind(d),beforeRender:d.updateRecValuesChangeFunc.bind(d),afterRender:d.postAppointmentPopupChanges.bind(d),onSave:"edit"===s?d.saveEditAppointment.bind(d):d.saveCreateAppointment.bind(d),onDestroy:d.closeAppointmentPopup.bind(d),headerName:I18n.getMsg("Appointment Information",moduleRecordMapping.Appointments.singular_label),cloneOnEdit:!0,apiCalls:{businessHours:store.findAll("business_hours"),appPreferences:store.peekAll("servapp_preferences",{},!1,!0,{module:"Appointments"}),serviceRecord:r.serviceRecord}},Lyte.registeredMixins["crm-services-appointments-mixin"].showQuickCreatePopupUsingSectionName(o)}))}));break;case"Reschedule Information":Events.isAppointmentReschedule=!0;var p=store.findAll("business_hours"),u=store.peekAll("servapp_preferences",{},!1,!0,{module:"Appointments"});u.length||(u=store.findAll("servapp_preferences",{},!1,!0,{module:"Appointments"}));var v="/crm/v2.1/Services__s/"+r,g=store.findAll("dummy",{},!1,!1,{url:v,method:"GET"});o={sectionName:t,moduleName:m,recordId:e,type:"edit",onSave:this.saveRescheduleApp.bind(this),delaySaveFunc:this.validateRescheduleApp.bind(this),headerName:I18n.getMsg("crm.appointments.status.markreschedule",moduleRecordMapping.Appointments.singular_label),beforeReady:this.changeAppointmentFieldVisibility,onRecValueChange:this.validateRescheduleApp.bind(this),beforeRender:this.resetCustomFieldValues.bind(this),serverErrorfunc:this.rescheduleServerErrors,getRequiredData:this.getAppointmentRequiredData,changeFieldFunc:this.generateReschedulePopupFieldsObj,wrapperClass:"quickCreateAppointmentsPopup",modalMaxHeight:"535px",apiCalls:{businessHours:p,serviceDetails:g,appPreferences:u},footerButtons:[{id:"quickCreateCancel",zcqa:"appRescheduleAjaxCancel"},{id:"quickCreateSave",zcqa:"appRescheduleAjaxsubmit"}],onDestroy:this.onDestroy.bind(this),cloneOnEdit:!0};break;case"Cancellation Information":o={sectionName:t,moduleName:m,recordId:e,type:"edit",onSave:this.saveCancelApp.bind(this),headerName:I18n.getMsg("crm.appointments.status.markcancel",moduleRecordMapping.Appointments.singular_label),cloneOnEdit:!0,getRequiredData:this.getAppointmentRequiredData,cloneOnEdit:!0,serverErrorfunc:this.cancelServerErrors,wrapperClass:"quickCreateAppointmentsPopup",modalMaxHeight:"535px",beforeRender:this.changeCancelStatus.bind(this),footerButtons:[{id:"quickCreateCancel",zcqa:"appCancelAjaxCancel"},{id:"quickCreateSave",zcqa:"appCancelAjaxsubmit"}]};break;case"Job Sheet Information":o={sectionName:t,moduleName:m,recordId:e,type:s,source:i,onSave:this.postSaveJobSheetPopupAction.bind(this),onCancel:this.cancelJobSheetPopup,delaySaveFunc:this.saveJobSheetPopup,headerName:I18n.getMsg("crm.button.add.module",I18n.getMsg("Job Sheet Information")),beforeRender:this.resetCustomFieldValues,getRequiredData:this.getAppointmentRequiredData,setCustomData:this.setJobSheetCustomData,skipInstObjDeletion:!0,serverErrorfunc:this.handleJobsheetServerErrors,recordData:n,modalMaxHeight:"535px"}}o&&Lyte.registeredMixins["crm-services-appointments-mixin"].showQuickCreatePopupUsingSectionName(o)},onDestroy:function(){this.resetValues(),_cruxUtils.removeCustomAlert()},changeCancelStatus:function(e,t){var i=e.getRequiredData.apiVSColObj.APPOINTMENTSTATUS;this.resetCustomFieldValues(e,t),t.$.set(i,I18n.getMsg("Cancelled"))},closeAppointmentPopup:function(e){"create"===e.type&&"relatedlist_new"===e.source&&Lyte.Router.getRouteInstance()&&"canvas"===Lyte.Router.getRouteInstance().routeName&&delete moduleRecordMapping.Appointments.fields},postAppointmentPopupChanges:function(){setTimeout((()=>{this.isAppointmentPopup=!1}),300)},getAppointmentRequiredData:function(e,t,i,r){var s=Lyte.registeredMixins["crm-services-appointments-mixin"].generateSectionFieldsApiVsColumn(e);switch(t){case"Appointment Information":s.businessJson=i.businessHours,s.appPreference=i.appPreferences[0].appointments;for(var a=e.length,n=0;n<a;n++){if(e[n].name===t){s.sectionDetails=e[n],s.params=r.params;for(var o={},l=e[n].fields.length,m=0;m<l;m++){var c=e[n].fields[m];o[c.column_name]=c}}"Standard"!==e[n].name&&"Job Sheet Information"!==e[n].name||"clone"!==r.type||(s.jobsheetSection=e[n])}s.fieldListObj=o,s.serviceDetails=i.serviceRecord&&i.serviceRecord[0];break;case"Reschedule Information":s.businessJson=i.businessHours,s.serviceDetails=i.serviceDetails.data[0],s.appPreference=i.appPreferences[0].appointments;break;case"Job Sheet Information":case"Standard":s.LayoutId=e.find((e=>"Job Sheet Information"===e.name||"Standard"===e.name)).layout.id,fileupload&&fileupload.fieldID&&(s.fileUpload=JSON.parse(JSON.stringify(fileupload)))}return s},setAppointmentRelatedData:function(e,t,i){var r={};switch(t){case"create":var s={};if(i&&i.relEntityId)if(s.id=i.relEntityId,s.name=i.relEntityName,"Services"===i.relModuleName)Lyte.Component.set(r,"Service_Name",s);else{var a={};a.api_name=moduleRecordMapping[i.relModuleName].api_name,a.id=moduleRecordMapping[i.relModuleName].id,s.module=a,Lyte.Component.set(r,"Appointment_For",s)}var n=i&&i.startTime?this.getStarttimeinCurrFormat(i.startTime):this.getStarttimeinCurrFormat();Lyte.Component.set(r,"Appointment_Start_Time",n);break;case"edit":var o=e.appointmentRecord[0];r.Duration=o.Duration,r.Service_Name=o.Service_Name,r.Location=o.Location,r.Address=o.Address,r.Owner=o.Owner,r.Appointment_Start_Time=o.Appointment_Start_Time;break;case"clone":o=e.appointmentRecord[0];var l=e.serviceRecord[0];r.Duration=l.Duration,r.Service_Name=o.Service_Name,l.Location===I18n.getMsg("Business Address")||l.Location===I18n.getMsg("Client Address")?r.Location=l.Location:r.Location=o.Location,r.Address=o.Address,r.Owner=o.Owner,r.Appointment_Start_Time=o.Appointment_Start_Time}return r},resetCustomFieldValues:function(e,t){var i=[CrmField.UITYPES.MULTI_PICK_LIST];if("Reschedule Information"===e.sectionName){t.$.set(e.getRequiredData.apiVSColObj.RESCHEDULEDFROM,t.$.get(e.getRequiredData.apiVSColObj.APPOINTMENTDATEANDTIME));var r=this.getStarttimeinCurrFormat();t.$.set(e.getRequiredData.apiVSColObj.APPOINTMENTDATEANDTIME,r)}for(var s=["RESCHEDULEDFROM","APPOINTMENTDATEANDTIME"],a=e.fieldsList[0].sectionCustomDetails.fields,n=a.length,o=0;o<n;o++){var l=a[o].fieldRecord;if(!l.column_name.startsWith("APPOINTMENTCF")&&s.includes(l.column_name)||i.contains(l.ui_type)){if(t[l.api_name]&&i.contains(l.ui_type)&&l.ui_type===CrmField.UITYPES.MULTI_PICK_LIST){e=[];l.default_value&&e.push(l.default_value),t.$.set(l.api_name,JSON.stringify(e))}}else{var m=l.default_value;t.$.set(l.api_name,m)}}},getStarttimeinCurrFormat:function(e){var t=$L.moment().toDate(),i=e||Events.getRoundedDateTime(t);return i.setSeconds(0),i.setMilliseconds(0),crmCalendar.convertToUserDatePattern(i.getDate()+" "+i.getMonth()+" "+i.getFullYear())+"TV"+Lyte.registeredMixins["crm-services-appointments-mixin"].getTimeValueInUserFormat(i)},changeAppointmentFieldVisibility:function(e,t){for(var i=e.getRequiredData.serviceDetails,r=e.fieldsList.length,s=e.getRequiredData.apiVSColObj,a=0;a<r;a++){var n=e.fieldsList[a],o=n.sectionCustomDetails.fields.length;switch(n.sectionRecord.name){case"Appointment Information":for(var l=0;l<o;l++){var m=n.sectionCustomDetails.fields[l].fieldRecord;"edit"===e.type?("SERVICEID"!==m.column_name&&"APPOINTMENTDATEANDTIME"!==m.column_name||(m.read_only=!0),"APPOINTMENTADDRESS"===m.column_name&&t.savedRecord[s.APPOINTMENTLOCATION]===I18n.getMsg("Business Address")&&(m.read_only=!0)):"clone"===e.type&&"APPOINTMENTADDRESS"===m.column_name&&("Business Address"===i.Location||"Business Address and Client Address"===i.Location&&t.savedRecord[s.APPOINTMENTLOCATION]===I18n.getMsg("Business Address"))&&(m.read_only=!0)}return e;case"Reschedule Information":for(l=0;l<o;l++){"RESCHEDULEDFROM"===(m=n.sectionCustomDetails.fields[l].fieldRecord).column_name&&(m.view_type.edit=!0,m.read_only=!0)}return e;default:return e}}},generateReschedulePopupFieldsObj:function(e){for(var t=null,i=e.length,r=0;r<i;r++)if("Appointment Information"===e[r].name)for(var s=e[r].fields.length,a=0;a<s;a++)if("APPOINTMENTDATEANDTIME"===e[r].fields[a].column_name){t=e[r].fields[a];break}var n,o=[];for(r=0;r<i;r++)if("Reschedule Information"===e[r].name){n=e[r];var l=e[r].fields.length;for(a=0;a<l;a++){var m=e[r].fields[a],c={};"RESCHEDULEDTO"===m.column_name?(c.fieldRecord=t,c.fieldCustomDetails={sequence_number:m.sequence_number}):(c.fieldRecord=m,c.fieldCustomDetails={}),o.push(c)}return Lyte.registeredMixins["crm-services-appointments-mixin"].generateQuickCreateSectionObj(n,o)}},saveCreateAppointment:function(e,t,i){var r=t[moduleRecordMapping.Appointments.id].id,s=Crm.userDetails.isSandbox?RebrandLinkUtil.getProperty("DEFAULT_SANDBOX_URL"):RebrandLinkUtil.getProperty("CRMURL"),a="<a target='_blank' href='"+(RebrandLinkUtil.getProperty("URLPROTOCOL")+"://"+s+Crm.getCrmBasePath()+"/tab/Appointments/"+r)+"' >"+I18n.getMsg("crm.invitation.view.details.label")+"</a>";if(_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.appointments.create.success.msg",[$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Appointments.singular_label),a]),ltPropType:"success",ltPropYield:"true",ltPropDuration:"4000"}}),this.refreshApp(this.createdSource,void 0,"Appointment Information"),this.resetValues(),"krp"===i.source){var n="Open_Appointments__s",o=e.Appointment_For,l=Object.entries(moduleRecordMapping).filter((e=>e[1].api_name===o.module.api_name))[0],m=Crm.getCrmBasePath()+"/KanbanViewEntity.do?action=get_entity_info&module="+l[0]+"&entityId="+o.id+"&perm=false";l&&"custom"===l[1].generated_type&&(m+="&caller=Feeds"),networkUtils.lyteInitiateRequest(m,"GET").then((function(e){var t=$L("crm-activity-right-panel")[0];t&&t.component.setData(n,e.right_panel_data[n])}))}else"listview"===i.source&&crmListView.reloadCurrentListView()},saveEditAppointment:function(){_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.appointments.edit.success.msg",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Appointments.singular_label)),ltPropType:"success"}}),this.refreshApp(this.createdSource,void 0,"Appointment Information"),this.resetValues()},saveCancelApp:function(){_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.appointment.cancel.msg.successfully",moduleRecordMapping.Appointments.singular_label),ltPropType:"success"}}),this.refreshApp(this.createdSource)},saveRescheduleApp:function(){this.resetAppointmentValues(),_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.appointment.reschedule.msg.successfully",moduleRecordMapping.Appointments.singular_label),ltPropType:"success"}}),this.refreshApp(this.createdSource)},changeAppStatus:function(e,t){var i=t.getRequiredData.apiVSColObj.APPOINTMENTSTATUS;return new Promise((function(t){t(e)})).then((function(e){e.$.set(i,"Cancelled")}))},resetValues:function(){delete this.createdSource,Events.isAppointmentReschedule=!1},updateRecValuesChangeFunc:function(e,t){var i=e.updateRecDetails;for(key in i){var r=[];r.push(key),this.setAppointmentsFieldValues(t,e,r,!0)}},setAppointmentsFieldValues:function(e,t,i,r){var s=this,a=i[0],n=t.getRequiredData.fieldListObj,o=t.type,l=t.getRequiredData.apiVSColObj;switch(a){case l.SEID:var m=$L("#Appointments_fldRow_APPOINTMENTNAME")[0],c=n.APPOINTMENTADDRESS,d=t.getRequiredData.serviceDetails;if("edit"!==o&&d&&m&&!m.component.data.fieldValueChanged&&e.Service_Name&&""!==e.Service_Name.name&&(!e.lookupError||!e.lookupError.Service_Name)&&(!e.$.error||!e.$.error.Service_Name)){var p=e.Service_Name.name+" - "+e.Appointment_For.name;e.$.set("Appointment_Name",p.substring(0,255))}if(d&&e.Location===I18n.getMsg("Client Address")){Lyte.Component.set(c,{read_only:!1,required:!0});var u=$L("#appointmentAddress")[0];u&&Lyte.Component.set(u.component.data,"ltPropValue",""),s.getAppointmentLocationValues(e,s)}break;case l.SERVICEID:var v=e.Service_Name.id;store.registerModel[moduleRecordMapping.Services.id]||store.registerModel(moduleRecordMapping.Services.id,{},{extends:"entity"}),new Promise((function(i){t.getRequiredData.serviceDetails&&t.getRequiredData.serviceDetails.id===v?i(e):store.findRecord(moduleRecordMapping.Services.id,v,{},void 0,!0,{}).then((function(e){t.getRequiredData.serviceDetails=e[0],i(e[0])}))})).then((function(){var a=t.getRequiredData.serviceDetails,n=$L("#Appointments_fldRow_APPOINTMENTNAME")[0];if("edit"!==o&&e.Appointment_For&&n&&!n.component.data.fieldValueChanged&&""!==e.Appointment_For.name){var l=e.Service_Name.name+" - "+e.Appointment_For.name;e.$.set("Appointment_Name",l.substring(0,255))}if(a&&a.Duration){var m=Lyte.registeredMixins["crm-services-mixin"].methods.convertDurationTimeDoubleToUserFormat(a.Duration);e.$.set("Duration",m)}s.memberDataForAppointment(v,a),a&&a.Location&&s.setLocationFieldRelatedChanges(e,t,a.Location,o),s.getAppointmentLocationValues(e,s),s.validateRescheduleApp(e,t,i,r)}));break;case l.APPOINTMENTDATEANDTIME:"edit"!==o&&s.validateRescheduleApp(e,t,i,r);break;case l.SMOWNERID:s.validateRescheduleApp(e,t,i,r);break;case l.APPOINTMENTLOCATION:$L("#Appointments_fldRow_APPOINTMENTLOCATION")[0]&&s.setAddressFieldRelatedChanges(e,t,e.Location,s);break;default:return}},setLocationFieldRelatedChanges:function(e,t,i,r){var s,a=[],n=t.getRequiredData.apiVSColObj;i===I18n.getMsg("Business Address")||i===I18n.getMsg("Client Address")?"edit"===r&&i!==e.Location?(a=[{display_value:I18n.getMsg("Business Address")},{display_value:I18n.getMsg("Client Address")}],e.$.set(n.APPOINTMENTLOCATION,e.Location)):(a=[{display_value:i}],e.$.set(n.APPOINTMENTLOCATION,i)):a=[{display_value:I18n.getMsg("Business Address")},{display_value:I18n.getMsg("Client Address")}];var o=$L("#Appointments_fldRow_APPOINTMENTLOCATION")[0],l=$L("#Crm_Appointments_APPOINTMENTLOCATION")[0];if(o)s=o.component.data,Lyte.Component.set(s.moduledataUicomp[s.currentLayout],"pick_list_values",a),Lyte.Component.set(s,"initialPicklistdata",a),i!==I18n.getMsg("Business Address")&&i!==I18n.getMsg("Client Address")||!l||Lyte.Component.set(l.component.data,"ltPropDisplayValue",i);else{s=t.getRequiredData.fieldListObj.APPOINTMENTLOCATION;var m=t.getRequiredData.sectionDetails.id,c=m.indexOf("_")>-1?m.split("_")[0]:m;Lyte.Component.set(s[c],"pick_list_values",a)}},setAddressFieldRelatedChanges:function(e,t,i,r){var s=$L("#Appointments_fldRow_APPOINTMENTADDRESS")[0];if(s){var a=s.component.data,n=t.getRequiredData.apiVSColObj;switch(i){case I18n.getMsg("Business Address"):e.$.set(n.APPOINTMENTADDRESS,r.getOrgAddressDetails()),Lyte.Component.set(a.moduledataUicomp,{read_only:!0,required:!1}),(o=e.$.model.fieldList[n.APPOINTMENTADDRESS]).mandatory=!1,store.addField(e.$.model._name,n.APPOINTMENTADDRESS,o.type,o);break;case I18n.getMsg("Client Address"):var o;e.$.set(n.APPOINTMENTADDRESS,void 0),Lyte.Component.set(a.moduledataUicomp,{read_only:!1,required:!0}),(o=e.$.model.fieldList[n.APPOINTMENTADDRESS]).mandatory=!0,store.addField(e.$.model._name,n.APPOINTMENTADDRESS,o.type,o)}}},getOrgAddressDetails:function(){var e="",t=Crm.userDetails.orgAddress;if(void 0!==t){for(var i=t.split("|"),r=0;r<5;r++)i[r]&&(e=e+i[r]+", ");e=e.substring(0,e.length-2)}return e},getAppointmentLocationValues:function(e,t){var i=e.Appointment_For?e.Appointment_For.module.api_name:void 0,r=e.Appointment_For?e.Appointment_For.id:void 0;if(r&&("Accounts"===i||"Contacts"===i)){var s={fields:"Contacts"===i?"Mailing_Street,Mailing_City,Mailing_State,Mailing_Zip,Mailing_Country,Other_Street,Other_City,Other_State,Other_Zip,Other_Country":"Billing_Street,Billing_City,Billing_State,Billing_Zip,Billing_Country,Shipping_Street,Shipping_City,Shipping_State,Shipping_Zip,Shipping_Country"},a="/crm/v2.1/"+i+"/"+r;store.findAll("dummy",{},!1,!1,{url:a,method:"GET",params:s}).then((function(e){if(e&&e.data&&e.data.length){for(var i=e.data[0],r=["Billing_Street","Billing_City","Billing_State","Billing_Zip","Billing_Country"],s=["Shipping_Street","Shipping_City","Shipping_State","Shipping_Zip","Shipping_Country"],a=["Mailing_Street","Mailing_City","Mailing_State","Mailing_Zip","Mailing_Country"],n=["Other_Street","Other_City","Other_State","Other_Zip","Other_Country"],o="",l="",m=[],c=0;c<5;c++){var d=r[c],p=s[c],u=a[c],v=n[c];i[d]&&(o=o+i[d]+", "),i[p]&&(l=l+i[p]+", "),i[u]&&(o=o+i[u]+", "),i[v]&&(l=l+i[v]+", ")}l&&m.push(Lyte.registeredMixins["crm-services-appointments-mixin"].removeExtraComma(l)),o&&m.push(Lyte.registeredMixins["crm-services-appointments-mixin"].removeExtraComma(o)),crmCommonModule.customerAddress=m,t.constructAppointmentAddressValue(m)}}))}},constructAppointmentAddressValue:function(e){var t=$L("#Appointments_fldRow_APPOINTMENTADDRESS")[0];if(t){var i=t.component.data;Lyte.Component.set(i,"locFldAddrVal",e)}},memberDataForAppointment:function(e,t){var i,r=this,s=$L("#Appointments_fldRow_SERVICEID")[0];if(s&&t&&t.Members)if(t.$has_more.Members){store.model[moduleRecordMapping.Services.id]||store.registerModel(moduleRecordMapping.Services.id,{},{extends:"entity"});var a={};a.relatedId=e,a.relationId=Lyte.registeredMixins["crm-services-mixin"].getRelationIdofMembersField(),store.findAll(moduleRecordMapping.Services.id,a,void 0,!1).then((function(e){e&&e[moduleRecordMapping.Services.id]&&(i=r.constructMembersIdList(e[moduleRecordMapping.Services.id]),Lyte.Component.set(s.component.data,"membersIdList",i))}))}else i=this.constructMembersIdList(t.Members),Lyte.Component.set(s.component.data,"membersIdList",i)},constructMembersIdList:function(e){var t="";e.users&&(e=e.users);var i=e.length;try{for(var r=0;r<i;r++)t+=e[r].Members.id+",";i>0&&(t=t.slice(0,t.length-1))}catch(i){t=e}return t},validateRescheduleApp:function(e,t,i,r){if((!i||i[0]===t.getRequiredData.apiVSColObj.APPOINTMENTDATEANDTIME||i[0]===t.getRequiredData.apiVSColObj.SERVICEID||i[0]===t.getRequiredData.apiVSColObj.SMOWNERID)&&t.getRequiredData.serviceDetails){var s=this,a=t.getRequiredData.serviceDetails,n=t.getRequiredData.businessJson,o=t.getRequiredData.appPreference,l=!0,[m,c]=this.getAppdetails(e,t.getRequiredData.apiVSColObj),d={businessJson:n,appPref:o,detailsJson:c,apiVsColObj:t.getRequiredData.apiVSColObj};if(!r){if(l=this.checkServiceAvailabilityTime(e,m,a,!0,!1,d,t.type,t.getRequiredData))if($L("#quickCreateSaveAppointments")[0].parentElement.component.data.buttons[1].label===I18n.getMsg("crm.appointments.add.job.sheet")){delete e.id;var p=a.Job_Sheet_Section__s.uservalue?a.Job_Sheet_Section__s.uservalue:a.Job_Sheet_Section__s,u="create"===t.type?s.getRecordDirtyValue(e):s.addCloneFieldValues(e,t.getRequiredData);return void this.showAppointmentSectionPopup(void 0,p,t.source,void 0,"create",void 0,u)}if(l)return new Promise((function(e){!1===s.checkDuplicateEvent(a,c,!0,(function(){!0,e()}),null,o.allow_booking_outside_businesshours,o.allow_booking_outside_service_availability,(function(){s.enableQCFooterBtn("quickCreateAppointmentsPopup",!0)}))&&s.enableQCFooterBtn("quickCreateAppointmentsPopup",!0)}));var v=$L("div#checkDuplicateEvent");return void(v.length&&v[0].scrollIntoView({block:"center",behavior:"smooth"}))}i[0]!==t.getRequiredData.apiVSColObj.APPOINTMENTDATEANDTIME&&i[0]!==t.getRequiredData.apiVSColObj.SMOWNERID&&i[0]!==t.getRequiredData.apiVSColObj.SERVICEID||this.checkServiceAvailabilityTime(e,m,a,!1,!1,d,t.type,t.getRequiredData),!0}},addCloneFieldValues:function(e,t){var i=["Reschedule_Count","Job_Sheet_Created__s","Job_Sheet_Section__s"],r={},s=t.sectionDetails.fields.map((e=>e.api_name)).filter((e=>!i.includes(e)));return s.push("id"),s.forEach((t=>{Object.keys(e).includes(t)&&(r[t]=e[t])})),r},getRecordDirtyValue:function(e){for(var t={},i=e.$.getDirtyAttributes(),r=i.length,s=0;s<r;s++){var a=e[i[s]];Lyte.Component.set(t,i[s],a)}return t},getAppdetails:function(e,t){var i={activityType:"Appointments"};i.ownerId=e.Owner?e.Owner.id:void 0,i.oldStart=this.getAppDateTimeObj(e[t.RESCHEDULEDFROM]),i.start=this.getAppDateTimeObj(e[t.APPOINTMENTDATEANDTIME]),i.oldOwnerId=e.Owner?e.Owner.id:void 0,i.recordId=e.id?e.id.split("_")[0]:void 0;var r={},s=this.getDateTimeFromString(e[t.APPOINTMENTDATEANDTIME]);return r.dateVal=s.date,r.time=s.time,[r,i]},getAppDateTimeObj:function(e){if(e&&""!==e){var t=this.getDateTimeFromString(e),i=t.date,r=t.time;e=i+" "+Utils.convertTimeValueTo24HourFormat(r);return $L.moment(e,Crm.userDetails.DATE_PATTERN.toUpperCase()+" HH:mm")._dateObj}return""},getDateTimeFromString:function(e){if(e){var t,i={};if(-1===e.indexOf("TV"))t=Crm.userDetails.DATE_PATTERN.toLocaleUpperCase()+" "+Crm.userDetails.TIME_FORMAT,i.date=$L.moment($L.moment(e,t).toDate()).format(Crm.userDetails.DATE_PATTERN.toLocaleUpperCase()),i.time=e.replace(i.date,"").trim();else{var r=e.split("TV");i.date=r[0],i.time=r[1]}return i}return""},checkAppointmentTimeWithCurrentTime:function(e){var t=this.getDateTimeFromString(e.Appointment_Start_Time),i=t.date,r=t.time,s=60*parseInt(e.Duration)*1e3,a=Utils.convertTimeValueTo24HourFormat(r),n=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.TIME_ZONE),o=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE)-n,l=(864e5+(CrmDateUtils.timeTomilliseconds(a)+o))%864e5+s,m=$L.moment(i).toDate(),c=CrmDateUtils.convertdateToDBformat(m,!0);return $L.moment(c).time()+l-6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE)<$L.moment().time()},cancelServerErrors:function(e){var t=JSON.parse(e.response).data[0];"duplicate data"===t.message?this.showduplicateAlertMessage(t,detailView.cancelAppSection):"the id given seems to be invalid"===t.message?this.refreshApp(this.createSource):"permission denied"===t.message?renderingUtils.displayPermissionDenied():"Completed Appointment cannot be marked as Cancelled,Scheduled or Overdue"!==t.message&&"To Update the fields of Cancellation Information Section, value of Status should be Cancelled"!==t.message||this.refreshApp(this.createSource)},rescheduleServerErrors:function(e){var t=JSON.parse(e.response).data[0];"DEPENDENT_FIELD_UNCHANGED"===t.code&&"Reschedule the appointment atleast once to Update the fields of Reschedule Information Section"===t.message?_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.appointment.already.scheduled",moduleRecordMapping.Appointments.singular_label),ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}}):"Appointment time does not falls under business hours"===t.message?_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("bh.wrng.user.bh.time"),ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}}):"Service is not available on the given time"===t.message?_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.appointments.service.datetimealert",moduleRecordMapping.Services.singular_label),ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}}):"duplicate data"===t.message?this.showduplicateAlertMessage(t,detailView.rescheduleAppSection):"the id given seems to be invalid"===t.message||"Completed Appointment or Cancelled Appointment cannot be rescheduled"===t.message?this.refreshApp(this.createdSource):"permission denied"===t.message&&renderingUtils.displayPermissionDenied()},getDisplayValue:function(e,t){for(var i=e.length,r=0;r<i;r++){var s=e[r];if(s.actual_value===t)return s.display_value}return null},enableQCFooterBtn:function(e,t){var i;(i=t?$L("."+e).find("crm-create-buttons"):$L("#"+e).find("crm-create-buttons")).length>0&&i[0].component.setData("disableFormbuttons",!1)},setAppointmentPopupParams:function(e,t,i,r){var s={};switch(e){case"relatedlist_new":var a,n,o,l=Lyte.Router.getRouteInstance()&&"canvas"===Lyte.Router.getRouteInstance().routeName;if(l)a=$L("crm-detailview-canvas")[0].component.data.relatedlist.cruxFilterBy({personality_name:"APPOINTMENTSPERSONALITY"})[0];else a=store.peekAll("related_list").filterBy({personality_name:"APPOINTMENTSPERSONALITY"})[0];if(a.id&&!a.isCustLookUp){if(l){var m=$("crm-detailview-canvas")[0].component.data;return o="Contacts"===(n=m.module)?m.originalRecord.Full_Name:"Services"===n?m.originalRecord.Service_Name:m.originalRecord.Name,this.setAppointmentParams(detailView.entityId,o,detailView.currentModule,s)}return this.setAppointmentParams(detailView.entityId,$L("#entityName").val(),detailView.currentModule,s)}return s;case"krp":var c=$L("#krp_Rightpanel_InfoContainer").find("#entityName").val();return this.setAppointmentParams($$rightPanel.entityId,c,$$rightPanel.currentModule,s);case"salessignals":var d=$L("#ss_entityId").val(),p=$L("#ntcBusinessCard"+d).find("#subvalue_LASTNAME").text();return this.setAppointmentParams(d,p,$L("#ss_module").val(),s);case"listview":if($L(t).length&&"kanban"===Lyte.Router.getRouteInstance().routeName){var u=$L(t).attr("data-relid"),v=$L("[name='module']").val();return this.setAppointmentParams(u,$L("#listView_"+u).text(),v,s)}if($L(t).length&&"list"===Lyte.Router.getRouteInstance().routeName&&"Appointments"!==Lyte.Router.getRouteInstance().transition.info.dynamicParams[0]){var g,h=$L(t).attr("id").split("_")[1],A=Lyte.Router.getRouteInstance().transition.info.dynamicParams;g="Services"===A[0]?"SERVICENAME":"Contacts"===A[0]?"FULLNAME":"NAME";var f=store.peekRecord(moduleRecordMapping[A[0]].id,h),C=Lyte.registeredMixins["crm-services-mixin"].getApiNameForField(A[0],g);return this.setAppointmentParams(h,f[C],A[0],s)}return s;case"calendar":if($("#wid_calCreate_opts_menu").hide(),"monthview"===calView.currCalView&&"calendarGlobelAdd"!==e||"weekview"===calView.currCalView&&calView.isMultiUserView&&"24:00"!==Crm.calPreferences.DAYSTARTSAT)if(Utils.isToday(i)){var D=$L.moment().toDate();i.setHours(D.getHours()),i.setMinutes(D.getMinutes()),i=Events.getRoundedDateTime(i)}else i.setHours(parseInt(Crm.calPreferences.DAYSTARTSAT));else"dayview"!==calView.currCalView&&"weekview"!==calView.currCalView||i.setMinutes(0);return s.startTime=i,s.popoverDetails=this.getPopoverDetails(r),s.viewType="popover",s;default:return s}},setAppointmentParams:function(e,t,i,r){if(void 0===r)r={};return r.relEntityId=e,r.relEntityName=t,r.relModuleName=i,r},getPopoverDetails:function(e){var t={posObj:{}};return t.posObj.top=e.pageY?e.pageY:e.clientY+document.body.scrollTop+document.documentElement.scrollTop,t.posObj.left=e.pageX?e.pageX:e.clientY+document.body.scrollTop+document.documentElement.scrollTop,t.popoverDraggable=!1,t},checkAppointmentRecordPermission:function(e,t){var i="Crm_Implied_"+t+"_"+e;return!!Crm.userDetails.permissions[i]||(_cruxUtils.showPermissionDeniedModal(),!1)},saveJobSheetPopup:function(e,t){var i=t.getRequiredData.apiVSColObj.APPOINTMENTSTATUS;return new Promise((function(t){t(e)})).then((function(e){e.$.set(i,"Completed")}))},cancelJobSheetPopup:function(e,t){var i=t.getRequiredData.fileUpload;i&&(fileupload={...fileupload,...i})},postSaveJobSheetPopupAction:function(e,t,i){this.resetAppointmentValues(),_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.appointment.complete.msg.successfully",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Appointments.singular_label)),ltPropType:"success"}}),this.refreshApp(i.source,"Complete","Appointment Information")},setJobSheetCustomData:function(e,t){var i={customData:{}};return i.customData.saveJobSheets=!0,i.customData.sectionName=t.sectionName,i.customData.LayoutId=t.getRequiredData.LayoutId,i},handleJobsheetServerErrors:function(){this.refreshApp(this.createdSource)},setAppointmentStatusActions:function(e,t,i){var r=this;$("#eventViewPopup").hide(),$("#moreEventsAllDiv").hide();var s=Lyte.registeredMixins["crm-detailcanvas-utils"],a=s&&s.isFromCanvasActivityEnabledModule("Appointments"),n=Crm.renderDVLyteFlow(moduleRecordMapping.Appointments.module_name);if(n||a||!n&&"appointmentCompletePopup"!==e){var o=JSON.parse(t.dataset.params).id,l=JSON.parse(t.dataset.params).from,m=JSON.parse(t.dataset.params).serviceId,c=JSON.parse(t.dataset.params).from;Lyte.resolvePromises({filesResolved:Lyte.injectResources(networkUtils.returnDependencyFiles(["zohocrm_services.js"],ResourceConstants.CRM).concat(networkUtils.returnDependencyFiles(["crm-services-appointments.js","servapp_preferences_model.js"],ResourceConstants.CRMClient)).concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("businesshours")],ResourceConstants.CRM)))}).then((function(){switch(e){case"Reschedule Information":r.showAppointmentSectionPopup(o,"Reschedule Information",c,m);break;case"Cancellation Information":r.showAppointmentSectionPopup(o,"Cancellation Information",c);break;case"appointmentCompletePopup":r.markascompletedAppointment("Appointment",void 0,void 0,l,o)}}))}else{if("appointmentCompletePopup"===e){var d=$L.moment()._dateObj,p=$L.moment(i)._dateObj;if(d.getTime()<p.getTime())return _cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.appointment.endtime.alert",moduleRecordMapping.Appointments.singular_label),ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}}),void this.resetAppointmentValues()}Crm.isAppAction=e,Crm.editEntity(event,t),event.preventDefault()}},scheduledAppMoreOption:function(e,t,i,r,s,a,n,o,l,m){var c=this;this.removeAppMoreOption();var d=e.id.split("_")[1];this.showAppMoreOptionsMenu(i,n);var p=$(e),u=Utils.windowWidth,v=Utils.windowHeight,g=p.offset().left,h=p.offset().top,A=$("#appMoreOption"),f=$("#cancelAppMoreOption"),C=$("#completeAppMoreOption"),D=$("#rescheduleAppMoreOption"),_=A.outerWidth(),y=$(e).outerHeight();if(A.removeClass("callsReminPop").css({position:"absolute"}),A.css({zIndex:"104"}),$(".moreOptionRow").removeClass("moreOptionRow"),p.closest("tr").addClass("moreOptionRow"),"homePage"===t&&$(".rep_runbtn").is(":visible")?A.css({left:g+30,top:h-4}):"listView"===t&&A.css({left:g+40,top:h-4}),$(e).hasClass("btnTransfer"))A.css({left:g,top:h+y}).addClass("callsReminPop");else{var M=h+_;u<g+y+10+_?(g-=_+10,h-=_):v<M&&(h=h-_+37),A.css({top:h-5}),Crm.userDetails.RTL_ENABLED?A.css({left:g-(_+10)}):A.css({left:g+y+10})}f.off("click mouseleave"),f.off("click mouseleave"),D.off("click mouseleave"),C.on("click",(function(){c.removeAppMoreOption(),c.markascompletedAppointment("Appointment",void 0,void 0,t,d)})),D.on("click",(function(){c.removeAppMoreOption();var e=JSON.parse(m).id,t=JSON.parse(m).serviceId,i=JSON.parse(m).from;c.showAppointmentSectionPopup(e,"Reschedule Information",i,t),event.preventDefault()})),f.on("click",(function(){c.removeAppMoreOption();var e=JSON.parse(m).id,t=JSON.parse(m).serviceId,i=JSON.parse(m).from;c.showAppointmentSectionPopup(e,"Cancellation Information",i,t),event.preventDefault()}));var T=$("#editAppRecordbtn"),b=$("#deleteAppRecordbtn");if("homePage"===t){var S=JSON.parse(e.dataset.params);b.on("click",(function(){var e=$("#deleteAppRecordbtn");c.removeAppMoreOption(),e.attr("data-onclick","return delAction('"+S.module+"','"+d+"','"+S.layoutHomeId+"','"+S.dashletId+"','"+s+"')"),showDeletePopup(d,"crm.button.move.to.trash","","",e,"Home"),event.preventDefault()})),T.on("click",(function(){var t=$("#editAppRecordbtn");c.removeAppMoreOption(),t.attr({"data-zcqa":"editbtn","data-cid":"editbtn","data-params":e.dataset.params,href:"'"+r+"/EditEntity.do?module="+S.module+"&id="+d+"'"})}))}else b.on("click",(function(){var e=$("#deleteAppRecordbtn");c.removeAppMoreOption(),Crm.userDetails.isRelatedListLyteEnabled?e.attr("data-onclick","javascript:Lyte.registeredMixins['crm-related-list-utils'].sortRelatedList('"+r+"','','"+d+"')"):e.attr("data-onclick","javascript:sortRelatedList('"+r+"','','"+d+"')"),showDeletePopup(d,"crm.button.move.to.trash","","",e,"rl"),event.preventDefault()})),T.on("click",(function(){var e=$("#editAppRecordbtn");c.removeAppMoreOption(),e.attr({"data-zcqa":o,"data-cid":l,"data-params":m})}));$(".appMoreOptionNew ul").on("mouseleave",(function(){c.removeAppMoreOption()})),A.show()},removeAppMoreOption:function(){$(".appMoreOptionNew").hide(),$(".moreOptionRow").removeClass("moreOptionRow"),$("#appMoreOption").remove(),$("#dvinner").removeClass("moreOpt_prevent_scroll")},showAppMoreOptionsMenu:function(e,t){if(0===$("#appMoreOption").length){var i='{"module" :"Appointments","isComp" : "'+("mark_as_complete"!==t.when_duration_exceeds||"Overdue"===e)+'","isScheduled" :"'+e+'","isEdit" :"'+Crm.userDetails.permissions.Crm_Implied_Edit_Appointments+'","isDelete" :"'+Crm.userDetails.permissions.Crm_Implied_Delete_Appointments+'"}';$("#show").append(Handlebars.templates.callMoreOptionsMenu(JSON.parse(i))),$("#dvinner").addClass("moreOpt_prevent_scroll")}},checkDuplicateEvent:function(e,t,i,r,s,a,n,o){var l=this,m=e?60*Lyte.registeredMixins["crm-services-mixin"].methods.convertTimeInHrMinsToDouble(e.Duration)*1e3:void 0,c=$("#Crm_Appointments_SMOWNERID"),d="";if(!t){var p=$("#Crm_Appointments_APPOINTMENTDATEANDTIME");(t={start:p.data("dateObj"),activityType:"Appointments"}).oldStart=new Date(p.data("oldValue")),t.ownerId=c.data("id"),t.oldOwnerId=c.data("oldValue"),0===c.length||Events.isAppointmentRescheldule&&!Events.entityId?(c=$("#value_SMOWNERID #ownerName_id"),t.ownerId=c.data().params.userId,d=detailView.entityId):t.ownerId=c.component?c.component.getData("dataId"):t.ownerId,!d&&Events.entityId&&(d=Events.entityId)}""===d&&t.recordId&&(d=t.recordId);var u=t.activityType,v=t.start;$("div#checkDuplicateEventAlert").remove();var g=t.ownerId,h=document.getElementById("Crm_Appointments_SMOWNERID");if(h&&h.component&&!h.component.getData("dataId"))return;if(g){var A="";c.length>0&&(A=c.attr("data-id"));var f=Utils.getTimeStringWithAmPm(v),C=Utils.getDateInUserDatePattern(v,!0)+" "+f.hrs+":"+f.mins+" "+f.meridiem,D=$L.moment($L.moment(v).toDate().getTime()+m).toDate(),_=Utils.getTimeStringWithAmPm(D),y=Utils.getDateInUserDatePattern(D,!0)+" "+_.hrs+":"+_.mins+" "+_.meridiem;return Events.isAppointmentReschedule&&i&&v.getTime()===t.oldStart.getTime()?(_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.appointment.already.scheduled",moduleRecordMapping.Appointments.singular_label),ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}}),!1):("edit"!==Events.currentStatus||v.getTime()!==t.oldStart.getTime()||A!==g)&&void this.checkAvailability(C,y,t.ownerId,u,d,!1,(function(e){var t,s,m=e.activityType,c=e.isAllDay,d=$("div#checkDuplicateEventAlert"),p=d,v="<a style='word-break:break-word' target='_blank' href='"+Crm.getCrmBasePath()+"/EntityInfo.do?module="+m+"&id="+e.entityId+"'>"+e.subject+"</a>";switch("Appointments"===u&&m&&(t=Crm.userDetails.USER_ID==g?"Events"===m?c?I18n.getMsg("crm.duplicate.event.overlap.allday.appointment.you",[v,Events.getModuleName(!0,!1,!0),Crm.moduleInfo[u].translatedSingularLabel.toLocaleLowerCase()]):e.startCoincides?I18n.getMsg("crm.duplicate.event.overlapwith.appointment.start.you",[v,e.endtimeStr,Events.getModuleName(!0,!1,!0),Crm.moduleInfo[u].translatedSingularLabel.toLocaleLowerCase()]):I18n.getMsg("crm.duplicate.event.overlapwith.appointment.end.you",[v,e.starttimeStr,Events.getModuleName(!0,!1,!0),Crm.moduleInfo[u].translatedSingularLabel.toLocaleLowerCase()]):"Appointments"===m?e.startCoincides?I18n.getMsg("crm.duplicate.event.overlapwith.event.start.you",[v,e.endtimeStr,Crm.moduleInfo[m].translatedSingularLabel.toLocaleLowerCase()]):I18n.getMsg("crm.duplicate.event.overlapwith.event.end.you",[v,e.starttimeStr,Crm.moduleInfo[m].translatedSingularLabel.toLocaleLowerCase()]):e.startCoincides?I18n.getMsg("crm.duplicate.event.overlapwith.call.start.you",[v,e.starttimeStr,Crm.moduleInfo[u].translatedSingularLabel.toLocaleLowerCase()]):I18n.getMsg("crm.duplicate.event.overlapwith.call.end.you",[v,e.starttimeStr,Crm.moduleInfo[u].translatedSingularLabel.toLocaleLowerCase()]):"Events"===m?c?I18n.getMsg("crm.duplicate.appointment.overlap.allday.other",[e.ownerName,v,Events.getModuleName(!0,!1,!0),Crm.moduleInfo[m].translatedSingularLabel.toLocaleLowerCase()]):e.startCoincides?I18n.getMsg("crm.duplicate.event.overlapwith.appointment.start.other",[e.ownerName,v,e.endtimeStr,Events.getModuleName(!0,!1,!0),Crm.moduleInfo[m].translatedSingularLabel.toLocaleLowerCase()]):I18n.getMsg("crm.duplicate.event.overlapwith.appointment.end.other",[e.ownerName,v,e.starttimeStr,Events.getModuleName(!0,!1,!0),Crm.moduleInfo[m].translatedSingularLabel.toLocaleLowerCase()]):"Appointments"===m?e.startCoincides?I18n.getMsg("crm.duplicate.event.overlapwith.event.start.other",[e.ownerName,v,e.endtimeStr,Crm.moduleInfo[m].translatedSingularLabel.toLocaleLowerCase()]):I18n.getMsg("crm.duplicate.event.overlapwith.event.end.other",[e.ownerName,v,e.endtimeStr,Crm.moduleInfo[m].translatedSingularLabel.toLocaleLowerCase()]):e.startCoincides?I18n.getMsg("crm.duplicate.event.overlapwith.call.start.other",[e.ownerName,v,e.starttimeStr,Crm.moduleInfo[u].translatedSingularLabel.toLocaleLowerCase()]):I18n.getMsg("crm.duplicate.event.overlapwith.call.end.other",[e.ownerName,v,e.starttimeStr,Crm.moduleInfo[u].translatedSingularLabel.toLocaleLowerCase()])),e.type){case"business":i?t=I18n.getMsg("crm.appointments.outsidebusiness.timealert"):e.isAvail=!1;break;case"shift":s=I18n.getMsg("bh.wrng.user.sh.time.1",[e.ownerName]);break;case"Unavailable":switch(e.unavailabletype){case 1:s=I18n.getMsg("bh.wrng.user.busy.time1",[e.ownerName,e.starttime,e.endtime]);break;case 2:s=I18n.getMsg("bh.wrng.user.busy.time2",[e.ownerName]);break;case 3:s=I18n.getMsg("bh.wrng.user.busy.time3",[e.ownerName,e.startdate,e.enddate]);break;default:s=I18n.getMsg("bh.wrng.user.busy.time4",[e.ownerName,e.starttime,e.startdate,e.endtime,e.enddate])}break;case"holiday":s=I18n.getMsg("bh.wrng.user.holidayonly",[e.time]);break;case"break":s=I18n.getMsg("bh.wrng.user.break.time.1",[e.ownerName])}var h=d.parent().children(".labelTabCreate").outerWidth();if(t){o&&o();p=renderingUtils.createHTML({name:"div",attr:{id:"checkDuplicateEventAlert",class:"timeAlert mB10"},child:[{name:"div",attr:{},child:[{name:"div",css:{background:"var(--orangeLightBg)",padding:"4px",border:"1px solid var(--orangeLightBr)","border-radius":"4px",color:"--crmWarningColor","word-break":"break-word"},child:[{name:"table",attr:{cellpadding:"3",cellspacing:"0",border:"0"},child:[{name:"tbody",child:[{name:"tr",child:[{name:"td",attr:{valign:"top"},child:[{name:"span",attr:{class:"zcicncss-alert-filled zcicn-cssIcons zcicn_red_mask mT2"}}]},{name:"td",attr:{class:"crm-small-font-size"},html:t}]}]}]}]}]}]});var A=null,f=null,C=null,D=$("#Crm_Appointments_APPOINTMENTDATEANDTIME");D.length?(f=(A=D.closest(".tabDivCreate")).find(".labelValCreate").outerWidth(),C=A.find(".labelTabCreate").outerWidth()):(f=(A=$L(".quickcreateMainDetailsContainer").find("#Appointments_fldRow_APPOINTMENTDATEANDTIME")).find(".FValue").outerWidth(),C=A.find(".customfieldLabel").outerWidth()),d.remove(),$(p).insertAfter(A),Crm.userDetails.RTL_ENABLED?$(p).css({width:f,"margin-right":"-8px","margin-right":C}):$(p).css({width:f,"margin-top":"-8px","margin-left":C}),d.css({"margin-left":h,"margin-top":"10px"})}if(s){o&&o();var _=renderingUtils.createHTML({name:"div",attr:{id:"checkDuplicateEventAlert",class:"timeAlert mB10"},child:[{name:"div",attr:{},child:[{name:"div",css:{background:"var(--orangeLightBg)",padding:"4px",border:"1px solid var(--orangeLightBr)","border-radius":"4px","word-break":"break-word"},child:[{name:"table",attr:{cellpadding:"3",cellspacing:"0",border:"0"},child:[{name:"tbody",child:[{name:"tr",child:[{name:"td",attr:{valign:"top"},child:[{name:"span",attr:{class:"zcicncss-alert-filled zcicn-cssIcons zcicn_red_mask mT2"}}]},{name:"td",attr:{class:"crm-small-font-size"},html:s}]}]}]}]}]}]});d.css({"margin-left":h,"margin-top":"10px"});var y=null;f=null,C=null;f=(y=Events.isAppointmentReschedule?A||$L("#Appointments_fldRow_APPOINTMENTDATEANDTIME"):A||$L("#Appointments_fldRow_SMOWNERID")).find(".FValue").outerWidth(),C=y.find(".customfieldLabel").outerWidth(),Crm.userDetails.RTL_ENABLED?$(_).css({width:f,"margin-top":"-8px","margin-right":C}):$(_).css({width:f,"margin-top":"-8px","margin-left":C}),d.remove(),$("div#checkDuplicateEventAlert").length&&($(_).removeClass("mB10"),$(_).addClass("mB15")),$(_).insertAfter(y);var M=$("div#checkDuplicateEvent");if($(_).insertAfter(M.is(":visible")?"#checkDuplicateEvent":y),i&&"holiday"===e.type){var T=$L("div#checkDuplicateEventAlert");T.length&&T[0].scrollIntoView({block:"center",behavior:"smooth"})}}if(i)if(e.isAvail||e.type||Crm.alertMsg){if(!a&&Events.isAppointmentReschedule&&"holiday"===e.type)_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:s,ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]},accept:function(){$L("#quickCreateCancelAppointments").length>0&&l.enableQCFooterBtn("quickCreateAppointmentsPopup",!0)}});else if("business"===e.type&&!a||!e.type&&Crm.alertMsg&&!e.isAvail&&!n)_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:t,ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]},accept:function(){$L("#quickCreateCancelAppointments").length>0&&l.enableQCFooterBtn("quickCreateAppointmentsPopup",!0)}});else if((Crm.alertMsg||"business"!==e.type)&&("holiday"!==e.type||a)){t?(t="<p>"+t+"</p>",Crm.alertMsg&&(t="<p>"+Crm.alertMsg+"</p><br>"+t),s&&(t=t+"<br><p>"+s+"</p>")):Crm.alertMsg?t=s?"<p>"+Crm.alertMsg+"</p><br>"+s:"<p>"+Crm.alertMsg+"</p>":s&&(t="<p>"+s+"</p>");var b=[{type:"reject",text:I18n.getMsg("crm.button.cancel"),appearance:"default",cxPropZcqa:"confirmButton1"},{type:"accept",text:I18n.getMsg("crm.button.create"),appearance:"primary",cxPropZcqa:"confirmButton0"}],S="crm.events.duplicate.create.msg2";"edit"===Crm.currentStatus&&(b=[{type:"reject",text:I18n.getMsg("crm.button.cancel"),appearance:"default",cxPropZcqa:"confirmButton1"},{type:"accept",text:I18n.getMsg("crm.button.save"),appearance:"primary",cxPropZcqa:"confirmButton0"}],S="crm.events.duplicate.edit.msg2"),_cruxUtils.showCustomAlert({params:{ltPropYield:!0,ltPropWrapperClass:"duplicateEventMsg crmCenterAlert",ltPropPrimaryMessageMarkdown:!1,ltPropPrimaryMessageZcqa:"confirmMessage0",ltPropSecondaryMessageMarkdown:!1,ltPropButtonPosition:"center",ltPropShowCloseButton:!1,ltPropSecondaryMessage:t+"<br>"+I18n.getMsg(S,[moduleRecordMapping.Appointments.singular_label]),ltPropSecondayMessageZcqa:"confirmMessage1",ltPropButtons:b},accept:function(){r&&r(e.isAvail)},reject:function(){$L("#quickCreateCancelAppointments").length>0&&l.enableQCFooterBtn("quickCreateAppointmentsPopup",!0)}})}}else r&&r();else r&&r(e.isAvail)}))}},checkAvailability:function(e,t,i,r,s,a,n){(new crmRequestPool).initiate({action:Crm.getCrmBasePath()+"/events/EventAction.do",type:"GET",data:"type=checkAvail&st="+e+"&et="+t+"&hostId="+i+"&entityId="+s+"&actType="+r+"&meetNow="+a,success:n})},openAlertPopup:function(e,t,i,r){var s=$("#checkDuplicateEvent"),a=s.length>0?s:$(Lyte.registeredMixins["crm-services-appointments-old-mixin"].createAlertDivElementForAppointment());a.insertAfter(t),$L("#appointmentAlert").html(e),Crm.userDetails.RTL_ENABLED?a.css({width:i,"margin-top":"-8px","margin-right":r}):a.css({width:i,"margin-top":"-8px","margin-left":r})},checkServiceAvailability:function(e,t,i){var r={};r.dateVal=$L(e).val();var s=e.id;if("Crm_Appointments_APPOINTMENTDATEANDTIME"==s&&$("#errorMsg_"+s).remove(),r.time=$L("#Crm_Appointments_APPOINTMENTDATEANDTIME_TimeOption").val(),r.elem=e,r.dateVal&&$L.moment(r.dateVal,Crm.userDetails.DATE_PATTERN.toUpperCase(),!0).validate()){var a,n=$L("#Crm_Appointments_SERVICEID");if(n.length>0&&(a=n.attr("serviceJSON"))&&(a=JSON.parse(a)),a&&!Events.isAppointmentReschedule||(a=(n=$L("#Crm_Appointments_APPOINTMENTDATEANDTIME")).attr("serviceJSON"))&&(a=JSON.parse(a)),a&&Crm.businessJSON&&this.appointmentPreferences){var o={businessJson:Crm.businessJSON,appPref:Lyte.registeredMixins["crm-appointments-mixn"].appointmentPreferences,detailsJson:null};return this.checkServiceAvailabilityTime(void 0,r,a,t,i,o)}return null}},checkServiceAvailabilityTime:function(e,t,i,r,s,a,n,o){var l,m,c;if((l=$L("#Appointments_fldRow_APPOINTMENTDATEANDTIME")).length>0&&(Events.isAppointmentReschedule||crmConstants.lyteCreateInitialModules.contains("Appointments")&&crmConstants.lyteCreateInitialModules.contains("Services")&&("create"===n||"clone"===n))){m=l.find(".FValue").outerWidth(),c=l.find(".customfieldLabel").outerWidth();var d=$L("#quickCreateSaveAppointments")[0];if(d)var p=d.parentElement.component.data.buttons[1]}else{m=(l=$(t.elem).closest(".tabDivCreate")).find(".labelValCreate").outerWidth(),c=l.find(".labelTabCreate").width()+20;var u=$("#saveAppointmentsBtn")}Crm.alertMsg=void 0;var v=!1,g=!1,h=t.dateVal;if(h&&$L.moment(h,Crm.userDetails.DATE_PATTERN.toUpperCase(),!0).validate()&&(u?u.attr("value",I18n.getMsg("Save")):Lyte.Component.set(p,"label",I18n.getMsg("Save")),i)){var A=a.appPref;if(!s){var f=t.time,C=Utils.convertTimeValueTo24HourFormat(f),D=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.TIME_ZONE),_=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE)-D,y=CrmDateUtils.timeTomilliseconds(C)+_,M=new Date(CrmDateUtils.convertdateToDBformat(h,!0)+"T00:00:00"),T=new Date(CrmDateUtils.convertdateToDBformat(h,!0)+"T00:00:00"),b=60*Lyte.registeredMixins["crm-services-mixin"].methods.convertTimeInHrMinsToDouble(i.Duration)*1e3;y>=864e5?M.setDate(M.getDate()+1):y<0&&M.setDate(M.getDate()-1),y+b>=864e5?T.setDate(T.getDate()+1):y+b<=0&&T.setDate(T.getDate()-1);var S=CrmDateUtils.convertdateToDBformat(M,!0),I=CrmDateUtils.convertdateToDBformat(T,!0),E=JSON.parse(JSON.stringify(i)),L=(new Date(S+"T00:00:00").getDay()-1+7)%7,R=(new Date(I+"T00:00:00").getDay()-1+7)%7,N=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],P=E.Availability_Type.uservalue;P||(P=E.Availability_Type);var O,w,U=E.Available_Timings,x=new Date(S).getTime(),V=new Date(I).getTime(),k="<a target='_blank' href='"+Crm.getCrmBasePath()+"/EntityInfo.do?module="+moduleRecordMapping.Services.plural_label+"&id="+E.id+"'>"+$ESAPI.encoder().encodeForHTML(E.Service_Name)+"</a>",F=null,B=$(Lyte.registeredMixins["crm-services-appointments-old-mixin"].createAlertDivElementForAppointment());$("div#checkDuplicateEvent").remove();var J=a.businessJson,j=(864e5+y)%864e5,q=j+b;if("custom"===J.type)if(!0===J.same_as_everyday)J.business_days.contains(N[L])&&(O=J.details[0],w=J.details[1]);else for(var H=J.details,Y=H.length,W=0;W<Y;W++)if(H[W].days===N[L]){O=H[W].business_timing[0],w=H[W].business_timing[1];break}var G=!1,z=V+(864e5+q)%864e5-6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE);if(z<(new Date).getTime()?(r&&Events.isAppointmentReschedule&&"ask_appointment_provider_to_complete"===A.when_duration_exceeds?e.$.set(a.apiVsColObj.APPOINTMENTSTATUS,"Overdue"):r&&e.$.set(a.apiVsColObj.APPOINTMENTSTATUS,"Completed"),G=!0):delete e[a.apiVsColObj.APPOINTMENTSTATUS],"clone"===n&&r){var Z=Lyte.registeredMixins["crm-appointments-mixin"].addCloneFieldValues(e,o);Object.keys(e).forEach((t=>{Z.hasOwnProperty(t)||delete e[t]}))}!(ee=J.business_days)||ee.includes(N[L])&&ee.includes(N[R])||(F=F||I18n.getMsg("crm.appointments.outsidebusiness.datealert"),this.openAlertPopup(F,l,m,c),g=!0,Crm.alertMsg=F),"custom"===J.type&&(O&&w?(j-CrmDateUtils.timeTomilliseconds(O)<0||q-CrmDateUtils.timeTomilliseconds(w)>0)&&(F=F||I18n.getMsg("crm.appointments.outsidebusiness.timealert"),this.openAlertPopup(F,l,m,c),Crm.alertMsg=F,g=!0):(F=F||I18n.getMsg("crm.appointments.outsidebusiness.timealert"),this.openAlertPopup(F,l,m,c),Crm.alertMsg=F,g=!0));var Q=E.Unavailable_Till,X=E.Unavailable_From,K=x+j-6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE);if(X&&!g&&K-new Date(X).getTime()>=0&&(!Q||K-new Date(Q).getTime()<=0||z-new Date(X).getTime()>=0&&(!Q||z-new Date(Q).getTime()<=0))&&(g=!0,F=I18n.getMsg("crm.appointments.outsideservice.datealert",[moduleRecordMapping.Services.singular_label.toLocaleLowerCase(),k]),this.openAlertPopup(F,l,m,c),Crm.alertMsg=F,v=!0),P!==I18n.getMsg("Specific Date Range")||g)if(P!==I18n.getMsg("Specific Date(s)")||g){if(P===I18n.getMsg("Specific Day(s)")&&!g){var ee=E.Available_Days;(ee=JSON.stringify(ee)).includes(N[L])&&ee.includes(N[R])||(F=F||I18n.getMsg("crm.appointments.outsideservice.dayalert",[moduleRecordMapping.Services.singular_label.toLocaleLowerCase(),k]),this.openAlertPopup(F,l,m,c),v=!0,Crm.alertMsg=F)}}else{var te=E.Available_Dates,ie=JSON.stringify(te);ie.includes(S)&&ie.includes(I)||(F=F||I18n.getMsg("crm.appointments.outsideservice.datealert",[moduleRecordMapping.Services.singular_label.toLocaleLowerCase(),k]),this.openAlertPopup(F,l,m,c),Crm.alertMsg=F,v=!0)}else{var re=E.Available_From,se=E.Available_Till,ae=Lyte.Transform.date.serialize(re),ne=Lyte.Transform.date.serialize(se);B.css({width:m,"margin-top":"-10px","margin-left":c}),(x-new Date(ae).getTime()<0||V-new Date(ne).getTime()>0)&&(F=F||I18n.getMsg("crm.appointments.outsideservice.datealert",[moduleRecordMapping.Services.singular_label.toLocaleLowerCase(),k]),this.openAlertPopup(F,l,m,c),v=!0,Crm.alertMsg=F)}if("Same as business time"!==U&&U||"custom"===J.type||r){if(U&&!g){var oe=U;"string"==typeof oe&&(oe=JSON.parse(oe)),1==oe.length?(j-CrmDateUtils.timeTomilliseconds(oe[0].From)<0&&(F=F||I18n.getMsg("crm.appointments.outsideservice.timealert",[moduleRecordMapping.Services.singular_label.toLocaleLowerCase(),k]),this.openAlertPopup(F,l,m,c),Crm.alertMsg=F,v=!0),q-CrmDateUtils.timeTomilliseconds(oe[0].To)>0&&(F=F||I18n.getMsg("crm.appointments.outsideservice.timealert",[moduleRecordMapping.Services.singular_label.toLocaleLowerCase(),k]),this.openAlertPopup(F,l,m,c),v=!0,Crm.alertMsg=F)):j-CrmDateUtils.timeTomilliseconds(oe[0].From)>=0&&q-CrmDateUtils.timeTomilliseconds(oe[0].To)<=0||j-CrmDateUtils.timeTomilliseconds(oe[1].From)>=0&&q-CrmDateUtils.timeTomilliseconds(oe[1].To)<=0||(F=F||I18n.getMsg("crm.appointments.outsideservice.timealert",[moduleRecordMapping.Services.singular_label.toLocaleLowerCase(),k]),this.openAlertPopup(F,l,m,c),v=!0,Crm.alertMsg=F)}}else this.checkDuplicateEvent(i,a.detailsJson,r,null,null,A.allow_booking_outside_businesshours,A.allow_booking_outside_service_availability)}if(!r){var le=a.detailsJson?a.detailsJson:null;this.checkDuplicateEvent(i,le,r,null,null,A.allow_booking_outside_businesshours,A.allow_booking_outside_service_availability)}if(g&&A.allow_booking_outside_businesshours||v&&A.allow_booking_outside_service_availability)return"edit"!==n&&G&&A.show_job_sheet&&i.Job_Sheet_Required&&(i.Job_Sheet_Required===I18n.getMsg("Yes")||i.Job_Sheet_Required.systemvalue===I18n.getMsg("Yes"))&&(u?u.attr("value",I18n.getMsg("crm.appointments.add.job.sheet")):Lyte.Component.set(p,"label",I18n.getMsg("crm.appointments.add.job.sheet"))),!0;if("edit"!==n&&G&&A.show_job_sheet&&i.Job_Sheet_Required&&(i.Job_Sheet_Required===I18n.getMsg("Yes")||i.Job_Sheet_Required.systemvalue===I18n.getMsg("Yes")))u?u.attr("value",I18n.getMsg("crm.appointments.add.job.sheet")):Lyte.Component.set(p,"label",I18n.getMsg("crm.appointments.add.job.sheet"));else if(v||g)return!1;return!0}},showduplicateAlertMessage:function(e,t){for(var i,r=t.FL.length,s=objectUtils.cloneObject(t),a=0;a<r;a++)if(s.FL[a].sysRefName===e.details.api_name){i=s.FL[a].colname;break}var n=I18n.getMsg("crm.duplicate.value.not.allowed")+" ",o="Appointments";return n+="<a target='_blank' href='"+Crm.getCrmBasePath()+"/EntityInfo.do?module="+o+"&id="+e.details.id+"'>"+I18n.getMsg("crm.invitation.view.details.label")+"</a>",commonUtils.showErrorMsg(n,$("#Crm_"+o+"_"+i),o),!1},refreshApp:function(e,t,i){switch(e){case"relatedlist":case"relatedlist_new":if(Crm.userDetails.isRelatedListLyteEnabled)Lyte.triggerEvent("relatedList",{refresh:!0,module:"Appointments"});else{var r=$("#module").val(),s=$("#entityId").val();if(s){var a={module:r,id:s,fromIndex:1};crmRelatedList.ajaxReq(a,void 0,!1,{action:"refresh"})}"canvas"===Lyte.Router.getRouteInstance().routeName&&"entity"===Lyte.Router.getRouteInstance().parent.routeName&&Lyte.triggerEvent("relatedList",{refresh:!0})}break;case"calendar":"Complete"!==t&&calView.refresh();break;case"homePage":var n=$("#applayoutId").html();n&&$("#datafetchdate_"+n)[0].click();break;default:"krp"!==e&&RefreshDetailsAction("Appointments",!0)}if("Appointment Information"===i){var o=document.getElementsByClassName("quickCreateAppointmentsPopup");o.length>0&&o[0].remove()}this.resetAppointmentValues()},markAsCompleteAppointment:function(e,t,i){var r,s,a=this,n=Lyte.registeredMixins["crm-detailcanvas-utils"],o=n&&n.isFromCanvasActivityEnabledModule("Appointments");if(Crm.renderDVLyteFlow(moduleRecordMapping.Appointments.module_name)||o){r=e,s=t.createSource;var l=store.peekRecord(moduleRecordMapping.Appointments.id,r);Lyte.Component.set(l,"Status","Completed"),l.$.save().then((function(){Lyte.Component.set(t,"markascompletedPopup",!1),"relatedlist"===s||"relatedlist_new"===s?Lyte.triggerEvent("relatedList",{refresh:!0,module:"Appointments"}):Lyte.triggerEvent("detail_view_listener_"+i,{componentsToBeReloaded:["all_components"]}),crmui.showMsgBand("success",I18n.getMsg("crm.appointment.complete.msg.successfully",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Appointments.singular_label)),"4000","")}),(function(e){var r=JSON.parse(e.response).data[0];"the id given seems to be invalid"===r.message?(Lyte.registeredMixins["crm-appointments-mixin"].refreshApp(s),renderingUtils.removeFreezeLayer()):"permission denied"===r.message?renderingUtils.displayPermissionDenied():"Appointment cannot be marked as completed before the appointment ends"===r.message?_cruxUtils.showCustomAlert({params:{ltPropWrapperClass:"crmCenterAlert",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.appointment.endtime.alert",moduleRecordMapping.Appointments.singular_label)}}):"Appointment cannot be marked as completed without associating the jobsheet"===r.message?(Lyte.Component.set(t,"markascompletedPopup",!1),Events.globalCreate(event,s,"JobSheets")):"As per the appointment preferences, appointment cannot be marked as completed"!==r.message&&"Cancelled Appointment cannot be marked as Completed,Scheduled or Overdue"!==r.message||Lyte.triggerEvent("detail_view_listener_"+i,{componentsToBeReloaded:["all_components"]})}))}else{r=void 0!==e?e:"detailView"!==Events.createSource?Events.entityId:detailView.entityId,s=Events.createSource;var m={data:[{}]};m.data[0].Status="Completed";var c={};c.params=JSON.stringify(m);var d="/crm/v2/Appointments__s/"+r;networkUtils.lyteInitiateRequest(d,"PUT",c).then((function(e){"success"==e.data[0].status&&"SUCCESS"==e.data[0].code&&($(".editbtnWtdroparr").remove(),$(".editOptdropdown").remove(),crmui.hidePopup("appointmentCompletePopup"),a.refreshApp(Events.createSource),crmui.showMsgBand("success",I18n.getMsg("crm.appointment.complete.msg.successfully",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Appointments.singular_label)),"4000",""))}),(function(e){"the id given seems to be invalid"===e.responseJSON.data[0].message?(Lyte.registeredMixins["crm-appointments-mixin"].refreshApp(s),renderingUtils.removeFreezeLayer()):"permission denied"===e.responseJSON.data[0].message?renderingUtils.displayPermissionDenied():"Appointment cannot be marked as completed before the appointment ends"===e.responseJSON.data[0].message?_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.appointment.endtime.alert",moduleRecordMapping.Appointments.singular_label)}}):"As per the appointment preferences, appointment cannot be marked as completed"!==e.responseJSON.data[0].message&&"Cancelled Appointment cannot be marked as Completed,Scheduled or Overdue"!==e.responseJSON.data[0].message||Lyte.registeredMixins["crm-appointments-mixin"].refreshApp(s)}))}},setAppointmentStatus:function(e,t,i,r){var s=$(t).text().trim();if(s===I18n.getMsg("crm.appointments.status.markreschedule",moduleRecordMapping.Appointments.singular_label)||s===I18n.getMsg("crm.appointments.status.markcancel",moduleRecordMapping.Appointments.singular_label))s===I18n.getMsg("crm.appointments.status.markreschedule",moduleRecordMapping.Appointments.singular_label)?this.showAppointmentSectionPopup(i,"Reschedule Information","detailView",r):s===I18n.getMsg("crm.appointments.status.markcancel",moduleRecordMapping.Appointments.singular_label)&&this.showAppointmentSectionPopup(i,"Cancellation Information","detailView",r);else if(Events.createSource="detailView",s==I18n.getMsg("crm.appointments.status.markcompleted1")){var a=new Date,n=CrmDateUtils.convertDateTimetoISOFormat($("#subvalue_APPOINTMENTDATEANDTIME").html()),o=$L.moment($L.moment(n).toDate().getTime()+60*detailView.Service_needed_Details.Duration*1e3).toDate();if(a.getTime()<o.getTime())return void _cruxUtils.showCustomAlert({params:{ltPropWrapperClass:"crmCenterAlert",ltPropWrapperClass:"crmCenterAlert",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.appointment.endtime.alert",moduleRecordMapping.Appointments.singular_label)}});$("#appointmentCompletePopupSave").attr("onclick","Lyte.registeredMixins['crm-appointments-mixin'].setAppointmentStatus('"+e+"',this)"),crmui.showPopup({id:"appointmentCompletePopup",escToClose:!1})}else if("appointmentCompletePopupSave"==t.id){var l=detailView.Service_needed_Details.Job_Sheet_Required;l&&"Yes"===l.systemvalue&&this.appointmentPreferences.show_job_sheet?(crmui.hidePopup("appointmentCompletePopup"),this.showAppointmentSectionPopup(detailView.entityId,detailView.Service_needed_Details.Job_Sheet_Section__s.uservalue,"detailView",void 0,"edit")):this.markAsCompleteAppointment(detailView.entityId)}},appointmentCompletePopupSave:async function(e,t,i){var r=store.peekRecord("servapp_preferences","1");(r=r&&r.appointments)||await store.findAll("servapp_preferences",{},!1,!0,{module:"Appointments"}).then((function(e){r=e[0].appointments})),"Yes"===t.serviceDetails.Job_Sheet_Required&&r.show_job_sheet?(Lyte.Component.set(t,"markascompletedPopup",!1),this.showAppointmentSectionPopup(e.id,t.serviceDetails.Job_Sheet_Section__s,t.createSource,void 0,"edit")):Lyte.registeredMixins["crm-appointments-mixin"].markAsCompleteAppointment(e.id,t,i)},markascompletedAppointment:async function(e,t,i,r,s,a){store.registerModel(moduleRecordMapping.Services.id,{},{extends:"entity"}),store.registerModel(moduleRecordMapping.Appointments.id,{},{extends:"entity"});var n=i||store.peekRecord(moduleRecordMapping.Appointments.id,s);void 0!==n&&void 0!==n.Duration&&void 0!==n.Appointment_Start_Time||await store.findRecord(moduleRecordMapping.Appointments.id,s).then((function(e){n=e[0]}));var o=store.peekRecord(moduleRecordMapping.Services.id,n.Service_Name.id);if((void 0===o||o&&"Yes"===o.Job_Sheet_Required&&void 0===o.Job_Sheet_Section__s)&&await store.findRecord(moduleRecordMapping.Services.id,n.Service_Name.id).then((function(e){o=e[0]})),void 0!==o&&void 0!==n){var l="string"==typeof n.Duration?Lyte.registeredMixins["crm-services-mixin"].methods.convertTimeInHrMinsToDouble(n.Duration):n.Duration;if($L.moment().toDate().getTime()<$L.moment(CrmDateUtils.convertDateTimetoISOFormat(n.Appointment_Start_Time,!0)).toDate().getTime()+60*l*1e3)return void _cruxUtils.showCustomAlert({params:{ltPropWrapperClass:"crmCenterAlert",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.appointment.endtime.alert",moduleRecordMapping.Appointments.singular_label)}});$L("crm-appointment-markascompleted").length?Lyte.Component.render("crm-appointment-markascompleted",{markascompletedPopup:!0,moduleName:e,recordDetails:n,createSource:r,serviceDetails:o,unique_listenerId:a},"#show"):Lyte.resolvePromises({filesResolved:Lyte.injectResources(networkUtils.returnDependencyFiles(["crm-detail-view-services.js"],ResourceConstants.CRMClient))}).then((function(){Lyte.Component.render("crm-appointment-markascompleted",{markascompletedPopup:!0,moduleName:e,recordDetails:n,createSource:r,serviceDetails:o,unique_listenerId:a},"#show")}))}},resetAppointmentValues:function(){Events.moduleName="Events",Events.module="Events","create"!==Events.currentStatus&&"edit"!==Events.currentStatus||!CFRExec.tempHold||validationUtils.isEmpty(CFRExec.tempHold.oldResJson)||(CFRExec.init(CFRExec.tempHold.oldResJson,CFRExec.tempHold.formRuleModule,CFRExec.OPERATIONCONSTANT.VIEW),CFRExec.tempHold={}),Events.currentStatus=void 0,$("#saveEventsBtn").removeAttr("disabled"),"relatedlist_new"==Events.createSource&&CFRExec.formRuleModule&&CFRExec.formRuleOldModule&&CFRExec.formRuleModule!=CFRExec.formRuleOldModule&&(CFRExec=objectUtils.cloneObject(crmTemplate.oldCFRObj))},methods:{getRescheduleHistory:function(e){$("crm-appointment-reschedulehistory").remove();var t=detailView.entityId?detailView.entityId:e,i="/crm/v2/Appointments__s/"+t+"/_rescheduled_history";store.findAll("dummy",{},!1,!1,{url:i,method:"GET"}).then((function(e){var i=networkUtils.returnDependencyFiles(["appointment-reschedulehistory.js"],ResourceConstants.CRMClient);i=i.concat(networkUtils.returnDependencyFiles(["appointment-reschedulehistory.css"],ResourceConstants.CRMClient)),Lyte.injectResources(i,void 0,(function(){var i=$("#subvalue_RESCHEDULECOUNT").text()||store.peekRecord(moduleRecordMapping.Appointments.id,t).Reschedule_Count;Lyte.Component.render("crm-appointment-reschedulehistory",{rescheduled_history:e.rescheduled_history,modalShow:!0,resCount:i},"#basic")}))}))}}},{mixins:["crm-services-mixin","crm-services-appointments-mixin","crm-services-appointments-old-mixin"]}),Lyte.Mixin.register("crm-services-mixin",{actions:{membersKeyDown:function(e){return e.preventDefault(),!1},openMembersPopup:function(){this.setData("showMembersPopup",!0)},setCustomDuration:function(){var e=this;document.getElementById("serviceDuration").toggle();var t=$L("#serviceDuration")[0].component.data;if(0===$L("#customDurationPopup").length)Lyte.injectResources(networkUtils.returnDependencyFiles(["crm-services-create-resources.js"],ResourceConstants.CRMClient),void 0,(function(){Lyte.Component.render("crm-customduration-services",{serviceDuration:e.data.serviceDuration,dataBind:e.data.dataBind,apiName:e.data.apiName,durationCompData:t,showPopup:!0},"body")}));else{var i=$L("#customDurationPopup")[0].component.data;Lyte.Component.set(i,{serviceDuration:this.data.serviceDuration,dataBind:this.data.dataBind,apiName:this.data.apiName,durationCompData:t,showPopup:!0})}}},methods:{searchAddressMethod:function(){return!1},checkLocValues:function(){return this.getData("locFldAddrVal").length>0},onUserSelected:function(e){var t=this.getData("moduledataUicomp.api_name"),i=this.getData("dataBind"),r=store.peekRecord("user",e.id),s=$L("#appointmentsMember")[0].component.data;Lyte.Component.set(i,t,{email:r.email,id:r.id,name:r.full_name}),Lyte.Component.set(s,"cxPropSelected",r.id),Lyte.Component.set(s,"cxPropSelectedUser",r),this.checkLayoutrules(this.$node)},constructDropdownUser:function(e,t,i){var r,s;"object"==typeof t?(r=t,s=i):(r=i,s=!0);var a=$L("#Appointments_fldRow_SERVICEID")[0].component.data.membersIdList,n=this.getData("userSearchcriteria"),o=this;return new Promise((function(e,t){if(s){var i=r.criteria;a&&(i="(("+i+"and"+n+")and(id:in:"+a+"))"),(l={}).criteria=i,l.type="ActiveUsers",Crm.userDetails.isLookupFilterEnabled&&o.getData("filterQueryId")&&(l.query_id=o.getData("filterQueryId")),store.triggerAction("user","search",l).then((function(t){e(t)}),(function(){t()}))}else{var l;r.ids=a,(l=r).page=1,Crm.userDetails.isLookupFilterEnabled&&o.getData("filterQueryId")&&(l.query_id=o.getData("filterQueryId")),store.findAll("user",l).then((function(t){e(t)}),(function(){t()}))}}))},setAvailableTime:function(e,t){this.setData("availableTiming",t),t!==I18n.getMsg("crm.service.servicetiming.custom")&&(Lyte.Component.set(this.data.dataBind,this.data.apiName,void 0),Lyte.Component.set(this.data,"multiselectData",void 0))},setMembersValue:function(e){for(var t="",i=[],r=this.data.moduledataUicomp.ui_type,s=(e=445===r?e.users:e).length,a=0;a<s;a++){t+=e[a].Members.name+",",i.push(e[a].Members.id)}t=t.substring(0,t.length-1),this.setData({membersValue:t,membersIdsArray:445===r?{users:e}:e,selectedMembersId:i})},addUsers:function(e){var t="",i=this.data.moduledataUicomp.ui_type,r=[],s=[],a=[],n=this.data.moduledataUicomp.api_name,o=e.map((e=>e.id)),l=$L("#Services_fldRow_MXNDUMMYCOLUMN_SERVICE")[0].component;if(o.length&&"edit"===this.data.initRoute&&l){var m=l.getData("membersIdsArray");(m=445===i?m.users:m)&&(a=m.map((e=>e.Members.id)),m.each((function(e){var t=e.Members.id;if(o.indexOf(t)<0){var i={};i.id=e.id,i._delete=null,i[n]={name:e.Members.name,id:t},Lyte.arrayUtils(s,"push",i)}})))}e.each((function(e){var i=e.id,o=e.full_name;t+=o+",",r.push(i);var l={};if(l[n]={name:o,id:i},a.length>0&&-1!==a.indexOf(i)){var c=m.filter((e=>e.Members.id===i))[0].id;l.id=c}Lyte.arrayUtils(s,"push",l)})),t=t.substring(0,t.length-1),445===i&&(s=s.length?{users:s}:void 0),l&&(Lyte.Component.set(l.data,"membersValue",t),Lyte.Component.set(this.data.dataBind,"Members",s),l.setData({selectedMembersId:r,userIdList:r}))},filterLookupUsers:function(e,t,i){var r=this,s=this.getData("userCriteria"),a=this.getData("userSearchcriteria"),n=t.criteria;return n&&(n="("+n+"and"+a+")"),new Promise((function(e,a){r.data.isSubordinateListing?(t.feature="subordinates",t.related_entity_id=Crm.userDetails.USER_ID,i?(t.search={},t.search.criteria=n):t.filters=s,store.triggerAction("user","get_assigned",t).then((function(t){e(t)}),(function(){a()}))):i?(t.criteria=n,store.triggerAction("user","search",t).then((function(t){e(t)}),(function(){document.querySelector("#serviceUserLookup").component.errorOnSearch()}))):(t.filters=s,store.findAll("user",t).then((function(t){e(t)}),(function(){a()})))}))},closeMembersPopup:function(){this.setData({userIdList:[],showMembersPopup:!1})},setAvailableTimeOptions:function(){return[{display_value:I18n.getMsg("crm.service.servicetiming.business"),actual_value:"Same as business time"},{display_value:I18n.getMsg("crm.service.servicetiming.custom"),actual_value:"Custom time"}]},setDurationOptions:function(e){var t=this.generateServiceDurationFieldPickListOptions();if(e&&void 0!==e.Duration){var i=e.Duration,r=this.convertTimeInHrMinsToDouble?this.convertTimeInHrMinsToDouble(i):this.executeMethod("convertTimeInHrMinsToDouble",i);if(-1===t.map((function(e){return e.actual_value})).indexOf(r.toString())){var s={};s.display_value=I18n.getMsg(i),s.actual_value=I18n.getMsg(r.toString()),t.length>7&&Lyte.arrayUtils(t,"pop"),Lyte.arrayUtils(t,"push",s)}}return t},convertDurationToMin:function(e,t){var i=0;return!isNaN(e)&&e&&e>=0&&(i=60*e),!isNaN(t)&&t&&t>=0&&(i+=t),i},constructServiceDurationTxt:function(e,t){return e&&0!==e?1!==e||t&&0!==t?e>=1&&(!t||0===t)?I18n.getMsg("crm.service.duration.hrs",e):1===e&&t&&t>=0?1===t?I18n.getMsg("crm.service.duration.hour.minute",[e,t]):I18n.getMsg("crm.service.duration.hour.minutes",[e,t]):e>=1&&t&&t>=0?1===t?I18n.getMsg("crm.service.duration.hours.minute",[e,t]):I18n.getMsg("crm.service.duration.hours.minutes",[e,t]):void 0:I18n.getMsg("crm.service.duration.hr",e):1===t?I18n.getMsg("crm.service.duration.minute",t):I18n.getMsg("crm.service.duration.minutes",t)},convertDurationTimeDoubleToUserFormat:function(e){if(!validationUtils.isValidDecimal(e))return e;if(0==(e=parseFloat(e)))return 0;var t=60*e*1e3,i=Utils.getMillisecondsToBasicDateProperties(t,!0);return this.constructServiceDurationTxt(i.hours,i.mins).trim()},convertTimeInHrMinsToDouble:function(e,t){var i=0;if(validationUtils.isValidDecimal(e))return e;var r="",s="";for(var a of e)isNaN(parseInt(a))?isNaN(a)&&(r+=a):(r.length>0&&(-1!=r.indexOf(I18n.getMsg("crm.service.duration.hr","").trim())||-1!=r.indexOf(I18n.getMsg("crm.service.duration.hrs","").trim())?i+=60*parseInt(s):i+=parseInt(s),r="",s=""),s+=a);var n=parseInt(s);switch(n&&(-1!=r.indexOf(I18n.getMsg("crm.service.duration.hr","").trim())||-1!=r.indexOf(I18n.getMsg("crm.service.duration.hrs","").trim())?i+=60*n:i+=n),t){case"minutes":default:return i;case"seconds":return 60*i;case"milliseconds":return 60*i*1e3}}},serviceAvailabilityPopup:function(e,t,i,r){var s=store.findAll("business_hours"),a=store.findAll("holidays"),n={sectionName:e,moduleName:"Services",recordId:t,type:"edit",unique_listener_id:r,headerName:I18n.getMsg("crm.service.mrk.serviceavail",moduleRecordMapping.Services.singular_label),delaySaveFunc:this.validateServiceAvailability,onSave:this.saveServiceAavailability,getRequiredData:i?(e,t,i,r)=>this.getServiceRequiredData(e,t,i,r,!0):this.getServiceRequiredData,wrapperClass:"QCServiceCustField",serverErrorfunc:this.serviceAvailabilityServError,getBusinessHoursAndHolidays:this.setBusinessHoursAndHolidays,lessList:["crm-create-service-resources.css"],onDestroy:this.closeServiceAvailabilityPopup,modalMaxHeight:"535px",cloneOnEdit:!0,apiCalls:{businessHours:s,holidays:a},footerButtons:[{id:"quickCreateCancel",zcqa:"serviceAjaxCancel"},{id:"quickCreateSave",zcqa:"serviceAjaxsubmit"}]};Lyte.registeredMixins["crm-services-appointments-mixin"].showQuickCreatePopupUsingSectionName(n)},validateServiceAvailability:function(e,t){var i=!0,r=t.getRequiredData.apiVSColObj.SERVICEAVAILABILITY,s=e[r],a=t.getRequiredData.apiVSColObj.SERVICESTATUS,n=t.getRequiredData.displayValues;if(t.getRequiredData.isFromNavBar){switch(s){case n.EveryBusinessDay:case n.SpecificDay:i=!1;break;case n.DateRange:var o=t.getRequiredData.apiVSColObj.STARTING_DATE,l=t.getRequiredData.apiVSColObj.CLOSING_DATE,m=e[o],c=e[l];if(m&&c){var d=CrmDateUtils.convertdateToDBformat(m,!0),p=CrmDateUtils.convertdateToDBformat(c,!0),u=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE),v=$L.moment().toDate().getTime()+u;($L.moment(d).toDate().getTime()-(v-v%864e5)>=0||$L.moment(p).toDate().getTime()-(v-v%864e5)>=0)&&(i=!1)}break;case n.SpecificDate:for(var g=t.getRequiredData.apiVSColObj.AVAILABLE_DATES,h=e[g],A=(u=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE),v=$L.moment().toDate().getTime()+u,h.length),f=0;f<A;f++){var C=h[f];$L.moment(C).toDate().getTime()-(v-v%864e5)>=0&&(i=!1)}}t.getRequiredData.isFromNavBar&&!i&&(t.getRequiredData.isallPastDates=!0)}var D=t.getRequiredData.apiVSColObj.AVAILABLE_DATES;h=e[D];return h&&(h=h.filter((function(e){if(""!==e&&$L.moment(e,"YYYY-MM-DD".toUpperCase(),!0).validate())return e})),e.$.set(D,h)),new Promise((function(t){t(e)})).then((function(e){t.getRequiredData.isFromNavBar&&!i&&e.$.set(a,"Available")}))},saveServiceAavailability:function(e,t,i){var r;r=i.getRequiredData.isallPastDates?"crm.service.active.msg.successfully":"crm.service.availability.msg.succesfully",_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg(r,moduleRecordMapping.Services.singular_label),ltPropType:"success"}}),Lyte.Router.getRouteInstance().refresh()},getServiceRequiredData:function(e,t,i,r,s){var a=Lyte.registeredMixins["crm-services-mixin"],n={};n.apiVSColObj=Lyte.registeredMixins["crm-services-appointments-mixin"].getApiVsColname(e,t),n.isallPastDates=!1;var o=e.filter((e=>"Availability Information"===e.name))[0].fields.filter((e=>"SERVICEAVAILABILITY"===e.column_name))[0].pick_list_values;return n.displayValues={EveryBusinessDay:a.getDisplayValue(o,"Every Business Days"),DateRange:a.getDisplayValue(o,"Specific Date Range"),SpecificDate:a.getDisplayValue(o,"Specific Date(s)"),SpecificDay:a.getDisplayValue(o,"Specific Day(s)")},s&&(n.isFromNavBar=!0),n},serviceAvailabilityServError:function(e){var t=JSON.parse(e.response);t.code&&"NO_PERMISSION"===t.code||t.data&&"no permission to perform an action on this record"===t.data[0].message?renderingUtils.displayPermissionDenied():t.data&&"The given service available days are not there in business days"===t.data[0].message?_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.service.days.bus.hours",moduleRecordMapping.Services.singular_label),ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}}):t.data&&"Service available time does not satisfy the business timing"===t.data[0].message?this.serviceAvailabilityError(void 0,"AVAILABLE_CUSTOM_TIMING",{0:I18n.getMsg("crm.service.servicetiming.bushours")},!0):t.data&&"Available Dates value in holiday or Not in BusinessDays"===t.data[0].message?this.serviceAvailabilityError(void 0,"AVAILABLE_DATES",[I18n.getMsg("crm.service.availdate.busalert")],!0):"LIMIT_EXCEEDED"===t.data[0].code&&_cruxUtils.showCustomAlert({params:{ltPropYield:!1,ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropPrimaryMessage:I18n.getMsg("crm.error.active.services.limit",moduleRecordMapping.Appointments.singular_label),ltPropShowCloseButton:!1,ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}})},serviceAvailabilityError:function(e,t,i,r,s){var a;if(s)for(var n=e.length,o=0;o<n;o++)if(t===e[o].column_name){a=e[o].field_label;break}var l,m,c=$L("#Services_fldRow_"+t)[0].component.data;r?(l="multiselectErrorDetails",m=i):(l="errorDetails",m={isError:!0,message:I18n.getMsg(i,a)}),Lyte.Component.set(c,l,m)},setBusinessHoursAndHolidays:function(){Crm.businessJSON=store.peekAll("business_hours")[0],Crm.holidays=store.peekAll("holidays")[0]},validateRecordServiceAvailability:function(e,t,i,r){if(!r||"Availability Information"===i){var s=!1,a=this.populateDataForServiceTimingValidation(t,e),n=a.apiVSColObj,o=a.availabilityType,l=n.AVAILABLE_CUSTOM_TIMING,m=a.displayValues;switch(o){case m.dateRange:var c=n.STARTING_DATE,d=n.CLOSING_DATE,p=e[c],u=e[d];if(p&&u){if(!$L.moment(p,Crm.userDetails.DATE_PATTERN.toUpperCase(),!0).validate()&&!$L.moment(u,Crm.userDetails.DATE_PATTERN.toUpperCase(),!0).validate())return;var v=CrmDateUtils.convertdateToDBformat(p,!0),g=CrmDateUtils.convertdateToDBformat(u,!0);if(g&&$L.moment(g).toDate()-$L.moment(v).toDate()<864e5){if($L.moment(v).toDate().getTime()===$L.moment(g).toDate().getTime()){this.serviceAvailabilityError(t,"CLOSING_DATE","crm.service.availfromto.samevaluealert"),s=!0;break}this.serviceAvailabilityError(t,"CLOSING_DATE","crm.service.availfromto.fromtoalert"),s=!0;break}}break;case m.specificDay:var h=n.AVAILABLE_DAYS,A=e[h]?JSON.parse(e[h]):void 0;if(!A||0===A.length){this.serviceAvailabilityError(t,"AVAILABLE_DAYS","crm.field.empty.check",!1,!0),s=!0;break}if(this.checkServiceAvailableDays(A)){this.serviceAvailabilityError(t,"AVAILABLE_DAYS","crm.service.availdate.busalert"),s=!0;break}break;case m.specificDate:var f=n.AVAILABLE_DATES,C=e.$.error[f]?e.$.error[f].value:e[f],D=e.$.error[f]&&e.$.error[f].errorDetails?e.$.error[f].errorDetails:{};if(C)for(var _=C.length,y=0;y<_;y++){var M=C[y];if(M){if(this.checkHolidays(M)){D[y]=I18n.getMsg("crm.service.availdate.holidayalert");continue}if(this.checkBusinessDays(M)){D[y]=I18n.getMsg("crm.service.availdate.busalert");continue}}}if(D&&Object.keys(D).length>0){(b=e.$.error)[f]?b[f].errorDetails=D:(e.$.isError=!0,b[f]={code:"MULTISELECTERROR",errorDetails:D,value:e[f]}),s=!0;break}case m.everyBusinessDay:}if(e.Duration&&"None"!==e.Duration){var T=this.getDurationAndServiceTimingDependencyDetails(t,e,e.Duration,a);if(T.errorArr)(b=e.$.error)[l]?b[l].errorDetails=T.errorArr:(e.$.isError=!0,b[l]={code:"MULTISELECTERROR",errorDetails:T.errorArr,value:e[l]}),s=!0;else T.dataTimeObj?e.$.set(l,T.dataTimeObj):T.isCustomBusinessTiming&&T.isdurationNotAvailable&&(this.serviceAvailabilityError(t,"AVAILABLE_CUSTOM_TIMING",I18n.getMsg("crm.service.avail.less.dur",moduleRecordMapping.Services.singular_label),!1,!1),s=!0)}else{var b=e.$.error;e.$.isError=!0,b[n.SERVICEDURATION]={code:"ERR02",message:Lyte.errorCodes.ERR02,value:void 0}}if(void 0!==e[n.BASEPRICE]&&e[n.BASEPRICE]<0){s=!0;b=e.$.error;e.$.isError=!0,b[n.BASEPRICE]={code:"PRICEERROR",message:I18n.getMsg("crm.service.price.field.greater.than.equalto"),value:void 0}}return!s}return!0},getDurationAndServiceTimingDependencyDetailsForDurationEdit:function(e,t,i){var r=this.populateDataForServiceTimingValidation(e,t);return this.getDurationAndServiceTimingDependencyDetails(e,t,i,r)},getDurationAndServiceTimingDependencyDetails:function(e,t,i,r){var s={};return i=this.methods.convertTimeInHrMinsToDouble(i,"milliseconds"),"businessJSON"in Crm||(Crm.businessJSON=store.peekAll("business_hours")[0]),void 0!==r.availabilityTiming&&r.availabilityTiming.length>0?s=this.getServiceTiming(i,r.availabilityType,{apiVSColObj:r.apiVSColObj,displayValues:r.displayValues},t):"custom"===Crm.businessJSON.type&&(s.isdurationNotAvailable=this.checkServiceTimingandDurationWithBusinessHour(i,r.availabilityType,{apiVSColObj:r.apiVSColObj,displayValues:r.displayValues},t),s.isCustomBusinessTiming=!0),s},populateDataForServiceTimingValidation:function(e,t){var i=this.generateApiVSColObj(e),r=i.SERVICEAVAILABILITY,s=i.AVAILABLE_CUSTOM_TIMING,a=e.filter((e=>"SERVICEAVAILABILITY"===e.column_name))[0].pick_list_values,n=this.getDisplayValue(a,"Specific Date Range"),o=this.getDisplayValue(a,"Specific Date(s)"),l=this.getDisplayValue(a,"Specific Day(s)"),m=this.getDisplayValue(a,"Every Business Days"),c={};return c.apiVSColObj=i,c.availabilityType=t[r],c.availabilityTiming=t.$&&t.$.error[s]?t.$.error[s].value:t[s],c.displayValues={dateRange:n,specificDate:o,specificDay:l,everyBusinessDay:m},c},generateApiVSColObj:function(e){for(var t=e.length,i={},r=0;r<t;r++){var s=e[r].api_name;i[e[r].column_name]=s}return i},getServiceTiming:function(e,t,i,r){var s=i.apiVSColObj.AVAILABLE_CUSTOM_TIMING,a=r.$&&r.$.error[s]?r.$.error[s].value:r[s],n=a.length,o=r.$&&r.$.error[s]?r.$.error[s].errorDetails:{},l=!1,m=!1;Object.keys(o).length&&(m=!0);var c,d,p,u,v=i.displayValues.specificDate,g=i.displayValues.specificDay,h=i.displayValues.dateRange;if("custom"===Crm.businessJSON.type){if(!0===Crm.businessJSON.same_as_everyday)c=Crm.businessJSON.details[0],d=Crm.businessJSON.details[1];else if(!1===Crm.businessJSON.same_as_everyday)if(t===g){var A=i.apiVSColObj.AVAILABLE_DAYS,f=JSON.parse(r[A]);f.length>0&&(c=this.getDayMinTime(f),(d=this.getDayMaxTime(f))&&c&&(CrmDateUtils.compareTime(c,d)||(p=I18n.getMsg("crm.service.custom.alert.commonbus"))))}else if(t===v){var C=i.apiVSColObj.AVAILABLE_DATES,D=r.$&&r.$.error[C]?r.$.error[C].value:r[C];D&&D.length>0&&(c=this.getDatesMinTime(D),(d=this.getDatesMaxTime(D))&&c&&(CrmDateUtils.compareTime(c,d)||(p=I18n.getMsg("crm.service.custom.alert.commonbus"))))}else if(t===h){var _=i.apiVSColObj.STARTING_DATE,y=i.apiVSColObj.CLOSING_DATE;if(r[_]&&r[y]){var M=CrmDateUtils.convertdateToDBformat(r[_],!0),T=CrmDateUtils.convertdateToDBformat(r[y],!0);if(M&&T){var b=this.getDateRangeMinMaxTime($L.moment(M+"T00:00:00").toDate(),$L.moment(T+"T00:00:00").toDate());c=b[0],d=b[1],CrmDateUtils.compareTime(c,d)||(p=I18n.getMsg("crm.service.custom.alert.commonbus"))}}}else c=this.getMinValueFrom(Crm.businessJSON.details),d=this.getMaxValueTo(Crm.businessJSON.details),CrmDateUtils.compareTime(c,d)||(p=I18n.getMsg("crm.service.custom.alert.commonbus"));for(var S=0;S<n;S++)if(p){if(!o[S]){o[S]=p;continue}}else{var I=a[S].From,E=a[S].To;if(I&&E&&c&&d&&!(CrmDateUtils.compareTime(c,Utils.convertTimeValueTo24HourFormat(I),!0)&&CrmDateUtils.compareTime(Utils.convertTimeValueTo24HourFormat(E),d,!0)||o[S])){o[S]=I18n.getMsg("crm.service.servicetiming.bushours");continue}}}var L=(u=m?a:this.mergeTimeInterval(JSON.parse(JSON.stringify(a)))).length;u.length!==n&&(l=!0);for(S=0;S<L;S++){E=u[S].To;if((I=u[S].From)&&E)if(e-(CrmDateUtils.timeTomilliseconds(E)-CrmDateUtils.timeTomilliseconds(I))>0){if(l){for(var R,N,P=a.length,O=0;O<P;O++){var w=a[O];R||w.From!==I||(R=O),N||w.To!==E||(N=O)}l=!1;for(O=R;O<=N;O++)o[O]||(o[O]=I18n.getMsg("crm.service.avail.less.dur",moduleRecordMapping.Services.singular_label));continue}if(!o[S]){o[S]=I18n.getMsg("crm.service.avail.less.dur",moduleRecordMapping.Services.singular_label);continue}}}l&&(a=u,u.length!==n&&(n=u.length));var $={};return o&&Object.keys(o).length>0?($.errorArr=o,$.isValid=!1):l?($.dataTimeObj=u,$.isValid=!0):$.isValid=!0,$},mergeTimeInterval:function(e){for(var t=1,i=[e[0]],r=e[0].To,s=e.length;t+1<=s;)r===e[t].From?i[i.length-1].To=e[t].To:i.push(e[t]),r=e[t].To,t++;return i},isValidTime:function(e,t){if(t){var[i,r]=e.split(":");return!(!i||isNaN(Number(i))&&Number(i)>24)&&!(!r||isNaN(Number(r)&&Number(r))>60)}var[s,a]=e.split(" "),[i,r]=s.split(":");return!(!i||isNaN(Number(i))&&Number(i)>24)&&(!(!r||isNaN(Number(r)&&Number(r))>60)&&!(!a||a.toUpperCase()!==I18n.getMsg("AM")&&a.toUpperCase()!==I18n.getMsg("PM")))},getDisplayValue:function(e,t){for(var i=e.length,r=0;r<i;r++){var s=e[r];if(s.actual_value===t)return s.display_value}return null},checkServiceTimingandDurationWithBusinessHour:function(e,t,i,r){var s=!1,a=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=i.displayValues.specificDate,o=i.displayValues.specificDay,l=i.displayValues.dateRange,m=i.displayValues.everyBusinessDay;if(!1===Crm.businessJSON.same_as_everyday)if(n===t){var c=i.apiVSColObj.AVAILABLE_DATES,d=r.$&&r.$.error[c]?r.$.error[c].value:r[c],p=[];if(d&&d.length){for(var u=d.length,v=0;v<u;v++)p.push(a[$L.moment(d[v]+"T00:00:00").toDate().getDay()]);p&&(s=this.checkServiceDurationAvailable(e,p))}}else if(o===t){var g=i.apiVSColObj.AVAILABLE_DAYS,h=JSON.parse(r[g]);h.length>0&&(s=this.checkServiceDurationAvailable(e,h))}else m!==t&&l!==t||(s=this.checkServiceDurationAvailable(e,Crm.businessJSON.business_days));else!0===Crm.businessJSON.same_as_everyday&&e>CrmDateUtils.timeTomilliseconds(Crm.businessJSON.details[1])-CrmDateUtils.timeTomilliseconds(Crm.businessJSON.details[0])&&(s=!0);return s},checkDuplicateDate:function(e,t){if(e&&e.length>0&&""!==e[0]&&-1!==e.indexOf(t))return!1;return!0},renderServiceAvailabilityPopup:function(e,t,i){var r=this;0===$L("crm-services-availability-status").length?Lyte.injectResources(networkUtils.returnDependencyFiles(["crm-services-availability-information.js","crm-services-members.js","crm-services-availability-status.js"],ResourceConstants.CRMClient),void 0,(function(){Lyte.Component.render("crm-services-availability-status",{entityId:e,datePattern:Crm.userDetails.DATE_PATTERN.toUpperCase(),unique_listener_id:i},"#show"),r.showServiceAvailabilityPopup(t)})):this.showServiceAvailabilityPopup(t)},showServiceAvailabilityPopup:function(e){var t=document.querySelector("crm-services-availability-status");switch(e){case"mark_as_temporarily_unavail":case"manage_unavailability":t.component.setData({unavailableValue:"Rest of the day",showPopup:!0,showDate:!1});break;case"mark_as_notinuse":t.setData("serviceStatus","Not in Use"),t.component.executeMethod("getCountndConfirm");break;default:return}},submitServiceStatusMark:function(e,t,i,r){commonUtils.showHideLoadingDiv(!0);var s=store.peekRecord(moduleRecordMapping.Services.id,e);if(Lyte.Component.set(s,"Status",t),"Temporarily Unavailable"===s.Status){var a=Crm.userDetails.TIME_FORMAT.split(" ").length>1?"TV11:59:59 PM":"TV23:59:59",n=Utils.convertDateToUserPattern($L.moment(i).toDate(),void 0,!0)+a;Lyte.Component.set(s,"Unavailable_Till",n)}if(0!==s.$.getDirtyAttributes().length){s.$.save(void 0,{affected_data:"true",affected_data_new:!0}).then((function(e){var t=store.peekRecord(moduleRecordMapping.Services.id,e[moduleRecordMapping.Services.id].id),i=document.querySelector("crm-services-availability-status");switch("canvas"===Lyte.Router.getRouteInstance().routeName&&Lyte.Router.getRouteInstance().refresh(),t.Status){case"Available":i&&Lyte.Component.set(i.component.data,"showPopup",!1),_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropMessage:I18n.getMsg("crm.service.active.msg.successfully",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Services.singular_label)),ltPropDuration:"4000",ltPropShow:!0}});break;case"Temporarily Unavailable":i&&i.component.setData({showPopup:!1,showAlertConfirmPopup:!1});var s=$L.moment(t.Unavailable_Till.split("TV")[0],Crm.userDetails.DATE_PATTERN.toUpperCase()).i18N("MM DD YYYY");_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropMessage:I18n.getMsg("crm.service.inactive.msg.successfully",[$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Services.singular_label),Lyte.registeredMixins["crm-services-appointments-mixin"].getDatewithsuffix(s)]),ltPropDuration:"4000",ltPropShow:!0}});break;case"Not in Use":i&&Lyte.Component.set(i.component.data,"showAlertConfirmPopup",!1),_cruxUtils.showCustomMessage({params:{ltPropType:"success",ltPropMessage:I18n.getMsg("crm.service.discontinue.msg.successfully",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Services.singular_label)),ltPropDuration:"4000",ltPropShow:!0}})}var a=$L("crm-detail-view")[0];if(a){var n=a.component.data;Lyte.Component.set(n,"record",objectUtils.cloneObject(t))}Lyte.triggerEvent("detail_view_listener_"+r,{componentsToBeReloaded:["record_actions"]}),commonUtils.showHideLoadingDiv(!1)}),(function(e){var t=JSON.parse(e.response);("NOT_ALLOWED"===t.data[0].code&&"As service availability is not valid, status cannot be changed"===t.data[0].message||"Service available time does not satisfy the business timing"===t.data[0].message)&&"Available"===s.Status?Lyte.injectResources(networkUtils.returnDependencyFiles(["business_hours-model.js","holidays-model.js","crm-services-appointments.js"],ResourceConstants.CRMClient).concat(networkUtils.returnDependencyFiles(["zohocrm_services.js",networkUtils.getI18nJSUrl("businesshours"),networkUtils.getI18nJSUrl("serviceentitykeys")],ResourceConstants.CRM)),void 0,(function(){Lyte.registeredMixins["crm-services-mixin"].serviceAvailabilityPopup("Availability Information",s.id,!0,r)})):"NO_PERMISSION"===t.data[0].code?renderingUtils.displayPermissionDenied():"LIMIT_EXCEEDED"===t.data[0].code&&_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.error.active.services.limit",moduleRecordMapping.Appointments.singular_label)}}),commonUtils.showHideLoadingDiv(!1)}))}},generateServiceDurationFieldPickListOptions:function(){return[{display_value:I18n.getMsg("crm.label.none"),actual_value:"none"},{display_value:I18n.getMsg("crm.service.duration.minutes",30),actual_value:"30"},{display_value:I18n.getMsg("crm.service.duration.hr",1),actual_value:"60"},{display_value:I18n.getMsg("crm.service.duration.hour.minutes",[1,30]),actual_value:"90"},{display_value:I18n.getMsg("crm.service.duration.hrs",2),actual_value:"120"},{display_value:I18n.getMsg("crm.service.duration.hours.minutes",[2,30]),actual_value:"150"},{display_value:I18n.getMsg("crm.service.duration.hrs",3),actual_value:"180"}]},getApiNameForField:function(e,t){var i=store.peekRecord("module",moduleRecordMapping[e].id).fields;if(i)return i.filter((e=>e.column_name===t))[0].api_name;store.findRecord("module",moduleRecordMapping[e].id).then((function(e){return e[0].fields.filter((e=>e.column_name===t))[0].api_name}))},getServicesMinMaxDate:function(e){var t={};switch(e[this.getApiNameForField("Services","SERVICEAVAILABILITY")]){case"Specific Date(s)":var i=e[this.getApiNameForField("Services","AVAILABLE_DATES")];i.sort(),t.servicesMinDate=i[0],t.servicesMaxDate=i[i.length-1];break;case"Specific Date Range":t.servicesMinDate=e[this.getApiNameForField("Services","STARTING_DATE")],t.servicesMaxDate=e[this.getApiNameForField("Services","CLOSING_DATE")]}return t},editedDataBindMembers:function(e,t){var i=e.data.dataBind.Members;return(i=(i=445===t.filter((e=>"MXNDUMMYCOLUMN_SERVICE"===e.column_name))[0].ui_type?i.users:i).filter((e=>!e.id||null===e._delete))).length?i:null},getRelationIdofMembersField:function(){for(var e=store.peekRecord("module",moduleRecordMapping.Services.id).fields,t=e.length,i=0;i<t;i++){var r=e[i];if("MXNDUMMYCOLUMN_SERVICE"===r.column_name)return r.multiselectlookup.id}},checkServiceDurationAvailable:function(e,t){for(var i=t.length,r=Crm.businessJSON.details,s=r.length,a=0;a<i;a++)for(var n=0;n<s;n++)if(r[n].days==t[a]&&e>CrmDateUtils.timeTomilliseconds(r[n].business_timing[1])-CrmDateUtils.timeTomilliseconds(r[n].business_timing[0]))return!0;return!1},getDateRangeMinMaxTime:function(e,t){var i=[],r=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s=[],a=(t.getTime()-e.getTime())/864e5;if(a>=7)i[0]=this.getMinValueFrom(Crm.businessJSON.details),i[1]=this.getMaxValueTo(Crm.businessJSON.details);else if(a>=1){for(var n=0;n<a;n++)s.push(r[(e.getDay()+n)%7]);i[0]=this.getDayMinTime(s),i[1]=this.getDayMaxTime(s)}return i},getDayMinTime:function(e){var t=null,i=!1,r=[],s=e.length,a=Crm.businessJSON.details,n=a.length;if(s>0)for(var o=0;o<s;o++)for(var l=0;l<n;l++)e[o]==a[l].days&&(r.push(a[l].business_timing[0]),i=!0);else t=a[0].business_timing?a[0].business_timing[0]:a[0];if(i){s=r.length;t=r[0];for(o=1;o<s;o++)CrmDateUtils.compareTime(t,r[o],!0)&&(t=r[o])}return t},getDayMaxTime:function(e){var t=null,i=!1,r=[],s=e.length,a=Crm.businessJSON.details,n=a.length;if(s>0&&n>=2)for(var o=0;o<s;o++)for(var l=0;l<n;l++)e[o]==a[l].days&&(r.push(a[l].business_timing[1]),i=!0);else t=a[0].business_timing?a[0].business_timing[1]:a[1];if(i){s=r.length;t=r[0];for(o=1;o<s;o++)CrmDateUtils.compareTime(t,r[o],!0)||(t=r[o])}return t},getDatesMinTime:function(e){"string"==typeof e&&(e=JSON.parse(e));var t=null,i=!1,r=[],s=e.length,a=Crm.businessJSON.details,n=a.length;if(n>=2&&a[0].business_timing)for(var o=0;o<s;o++)for(var l=0;l<n;l++){new Date(e[o]+"T00:00:00").getDay()==CrmDateUtils.getDayNumber(a[l].days)&&(r.push(a[l].business_timing[0]),i=!0)}else t=a[0].business_timing?a[0].business_timing[0]:a[0];if(i){s=r.length;t=r[0];for(o=1;o<s;o++)CrmDateUtils.compareTime(t,r[o],!0)&&(t=r[o])}return t},getDatesMaxTime:function(e){"string"==typeof e&&(e=JSON.parse(e));var t=null,i=e.length,r=!1,s=[],a=Crm.businessJSON.details,n=a.length;if(n>=2&&a[0].business_timing)for(var o=0;o<i;o++)for(var l=0;l<n;l++){new Date(e[o]+"T00:00:00").getDay()==CrmDateUtils.getDayNumber(a[l].days)&&(s.push(a[l].business_timing[1]),r=!0)}else t=a[0].business_timing?a[0].business_timing[1]:a[1];if(r){i=s.length;t=s[0];for(o=1;o<i;o++)CrmDateUtils.compareTime(t,s[o],!0)||(t=s[o])}return t},getMinValueFrom:function(e){for(var t=e.length,i=e[0].business_timing[0],r=1;r<t;r++)CrmDateUtils.compareTime(i,e[r].business_timing[0])&&(i=e[r].business_timing[0]);return i},getMaxValueTo:function(e){for(var t=e.length,i=e[0].business_timing[1],r=1;r<t;r++)CrmDateUtils.compareTime(i,e[r].business_timing[1])||(i=e[r].business_timing[1]);return i},checkServiceAvailableDays:function(e){if(Crm.businessJSON.business_days&&e)for(var t=e.length,i=0;i<t;i++)if(!Crm.businessJSON.business_days.contains(e[i]))return!0},checkBusinessDays:function(e){var t=[],i=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];if("businessJSON"in Crm||(Crm.businessJSON=store.peekAll("business_hours")),Crm.businessJSON.business_days){var r=Crm.businessJSON.business_days.length;if(r>0&&r<7){for(var s=$L.moment(e+"T00:00:00").toDate().getDay(),a=0;a<7;a++)-1===Crm.businessJSON.business_days.indexOf(i[a])&&t.push(i[a]);var n=t.length;for(a=0;a<n;a++){if(s===CrmDateUtils.getDayNumber(t[a]))return!0}}}},checkHolidays:function(e){"holidays"in Crm||(Crm.holidays=store.peekAll("holidays"));var t=Crm.holidays.length;if(t>0&&void 0===Crm.holidays[0].shift)for(var i=0;i<t;i++)for(var r=Crm.holidays[i].details.length,s=0;s<r;s++)if($L.moment(Crm.holidays[i].details[s].date).toDate().getTime()===$L.moment(e).toDate().getTime())return!0;return!1},manageServiceDuration:function(e){e=$(e);var t=$("#serviceDurationDiv"),i=e.attr("data-value"),r=e.text();if("custom"===i){$("crm-customtime-services").remove();var s=networkUtils.returnDependencyFiles(["customtime-services.js"],ResourceConstants.CRMClient);s=s.concat(networkUtils.returnDependencyFiles(["customtime-services.css"],ResourceConstants.CRMClient)),Lyte.injectResources(s,void 0,(function(){Lyte.Component.render("crm-customtime-services",{},"#basic");var e=document.getElementById("customTimepopup");e.ltProp("offset",{top:"0px",left:"center"}),e.ltProp("show",!0);var t=$("#serviceDurationsUL").find(".selectedOpt");if(void 0!==t.attr("data-value")&&"NaN"!==parseInt(t.attr("data-value")).toString()){var i=parseInt(t.attr("data-value"));$("#durationInHours").val(parseInt(i/60)),$("#durationInMinutes").val(i%60)}}))}else t.text(r),t.next("input").attr({"data-value":i}).val(i);$("body").css({overflow:"auto"})},showServiceMembersPopup:function(){var e=document.getElementById("ServiceMultiUserComponent");void 0!==e&&$(e).length>0&&e.cxProp("show",!0)},showServiceAvailabilityPopupMenu:function(e,t){var i=this;if(0===$L("#crm-services-markunavailable").length){var r=networkUtils.returnDependencyFiles(["services-markunavailable.js"],ResourceConstants.CRMClient);Lyte.injectResources(r,void 0,(function(){Lyte.Component.render("crm-services-markunavailable",{entityId:e,datePattern:Crm.userDetails.DATE_PATTERN.toUpperCase()},"#serviceMark"),"mark_as_notinuse"===t?i.showNotInUseAlert():$("#crm-services-markunavailable")[0].ltProp("show",!0)}))}else"mark_as_notinuse"===t?this.showNotInUseAlert():$("#crm-services-markunavailable")[0].ltProp("show",!0)},showNotInUseAlert:function(){var e=document.querySelector("crm-services-markunavailable").component;e.setData("serviceStatus","Not in Use"),e.executeMethod("getCountndConfirm")},oldSubmitServiceStatusMark:function(e,t,i){var r={data:[]};r.data[0]={},r.data[0].Status=t,"Temporarily Unavailable"===r.data[0].Status&&(r.data[0].Unavailable_Till=i);var s="/crm/v2/Services__s/"+e,a={};a.params=JSON.stringify(r),detailView.service_status=t;var n=$("#serviceAvailPopButton");networkUtils.lyteInitiateRequest(s,"PUT",a).then((function(e){var t=$("#unAvailableSpan.unAvailable");if("SUCCESS"==e.data[0].code)switch(detailView.service_status){case"Available":n.hide(),$("#serviceAvailPoplink").text(I18n.getMsg("crm.service.mrk.as.unavail")),t.hide(),crmui.showMsgBand("success",I18n.getMsg("crm.service.active.msg.successfully",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Services.singular_label)),"4000",""),Lyte.Router.getRouteInstance().refresh();break;case"Temporarily Unavailable":document.getElementById("crm-services-markunavailable").ltProp("show",!1),document.getElementById("popupalertConfirm").ltProp("show",!1),crmui.showMsgBand("success",I18n.getMsg("crm.service.inactive.msg.successfully",[$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Services.singular_label),Lyte.registeredMixins["crm-services-appointments-mixin"].getDatewithsuffix(detailView.UnavailDate)]),"4000",""),Lyte.Router.getRouteInstance().refresh();break;case"Not in Use":document.getElementById("popupalertConfirm").ltProp("show",!1),crmui.showMsgBand("success",I18n.getMsg("crm.service.discontinue.msg.successfully",$ESAPI.encoder().encodeForHTML(moduleRecordMapping.Services.singular_label)),"4000",""),Lyte.Router.getRouteInstance().refresh()}}),(function(e){("NOT_ALLOWED"===e.responseJSON.data[0].code&&"As service availability is not valid, status cannot be changed"===e.responseJSON.data[0].message||"Service available time does not satisfy the business timing"===e.responseJSON.data[0].message)&&"Available"===detailView.service_status?(Lyte.registeredMixins["crm-services-mixin"].serviceAvailabilityPopup("Availability Information",detailView.entityId,!0),n.addClass("triggerAvailable")):"NO_PERMISSION"==e.responseJSON.data[0].code?renderingUtils.displayPermissionDenied():"LIMIT_EXCEEDED"==e.responseJSON.data[0].code?_cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.error.active.services.limit"),ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}}):Lyte.Router.getRouteInstance().refresh()}))},chooseServiceTimeOption:function(e){$(e).val()==I18n.getMsg("crm.service.servicetiming.custom")?(this.createtimeslotRow(0),renderingUtils.labelWidthFixed("list","secContent_Availability_Information")):($("#Timing").remove(),$("div[id=CustomTimingClear]").remove());var t=$("#Crm_Services_AVAILABLE_CUSTOM_TIMING").attr("custom_time");if(""!=t&&$(e).val()==I18n.getMsg("crm.service.servicetiming.custom")){var i=JSON.parse(t),r=i.length;r>0&&i!=I18n.getMsg("crm.service.servicetiming.business")&&(""!=i[0].From&&""!=i[0].To&&($(".customTimeContainer").find(".ico_plus-lg").removeClass("disable"),$("#timechange1_0").val("HH:mm"==Crm.userDetails.TIME_FORMAT?i[0].From:CrmDateUtils.convertTimeTo12HourFormat(i[0].From)),$("#timechange2_0").val("HH:mm"==Crm.userDetails.TIME_FORMAT?i[0].To:CrmDateUtils.convertTimeTo12HourFormat(i[0].To))),r>1&&(e=document.getElementById("addRow_0"),this.createtimeslotRow(1,e),$("#timechange1_1").val("HH:mm"==Crm.userDetails.TIME_FORMAT?i[1].From:CrmDateUtils.convertTimeTo12HourFormat(i[1].From)),$("#timechange2_1").val("HH:mm"==Crm.userDetails.TIME_FORMAT?i[1].To:CrmDateUtils.convertTimeTo12HourFormat(i[1].To))))}renderingUtils.labelWidthFixed("list","serviceAjaxEdit")},createtimeslotRow:function(e,t){var i,r=1;if($("#timechange1_"+e).size()>0&&e>0&&(r=0),0==e){var s=document.createElement("div");s.setAttribute("id","CustomTiming"+e),s.setAttribute("class","CUSTOMTIMING tabDivCreate");var a=document.getElementById("Services_fldRow_AVAILABLE_CUSTOM_TIMING");$(a).after(s),(i=document.createElement("div")).setAttribute("id","Timing"),i.setAttribute("class","labelTabCreate pL5 pR columnCal1 newmandatory");var n=document.createTextNode(I18n.getMsg("crm.service.servicetiming.choosecustom"));i.appendChild(n),s.append(i),$(i).after(o),r=0}var o=document.createElement("div");o.setAttribute("id","CustomTimingClear"),o.setAttribute("class","labelValCreate mL45 noBlockEle");var l,m='<input type="text" class="cus_time-From textField fL" id="timechange1_'+r+'" placeholder="HH:MM" data-fieldtype="timeField" onchange="Lyte.registeredMixins["crm-services-mixin"].showADD_CTime(this)" />',c='<input type="text" class="cus_time-To textField fL" id="timechange2_'+r+'" placeholder="HH:MM" data-fieldtype="timeField" onchange="Lyte.registeredMixins["crm-services-mixin"].showADD_CTime(this)" />';if($(t).closest(".customTimeContainer").length<1?$("#CustomTimingClear").append('<div class="fL w50_per crmNotFoundColor mB10">'+I18n.getMsg("crm.label.from")+'</div><div class="fL w50_per crmNotFoundColor mB10">'+I18n.getMsg("crm.label.to")+'</div><div class="cBoth"></div><div class="pT4 customTimeContainer mB10 clearFix"><div class="customTimeRow fL">'+m+" "+c+'</div> <a href="javascript:void(0)" id="addRow_'+e+'" class="svgIcons dIB ico_plus-lg mL10 vaM mT8 disable" onclick="Lyte.registeredMixins["crm-services-mixin"].addtimeslotRow(this)";></a></div>'):$("#CustomTimingClear").append('<div class="pT4 customTimeContainer mB10 clearFix" id="timeField'+e+'"><div class="customTimeRow fL">'+m+" "+c+'</div> <a href="javascript:void(0)" id="removeRow'+e+'" class="svgIcons dIB ico_minus-lg mL10 vaM mT8" onclick="Lyte.registeredMixins["crm-services-mixin"].removetimeslotRow(this)";></a></div>'),0!=e){(l=document.createElement("a")).setAttribute("id","removeRow"+e),l.setAttribute("class","svgIcons dIB ico_minus-lg mL10 vaM mT5"),l.setAttribute("onclick","Lyte.registeredMixins['crm-services-mixin'].removetimeslotRow(this);");var d=document.createElement("a");d.setAttribute("id","removeRow"+(e-1)),d.setAttribute("class","svgIcons dIB ico_minus-lg mL10 vaM mT5"),d.setAttribute("onclick","Lyte.registeredMixins['crm-services-mixin'].removetimeslotRow(this);"),$(t).after(d),t.remove()}$("#CustomTiming0").focusin(setFocusClass),$("#timechange1_"+r).each(crmTemplate.bindEventsToTimeField),$("#timechange2_"+r).each(crmTemplate.bindEventsToTimeField)},showServiceDuration:function(e){var t=$("#Crm_Services_SERVICEDURATION").attr("data-value");this.constructServiceDurations(t);var i=$(e).outerHeight(),r=$(e).offset().top,s=$(e).offset().left,a=renderingUtils.windowHeight,n=$("#serviceDurationsUL"),o=n.find("li");if(o.removeClass("selectedOpt"),o.each((function(){$(this).attr("data-value")!==t||$(this).addClass("selectedOpt")})),$("#serviceDurationErrorSpan").hide(),$(e).addClass("SlctListAtv"),n.css({display:"block",visibility:"hidden",top:r+i,left:s-10}),n.offset().top+n.outerHeight()>=a)var l=r-n.outerHeight();else l=r+i;n.css({top:l,left:s-10,visibility:"visible"}),$("body").css({overflow:"hidden"})},validateDate:function(e){var t=Crm.userDetails.DATE_PATTERN,i=$(e),r=i.val().trim(),s="Services";$(document.getElementById("errorMsg_"+i.attr("id"))).remove();var a=i.parent();if(Crm.holidays.selectedDate.removeFirstOccurenceOfElement(i.data("oldvalue")),i.data("oldvalue",""),r){if(!$L.moment(r,t.toUpperCase(),!0).validate())return a.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.emptyalert"),i,s),!1;Crm.holidays.selectedDate.push(CrmDateUtils.convertdateToDBformat(r,!0)),i.data("oldvalue",CrmDateUtils.convertdateToDBformat(r,!0));var n=CrmDateUtils.convertdateToDBformat(r,!0);if(this.checkHolidays(n))return a.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.holidayalert"),i,s),!1;if(this.checkBusinessDays(n))return a.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.busalert"),i,s),!1;a.removeClass("validErrMsg")}else a.removeClass("validErrMsg")},showADD_CTime:function(e){var t=$(e).closest(".customTimeRow"),i=$(".customTimeContainer"),r=t.find(".cus_time-From").val().trim(),s=t.find(".cus_time-To").val().trim();""!=r&&""!=s&&i.find(".ico_plus-lg").removeClass("disable")},addtimeslotRow:function(e){if(e.previousElementSibling.firstChild.value&&e.previousElementSibling.lastChild.value){var t=1+Number(e.id.slice(7));this.createtimeslotRow(t,e)}},removetimeslotRow:function(e){var t=e.closest(".labelValCreate"),i=document.createElement("a");i.setAttribute("id","addRow_0"),i.setAttribute("class","svgIcons dIB ico_plus-lg mL10 vaM mT5"),i.setAttribute("onclick","Lyte.registeredMixins['crm-services-mixin'].addtimeslotRow(this);"),$(e).closest(".customTimeContainer").remove();var r=$(t).children(".customTimeContainer");r.attr("id","timeField0"),r.append(i),r.find(".ico_minus-lg").remove()},getServiceModuleAvailDates:function(e,t,i){var r=6e4*CrmDateUtils.getTimeOffsetInMins(Crm.userDetails.ORGTIME_ZONE),s=(new Date).getTime()+r,a=Crm.userDetails.DATE_PATTERN,n=[];if(this.allPastDates=!0,e){var o=$(t).parent();if(!$L.moment(e,a.toUpperCase(),!0).validate())return o.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.emptyalert"),t,i),!1;var l=CrmDateUtils.convertdateToDBformat(e,!0);if(this.checkHolidays(l))return o.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.holidayalert"),t,i),!1;if(this.checkBusinessDays(l))return o.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.busalert"),t,i),!1;new Date(l).getTime()-(s-s%864e5)>=0&&(this.allPastDates=!1),n.push(l)}for(var m=1;m<=25;m++){var c=$("#Crm_Services_AVAILABLE_DATES_"+m),d=c.val();if(d){var p=c.parent();if(!$L.moment(d,a.toUpperCase(),!0).validate())return p.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.emptyalert"),c,i),!1;var u=CrmDateUtils.convertdateToDBformat(d,!0);if(this.checkHolidays(u))return p.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.holidayalert"),c,i),!1;if(this.checkBusinessDays(u))return p.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.busalert"),c,i),!1;if(new Date(u).getTime()-(s-s%864e5)>=0&&(this.allPastDates=!1),n.contains(u))return p.addClass("validErrMsg"),commonUtils.showErrorMsg(I18n.getMsg("crm.alert.duplicate.found")+" "+Utils.getDateInUserDatePattern($L.moment(u).toDate(),!0),c,i),!1;n.push(u)}}return n.length>0?n:null},validateFromTill:function(){var e=$("#Crm_Services_STARTING_DATE"),t=$("#Crm_Services_CLOSING_DATE"),i=commonUtils.getValue(e),r=commonUtils.getValue(t);if(i){if(!$L.moment(i,Crm.userDetails.DATE_PATTERN.toUpperCase(),!0).validate())return commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.emptyalert"),$(e),s),!1;i=CrmDateUtils.convertdateToDBformat(i,!0)}if(r){if(!$L.moment(r,Crm.userDetails.DATE_PATTERN.toUpperCase(),!0).validate())return commonUtils.showErrorMsg(I18n.getMsg("crm.service.availdate.emptyalert"),$(t),s),!1;r=CrmDateUtils.convertdateToDBformat(r,!0)}$(document.getElementById("errorMsg_"+e.attr("id"))).remove(),$(document.getElementById("errorMsg_"+t.attr("id"))).remove();var s="Services";if(i&&r&&new Date(r)-new Date(i)<864e5)return new Date(r).getTime()==new Date(i).getTime()?(commonUtils.showErrorMsg(I18n.getMsg("crm.service.availfromto.samevaluealert"),t,s),!1):(commonUtils.showErrorMsg(I18n.getMsg("crm.service.availfromto.fromtoalert"),t,s),!1)},constructServiceDurations:function(e){var t=$(renderingUtils.createHTML({name:"div",attr:{id:"serviceDurationsUL",class:"showComboNew ap newPopup dN",style:"display:none"},child:[{name:"ul",attr:{class:"m0 p0"}}]}));$("#show").append(t);var i,r,s=t.find("ul");s.html("");var a="none";e&&(a=e);for(var n=[{value:"none",html:I18n.getMsg("None")},{value:"30",html:I18n.getMsg("crm.service.duration.minutes",["30"])},{value:"60",html:I18n.getMsg("crm.service.duration.hr",["1"])},{value:"90",html:I18n.getMsg("crm.service.duration.hour.minutes",["1","30"])},{value:"120",html:I18n.getMsg("crm.service.duration.hrs",["2"])},{value:"150",html:I18n.getMsg("crm.service.duration.hours.minutes",["2","30"])},{value:"180",html:I18n.getMsg("crm.service.duration.hrs",["3"])},{value:"custom",html:I18n.getMsg("crm.lable.custom")}],o=!0,l=n.length,m=0;m<l;m++){i=$("<span>"),r=$("<li>"),a===n[m].value&&(o=!1);var c=r.attr({class:n[m].value===a?"selectedOpt":n[m].value,onclick:"Lyte.registeredMixins['crm-services-mixin'].manageServiceDuration(this);","data-value":n[m].value});i.attr({class:"slctOptTxt"}),i.text(n[m].html),i.appendTo(c),c.appendTo(s)}if(o&&"none"!==a){i=$("<span>"),r=$("<li>");var d=detailView.converMinToHourAndMin(parseInt(a)),p=s.find(".custom");c=r.attr({onclick:"Lyte.registeredMixins['crm-services-mixin'].manageServiceDuration(this);","data-value":a,"data-custom":"true"});i.attr({class:"slctOptTxt"}),i.text(detailView.constructDurationTxt(d[0],d[1])),i.appendTo(c),p.before(c)}},serviceAvailabilityEditAction:function(e,t,i){var r=null,s=e.FL.length,a=$("#serviceAjaxEditFields");0==$(a).is(":empty")&&$(a).empty();for(var n=0;n<s;n++)"UNAVAILABLE_TILL"!==e.FL[n].colname&&"SERVICESTATUS"!==e.FL[n].colname&&"UNAVAILABLE_FROM"!==e.FL[n].colname&&(r=crmTemplate.createFieldRow(t.layout_jsonarrayObj.sysLayoutId,i,void 0,e.FL[n]),$(a).append(r));var o=$("#Crm_Services_AVAILABLE_DATES");if(o.length>0){var l=JSON.parse(o.attr("arr_date")),m=l.length;if(m>0){if(null!=l){o.val(Utils.getDateInUserDatePattern(new Date(l[0]+"T00:00:00"),!0)),o.data("oldvalue",l[0]);var c=document.createElement("a");c.setAttribute("id","removeDate_0"),c.setAttribute("class","svgIcons dIB ico_minus-lg mL10 vaM mT5 fL"),c.setAttribute("onclick","Lyte.registeredMixins['crm-services-appointments-old-mixin'].removeDateField(this);"),1!=m&&$(o).after(c),Crm.holidays={},Crm.holidays.selectedDate=[],Crm.holidays.selectedDate.push(l[0])}for(var d=document.getElementById("addDate_1"),p=1;p<m;p++)Lyte.registeredMixins["crm-services-appointments-old-mixin"].editDate(d,Utils.getDateInUserDatePattern(new Date(l[p]+"T00:00:00"),!0),p),d=document.getElementById("addDate_"+p)}}var u=$("#Crm_Services_AVAILABLE_CUSTOM_TIMING");u.length>0&&this.chooseServiceTimeOption(u);var v=a.find("select");v&&v.length&&thirdPartyUtils.bindSelect2(v)},closeServiceAvailabilityPopup:function(e){Crm.renderDVLyteFlow(e.moduleName)?store.findRecord(moduleRecordMapping[e.moduleName].id,e.recordId).then((function(t){if(t){var i=$L("crm-detail-view")[0];if(i){var r=i.component.data;Lyte.Component.set(r,"record",objectUtils.cloneObject(t[0]))}Lyte.triggerEvent("detail_view_listener_"+e.unique_listener_id,{componentsToBeReloaded:["record_actions"]})}})):Lyte.Router.getRouteInstance().refresh()}},{mixins:["crm-appointments-mixin"]});
