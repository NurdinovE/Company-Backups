Lyte.Component.register("crm-tag",{_template:'<template tag-name="crm-tag"> <lyte-event-listener event-name="tags" on-fire="{{action(\'tagsListener\')}}"> <div id="tagui" class="tagSection dF"> <template is="if" value="{{expHandlers(fromRl,\'!\')}}"><template case="true"> <template is="if" value="{{expHandlers(expHandlers(tags.length,\'<=\',0),\'&amp;&amp;\',record.$stop_processing)}}"><template case="true"> <div class="dIB vaT tag_Icon fL mR5 zc_cursor_notallowed disabled mT3"> <span class="dIB zcicncss-tag zcicn-cssIcons zcicn_grey_mask let0 top0"></span> </div> </template><template case="false"> <div class="dIB vaT tag_Icon fL mR5 mT3"> <span class="dIB zcicncss-tag zcicn-cssIcons zcicn_grey_mask let0 top0"></span> </div> </template></template> </template></template> <div class="tagField dIB vaT mL0"> <template is="if" value="{{expHandlers(showDropDown,\'!\')}}"><template case="true"> <template is="if" value="{{expHandlers(tags.length,\'<=\',0)}}"><template case="true"> <template is="if" value="{{expHandlers(fromRl,\'!\')}}"><template case="true"> <div id="tagDiv" class="d_addTag dIB vaT com_par mL0 pR mT3 crm-small-font-size zcanvas-label"> <template is="if" value="{{expHandlers(expHandlers(record.$approved,\'!\'),\'&amp;&amp;\',expHandlers(expHandlers(expHandlers(module,\'===\',\'Services\'),\'||\',expHandlers(module,\'===\',\'Appointments\')),\'!\'))}}"><template case="true"> <template is="if" value="{{expHandlers(record.$approval_state,\'===\',&quot;approval_process_rejected&quot;)}}"><template case="true"> <a lt-prop-tooltip-config=" { &quot;showdelay&quot;:500,&quot;appearance&quot;:&quot;box&quot;} " lt-prop-title="{{getI18n(\'crm.label.add.tags\')}}" class="zcnoprop crm-font-regular crm-base-font-size crm-tag-addtext crm-cscript-write-action" href="javascript:void(0);" data-zcqa="zohocrm_canvas_addTag" onclick="{{action(\'showInput\')}}" style="color:#5a5a5a">{{getI18n(\'crm.label.add.tags\')}}</a> </template><template case="false"> <a class="zcnoprop crm-font-regular crm-base-font-size" lt-prop-title="{{getI18n(\'crm.tags.detailview.create.no.permission.msg\')}}" href="javascript:void(0);" data-zcqa="zohocrm_canvas_addTag">{{getI18n(\'crm.label.add.tags\')}}</a> </template></template> </template><template case="false"><template is="if" value="{{record.$stop_processing}}"><template case="true"> <a class="zcnoprop crm-font-regular crm-base-font-size disabled crmBaseColor zc_cursor_notallowed" href="javascript:void(0);" data-zcqa="zohocrm_canvas_addTag">{{getI18n(\'crm.label.add.tags\')}}</a> </template><template case="false"><template is="if" value="{{checkButtonStatus(\'tags\',record)}}"><template case="true"> <template is="if" value="{{record.$review}}"><template case="true"> <a class="zcnoprop crm-font-regular crm-base-font-size crmBaseColor" href="javascript:void(0);" lt-prop-title="{{getI18n(\'crm.reviewprocess.detailview.create.no.permission.msg\')}}" data-zcqa="zohocrm_canvas_addTag">{{getI18n(\'crm.label.add.tags\')}}</a> </template><template case="false"> <a class="zcnoprop crm-font-regular crm-base-font-size crmLabelColor zc_cursor_notallowed" href="javascript:void(0);" lt-prop-title="{{getI18n(\'crm.lock.tag.restricted\')}}" data-zcqa="zohocrm_canvas_addTag">{{getI18n(\'crm.label.add.tags\')}}</a> </template></template> </template><template case="false"><template is="if" value="{{expHandlers(expHandlers(expHandlers(tagsEditPermission,\'!\'),\'||\',expHandlers(expHandlers(record.$editable,\'||\',record.$locked_for_me),\'!\')),\'||\',expHandlers(record.$approval_state,\'==\',&quot;zia_vision_pending&quot;))}}"><template case="true"> <a class="zcnoprop crm-font-regular crm-base-font-size crmBaseColor" href="javascript:void(0);" lt-prop-title="{{getI18n(\'crm.tags.detailview.create.no.permission.msg\')}}" data-zcqa="zohocrm_canvas_addTag">{{getI18n(\'crm.label.add.tags\')}}</a> </template><template case="false"> <a lt-prop-tooltip-config=" { &quot;showdelay&quot;:500,&quot;appearance&quot;:&quot;box&quot;} " lt-prop-title="{{getI18n(\'crm.label.add.tags\')}}" class="zcnoprop crm-font-regular crm-base-font-size crm-tag-addtext crm-cscript-write-action crmBaseColor" href="javascript:void(0);" data-zcqa="zohocrm_canvas_addTag" onclick="{{action(\'showInput\')}}">{{getI18n(\'crm.label.add.tags\')}}</a> </template></template></template></template></template></template></template></template> </div></template><template case="false"> <div>-</div> </template></template>  </template><template case="false"> <div id="tagDiv" class="dF vaM pR w100_per"> <template is="if" value="{{tagsWidth}}"><template case="true"> <template is="if" value="{{fixedComponent}}"><template case="true"> <crux-tag-component class="dIB" data-zcqa="cruxTagComponent" cx-prop-width="{{expHandlers(tagsWidth,\'+\',&quot;px&quot;)}}" cx-prop-clip-mode="true" cx-prop-module="{{module}}" cx-prop-trigger-tag-click="true" cx-prop-value="{{tags}}" cx-prop-redirect-url="{{redirectUrl}}"></crux-tag-component> </template><template case="false"> <crux-tag-component class="dIB" data-zcqa="cruxTagComponent" cx-prop-width="{{expHandlers(tagsWidth,\'+\',&quot;px&quot;)}}" cx-prop-clip-mode="false" cx-prop-module="{{module}}" cx-prop-trigger-tag-click="true" cx-prop-value="{{tags}}" cx-prop-redirect-url="{{redirectUrl}}"></crux-tag-component> </template></template> </template></template> <template is="if" value="{{expHandlers(fromRl,\'!\')}}"><template case="true"> <li class="dIB crmaddtag"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(record.$approved,\'!\'),\'&amp;&amp;\',expHandlers(expHandlers(expHandlers(module,\'===\',\'Services\'),\'||\',expHandlers(module,\'===\',\'Appointments\')),\'!\')),\'||\',record.$stop_processing)}}"><template case="true"> <template is="if" value="{{expHandlers(record.$approval_state,\'==\',&quot;approval_process_rejected&quot;)}}"><template case="true"> <span class="dIB zcicncss-editFilled zcicn-cssIcons zcicncss13 mL0 crm-tag-addtext crm-cscript-write-action" data-zcqa="zohocrm_canvas_addTagIcon" lt-prop-title="{{getI18n(\'crm.label.add.tags\')}}" onclick="{{action(\'showInput\')}}"></span> </template><template case="false"> <span class="dIB zcicncss-editFilled zcicn-cssIcons zcicncss13 mL0 disabled zc_cursor_notallowed" data-zcqa="zohocrm_canvas_addTagIcon"></span> </template></template> </template><template case="false"><template is="if" value="{{expHandlers(record.$locked_for_me,\'&amp;&amp;\',checkButtonStatus(\'tags\',record))}}"><template case="true"> <span class="dIB zcicncss-reg-plus canvasViewTagAddIcon zcicncss-editFilled zcicn-cssIcons zcicncss13 mL0 zc_cursor_notallowed" lt-prop-title="{{getI18n(\'crm.lock.tag.restricted\')}}" data-zcqa="zohocrm_canvas_addTagIcon"></span> </template><template case="false"><template is="if" value="{{expHandlers(expHandlers(expHandlers(tagsEditPermission,\'!\'),\'||\',expHandlers(expHandlers(record.$editable,\'||\',record.$locked_for_me),\'!\')),\'||\',expHandlers(record.$approval_state,\'==\',&quot;zia_vision_pending&quot;))}}"><template case="true"> <span class="dIB zcicncss-editFilled zcicn-cssIcons zcicncss13 mL0" lt-prop-title="{{getI18n(\'crm.tags.detailview.create.no.permission.msg\')}}" data-zcqa="zohocrm_canvas_addTagIcon"></span> </template><template case="false"> <span class="dIB zcicncss-editFilled zcicn-cssIcons zcicncss13 mL0 crm-tag-addtext crm-cscript-write-action" data-zcqa="zohocrm_canvas_addTagIcon" lt-prop-title="{{getI18n(\'crm.label.add.tags\')}}" onclick="{{action(\'showInput\')}}"></span> </template></template></template></template></template></template> </li> </template></template> </div> </template></template> </template><template case="false"> <div id="tagDropDown"> <crux-tag cx-prop-tags="{{tags}}" cx-prop-comma-seperation="true" cx-prop-max-tag-limit="{{tagsLimit}}" cx-prop-tag-options="{{lbind(allTags)}}" on-validation="{{method(\'validateTag\')}}" on-error="{{method(\'onError\')}}" cx-prop-prevent-key-list="{{cxPropPrevent}}" on-color-tag-palette-hide="{{method(&quot;hideColor&quot;)}}"> </crux-tag> <div id="tagInputButtonsDiv" class="dIB vaBottom inputButtons"> <input type="button" data-zcqa="zohocrm_canvas_saveTag" value="{{getI18n(\'crm.button.save\')}}" class="crm-small-font-size pL5 saveButton cP" style="border: 0px; background: transparent; color: rgb(74, 142, 219); opacity: 1;" onclick="{{action(\'saveTagtoRecord\')}}"> <span class="mL5 crm-small-font-size crm-font-regular cP crm-rl-write-cancel crmBaseColor" data-zcqa="zohocrm_canvas_cancelTag" onclick="{{action(\'cancelTag\')}}">{{getI18n(\'crm.button.cancel\')}}</span> </div> </div> </template></template> </div> <div class="cBoth"></div> </div> </lyte-event-listener></template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1]},{type:"if",position:[1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[]},false:{dynamicNodes:[]}},default:{}}]}},default:{}},{type:"attr",position:[1,1,3,1]},{type:"if",position:[1,1,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]}},default:{}}]}},default:{}}]}},default:{}}]}},default:{}}]},false:{dynamicNodes:[]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}},default:{}}]}},default:{}}]}},default:{}}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3,1]},{type:"attr",position:[1,3,3]},{type:"text",position:[1,3,3,0]}]}},default:{}},{type:"componentDynamic",position:[1]}],_observedAttributes:["module","record","recordId","allTags","allTagNames","tags","tagNameIdMapping","tagsBeforeEdit","showDropDown","tagsLimit","cxPropPrevent","tagsEditPermission","allowedCount","tempCount","tagCount","fromRl","lyteUnbound","tagsWidth","fixedComponent","redirectUrl"],data:function(){return{module:Lyte.attr("string"),record:Lyte.attr("object"),recordId:Lyte.attr("string"),allTags:Lyte.attr("array",{default:[]}),allTagNames:Lyte.attr("array",{default:[]}),tags:Lyte.attr("array",{default:[]}),tagNameIdMapping:Lyte.attr("object"),tagsBeforeEdit:Lyte.attr("array"),showDropDown:Lyte.attr("boolean",{default:!1}),tagsLimit:Lyte.attr("number",{default:10}),cxPropPrevent:Lyte.attr("array"),tagsEditPermission:Lyte.attr("boolean",{default:!0}),allowedCount:Lyte.attr("number",{default:0}),tempCount:Lyte.attr("number",{default:0}),tagCount:Lyte.attr("number",{default:0}),fromRl:Lyte.attr("boolean",{default:!1}),lyteUnbound:Lyte.attr("boolean",{default:!1}),tagsWidth:Lyte.attr("number",{default:500}),fixedComponent:Lyte.attr("boolean",{default:!1}),redirectUrl:Lyte.attr("string")}},tagnamevsid:{},init:function(){if(Lyte.Router.getRouteInstance()&&("listview"===Lyte.Router.getRouteInstance().routeName||"custom-view"===Lyte.Router.getRouteInstance().parent.routeName||"ListView"===Lyte.Router.getRouteInstance().getQueryParams().feature))return this.setData("fromRl",!0),void(this.getData("record")&&this.setExistingTagValue());if(Lyte&&Lyte.Router&&Lyte.Router.getRouteInstance()&&"canvas"===Lyte.Router.getRouteInstance().routeName){var t=moduleRecordMapping[this.getData("module")];if(t.canvas_view||t.card_view||t.table_view||t.kanban_view||t.chart_id&&t.chart_view_supported&&t.chart_view){var e=this.getCurrentListViewURL(this.getData("module")),a=t.kanban_view||t.chart_view?"?":"&";this.setData("redirectUrl",e+a)}if(void 0===this.getData("redirectUrl")){var o=this.getData("module");e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.list",dynamicParams:[o,moduleRecordMapping[o].cvid]});this.setData("redirectUrl",e+"?")}}this.fireRequest(this),Lyte.Router.getRouteInstance()&&"canvas"===Lyte.Router.getRouteInstance().routeName&&"entity"===Lyte.Router.getRouteInstance().parent.routeName&&!Lyte.Router.getRouteInstance().currentModel.entityDetails.TagsEditPermission&&this.setData("tagsEditPermission",!1)},validatingCanvasRule:function(t,e){var a=moduleRecordMapping[t].api_name;"canvas"===Lyte.Router.getRouteInstance().routeName&&store.peekAll("canvas_rule").filter((function(t){return t.module.api_name===a})).length>0&&store.findRecord(moduleRecordMapping[t].id,e).then((function(t){Lyte.registeredMixins["crm-detailcanvas-utils"].validatingCanvasRule(a,t[0])}))},fireRequest:function(t){t.setExistingTagValue(),t.fetchAllTags()},setExistingTagValue:function(){this.setData("cxPropPrevent",[">","<",","]);for(var t=this.getData("record"),e=t&&t.Tag?t.Tag:[],a=e.length,o=0;o<a;o++){var s=e[o];s.link=this.getTagLinkUrl(s)}this.setData("tags",e.slice())},getTagLinkUrl:function(t){var e=this.getData("module"),a={comparator:"equal",field:{api_name:"Tag"},value:[{name:t.name}]};return"undefined"==typeof fromPrintPreview_asp||!1===fromPrintPreview_asp?Lyte.Router.getURL({route:"crm.tab.module.custom-view.list",dynamicParams:[e,moduleRecordMapping[e].cvid],queryParams:{filters:JSON.stringify(a)}}):""},getCurrentListViewURL:function(t){if(t&&moduleRecordMapping[t]&&moduleRecordMapping[t].cvid){var e="";return moduleRecordMapping[t].kanban_view?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.kanban",dynamicParams:[t,moduleRecordMapping[t].cvid]}):moduleRecordMapping[t].chart_view?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.chart",dynamicParams:[t,moduleRecordMapping[t].cvid]}):moduleRecordMapping[t].canvas_view&&moduleRecordMapping[t].viewid?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.canvas",dynamicParams:[t,moduleRecordMapping[t].cvid,moduleRecordMapping[t].viewid],queryParams:{viewType:"CustomizedView"}}):moduleRecordMapping[t].card_view&&moduleRecordMapping[t].cardid?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.canvas",dynamicParams:[t,moduleRecordMapping[t].cvid,moduleRecordMapping[t].cardid],queryParams:{viewType:"CardView"}}):moduleRecordMapping[t].table_view&&moduleRecordMapping[t].tableid&&(e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.canvas",dynamicParams:[t,moduleRecordMapping[t].cvid,moduleRecordMapping[t].tableid],queryParams:{viewType:"TableView"}})),e}},fetchAllTags:function(){var t=this.getData("module"),e=crmConstants.tagNotSupMod,a=store.peekRecord("module",moduleRecordMapping[t].id),o=this;!e.contains(t)&&a.api_supported&&store.findAll("tag",{module:moduleRecordMapping[t].api_name,fromPage:"view"},!0,!0).then((function(t){if(o.data){o.setData("allTags",t),o.populate_tagnamecolor(o,t);var e=o.generateTagNameIdMapping(t);if(o.setData("tagNameIdMapping",e),t.$&&t.$.meta){var a=t.$.meta;o.setData("allowedCount",a.allowed_count),o.setData("tagCount",a.count)}var s=$(o.$node),r=s&&s.find(".crmaddtag"),i=s&&s.find(".listview_taglists");r.length>0&&i.length>0&&i.append(r)}}))},populate_tagnamecolor:function(t,e){for(var a={},o=e.length,s=0;s<o;s++)a[e[s].name]=e[s].color_code;t.tagnamevscolor=a},getSelectedTagNames:function(t){for(var e=[],a=t.length,o=0;o<a;o++){var s=t[o].name.replace(/  +/g," ");e.push(s)}return e},generateTagNameIdMapping:function(t){for(var e={},a=t.length,o=0;o<a;o++){var s=t[o];e[s.name]=s}return e},processTagStrings:function(t){for(var e=this.getData("tagNameIdMapping"),a=t.length,o=[],s=0;s<a;s++){var r=t[s],i=e[r];i||(i=store.createRecord("tag")).$.set("name",r),o.push(r)}return o},addToExistingTags:function(){for(var t=this.getData("tags"),e=t.length,a=0;a<e;a++)t[a].link||(t[a].link=this.getTagLinkUrl(t[a]));t=t.slice(),this.setData("tags",t);var o=this.getData("record"),s=this.setData("tagCount",s),r=this.getData("tagNameIdMapping");Lyte.triggerEvent("tags",{action:"update",data:t,recordId:o.id,tagCount:s,tempCount:s,tagNameIdMapping:r})},saveTagtoRecord:function(t,e){var a=this.getData("module"),o=e||this.getData("tags"),s=this.getSelectedTagNames(o),r=this.getData("tagsBeforeEdit"),i=this.getSelectedTagNames(r),n=this.getData("tagsLimit"),c=e?"":$L("crux-tag")[0].cxProp("inputValue");if(o.length===n&&""!==c){var d=I18n.getMsg("crm.tags.records.limit.reached",n);return renderingUtils.showAlertMsg(I18n.getMsg(d)),!1}if(0===r.length&&0===o.length&&""!==c)return renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.need.alphanumeric.characters")),void this.setData("showDropDown",!1);if(""!==c){if(o.length>0)return CrmTags.checkCharacter(c)?void renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.not.selected.text")):void renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.need.alphanumeric.characters"));if(0===o.length)return void renderingUtils.showAlertMsg(I18n.getMsg("crm.no.tag.selected"))}if(i.join(",")!==s.join(",")){var l=!1;if(0===s.length&&(l=!0,s=this.getSelectedTagNames(r)),s){var p,m=this.getData("recordId"),u=/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g;if(s.filter((function(t){return t.match(u)})).length>0){renderingUtils.showCustomAlert(I18n.getMsg("crm.tag.name.invalid.emoji"));var g=s.length;for(w=0;w<g;w++)s[w].match(u)&&(s.splice(w,1),g--,w--);if(s.length<=0)return this.setData("tags",r),void this.setData("showDropDown",!1)}if(store.clearCachedQuery("tag"),l){p="/crm/v2/"+moduleRecordMapping[a].api_name+"/"+m+"/actions/remove_tags?fromClient=true&tag_names="+encodeURIComponent(s);var f={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},v=this;app.store.makeRequest("sendXHR",p,"POST",f,this.getData("tags")).then((function(e){var o=JSON.parse(e.response).data;if(o&&o.length>0&&-1!=o[0].message.indexOf("tags updated successfully")){v.validatingCanvasRule(a,m);var r=v.processTagStrings(o[0].details.tags);if(v.setData("tags",r.slice()),v.addToExistingTags(),v.fetchAllTags(),v.setData("showDropDown",!1),t&&t.resolvefn&&t.resolvefn(),CScriptLib&&(!t||t.trigger)){var n=i||[],c=s||[],d=c.diff(n)||[],l=n.diff(c)||[];c=c.map((function(t){return{name:t}})),d=d.map((function(t){return{name:t}})),l=l.map((function(t){return{name:t}})),CScript.Engine.Global.dispatchEvent("onTagChanged",void 0,d,l)}if(featuresAvailable.DATA_HUB){var p=$L("crm-detailview-canvas")[0];p&&p.component&&p.component.staticRecordUpdate("Tag",r)}}else t&&t.resolvefn&&t.rejectfn(),crmui.showMsgBand("info",I18n.getMsg("crm.tags.add.unsuccessful"),1e3,"")}),(function(e){t&&t.resolvefn&&t.rejectfn(),"NO_PERMISSION"===JSON.parse(e.responseText).code?(v.closeTag(),!t&&renderingUtils.displayPermissionDenied(),t&&t.rejectfn&&robjs.rejectfn("NO_PERMISSION")):(!t&&renderingUtils.showCustomAlert(I18n.getMsg("crm.tag.unable.to.process"),I18n.getMsg("crm.label.small.tags"),!1),t&&t.rejectfn&&robjs.rejectfn("INTERNAL_ISSUE"))}))}else{for(var h=e||this.getData("tags"),y=h.length,w=0;w<y;w++){var _=h[w].name.replace(/  +/g," ");h[w].name=_,"noFill"===h[w].color_code&&(h[w].color_code=null)}this.addtagstoRec(this,{tags:h,over_write:!0,ids:m},m,!0,a,"canvas","add",t,s,i)}}else this.setData("showDropDown",!1)}else this.setData("showDropDown",!1)},methods:{onError:function(t,e,a,o,s,r){if(3===e.errorCode){var i=this.getData("tagsLimit");r&&r.toggle(),renderingUtils.showAlertMsg(I18n.getMsg("crm.tags.records.limit.reached",i))}else 1===e.errorCode&&renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.need.alphanumeric.characters"))},reloadComponent:function(){this.fireRequest(this)},validateTag:function(t){if(!CrmTags.checkCharacter(t))return $L("lyte-dropdown",this.$node)[0].close(),!1;if(!this.data.tagNameIdMapping[t]){var e=this.getData("allowedCount"),a=this.getData("tagCount");return a>=e?(renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.edition.limit.exceeded")),$L("lyte-dropdown",this.$node)[0].close(),!1):(a++,this.setData("tagCount",a),this.getData("tagNameIdMapping")[t]=!1,!0)}},hideColor:function(t,e){var a=this.$node.querySelector("crux-tag"),o=a.component.bodyDrop.querySelector("crux-color-palette lyte-popover");e&&e.target&&!a.component.bodyDrop.contains(e.target)&&!o.component.childComp.contains(e.target)&&(a.toggle("close"),this.setData("showDropDown",!1))}},actions:{tagsListener:function(t){var e=this.getData("record");if("update"===t.action&&t.recordId===e.id){var a=t.data.slice();this.setData("tags",a),this.setData("tagsBeforeEdit",a),t.tagCount&&this.setData("tagCount",t.tagCount),t.tagNameIdMapping&&this.setData("tagNameIdMapping",t.tagNameIdMapping),t.tempCount&&this.setData("tempCount",tempCount)}},showInput:function(){for(var t=$("crm-tag"),e=t.length,a=0;a<e;a++)t[a].component.setData("showDropDown",!1);var o=this.getData("tags").slice(),s=this.getData("tagCount");this.setData("tagsBeforeEdit",o),this.setData("tempCount",s),this.setData("showDropDown",!0),$L("crux-tag",this.$node)[0].focus()},cancelTag:function(){var t=this.getData("record"),e=this.getData("tagsBeforeEdit").slice();this.setData("tags",e),this.setData("showDropDown",!1);var a=this.getData("tempCount");Lyte.triggerEvent("tags",{action:"update",data:e,recordId:t.id,tagCount:a})},saveTagtoRecord:function(){this.saveTagtoRecord()}},closeTag:function(){var t=this.getData("record"),e=this.getData("tagsBeforeEdit").slice();this.setData("tags",e),this.setData("showDropDown",!1);var a=this.getData("tempCount");Lyte.triggerEvent("tags",{action:"update",data:e,recordId:t.id,tagCount:a})}},{mixins:["crm-tag-mixin"]});
