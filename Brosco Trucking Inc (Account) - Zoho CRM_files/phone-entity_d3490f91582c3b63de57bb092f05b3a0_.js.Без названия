Lyte.Component.register("phone-entity",{_template:'<template tag-name="phone-entity" use-strict="true"> <div class="phoneNo_{{defaultid}}"> <template is="if" value="{{expHandlers(isassociate,\'&amp;&amp;\',expHandlers(isFromCanvas,\'&amp;&amp;\',expHandlers(expHandlers(isAssociationAvailable,\'!\'),\'||\',expHandlers(isAssociationNumberAvailable,\'!\'))))}}"><template case="true"> <lyte-button lt-prop-disabled="true"> <template is="registerYield" yield-name="text">{{getI18n("crm.calls.associate.number.with")}}</template> </lyte-button> </template><template case="false"><template is="if" value="{{isassociate}}"><template case="true"> <template is="if" value="{{expHandlers(defaultvalue,\'&amp;&amp;\',isAssociationNumberAvailable)}}"><template case="true"> <lyte-button class="newNumber_{{defaultid}}_new" lt-prop-appearance="primary" data-zcqa="associate"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.calls.associate.number.with\')}} </template> </lyte-button> <lyte-menu lt-prop-yield="true" id="callNewNumPop" lt-prop-callout="true" lt-prop-event="click" lt-prop-query=".newNumber_{{defaultid}}_new" lt-prop-on-menu-click="{{action(\'closeMenu\')}}"> <template is="registerYield" yield-name="yield"> <lyte-menu-body> <lyte-menu-item id="ctiapi_unknown_add_leadActivity" data-prop="Leads" class="create_associate_number" data-zcqa="ctiapi_unknown_associate_lead"> <lyte-menu-label class="dF spaceBetween aiCenter w100_per"> {{getDisplayModuleName(\'Leads\',true)}} <span class="zcicn-arrow-solid-right-sm-mask zcicn-cssIcons zcicn-rotate-180"></span> </lyte-menu-label> </lyte-menu-item> <lyte-menu-item id="ctiapi_unknown_add_contactActivity" data-prop="Contacts" class="create_associate_number" data-zcqa="ctiapi_unknown_associate_contact"> <lyte-menu-label class="dF spaceBetween aiCenter w100_per"> {{getDisplayModuleName(\'Contacts\',true)}} <span class="zcicn-arrow-solid-right-sm-mask zcicn-cssIcons zcicn-rotate-180"></span> </lyte-menu-label> </lyte-menu-item> </lyte-menu-body> </template> </lyte-menu> <lyte-menu lt-prop-yield="true" id="callNewNumPop" lt-prop-callout="true" lt-prop-event="mouseover" lt-prop-query=".create_associate_number" lt-prop-on-menu-click="{{action(\'closeMenu\')}}" lt-prop-position="right" on-before-open="{{method(\'subActionOpen\')}}"> <template is="registerYield" yield-name="yield"> <lyte-menu-body> <lyte-menu-item onclick="{{action(\'showConversionForm\',module)}}" id="ctiapi_unknown_add_leadActivity" data-zcqa="ctiapi_unknown_associate_new_{{module}}"> <lyte-menu-label class="dB"> {{getI18n(\'crm.label.convert.create.new.module\',getDisplayModuleName(module,true))}} </lyte-menu-label> </lyte-menu-item> <lyte-menu-item onclick="{{action(\'showAssociateForm\',module)}}" id="ctiapi_unknown_associate_leadActivity" data-zcqa="ctiapi_unknown_associate_existing_{{module}}"> <lyte-menu-label class="dB"> {{getI18n(\'crm.tpi.ctiapi.associate.new.module\',getDisplayModuleName(module,true))}} </lyte-menu-label> </lyte-menu-item> </lyte-menu-body> </template> </lyte-menu> <template is="if" value="{{activityId}}"><template case="true"> <lyte-event-listener event-name="phone_entity_conversion_{{activityId}}" on-fire="{{action(\'refreshPage\')}}"></lyte-event-listener> </template></template> </template></template> </template><template case="false"> <div href="javascript:void(0);" class="ellipsistext {{estyle}}" style="text-decoration:none"> <span class="mR10 pL0 dIB vaM">{{defaultvalue}}</span> <template is="if" value="{{showPlusIcon}}"><template case="true"> <i class="iconPlus dIB cP vaM newNumber_{{defaultid}}" onclick="{{action(\'stopEvent\')}}"></i> </template></template> </div> <lyte-menu lt-prop-yield="true" id="callNewNumPop" lt-prop-callout="true" lt-prop-event="click" lt-prop-query=".newNumber_{{defaultid}}" lt-prop-on-menu-click="{{action(\'closeMenu\')}}" style="display: none"> <template is="registerYield" yield-name="yield"> <lyte-menu-body class="NewNumAddMenu"> <lyte-menu-item onclick="{{action(\'showConversionForm\',\'Leads\')}}" id="ctiapi_unknown_add_leadActivity"> <lyte-menu-label class="dB"> {{getI18n(expHandlers(isassociate,\'?:\',\'crm.label.convert.create.new.module.associate\',\'crm.label.convert.create.new.module\'),getDisplayModuleName(\'Leads\',true))}} </lyte-menu-label> </lyte-menu-item> <lyte-menu-item onclick="{{action(\'showConversionForm\',\'Contacts\')}}" id="ctiapi_unknown_add_contactActivity"> <lyte-menu-label class="dB"> {{getI18n(expHandlers(isassociate,\'?:\',\'crm.label.convert.create.new.module.associate\',\'crm.label.convert.create.new.module\'),getDisplayModuleName(\'Contacts\',true))}} </lyte-menu-label> </lyte-menu-item> <lyte-menu-item class="br_top_border1" onclick="{{action(\'showAssociateForm\',\'Leads\')}}" id="ctiapi_unknown_associate_leadActivity"> <lyte-menu-label class="dB"> {{getI18n(expHandlers(isassociate,\'?:\',\'crm.label.associate.existing.module\',\'crm.tpi.ctiapi.associate.new.module\'),getDisplayModuleName(\'Leads\',true))}} </lyte-menu-label> </lyte-menu-item> <lyte-menu-item onclick="{{action(\'showAssociateForm\',\'Contacts\')}}" id="ctiapi_unknown_associate_contactActivity"> <lyte-menu-label class="dB"> {{getI18n(expHandlers(isassociate,\'?:\',\'crm.label.associate.existing.module\',\'crm.tpi.ctiapi.associate.new.module\'),getDisplayModuleName(\'Contacts\',true))}} </lyte-menu-label> </lyte-menu-item> </lyte-menu-body> </template> </lyte-menu> </template></template></template></template> <lyte-modal id="lookupListPopupPhoneEntity" lt-prop-bind-to-body="{{ltPropBindToBody}}" lt-prop-class="crmBoxModal" lt-prop-wrapper-class="lookupListTable {{if(fromSalesInbox,\'fromSalesInbox\',\'\')}}" on-close="{{method(\'closeLookup\')}}" lt-prop-show-close="true" lt-prop-allow-multiple="true" lt-prop-show="{{lbind(showCopy)}}"> <template is="registerYield" yield-name="modal"> <crux-lookup-filter-view module="{{module}}" cx-prop-return-full-object-on-get="true" on-data-loaded="{{method(\'onDataLoaded\')}}" mod-id="{{modId}}" on-value-change="{{method(\'onLookupSelect\')}}" flush-view="{{lbind(flushView)}}" show="{{lbind(showCopy)}}"> </crux-lookup-filter-view> </template> </lyte-modal> <form name="associatePhNoForm{{defaultid}}" action="javascript:" onsubmit="{{action(\'stopEvent\')}}"> <input type="hidden" id="assocWithId"> <input type="hidden" id="assocWithName"> <input type="hidden" id="assocWithModule"> </form> </div> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[0]}]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"text",position:[1,1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"componentDynamic",position:[1,1]},{type:"text",position:[1,3,1,1]},{type:"componentDynamic",position:[1,3,1]},{type:"componentDynamic",position:[1,3]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[3]},{type:"attr",position:[5]},{type:"registerYield",position:[5,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3]},{type:"text",position:[1,3,1,1]},{type:"componentDynamic",position:[1,3,1]},{type:"componentDynamic",position:[1,3]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[5]},{type:"attr",position:[7]},{type:"if",position:[7],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,0]},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3]},{type:"text",position:[1,3,1,1]},{type:"componentDynamic",position:[1,3,1]},{type:"componentDynamic",position:[1,3]},{type:"attr",position:[1,5]},{type:"text",position:[1,5,1,1]},{type:"componentDynamic",position:[1,5,1]},{type:"componentDynamic",position:[1,5]},{type:"attr",position:[1,7]},{type:"text",position:[1,7,1,1]},{type:"componentDynamic",position:[1,7,1]},{type:"componentDynamic",position:[1,7]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[3]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3]},{type:"registerYield",position:[1,3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,3]},{type:"attr",position:[1,5]}],_observedAttributes:["defaultvalue","defaultid","activityId","autotrigger","estyle","module","showCopy","isFromCanvas","isassociate","isAssociationAvailable","ltPropBindToBody","showPlusIcon","record"],init:function(){if(Lyte.injectResources([networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("phonenumberassociate")],ResourceConstants.CRM)[0]]),this.getData("isassociate")){var e,t=store.peekRecord(moduleRecordMapping.Calls.id,this.getData("activityId")),a="Outbound"===Lyte.registeredMixins["crm-detailview-common-utils"].getCallType(t);this.setData("isOutboundNumber",a),a&&t.To_Number__s?e=t.To_Number__s:!a&&t.From_Number__s?e=t.From_Number__s:!Crm.userDetails.CALLS_PREFERENCE&&t.$phone_number&&(e=t.$phone_number),this.setData("defaultvalue",e)}if(void 0===this.getData("defaultid")){var i=this.getPhoneId(this.getData("defaultvalue"));this.setData("defaultid",i)}this.getData("isFromCanvas")&&(!(t=store.peekRecord(moduleRecordMapping.Calls.id,this.getData("activityId")))||t.Who_Id||t.What_Id||this.setData("isAssociationAvailable",!0));this.getData("isassociate")&&Crm.userDetails.CALLS_PREFERENCE&&this.getData("defaultvalue")?this.processAssociateWithLR():this.getData("isassociate")&&!Crm.userDetails.CALLS_PREFERENCE&&this.setData("isAssociationNumberAvailable",!0)},getPhoneId:function(e){return e&&(e=(e=0===(e=e.replaceAll(/[^a-zA-Z0-9]/g,"")).indexOf("0")?e.substring(1):e).replace(/./g,(e=>crmCallsNew.alpha_mappings[e.toUpperCase()]||e))),e},autoTriggerFn:function(){if(null!=this.getData("autotrigger"))switch(this.getData("autotrigger")){case"add_lead":CrmPhoneNumbers.showConversionForm("Leads",this.getData("defaultvalue"),this.getData("defaultid"),this.getData("activityId"));break;case"add_contact":CrmPhoneNumbers.showConversionForm("Contacts",this.getData("defaultvalue"),this.getData("defaultid"),this.getData("activityId"));break;case"associate_lead":"undefined"!=typeof Crm&&Crm.userDetails.isLookupAdvancedSearchEnabled?this.executeMethod("openLookup","Leads"):CrmPhoneNumbers.showAssociateForm("Leads",this.getData("defaultvalue"),this.getData("defaultid"),this.getData("activityId"));break;case"associate_contact":"undefined"!=typeof Crm&&Crm.userDetails.isLookupAdvancedSearchEnabled?this.executeMethod("openLookup","Contacts"):CrmPhoneNumbers.showAssociateForm("Contacts",this.getData("defaultvalue"),this.getData("defaultid"),this.getData("activityId"))}}.observes("autotrigger").on("didConnect"),processAssociateWithLR:function(){var e,t=moduleRecordMapping.Calls.layouts[0].id,a=moduleApiMapping.Calls;!this.getData("isLRFetched")&&(void 0===Crm.userDetails.LAYOUTRULEAVAILABLE||!0===Crm.userDetails.LAYOUTRULEAVAILABLE&&Crm.userDetails.LRINVOLVEDMODULES.contains(a))?e=[store.findAll("layout_rule",{module:a},!1,!1,t)]:this.getData("layoutRules")&&(e=[]);e?Lyte.resolvePromises(e).then(function(e){var t=store.peekRecord(moduleRecordMapping.Calls.id,this.getData("activityId")),a=moduleRecordMapping.Calls.layouts[0],i=objectUtils.cloneObject(a);this.setData("layout",i);var o=this.getData("layoutRules");if(!this.getData("isLRFetched")){o=e[0].layout_rule;this.setData({layoutRules:o,isLRFetched:!0})}o&&Lyte.registeredMixins["crm-detailview-parser"].processOneLayoutRules(i,o,t,"view"),this.showHideAssociateBtn(t,i)}.bind(this)):this.setData("isAssociationNumberAvailable",!0)},showHideAssociateBtn:function(e,t){var a,i=t.sections,o=!1,s=this.getData("isOutboundNumber")?"To_Number__s":"From_Number__s";i.forEach((function(e){e.isHiddenInLR||e.fields.forEach((function(e){e.api_name===s&&e.view_type.view&&(o=!0)}))})),a=this.getData("isOutboundNumber")?e.To_Number__s:e.From_Number__s,o&&a?this.setData("isAssociationNumberAvailable",!0):this.setData("isAssociationNumberAvailable",!1)},observeRecord:function(){if(Crm.userDetails.CALLS_PREFERENCE){var e,t=this.getData("record");if(e=this.getData("isOutboundNumber")?t.To_Number__s:t.From_Number__s,this.setData("defaultvalue",e),e){var a=this.getPhoneId(e);this.setData("defaultid",a)}else this.setData("defaultid",void 0);e?this.processAssociateWithLR():this.setData("isAssociationNumberAvailable",!1)}}.observes("record.*"),data:function(){return{defaultvalue:Lyte.attr("string"),defaultid:Lyte.attr("string"),activityId:Lyte.attr("string"),autotrigger:Lyte.attr("string"),estyle:Lyte.attr("string",{default:"crm-font-bold crmBaseColor"}),module:Lyte.attr("string"),showCopy:Lyte.attr("boolean",{default:!1}),isFromCanvas:Lyte.attr("boolean",{default:!1}),isassociate:Lyte.attr("boolean",{default:!1}),isAssociationAvailable:Lyte.attr("boolean",{default:!1}),ltPropBindToBody:Lyte.attr("boolean",{default:!1}),showPlusIcon:Lyte.attr("boolean",{default:!0}),record:Lyte.attr("object",{watch:!0})}},methods:{openLookup:function(e){var t=moduleRecordMapping[e].id;this.setData({module:e,modId:t}),CrmPhoneNumbers.currentActivityId=this.getData("activityId"),CrmPhoneNumbers.getAvailablePhoneFields(e,void 0,void 0,void 0,function(){var e=document.getElementsByTagName("crux-lookup-filter-view")[0];e?e.component.init():this.setData("ltPropBindToBody",!0)}.bind(this),CrmPhoneNumbers.noFieldErrFn)},onDataLoaded:function(){this.setData("showCopy",!0)},onLookupSelect:function(e){CrmPhoneNumbers.onInputChange(e.id,e.displayName,this.getData("module"),this.getData("defaultvalue"),this.getData("defaultid")),this.setData("lookUpSelected","fromLookUp"),this.executeMethod("closeLookup")},closeLookup:function(){this.setData({showCopy:!1,flushView:!0,autotrigger:""}),"fromLookUp"!==this.getData("lookUpSelected")&&CrmPhoneNumbers.closeConversionForm()},subActionOpen:function(e,t,a){var i=a.dataset.prop;this.setData("module",i)}},actions:{showConversionForm:function(e){Crm.userDetails.isStorageLimitReached?Crm.showStorageExceedPopup():CrmPhoneNumbers.showConversionForm(e,this.getData("defaultvalue"),this.getData("defaultid"),this.getData("activityId"))},showAssociateForm:function(e){Crm.userDetails.isStorageLimitReached?Crm.showStorageExceedPopup():"undefined"!=typeof Crm&&Crm.userDetails.isLookupAdvancedSearchEnabled?(this.setData("lookUpSelected",""),this.executeMethod("openLookup",e)):CrmPhoneNumbers.showAssociateForm(e,this.getData("defaultvalue"),this.getData("defaultid"),this.getData("activityId"))},refreshPage:function(e,t,a){"undefined"!=typeof Calls&&Calls.updateCardsDataAjax&&Calls.updateCardsDataAjax(detailView.entityId,e,t,a);var i={};i.module=moduleApiMapping.Calls,i.entityId=this.getData("activityId"),SourceIdentifier.refreshPage("detailView",i)}}},{mixins:["crm-stop-event"]});
