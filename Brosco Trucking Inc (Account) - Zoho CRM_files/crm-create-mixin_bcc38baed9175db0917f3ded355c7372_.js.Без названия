Lyte.Mixin.register("crm-create-mixin",{globalDataIndex:0,checkLayoutrules:function(e,t){this.getData("isPortalPreview")||(e&&!e.getData("fromSubform")?this.processLayoutRules(e):e||!this.getData("isWizard")||this.getData("isWizardView")||this.processLayoutRules()),this.getData("zorEnabled")&&this.triggerZiaOwnerRecommendation();var a=this.getData("moduleFormulafields");if((a&&a.length?a.length:0)&&!t){var i=this.getData("dataBind"),r=this.getData("moduledataUicomp");"FIRSTNAME"===r.column_name&&this.formulaWorkerExecution(a,this.getData("salutationfieldData"),i),this.formulaWorkerExecution(a,r,i)}},renderViewPortNode:function(){this.data.lyteViewPort&&this.setData("lyteViewPort",!1)},showDuplicateRecordDetail:function(e){var t=this.getData("errorDetails");if(t.duplicateFdetails&&t.duplicateFdetails.detailsFromserver&&t.duplicateFdetails.detailsFromserver.duplicate_record){var a=t.duplicateFdetails.detailsFromserver.duplicate_record,i=moduleRecordMapping[t.duplicateFdetails.moduleN].id,r=store.peekRecord("module",i).display_field,o=store.peekRecord(i,a.id),n="null";o?(n="Full_Name"==r.api_name&&o.Salutation?o.Salutation+" "+o[r.api_name]:o[r.api_name],Crm.showExistingEmailQuickInfo(n,a.Owner.name,a.Owner.zuid,t.duplicateFdetails.modLabel,t.duplicateFdetails.key,e,!0)):store.findRecord(i,a.id,{approved:"both",converted:"both"}).then((function(i){n=i[0]?"Full_Name"==r.api_name&&i[0].Salutation?i[0].Salutation+" "+i[0][r.api_name]:i[0][r.api_name]:n,Crm.showExistingEmailQuickInfo(n,a.Owner.name,a.Owner.zuid,t.duplicateFdetails.modLabel,t.duplicateFdetails.key,e,!0)}),(function(){Crm.showExistingEmailQuickInfo(n,a.Owner.name,a.Owner.zuid,t.duplicateFdetails.modLabel,t.duplicateFdetails.key,e,!0)}))}},hideDuplicateRecordDetail:function(e){$L("#crmExistingEmailQuickInfoPopover")[0]&&Crm.dontHideQuickInfoPop(e)},displayRestrictionWarning:function(e){var t=this;this.renderViewPortNode(),this.setData("warningDetails",{isRestrictionWarning:!0});var a=this.getData("modulenameUicomp"),i="edit"===this.data.initRoute?this.data.dataBind.id:null;Lyte.registeredMixins["crm-assignment-threshold-common"].restrictionGrantCheck(a,e,i).then((function(e){var a=$L(t.$node.querySelector(".FValue")),i=a.position().left,r=a.width();if(Crm.userDetails.RTL_ENABLED){var o=t.getData("fldLabelid");i=-$L("#"+o).outerWidth()}var n=document.getElementById("assRestGrant");if(n){var s="position:relative;left:"+i+"px;width:"+r+"px;top:10px";n.setData("rsGrantStyle",s)}var l=$L("#assignmentRestriction");e&&!1===e.allow?l.removeClass("dN"):l.addClass("dN")}))},getLayoutPromise:function(e){var{layoutId:t,moduleapi:a,moduleName:i,entityId:r,isRecursivecall:o,wizardId:n,clonedlayoutId:s,isOldFlow:l,modeType:d,isPortalPreview:c,dataObject:u,transData:m,queryParamsInfo:p,isThroughQc:f,formViewTypeInfo:_}=e;if(n&&(c||(renderingUtils.freezeBackground(),commonUtils.showHideLoadingDiv(!0))),t){var y={},g={},v={layoutId:t,moduleSet:!0,peekField:!1,from:"lyteCreate",allowMultiple:!0};if(u&&u.layoutCustomData)for(var h in u.layoutCustomData)v[h]=u.layoutCustomData[h];if(d&&(v.mode=d),void 0!==n)if(l)g.moduler=store.findRecord("module",moduleRecordMapping[i].id,void 0,void 0,!0,v),g.wizard=store.findRecord("wizard",n,{layout_id:t,from_cache:!0});else{g.moduler=store.findRecord("module",moduleRecordMapping[i].id,void 0,void 0,!0,v),g.wizard=store.findRecord("wizard",n,{layout_id:t,from_cache:!0}).then((function(e){return r&&"string"!=typeof r&&(store.pushPayload(moduleRecordMapping[i].id,r[moduleRecordMapping[i].id][0]),r.meta&&(y.originalData=r.meta.original)),e})).catch((()=>{let e;if(r&&"string"!=typeof r&&(e=r[moduleRecordMapping[i].id][0]),e&&"draft"===e.$state)return _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.record.wizard.not.available"),ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]},accept:function(){Lyte.Router.transitionTo({route:"crm.tab.module.actions.draft",dynamicParams:[i]}),renderingUtils.removeFreezeLayer()}}),f||this.transition.abort(),{isWizardNotAvailble:!0}}));let e=store.peekRecord("wizard",n);if(Crm.userDetails.isWizardViewEnabled&&!Crm.userDetails.RTL_ENABLED&&!window.clientPortalName&&e&&e.layoutVsScreens){let a=e.layoutVsScreens[t]?e.layoutVsScreens[t].mapByKey("id"):[],r=store.peekAll("canvasview").filter((e=>e.canvas_enabled&&e.related_to&&e.related_to.wizard&&e.related_to.wizard._screen&&a.contains(e.related_to.wizard._screen.id))).mapByKey("id"),o=[],n=15;for(r.length&&(g.canvasRules=store.findAll("canvas_rule",{module:moduleRecordMapping[i].api_name}),g.mapDependency=networkUtils.lyteInitiateRequest(`/crm/v4/settings/layouts/${t}/map_dependency`,"GET",{params:{module:moduleRecordMapping[i].api_name}}));r.length;)o.push(r.splice(0,n));o.forEach(((e,t)=>{g["wizardViews"+t]=store.findAll("canvasview",{feature:"WizardView",parsed:"true",ids:e.join()})}))}}else{function D(e){if(r&&"string"!=typeof r){if(u&&u.subformAjaxField){var a=objectUtils.getKeys(u.subformAjaxField)[0];r[moduleRecordMapping[i].id][0][a]=u.subformAjaxField[a]}store.pushPayload(moduleRecordMapping[i].id,r[moduleRecordMapping[i].id][0]),r.meta&&(y.originalData=r.meta.original)}return e?e[0].layouts.filter((function(e){return e.id===t})):void 0}u&&u.substituteResponse&&u.substituteResponse.layoutResponse?g.layout=new Promise((function(e){e(D(u.substituteResponse.layoutResponse))})):g.layout=store.findRecord("module",moduleRecordMapping[i].id,{include_inner_details:"lookup.query_details.criteria"},void 0,!0,v).then((function(e){return D(e)}))}if(n){if("Potentials"===i||void 0===Crm.userDetails.LAYOUTRULEAVAILABLE||!0===Crm.userDetails.LAYOUTRULEAVAILABLE&&Crm.userDetails.WLRINVOLVEDMODULES&&-1!==Crm.userDetails.WLRINVOLVEDMODULES.indexOf(i)){var b={comparator:"equal",api_name:"wizard.id",value:n||"null"};g.layout_rules=store.findAll("layout_rule",{module:a,filters:JSON.stringify(b)},!1,!1,t)}}else(void 0===Crm.userDetails.LAYOUTRULEAVAILABLE||!0===Crm.userDetails.LAYOUTRULEAVAILABLE&&Crm.userDetails.LRINVOLVEDMODULES.contains(i))&&(u&&u.substituteResponse&&u.substituteResponse.layoutRulesResponse?g.layout_rules=new Promise((function(e){e(u.substituteResponse.layoutRulesResponse)})):g.layout_rules=new Promise((function(e){return store.findAll("layout_rule",{module:a},!1,!1,t).then((function(t){e(t)}),(function(){e()}))})));(void 0===Crm.userDetails.VALIDATIONRULEAVAILABLE||!0===Crm.userDetails.VALIDATIONRULEAVAILABLE&&Crm.userDetails.VRINVOLVEDMODULES.contains(i))&&(u&&u.substituteResponse&&u.substituteResponse.validationRuleResponse?g.validation_rules=new Promise((function(e){e(u.substituteResponse.validationRuleResponse)})):g.validation_rules=new Promise((function(e){return store.findAll("validation_rule",{layout_id:t,module:a,download_rules:!0},!1).then((function(t){e(t)}),(function(){e()}))}))),r&&!o&&(g.current_record=store.findRecord(moduleRecordMapping[i].id,r,{approved:"both",converted:"both"}).then((function(e){return e.$.meta&&(y.originalData=e.$.meta.original),e})));var L=store.peekRecord("layout",t);return L&&"Campaigns"===i&&("Zoho Survey"!==L.name||"2"!==L.status&&"campaign_integration"!==L.source||(g.surveyDepartments=store.triggerAction("module","survey_departments",{type:"GET"})),"system"!==L.generated_type||"webinar"!==L.created_for&&"Zoho Webinar"!==L.name||"campaign_integration"!==L.source||(g.webinarIntegration=new Promise((function(e){return store.findAll("webinar").then((function(t){e(t)}),(function(){e()}))})))),Lyte.resolvePromises(g).then((function(e){if(n)if(y.wizard=e.wizard,y.wizard&&y.wizard.length){var a=y.wizard.filter((function(e){var t=Crm.userDetails.PROFILE_ID;return"team_based"===moduleRecordMapping[i].access_type&&(t=moduleRecordMapping[i].private_profile.id),!!(e.profiles.mapBy("id").contains(t)||window.clientPortalName&&e.portal_user_types.mapBy("id").contains(t))}));y.wizard=a}else store.unloadRecord("wizard-container",t);else y.layout=e.layout;if(e&&e.layout_rules&&e.layout_rules.layout_rule){for(var r=e.layout_rules.layout_rule.length,o=0;o<r;o++)e.layout_rules.layout_rule[o].id=t+"_"+o,e.layout_rules.layout_rule[o].layout=t;store.pushPayload("layout_rule",e.layout_rules.layout_rule),y.layout_rule=e.layout_rules.layout_rule}return(void 0===Crm.userDetails.VALIDATIONRULEAVAILABLE||!0===Crm.userDetails.VALIDATIONRULEAVAILABLE&&Crm.userDetails.VRINVOLVEDMODULES.contains(i))&&(y.validation_rule=e.validation_rules),e.surveyDepartments&&(y.survey_departments=e.surveyDepartments?e.surveyDepartments.survey_departments:[]),e.webinarIntegration&&(y.webinarIntegration=e.webinarIntegration?e.webinarIntegration[0]:void 0),e.mapDependency&&(y.mapDependency=e.mapDependency),y}))}if(!("Tasks"!=i||store.model[moduleRecordMapping[i].id]&&moduleRecordMapping[i].fields))return store.findRecord("module",moduleRecordMapping.Tasks.id).then(function(e){var t={};return t.moduleapi=a,t.moduleName=i,r?store.findRecord(moduleRecordMapping[i].id,r,{approved:"both",converted:"both"},void 0,!1).then(function(a){var r=a[moduleRecordMapping[i].id][0];return t.layoutId=s||e[0].layouts[0].id,t.wizardId=r.Wizard&&"draft"===r.$state&&!this.transition.data.layoutId?r.Wizard.id:void 0,t.entityId=a,t.isRecursivecall=!0,this.getLayoutPromise(t)}.bind(this)):(t.layoutId=e[0].layouts[0].id,t.wizardId=n,t.entityId=r,t.isRecursivecall=o,t.clonedlayoutId=s,this.getLayoutPromise(t))}.bind(this));if(r){var C={},I={approved:"both",converted:"both"};function E(e){var t,r=e[moduleRecordMapping[i].id][0];if(r){if(!s&&(!r.Layout||validationUtils.isEmpty(r.Layout))){var o=moduleRecordMapping[i].layouts.filter((function(e){return e.status>=0||"active"===e.status}))[0];t=o?o.id:t}if(this.isInventoryModule(i)&&moduleRecordMapping.PriceBooks){var n={Invoices:"Invoiced_Items",PurchaseOrders:"Purchase_Items",SalesOrders:"Ordered_Items",Quotes:"Quoted_Items"}[i],l=[];if(r&&r.hasOwnProperty(n)&&r[n]&&r[n].length&&r[n].forEach((function(e){e&&e.Price_Book_Name&&e.Price_Book_Name.id&&l.push(e.Price_Book_Name.id)})),l.length){var d=new Promise((function(e){return store.model[moduleRecordMapping.PriceBooks.id]||store.registerModel(moduleRecordMapping.PriceBooks.id,{},{extends:"entity"}),store.findAll(moduleRecordMapping.PriceBooks.id,{ids:l.toString(),approved:"both"}).then((function(){e("success")}),(function(){e("failure")}))}));Lyte.resolvePromises(d).then(function(e){this.invPriceBookBulkResponse=e}.bind(this))}}var c,y={};y.layoutId=s||(t||r.Layout.id),y.moduleapi=a,y.moduleName=i,y.entityId=e,y.isRecursivecall=!0,f?("clone"===_&&(y.wizardId=!validationUtils.isNotEmpty(r.Wizard)||!m||m.layoutId||"draft"!==r.$state&&"save"!==r.$state?void 0:r.Wizard.id),c=p):(this.transition&&"crm.tab.module.entity.clone"!==this.transition.info.route&&(y.wizardId=!validationUtils.isNotEmpty(r.Wizard)||this.transition.data.layoutId&&(!m||m.layoutId)||"draft"!==r.$state&&"save"!==r.$state?void 0:r.Wizard.id),c=this.getQueryParams()),y.dataObject=u;var g=f?m.isWizardNotAvailable:this.transition.data.isWizardNotAvailable;if(c.wizardId||!y.wizardId||g)return this.getLayoutPromise(y);{let e={...c,wizardId:y.wizardId};return"draft"===r.$state&&(e.state=r.$state),f||(this.replaceWith({route:this.transition.info.route,dynamicParams:this.transition.info.dynamicParams,queryParams:e}).data={isWizardRouteSwitch:!0,previousTrans:app.historyLength<=1?{}:Lyte.deepCopyObject(app.prevTransition)}),{isWizardRouteSwitch:!0,previousTrans:app.historyLength<=1?{}:Lyte.deepCopyObject(app.prevTransition)}}}this.isRecordUnAvailableError=!0}function R(e){var t=e&&e.responseText||void 0;if((t=t&&"string"==typeof t?JSON.parse(t):t)&&"NO_PERMISSION"===t.code)return f||(crmHistory.handleAjaxErrorLyte=!0),renderingUtils.displayPermissionDenied(),this.permissionDeniedForModule=!0,void(f||this.transition.abort())}return C.requestFrom=m&&Crm.renderDVLyteFlow(i)?m.reqFrom:void 0,C.resetSubformDataForEntity=!0,this.isInventoryModule(i)&&(C.invRECORDSversion="v4"),u&&u.entityRequestCustomData&&Object.assign(C,u.entityRequestCustomData),u&&u.entityRequestQueryParams&&Object.assign(I,u.entityRequestQueryParams),u&&u.substituteResponse&&u.substituteResponse.entityResponse?new Promise(function(e){var t=u.substituteResponse.entityResponse,a={};Array.isArray(t)?(a[moduleRecordMapping[i].id]=t,a.meta=t[0]._$):t.hasOwnProperty(moduleRecordMapping[i].id)&&t.hasOwnProperty("meta")?a=t:(a[moduleRecordMapping[i].id]=[],a[moduleRecordMapping[i].id].push(t),a.meta=t._$),e(E.call(this,a))}.bind(this)):store.findRecord(moduleRecordMapping[i].id,r,I,void 0,!1,C).then(function(e){return E.call(this,e)}.bind(this),function(e){return R.call(this,e)}.bind(this))}},lastZorFieldsAndValue:{},lockedbyCR:new Set,getZORFromDI:function(e){var t=$L("crm-create-layout")[0],a=t.getData("lastZorFieldsAndValue"),i=t.getData("zorFieldsVsDatatypes"),r=Object.keys(a);if(null!==r&&0!==r.length){var o,n="multiselectpicklist"===i[r[0]]?"in":"equals",s=void 0===a[r[0]]?null:a[r[0]];"userlookup"!==i[r[0]]&&"entitylookup"!==i[r[0]]||(s=a[r[0]].id?a[r[0]].id:a[r[0]]),o={field:{api_name:r[0]},comparator:n,value:s};for(var l=r.length,d=1;d<l;d++){n="multiselectpicklist"===i[r[d]]?"in":"equals",s=void 0===a[r[d]]?null:a[r[d]],"userlookup"!==i[r[d]]&&"entitylookup"!==i[r[d]]||(s=a[r[d]].id?a[r[d]].id:a[r[d]]),o={group:[o,{field:{api_name:r[d]},comparator:n,value:s}],group_comparator:"and"}}var c=$L("crm-create-layout")[0].component;c.setData("isFetchingSuggestion",!0);return store.triggerAction("zia_reasoning","zia_suggested_users",void 0,{module:this.getData("moduleData.api_name"),record_criteria:o,include_inner_details:"user.full_name,user.email,user.role,user.profile,user.image_link,user.zuid"},"GET").then((function(t){if(void 0===t||void 0===t.zia_suggested_users)return c.setData({zorAvailable:!1,isFetchingSuggestion:!1}),void(e&&c.showRecommendationPop());for(var a=t.zia_suggested_users[0],i=JSON.parse(JSON.stringify(a.zia_suggested_users)),r=i.length,o=c.getData("restriction_enabled_for_module"),n=c.getData("zia_threshold_enabled_for_module"),s=!0,l=JSON.parse(JSON.stringify(a.fields_considered)),d=0;d<r&&s;d++){var u=i[d];if(!o&&!n)if(u.assignment_allowed){var m={};m.confidence_percentage=u.confidence_percentage,m.user={id:u.user.id};var p={fields_considered:l,zia_suggested_users:[m]};u.abz_details=p,Lyte.arrayUtils(i,"removeAt",d,1),c.setData({recommendedOwner:u,zorAvailable:!0,otherRecommendations:i,zORViewed:!1}),s=!1}else u.thresholdExpired=!0}s&&c.setData("zorAvailable",!1);for(var f=l.length,_=[],y=0;y<f;y++){if(l[y].field)store.peekRecord("field",l[y].field.id)&&_.push(l[y])}if(f=_.length,$L("crm-create-layout")[0].component.setData("factConLen",f),f>0){var g=[];for(y=0;y<f;y+=2){var v=[];null!==_[y].field&&(_[y].field.field_label=store.peekRecord("field",_[y].field.id).field_label,v.push(_[y]),y<f-1&&null!==_[y+1].field&&(_[y+1].field.field_label=store.peekRecord("field",_[y+1].field.id).field_label,v.push(_[y+1])),g.push(v))}c.setData("fcGrp",g)}for(var h=Lyte.deepCopyObject(a.zia_suggested_users),D=(f=h.length,[]),b=0;b<f;b++){(u=h[b]).user.is_zia_suggested_user=!0,u.user.confidence_percentage=u.confidence_percentage,u.user.fields_considered=l,D.push(u.user)}c.setData("zia_suggested_users",a),c.setData("isFetchingSuggestion",!1),c.setData("recommendedUsersList",{users:D,label:I18n.getMsg("Zia Suggestion")}),e&&c.showRecommendationPop()}),(function(){c.setData("zorAvailable",!1),c.setData("isFetchingSuggestion",!1),e&&c.showRecommendationPop()}))}this.setData("zorAvailable",!1)},showRecommendationPop:function(e){var t,a;e?(a=this,t=$L("crm-user-wrapper")[0].component.data.userRecord.id):t=(a=$L("crm-create-layout")[0].component).data.dataBind.Owner&&a.data.dataBind.Owner.id?a.data.dataBind.Owner.id:Crm.userDetails.USER_ID;var i=!1;t!==a.data.recommendedOwner.user.id&&(i=!0);var r=$L("#zorTabs")[0];r&&r.openTab("recommendedUser"),a.setData({isQC:e,ownerAssigned:i,showZORPop:!0})},triggerZiaOwnerRecommendation:function(e,t){if(!Crm.userDetails.CLIENT_ACCOUNT){for(var a,i=this.getData("initRoute"),r=this.getData("dataBind"),o=$L("crm-create-layout")[0],n=o?o.getData("isMandatoryFieldsValid"):{},s=o.component.data.moduleData.fields,l=s.length,d=!1,c=0;c<l;c++)if("Owner"===s[c].api_name&&s[c].read_only){d=!0;break}for(var u=Object.keys(r.$.model.fieldList),m=u.length,p=0;p<m;p++)if(!0===r.$.model.fieldList[u[p]].mandatory&&"Owner"!==u[p]){var f=r[u[p]];n[u[p]]=!0,validationUtils.isEmpty(f)&&(n[u[p]]=!1)}this.setData("mandFields",R),o&&o.setData("isMandatoryFieldsValid",n);var _=Object.values(n),y=0,g=_.length;for(c=0;c<g;c++)!1===_[c]&&y++;if(a=o.getData("isZORRequestSent")||y<=1,"create"!==i&&"clone"!==i||!a||d)t&&this.showRecommendationPop();else{var v,h=Object.keys(this.data.zorContributingFields),D=(g=h.length,o?o.getData("lastZorFieldsAndValue"):{}),b=o?o.getData("zorFieldsVsDatatypes"):{};this.recordObj={};for(c=0;c<g;c++){var L=r[h[c]];if(void 0!==r.$.model.fieldList[h[c]]){var C=r.$.model.fieldList[h[c]].fieldType;b[h[c]]=C,this.setData("zorFieldsVsDatatypes",b);var I=!1;"picklist"===C?"-None-"!==L&&(I=!0):I=!0,L&&I&&(r.$.error&&r.$.error[h[c]]?v=r.$.error[h[c]].value:("lookup"===C&&(L=L.id),v=L),"boolean"!==C&&!v||!o||!validationUtils.isEmpty(D)&&D[h[c]]===v||("boolean"===C||v?D[h[c]]=v:delete D[h[c]],this.setData("lastZorFieldsAndValue",D),!0,o.setData({isDataChangedAfterLastRequest:!0,isAllManFieldsFilled:!0})))}}if(!o.getData("isZORRequestSent")&&a){var E=o.getData("isAllManFieldsFilled");if(void 0!==E&&!E){var R=Object.keys(n);g=R.length;for(c=0;c<g;c++)n[R[c]]&&(D[R[c]]=r[R[c]]);o.setData("lastZorFieldsAndValue",D)}}!o.getData("isZORRequestSent")||o.getData("isDataChangedAfterLastRequest")&&e?(o.setData({isZORRequestSent:!0,isDataChangedAfterLastRequest:!1}),clearTimeout(this.zorDITimeout),this.zorDITimeout=setTimeout(function(){this.getZORFromDI(t)}.bind(this),100)):t&&this.showRecommendationPop()}}},recordObj:{},getModulePromise:function(e){var t,a,i,r,o,{layoutId:n,moduleapi:s,moduleName:l,entityId:d,wizardId:c,clonedlayoutId:u,isOldFlow:m,modeType:p,isPortalPreview:f,dataObject:_,transData:y,queryParamsInfo:g,isThroughQc:v,formViewTypeInfo:h}=e,D=!1,b={},L={},C={layoutId:n,moduleapi:s,moduleName:l,entityId:d,wizardId:c,clonedlayoutId:u,isOldFlow:m,modeType:p,isPortalPreview:f,dataObject:_,transData:y,queryParamsInfo:g,isThroughQc:v,formViewTypeInfo:h};if(C.isRecursivecall=!!c,b.batchRequest1=this.getLayoutPromise(C),!("Activities"===l||"Calls"===l||"Tasks"===l||"Events"===l||"Services"===l||"Appointments"===l||"Activities"===l||l.startsWith("Orchestration")||l.startsWith("PathFinder")||_&&_.skipRequest&&_.skipRequest.custom_button)){t=!0,store.clearCachedQuery("custom_button",{module:s});let e=Lyte.registeredMixins["crm-view-utils"];L.custom_button=new Promise((function(t){return e.getCustomButtonApiPromise({moduleApiName:s,fields:"id,name,description,profiles,layouts,sequence_number,position,details,user_types,action"}).then((function(e){t(e)}),(function(){t()}))}))}var I=void 0!==moduleRecordMapping&&moduleRecordMapping[l]?moduleRecordMapping[l].fields:void 0;if(I&&I.filter((function(e){("subform"===e.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===e.data_type)&&void 0===store.peekRecord("module",e.subform.id)&&(o=e.subform.id)})),void 0!==o&&(L.subform=new Promise((function(e){app.store.makeRequest("findAll","module").then((function(t){e(t)}),(function(){e()}))}))),!Crm.userDetails.CLIENT_ACCOUNT&&"object"==typeof Crm&&Crm.isZiaOwnerRecommendationEnabled){D=!0;var E=moduleRecordMapping[l].api_name;L.zorContributingFields=new Promise((function(e){return store.findAll("owner_suggestion_configuration",{module:E},!1,!0).then((function(t){if(null===t||t.length<1)D=!1,e();else{var a=Object.assign({},t[0]);if(a.enabled&&a.enabled_for_current_user)return store.triggerAction("zia_reasoning","zia_assignment_suggestions",void 0,{module:E},"GET").then((function(t){var a={};if(JSON.stringify(t)===JSON.stringify({}))D=!1,e();else{for(var i=t.zia_assignment_suggestions,r=i.length,o=0;o<r;o++){var n=i[o];if("current_model"===n.type)for(var s=n.contributing_fields.length,l=0;l<s;l++){var d=n.contributing_fields[l];d.enabled&&null!==d.field&&null!==d.score&&(a[d.field.api_name]=!0)}}JSON.stringify(a)!==JSON.stringify({})?e(a):(D=!1,e())}}),(function(){D=!1,e()}));D=!1,e()}}),(function(){D=!1,e()}))}))}"Potentials"!=l&&"Deals"!=l||(a=!0,L.fc_category=new Promise((function(e){return Lyte.registeredMixins["crm-detailcanvas-utils"]&&Lyte.registeredMixins["crm-detailcanvas-utils"].isFormViewCommonCheck()||"FormView"===Lyte.Router.getRouteInstance().getQueryParams().feature?(n=n||Lyte.Router.getRouteInstance().getQueryParams().layoutId,store.findAll("stage",{module:"Deals",layout_id:n},!0).then((function(t){e(t)}),(function(){e()}))):store.findAll("dummy",{module:"Deals"},!1,!1,{url:"/crm/v2.1/settings/stages"}).then((function(t){e(t)}),(function(){e()}))})));var R=RebrandLinkUtil.getProperty("DeploymentLocation");if("Accounts"!==l||"China"!==R||Crm.userDetails.CLIENT_ACCOUNT||(i=!0,L.skyEyeIntegration=new Promise((function(e){return store.findAll("dummy",{},!1,!1,{url:"/crm/v2/__internal/settings/skyeye"}).then((function(t){e(t)}),(function(){e()}))}))),this.isInventoryModule(l)&&(r=!0,L.getOrgTax=new Promise((function(e){return store.findAll("tax-detail").then((function(t){e(t)}),(function(){e()}))})),moduleRecordMapping.Products&&moduleRecordMapping.Products.id)){var S=this;L.getProductModule=new Promise((function(e){return store.findRecord("module",moduleRecordMapping.Products.id).then((function(t){if(S.transition&&S.transition.data&&S.transition.data.generatePOactionData){var a=S.transition.data.generatePOactionData;return new Promise((function(i){return store.findAll(moduleRecordMapping.Products.id,{ids:a.idList,approved:"both"},!1,!1).then((function(a){S.transition.data.generatePOactionData.productRecords=a[moduleRecordMapping.Products.id],i(a),e(t)}),(function(){i(),e(t)}))}))}e(t)}),(function(){e()}))}))}if(validationUtils.isNotEmpty(Crm.userDetails.CURRENCY_DETAILS)){var F=store.peekRecord("user",Crm.userDetails.USER_ID);F&&!F.Currency&&(L.currentUser=new Promise((function(e){return store.findRecord("user",Crm.userDetails.USER_ID).then((function(t){e(t)}),(function(){e()}))})))}return"true"!==window.isSandboxAcc&&d&&l.match(/^(Leads|Contacts|Vendors|CustomModule[0-9]{0,})$/gm)&&(CLIENT_PORTAL_NAME&&"dummyValue"!==CLIENT_PORTAL_NAME||Crm.userDetails.CLIENT_PORTAL_NAME)&&(L.available_actions=new Promise((function(e){return networkUtils.lyteInitiateRequest("/crm/v2.2/"+s+"/"+d+"/actions/available_actions","GET").then((function(t){e(t)}),(function(){e()}))}))),"Services"===l&&(L.servicesRequest=new Promise((function(e){var t={};return t.businessHours=store.findAll("business_hours"),t.holidays=store.findAll("holidays"),Lyte.resolvePromises(t).then((function(t){Lyte.registeredMixins["crm-services-mixin"].setBusinessHoursAndHolidays(),e(t)}))}))),b.batchRequest2=Lyte.resolvePromises(L).then((function(e){var o={};return t&&(o.custom_button=e.custom_button),a&&(o.fc_category=e.fc_category),i&&(o.skyEyeIntegration=e.skyEyeIntegration),D&&(o.zorContributingFields=e.zorContributingFields,o.zorEnabled=!0),e.available_actions&&(o.available_actions=e.available_actions),r&&(o.orgTaxDetails=e.getOrgTax),o.currentUser=store.peekRecord("user",Crm.userDetails.USER_ID),o})),Lyte.resolvePromises(b).then((function(e){for(var t={},a=1;a<=2;a++)for(var i in e["batchRequest"+a])t[i]=e["batchRequest"+a][i];return t}))},hideEmptySection:function(e,t){var a=this.getData("initRoute"),i=this.data.currentInstObjKey,r=e.fields,o=!1,n=r.length,s="clone"===this.data.initRoute?"create":s;if(t){for(l=0;l<n;l++)if(r[l]&&r[l].visible&&!r[l][i].isHiddenViaAccesiblity&&r[l].view_type[s]){o=!0;break}o||Lyte.Component.set(e[i],"isCustomHidden",!0)}else{for(var l=0;l<n;l++)if(r[l]&&r[l].visible&&Lyte.Component.registeredHelpers.getViewtype(r[l].view_type,a)){o=!0;break}o||(Lyte.Component.set(e[i],"isvalidSection",!1),e[i].haveValidFields=!1)}},haveValidFldsinSection:function(e,t){for(var a=this.getData("initRoute"),i=this.data.currentInstObjKey,r=e.fields,o=!1,n=r.length,s=0;s<n;s++)r[s]&&r[s].visible&&Lyte.Component.registeredHelpers.getViewtype(r[s].view_type,a)&&(o=r[s].api_name!=t,e[i].haveValidFields=!0);return o},getuserCurrencydata:function(e,t,a){var i,r={};if(a&&a.Currency)i=a.Currency;else{var o=store.peekRecord("user",Crm.userDetails.USER_ID);i=o?o.Currency:void 0}var n=(i=e||i)||(Crm.userDetails.IS_MULTI_CURRENCY_ENABLED?Crm.userDetails.PREFERRED_CURRENCY||Crm.userDetails.BASE_CURRENCY||"":Crm.userDetails.defaultOrgCurrency||Crm.userDetails.BASE_CURRENCY||"");r.currentCurrency=n,r.currencyDetails=Crm.userDetails.CURRENCY_DETAILS;var s={};for(var l in Lyte.Component.registeredHelpers.isNotEmpty(r.currencyDetails)||(n&&"string"==typeof n?s.symbol=n:s=n),r.currencyDetails)if(l===r.currentCurrency||r.currencyDetails[l]&&r.currencyDetails[l].symbol===r.currentCurrency){(s=r.currencyDetails[l]).key=l;break}var d=s?s.er&&s.decimals?Number(s.er).toFixed(s.decimals):s.er:"";s&&d&&(s.updatedER=d),s&&Object.keys(s).length||((s=s||{}).symbol=n),s&&(s=Lyte.deepCopyObject(s));var c,u=$L("crm-canvas-form"),m=Lyte.Router.getRouteInstance()&&Lyte.Router.getRouteInstance().transition.info.route,p=Lyte.Router.getRouteInstance()&&Lyte.Router.getRouteInstance().getQueryParams()&&!!Lyte.Router.getRouteInstance().getQueryParams().wizardId&&u.length;if("crm.tab.module.create.canvas"===m||"crm.tab.module.entity.edit.canvas"===m||"crm.tab.module.entity.clone.canvas"===m||p){var f=u[0].component.data.record;c=f?f.__currencyERValues:{}}else c=this.data&&this.data.dataBind?this.data.dataBind.__currencyERValues:{};return c&&""!==c&&c.Currency===s.key&&c.Exchange_rate!==s.er&&(s.er=c.Exchange_rate),s},expandTextarea:function(e,t,a,i,r){var o,n=$(e),s=!(!this.data||!this.data.isdefaultInvSubform||"ITEMDESCRIPTION"!==this.data.columnName),l="subform"==a?165:354,d=18,c=0,u=0,m=n.val(),p=n.parents("lyte-input");$L.fastdom.measure((function(){p&&p[0]&&(u=p[0].clientWidth),i&&(i.style.width=u+"px",i.textContent=m,o=i.offsetHeight)})),$L.fastdom.mutate(function(){if(0==o&&t&&"focus"==t.type)c=s?3*d+12:3*d;else if(0==o&&t&&"focusout"==t.type)c=d;else{c=d*(o/d)+3*d,"subform"===a&&o&&(this.data.databindSubform.expandTAonDrag=!0)}"subform"===a&&t&&"focusout"===t.type&&(c=o<d?d=s?66:d:o+36);var e=c>=l?l:c;r.__multiline_max_height&&r.__multiline_max_height>e&&(e=c>=r.__multiline_max_height?r.__multiline_max_height:c),n.css("height",e),p&&p.css("height",e)}.bind(this))},fillEmptyRowForNonMandatedSubform:function(){var e=document.querySelectorAll("crm-create-subformsection"),t=e?e.length:0;if(t>0)for(var a=0;a<t;a++){var i=e[a],r=i.component.data;if(0===r.dataBind[r.apiName].length&&!r.isMandatorySubform){var o=i.component.$node.component.data,n=store.createRecord(o.subformId,{},!0);r.dataBind[r.apiName].add(n),(Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.isSubformNewComponentEnabled||Crm.userDetails.SUBFORM_PERMISSIONS)&&(r.newRecordIds=[],r.newRecordIds.push(n.id))}}},validateSubformData:function(e,t,a){if(t||a||!this.getData("isQuickCreate")&&"quickCreate"!==this.data.globalData.formType){var i=(t||a)&&$("crm-canvas-form"),r=(t||a)&&i[0]?i[0].component.data.currentInstObjKey:this.data.currentInstObjKey;if(Crm.userDetails.isMandatorySubFormEnabled){var o=document.querySelectorAll("crm-create-subformsection"),n=o?o.length:0;if(n>0)for(var s=0;s<n;s++){var l=!1,d=o[s],c=d.component.data,u=c.subformsectionData[r].isvalidSection,m=($L(d).find(".uploadDoc"),c.subformFileUploadFieldIds),p=[],f=!1;if(a&&void 0===c.subformsectionData[r].isvalidSection&&(u=!0),objectUtils.getLength(m)>0&&(p=objectUtils.getKeys(m),f=!0),u||t){var y=c.subFieldsarray,g=y.length,v=c.dataBind[c.apiName];if(0===v.length&&!c.isMandatorySubform){var h=d.component.$node.component.data,D=store.createRecord(h.subformId,{},!0);Object.defineProperty(D,"$dummyRow",{writable:!0,configurable:!1}),Lyte.Component.set(D,"$dummyRow",!0),D.$.addEventListener("change",(function(e,t){e.$dummyRow&&"show"!==t&&Lyte.objectUtils(e,"delete","$dummyRow")})),c.cacheRecordIds.push(D.id),c.dataBind[c.apiName].add(D),v=c.dataBind[c.apiName],(Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.isSubformNewComponentEnabled||Crm.userDetails.SUBFORM_PERMISSIONS)&&(c.newRecordIds=[],c.newRecordIds.push(D.id))}for(var b=_.clone(v),L=b.length,C=0;C<L;C++){for(var I=!1,E=0;E<g;E++)if(!y[E].subform){if(b[C]&&b[C].lookupError&&133===y[E].ui_type&&b[C].lookupError[y[E].api_name]){I=!0;break}if(!(116===y[E].ui_type&&void 0===v[0][y[E].api_name]||"SERIAL_NUMBER"===y[E].column_name||2===y[E].ui_type&&("-None-"===b[C][y[E].api_name]||""===b[C][y[E].api_name])||100===y[E].ui_type&&"[]"===b[C][y[E].api_name]||void 0===b[C][y[E].api_name])){if(validationUtils.isEmptyString(b[C][y[E].api_name])||"boolean"===y[E].data_type&&!b[C][y[E].api_name])continue;if(555===y[E].ui_type){for(var R=b[C][y[E].api_name],S=R?R.length:0,F=0;F<S;F++)if(void 0!==R[F].file_id||void 0!==R[F].file_Id){I=!0;break}}else I=!0;if(I)break}}if(I){l=!0;var O=c.dataBind&&c.dataBind.$approval_state&&("approval_process_pending"===c.dataBind.$approval_state||"approval_process_rejected"===c.dataBind.$approval_state)&&c.dataBind.$editable;for(T=c.mandatoryFields,r=c.currentInstObjKey,M=T.length,P=0;P<M;P++){var k=O&&Lyte.registeredMixins.approvalprocess.disableGuidedSellingInAp(c.dataBind,c.moduleInfo)&&Lyte.registeredMixins.approvalprocess.skipMandatoryFieldCheck(c.moduleInfo,c.dataBind,P.id,!0);(J=e[c.apiName][0].$.model.fieldList[T[P].api_name]).mandatory=!k,store.addField(e[c.apiName][0].$.model._name,T[P].api_name,J.type,J,!1),e[c.apiName][0].$.model.fieldList[T[P].api_name].mandatory=!k}}else if(v.length>1){Lyte.arrayUtils(c.cacheRecordIds,"removeAt",c.cacheRecordIds.indexOf(b[C].id),1),v.remove(b[C]);var w=$(o)[s].component;v.length<c.subformsectionData.properties.maximum_rows&&w.setData("disableAddBtn",!1)}else if(1===v.length){var N=b[C].$dummyRow;Lyte.Component.set(b[C],"show",!0),Lyte.Component.set(b[C],"$dummyRow",N);for(var T,M=(T=c.mandatoryFields).length,P=0;P<M;P++){(J=e[c.apiName][0].$.model.fieldList[T[P].api_name]).mandatory=!1,store.addField(e[c.apiName][0].$.model._name,T[P].api_name,J.type,J,!1)}var A=c.cscriptMandatoryFlds;let t=A.length;for(let a=0;a<t;a++)e[c.apiName][0].$.model.fieldList[A[a].api_name].mandatory=!1,store.addField(e[c.apiName][0].$.model._name,A[a].api_name,e[c.apiName][0].$.model.fieldList[A[a].api_name].type,e[c.apiName][0].$.model.fieldList[A[a].api_name])}}if(f){var U={},x=v.length;if(p.length>0){for(var V=p.length,B=0;B<V;B++)for(var j,Y=m[j=p[B]],q=0;q<x;q++){var z=v[q][Y];if(z){var W=z[0];if(W){var H=W.file_id;fileupload.uploadedFileObject.forEach((function(e){j===e.fieldId&&e.encryptedUploadId===H?(U[j+"_"+(q+1)]=fileupload.uploadDeleteObject[j+"_"+e.rowNum],e.rowNum=q+1+""):""!==e.rowNum?U[e.fieldId+"_"+e.rowNum]=fileupload.uploadDeleteObject[e.fieldId+"_"+e.rowNum]:U[e.fieldId]=fileupload.uploadDeleteObject[e.fieldId]}))}}}fileupload.uploadDeleteObject=U}}if(l)for(Q=(K=c.mandatoryAggregateFields).length,G=0;G<Q;G++){(J=e.$.model.fieldList[K[G].api_name]).mandatory=!0,store.addField(e.$.model._name,K[G].api_name,J.type,J,!1)}else for(var K,Q=(K=c.mandatoryAggregateFields).length,G=0;G<Q;G++){var J;(J=e.$.model.fieldList[K[G].api_name]).mandatory=!1,store.addField(e.$.model._name,K[G].api_name,J.type,J,!1)}}}}}},isErrorExistInData:function(e,t,a,i,r){var o=!1,n=this.data.currentInstObjKey,s=this.getData("currsubformApinames");if(validationUtils.isNotEmpty(i))for(var l in i){var d=0;i[l].forEach((function(t){if(e[l][d].id==t.recId){var a=e[l][d].$.model.fieldList;for(var i in t.errorObj)"picklist"!==a[i].fieldType&&"multiselectpicklist"!==a[i].fieldType&&"lookup"!==a[i].fieldType&&"userlookup"!==a[i].fieldType||!("ERR02"===t.errorObj[i].code&&!e[l][d].$.error[i]&&a[i].mandatory||e[l][d].lookupError)||(e[l][d].$.isError=!0,e[l][d].$.error[i]=t.errorObj[i])}d++}))}if(s&&s.length>0){var c=this.data.moduleSections||[];c=(c=this.data.moduleSections.filter((function(e){return e.isSubformSection||"subforms"===e.type})))||[],s.forEach((function(t){var a=c.filter((function(e){return e.subform_apiname===t}))[0];a&&a[n].isvalidSection?void 0!==e[t]&&e[t].forEach((function(e){e.show=!1,Lyte.Component.registeredHelpers.isNotEmpty(e.$.error)&&(o=!0)})):a&&!a[n].isvalidSection&&void 0!==e[t]&&e[t].forEach((function(e){if(validationUtils.isNotEmpty(e.$.error))for(var t in e.$.error)delete e[t];store.$.clrRecErr(e.$)}))}))}var u=Lyte.deepCopyObject(e.$.error||{}),m=[],p=e.$.model.fieldList,f="edit"===this.data.initRoute?"edit":"create";let _=this.data.globalData&&this.data.globalData.min_date_time||"",y=this.data.globalData&&this.data.globalData.min_date||"",g=this.minDateValidator({record:e,min_date:y,min_date_time:_});if(validationUtils.isNotEmpty(g)){u=u||{};for(let t in g)u.hasOwnProperty(t)||e.$.error&&e.$.error.hasOwnProperty(t)||(e.$.error[t]=u[t]=g[t],e.$.isError||(e.$.isError=!0))}for(var v in u){var h=p[v];if(h&&h.fieldID){var D,b=store.peekRecord("field",h.fieldID);if(!this.data.isWizard&&b&&b.section){var L,C=b.section||[],I=C.length;if(1===I&&C[0]&&C[0][n]&&C[0][n].type&&"used"===C[0][n].type)L=C[0];else if(I)for(var E=0;E<I;E++){var R=C[E];if(R&&R[n]&&R[n].type&&"used"===R[n].type){L=R;break}}L&&L[n]&&L[n].hasOwnProperty("isvalidSection")&&!L[n].isvalidSection&&(D=!0)}b&&b&&b.visible&&b.view_type[f]&&!D||(m.push(v),e.__skip_clientOnSaveValidation=!0)}}return m.forEach((function(e){delete u[e]})),e.$.isError&&validationUtils.isNotEmpty(u)||o||validationUtils.isNotEmpty(e.lookupError)?(this.validateSubform(t,a,r),this.failureFun(e.$.error,t,void 0,void 0,void 0,a,r),this.focusErrorField(t),!(t.skipMandatoryCheck&&!t.isValidErrorPresent)):this.checkAllMandatorySubForms(a,t)?void 0:(this.focusErrorField(t),!0)},getLatestErrorFocusField:function(e,t,a,i,r,o,n){return 0==e.prevOfftop||e.prevOfftop>t?(e.prevOfftop=t,e.prevOffLeft=a,e.firstErrorfield=i,e.issubform=r,e.isaggField=o,e.isSubformSection=n):e.prevOfftop==t&&e.prevOffLeft>a&&(e.prevOfftop=t,e.prevOffLeft=a,e.firstErrorfield=i),e},setErrorObject:function(e,t,a,i,r,o){if(t.isError=!0,o)return!0;if(a){var n=$L(e).parents("crm-create-subformsection")[0];n&&!n.component.data.aggerrorDetails&&Lyte.Component.set(n.component.data,"aggerrorDetails",{}),Lyte.Component.set(n.component.data.aggerrorDetails,i,t),r||(e.querySelector("input").classList.add("cuserrorAborder"),e.classList.add("lcAggError"))}else Lyte.Component.set(e.component.data,"errorDetails",t)},setMutltiselectErrorObject:function(e,t){Lyte.Component.set(e.component.data,"multiSelectErrorDetails",t.errorDetails)},focusErrorField:function(e){var t=this;$L.fastdom.measure((function(){if(e&&e.firstErrorfield){if(e.firstErrorfield.component&&e.firstErrorfield.getData("isNoErrorFocus"))return;if(e.isaggField){var a=e.firstErrorfield;a&&(a.ltProp&&(a.ltProp("readonly")||a.ltProp("disabled"))?a.scrollIntoView({block:"center",behavior:"smooth"}):a.focus())}else{var i,r=!1;if(e.firstErrorfield&&e.firstErrorfield.component){var o=e.firstErrorfield.component.data,n=o.moduledataUicomp?o.moduledataUicomp.data_type:o.subformFields?o.subformFields.data_type:"";if(o.moduledataUicomp&&"Native__Survey__Extn__Survey"==o.moduledataUicomp.api_name)n=(s=e.firstErrorfield.querySelector("lyte-dropdown"))&&"-None-"==s.ltProp("selected")?"picklist":n;switch(e.firstErrorfield.getData("lyteViewPort")&&e.firstErrorfield.setData("lyteViewPort",!1),n){case"multiselectpicklist":i=(s=e.firstErrorfield.querySelector("lyte-dropdown"))?s.querySelector("input"):void 0,s&&s.toggle();break;case"picklist":var s;(s=e.firstErrorfield.querySelector("lyte-dropdown"))&&((i=s?s.querySelector(".lyteDummyEventContainer"):void 0)&&i.focus(),s&&s.toggle());break;case"userlookup":var l=e.firstErrorfield.querySelector("lyte-dropdown");l&&l.toggle();break;default:var d;if(!e.isSubformSection){if([CrmField.UITYPES.SERVICE_TIMING,CrmField.UITYPES.MULTI_DATE_SELECT].contains(e.firstErrorfield.component.getData("uiType"))){r=Lyte.registeredMixins["crm-create-mixin"].handlemultiSelectError(e.firstErrorfield);break}(d=e.firstErrorfield.component.getData("errorDetails"))&&(d.inFocusNow=!0,e.firstErrorfield.component.setData("errorDetails",d))}if(i=e.firstErrorfield.querySelector("lyte-input")){i.blur(),i.focus();var c=$L(i).parents(".FValue");c&&c[0]&&c[0].classList.contains("cuserrorFborder")&&(c[0].classList.remove("cuserrorFborder"),setTimeout((function(){c&&c[0]&&c[0].classList.add("cuserrorFborder")}),500))}else{var u=e.firstErrorfield.getData("moduledataUicomp.data_type");e.isSubformSection&&void 0===u&&(u=o.subformFields.data_type),(Crm.userDetails.isPhoneNoNewView&&"phone"===u||"multiselectlookup"===u)&&e.firstErrorfield.querySelector("input").focus(),e.isSubformSection&&301===o.subformFields.ui_type&&(e.firstErrorfield.component.setData("errorDetails",d),(i=e.firstErrorfield.querySelector("lyte-checkbox"))&&(i.blur(),i.focus())),e.isSubformSection&&555===o.subformFields.ui_type&&(i=e.firstErrorfield.querySelector("lyte-button"))&&i.focus(),"SERVICEDURATION"===e.firstErrorfield.component.getData("columnName")&&"integer"===u&&(i=e.firstErrorfield.querySelector("lyte-dropdown"))&&(i.focus(),i.toggle()),250===o.uiType&&(i=e.firstErrorfield.querySelector("lyte-texteditor"))&&(i.focus(),i.scrollIntoView({block:"center",inline:"nearest"}))}}if((i||l)&&Crm.userDetails.isPinnedColumnEnabled&&e.issubform&&t.onFocusForSubformFields(i||l),o&&!r)(o.moduledataUicomp?o.moduledataUicomp.read_only:!!o.subformFields&&o.subformFields.read_only)&&e.firstErrorfield&&e.firstErrorfield.scrollIntoView({block:"center",behavior:"smooth"})}}}}))},onFocusForSubformFields:function(e){var t,a=0,i=$L(e),r=i.closest("lyte-td"),o=i.closest("lyte-table"),n=o.find(".lyteTableScroll"),s=r[0].getBoundingClientRect(),l=o[0].getBoundingClientRect();if($L(e).closest("lyte-table-structure.createSubFormTable").find("lyte-thead").find("lyte-tr").find("lyte-th").each((function(){var e=$L(this);"enable"===e.attr("fixed")&&(a+=e.outerWidth(),t=this)})),t&&!r.hasClass("lyteTableFixed")&&Crm.userDetails.RTL_ENABLED?s.right>l.right-a:l.left+a>s.left){var d=Crm.userDetails.RTL_ENABLED?-(s.right-(l.right-a)):l.left+a-s.left;n[0].scrollLeft-=d}else if(Crm.userDetails.RTL_ENABLED?s.left<l.left:l.right<s.right){var c=Crm.userDetails.RTL_ENABLED?-(l.left-s.left):s.right-l.right;n[0].scrollLeft+=c}else if(Crm.userDetails.RTL_ENABLED?l.right<s.right:s.left<l.left){c=Crm.userDetails.RTL_ENABLED?-(s.right-l.right):l.left-s.left;n[0].scrollLeft-=c}},rearrangeSubformPinnedFields:function(e){var t=$L("#"+e),a=.6*t.find("lyte-table").eq(0).width(),i=0;t.find("lyte-th").each((function(){var e=$L(this);"true"!==e.attr("pinned-column")&&""!==e.attr("pinned-column")||(i+=e[0].offsetWidth),e[0].id&&""!==e[0].id&&(i>a?(e.attr("fixed",""),store.peekRecord("field",e[0].id).fixed=""):"true"===e.attr("pinned-column")&&(e.attr("fixed","enable"),e[0].id&&(store.peekRecord("field",e[0].id).fixed="enable")))}))},handlemultiSelectError:function(e){var t=e.component.getData("multiselectData").findIndex((e=>e.Error)),a=e.querySelectorAll(".multiselectitem")[t];if(a){var i=a.querySelector("lyte-input");i&&(i.focus(),i.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}))}return!0},handleValidationRuleCondition:function(e,t,a,i,r,o,n,s,l,d,c){var u=e.primary_condition;"Reporting_To"===t&&"Full_Name"===u.field.api_name&&(u.field.api_name=t);var m=i.checkCriteriaMatch(u,r,void 0,a,i,void 0,s,!0);void 0!==m&&("success"===a&&m?i.handleExecutionType(e,t,i,r,a,o,n,l,d,s,c):"failure"!==a||m||i.handleExecutionType(e,t,i,r,a,o,n,l,d,s,c))},handleExecutionType:function(e,t,a,i,r,o,n,s,l,d,c){var u=e.sub_conditions.length,m=a.data.currentInstObjKey,p=store.peekRecord("field",o),f=a.getData("moduleData.additionalFielddata"),_=f?f.picklist:[],y=e.primary_condition.field.api_name;-1!==y.indexOf(".")&&(y=y.split(".")[0]);var g=l?l.length:0,v=!0,h=void 0!==Crm.userDetails.ValidationAlertPreference&&Crm.userDetails.ValidationAlertPreference&&!d;if(u>0)for(var D=0;D<u;D++){var b=e.sub_conditions[D],L=a.checkCriteriaMatch(b.criteria,i,!0,r,a,void 0,d,!0),C=b.criteria.length,I=[];if(C)for(var E=0;E<C;E++)b.criteria[E].field&&I.push(b.criteria[E].field.api_name);else I.push(b.criteria.field.api_name);if(L&&s&&h&&"allow_by_alert"===b.alert_type)if(c)L=!1;else if(s.contains("Layout")&&!s.contains("Wizard"))L=!0;else if(g){for(var R=I.length,S=0;S<R;S++){var F=I[S];if(L=!(!s.contains(y)&&!s.contains(F))&&(!_.contains(y)&&!_.contains(F)||(i.$.getInitialValues(y)!==i.$.get(y)||i.$.getInitialValues(F)!==i.$.get(F))))break}if(g>0&&!L)for(var O=0;O<g;O++){if((k=l[O]).field.api_name===y&&b.id===k.query_id){L=!1;break}L=!0}}else L=!0;if(L&&(n.push({message:b.alert,targetField:t,targetFieldId:o,alert_preference:b.alert_preference,alert_type:b.alert_type,query_id:b.id}),!h)){p[m].isSecVal=!0;break}}else{if(h){if(h&&s&&"allow_by_alert"===e.alert_type)if(c)v=!1;else if(g){if(!(v=!!s.contains(y)&&(!_.contains(y)||i.$.getInitialValues(y)!==i.$.get(y)))&&g>0)for(O=0;O<g;O++){var k;if((k=l[O]).field.api_name===y&&e.id===k.query_id){v=!1;break}v=!0}}else v=!0}else p[m].isSecVal=!0;v&&n.push({message:e.alert,targetField:t,targetFieldId:o,alert_preference:e.alert_preference,alert_type:e.alert_type,query_id:e.id})}},setValidationErrorNew:function(e,t,a,i){var r=i.getData("dataBind"),o=store.peekRecord("module",r.$.model._name),n=i.getData("currentEvent"),s="crm-create-layout#"+o.module_name+"LC_layoutNode",l=$L(s)[0]&&$L(s)[0].component?$L(s)[0].component:$L(s)[0];e.isVRError=!0,l.setData("valRuleFieldIds",void 0),l.setData("valRuleData",e),l.setData("valLayoutData",i),l.setData("valRuleFieldIds",t);var d=$L("crm-validation-alert")[0],c=$L("crm-quick-create-listing")[0],u=!1;if(c){c=c.component,u=!0,d&&d.remove();var m=c.getData("currentLayout.fields");if(m)for(var p=m.length,f=0;f<p;f++){var _=m[f];if(!!t&&t.includes(_.id)){var y=c.getData("moduleName")+"_fldRow_"+_.column_name,g=$L("crm-create-fields#"+y)[0],v=g?g.component.data:void 0;v&&(g&&g.getData("lyteViewPort")&&g.setData("lyteViewPort",!1),Lyte.Component.set(v,"errorDetailsNew",void 0))}}}if(d){var h=d.component;if(h.getData("isStage")){if("save"!==n){var D=h.getData("alertDetails"),b=h.getData("fieldIds");return b&&Lyte.arrayUtils(t,"push",b),D instanceof Object&&Object.keys(D).length>0&&(e={...D,...e}),h.executeMethod("emptyErrorData"),h.setData({alertDetails:e,fieldIds:t,module:o,isStage:!0,isQc:!0,isVRError:!0,popoverDirection:"bottomLeft",dontFocus:a}),void h.executeMethod("setValError")}d.remove()}else if(!u)return h.setData("isWizard",i.getData("isWizard")),void h.executeMethod("setValError")}Lyte.Component.render("crm-validation-alert",{alertDetails:e,fieldIds:t,module:o,isStage:!0,isQc:!0,isVRError:!0,dontFocus:a,popoverDirection:"bottomLeft"},".valRule")},setValidationError:function(e,t,a,i,r){var o=a.getData("moduleData.fields").filter((function(e){return e.id==i}))[0],n=a.getData("module")+"_fldRow_"+o.column_name,s=$L("crm-create-fields#"+n)[0],l={isError:!0};l.inFocusNow=!r,l.isVRError=!0,l.message=$ESAPI.encoder().encodeForHTML(e);var d=a.data.currentInstObjKey;if(!s&&!(s=(s=document.querySelectorAll(".aggField."+t))&&s.length>=1?s[0]:void 0)&&validationUtils.isNotEmpty(o.subform)){var c=a.data.moduleData[d].aggerrorDetails;Lyte.Component.set(a.data.moduleData[d],"aggerrorDetails",validationUtils.isNotEmpty(c)?c:{}),Lyte.Component.set(a.data.moduleData[d].aggerrorDetails,t,l)}if(!!s&&!!s.classList.contains("aggField")){var u=$L(s).parents("crm-create-subformsection")[0];if(u&&!u.component.data.aggerrorDetails&&Lyte.Component.set(u.component.data,"aggerrorDetails",{}),Lyte.Component.set(u.component.data.aggerrorDetails,t,l),r)return;s&&(s.querySelector("input").classList.add("cuserrorAborder"),s.classList.add("lcAggError"),s.getData&&s.getData("ltPropReadonly")?s.scrollIntoView({block:"center",behavior:"smooth"}):s.focus())}else{var m=s?s.component.data:void 0,p="edit"==a.getData("initRoute")?"edit":"create";if(o.view_type[p]&&o.visible&&(!o.read_only||o[d].validate_read_only))if(m){if(s&&s.getData("lyteViewPort")&&s.setData("lyteViewPort",!1),Lyte.Component.set(m,"errorDetails",l),r)return;if("picklist"==o.data_type){var f=s.querySelector("lyte-dropdown");(f=f?f.querySelector(".lyteDummyEventContainer"):void 0)&&(f.focus(),setTimeout((function(){$(f).blur()}),500))}else{var _="boolean"===o.data_type?s.querySelector("lyte-checkbox"):s.querySelector("lyte-input");if(_)_.focus();else if(Crm.userDetails.isPhoneNoNewView&&"phone"===o.data_type)s.querySelector("input").focus();else if("userlookup"===o.data_type){var y=s.querySelector("lyte-dropdown");(y=y?y.querySelector(".lyteDummyEventContainer"):void 0)&&y.focus()}}}else Lyte.Component.set(o[d],"errorDetails",l)}},checkFieldsToValidate:function(e){if(e.moduleData[e.currentInstObjKey].onlyValidateVisibleFields){for(var t=e.moduleFields.length,a=[],i=0;i<t;i++)e.moduleFields[i].visible&&e.moduleFields[i].view_type[e.initRoute]&&a.push(e.moduleFields[i].api_name);return a}},validateCreateform:function(e,t,a,i,r,o,n,s){o=o||event,this.setData("valEvent",o);var l=[];l.push(e,t,a,i,r,o,n,!0),this.setData("validateVar",l),s=s||!1;var d={};if(n&&Object.keys(n).length)for(custDataKeys in n)d[custDataKeys]=n[custDataKeys];var c=$L("crm-validation-alert")[0];if(c){var u=c.component;u.setData("isVRError",!1),u.executeMethod("emptyErrorData")}var m=$(".successVerified");m.length&&m.remove(),this.setData("currentEvent",e),this.setData("currentEventID",a),this.setData("disableFormbuttons",!0);var p=this.getData("dataBind"),f=this.getData("module"),y=this.data.currentInstObjKey,g="crm-create-fields[record-name='"+p.$.model._name+"']",v=$L(g)[0];v&&v.component.checkLayoutrules(v),Lyte.Component.set(this.data.moduleData[y],"surveyTexterrorDetails",{});var h=this.getData("currsubformApinames"),D=this;s&&D.setData("vrPassed",!1);var b=D.getData("isWizard");y=D.data.currentInstObjKey;function L(e){T&&!T[e.id]?M={}:T&&T[e.id]&&(M=T[e.id]);var t={};!e.$.getDirtyAttributes().contains(B.api_name)&&e[B.api_name]&&(t.name=e[B.api_name].name,t.id=e[B.api_name].id,t.$populate_fields_of_lookup=!1,M[B.api_name]=t),M&&!$.isEmptyObject(M)&&(T[e.id]=M)}if(Crm.userDetails.isLookupFilterEnabled&&b){var C=document.querySelector("crm-create-layout").component,I=(te=store.peekRecord("wizard-container",C.data.selectedLayoutid.split(";")[0])).field_array,E=I.length,R="save"===e&&"draft"===p.$state,S="saveasdraft"===e;let t={};for(var F=0;F<E;F++){var O=I[F];if("lookup"===O.data_type&&O.lookup.query_details&&O.lookup.query_details.criteria&&(O.lookup.revalidate_filter_during_edit||R)&&(O[y].selectedId||C.data.dataBind[O.api_name]&&C.data.dataBind[O.api_name].id)&&!S){const e={id:O[y].selectedId||C.data.dataBind[O.api_name].id,name:O[y].lookupSingle||C.data.dataBind[O.api_name].name};p.$.getDirtyAttributes().contains(O.api_name)||(e.$populate_fields_of_lookup=!1),t[O.api_name]=e}else if("userlookup"===O.data_type&&O.lookup.query_details&&O.lookup.query_details.criteria&&(O.lookup.revalidate_filter_during_edit||R)&&p[O.api_name]&&!S){let e={id:p[O.api_name].id,name:p[O.api_name].name||p[O.api_name].full_name};p.$.getDirtyAttributes().contains(O.api_name)||(e.$populate_fields_of_lookup=!1),t[O.api_name]=e}if("subform"===O.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===O.data_type){var k=O.subformFields,w=Crm.userDetails.SUBFORM_PERMISSIONS&&O.subform&&O.subform.id?store.peekRecord("module",O.subform.id):void 0;if(k){for(var N=k.length,T={},M={},P=0;P<N;P++){("lookup"===(B=k[P]).data_type||"userlookup"===B.data_type)&&B.lookup.revalidate_filter_during_edit&&(!w||w&&w.editable)&&p[O.api_name].forEach(L)}t[O.api_name]=T}}}validationUtils.isEmpty(t)||(d.$lookupFilterEditData=t)}else if(Crm.userDetails.isLookupFilterEnabled&&Lyte.registeredMixins["crm-create-init-mixin"].checkLyteConvertionSupport(f)&&window[f]&&"edit"===window[f].currentStatus){var A=document.querySelector("crm-create-layout").component.data.selectedLayoutid;if(A){var U=A.split(";");A=U[0]}var x=this.data.moduleData.fields,V=x.length;let e={};for(F=0;F<V;F++){let t=x[F];if("picklist"!==t.data_type||"-None-"!==p[t.api_name]&&""!==p[t.api_name]||p.$.set(t.api_name,void 0),"lookup"===t.data_type&&t.lookup.revalidate_filter_during_edit&&t[y].selectedId&&t.view_type.edit){const a={id:t[y].selectedId,name:t[y].lookupSingle};p.$.getDirtyAttributes().contains(t.api_name)||(a.$populate_fields_of_lookup=!1),e[t.api_name]=a}else if("userlookup"===t.data_type&&t.lookup.revalidate_filter_during_edit&&p[t.api_name]){let a={id:p[t.api_name].id,name:p[t.api_name].name||p[t.api_name].full_name};p.$.getDirtyAttributes().contains(t.api_name)||(a.$populate_fields_of_lookup=!1),e[t.api_name]=a}if(("subform"===t.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===t.data_type)&&t.subformFields){for(k=t.subformFields,w=Crm.userDetails.SUBFORM_PERMISSIONS&&t.subform&&t.subform.id?store.peekRecord("module",t.subform.id):void 0,N=k.length,T={},M={},P=0;P<N;P++){var B;("lookup"===(B=k[P]).data_type||"userlookup"===B.data_type)&&B.lookup.revalidate_filter_during_edit&&(!w||w&&w.editable)&&p[t.api_name].forEach(L)}e[t.api_name]=T}}validationUtils.isEmpty(e)||(d.$lookupFilterEditData=e)}D.clearUIError();var j={};i?this.fillEmptyRowForNonMandatedSubform():this.validateSubformData(p),h&&h.length>0&&h.forEach((function(e){if(j[e]=[],void 0!==p[e]){var t=p[e].model._name,a=store.peekRecord("module",t),i=!(!Crm.userDetails.SUBFORM_PERMISSIONS||!a||a.editable);p[e].forEach((function(t,a){if(!i||t.$.isNew){if(objectUtils.getKeys(t.dummyErrorDetails).each((function(e){Lyte.objectUtils(t.dummyErrorDetails,"delete",e)})),t.lookupError)Object.keys(t.lookupError).forEach((function(i){p[e][a].$.isError=!0,p[e][a].$.error[i]=t.lookupError[i]}));j[e].push({recId:t.id,errorObj:Lyte.deepCopyObject(t.$.error)}),(Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.isSubformNewComponentEnabled||Crm.userDetails.SUBFORM_PERMISSIONS)&&t.$.validate()}else store.$.clrRecErr(t.$)}))}})),D.setData("errorfieldFocused",!1);var Y={firstErrorfield:null,prevOfftop:0,prevOffLeft:0},q="crm-create-avatarupload",z=D.getData("initRoute"),W=document.querySelector(q),H="#photoID",K=W?W.querySelector(H):null,Q=store.peekRecord("module",p.$.model._name),G="layComp"+y,J="crm-create-layout#"+Q.module_name+"LC_layoutNode."+G,Z=$L(J)[0];G="layComp"+y,J="crm-create-layout#"+Q.module_name+"LC_layoutNode."+G;if(Z){Z.setData("disableFormbuttons",!0);var X=Z.component.data.avatarApiname;if(K&&K.value||!X||!p[X]||!W?Z.component.data.isWizard&&""===Z.component.data.recordImagePhotoId&&p.$.set(X,null):p.$.set(X,null),Z.component.data.isWizard){var ee=Z.component.data.currentWizardButton;ee&&"custom_button"===ee.category&&"save"===ee.type&&$L("#crm_create_saveasdraftbutn").hide();var te,ae=[];if((te=store.peekRecord("wizard-container",Z.component.data.selectedLayoutid.split(";")[0]))&&te.chart_data){ae=te.chart_data.screen_connections;var ie=Z.getData("screenHistory"),re=(ie=ie||[]).map((e=>e.id)),oe=[];if(re.length>1){var ne="save"!==e||i?re.length:re.indexOf(Z.getData("activeScreen.id"));for(F=0;F<ne;F++){var se=re[F],le=re[F+1];for(var de in ae)if(ae[de].source_screen.id===se&&ae[de].target_screen.id===le){oe.push(de);break}}}p.$.set("$wizard_connection_path",oe)}}try{if("edit"===z&&Lyte.registeredMixins["crm-create-mixin2"].isEmailFieldModifiedForCustomSharingAlert(Z)){let e=Lyte.registeredMixins["email-sharing-alert"];if(e&&e.showCustomEmailSharingAlert("EMAIL"))return this.setData("disableFormbuttons",!1),void e.checkCustomSharingEnabledForRecord(Z.component.data.dataBind.id,this,this.validateCreateform,arguments)}}catch(e){murphy.error(e)}}if(Z&&p&&(!p.Layout||"object"==typeof p.Layout)&&(b||"edit"!==z||Z.getData("transitionData.layoutId"))){var ce=(U=Z.component.data.selectedLayoutid.split(";"))[0];Lyte.Component.set(p,"Layout",{id:ce}),U[1]&&Lyte.Component.set(p,"Wizard",{id:U[1]})}if(Z&&"edit"!==z&&"Campaigns"===this.getData("module")){var ue=Z.getData("selectedLayoutid").split(";"),me=store.peekRecord("layout",ue[0]);me&&"survey"===me.created_for&&this.setZohoSurveyDetailsInEntity(p)}if("edit"===z&&"Bundles"===this.getData("module")&&p&&p.$.error){var pe=p.$.error;pe.Linked_Products&&"ERR02"===pe.Linked_Products.code&&p.Total_Item_Count>=2&&(delete pe.Linked_Products,p.Linked_Products=p.$._attributes.Linked_Products)}if(this.revertOriginalData(),this.data.moduleData[y].task_rec_rule){var fe={RRULE:this.data.moduleData[y].task_rec_rule};p.$.set("Recurring_Activity",fe)}else"Events"!==this.getData("moduleData").module_name&&delete p.Recurring_Activity;var _e,ye=this.getData("moduleData.fields"),ge=ye.length;for(_e=0;_e<ge;_e++)if(ye[_e]&&"lookup"===ye[_e].data_type){var ve=ye[_e],he=ve.api_name;if(p[ye[_e].api_name]&&ye[_e][y].lookupSingle&&(ye[_e][y].lookupSingle!==p[ye[_e].api_name].name||!p[ye[_e].api_name].id)){ye[_e][y].selectedId&&(Lyte.Component.set(ye[_e][y],"removeSelectedId",!0),Lyte.Component.set(ye[_e][y],"selectedId",""));var De=ye[_e].column_name,be=p.lookupError;if("PARENT_CAMPAIGNID"===De)continue;var Le=ye[_e].lookup?ye[_e].lookup.module.api_name:void 0,Ce=Le&&moduleRecordMapping[Le]?moduleRecordMapping[Le].singular_label:I18n.getMsg("crm.zia.vision.record");be||(be={}),Ce=$ESAPI.encoder().encodeForHTML(Ce);var Ie=I18n.getMsg("crm.label.lookup.norecord",Ce),Ee=" "+I18n.getMsg("crm.label.create.new")+" "+Ce;be[he]={message:Ie,createMsg:Ee},Lyte.Component.set(this.getData("dataBind"),"lookupError",be)}}var Re=p.$&&p.$.model&&p.$.model.fieldList?p.$.model.fieldList:void 0,Se="edit"===z?"edit":"create";if(Re)for(var Fe in Re=Re||{}){if(Re[Fe]&&Re[Fe].fieldID){var Oe=store.peekRecord("field",Re[Fe].fieldID);let e=!1,t=!1;(Re[Fe].mandatory||Oe&&Oe.system_mandatory)&&(t=!0,Oe.system_mandatory&&!i&&(e=!0));var ke=!!Oe&&this.isValidVRFieldForInventory(Oe,this.getData("module"));const a=Oe&&Oe[y]&&Oe[y].isCscriptHidden,r=Oe&&Oe[y]&&Oe[y].isCscriptReadOnly;if(Oe&&(!Oe.visible||!Oe.view_type[Se]||a||r||Oe.read_only&&!ke)&&t){var we=Re[Fe];we.mandatory=e,store.addField(p.$.model._name,Fe,we.type,we)}}"create"!==Se&&"draft"!==p.$state||"CURRENCYISOCODE"!==Re[Fe].columnName||!Crm.userDetails.CURRENCY_DETAILS[p.Currency]||Crm.userDetails.CURRENCY_DETAILS[p.Currency].isActive||(p.$.error[Fe]={code:"inActiveCurrency"},p.$.isError=!0)}var Ne=Re;delete p.__skip_clientOnSaveValidation;var Te=this.checkFieldsToValidate({moduleData:this.data.moduleData,moduleFields:ye,initRoute:z,currentInstObjKey:y});if(Te?p.$.validate(Te):p.$.validate(),Lyte.registeredMixins["crm-uploadfields-mixin"]&&!Lyte.registeredMixins["crm-uploadfields-mixin"].validateAllImageUploadCreateFields()&&(p.$.isError=!0),Lyte.registeredMixins["crm-uploadfields-mixin"]&&!Lyte.registeredMixins["crm-uploadfields-mixin"].validateAllFileuploadCreateFields()&&(p.$.isError=!0),"Bundles"===this.getData("module")&&(this.data.dataBind.$.error.Linked_Products&&"ERR02"===this.data.dataBind.$.error.Linked_Products.code&&this.data.dataBind.Unique_Item_Count<2?this.data.dataBind.$.error.Linked_Products.message=I18n.getMsg("bundles.minimum.product.check",["2",moduleRecordMapping.Products.plural_label,moduleRecordMapping.Bundles.singular_label]):this.data.dataBind.Unique_Item_Count<2&&(p.$.isError=!0,store.$.setRecErr(p.$,"Linked_Products",{code:"ERR02",message:I18n.getMsg("bundles.minimum.product.check",["2",moduleRecordMapping.Products.plural_label,moduleRecordMapping.Bundles.singular_label]),value:this.data.dataBind})),this.data.dataBind.Bundle_Code&&this.data.dataBind.Bundle_Code.includes(" ")&&ye)){var Me=ye.find((e=>"Bundle_Code"===e.api_name)),Pe=Me?Me.field_label:null;Pe&&(p.$.isError=!0,store.$.setRecErr(p.$,"Bundle_Code",{code:"ERR03",message:I18n.getMsg("bundles.field.space.alert",Pe),value:this.data.dataBind.Bundle_Code}))}var $e=!1;if("PriceBooks"===this.getData("module")){var Ae={recordObj:p,compData:Z},Ue=this.validatePricingDetails(Ae,e);$e=!Ue}var xe=!0;if("Services"===this.getData("moduleData").module_name&&(xe=Lyte.registeredMixins["crm-services-mixin"].validateRecordServiceAvailability(p,this.getData("moduleData.fields"),this.getData("quickCreateDataObj").sectionName,this.getData("isQuickCreate"),this.getData("module"))),b&&Z.component.checkAndRemoveErrorsForWizard(p,Z.component,!0),this.isErrorExistInData(p,Y,i,j)||p.isblankSurveyNameError||!xe)return delete p.isblankSurveyNameError,Z.setData("disableFormbuttons",!1),D.getMethods("onQuickCreateValidateFailure")&&D.executeMethod("onQuickCreateValidateFailure",{type:1,from:"layoutRules"}),b&&Z.getData("showSummaryModal")&&Z.setData("showSummaryModal",!1),void o.preventDefault();if($e){if(Z.setData("disableFormbuttons",!1),Ae.pricingDetApiName){for(var Ve,Be=p[Ae.pricingDetApiName]||[],je=Be.length,Ye=0;Ye<je;Ye++){var qe=Be[Ye],ze=Ye+1;if(qe.fromRangeError&&qe.fromRangeError!==I18n.getMsg("crm.alert.selected.rangevalue")?(We("fromRange",ze),Ve=!0):qe.toRangeError&&qe.toRangeError!==I18n.getMsg("crm.alert.selected.rangevalue")?(We("toRange",ze),Ve=!0):qe.discountError&&qe.discountError!==I18n.getMsg("crm.alert.selected.rangevalue")&&(We("discount",ze),Ve=!0),Ve)break}function We(e,t){var a=$L("#PriceBooks_fldRow_PRICINGDETAILS #hrow"+t+" ."+e+"ParentDiv lyte-input")[0];a&&a.focus()}}o.preventDefault()}else{var He;if(void 0!==Lyte.Router.getRouteInstance()&&(He=Lyte.Router.getRouteInstance().currentModel),"true"!==window.isSandboxAcc&&void 0!==He&&He.available_actions){var Ke=He.available_actions.actions.find((function(e){return"portal_user_preference"===e.name}));if(Ke){let e=e=>{let t=store.peekRecord("field",e.invitation_field.id);if(p.$.getDirtyAttributes().contains(t.api_name)){var a=function(){p.$.set(t.api_name,p.$.getInitialValues(t.api_name)),Z.setData("disableFormbuttons",!1)};if(""===p.$.get(t.api_name))return _cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.inv.field.emt",t.display_label),ltPropType:"error",ltPropDuration:3e3}}),void a();if(p.$.getInitialValues(t.api_name).trim()===p.$.get(t.api_name))s?Qe():D.executeValidationRule(D,!!b,Qe,!1,[void 0]);else{var i=function(){s?Qe():D.executeValidationRule(D,!!b,Qe,!1,[void 0])},r=networkUtils.returnDependencyFiles(["zohocrm_clientPortalMiscFuncs.js"],ResourceConstants.CRM);Lyte.injectResources({parent:r},void 0,(function(){CPMF.showInvitaitonFieldEditMessagePopUp(p.id,e.id,i,a)}))}}else s?Qe():D.executeValidationRule(D,!!b,Qe,!1,[void 0])},t=store.peekRecord("user_type",Ke.details.user_type.id);return t&&t.invitation_field?void e(t):void store.findAll("user_type").then((t=>{e(t.find((e=>e.id===Ke.details.user_type.id)))}))}s?Qe():D.executeValidationRule(D,!!b,Qe,!1,[void 0])}else s?Qe():D.executeValidationRule(D,!!b,Qe,!1,[void 0])}function Qe(a){if(a)return _cruxUtils.showCustomMessage({params:{ltPropType:"error",id:"create_record_messagebox",ltPropOffset:{top:"100px"},ltPropDuration:5e3,ltPropMessage:I18n.getMsg("crm.label.vr.function.InternalServerError"),ltPropShow:!0}}),void Z.setData("disableFormbuttons",!1);if(D.getData("vrPassed"))return!0!==Crm.isCalendarSchedule&&Crm.trackSpotLightAction("Validation Rules - Records Invoked",{Module:D.getData("module")}),Z.setData("disableFormbuttons",!1),D.getMethods("onQuickCreateValidateFailure")&&D.executeMethod("onQuickCreateValidateFailure",{type:2,from:"validationRules"}),void o.preventDefault();if(D.getMethods("onQuickCreateValidateSuccess")&&D.executeMethod("onQuickCreateValidateSuccess"),"Potentials"!=D.getData("module")||i||!D.handleOmitedStageInPotential()){var r;"save"!==e&&"saveAndNew"!==e||!Crm.isCpqActivated()||D.getData("isQuickCreate")||!D.executeCPQRules||Crm.userDetails.CLIENT_ACCOUNT||(r=function(){return D.executeCPQRules()});var n=$L("#changeOwner")[0],s=n&&!0===n.component.data.ltPropShow?$L("crm-change-owner"):void 0;if("edit"===D.getData("initRoute")&&s&&s.is(":visible")){var l={},d={},c=p.$.getDirtyAttributes()||[],u=p.$&&p.$.model&&p.$.model.fieldList||{};c.forEach((function(e){e&&u[e]&&u[e].uiType&&8!==u[e].uiType&&D.data.moduleData.fields.filter((function(t){if(t.id===u[e].fieldID){var a=p[t.api_name];if(a){if(24===t.ui_type||202===t.ui_type)a=apiDateFormat(a);else if(786===t.ui_type||333===t.ui_type||14===t.ui_type){var i=Crm.userDetails.TIME_FORMAT;i=i.includes("a")?"HH:mm A":Crm.userDetails.TIME_FORMAT,a=$L.moment(a,Crm.userDetails.DATE_PATTERN.toUpperCase()+"TV"+i).i18N("YYYY-MM-DDTHH:mm:ss")}d[t.api_name]=a}else d[t.api_name]=""}}))})),l.folOwnerAjaxVal=d,s[0].component.data.ajaxEditOwnerValue=l;var m=$L("crm-detail-view");m&&m[0].component&&(m=m[0].component).closeAjaxEdit(!0);var f=$L("#quickCreateSetup");f&&f[0]&&(f=f[0].component).closeQuickCreate()}else{if(D.getData("isQuickCreate"))if(t){var _=t({firstErr_Object:Y,data:p,currentEvent:e,layoutData:Z,isDraft:i,scope:D,evn:o});if(_&&_.then)if(_.then)Promise.resolve(_).then(function(){Ge(i)}.bind(this),(function(){Z.setData("disableFormbuttons",!1)}));else if(_.validateOnly)return}else Ge(i);else if(t||r){var y=t&&t(),g=r&&r(),v=[],h=!1;y&&y.then?v.push(y):!1===y&&(h=!0),g&&g.then&&!h&&v.push(g),Promise.all(v).then(function(){h||Ge(i)}.bind(this),(function(){Z.setData("disableFormbuttons",!1)}))}else Ge(i)}}else Z.setData("disableFormbuttons",!1)}function Ge(t){p.$se_module&&(d.$se_module=p.$se_module);var i=!1,n=D.getData("initRoute"),s=D.getData("moduleData");"create"===n&&Lyte.Component.registeredHelpers.isRequesterTeamModule(s.module_name)&&Crm.client_tracking("Team Module - Requestor Record Created.");var l=D.data.currentInstObjKey;"transition"!==e&&"saveasdraft"!==e||(D.wizard_showHideLoadingDiv(!0),"saveasdraft"===e&&D.removeInvalidLineItemRows(p,Z.component)),t?(delete p.$state,Lyte.Component.set(p,"$state","draft")):"draft"===p.$state&&(i=!0,Lyte.Component.set(p,"$state","save"),commonUtils.showHideLoadingDiv(!0)),!validationUtils.isEmpty(p.Wizard)&&p.$wizard_connection_path&&Lyte.Component.set(p,"$wizard_connection_path",JSON.parse(JSON.stringify(p.$wizard_connection_path))),commonUtils.showHideLoadingDiv(!0),s[l]&&s[l].external_search_acc_CompanyId&&D.setSkyEyeCompanyInRecord(p,s,l);var c=$L("crm-create-layout.layComp"+l)[0],u={};if("edit"===n){if(u.affected_data=!0,s[l]&&s[l].changeOwnerDetails&&s[l].changeOwnerDetails.length){var m,_=s[l].changeOwnerDetails[0];if(validationUtils.isNotEmpty(_)&&validationUtils.isNotEmpty(_.queryParams)){var y=_.queryParams;m=y.related_modules?y.related_modules:[],p.Owner&&p.Owner.id===y.owner_id&&(p.Owner.$notify=y.notify,p.Owner.$related_modules=m)}}}else if("clone"===n&&c){var g=c.component.data,v=Lyte.deepCopyObject(g.initialCreatebject),h=Je(v,p.$.toJSON(),Crm.curr_sub_Form_DetailS&&Crm.curr_sub_Form_DetailS.apiNames[0]?Lyte.deepCopyObject(Crm.curr_sub_Form_DetailS.orgCloneSubformData):void 0,p.$.model.fieldList,g.cscriptOrgValues),L={};if(L.parent_id=g.entityrecordData.id,L.type="POST",D.data.transitionData&&D.data.transitionData.hasOwnProperty("inventoryAutoFillData")){var C=p.$.model.fieldList;for(var I in C=C||{},v)h&&!h.hasOwnProperty(I)&&C.hasOwnProperty(I)&&C[I].fieldID&&-1==="Modified_By,Modified_Time,Created_By,Created_Time".indexOf(I)&&(h[I]=v[I])}L.dataToSend=h,d.cloneData=L}if("create"===n||"clone"===n){var E="owner_recommendation_unavailable",R=null;c&&"assigned_by_zia"===c.getData("zia_owner_assignment")&&(E="assigned_by_zia",R=c.getData("abz_details")),D.setZiaOwnerAssignmentStateInRecord(p,E,R,n,d,s.module_name)}if(s[l]&&s[l].skyEyeIntegrationEnabled)if("edit"===n&&p.$.getDirtyAttributes().includes("Account_Name")&&!s[l].external_search_acc_CompanyId&&p.$skyeye_account_id)p.$.set("$skyeye_account_id","");else if("clone"===n&&p.$skyeye_account_id){!(!d.cloneData||!d.cloneData.dataToSend||d.cloneData.dataToSend.hasOwnProperty("Account_Name"))&&void 0===s[l].external_search_acc_CompanyId&&(d.cloneData.dataToSend.$skyeye_account_id=p.$skyeye_account_id)}var S=D.getData("moduleSections")||[],F="edit"===n?"edit":"create",O=D.constructBeforeEntitySaveData({moduleSections:S,currView:F,currentInstObjKey:l,entityRecord:p});if(O&&O.hasOwnProperty("skipMandatory")&&Z&&Z.setData("skipMandatory",O.skipMandatory),D.data.isWizard){let e=(c=document.querySelector("crm-create-layout")).getData("currentWizardButton");e&&"save"!==p.$state&&("save"===e.type?p.$state="save":p.$state="draft"),d.wizardButtonRecord=e,d.reloadDataForWizard=r}(Crm.userDetails.isSubformNewComponentEnabled||Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.SUBFORM_PERMISSIONS)&&(d.subformVsRemovedRowIds={},d.subformVsCachedRowIds={},d.subformVsNewRowIds={},D.data.isWizard?($L("crm-create-subformsection").each((function(e,t){Crm.subformVsRemovedRowIds[t.component.data.apiName]=t.component.data.removedRowIds,Crm.subformVsCachedRowIds[t.component.data.apiName]=t.component.data.cacheRecordIds,Crm.subformVsNewRowIds[t.component.data.apiName]=t.component.data.newRecordIds})),d.subformVsRemovedRowIds=Crm.subformVsRemovedRowIds,d.subformVsCachedRowIds=Crm.subformVsCachedRowIds,d.subformVsNewRowIds=Crm.subformVsNewRowIds):$L("crm-create-subformsection").each((function(e,t){d.subformVsRemovedRowIds[t.component.data.apiName]=t.component.data.removedRowIds,d.subformVsCachedRowIds[t.component.data.apiName]=t.component.data.cacheRecordIds,d.subformVsNewRowIds[t.component.data.apiName]=t.component.data.newRecordIds}))),D.data.moduleData&&D.data.moduleData[l]&&D.data.moduleData[l].hasOwnProperty("skipPricingDtlsInPayload")&&(d.skipPricingDtlsInPayload=D.data.moduleData[l].skipPricingDtlsInPayload,d.pricingDetApiName=D.data.moduleData[l].pricingDetApiName);var k=D.data.moduleData;if(k&&"Invoices"===k.module_name&&p.hasOwnProperty("Invoiced_Items")&&!t){if(!D.confirmInvoiceCreationWithLowStock(p.Invoiced_Items))return commonUtils.showHideLoadingDiv(!1),Z.setData("disableFormbuttons",!1),void o.preventDefault();commonUtils.showHideLoadingDiv(!0)}if(D.getMethods("updateEntitySaveQp")&&(N=D.executeMethod("updateEntitySaveQp")))for(var w in N)u[w]=N[w];D.getData("module")&&D.getData("module")===moduleApiMapping.Tasks&&((z=(q=$L("crm-task-markascompleted-popup")[0])?q.component.data:void 0)&&z.showNotifyOwnerChecked&&Object.assign(d,q.component.executeMethod("setCustomDataToSendMail")));D&&D.data.qcSkipMandatory&&Z.setData("skipMandatory",D.data.qcSkipMandatory);var N,T={};if("edit"===n){var M,P={},A=p.$.getDirtyAttributes()||[],U={},x=p.$&&p.$.model&&p.$.model.fieldList||{};c&&c.component&&c.component.data&&(T=c.component.data.initialCreatebject||{},P=c.component.data.globalData.originalEntityrecordData||{},c.component.data.transitionData&&validationUtils.isNotEmpty(c.component.data.transitionData.inventoryAutoFillData)&&(M=!0)),M||A.forEach((function(e){e&&x[e]&&["lookup","ownerlookup","userlookup"].contains(x[e].fieldType)&&P[e]&&p[e]&&P[e].id&&p[e].id&&P[e].id===p[e].id&&D.data.moduleData.fields.filter((function(t){if(t.association_details&&t.association_details.lookup_field.id===x[e].fieldID&&!A.contains(t.api_name))if(Lyte.Transform[t.data_type]&&Lyte.Transform[t.data_type].serialize)if("datetime"===t.data_type){var a=c.component.data.originalData[t.api_name];a=a.replace(/[+-]\d{2}:\d{2}/,""),U[t.api_name]=a}else U[t.api_name]=Lyte.Transform[t.data_type].serialize(P[t.api_name]);else U[t.api_name]=P[t.api_name]}))})),d.skipUnChangedFieldsInPUTApi=U}if(("edit"===n||D.data.isWizard&&(t||"create"===n))&&(0===Object.keys(T).length&&c&&c.component&&c.component.data&&(T=c.component.data.initialCreatebject||{}),!0===Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM&&Crm.curr_sub_Form_DetailS&&Crm.curr_sub_Form_DetailS.apiNames)){var V={};Crm.curr_sub_Form_DetailS.apiNames.forEach((function(e){var t=T[e],a=p[e];if(t&&t.length>0&&a&&a.length>0){var i={};a.forEach((function(e){var t={},a=e.$.getDirtyAttributes(),r=e.$&&e.$.model&&e.$.model.fieldList||{};a.forEach((function(i){var o=r[i].fieldID;i&&r[i]&&["lookup","ownerlookup","userlookup"].contains(r[i].fieldType)&&Object.keys(r).forEach((function(i){var n=r[i].fieldID;if(n&&n!=o){var s=store.peekRecord("field",n);s&&s.association_details&&s.association_details.lookup_field&&s.association_details.lookup_field.id==o&&-1===a.indexOf(i)&&(Lyte.Transform[r[i].type]&&Lyte.Transform[r[i].type].serialize?t[i]=Lyte.Transform[r[i].type].serialize(e[i]):t[i]=e[i])}}))})),Object.keys(t).length>0&&(i[e.$.pK]=t)})),V[e]=i}})),d.subformVsPopulateSFUnChangedFOLInPUTApi=V}if(D.getMethods("updateEntitySaveQp")&&(N=D.executeMethod("updateEntitySaveQp")))for(var w in N)u[w]=N[w];if(D&&D.data.qcSkipMandatory&&Z.setData("skipMandatory",D.data.qcSkipMandatory),Z&&Z.getData("cloneOnEdit")&&d&&(d.cloneOnEdit=!0),"edit"===n&&s&&"Services"===s.module_name&&p.$.getDirtyAttributes().contains("Members")&&d&&(d.editedMembersValue=Lyte.registeredMixins["crm-services-mixin"].editedDataBindMembers(D,s.fields)),b&&D&&!D.isRecordSubmission&&(d.emptyTrigger=!0),u&&u.affected_data_new&&(d||(d={}),d.record_dirty_props=p.$.getDirtyAttributes()),"edit"===n&&void 0!==p.$approval&&(p.$approval.takeover||p.$approval.approve)){var B=Lyte.registeredMixins.approvalprocess.constructDataForApprovalProcess(store.$.toJSON(p.$.model._name,store.$.updateJSON(p,p.$.model,p.$.isDirty()),void 0,void 0,{obj:new Map}),p,d),j=s.record_modification.approval_record_modification[0];void 0!==j.allowed_user_permissions&&(j=j.allowed_user_permissions,Lyte.registeredMixins.approvalprocess.saveRecordWithApprovalResponse(j,B,"edit"))}else{var q,z;if(k&&"Tasks"===k.api_name)(z=(q=$L("crm-tasks-markascomplete")[0])?q.component.data:void 0)&&z.showNotifyOwnerChecked&&(d=q.component.executeMethod("setCustomDataToSendMail",d)),z&&q.component.removePopup(q.component.data.elementId);p.$.save(d,u,{skipValidation:t||p.__skip_clientOnSaveValidation,validateOnSave:t}).then((function(i){var o=D.data.quickCreateDataObj;if(o&&o.parseFieldDeatils)var n=o.parseFieldDeatils.field;var s=$("crm-multi-selection-popup")[0];if(n&&"multiselectlookup"===n.data_type&&s){var l=p[n.api_name];s.component.AfterSave(l,"confirm"===s.component.data.action)}var c,u=D.getData("module");Lyte.triggerEvent("CruxFrameListener",{saveResponse:i[p.$.model._name],buttonAction:e,moduleName:u,currentPage:D.data.initRoute,isWizard:D.data.isWizard}),fileupload.draftRecord=p,"undefined"!=typeof EmailComposeUtil&&EmailComposeUtil&&EmailComposeUtil.removeDraftDOMElement();var m=Lyte.Router.getRouteInstance()&&Lyte.Router.getRouteInstance().transition?Lyte.Router.getRouteInstance().transition.data:{};if(!Crm.isHeadless&&isWFKafkaUser()&&!m.listRelationId){var f=Object.keys(i)[0],_=i[f].isWFScheduler;Crm.renderDVLyteFlow(u)&&_?((c={}).refreshInWms=!0,c.currOffloadingJobId=i[f].wfOffloadedJobid):("undefined"==typeof detailView&&(detailView={}),detailView.isWFExecInKafka=_,_&&(detailView.singleRecordLyteOffloading=!0,detailView.refreshInWms=!0,detailView.currOffloadingJobId=i[f].wfOffloadedJobid))}"transition"!==e&&"saveasdraft"!==e||D.wizard_showHideLoadingDiv(!1),Crm.trackSpotLightAction("MPL - Record Edited",{Module:u});var y={currentEventID:a,type:"afterSave",data:p,customDataEntity:d,response:i};if(D.succFun(i,e,p.$state,Z,t,y,c),D.focusErrorField(Y),r){var g=document.querySelector("crm-create-layout").getData("dataBind").$.model._name;store.findRecord(g,i[g].id).then((function(e){var t=document.querySelector("crm-create-layout");t.component.methods.resetSubformData(e[0],t),t.setData("dataBind",e[0])}))}var v=$L("crm-create-layout")[0];if(b&&v&&("draft"===p.$state||"save"===p.$state)){var h=v.component.data.fileuploadFieldsData,L=Object.keys(h),C=i[Object.keys(i)[0]],I=Object.keys(C),E=L.filter((e=>I.includes(e))),R=$L("crux-file-upload-component"),S=R.length,F=[];v.component.data.moduleData.fields.filter((e=>"subform"===e.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===e.data_type)).forEach((e=>{F.push(e.api_name)})),E.forEach((e=>{if(!F.includes(e)){h[e]=Lyte.registeredMixins["crm-uploadfields-mixin"].getFileDataInCruxFormat(C[e]);for(var t=0;t<S;t++){var a=R[t].component;a.data.cxPropField.api_name!==e||a.data.cxPropField.subform_api||(a.setData("cxPropFiles",[]),a.setData("cxPropValue",h[e]))}}}));var O=v.component,k=O.data.uploadedImageDetailsMap,w=Object.keys(k),N=Object.keys(i[Object.keys(i)[0]]);w.filter((e=>N.includes(e))).forEach((function(e){var t=Lyte.registeredMixins["crm-uploadfields-mixin"].getCruxImageUploadComponents(e,"create","api-name");if(void 0!==t){var a=t.getData("cxPropField").id,r=Lyte.registeredMixins["crm-uploadfields-mixin"].constructImageDataFromServer(i[Object.keys(i)[0]][e],u,$L("#id").val(),a),o=Lyte.registeredMixins["crm-uploadfields-mixin"].constructImageSrcWithExistingData(r,k[e]);1===o.length&&(o=Lyte.registeredMixins["crm-uploadfields-mixin"].constructImageDataByState(o,i[Object.keys(i)[0]][e])),t.setData("cxPropValue",o),t.setData("cxPropValidationTooltip",Lyte.registeredMixins["crm-uploadfields-mixin"].setTooltipValue(o)),Lyte.registeredMixins["crm-uploadfields-mixin"].updateImageDetailsMap(e,o),O.setData("dataBind."+e,k[e])}})),O.setData("imageGetValueMap",{})}"Leads"!=u&&"Contacts"!=u&&"Potentials"!=u||Crm.trackSpotLightAction(u+" - Added"),crmTab.emptyCache(u)}),(function(r){if(D.getMethods("onBeforeQuickCreateSaveFailure")&&D.executeMethod("onBeforeQuickCreateSaveFailure",a,"afterSave",r,p))return;if(i&&Lyte.Component.set(p,"$state","draft"),commonUtils.showHideLoadingDiv(!1),D.wizard_showHideLoadingDiv(!1),Z.getData("isWizard")&&Z.getData("showRecordSummary")&&Z.setData("showRecordSummary",!1),"500"==r.status)return crmHistory.handleAjaxErrorLyte=!0,void renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("error.database.problem"));D.validateSubform(Y),D.failureFun(r,Y,p,e,Z,t),D.focusErrorField(Y),D.portalErrorResponse(r);var s=Lyte.Router.getRouteInstance().currentModel,l="clone"!==n&&s.available_actions?s.available_actions.actions.find((function(e){return"portal_user_preference"===e.name})):void 0;if("Bundles"===f&&r.status&&400===r.status){var d=JSON.parse(r.response);if(d&&d.data){var c=d.data.first(),u=c?c.code:"";if("LIMIT_EXCEEDED"===u){var m=Crm.userDetails,_=m.BundlesFeatureLimit?m.BundlesFeatureLimit:null,y=_&&_.bundleLimit?_.bundleLimit:null;y&&renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("bundles.create.maxlimit.alert",[y,moduleRecordMapping.Bundles.plural_label,moduleRecordMapping.Bundles.singular_label]))}else{if("DUPLICATE_DATA"===u||"MULTIPLE_OR_MULTI_ERRORS"===u||"INVALID_DATA"===u)return void Z.setData("disableFormbuttons",!1);if("MANDATORY_NOT_FOUND"===u&&(!moduleRecordMapping.hasOwnProperty("Products")||moduleRecordMapping.hasOwnProperty("Products")&&!moduleRecordMapping.Products.visible))return void renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("bundles.product.disabled.alert",[moduleRecordMapping.Bundles.singular_label.toLowerCase(),moduleRecordMapping.Products.plural_label]))}}}(l||Crm.userDetails.CLIENT_ACCOUNT)&&D.portalErrorResponse(r),Z.setData("disableFormbuttons",!1),D.getMethods("onQuickCreateSaveFailure")&&D.executeMethod("onQuickCreateSaveFailure",a,"afterSave",r,p),o.preventDefault()}));var W=$L("crm-zia-vision-error-popup");W&&W[0]&&W[0].component.setData("isZiaFeedbackPopupShown",!1);var H=$L("crm-create-entity.entComp"+l),K=document.querySelector("#visionErrorChk"),Q=[],G={},J=[],X={},ee=H[0].getData("entityrecordData").id,te="/crm/v3/"+f+"/"+ee+"/actions/vision_feedback",ae={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},ie=$L("crm-image-upload-create");if(H&&K&&K.checked){if(H[0].getData("showVisionHelpZiaOfRecImg")&&(X.id=Ne.Record_Image.fieldID,X.validation_failure_count=1,J.push(X)),(ne=H[0].getData("showVisionHelpZiaOfCusImg"))&&Object.keys(ne).length>0&&ie&&ie.length>0)for(var re=ie.length,oe=0;oe<re;oe++){if(ne[se=ie[oe].component.data.fieldid])(X={}).id=se,X.validation_failure_count=1,J.push(X)}}else if(H&&K&&!K.checked){var ne;if(H[0].getData("showVisionHelpZiaOfRecImg")&&(X.id=Ne.Record_Image.fieldID,X.validation_failure_count=0,J.push(X)),(ne=H[0].getData("showVisionHelpZiaOfCusImg"))&&ie)if((re=ie.length)>0)for(oe=0;oe<re;oe++){var se;if(ne[se=ie[oe].component.data.fieldid])(X={}).id=se,X.validation_failure_count=0,J.push(X)}}if(H&&K&&J.length>0){var le={};le.fields=J,Q.push(le),G.vision_feedback=Q,app.store.makeRequest("sendXHR",te,"PUT",ae,JSON.stringify(G))}}}function Je(e,t,a,i,r){var o={},n=(r=r||{},Crm.curr_sub_Form_DetailS?Crm.curr_sub_Form_DetailS.apiNames:void 0);for(var s in t)if("Owner"===s||"Layout"===s)e[s]&&t[s]&&t[s].id!==e[s].id&&(o[s]=t[s]);else if(i[s]&&"multiuserlookup"===i[s].fieldType)o[s]=t[s]&&t[s].length?t[s]:[];else if(_.isEqual(t[s],e[s])||n&&-1!==n.indexOf(s)){if(n&&-1!==n.indexOf(s)){if(Z&&Z.getData("layoutId")){var l=store.peekRecord("layout",Z.getData("layoutId"));l&&l.fields&&l.fields.filterBy({api_name:s})[0]&&(o[s]=p[s])}}else if(i[s]&&"picklist"===i[s].fieldType&&t[s]&&e[s]&&_.isEqual(t[s],e[s])&&i[s].fieldID){var d=store.peekRecord("field",i[s].fieldID);d&&d.default_value&&d.default_value===t[s]&&(o[s]=t[s])}else if(r.hasOwnProperty(s)&&!o.hasOwnProperty(s)){var c=r[s];_.isEqual(t[s],c)||(o[s]=t[s])}}else o[s]=t[s];return o}},executeValidationRule:function(e,t,a,i,r,o,n,s){var l=e.getData("dataBind"),d=l.$.getDirtyAttributes(),c=e.data.currentInstObjKey,u="crm-create-layout#"+store.peekRecord("module",l.$.model._name).module_name+"LC_layoutNode",m=$L(u)[0],p=e.getData("isWizard"),f=e.getData("isWizardView"),_=$L("crm-validation-alert")[0];_&&!n&&($L("crm-quick-create-listing")[0]&&_.setData("isVRError",!1),p&&_.setData("layoutData",m),_.component.executeMethod("emptyErrorData"));var y=m?m.getData("valFeatureSpecinfo"):[];n||m.setData("valRuleData",void 0);var g=m?m.getData("validationRules"):void 0;n&&o&&(g=g.filter((function(e){return e.id==o})));var v,h,D=e.getViewTypeInfo(),b=e.getData("moduleData.fields"),L=!!m&&m.getData("cloneOnEdit"),C=m?m.getData("globalData"):{},I=!!(C&&C.quickEntityData&&C.quickEntityData.isKanbanviewEdit)&&C.quickEntityData.isKanbanviewEdit;if(e.getData("isQuickCreate")&&e.getData("quickCreateDetails").isCustomList)if(this.getMethods("executeValidationRule")){var E=this.executeMethods("executeValidationRule");g=E&&E.length?E:void 0}else g=void 0;else v=e.getData("currentLayout")?e.getData("currentLayout"):e.getData("selectedLayoutid"),h=v.split(";")[0];var R=[];if(e.setData("vrPassed",!1),e.setData("moveToScreenOnVRFailure",t),g){var S=0,F=g.filter((function(e){var t=e.layout.id?e.layout.id:e.layout;return h==t&&e.active&&"function"==e.validation_type})),O=g.filter((function(e){var t=e.layout.id?e.layout.id:e.layout;return h==t&&e.active&&"criteria"==e.validation_type}));if(O.length+F.length){var k=[],w=0;F.forEach((function(t){var a=t.field.api_name,i=b.filter((function(e){return e.id==t.field.id}))[0];if(i[c]&&i[c].errorDetails&&(i[c].errorDetails={}),i[c]&&i[c].aggerrorDetails&&(i[c].aggerrorDetails={}),r&&r.some((function(e){return void 0===e||store.peekRecord("wizard-screen",e).segments.mapBy("id").some((function(e){return void 0!==i[e]}))}))){var o=e.data.isWizard||T(i),n=!!i&&e.isValidVRFieldForInventory(i,e.getData("module"));if(i&&o&&i.visible&&i.view_type[D]&&(!i.read_only||n||i[c].validate_read_only)&&e.fieldInPath(i)){++w;var s={};s.column_name=i.column_name,s.uitype=i.ui_type,s.value=""===l[a]||void 0===l[a]?"":l[a]+"",s.api_name=i.api_name,s.field_label=i.field_label,s.id=t.associated_function.id,s._targetFieldid=i.id;var d=I?"quickCreate":void 0;s.record=e.filterValidUITypes(l,e.getData("initRoute"),b,d,{isCloneOnEdit:L,isVR:!0}),s.value&&[24,14,30,202,333,786].contains(s.uitype)&&(s.value=s.record[s.api_name]),k.push(s)}}}));var N=w+O.length;function T(t){var a=!1;return e.data.moduleSections&&e.data.moduleSections.forEach((function(e){e&&e[c]&&e[c].type&&"used"===e[c].type&&e.fields&&e.fields.some((function(i){i.id===t.id&&e[c].isvalidSection&&(a=!0)}))})),a}w&&(e.setData("VRFunc",!0),store.triggerAction(l.$.model._name,"execute",{type:"POST",jsonData:k}).then((function(t){t&&t.functions&&e.handleVRFunctionResponse(e.getData("module"),t.functions,k,e,R,i),N==(S+=w)&&M(e)}),(function(t){M(e,t)}))),O.forEach((function(t){var a,i;if(t.field){a=t.field.api_name,i=t.field.id;var r=b.filter((function(e){return e.id==i}))[0];delete r[c].isSecVal,r[c]&&r[c].errorDetails&&(r[c].errorDetails={}),r[c]&&r[c].aggerrorDetails&&(r[c].aggerrorDetails={});var o=e.data.isWizard||T(r),n=e.getData("module")?e.getData("module"):e.getData("moduleName"),u=e.isValidVRFieldForInventory(r,n);r&&o&&r.visible&&(!r.read_only||u||r[c].validate_read_only)&&(r.view_type[D]||r.view_type.isVRField)&&t.conditions&&e.fieldInPath(r)&&t.conditions.forEach((function(o){r[c].isSecVal||e.handleValidationRuleCondition(o,a,t.execution_type,e,l,i,R,f,d,y,s)}))}++S,N==S&&M(e)})),0==w&&0==O.length&&M(e)}else M(e)}else M(e);function M(e,t){var r=e.getData("isWizard");const o=e.getData("isWizardView");var n,s=void 0!==Crm.userDetails.ValidationAlertPreference&&Crm.userDetails.ValidationAlertPreference&&!o;if(0!==R.length)if(r){var l={},d=[];if(e.getData("moveToScreenOnVRFailure")&&!(o?R.some((e=>{let t=store.peekRecord("field",e.targetFieldId);return!!$L(".fieldupdate_"+t.column_name)[0]})):R.some((t=>{if(e.getErrorFieldObj(t.targetField))return!0})))){var c=document.querySelector("crm-create-layout");c.component.getData("screenHistory").some((function(e){let t=store.peekRecord("wizard-screen",e.id);return t.segments.some((function(a){if(a.fields){var i=a.fields.sortBy(a.id+".sequence_number").mapBy("id"),r=!1,s=999;if(R.forEach((function(e){var t=i.indexOf(e.targetFieldId);-1!==t&&t<s&&(r=!0,s=t,n=e)})),r)return o&&(t.vrErrors=R),c.component.handleScreenTransition(e.id,void 0,!0),c.component.setData("transitionDone",!0),!0}return!1}))}))}else{store.peekRecord("wizard-screen",document.querySelector("crm-create-layout").component.getData("screenHistory")[document.querySelector("lyte-step").ltProp("selected")].id).segments.some((function(t){if(t.fields){var a=t.fields.sortBy(t.id+".sequence_number").mapBy("id"),i=999;R.forEach((function(e){var t=a.indexOf(e.targetFieldId);-1!==t&&t<i&&(i=t,n=e)})),n&&o&&Lyte.registeredMixins["crm-canvas-view-rules"].HandlindValidationRuleErrorforAjaxEdit(e.getData("dataBind"),R)}}))}i&&(n=void 0),s?(e.setData("vrPassed",!0),R.forEach((function(e){var t=[];Lyte.arrayUtils(t,"push",e),l&&l.hasOwnProperty(e.targetFieldId)?(t=l[e.targetFieldId],Lyte.arrayUtils(t,"push",e),l[e.targetFieldId]=t):(Lyte.arrayUtils(d,"push",e.targetFieldId),Lyte.objectUtils(l,"add",e.targetFieldId,t))})),e.setValidationErrorNew(l,d,i,e)):(R.forEach((function(t){n&&t!==n&&e.setValidationError(t.message,t.targetField,e,t.targetFieldId,i)})),n&&(e.setData("vrPassed",!0),e.setValidationError(n.message,n.targetField,e,n.targetFieldId,!1)))}else{e.setData("vrPassed",!0);l={},d=[];R.forEach((function(t){if(s){var a=[];Lyte.arrayUtils(a,"push",t),l&&l.hasOwnProperty(t.targetFieldId)?(a=l[t.targetFieldId],Lyte.arrayUtils(a,"push",t),l[t.targetFieldId]=a):(Lyte.arrayUtils(d,"push",t.targetFieldId),Lyte.objectUtils(l,"add",t.targetFieldId,a))}else e.setValidationError(t.message,t.targetField,e,t.targetFieldId,i)})),s&&e.setValidationErrorNew(l,d,i,e)}a&&a(t)}},succFun:function(e,t,a,i,r,o,n){var s,l=this,d=l.getData("dataBind");if(null==e&&"edit"==l.getData("initRoute"))s={id:d.id},l.handleNavigation(l,i,t,s,o);else{for(var c in e)s=e[c];var u=0,m=0,p=l.getData("moduleData"),f=0;if("edit"===l.getData("initRoute")&&p.changeOwnerDetails&&p.changeOwnerDetails.length){var _=l.getData("untoucheddataBind");f=_&&_.Owner&&_.Owner.id===p.changeOwnerDetails[0].queryParams.owner_id?0:p.changeOwnerDetails.length}f=0;var y=0,g=0,v=0,h=i.component?i.component.data:[],D=this.getData("moduleData.invokeRemoveAllCall");if((D=[])&&D.length&&"edit"==this.getData("initRoute")&&d[h.moduleData.display_field.api_name]&&(g=D.length,++y),l.getData("isstageSave")&&l.getData("reasonforLoss")&&Crm.userDetails.permissions&&Crm.userDetails.permissions.Crm_Implied_Create_Notes&&++v,f||y||v){v&&Lyte.injectResources(networkUtils.returnDependencyFiles(["note_model.js"],ResourceConstants.CRMClient),void 0,(function(){var e={Note_Title:d.Stage,Note_Content:l.getData("reasonforLoss"),Parent_Id:{id:s.id},se_module:"Potentials"},a=store.createRecord("note",e,!0);commonUtils.showHideLoadingDiv(!0),a.$.save().then((function(){commonUtils.showHideLoadingDiv(!1),++m,y+f+v==m&&l.handleNavigation(l,i,t,s,o)}),function(){commonUtils.showHideLoadingDiv(!1),++m,y+f+v==m&&l.handleNavigation(l,i,t,s,o);crmui.showMsgBand("error","Notes API failed due to invalid data - Reason for Loss not updated",3e3)}.bind(this))}));for(var b=0;b<f;b++){var L=p.changeOwnerDetails[b];validationUtils.isNotEmpty(L)&&L.customData&&(L.customData.qParams=L.queryParams),store.triggerAction(d.$.model._name,"change_owner",L.customData).then((function(){++m,y+f+v===m&&l.handleNavigation(l,i,t,s,o)}),(function(e){if(++m,y+f+v==m&&l.handleNavigation(l,i,t,s,o),e&&e.responseText){var a=JSON.parse(e.responseText),r="";"INVALID_DATA"===a.code&&"body"===a.message?r="Change Owner Not succesfull - INVALID DATA sent":a.message&&(r="Change Owner Not succesfull - "+a.message),crmui.showMsgBand("error",r,3e3)}}))}if(y){var C={},I=Crm.getCrmBasePath()+"/EditCommonModule.do";C.layoutId=h.selectedLayoutid,C["property(module)"]=h.moduleName,C.module=h.moduleName,C.newModel=!0,C.notify=void 0,C.operation="edit",C.ActionType="Edit",C["property(id)"]=d.id,h.moduleData.fields.filter((function(e){if(e.system_mandatory){var t="property("+e.display_label+")";C[t]=d[e.api_name]}}));for(var E=0;E<g;E++){var R=D[E].colName;C["property("+R+")"]="-all-";var S="property("+commonUtils.getLookupIdName(D[E].lookupModule)+":"+R+")";C[S]="-all-"}networkUtils.lyteInitiateRequest(I,"POST",{params:C}).then((function(){var e=h.moduleData.addedMLRecords;(e&&e.length?e.length:0)?(e.forEach((function(e){d.$.set(e.mlApiname,e.mlData)})),d.$.save(void 0,void 0,{skipValidation:r,validateOnSave:r}).then((function(){++m,y+f+v==m&&l.handleNavigation(l,i,t,s,o)}))):(++m,y+f+v==m&&l.handleNavigation(l,i,t,s,o))}))}}else if(l.data.isWizard&&"save"===t&&validationUtils.isNotEmpty(i.component.data.ack_message)&&i.component.data.ack_message.content){document.getElementById("lt_wizard_button_acknowledgement").ltProp({transition:{animation:"slideFromTop",duration:"0.3"},offset:{top:"0",left:"center"},show:!0}),commonUtils.showHideLoadingDiv(!1)}else l.handleNavigation(l,i,t,s,o,n);var F=[],O=[];if(F&&F.length||O&&O.length){var k,w,N={multiLookup:[]},T=[],M=[],P=[],$=[],A=[];F.forEach((function(e){var t=e.component.data;if(t&&t.multiselRecords&&t.multiselRecords.length||t.multiselRecords&&0==t.multiselRecords.length&&"edit"==l.getData("initRoute")){var a=t.moduledataUicomp.multiselectlookup;if(T.push(t.multiselRecords),"edit"==l.getData("initRoute")){var i=[];t.multiselRecords.forEach((function(e){i.push(e.id)})),M.push(i)}w=t.prevSelectedarray,$.push(a.linking_module.id),N.multiLookup.push(store.findRecord("module",a.linking_module.id)),u++}})),N.multiuserLookup=[],O.forEach((function(e){var t=e.component.data;if(t&&t.userRecordids&&t.userRecordids.length||t.userRecordids&&0==t.userRecordids.length&&"edit"==l.getData("initRoute")){var a=t.moduledataUicomp.multiuserlookup;P.push(t.userRecordids),k=t.untouchedMultiuserdata,A.push(a.linking_module.id),N.multiuserLookup.push(store.findRecord("module",a.linking_module.id)),u++}})),N.multiLookup.length&&Lyte.resolvePromises(N.multiLookup).then((function(e){var t=e.length;l.setData("validPromisefield",l.getData("validPromisefield")+t);for(var i=0;i<t;i++){var r,o,n=e[i],c=T[i],u=M[i],m=$[i];if(c&&c.length||"edit"==l.getData("initRoute"))if(n[0].fields.forEach((function(e){"lookup"==e.data_type&&(d.$.model.fieldList[e.api_name]?o=e.api_name:r=e.api_name)})),"edit"==l.getData("initRoute")){for(var p=[],f=[],_=[],y=!1,g=w?w.length:0,v=0;v<g;v++)u.contains(w[v])?p.push(w[v]):_.push(w[v]);for(var h=u.length,D=0;D<h;D++)p.contains(u[D])||_.contains(u[D])||f.push(u[D]);f&&f.length&&(y=!0,l.setData("completepromiseLength",l.getData("completepromiseLength")+f.length),f.forEach((function(e){var t=store.createRecord(m);t.$.set(r,{id:s.id}),t.$.set(o,{id:e}),a&&t.$.set("$state",a),t.$.save().then((function(){x()}),(function(){U()}))}))),_&&_.length&&(y=!0,l.setData("completepromiseLength",l.getData("completepromiseLength")+_.length),store.batch((function(){_.forEach((function(e){var t={group_operator:"AND",group:[{comparator:"equal",field:{api_name:r},value:s.id},{comparator:"equal",field:{api_name:o},value:e}]};store.findAll(m,{filters:JSON.stringify(t)}).then((function(e){var t=e&&e[0]?e[0]:void 0;t&&(t.$.deleteRecord(),t.$.save().then((function(){x()}),(function(){U()})))}))}))}))),y||(l.setData("completepromiseLength",l.getData("completepromiseLength")+1),x())}else l.setData("completepromiseLength",l.getData("completepromiseLength")+c.length),c.forEach((function(e){var t=store.createRecord(m);t.$.set(r,{id:s.id}),t.$.set(o,{id:e.id}),a&&t.$.set("$state",a),t.$.save().then((function(){x()}),(function(){U()}))}))}})),N.multiuserLookup.length&&Lyte.resolvePromises(N.multiuserLookup).then((function(e){var t=e.length;l.setData("validPromisefield",l.getData("validPromisefield")+t);for(var a=0;a<t;a++){var i,r,o=e[a],n=P[a],c=A[a];if(o[0].fields.forEach((function(e){"lookup"!=e.data_type&&"userlookup"!=e.data_type||(d.$.model.fieldList[e.api_name]?r=e.api_name:i=e.api_name)})),"edit"==l.getData("initRoute"))if(n&&n.length||k&&k.length){for(var u=[],m=[],p=[],f=!1,_=k.length,y=0;y<_;y++)n.contains(k[y].id)?u.push(k[y].id):p.push(k[y].id);for(var g=n.length,v=0;v<g;v++)u.contains(n[v])||p.contains(n[v])||m.push(n[v]);m&&m.length&&(f=!0,l.setData("completepromiseLength",l.getData("completepromiseLength")+m.length),m.forEach((function(e){var t=store.createRecord(c);t.$.set(i,{id:s.id}),t.$.set(r,{id:e}),t.$.save().then((function(){x()}),(function(){U()}))}))),p&&p.length&&(f=!0,l.setData("completepromiseLength",l.getData("completepromiseLength")+p.length),store.batch((function(){p.forEach((function(e){var t={group_operator:"AND",group:[{comparator:"equal",field:{api_name:i},value:s.id},{comparator:"equal",field:{api_name:r},value:e}]};store.findAll(c,{filters:JSON.stringify(t)}).then((function(e){var t=e&&e[0]?e[0]:void 0;t&&(t.$.deleteRecord(),t.$.save().then((function(){x()}),(function(){U()})))}))}))}))),f||(l.setData("completepromiseLength",l.getData("completepromiseLength")+1),x())}else l.setData("completepromiseLength",l.getData("completepromiseLength")+1),x();else n&&n.length&&(l.setData("completepromiseLength",l.getData("completepromiseLength")+n.length),n.forEach((function(e){var t=store.createRecord(c);t.$.set(i,{id:s.id}),t.$.set(r,{id:e}),t.$.save().then((function(){x()}),(function(){U()}))})))}})),l.getData("promiseLength")==l.getData("completepromiseLength")&&l.getData("validPromisefield")==u&&l.handleNavigation(l,i,t,s,o,n)}}function U(){Lyte.Component.registeredHelpers.log("Error in record creation")}function x(){l.setData("promiseLength",l.getData("promiseLength")+1),l.getData("promiseLength")==l.getData("completepromiseLength")&&l.getData("validPromisefield")==u&&l.handleNavigation(l,i,t,s,o)}},handleNavigation:function(e,t,a,i,r,o){commonUtils.showHideLoadingDiv(!0);var n=t,s=e.getData("dataBind"),l=e.data.currentInstObjKey;const d=e.getData("moduleData").id,c=e.getData("moduleData").module_name;if(store.clearCachedQuery(d),fileupload.uploadDeleteObject={},fileupload.draftDatas={},fileupload.isDraftRecord=s.$state,"transition"!==a&&"custom_button"!==a){e.getData("preventRecUnload")||store.unloadRecord(d,i.id);var u=e.getData("entityrecordData");"clone"===e.getData("initRoute")&&validationUtils.isNotEmpty(u)&&!u.$.isNew&&store.unloadRecord(d,u.id);var m=e.getData("currsubformApinames");m&&m.length&&m.forEach((function(t){if(void 0!==e.getData("dataBind").$.model.fieldList[t]){var a=e.getData("dataBind").$.model.fieldList[t].relatedTo;store.unloadAll(a)}}))}if("Campaigns"===c&&n){var p=n.getData("moduleData.fields").filter((function(e){return"Native__Survey__Extn__Survey_Type"===e.api_name}))[0];p&&p[l].isNewSurveyField&&store.findAll("dummy",{},!1,!1,{url:"/crm/v2.2/Campaigns/"+i.id+"/actions/survey_status"}).then((function(e){e&&e.survey_status&&e.survey_status.editor_url&&networkUtils.openUrl(e.survey_status.editor_url,"blank")}))}e.showValidationMsgBox(i,c);if(["save","saveAndNew","saveasdraft"].includes(a)&&Lyte.Router.getRouteInstance()&&(Lyte.Router.getRouteInstance().transition.data.skipDirtyCheck=!0),"save"===a)if(n&&n.component.data.transitionData&&n.component.data.transitionData.fillUpModule&&!n.component.data.transitionData.isFillUpModuleFromURL&&n.component.data.transitionData.entityid&&!n.component.data.transitionData.isConnectedToField){var f=n.component.data.transitionData;Crm.scrollToElem=f.returnAnchor;if(["Campaigns","Products"].contains(f.relmodule)&&f.module!=f.relmodule){var _={};_.relmodule=f.relmodule,_.listRelationId=f.listRelationId,_.entityid=f.entityid,_.newentityID=i.id,_.type="PUT",store.triggerAction(d,"relatedListmap",_)}"Campaigns"==f.fillUpModule&&"Campaigns"===f.module?Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:[c,i.id]}):(Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:[f.fillUpModule,f.entityid]}),crmHistory.backOneLevel())}else if(e.getData("isQuickCreate")||e.data.globalData&&(!e.data.globalData||e.data.globalData.isThroughQc))e.data.globalData&&e.data.globalData.isThroughQc&&!e.getData("isQuickCreate")&&Lyte.Component.registeredHelpers.isRequesterTeamModule(c)&&n&&n.component.data.transitionData&&!n.component.data.transitionData.isConnectedToField&&Lyte.Router.transitionTo({route:"crm.tab.requesters.module.index-module.entity.detail",dynamicParams:[c,i.id]});else if("edit"===e.getData("initRoute"))if("listView"===Crm.editReqFrom){var y=e.getData("entityrecordData"),g=e.data.isWizard&&Lyte.Router.getRouteInstance().getQueryParams().wizardId?e.data.entityrecordData.Layout.id:this.data.currentLayout;y&&Crm.getCanvasId(e.data.moduleData.id,y.id,g)?i.affected_data?Lyte.Router.transitionTo({route:"crm.tab.module.entity.canvas",dynamicParams:[c,y.id,Crm.getCanvasId(e.data.moduleData.id,y.id,g)]}).data={affected_data:i.affected_data}:Lyte.Router.transitionTo({route:"crm.tab.module.entity.canvas",dynamicParams:[c,y.id,Crm.getCanvasId(e.data.moduleData.id,y.id,g)]}):i.affected_data?Lyte.Router.transitionTo({route:"crm.tab.module.entity.detail",dynamicParams:[c,i.id]}).data={affected_data:i.affected_data}:Lyte.Router.transitionTo({route:"crm.tab.module.entity.detail",dynamicParams:[c,i.id]})}else if("canvas"===Crm.layoutReqFrom||"detailView"===Crm.layoutReqFrom){var v;if(Crm.layoutReqFrom=void 0,crmNavig&&crmNavig[crmNavig.customViewKey]&&crmListView.getObject().fromIndex&&crmListView.getObject().toIndex&&(v=crmNavig[crmNavig.customViewKey].recordId.map((function(e){return e.id})).indexOf(i.id)),v&&v>0){y=e.getData("entityrecordData");Crm.getCanvasId(e.data.moduleData.id,y.id,this.data.currentLayout)?Lyte.Router.transitionTo({route:"crm.tab.module.entity.canvas",dynamicParams:[c,i.id,Crm.getCanvasId(e.data.moduleData.id,y.id,this.data.currentLayout)]}).data={FROM_INDEX:crmListView.getObject().fromIndex,TO_INDEX:crmListView.getObject().toIndex,recordNum:v,cvid:customViewObject.cvId,fromDel:!1,navig:!0,affected_data:i.affected_data}:Lyte.Router.transitionTo({route:"crm.tab.module.entity.detail",dynamicParams:[c,i.id]}).data={FROM_INDEX:crmListView.getObject().fromIndex,TO_INDEX:crmListView.getObject().toIndex,recordNum:v,cvid:customViewObject.cvId,fromDel:!1,navig:!0,affected_data:i.affected_data}}else Crm.getCanvasId(e.data.moduleData.id,i.id,this.data.currentLayout)?i.affected_data?Lyte.Router.transitionTo({route:"crm.tab.module.entity.canvas",dynamicParams:[c,i.id,Crm.getCanvasId(e.data.moduleData.id,i.id,this.data.currentLayout)]}).data={affected_data:i.affected_data}:Lyte.Router.transitionTo({route:"crm.tab.module.entity.canvas",dynamicParams:[c,i.id,Crm.getCanvasId(e.data.moduleData.id,i.id,this.data.currentLayout)]}):i.affected_data?Lyte.Router.transitionTo({route:"crm.tab.module.entity.detail",dynamicParams:[c,i.id]}).data={affected_data:i.affected_data}:Lyte.Router.transitionTo({route:"crm.tab.module.entity.detail",dynamicParams:[c,i.id]})}else i.affected_data?crmHistory.backOneLevel(void 0,void 0,{affected_data:i.affected_data},void 0,o):crmHistory.backOneLevel(void 0,void 0,void 0,void 0,o);else"Tasks"===c?Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:["Activities",i.id],queryParams:{sub_module:"Tasks"}}):"Events"!==c&&Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:[c,i.id]});else if("saveAndNew"===a)"create"===e.getData("initRoute")?(Lyte.Router.getRouteInstance().transition.data.skipModuleReqTrigger=!0,Lyte.Router.getRouteInstance().refresh({refreshTemplate:!0}).data=Lyte.Router.getRouteInstance().transition.data):"Tasks"===c?Lyte.Router.transitionTo({route:"crm.tab.module.create",dynamicParams:["Activities"],queryParams:{sub_module:"Tasks"}}):Lyte.Router.transitionTo({route:"crm.tab.module.create",dynamicParams:[c]});else if("saveasdraft"===a)Lyte.Router.transitionTo({route:"crm.tab.module.actions.draft",dynamicParams:[c]});else if("custom_button"===a){var h=$L("crm-create-buttons")[0].component;if(h){var D=h.custombuttonWizardDetails;D&&(D.custombuttonEmptymodal.recordId=i.id,h.callCustomFunction(D.buttonId,void 0,D.custombuttonEmptymodal,!0))}}else if(s.$screenId){n.setData("disableFormbuttons",!1);const e=n.component;e.clearPricingDetailsError(),e.handleScreenTransition(s.$screenId).then((()=>{e.executeMethod("resetSubformData",s,e,"orgSubformData"),commonUtils.showHideLoadingDiv(!1)}))}e.getMethods("onQuickCreateSaveSuccess")&&e.executeMethod("onQuickCreateSaveSuccess",r.currentEventID,r.type,r.data,r.response,a,r)},validateSubform:function(e,t,a){for(var i=this,r=i.getData("currsubformApinames"),o=r.length,n=i.getData("dataBind"),s=!0,l=0;l<o;l++){var d=n[r[l]];Crm.userDetails.isMandatorySubFormEnabled&&i.checkMandatorySubForm(r[l],t,e),null!=d&&d.forEach((function(o,n){o.$.isError&&((!Crm.userDetails.isSubformNewComponentEnabled&&!o.show||Crm.userDetails.isSubformNewComponentEnabled&&s)&&(Lyte.Component.set(o,"show",!0),s&&(s=!1)),i.handleClientErrors(o.$.error,!0,n,e,o,t,a,r[l]))}))}},getFinalErrorObjectDetails:function(e,t){if(e&&e.details&&e.details.json_path){for(var a=e.details.json_path.split("."),i=a.length,r=t.$.model.fieldList,o=e.details.api_name,n=0;n<i;n++){var s=a[n];if(-1!==s.indexOf("[")){var l=s.split("[");l&&l[0]&&r[l[0]]&&"relation"===r[l[0]].type&&(e.details.parent_api_name=l[0],e.details.index=Number(l[1].split("]")[0]))}if(s===o){var d=n-1,c=a[d];if(e.details.parent_api_name)u(store.modelFor(t.$.model.fieldList[e.details.parent_api_name].relatedTo).fieldList,c,d,a,s);else u(t.$.model.fieldList,c,d,a,s)}}function u(t,a,i,r,o){if(t[o]&&"id"!==o)e.details.api_name=o;else for(var n=!1;!n;)-1!==a.indexOf("[")&&(a=a.split("[")[0]),t[a]&&"id"!==a?(n=!0,e.details.api_name=a):(a=r[i-1],i-=1),void 0===a&&(n=!0)}return e}return e},failureFun:function(e,t,a,i,r,o,n){if(this.wizard_showHideLoadingDiv(!1),e.onreadystatechange){var s,l=e.responseText?JSON.parse(e.responseText):"";if(l.data)if(this.data.isWizardView&&t&&!t.handleSubformErrorsForWizardView)Lyte.registeredMixins["crm-formview-mixin"].handleRecordSaveErrors(e,t,a,this);else{for(var d in l)s=l[d];for(var c=s?s.length:0,u=0;u<c;u++){var m=this.getFinalErrorObjectDetails(s[u],a),p=(m=this.getFinalErrorObjectDetails(m,a)).details?m.details.api_name:"";this.handleServerErrors(m,p,t,this,a,i,r)}}else switch(l.code){case"NO_PERMISSION":renderingUtils.displayPermissionDenied();break;case"INVALID_DATA":"can't update the converted record"===l.message&&Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:[this.getData("moduleData").module_name,this.getData("dataBind").id]}),"the id given seems to be invalid"===l.message&&($L("crm-create-entity")[0].remove(),Lyte.injectResources(networkUtils.returnDependencyFiles(["crm-permission-error.js"],ResourceConstants.CRMClient),void 0,(function(){Lyte.Component.render("crm-permission-error",{brandName:Crm.appName},"#show")})))}}else this.handleClientErrors(e,!1,void 0,t,void 0,o,n)},handleBreadCrumbServerErrorsForSubforms:function(e){var t=document.querySelector("crm-create-layout");if(t.component.data.isWizard)for(var a=t.component.getData("screenHistory"),i=a?a.length:0,r=document.querySelector("lyte-step"),o=r?r.ltProp("selected"):void 0,n=0;n<i;n++)for(var s=store.peekRecord("wizard-screen",a[n].id).segments,l=s.length,d=0;d<l;d++){if("subforms"===s[d].type)for(var c=s[d].fields.mapBy("api_name"),u=c.length,m=0;m<u;m++)if(e===c[m]&&o!==a[n].index)return void t.component.handleScreenTransition(a[n].id,void 0,!0)}},handleBreadCrumbServerErrors:function(e,t){var a=this.getErrorFieldObj(e);if(a)return a;var i=document.querySelector("crm-create-layout");if(i.component.data.isWizard){for(var r=i.component.getData("screenHistory"),o=r?r.length:0,n=document.querySelector("lyte-step"),s=n?n.ltProp("selected"):void 0,l=[],d=0;d<o;d++)for(var c=store.peekRecord("wizard-screen",r[d].id).segments,u=c.length,m=0;m<u;m++){var p=c[m].type;if("fields"==p||"composite"==p||"subforms"==p){var f=c[m].fields.mapBy("api_name"),_=(c[m].fields.mapBy("id"),f.length);l=l.concat(f);for(var y=0;y<_;y++)if(e==f[y])return s!==r[d].index&&(i.component.handleScreenTransition(r[d].id,void 0,!0),i.component.getData("isWizardView"))?void Lyte.registeredMixins["crm-formview-mixin"].processError(t,i.component.data.moduleData,i.component.data.dataBind):this.getErrorFieldObj(e)}}if(a||!t||"FILTER_CRITERIA_NOT_SATISFIED"!==t.code){if(t&&store.modelFor(i.getData("moduleId")).fieldList[t.details.api_name]&&i.component.data.isWizard){var g=i.component.data.screenHistory?i.component.data.screenHistory[i.component.data.screenHistory.length-1].name:"",v=document.getElementById("postErrorPop");"save"===i.component.data.dataBind.$state?i.component.setData("invalidDataErrorMsg",I18n.getMsg("crm.wizard.update.invaliddata.desc")):i.component.setData("invalidDataErrorMsg",I18n.getMsg("crm.wizard.save.invaliddata.desc",$ESAPI.encoder().encodeForHTML(g))),v.ltProp("offset",{top:"0",left:"center"}),v.ltProp("transition",{animation:"slideFromTop",duration:"0.4"}),v.ltProp({show:!0});var h=document.querySelector("crm-create-buttons");h&&h.setData("fieldsFilled",l)}}else renderingUtils.showMsgBox(t.message,"error")}},getErrorFieldObj:function(e){if(e){var t=store.modelFor(this.getData("dataBind.$.model._name")).fieldList[e],a=this.getData("module")?this.getData("module"):this.getData("moduleName");"object"==typeof a&&(a=this.getData("modulenameUicomp"));var i="crm-create-fields#"+a+"_fldRow_"+t.columnName,r=document.querySelectorAll(i);if(-1===e.indexOf("$"))return r&&r.length||(r=document.querySelectorAll(".aggField."+e)),r=r&&r.length>=1?r[0]:void 0}},getActualClientError:function(e){return e&&-1!==e.indexOf("You do not have sufficient permission to associate this record. Contact your administrator.")?I18n.getMsg("crm.crud.lookup.inaccessible.record"):e},showValidationMsgBox:function(e,t){if(e&&e.$approval_state&&"review_process_pending"===e.$approval_state){var a=$L("crm-reviewprocess-reviewpop");0!==a.length&&a[0].remove(),Lyte.Component.render("crm-reviewprocess-reviewpop",{moduleName:moduleRecordMapping&&moduleRecordMapping[t]?moduleRecordMapping[t].plural_label:t},"#tabLayer"),$L("#rpRecordInReview")[0].ltProp("show",!0)}if(e&&e.$approval_state&&["zia_vision_validation","zia_vision_rejected"].contains(e.$approval_state)){var i=Crm.getVisionMyJobsDependency();Lyte.injectResources(i,void 0,(function(){!function(){var e=$("crm-zia-vision-error-popup");0!==e.length&&e.remove();Crm.client_tracking("Zia Vision Entity Validation Failure",{type:"image_processing"}),Lyte.Component.render("crm-zia-vision-error-popup",{moduleName:moduleRecordMapping&&moduleRecordMapping[t]?moduleRecordMapping[t].plural_label:t,action:"image_processing",isSaveAndNew:!0},"#tabLayer"),$L("#visionApproval_messageBox")[0].ltProp("show",!0)}()}))}},handleServerErrors:function(e,t,a,i,r,o,n){(function e(t,a,i,r,o,n,l){var d;if(t.code&&"MULTIPLE_OR_MULTI_ERRORS"===t.code){if(t.details&&t.details.errors){var c=!0;if(!t.details.errors.some((function(e){if(e.details&&r.getErrorFieldObj(e.details.api_name))return!0}))){var u=document.querySelector("crm-create-layout");c=u.component.getData("screenHistory").some((function(e){return store.peekRecord("wizard-screen",e.id).segments.some((function(a){if(a.fields){var i=a.fields.mapBy("api_name");return t.details.errors.some((function(t){if(t.details&&-1!==i.indexOf(t.details.api_name))return u.component.handleScreenTransition(e.id,void 0,!0),!0}))}}))}))}c?t.details.errors.forEach((function(t){t.details&&r.getErrorFieldObj(t.details.api_name)&&e(t,t.details?t.details.api_name:"",i,r,o,n,l,r)})):r.handleBreadCrumbServerErrors(void 0,{details:{api_name:"Owner"}})}return}if(t.code&&"LIMIT_EXCEEDED"===t.code&&"Services"===r.getData("module")){var m=store.modelFor(moduleRecordMapping[r.getData("module")].id).fieldList[t.details.api_name];if(m&&"SERVICESTATUS"===m.columnName)return void _cruxUtils.showCustomAlert({params:{ltPropPrimaryMessage:I18n.getMsg("crm.error.active.services.limit"),ltPropWrapperClass:"crmCenterAlert",ltPropContentAlign:"center",ltPropButtonPosition:"center",ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.nsocial.onboard.got.it"),appearance:"primary"}]}})}else if(t.details&&(void 0!==t.details.index||Crm.userDetails.SUBFORM_PERMISSIONS&&"NO_PERMISSION"===t.code&&t.details&&(r.getData("currsubformApinames").contains(t.details.api_name)||Crm.curr_sub_Form_DetailS&&Crm.curr_sub_Form_DetailS.apiNames.includes(t.details.api_name)))){if(Crm.userDetails.SUBFORM_PERMISSIONS&&"NO_PERMISSION"===t.code&&(r.getData("currsubformApinames").contains(t.details.api_name)||Crm.curr_sub_Form_DetailS&&Crm.curr_sub_Form_DetailS.apiNames.includes(t.details.api_name))){var p,f=t.details.permissions[0].split("_"),_=f?f[f.length-1]:"",y=_?moduleRecordMapping[_].actual_singular_label:"";switch(t.message){case"No Create permission for this Subform":p=I18n.getMsg("crm.sf.permission.no.create.error"," <b>"+y+"</b>");break;case"No Edit permission for this Subform":p=I18n.getMsg("crm.sf.permission.no.edit.error"," <b>"+y+"</b>");break;case"No Delete permission for this Subform":p=I18n.getMsg("crm.sf.permission.no.delete.error"," <b>"+y+"</b>")}return void renderingUtils.displayPermissionDenied(null,null,p)}r.handleBreadCrumbServerErrorsForSubforms(a,t);var g=r.getData("dataBind")[t.details.parent_api_name],v=0,h=0;c=!1;g.forEach((function(e){h++;var a=!1,i=e.$.model.fieldList;if(Object.keys(i).forEach((function(t){i[t].fieldID&&void 0!==e[t]&&(a=!0)})),a&&++v-1===t.details.index&&!c){var o='crm-create-subformsection[subform-id="'+g.model._name+'"]';document.querySelector(o).component.fetchInventoryProductDetails(e),Lyte.Component.set(e,"show",!0);var n=t.details.api_name;r.isInventoryModule(r.getData("module"))&&["Invoiced_Items","Purchase_Items","Ordered_Items","Quoted_Items"].contains(t.details.parent_api_name)&&"Price_Book_Name"===n&&(n="List_Price");var s=r.getData("module")+"_"+t.details.parent_api_name+"_R"+h+"_"+n;d=document.getElementById(s),c=!0}}))}else{if(t.details&&t.details.api_name&&"Layout"==t.details.api_name&&"INVALID_DATA"==t.code){var D=$L("#lt_create_alert_comp")[0];if(D){var b={};return b.header=I18n.getMsg("crm.label.creator.noPermission"),b.content=I18n.getMsg("crm.recordcreation.layout.permission.denied"),b.buttonData=[{type:"accept",text:I18n.getMsg("crm.button.ok"),appearance:"primary"}],$L("crm-create-entity")[0].component.setData("ltalertInfo",b),void D.ltProp("show",!0)}}var L=o.$.model.fieldList;if("INVALID_DATA"===t.code&&t.message&&-1!==t.message.indexOf("Record can't be created as child for the given parent record"))return void crmui.showMsgBand("error",I18n.getMsg("crm.tooltip.child.campaign.limit.reached",crmTab.getDisplayName("Campaigns",!1)),3e3);if("INVALID_DATA"===t.code&&t.message&&-1!==t.message.indexOf("storage space exceeds"))return void crmui.showMsgBand("error",I18n.getMsg("crm.fileuploader.entityattachments.message.507"),3e3);if("RECORD_LOCKED"===t.code&&t.message&&"Sorry, you cannot perform this operation as the record is locked."===t.message&&renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("crm.record.locking.permission.denied")),"FILTER_CRITERIA_NOT_SATISFIED"===t.code&&t.message&&"Associating record does not match the lookup filter criteria for the Lookup field"===t.message&&"Parent_Campaign"===a&&"Campaigns"===r.data.module)return void crmui.showMsgBand("error",I18n.getMsg("crm.lookup.error.campaigns.cannot.associate.to.parent"),3e3);if("INVALID_DATA"===t.code&&t.details&&t.details.api_name&&"WIZARD"===t.details.api_name.toUpperCase()){const e=$L("#lt_create_alert_comp")[0];if(e){let t={header:I18n.getMsg("crm.gdpr.notavailable.field"),content:I18n.getMsg("crm.wizard.execution.invalidwizard")};return t.buttonData=[{type:"accept",text:I18n.getMsg("crm.button.ok"),appearance:"primary"}],$L("crm-create-entity")[0].component.setData("ltalertInfo",t),void e.ltProp("show",!0)}}if("INVALID_DATA"===t.code&&l&&"clone"===l.getData("initRoute")&&L[a]&&t.details)if("multiuserlookup"===L[a].fieldType&&"DISABLED"===t.details.user_status){if(validationUtils.isNotEmpty(o[a])&&o[a].users){var C,I=l.getData("moduleData.fields").filter((function(e){return e.api_name===a}))[0];if(I){var E=[];o[a].users.forEach((function(e){var t=e[I.multiuserlookup.connectedlookup_apiname];t&&E.push(t.id)})),C=E.join(",")}if(C)return store.findAll("user",{ids:C}).then((function(e){var t=[],i=[];if(e&&e.length){e.forEach((function(e){"disabled"===e.status&&(t.push(e.full_name),i.push(e.id))}));var r=$L("#inactiveMultiUsermodal")[0];if(r){var o="Inactive users are selected in <b>"+$ESAPI.encoder().encodeForHTML(I.field_label)+"</b>.",n=l.component.data.moduleData[s];Lyte.Component.set(n,"inactiveMUserWarningmsg",o),Lyte.Component.set(n,"inactiveMUserIds",i),Lyte.Component.set(n,"inactiveMultiUsersarr",t),r.setData("multiUserFieldApi",a);var d={left:"center",top:"0px"},c={animation:"slideFromTop",duration:"0.3"};r.ltProp("transition",c),r.ltProp("offset",d),r.ltProp("showCloseButton",!1),r.ltProp("show",!0)}}}))}}else if("ownerlookup"===L[a].fieldType&&"DISABLED"===t.details.user_status)return void renderingUtils.displayPermissionDenied(void 0,void 0,I18n.getMsg("crm.alert.assign.active.user"));if(void 0===(d=r.handleBreadCrumbServerErrors(a,t))&&store.modelFor(moduleRecordMapping[r.getData("module")].id).fieldList[t.details.api_name]){"CANNOT_PERFORM_ACTION"===t.code&&renderingUtils.displayPermissionDenied({responseText:'<div id="errorMsg" style="display:none;">Insufficient privileges to perform this operation.</div>'});var R=store.modelFor(moduleRecordMapping[r.getData("module")].id).fieldList[t.details.api_name];if(R&&"relation"===R.type&&"LIMIT_EXCEEDED"===t.code&&t.details.limit){var S,F=store.peekRecord("module",R.relatedTo);S=F&&F.plural_label?F.plural_label:t.details.api_name;var O=I18n.getMsg("crm.subform.record.create.maxrow.limit",[t.details.limit,$ESAPI.encoder().encodeForHTML(S)]);crmui.showMsgBand("error",O,3e3)}if(t&&"NO_DATA"===t.code&&R&&"PRICINGDETAILS"===R.columnName&&crmui.showMsgBand("error","Cannot create/update Record. Pricing Details data not present",3e3),Crm.userDetails.isStaticSubFormEnabled&&R&&"subform"===R.cusRelationFldType)"static_subform"===(F=store.peekRecord("module",R.relatedTo)).generated_type&&-1!==t.message.indexOf("row size exceeded")&&crmui.showMsgBand("error",I18n.getMsg("crm.crud.static.subform.refresh"),3e3);if(t&&t.code&&"FILTER_CRITERIA_NOT_SATISFIED"===t.code&&"Parent_Campaign"!==a){let e,t,i,o=moduleRecordMapping[r.getData("module")].fields.filter((e=>e.api_name===a))[0];return 221===o.ui_type?(e="User",t="Users",i=I18n.getMsg("crm.user.text")):(e=o.lookup&&o.lookup.module&&o.lookup.module.api_name,t=moduleApiVsNameMapping[e],i=moduleRecordMapping[t].singular_label),$L("#subvalue_"+o.column_name)[0].setData({cxPropErrorMessage:I18n.getMsg("crm.lookupfilter.entity.errormsg",i),isError:!0}),void commonUtils.showHideLoadingDiv()}return}}if(!d&&!["DUPLICATE_LINKING_DATA","SAME_LINKING_DATA","SELF_REFERENCE_LINKING_DATA_INPUT","CANNOT_PERFORM_ACTION","BLOCKED_RECORD","DEPENDENT_SERVICE_ERROR"].contains(t.code))return(t.details&&t.details.parent_api_name&&"id"===t.details.api_name||r.data.currsubformApinames.includes(t.details.parent_api_name)&&t.details.api_name===t.details.parent_api_name&&"the given id seems to be invalid"===t.message||t.details&&t.details.api_name&&(t.details.api_name.includes("Serial_Number")||"Sequence_Number"===t.details.api_name)&&t.details.info.startsWith("Serial Number range should be between"))&&crmui.showMsgBand("error",I18n.getMsg("crm.crud.subform.deleted.record"),3e3),void(Crm.userDetails.isStaticSubFormEnabled&&t.details&&t.details.parent_api_name&&t.message&&-1!==t.message.indexOf("Statics values of an subform seems invalid")&&crmui.showMsgBand("error",I18n.getMsg("crm.crud.static.subform.refresh"),3e3));var k=d&&d.component&&d.component.data.fieldLabel?d.component.data.fieldLabel:"",w={isError:!0},N=d?d.getBoundingClientRect():"",T=N.top,M=N.left;["BLOCKED_RECORD"].contains(t.code)||(i=r.getLatestErrorFocusField(i,T,M,d));d&&d.getData("lyteViewPort")&&d.setData("lyteViewPort",!1);switch(t.code){case"MANDATORY_NOT_FOUND":if(w.code="ERR02",w.message=I18n.getMsg("crm.field.empty.check",$ESAPI.encoder().encodeForHTML(k)),d.classList.contains("aggField")){var P=$L(d).parents("crm-create-subformsection")[0];Lyte.Component.set(P.component.data.aggerrorDetails,t.details.api_name,w),d.querySelector("input").classList.add("cuserrorAborder"),d.classList.add("lcAggError")}else Lyte.Component.set(d.component.data,"errorDetails",w),d.querySelector(".FValue").classList.add("cuserrorFborder");break;case"INVALID_DATA":var A,U;if(t.message&&t.message.includes("Non Subordinate User Found"))(A=!!t.details.parent_api_name)||(U=r.getData("dataBind.$.model.fieldList")[t.details.api_name].columnName),!A&&U.includes("MXN")?w.message=I18n.getMsg("crm.record.creation.multiuserlookup.alert.manage.subordinate.user",t.message.split("-")[1]):w.message=I18n.getMsg("crm.record.creation.userlookup.alert.manage.subordinate.user");else t.message&&"Invalid Currency code"===t.message?w.message=I18n.getMsg("crm.currency.active.check"):t.message&&"invalid data"!==t.message?w.message=r.getActualClientError(t.message):t.message&&"invalid data"===t.message&&t.details&&t.details.info_message?w.message=t.details.info_message:w.message=I18n.getMsg("crm.field.valid.check",$ESAPI.encoder().encodeForHTML(k));var x,V,B=r.getData("dataBind.$.model.fieldList");if(t.details.parent_api_name){var j=store.modelFor(B[t.details.parent_api_name].relatedTo).fieldList[t.details.api_name];x=j.fieldType,V=j.type}else x=B[t.details.api_name].fieldType,V=B[t.details.api_name].type;if(w.message=t.details.maximum_length&&"multiselectlookup"===x?I18n.getMsg("crm.listview.maximum.records.alert",t.details.maximum_length):w.message,!t.details.maximum_length||"fileupload"!=x&&"imageupload"!=x){if(t.details.maximum_length&&("text"===x||"string"===V?w.message=I18n.getMsg("crm.iamexception.maxlen",[t.details.maximum_length,$ESAPI.encoder().encodeForHTML(k)]):"number"!==V&&"phone"!==x||(w.message=I18n.getMsg("crm.field.length.check",$ESAPI.encoder().encodeForHTML(k)))),t.message&&"invalid data"===t.message&&"lookup"===x&&(w.message=I18n.getMsg("crm.crud.lookup.inaccessible.record"),r.isInventoryModule(r.getData("module"))&&["Invoiced_Items","Purchase_Items","Ordered_Items","Quoted_Items"].contains(t.details.parent_api_name)&&"Price_Book_Name"===t.details.api_name&&(w.message=I18n.getMsg("crm.crud.lookup.module.inaccessible"))),Lyte.Component.set(d.component.data,"errorDetails",w),!t.details.parent_api_name&&d){var Y=d.querySelector(".FValue");if(Y)Y.classList.add("cuserrorFborder");else{var q=!!d.classList.contains("aggField");r.setErrorObject(d,w,q,t.details.api_name)}}}else{var z="";z="fileupload"===x?I18n.getMsg("crm.attachment.fileUploadField.Maxlen.check.field",[t.details.maximum_length,$ESAPI.encoder().encodeForHTML(k)]):I18n.getMsg("crm.imageupload.allowed.length",[t.details.maximum_length,$ESAPI.encoder().encodeForHTML(k)]),w.message=z,d.component.data.errorDetails=w,crmui.showMsgBand("error",z,3e3)}break;case"DUPLICATE_LINKING_DATA":Crm.getCrmBasePath(),r.getData("module"),t.details.id;store.findRecord(moduleRecordMapping[r.getData("module")].id,t.details.id,{approved:"both"},!0).then((function(e){var a=I18n.getMsg("crm.linking.module.duplicate.warning",[r.getData("module"),t.details.id,e[0].Name,Crm.getCrmBasePath()]);renderingUtils.showCustomAlert(a,"",!0)}));break;case"SAME_LINKING_DATA":case"SELF_REFERENCE_LINKING_DATA_INPUT":var W=I18n.getMsg("crm.linking.module.sameassociation.warning");renderingUtils.showCustomAlert(W,"",!0);break;case"DUPLICATE_DATA":if(t.details&&t.details.more_records&&Crm.userDetails.permissions["Crm_Implied_Merge_"+r.getData("module")]?(w.message=I18n.getMsg("crm.duplicate.value.not.allowed")+" "+I18n.getMsg("crm.duplicate.value.available.multiple",[null!=moduleRecordMapping[t.details.duplicate_record.module.api_name]?$ESAPI.encoder().encodeForHTML(moduleRecordMapping[t.details.duplicate_record.module.api_name].singular_label.toLowerCase()):$ESAPI.encoder().encodeForHTML(r.getData("singularLabel").toLowerCase()),$ESAPI.encoder().encodeForHTML(k)]),w.more_records=!0):w.message=I18n.getMsg("crm.duplicate.value.not.allowed")+" "+I18n.getMsg("crm.duplicate.value.available",[null!=moduleRecordMapping[t.details.duplicate_record.module.api_name]?$ESAPI.encoder().encodeForHTML(moduleRecordMapping[t.details.duplicate_record.module.api_name].singular_label.toLowerCase()):$ESAPI.encoder().encodeForHTML(r.getData("singularLabel").toLowerCase()),$ESAPI.encoder().encodeForHTML(k)]),w.duplicateFdetails={},w.duplicateFdetails.id=t.details&&t.details.duplicate_record?t.details.duplicate_record.id:void 0,w.duplicateFdetails.key=t.details.api_name,w.duplicateFdetails.dupFieldLabel=k,w.duplicateFdetails.dupColName=d.component.data.columnName,w.duplicateFdetails.modLabel=null!=moduleRecordMapping[t.details.duplicate_record.module.api_name]?moduleRecordMapping[t.details.duplicate_record.module.api_name].singular_label:r.getData("singularLabel"),w.duplicateFdetails.moduleN=null!=moduleRecordMapping[t.details.duplicate_record.module.api_name]?moduleRecordMapping[t.details.duplicate_record.module.api_name].api_name:r.getData("module"),w.duplicateFdetails.modPluLabel=null!=moduleRecordMapping[t.details.duplicate_record.module.api_name]?moduleRecordMapping[t.details.duplicate_record.module.api_name].plural_label:r.getData("moduleData").plural_label,w.duplicateFdetails.detailsFromserver=t.details,!d.classList.contains("aggField")){var H=d.component.data.moduleData.fields.filter((function(e){return e.api_name===d.component.data.apiName}));w.duplicateFdetails.isFieldEnc=null!==H[0].crypt}if(d.classList.contains("aggField")){P=$L(d).parents("crm-create-subformsection")[0];Lyte.Component.set(P.component.data.aggerrorDetails,t.details.api_name,w),d.querySelector("input").classList.add("cuserrorAborder"),d.classList.add("lcAggError")}else Lyte.Component.set(d.component.data,"errorDetails",w),d.querySelector(".FValue").classList.add("cuserrorFborder");break;case"CANNOT_PERFORM_ACTION":renderingUtils.displayPermissionDenied({responseText:'<div id="errorMsg" style="display:none;">Insufficient privileges to perform this operation.</div>'});break;case"RECORD_IN_BLUEPRINT":i&&i.firstErrorfield&&i.firstErrorfield.component&&i.firstErrorfield.setData("isNoErrorFocus",!0),crmui.showMsgBand("error",I18n.getMsg("crm.process.criteria.pop.info"),3e3);break;case"DEPENDENT_SERVICE_ERROR":case"CANNOT_PROCESS":"error"===t.status&&t.details&&"UNAUTHORIZED_CAMPAIGN_USER"===t.details.dependency_error?crmui.showMsgBand("error",I18n.getMsg("crm.campaign.non.campaign.user.error.dynamic",Crm.integrationsAppName.ZOHO_CAMPAIGNS),3e3):t.message&&"error"===t.status&&crmui.showMsgBand("error",t.message,3e3);break;case"BLOCKED_RECORD":var K=document.querySelector("#emailblValidation");if(K){var Q={left:"center",top:"0px"},G={animation:"slideFromTop",duration:"0.3"};K.ltProp("transition",G),K.ltProp("offset",Q),K.ltProp("showCloseButton",!1),K.ltProp("show",!0)}$("#createskipblocklistValidation").on("click",(function(){K.ltProp("show",!1);var e="draft"===o.$state;e&&r.wizard_showHideLoadingDiv(!0),document.querySelector("crm-create-layout").setData("disableFormbuttons",!0),o.$.save({skipblocklistValidation:!0},void 0,{skipValidation:e,validateOnSave:e}).then((function(t){r.wizard_showHideLoadingDiv(!1);var a=r.getData("module");Crm.trackSpotLightAction("MPL - Record Edited",{Module:a}),r.succFun(t,n,o.$state,l,e),r.focusErrorField(i),"Leads"!=a&&"Contacts"!=a&&"Potentials"!=a||Crm.trackSpotLightAction(a+" - Added")}),(function(e){r.wizard_showHideLoadingDiv(!1),r.validateSubform(i),r.failureFun(e,i,o),r.focusErrorField(i),l.setData("disableFormbuttons",!1),event.preventDefault()}))}));break;case"LIMIT_EXCEEDED":if(d.component.data&&d.component.data.uiType===CrmField.UITYPES.IMAGE_UPLOAD){z="";z=I18n.getMsg("crm.imageupload.allowed.length",[t.details.maximum_length||t.details.limit,$ESAPI.encoder().encodeForHTML(k)]),w.message=z,d.component.data.errorDetails=w,crmui.showMsgBand("error",z,3e3)}else w.message=t.message&&"invalid data"!==t.message?t.message:I18n.getMsg("crm.field.valid.check",k),Lyte.Component.set(d.component.data,"errorDetails",w),t.details.parent_api_name||d.querySelector(".FValue").classList.add("cuserrorFborder");break;case"MAPPING_MISMATCH":w.message=t&&t.message&&"invalid data"!==t.message?t.message:I18n.getMsg("crm.field.valid.check",k),t&&t.details&&("Pipeline"===t.details.mapped_field&&"Stage"===t.details.api_name?w.message="Pipeline "+I18n.getMsg("doesn't contain")+" "+I18n.getMsg("crm.label.the")+" Stage":("Layout"===t.details.mapped_field&&"Pipeline"===t.details.api_name||"Pipeline"===t.details.mapped_field&&"Layout"===t.details.api_name)&&(w.message="Layout "+I18n.getMsg("doesn't contain")+" "+I18n.getMsg("crm.label.the")+" Pipeline")),Lyte.Component.set(d.component.data,"errorDetails",w),t.details.parent_api_name||d.querySelector(".FValue").classList.add("cuserrorFborder");break;case"FILTER_CRITERIA_NOT_SATISFIED":var J;if(t.details.parent_api_name){var Z=r.getData("moduleData.currsubformApinames").filter((function(e){return e===t.details.parent_api_name})),X=r.getData("moduleData.fields").filter((function(e){return("subform"===e.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===e.data_type)&&e.subform.module===Z[0]}));J=X[0].subformFields.filter((function(e){return e.api_name===t.details.api_name}))}else J=r.getData("moduleData.fields").filter((function(e){return e.api_name===t.details.api_name}));var ee="";if(221===J[0].ui_type||55===J[0].ui_type)ee=I18n.getMsg("crm.field.label.user.lookup");else if(moduleRecordMapping[J[0].lookup.module.api_name])ee=moduleRecordMapping[J[0].lookup.module.api_name].singular_label;else if(moduleDetailedInfo.modules){const e=J[0].lookup.module.api_name;let t=moduleDetailedInfo.modules.filter((function(t){return t.api_name===e}))[0];t&&t.singular_label&&(ee=t.singular_label)}w.message=I18n.getMsg("crm.lookupfilter.entity.errormsg",ee),Lyte.Component.set(d.component.data,"errorDetails",w),d.querySelector(".FValue").classList.add("cuserrorFborder");break;case"NOT_ALLOWED":w.message="can't add inactive product in the inventory"===t.message?I18n.getMsg("crm.select.product.deleted"):t.message,"Linked_Products"===a&&-1!==t.message.indexOf("product is inactive")&&r.data&&r.data.module&&"Bundles"===r.data.module&&(w.message=I18n.getMsg("bundles.product.inactive.alert",moduleRecordMapping.Products.singular_label)),Lyte.Component.set(d.component.data,"errorDetails",w),t.details.parent_api_name||d.querySelector(".FValue").classList.add("cuserrorFborder");break;default:w.message=t.message&&"invalid data"!==t.message?t.message:I18n.getMsg("crm.field.valid.check",$ESAPI.encoder().encodeForHTML(k)),Lyte.Component.set(d.component.data,"errorDetails",w),!t.details.parent_api_name&&d.querySelector(".FValue").classList.add("cuserrorFborder")}})(e,t,a,i=i||this,r,o,n),i.setData("reasonforLoss","");var s=i.data.currentInstObjKey},handleClientErrors:function(e,t,a,i,r,o,n,s){var l=this,d=t?r.lookupError:this.getData("dataBind.lookupError");if(d)for(var c in d)e[c]=d[c];var u=function(e){return e.api_name===m};for(var m in e){var p=e[m];if(o&&"ERR02"==p.code)i.isValidErrorPresent||(i.skipMandatoryCheck=!0);else{i.isValidErrorPresent=!0;var f=document.querySelector("crm-create-layout"),_=f.component;if(!n||"ERR08"!=p.code&&"ERR03"!=p.code){var y,g,v;if(t){var h="crm-create-subformfields#"+l.getData("moduleData").module_name+"_"+s+"_R"+(a+1)+"_"+m;y=$L(h)[0]}else y=this.handleBreadCrumbServerErrors(m);"inActiveCurrency"===p.code&&!y&&Lyte.registeredMixins["crm-canvas-view-rules"]&&Lyte.registeredMixins["crm-canvas-view-rules"].isCanvasFormView&&Lyte.registeredMixins["crm-formview-mixin"].validateRecordCurrencyField();var D=!1,b=document.querySelector("#"+_.data.moduleName+"_SubForm_"+s);if(!y&&Crm.userDetails.isSubformNewComponentEnabled&&t&&$L("#"+m+"_dummy"+a).length>0)D=!0,v=b.component.data.actualSubformFields.filter(u)[0],g=f.component.data.dataBind[s][a];else if(!y){var L=f.component.getData("currsubformApinames");L.length>0&&L.forEach((function(e){void 0!==f.component.data.dataBind[e]&&f.component.data.dataBind[e].forEach((function(e){store.$.clrRecErr(e.$)}))})),delete _.data.dataBind.$.error[m];continue}var C=y&&y.component&&y.component.data.fieldLabel?y.component.data.fieldLabel:"";D&&(C=v.field_label);var I=y?!!y.classList.contains("aggField"):"";D||$L.fastdom.measure(function(e,t,a){var r=e?e.getBoundingClientRect():"",o=r.top,n=r.left;i=0==p.code?i:l.getLatestErrorFocusField(i,o,n,e,t,a)}.bind(l,y,t,I));var E={};if(D&&(E.errorFieldClass="subFormDummyFldErrorClass"),E.code=p.code,"ERR02"===p.code&&y&&y.component){var R,S,F=y.component.data;validationUtils.isNotEmpty(F.dataBind)?(S=F.dataBind,R=F.moduledataUicomp):validationUtils.isNotEmpty(F.databindSubform)&&(S=F.databindSubform,R=F.subformFields);var O=S?S.lookupError:void 0;if(!t&&validationUtils.isNotEmpty(O)&&R&&"lookup"===R.data_type&&validationUtils.isNotEmpty(O[R.api_name]))return}switch(p.code){case"ERR02":F=D?void 0:y.component.data;if(!(F=I||t?void 0:F)||"Events"===F.modulenameUicomp||"Who_Id"!==F.moduledataUicomp.api_name&&"What_Id"!==F.moduledataUicomp.api_name)if(F&&"Events"===F.modulenameUicomp&&"What_Id"===F.moduledataUicomp.api_name){var k=y.component.data.currentRelatedToOption,w=y.querySelectorAll("crm-create-fields");switch(k){case"None":E.message=I18n.getMsg("crm.field.empty.check",I18n.getMsg("crm.right.panel.relatedto")),l.setErrorObject(y,E,I,m,t);break;case"Leads":var N=w[0];E.message=I18n.getMsg("crm.field.empty.check",I18n.getMsg("Leads")),l.setErrorObject(N,E,I,m,t);break;case"Contacts":if(!this.getData("dataBind").Who_Id){N=w[0];E.message=I18n.getMsg("crm.field.empty.check",I18n.getMsg("crm.label.title.contact")),l.setErrorObject(N,E,I,m,t);break}case"Others":var T=(N=w[0]).component.data.multiFieldDropdownDispVal;E.message=I18n.getMsg("crm.field.empty.check",I18n.getMsg(T)),l.setErrorObject(N,E,I,m,t)}}else F&&F.uiType===CrmField.UITYPES.MULTI_DATE_SELECT?(E.code="MULTISELECTERROR",E.errorDetails={0:I18n.getMsg("crm.field.empty.check",I18n.getMsg("crm.label.date"))},l.setMutltiselectErrorObject(y,E,I,m,t)):(void 0===F||F&&F.uiType!==CrmField.UITYPES.FILE_UPLOAD&&F.uiType!==CrmField.UITYPES.IMAGE_UPLOAD)&&("Bundles"===this.getData("module")&&this.data.dataBind.Linked_Products&&this.data.dataBind.Unique_Item_Count<2&&"MXNDUMMYCOLUMNBUNDLE"===y.component.data.columnName?E.message=I18n.getMsg("bundles.minimum.product.check",["2",moduleRecordMapping.Products.plural_label,moduleRecordMapping.Bundles.singular_label]):E.message=I18n.getMsg("crm.field.empty.check",$ESAPI.encoder().encodeForHTML(C)),l.setErrorObject(y,E,I,m,t,D)&&Lyte.objectUtils(g.dummyErrorDetails,"add",m,E));else"Who_Id"===F.moduledataUicomp.api_name?"Leads"!==F.currentRelatedToOption&&"Contacts"!==F.currentRelatedToOption||(E.message=I18n.getMsg("crm.field.empty.check",F.ctDropdownDispVal),l.setErrorObject(y,E,I,m,t)):"What_Id"===F.moduledataUicomp.api_name?(E.message=I18n.getMsg("crm.field.empty.check",F.multiFieldDropdownDispVal),l.setErrorObject(y,E,I,m,t)):(E.message=I18n.getMsg("crm.field.empty.check",$ESAPI.encoder().encodeForHTML(C)),l.setErrorObject(y,E,I,m,t));break;case"ERR03":case"ERR08":E.message=I18n.getMsg("crm.field.valid.check",$ESAPI.encoder().encodeForHTML(C)),"Bundles"===this.getData("module")&&"BUNDLECODE"===y.component.data.columnName&&e.hasOwnProperty("Bundle_Code")&&e.Bundle_Code.value&&e.Bundle_Code.value.includes(" ")&&(E.message=e.Bundle_Code.message?e.Bundle_Code.message:I18n.getMsg("bundles.field.space.alert",$ESAPI.encoder().encodeForHTML(C))),l.setErrorObject(y,E,I,m,t,D)&&Lyte.objectUtils(g.dummyErrorDetails,"add",m,E);break;case"ERR04":E.message=I18n.getMsg("crm.field.valid.decimal.check2",[$ESAPI.encoder().encodeForHTML(C),p.allowedDecimal]),l.setErrorObject(y,E,I,m,t,D)&&Lyte.objectUtils(g.dummyErrorDetails,"add",m,E);break;case"ERR06":var M=!1;(F=D?void 0:y.component.data)&&F.moduledataUicomp&&["QUESTIONS","ANSWERS","ADDCOMMENT"].contains(F.moduledataUicomp.column_name)&&"Solutions"===F.modulenameUicomp&&(M=!0),E.message="Campaign_Name"===m||"Native__Campaigns__Extn__Campaign_Subject"===m||"Native__Campaigns__Extn__Sender_Name"===m?I18n.getMsg("crm.criteria.editor.no.of.characters.exceed",[$ESAPI.encoder().encodeForHTML(C),p.expected]):M?I18n.getMsg("crm.iamexception.maxlen",[F.moduledataUicomp.length,$ESAPI.encoder().encodeForHTML(C)]):I18n.getMsg("crm.field.length.check",[$ESAPI.encoder().encodeForHTML(C)]),l.setErrorObject(y,E,I,m,t,D)&&Lyte.objectUtils(g.dummyErrorDetails,"add",m,E);break;case"MULTISELECTERROR":l.setMutltiselectErrorObject(y,p,I,m,t);break;case"inActiveCurrency":E.message=I18n.getMsg("crm.currency.active.check"),l.setErrorObject(y,E,I,m,t);break;default:E.message=p.message?p.message:"invalid data in Client",E.msg2=p.createMsg?p.createMsg:void 0,"mxncloneproceed"===p.code&&(E.message=""),l.setErrorObject(y,E,I,m,t,D)&&Lyte.objectUtils(g.dummyErrorDetails,"add",m,E)}}else t?delete r.$.error[m]:delete _.data.dataBind.$.error[m]}}},wizard_showHideLoadingDiv:function(e,t){let a=$L(".wiz_loading"),i=$("body"),r=$L(".wiz_loading .wiz_loading_content");e?(!0===t?r.css("display","none"):r.css("display",""),a.show(),i.addClass("oH")):(r.hide(),a.hide(),i.removeClass("oH"))},bindDateTimetoNode:function(e,t,a,i){var r=t.$node.querySelector('lyte-input[lt-prop-type="date"]'),o=t.$node.querySelector('lyte-input[lt-prop-type="time"]');if(e){var n,s;if(-1==e.indexOf("TV")){var l=t.getDateTimeObjFromString(e);l.date?((n=[]).push(l.date),n.push(l.time),s=l.time):s=(n=e.split(" ")).length>=2?2==n.length?n[1]:n[1]+" "+n[2].toUpperCase():""}else s=(n=e.split("TV")).length>=2?n[1]:"";r&&o&&(r.component.setData("ltPropCurrentDate",n[0]),o.component.setData("ltPropDefaultTime",s))}i&&!e&&(o.component.setData("ltPropDefaultTime",this.getData("userTimeobj.currTime")),$L(r.querySelector("input")).val(""),r.component.setData("ltPropCurrentDate",""),Lyte.Component.set(t.getData("dataBind"),a,void 0))},handleEntityRecordChanges:function(e,t){var a=this,i=a.getData("moduleData.module_name"),r=this.data.currentInstObjKey;if(e){function o(e,o){e.forEach((function(e){var n="#"+i+"_fldRow_"+e.columnName+" crux-user-dropdown",s=t[e.apiName],l=a.$node.querySelector(n);if("edit"==a.getData("initRoute")&&8==a.getData("uiType")&&a.setData("editOwnerlabel",s.name?s.name:s.full_name),l&&Lyte.Component.registeredHelpers.isNotEmpty(s))if(o){(u={}).id=s.id,u.full_name=s.name?s.name:s.full_name,l.component.setData("cxPropSelectedUser",u),u.name=s.name?s.name:s.full_name,t[e.apiName]=u,a.setCScriptSkipFlagForField(e.fieldId),s.id===u.id&&s.full_name===u.full_name||(t[e.apiName]=u);var d=store.peekRecord("field",e.fieldId);if(d&&delete d[r].skipCscriptExecutionforField,"userlookup"===a.data.moduledataUicomp.data_type){var c=a.$node.querySelector(".lcSingleUser");c&&c.classList.remove("lcSingleUser")}}else{s=s.users;var u=[],m=[];s.forEach((function(t){t=t[e.connectingApiname];var a={};a.id=t.id,m.push(t.id),a.full_name=t.name,u.push(a)}));let t=$L("crm-create-layout")[0].component;if(t.data.isWizard&&"edit"===a.getData("initRoute")){let a=t.shelvedData;a[e.apiName]&&a[e.apiName].usersData&&(u=a[e.apiName].usersData)}l.component.setData("cxPropSelectedUsers",u),l._callee.component.setData("userRecordids",m)}}))}function n(e,t){var a=t.getData("whatIdSelectedObj");if("Events"===t.getData("modulenameUicomp")||"Events"!==t.getData("modulenameUicomp")&&("Who_Id"===t.getData("moduledataUicomp").api_name||"What_Id"===t.getData("moduledataUicomp").api_name)){if("What_Id"===t.getData("moduledataUicomp").api_name){var i=t.getData("whatIdModuleArray");if(i&&i.length>0){var r=t.querySelector("#Crm_"+t.getData("modulenameUicomp")+"_"+t.getData("moduledataUicomp").column_name+"_select");r&&r.setData("preventSelectedObs",!1),t.setData("ctSelectedValue",a.module_name),t.setData("currentCtSelectedValue",a.module_name),t.setData("currentWhatIdValue",moduleRecordMapping[a.module_name].id),"Events"===t.getData("modulenameUicomp")&&"modelListField"===t.getData("whatIdSelectedOption")&&t.setData("modId",moduleRecordMapping[i[0].module_name].id),t.setData("currentWhatIdModuleApiName",moduleApiMapping[a.module_name])}}return"Events"!==t.getData("modulenameUicomp")||(!e||t.getData("whatIdSelectedOption"))&&e||(t.setData("currentRelatedToOption","None"),t.setData("selectedCurrentRelatedToOption","None")),!0}return!1}e.picklist&&e.picklist.length&&e.picklist.forEach((function(e){var r,o="#"+i+"_fldRow_"+e.columnName+" lyte-dropdown",n=a.$node.querySelector(o);n&&(t&&t.$.error&&t.$.error[e.apiName]&&"ERR02"===t.$.error[e.apiName].code?(r="-None-",n.ltProp("selected",r)):r=n.ltProp("selected"),n&&n.ltProp("displayValue",r),"-None-"!=r&&n.classList.contains("noneSelected")&&n.classList.remove("noneSelected"),"-None-"==r&&!n.classList.contains("noneSelected")&&n.classList.add("noneSelected"))})),e.datetime&&e.datetime.length&&e.datetime.forEach((function(e){var i=t[e.apiName];a.bindDateTimetoNode(i,a,e.apiName)})),e.userlookup&&e.userlookup.length&&o(e.userlookup,!0),e.multiuserlookup&&e.multiuserlookup.length&&o(e.multiuserlookup,!1),e.ownerlookup&&e.ownerlookup.length&&o(e.ownerlookup,!0),e.lookup&&e.lookup.length&&e.lookup.forEach((function(e){var r="#"+i+"_fldRow_"+e.columnName,o="CRM-CREATE-FIELDS"==a.$node.tagName?a.$node:a.$node.querySelector(r),s=t[e.apiName];if(o){var l=t,d=o.getData("whatIdSelectedObj");if(("Who_Id"===e.apiName||"What_Id"===e.apiName)&&("Events"!==o.getData("modulenameUicomp")?"Who_Id"===e.apiName&&o&&Lyte.Component.registeredHelpers.isNotEmpty(t.What_Id):"What_Id"===e.apiName&&o&&Lyte.Component.registeredHelpers.isNotEmpty(t.Who_Id))||validationUtils.isNotEmpty(s))if(l.$se_module){if("Events"===o.getData("modulenameUicomp")){var c,u=o.getData("selectedParticipents"),m=o.getData("selectedWhoWhatObj"),p=l.Participants,f=p.length;if("Who_Id"===(c=l.$se_module&&"Contacts"===l.$se_module?"Who_Id":"What_Id")||"What_Id"===c&&"Leads"===l.$se_module){for(var _=0;_<f;_++)if(m[c].id===p[_].participant){if("Who_Id"===c){u.Contacts=m[c];break}u.Leads=m[c];break}if(m[c]&&m[c].Email&&m[c].Email.length>0&&(l.Who_Id&&Object.keys(l.Who_Id).length&&(0!==Object.keys(u.Contacts).length&&o.setData("contactParticipentChecked",!0),o.setData("contactRadiobutton",l.Who_Id)),l.What_Id&&Object.keys(l.What_Id).length)){u=o.getData("selectedParticipents");"Leads"===l.$se_module&&(0!==Object.keys(u.Leads).length&&o.setData("leadParticipentChecked",!0),o.setData("leadsRadiobutton",l.What_Id))}}o.setData("selectedParticipents",u)}if("Events"!==o.getData("modulenameUicomp")&&("Who_Id"===o.getData("moduledataUicomp").api_name||"What_Id"===o.getData("moduledataUicomp").api_name)||"Events"===o.getData("modulenameUicomp")){var y="",g=o.getData("whatIdModuleArray"),v=g.length;if("Leads"===l.$se_module)y="Leads";else if("Contacts"===l.$se_module)y="Contacts";else for(var h=0;h<v;h++)if(g[h].api_name===l.$se_module){y=g[h].module_name;break}}if("Events"!==o.getData("modulenameUicomp")){var D=o.getData("currentInstObjKey");if("Who_Id"===o.getData("moduledataUicomp").api_name){var b='crm-create-fields[record-name="'+t.$.model._name+'"].What_Id',L=document.querySelector(b);if(l.Who_Id){if(o.setData("currentRelatedToOption","Contacts"),o.setData("selectedCurrentRelatedToOption","Contacts"),o.setData("currentModuleId",moduleRecordMapping.Contacts.id),L&&L.setData("whoAndWhatDisability",!1),"Contacts"!==y)o.setData("currentPossibleSeModule",y);else(F=o.getData("whatIdModuleArray"))&&F.length>0&&o.setData("currentPossibleSeModule",d.module_name);o.setData("lookupSingle",l.Who_Id.name),o.setData("editInit",!0),o.setData("selectedSingleId",l.Who_Id.id)}else if(l.What_Id&&"Leads"===y)o.setData({modId:moduleRecordMapping.Leads.id,isSingle:!0}),o.setData("currentRelatedToOption","Leads"),o.setData("selectedCurrentRelatedToOption","Leads"),o.setData("currentModuleId",moduleRecordMapping.Leads.id),L&&L.setData("whoAndWhatDisability",!0),o.setData("lookupSingle",l.What_Id.name),o.setData("editInit",!0),o.setData("selectedSingleId",l.What_Id.id);else if(l.What_Id&&"Leads"!==y){var C,I;I=(C=o.getData("moduleData").fields).length;for(_=0;_<I;_++)if("What_Id"===C[_].api_name){Lyte.objectUtils(o.getData("moduleData").fields[_][D],"add","currentPossibleSeModule",y);break}}}else if("What_Id"===o.getData("moduledataUicomp").api_name&&l.What_Id){var E=o.querySelector("#Crm_"+o.getData("modulenameUicomp")+"_"+o.getData("moduledataUicomp").column_name+"_select");if(E&&E.setData("preventSelectedObs",!1),"Leads"!==y){var R,S;o.setData("ctSelectedValue",y),o.setData("currentCtSelectedValue",y),o.setData("currentPossibleSeModule",y),S=(R=o.getData("moduleData").fields).length;for(_=0;_<S;_++)if("Who_Id"===R[_].api_name){Lyte.objectUtils(o.getData("moduleData").fields[_][D],"add","currentPossibleSeModule",y);break}o.setData("currentWhatIdValue",moduleRecordMapping[y].id),o.setData("modId",moduleRecordMapping[y].id),o.setData("currentWhatIdModuleApiName",moduleApiMapping[y]),o.setData("whoAndWhatDisability",!1),o.setData("lookupSingle",l.What_Id.name),o.setData("editInit",!0),o.setData("selectedSingleId",l.What_Id.id)}else{(F=o.getData("whatIdModuleArray"))&&F.length>0&&(o.setData("ctSelectedValue",d.module_name),o.setData("currentCtSelectedValue",d.module_name)),o.setData("whoAndWhatDisability",!0)}}else if("What_Id"===o.getData("moduledataUicomp").api_name&&!l.What_Id){var F;(F=o.getData("whatIdModuleArray"))&&F.length>0&&o.setData("currentPossibleSeModule",d.module_name)}}else if("Events"===o.getData("modulenameUicomp")){m=o.getData("selectedWhoWhatObj");var O=!1,k=!1;l.What_Id&&Object.keys(l.What_Id).length&&(k=!0),l.Who_Id&&Object.keys(l.Who_Id).length&&(O=!0),void 0!==o.getData("whatIdSelectedOption")&&null!==o.getData("whatIdSelectedOption")||("Leads"===y?(o.setData("currentRelatedToOption","Leads"),o.setData("selectedCurrentRelatedToOption","Leads")):"Contacts"===y||"Contacts"!==y&&O?(o.setData("currentRelatedToOption","Contacts"),o.setData("selectedCurrentRelatedToOption","Contacts")):(o.setData("currentRelatedToOption","Others"),o.setData("selectedCurrentRelatedToOption","Others"))),"Leads"===o.getData("whatIdSelectedOption")?(o.setData("currentModuleId",moduleRecordMapping.Leads.id),o.setData("lookupSingle",l.What_Id.name),o.setData("editInit",!0),o.setData("selectedSingleId",l.What_Id.id),o.setAddressForLocField(m.What_Id)):"Contacts"===o.getData("whatIdSelectedOption")?(o.setData("currentModuleId",moduleRecordMapping.Contacts.id),O&&(o.setData("lookupSingle",l.Who_Id.name),o.setData("editInit",!0),o.setData("selectedSingleId",l.Who_Id.id),o.setAddressForLocField(m.Who_Id))):"modelListField"===o.getData("whatIdSelectedOption")&&(k?(o.setData("currentWhatIdValue",moduleRecordMapping[y].id),o.setData("modId",moduleRecordMapping[y].id),o.setData("currentWhatIdModuleApiName",moduleApiMapping[y]),o.setData("ctSelectedValue",y),o.setData("currentCtSelectedValue",y),o.setData("lookupSingle",l.What_Id.name),o.setData("editInit",!0),o.setData("selectedSingleId",l.What_Id.id),o.setData("currentPossibleSeModule",y),o.setAddressForLocField(m.What_Id)):(o.setData("ctSelectedValue",d.module_name),o.setData("currentCtSelectedValue",d.module_name),o.setData("currentWhatIdValue",d.id),o.setData("modId",d.id),o.setData("currentWhatIdModuleApiName",moduleApiMapping[d.module_name]),o.setData("currentPossibleSeModule",d.module_name)))}}else n(!1,o)||(o.component.setData("lookupSingle",s.name),s.id&&o.component.setData({editInit:!0,selectedSingleId:s.id}));else n(!0,o)}})),e.multiselectlookup&&e.multiselectlookup.length&&e.multiselectlookup.forEach((function(e){var r,o="#"+i+"_fldRow_"+e.columnName,n="CRM-CREATE-FIELDS"==a.$node.tagName?a.$node:a.$node.querySelector(o),s=t[e.apiName],l=s&&s.length?s.length:0;n&&l&&(r=1==l?s[0][e.connectingApiname].name:2==l?s[0][e.connectingApiname].name+", "+s[1][e.connectingApiname].name:s[0][e.connectingApiname].name+", "+s[1][e.connectingApiname].name+".. &More",n.component.setData("lookupListstring",r))}))}},fieldInPath:function(e){const t=$L("crm-create-layout");if(t&&t.length){var a=t[0];if(a){var i=a.getData("screenHistory");if(i&&i.length)return i.some((function(t){const a=store.peekRecord("wizard-screen",t.id);if(a)return a.segments.mapBy("id").some((function(t){return void 0!==e[t]}))}))}}return!0},checkCriteriaMatch:function(e,t,a,i,r,o,n,s,l){var d=r.data.currentInstObjKey;if(!e.group_operator&&null==e.length)return h(e,a,r,i,o,n,s);if(e.group_operator){var c=[],u=0;_=e.group_operator;for(var m=e.group,p=m.length,f=0;f<p;f++)m[f].group_operator?c[u++]=r.checkCriteriaMatch(m[f],t,a,i,r,o,n,s,l):c[u++]=h(m[f],a,r,i,o,n,s);if(!l&&(void 0===c[0]||void 0===c[1]))return;switch(_){case"and":return c[0]&&c[1];case"or":return c[0]||c[1]}}else{c=[],u=0;var _,y=e;for(var g in y)null==y[g].length||"string"==typeof y[g]?"object"==typeof y[g]?c[u++]=h(y[g],a,r,void 0,o,n,s):"string"==typeof y[g]&&(_=y[g]):"function"!=typeof y[g]&&(c[u++]=r.checkCriteriaMatch(y[g],t,a,i,r,o,n,s,l));if(!l&&(void 0===c[0]||void 0===c[1]))return;switch(_){case"and":return c[0]&&c[1];case"or":return c[0]||c[1]}}function v(e,t,a){if(Lyte.registeredMixins["crm-detailcanvas-utils"]&&(Lyte.registeredMixins["crm-detailcanvas-utils"].isFormViewCommonCheck()||Lyte.registeredMixins["crm-detailcanvas-utils"].isWizardView()))return(i=store.peekRecord("field",t))||void 0;var i,r=a&&a.layoutMeta?a.layoutMeta.fields:e.getData("moduleData.fields");if(r=e.data.isNewSubformUI&&e.data.module_info?e.data.module_info.fields:r,!!(e&&e.data&&e.data.globalData&&("quickCreate"===e.data.globalData.formType&&"quick_create"===e.data.globalData.currentViewType||e.data.globalData.injectSections))&&e.data.globalData.moduleSections&&e.data.globalData.currentInstObjKey){for(var o=[],n=e.data.globalData.moduleSections,s=e.data.globalData.currentInstObjKey,l=0,d=n.length;l<d;l++)"used"===n[l][s].type&&n[l][s].isvalidSection&&(o=o.concat(n[l].fields));r=o}return r&&1===(i=r.filter((function(e){return e.id==t}))).length?i[0]:void 0}function h(e,a,i,r,o,n,s){var l=t,c=e.field.api_name;-1!==c.indexOf(".")&&(c=c.split(".")[0]);var u,m,p,f=e.field.id,_=!!Lyte.Router.getRouteInstance()&&"canvas"===Lyte.Router.getRouteInstance().routeName;if(n&&!a?(u="create",m=v(void 0,f),i=Lyte.registeredMixins["crm-create-mixin"]):(u=i.getViewTypeInfo(o?o.view_type:void 0),m=v(i,f,o)),void 0===m?p=!0:"Owner"===m.api_name||m.visible||(p=!0),s&&(!m||m&&(!m.visible||m[d]&&(m[d].isCscriptHidden||m[d].isHiddenInLayoutRules))))return!1;if(m&&!m.view_type[u]&&m[d]&&!m[d].quickCreateEditField&&s&&m.field_read_only)return!1;if(a&&(!m||m&&!(m.view_type[u]||m[d]&&m[d].quickCreateEditField)))return!0;if(!p){var y=function(e,t,a,i){return validationUtils.isEmpty(t.$.error[e])?"failure"!==i?"text"===a.data_type&&"string"==typeof t[e]?t[e].trim():t[e]:"text"===a.data_type&&"string"==typeof t[e]?""===t[e].trim()?void 0:t[e].trim():"picklist"===a.data_type&&"-None-"===t[e]?void 0:t[e]:t.$.error[e].value}(c,l,m,r);if(null!==(y=void 0===y&&"edit"!==u&&m.default_value?m.default_value:y)&&"object"==typeof y&&0===Object.keys(y).length&&(y=null),"function"==typeof i.getData&&i&&void 0!==i.getData("mxnFldValue")&&444===m.ui_type&&(y=i.getData("mxnFldValue")),"function"==typeof i.getData&&i&&445===m.ui_type){let e=$("#Crm_"+i.getData("modulenameUicomp")+"_"+m.column_name)[0],t=$("#"+i.getData("modulenameUicomp")+"_fldRow_"+m.column_name)[0];if(e?y=I18n.getMsg("crm.label.rejection.send.alert.users")===e.innerText?"":e.innerText:t&&(y=t.getElementsByClassName("customfieldValue")[0].innerHTML),_){let e=m.api_name,t=store.peekRecord(i.getData("moduleData").id,i.getData("entityId"))[e];y=t?t.users[0][e].name:""}}Crm.canvas&&Crm.canvas.stageStrip&&"Stage"===c&&(Crm.canvas.isVR_Subcondition=a,y=store.peekAll("stage").filter((function(e){return e.id===Crm.canvas.selectedStageId}))[0].display_label);var g=e.value;if("STAGE"===m.column_name){for(var h=m.pick_list_values,D=[],b=h.length,L=0;L<b;L++)("${OPEN}"!==g||"Open"!==h[L].forecast_type&&"Open"!==h[L].deal_category)&&("${CLOSEDWON}"!==g||"Closed Won"!==h[L].forecast_type&&"Closed Won"!==h[L].deal_category)&&("${CLOSEDLOST}"!==g||"Closed Lost"!==h[L].forecast_type&&"Closed Lost"!==h[L].deal_category)||D.push(h[L].display_value);D.length>0&&(g=D)}var C,I,E=i.checkComparator(y,g,e.comparator,l,c,r,f,a,i);return a?(i.getData("moduleSections")&&i.getData("moduleSections").filter((function(e){(e&&e[d]&&"used"===e[d].type||e.screen)&&e.fields&&e.fields.some((function(t){t.api_name==c&&t.id==f&&(C=t,I=e)}))})),C&&(I&&!1===I[d].isvalidSection||!C.view_type[u]&&!m[d].quickCreateEditField||!C.visible)?void 0:E):E}}},generateFiscalPeriods:function(e){var t={},a=$L.moment(e.startDate,"YYYY-MM-DD"),i=[];if(5===e.structure.length)i=[13,13,13,13];else{var r=e.structure.split("-");for(var o of r)i.push(4*o)}var n,s,l=e.surplusWeek;l&&(n=l.year,s=l.quarter);var d=a.getDObj().getFullYear(),c=!1;if(null!==a)for(var u=a,m=0;m<3;){var p=u.i18N("YYYY-MM-DD"),f=n===d?7:0,_=u.add(363+f,"date").i18N("YYYY-MM-DD");t[d.toString()]={start_date:p,end_date:_};for(var y=$L.moment(p,"YYYY-MM-DD"),g=0;g<4;g++){var v=n===d&&g+1===s?7:0,h=y.i18N("YYYY-MM-DD"),D=y.add(7*i[g]+v-1,"date").i18N("YYYY-MM-DD");t[d.toString()+"-"+(g+1)]={start_date:h,end_date:D},y=$L.moment(D,"YYYY-MM-DD").add(1,"date")}m+=1,d+=1,u=$L.moment(_,"YYYY-MM-DD").add(1,"date"),3!==m||c||(u=$L.moment(e.startDate,"YYYY-MM-DD").subtract(364*m,"date"),m=0,c=!0,d-=6)}return t},getFiscalCriteriaPeriods:function(e){var t,a,i=this.generateFiscalPeriods(e),r={},o=objectUtils.getKeys(i);for(var n of o){var s=$L.moment(i[n].start_date,"YYYY-MM-DD"),l=$L.moment(i[n].end_date,"YYYY-MM-DD");l=l.add(1,"date");var d,c=$L.moment().fromNow(s).past,u=$L.moment(l).fromNow($L.moment()).past;if(c&&u)n.includes("-")?(d="${THISFQ}",a=n):(d="${THISFY}",t=n),r[d]={start_date:i[n].start_date,end_date:i[n].end_date}}var m=parseInt(t)-1,p=parseInt(t)+1;r["${PREVFY}"]={start_date:i[m.toString()].start_date,end_date:i[m.toString()].end_date},r["${NEXTFY}"]={start_date:i[p.toString()].start_date,end_date:i[p.toString()].end_date};var f=a.split("-"),_=parseInt(f[1])-1,y=parseInt(f[0]),g=parseInt(f[1])+1,v=parseInt(f[0]);0===_&&(_=4,y-=1);var h=i[y.toString()+"-"+_];r["${PREVFQ}"]={start_date:h.start_date,end_date:h.end_date},5===g&&(g=1,v+=1);var D=i[v.toString()+"-"+g];return r["${NEXTFQ}"]={start_date:D.start_date,end_date:D.end_date},r},checkComparator:function(e,t,a,i,r,o,n,s,l,d){var c=i.$.model.fieldList[r];if(!c&&!d)return!0;e=e&&"string"==typeof e?e.trim():e;var u=Crm.userDetails.FISCAL_DETAILS.fiscalMonth-1,m=$L.moment().toDate().getMonth()-u;$L.moment().toDate().getMonth()<u&&(m=12-u+$L.moment().toDate().getMonth());var p=!1;if(fiscalCustomPeriodsEnabled){var f=Crm.userDetails.FISCAL_DETAILS;if(p="custom"===f.calendarType)var _=this.getFiscalCriteriaPeriods(f)}var y,g=parseInt(m/3);if("date"==c.type&&e){Lyte.Component.registeredHelpers.isNotEmpty(i.$.error[r])&&(e=i.$.error[r].errorValue);var v=-1!=["dd.mm.yyyy.","yyyy. mm. dd","yyyy.mm.dd","yyyy'年'mm'月'dd'日'"].indexOf(Crm.userDetails.DATE_PATTERN.toLowerCase());if("${TODAY}"==t){a="equal";var h=Utils.convertUsrtoDefaultDatePattern($L.moment().toDate(),v);t=Utils.getDateInGivenPattern(h,"yyyy-mm-dd")}else if("${TOMORROW}"==t){a="equal",(D=new Date).setDate(D.getDate()+1);h=Utils.convertUsrtoDefaultDatePattern(D,v);t=Utils.getDateInGivenPattern(h,"yyyy-mm-dd")}else if("${TOMORROWPLUS}"==t){a="greater_equal",(D=new Date).setDate(D.getDate()+1);h=Utils.convertUsrtoDefaultDatePattern(D,v);t=Utils.getDateInGivenPattern(h,"yyyy-mm-dd")}else if("${YESTERDAY}"==t){a="equal",(D=new Date).setDate(D.getDate()-1);h=Utils.convertUsrtoDefaultDatePattern(D,v);t=Utils.getDateInGivenPattern(h,"yyyy-mm-dd")}else if("${YESTERDAYMINUS}"==t){a="less_equal",(D=new Date).setDate(D.getDate()-1);h=Utils.convertUsrtoDefaultDatePattern(D,v);t=Utils.getDateInGivenPattern(h,"yyyy-mm-dd")}else if("${LASTMONTH}"==t){a="between";var D=new Date,b=new Date(D.getFullYear(),D.getMonth()-1,1),L=new Date(D.getFullYear(),D.getMonth(),0);t=[];var C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");var I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${THISMONTH}"==t){a="between";D=new Date,b=new Date(D.getFullYear(),D.getMonth(),1),L=new Date(D.getFullYear(),D.getMonth()+1,0);t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${NEXTMONTH}"==t){a="between";D=new Date,b=new Date(D.getFullYear(),D.getMonth()+1,1),L=new Date(D.getFullYear(),D.getMonth()+2,0);t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${LASTWEEK}"==t){a="between";var E=(x=(U=new Date).getDate()-7-U.getDay())+6,R=new Date(U.setDate(x)),S=new Date(U.setDate(E));t=[];C=Utils.convertUsrtoDefaultDatePattern(R,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(S,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${THISWEEK}"==t){a="between";E=(x=(U=new Date).getDate()-U.getDay())+6,R=new Date(U.setDate(x)),S=new Date(U.setDate(E));t=[];C=Utils.convertUsrtoDefaultDatePattern(R,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(S,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${NEXTWEEK}"==t){a="between";E=(x=(U=new Date).getDate()+7-U.getDay())+6,R=new Date(U.setDate(x)),S=new Date(U.setDate(E));t=[];C=Utils.convertUsrtoDefaultDatePattern(R,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(S,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${THISYEAR}"==t){a="between";D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),0,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),12,0),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${LASTYEAR}"==t){a="between";D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear()-1,0,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear()-1,12,0),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${NEXTYEAR}"==t){a="between";D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear()+1,0,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear()+1,12,0),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${THISFY}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,0),u<=D.getMonth()?L.setFullYear(L.getFullYear()+1):b.setFullYear(b.getFullYear()-1)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${NEXTFY}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1),u<=D.getMonth()&&(b=$L.moment("").toDate()).setFullYear(D.getFullYear()+1,u,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,0),u<=D.getMonth()?L.setFullYear(L.getFullYear()+2):L.setFullYear(L.getFullYear()+1)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${PREVFY}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,0),u<=D.getMonth()?b.setFullYear(b.getFullYear()-1):b.setFullYear(b.getFullYear()-2),u>D.getMonth()&&L.setFullYear(L.getFullYear()-1)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${THISFQ}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1);L=D;D.getMonth()<u&&(b.setFullYear(b.getFullYear()-1),L.setFullYear(L.getFullYear()-1));var F=b.getMonth()+3*g;b.setMonth(F),L.setFullYear(L.getFullYear(),F+3,0)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${PREVFQ}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1);L=D;D.getMonth()<u&&(b.setFullYear(b.getFullYear()-1),L.setFullYear(L.getFullYear()-1));F=b.getMonth()+3*(g-1);b.setMonth(F),L.setFullYear(L.getFullYear(),F+3,0)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("${NEXTFQ}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1);L=D;D.getMonth()<u&&(b.setFullYear(b.getFullYear()-1),L.setFullYear(L.getFullYear()-1));F=b.getMonth()+3*(g+1);b.setMonth(F),L.setFullYear(L.getFullYear(),F+3,0)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Utils.getDateInGivenPattern(C,"yyyy-mm-dd");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Utils.getDateInGivenPattern(I,"yyyy-mm-dd")}else if("string"==typeof t&&(t.match("AGEINDAYS")||t.match("DUEINDAYS"))){t.match("AGEINDAYS")&&(B=!0);try{V=t.substring(t.indexOf("+")+1)}catch(e){murphy.error(e)}B&&(V="-"+V);h=Utils.convertUsrtoDefaultDatePattern(new Date,v);h=Utils.getDateInGivenPattern(h,"yyyy-mm-dd"),V=parseInt(V),(D=new Date).setDate(D.getDate()+V);var O=Utils.convertUsrtoDefaultDatePattern(D,v);switch(t=O=Utils.getDateInGivenPattern(O,"yyyy-mm-dd"),a){case"greater_than":case"greater_equal":B&&(a="greater_equal"==a?"less_equal":"less_than");break;case"less_than":case"less_equal":B?(a="between",(t=[])[0]=O,t[1]=h):(a="between",(t=[])[0]=h,t[1]=O)}}var k=Crm.userDetails.DATE_PATTERN.toUpperCase(),w=Utils.isValidDate(k,e);if(!w)try{e=$L.moment(e,k,{i18n:!0}).format(k),w=Utils.isValidDate(k,e)}catch(e){murphy.error(e)}if(!w)return!1;h=Utils.convertUsrtoDefaultDatePattern(e,v);e=Utils.getDateInGivenPattern(h,"yyyy-mm-dd")}else if("datetime"==c.type&&e){var N,T;if(Lyte.Component.registeredHelpers.isNotEmpty(i.$.error[r])&&(e=i.$.error[r].errorValue),e.indexOf("TV")>=0)N=(T=e.split("TV"))[0];else{k=Crm.userDetails.DATE_PATTERN.toUpperCase();var M=Crm.userDetails.TIME_FORMAT,P=k+" "+M.replace(":MM",":mm");if(T=[],!(N=$L.moment(e,P).format(k)))try{N=$L.moment(e,P,{i18n:!0}).format(k)}catch(e){murphy.error(e)}T[0]=N;var $=Crm.userDetails.TIME_FORMAT.split(" ").length>1?M.replace("a","A"):Crm.userDetails.TIME_FORMAT;if(T[1]=$L.moment(e,P).format($),!T[1])try{T[1]=$L.moment(e,P,{i18n:!0}).format($)}catch(e){murphy.error(e)}T[1]=T[1]?T[1].toUpperCase():T[1]}var A=Utils.isValidDate(Crm.userDetails.DATE_PATTERN.toUpperCase(),N);v=-1!=["dd.mm.yyyy.","yyyy. mm. dd","yyyy.mm.dd","yyyy'年'mm'月'dd'日'"].indexOf(Crm.userDetails.DATE_PATTERN.toLowerCase());if("${TODAY}"==t){a="between";D=new Date,b=new Date(D.setHours(0,0,0,0)),L=new Date(D.setHours(23,59,59,999));t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${TOMORROW}"==t){a="between";D=new Date((new Date).setDate((new Date).getDate()+1)),b=new Date(D.setHours(0,0,0,0)),L=new Date(D.setHours(23,59,59,999));t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${TOMORROWPLUS}"==t){a="greater_equal",(D=new Date).setDate(D.getDate()+1),D.setHours(0,0,0,0);h=Utils.convertUsrtoDefaultDatePattern(D,v);t=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(h)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${YESTERDAY}"==t){a="between";D=new Date((new Date).setDate((new Date).getDate()-1)),b=new Date(D.setHours(0,0,0,0)),L=new Date(D.setHours(23,59,59,999));t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${YESTERDAYMINUS}"==t){a="less_equal",(D=new Date).setDate(D.getDate()-1);h=Utils.convertUsrtoDefaultDatePattern(D,v);t=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(h)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${LASTMONTH}"==t){a="between";D=new Date,b=new Date(D.getFullYear(),D.getMonth()-1,1);(L=new Date(D.getFullYear(),D.getMonth(),0)).setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${THISMONTH}"==t){a="between";D=new Date,b=new Date(D.getFullYear(),D.getMonth(),1);(L=new Date(D.getFullYear(),D.getMonth()+1,0)).setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${NEXTMONTH}"==t){a="between";D=new Date,b=new Date(D.getFullYear(),D.getMonth()+1,1);(L=new Date(D.getFullYear(),D.getMonth()+2,0)).setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${LASTWEEK}"==t){a="between";E=(x=(U=new Date).getDate()-7-U.getDay())+6,R=new Date(U.setDate(x)),S=new Date(U.setDate(E));R.setHours(0,0,0,0),S.setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(R,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(S,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${THISWEEK}"==t){a="between";E=(x=(U=new Date).getDate()-U.getDay())+6,R=new Date(U.setDate(x)),S=new Date(U.setDate(E));R.setHours(0,0,0,0),S.setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(R,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(S,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${NEXTWEEK}"==t){a="between";var U,x;E=(x=(U=new Date).getDate()+7-U.getDay())+6,R=new Date(U.setDate(x)),S=new Date(U.setDate(E));R.setHours(0,0,0,0),S.setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(R,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(S,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${THISYEAR}"==t){a="between";D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),0,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),12,0),b.setHours(0,0,0,0),L.setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${LASTYEAR}"==t){a="between";D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear()-1,0,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear()-1,12,0),b.setHours(0,0,0,0),L.setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${NEXTYEAR}"==t){a="between";D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear()+1,0,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear()+1,12,0),b.setHours(0,0,0,0),L.setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${THISFY}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").endOf("day").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,0),u<=D.getMonth()?L.setFullYear(L.getFullYear()+1):b.setFullYear(b.getFullYear()-1),b.setHours(0,0,0,0),L.setHours(23,59,59,999)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${NEXTFY}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").endOf("day").toDate();else{D=$L.moment("").toDate();if((b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1),u<=D.getMonth())(b=$L.moment("").toDate()).setFullYear(D.getFullYear()+1,u,1);(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,0),u<=D.getMonth()?L.setFullYear(L.getFullYear()+2):L.setFullYear(L.getFullYear()+1),b.setHours(0,0,0,0),L.setHours(23,59,59,999)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${PREVFY}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").endOf("day").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1),(L=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,0),u<=D.getMonth()?b.setFullYear(b.getFullYear()-1):b.setFullYear(b.getFullYear()-2),u>D.getMonth()&&L.setFullYear(L.getFullYear()-1),b.setHours(0,0,0,0),L.setHours(23,59,59,999)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${THISFQ}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").endOf("day").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1);L=D;D.getMonth()<u&&(b.setFullYear(b.getFullYear()-1),L.setFullYear(L.getFullYear()-1));F=b.getMonth()+3*g;b.setMonth(F),L.setFullYear(L.getFullYear(),F+3,0),b.setHours(0,0,0,0),L.setHours(23,59,59,999)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${PREVFQ}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").endOf("day").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1);L=D;D.getMonth()<u&&(b.setFullYear(b.getFullYear()-1),L.setFullYear(L.getFullYear()-1));F=b.getMonth()+3*(g-1);b.setMonth(F),L.setFullYear(L.getFullYear(),F+3,0)}b.setHours(0,0,0,0),L.setHours(23,59,59,999),t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("${NEXTFQ}"==t){if(a="between",p)b=$L.moment(_[t].start_date,"YYYY-MM-DD").toDate(),L=$L.moment(_[t].end_date,"YYYY-MM-DD").endOf("day").toDate();else{D=$L.moment("").toDate();(b=$L.moment("").toDate()).setFullYear(D.getFullYear(),u,1);L=D;D.getMonth()<u&&(b.setFullYear(b.getFullYear()-1),L.setFullYear(L.getFullYear()-1));F=b.getMonth()+3*(g+1);b.setMonth(F),L.setFullYear(L.getFullYear(),F+3,0),b.setHours(0,0,0,0),L.setHours(23,59,59,999)}t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("string"==typeof t&&(t.match("AGEINDAYS")||t.match("DUEINDAYS"))){var V,B=!1;try{V=t.substring(t.indexOf("+")+1)}catch(e){murphy.error(e)}t.match("AGEINDAYS")&&(B=!0,V="-"+V),V=parseInt(V);D=new Date((new Date).setDate((new Date).getDate()+V)),b=new Date(D.setHours(0,0,0,0)),L=new Date(D.setHours(23,59,59,999));t=[];C=Utils.convertUsrtoDefaultDatePattern(b,v);t[0]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(C)+Crm.userDetails.TIME_ZONE.replace(".",":");I=Utils.convertUsrtoDefaultDatePattern(L,v);t[1]=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(I)+Crm.userDetails.TIME_ZONE.replace(".",":");var j=$L.moment($L.moment().toDate().setHours(0,0,0,0)).toDate(),Y=$L.moment($L.moment().toDate().setHours(23,59,59,999)).toDate();j=Utils.convertUsrtoDefaultDatePattern(j,v);j=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(j)+Crm.userDetails.TIME_ZONE.replace(".",":");Y=Utils.convertUsrtoDefaultDatePattern(Y,v);switch(Y=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(Y)+Crm.userDetails.TIME_ZONE.replace(".",":"),a){case"equal":a="between";break;case"not_equal":a="not_between";break;case"greater_than":case"greater_equal":B?(t=t[0],a="greater_equal"==a?"less_equal":"less_than"):t=t[1];break;case"less_than":case"less_equal":B?(a="between",t[1]=Y):(a="between",t[0]=j)}}if(!A)return!1;var q=Utils.convertUsrtoDefaultDatePattern(N,v);if(T[1]){var z=Lyte.registeredMixins["crm-date-datetime-mixin"].getfinalTimeObjectfromTime(T[1]);validationUtils.isNotEmpty(z)&&(q.setHours(z.hrs),q.setMinutes(z.mins))}e=Lyte.registeredMixins["crm-date-datetime-mixin"].getDateTimeWithTimezone(q)+Crm.userDetails.TIME_ZONE.replace(".",":")}else if("number"==c.type){if(null==e?(Lyte.Component.registeredHelpers.isNotEmpty(i.$.error[r])?e=isNaN(parseFloat(i.$.error[r].value))?"${EMPTY}"!=t&&"${NOTEMPTY}"!=t?0:void 0:parseFloat(i.$.error[r].value):o&&"failure"!==o&&(e="${EMPTY}"!==t&&"${NOTEMPTY}"!==t?0:e),o&&0===e&&(e=void 0)):Lyte.Component.registeredHelpers.isNotEmpty(i.$.error[r])&&(e=isNaN(parseFloat(i.$.error[r].value))?"${EMPTY}"!=t&&"${NOTEMPTY}"!=t?0:void 0:parseFloat(i.$.error[r].value)),"currency"===c.fieldType&&(t||0===t)){var W=Crm.userDetails.CURRENCY_DETAILS;i.Currency&&W&&W[i.Currency]&&("number"==typeof t?t=W[i.Currency].er*t:!Array.isArray(t)||"between"!==a&&"not_between"!==a||((t=objectUtils.cloneObject_new(t))[0]=parseFloat(W[i.Currency].er*t[0]),t[1]=parseFloat(W[i.Currency].er*t[1])))}}else if("lookup"===c.fieldType)validationUtils.isNotEmpty(e)&&(e=e.name);else if("userlookup"===c.fieldType||"ownerlookup"===c.fieldType){if("ownerlookup"===c.fieldType&&"${EMPTY}"===t&&!validationUtils.isNotEmpty(e)&&l&&l.getData("isWizard"))return!1;if("userlookup"===c.fieldType&&"${EMPTY}"===t)return!validationUtils.isNotEmpty(e);if("${NOTEMPTY}"===t&&"not_equal"===a||"not_equal"===a&&"${EMPTY}"===t&&validationUtils.isNotEmpty(e))return!0;if(5678!==e){if(validationUtils.isNotEmpty(e)&&(e=e.id),"-1"===t||"${CURRENTUSER}"===t)t=Crm.userDetails.USER_ID;else if(Array.isArray(t))for(var H=t.length,K=0;K<H;K++)"-1"!==t[K]&&"${CURRENTUSER}"!==t[K]||(t[K]=Crm.userDetails.USER_ID);t=t.id?t.id:Array.isArray(t)||"string"==typeof t?t:Crm.userDetails.USER_ID}}else if("bigint"===c.fieldType){if("object"===c.type){if(validationUtils.isNotEmpty(e)&&(e=e.id),t.id)t=t.id;else{var Q=[];t.forEach((function(e){Q.push(e.id)})),t=Q}a="equal"==a?"contains":"not_equal"==a?"not_contains":a}else if("string"===c.type)try{e=e&&"string"==typeof e&&e.trim()&&!isNaN(e)?parseFloat(e):e;let a,i=t;i&&(Array.isArray(i)&&i.length?(a=i.map((e=>e&&"string"==typeof e&&e.trim()&&!isNaN(e)?parseFloat(e):e)),t=a):"string"!=typeof i||["${NOTEMPTY}","${EMPTY}"].includes(i)||(a=i&&"string"==typeof i&&i.trim()&&!isNaN(i)?parseFloat(i):i,t=a))}catch(e){murphy.error(e)}}else if("multi-user"===c.type&&e)return 0===Object.values(e).length&&"${EMPTY}"===t||"${NOTEMPTY}"===t&&0!==Object.values(e).length;if(o&&void 0===(y=l.chkFieldemptyVR(e,o,s))&&s&&"number"===c.type&&void 0===e&&["not_equal","less_equal","less_than"].contains(a))return!1;switch(t&&"string"==typeof t&&t.indexOf("${NOC")>=0&&(t=t.replace("${NOC","").replace("}",""),e=o?e?e.length||0:void 0!==e?void 0:e:e?e.length:0),a){case"between":case"not_between":if(1==y||0==y)return y;if(t&&2==t.length){if("string"==typeof t[0]&&"string"==typeof t[1]&&t[0].indexOf("${NOC")>=0&&t[1].indexOf("${NOC")>=0){var G=t[0].replace("${NOC","").replace("}",""),J=t[1].replace("${NOC","").replace("}",""),Z=(e=e?e.length:0)>=G.trim()&&e<=J.trim();return"between"==a?Z:!Z}Z=e>=("string"==typeof t[0]?t[0].trim():t[0])&&e<=("string"==typeof t[1]?t[1].trim():t[1]);return"between"==a?Z:!Z}break;case"less_equal":return 1==y||0==y?y:"datetime"==c.type||"date"==c.type?new Date(e)<=new Date(t):Number(e)<=Number(t);case"less_than":return 1==y||0==y?y:"datetime"==c.type||"date"==c.type?new Date(e)<new Date(t):Number(e)<Number(t);case"greater_equal":return 1==y||0==y?y:"datetime"==c.type||"date"==c.type?new Date(e)>=new Date(t):Number(e)>=Number(t);case"greater_than":return 1==y||0==y?y:"datetime"==c.type||"date"==c.type?new Date(e)>new Date(t):Number(e)>Number(t);case"equal":case"not_equal":return l.equalCheckBasedOnType(e,t,typeof t,a,i,r,o,n,s,l);case"starts_with":case"ends_with":return 1==y||0==y?y:t&&"string"==typeof t?(t=t?t.toLowerCase():t,!(!e||"string"!=typeof e)&&(e=e.toLowerCase(),"starts_with"===a?e.startsWith(t):e.endsWith(t))):!!Array.isArray(t)&&(re=t.some((function(t){return t=t&&"string"==typeof t?t.toLowerCase():t,!(!e||"string"!=typeof e)&&(e=e.toLowerCase(),"starts_with"===a?e.startsWith(t):e.endsWith(t))})));case"contains":case"not_contains":if(1==y||0==y)return y;if(""==e&&"failure"==o)return!0;if(null==o&&"not_contains"==a&&!e)return!0;if(e){if("string"==typeof t){t=t?t.toLowerCase():t;var X=-1!=(e=e?e.toLowerCase():e).indexOf(t);return"contains"==a?X:!X}if(Array.isArray(t)&&t.length){if("not_contains"===a){for(var ee,te=t.length,ae=0;ae<te;ae++){var ie=t[ae];if(ie=ie&&"string"==typeof ie?ie.toLowerCase():ie,"string"==typeof e)(X=-1!==(e=e.toLowerCase()).indexOf(ie))&&(ee=!0)}return!ee}var re=t.some((function(t){if(t=t&&"string"==typeof t?t.toLowerCase():t,"string"==typeof e){var i=-1!==(e=e.toLowerCase()).indexOf(t);return"contains"==a?i:!i}return!1}));return re}if("object"==typeof t&&t.length){var oe=t.contains(e);return"contains"==a?oe:!oe}}return!1}},chkFieldemptyVR:function(e,t,a){if(null==e&&t&&!a)return"failure"===t},equalCheckBasedOnType:function(e,t,a,i,r,o,n,s,l,d){var c;if("${NOTEMPTY}"==t?(i="not_equal",t="",e=f(e="-None-"==e||null==e?"":e)):"${EMPTY}"==t&&(t="",e=f(e="-None-"==e||null==e?"":e)),t&&"string"==typeof t&&t.indexOf("${NOC")>=0&&(t=t.replace("${NOC","").replace("}",""),e=e?e.length:0),n){c=d.chkFieldemptyVR(e,n,l);var u=store.peekRecord("field",s);if(u&&"picklist"===u.data_type&&"-None-"===e&&"not_equal"===i)return!1}if(1==c||0==c)return c;switch(a){case"string":var m=(e&&isNaN(e)?e.toString().toLowerCase():e)==(t&&isNaN(e)?t.toLowerCase():t);return"equal"==i?m:!m;case"boolean":case"number":m=e==t;return"equal"==i?m:!m;case"array":case"object":var p=!1;return t.forEach((function(t){(t=t&&"string"==typeof t?t.toLowerCase():t,(e=e&&"string"==typeof e?e.toLowerCase():e)&&"string"==typeof e)&&(t==e&&!p&&(p=!0))})),"equal"==i?p:!p}function f(e){return"0"==e&&(e="notEmpty"),e}},setinitialPicklistdata:function(e,t,a,i,r,o){var n=[];n[0]={};var s=r.length;if(a)if(a=a||("multiselectpicklist"==e.data_type?"[]":"-None-"),"multiselectpicklist"==e.data_type){if(a="string"==typeof a?JSON.parse(a):a,(n=r.filter((function(e){return a.contains(e.display_value)}))).length&&n.length!=a.length){var l=JSON.parse(JSON.stringify(n[0])),d=["display_value","actual_value","maps","type"];for(var c in l)d.contains(c)||delete l[c];for(var u=l.maps.length,m=0;m<u;m++)l.maps[m].pick_list_values=[];a.forEach((function(e){if(!n.filter((function(t){return t.display_value==e})).length){var t=Lyte.deepCopyObject(l);t.display_value=t.actual_value=e,n.push(t)}}))}else if(e.default_value&&"clone"===this.getData("initRoute")&&a&&!a.length){for(var p=0;p<s;p++)if(r[p].display_value==e.default_value){n[0]=r[p];break}}else if(0===n.length&&n.length!=a.length){l=JSON.parse(JSON.stringify(r[0])),d=["display_value","actual_value","maps","type"];for(var c in l)d.contains(c)||delete l[c];for(u=l.maps.length,m=0;m<u;m++)l.maps[m].pick_list_values=[];a.forEach((function(e){if(!n.filter((function(t){return t.display_value==e})).length){var t=l;t.display_value=t.actual_value=e,n.push(t)}}))}}else n=r.filter((function(e){return a==e.display_value}));else if(e.default_value||"Currency"==e.api_name)for(p=0;p<s;p++){if("edit"===this.getData("initRoute")&&"-None-"===r[p].display_value&&!o){n[0]=r[p];break}if(r[p].display_value==e.default_value){n[0]=r[p];break}if("Currency"==e.api_name&&t&&r[p].display_value==t.key){n[0]=r[p];break}}else{var f=this.getData("dataBind");n[0]=f&&f.$approval_state&&("approval_process_pending"===f.$approval_state||"approval_process_rejected"===f.$approval_state)&&e.read_only?"":r[0]}return n},setdropdownProperties:function(e,t,a,i,r,o,n,s){var l,d,c,u=this.data.currentInstObjKey,m=this,p=this.data.moduleData[u].renderedLayoutId;if("SALUTATION"==r){c=(d=$L(".cruxCompClass_SALUTATION lyte-dropdown")).parents("crm-create-fields")[0],d=d[0]}else l=t+" lyte-dropdown",d=document.querySelector(l),c=document.querySelector(t);var f,_=this.getData("initialCreatebject"),y=this.getData("dataBind");if((("subform"===s||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===s)&&(y=this.getData("databindSubform")),"Stage"===n&&"FORECAST_CATEGORY"===r)&&((K=this.getData("moduleData"))&&K.fields)){var g=K.fields.filter((function(e){return"Stage"===e.api_name}))[0];if(g&&"STAGE"===g.column_name){var v=g[p];if(v&&v.pick_list_values&&y[n]){var h=v.pick_list_values.filter((function(e){return e.display_value===y[n]}))[0];h&&h.forecast_category&&(f=h.forecast_category)}}}var D=this.getData("initRoute");if(!_||!Object.keys(_).length){var b="crm-create-layout#"+store.peekRecord("module","subform"===s?this.data.moduleData.id:y.$.model._name).module_name+"LC_layoutNode",L=$L(b)[0];_=L?L.getData("initialCreatebject"):void 0}if(c&&d&&c.component.data.moduledataUicomp&&!c.component.data.moduledataUicomp.read_only){var C=(T=c.component.data).moduledataUicomp.data_type;if(!e){var I=c.component.getData("orginalPicklistdata");if("multiselectpicklist"!==C&&_[i])!I.filter((function(e){return e.display_value==_[i]}))[0]&&I.push(m.createDummyPLobject(I[0],_[i]));e=I}var E=T.moduledataUicomp[p];if(e=m.getOriginalPicklistValues(e,E&&E.pick_list_values?E.pick_list_values:T.moduledataUicomp.pick_list_values,i,n),E&&E.default_value)(Y=e.filter((function(e,t){if(e.display_value===E.default_value)return j=t,!0}))[0])&&j&&(Lyte.arrayUtils(e,"removeAt",j,1),Lyte.arrayUtils(e,"insertAt",0,Y));if("multiselectpicklist"===C&&_[i]&&"create"!==D&&y[n]==_[n])(q={plOptions:e,exitRecordVal:_[i]}).orgPLValues=E&&E.pick_list_values?E.pick_list_values:T.moduledataUicomp.pick_list_values,e=ae(q);Lyte.Component.set(c.component.data.moduledataUicomp[u],"dpick_list_values",e);var R=[],S=!1;if("multiselectpicklist"===C)e.forEach((function(e){y[i]&&JSON.parse(y[i]).contains(e.display_value)&&(R.push(e),S=!0)})),R.length||(R[0]=e[0]);else{(P=e.filter((function(e){return e.display_value==_[i]}))[0])&&"-None-"===P.display_value&&E&&E.default_value&&(P=void 0);var F="create"!==D&&_[i]&&P||e[0];R[0]=e[0];for(var O=e.length,k=0;k<O;k++)if(e[k].display_value===d.component.getData("ltPropDisplayValue")){R[0]=e[k];break}}if(J="multiselectpicklist"==C?T.moduleData[u].additionalFielddata.multiselectpicklist.filter((function(e){return e.fieldId===T.moduledataUicomp.id}))[0]:T.moduleData[u].additionalFielddata.picklist.filter((function(e){return e.fieldId===T.moduledataUicomp.id}))[0],this.getData("isscreenSwitch")&&J&&J.renderedCount>1){var w=e.filter((function(e){return e.display_value==y[i]}));R[0]=w&&w[0]?w[0]:R[0]}if(f&&f.id)(W=e.filter((function(e){return e.id===f.id}))[0])&&R&&R[0]&&(R[0]=W);if(d.component.setData("ltPropOptions",R),"multiselectpicklist"!=c.component.data.moduledataUicomp.data_type){(!this.getData("isscreenSwitch")||J&&1==J.renderedCount)&&(d.component.setData("ltPropSelected",R[0].display_value),d.component.setData("ltPropDisplayValue",R[0].display_value)),"-None-"==R[0].display_value?(d&&d.classList.add("noneSelected"),Lyte.Component.set(y,i,T.moduledataUicomp.required?"":R[0].display_value)):(d&&d.classList.remove("noneSelected"),Lyte.Component.set(y,i,R[0].display_value));const e=this.data&&this.data.activeScreen&&this.data.activeScreen.isEntryScreen;"initialRender"!==s||e||this.executeCscriptWrapper(y,i),!0===T.moduledataUicomp.enable_colour_code&&(R[0]&&"-None-"!==R[0].display_value?(c.component.setData("moduledataUicomp.color_code",R[0].colour_code),c.component.setData("moduledataUicomp.pkcolor_enabled_class","colorEnabledPicklist")):c.component.setData("moduledataUicomp.pkcolor_enabled_class","colorEnabledPicklist colorEnabledPKNone"))}else if(0==a){if(U=(A=c.component.data).dataBind[A.apiName])if("string"==typeof U)(V=JSON.parse(U)).length?e.filter((function(e){return e.display_value==V[0]}))[0]?x=1:(x=0,Lyte.Component.set(y,i,"[]")):x=0;else x=U.length;else x=0;x?d.ltProp("placeholder",""):d.ltProp("placeholder",I18n.getMsg("crm.label.picklist.none"))}else if(1==a)if(S){var N=ee(R);Lyte.Component.set(y,i,N)}else Lyte.Component.set(y,i,"[]");"SALUTATION"==r&&c.querySelector("lyte-input").focus(),te(R[0],T.moduledataUicomp)}else if(c&&d&&c.component.data.subformFields&&!c.component.data.subformFields.read_only){var T=c.component.data;y=T.databindSubform;C=T.subformFields.data_type;if(_&&_[T.parentSubformdata.subform_apiname]&&(_=_[T.parentSubformdata.subform_apiname].filter((function(e){return e.id===y.id}))[0]),_=_||{},!e){I=c.component.data.subformFields.pick_list_values;if("multiselectpicklist"!==C&&_[i])I.filter((function(e){return e.display_value===_[i]}))[0]||I.push(m.createDummyPLobject(I[0],_[i]));else x=0;e=I}E=T.subformFields[p];e=m.getOriginalPicklistValues(e,E&&E.pick_list_values?E.pick_list_values:T.subformFields.pick_list_values,i,n),c.component.data.dpick_list_values=e,c.component.data.oldPickListValue=void 0;var M,P=e.filter((function(e){return e.display_value===_[i]}))[0],$=!1;F=e[0],R=[];if("picklist"===C?(e.forEach((function(e){y[i]===e.display_value&&(F=e)})),R[0]=F):(e.forEach((function(e){y[i]&&JSON.parse(y[i]).contains(e.display_value)&&R.push(e)})),R.length>0&&($=!0)),T.subformFields.enable_colour_code&&R[0]&&(c.component.setData("pkColorCode",R[0].colour_code),"-None-"===R[0].display_value?c.component.setData("pkColorEnabledClass","colorEnabledPicklist colorEnabledPKNone"):c.component.setData("pkColorEnabledClass","colorEnabledPicklist")),d.component.setData("ltPropOptions",R),M="multiselectpicklist"==C?T.moduleData[u].addSubFormFielddata.multiselectpicklist.filter((function(e){return e.fieldId===T.subformFields.id}))[0]:T.moduleData[u].addSubFormFielddata.picklist.filter((function(e){return e.fieldId===T.subformFields.id}))[0],"multiselectpicklist"!==c.component.data.subformFields.data_type)(!this.getData("isscreenSwitch")||M&&1===M.renderedCount)&&(d.component.setData("ltPropSelected",R[0].display_value),d.component.setData("ltPropDisplayValue",R[0].display_value)),"-None-"===R[0].display_value?(d&&d.classList.add("noneSelected"),T.subformFields.required?Lyte.Component.set(y,i,""):Lyte.Component.set(y,i,R[0].display_value)):(d&&d.classList.remove("noneSelected"),Lyte.Component.set(y,i,R[0].display_value));else if(!1===a){var A,U,x,V;if(U=(A=c.component.data).databindSubform[A.subformFields.api_name])if("string"==typeof U)(V=JSON.parse(U)).length?e.filter((function(e){return e.display_value===V[0]}))[0]?x=1:(x=0,Lyte.Component.set(y,i,"[]")):x=0;else x=U.length;else x=0;x?d.ltProp("placeholder",""):d.ltProp("placeholder",I18n.getMsg("crm.label.picklist.none"))}else if($){N=ee(R);d.component.setData("ltPropSelected",N),Lyte.Component.set(y,i,N)}else d.component.setData("ltPropSelected","[]"),d.component.setData("ltPropPlaceholder",I18n.getMsg("crm.label.picklist.none")),Lyte.Component.set(y,i,"[]");te(R[0],T.subformFields,!0,T)}else{var B;if((B="subform"===s?this.getData("parentSubformdata").fields.filter((function(e){return e.api_name==i})):this.getData("moduleData").fields.filter((function(e){return e.api_name==i})))&&B[0]&&!B[0].read_only){e||(e=B[0][u].orginalPicklistdata?B[0][u].orginalPicklistdata:this.filterValidPickListValues(o,B[0]));var j,Y,q,z,W,H=B[0][p];if(e=m.getOriginalPicklistValues(e,H&&H.pick_list_values?H.pick_list_values:B[0].pick_list_values,i,n),H&&H.default_value)(Y=e.filter((function(e,t){if(e.display_value===H.default_value)return j=t,!0}))[0])&&j&&(Lyte.arrayUtils(e,"removeAt",j,1),Lyte.arrayUtils(e,"insertAt",0,Y));if("multiselectpicklist"===B[0].data_type&&_[i]&&"create"!==D&&y[n]==_[n])(q={plOptions:e,exitRecordVal:_[i]}).orgPLValues=H&&H.pick_list_values?H.pick_list_values:B[0].pick_list_values,e=ae(q);if(B[0][u].dpick_list_values=e,"SALUTATION"===r){var K,Q=(K=this.data&&this.data.moduleData&&this.data.moduleData.fields||[]).filter((function(e){return"FIRSTNAME"===e.column_name}))[0];Q&&(Q[u].dpick_list_values=e)}if(f&&f.id)(W=e.filter((function(e){return e.id===f.id}))[0])&&(z=W);if("picklist"==B[0].data_type)if("Calls"==this.getData("moduleName"))Lyte.Component.set(y,i,e[0].display_value);else{var G=z&&z.display_value||e[0].display_value;if("create"==D&&this.getData("isscreenSwitch")){var J,Z=this.data.moduleData[u].additionalFielddata;Z&&"multiselectpicklist"==C?J=Z.multiselectpicklist.filter((function(e){return e.fieldId==B[0].id}))[0]:Z&&(J=Z.picklist&&Z.picklist.filter((function(e){return e.fieldId===B[0].id}))[0]),G=J&&J.renderedCount>=1&&y[i]?y[i]:G}F="create"!==D&&_[i]?e.filter((function(e){return e.display_value==_[i]})).length?_[i]:e[0].display_value:G;Lyte.Component.set(y,i,z&&z.display_value||F)}else if(0==a&&B[0].default_value&&!this.getData("isscreenSwitch"))if(e.filter((function(e){return e.display_value==B[0].default_value})).length){var X=[B[0].default_value];Lyte.Component.set(y,i,JSON.stringify(X))}else B[0][u].dontSetDefaultValue=!0,Lyte.Component.set(y,i,"[]");else(1==a||0==a&&!this.getData("isscreenSwitch"))&&Lyte.Component.set(y,i,"[]");te(z||"picklist"===B[0].data_type?e.filter((e=>e.display_value===y[i]))[0]:e[0],B[0])}}function ee(e){var t=[];return e.forEach((function(e){t.push(e.display_value)})),JSON.stringify(t)}function te(e,t,i,r){var n=e&&e.maps?e.maps.length:0;if(t&&"STAGE"===t.column_name){var l=e?e.probability:void 0;void 0!==l&&Lyte.Component.set(y,"Probability","-None-"===y[t.api_name]?void 0:l),m.setExpectedRevenue()}for(var d=0;d<n;d++){var c,u;if(i&&void 0!==r.apiName){var p=r.apiName;if(void 0===y[p])c=(f=y.$.model.fieldList[e.maps[d].api_name])?f.columnName:void 0;else c=y[p].model.fieldList[e.maps[d].api_name].columnName;u="crm-create-subformfields#"+r.moduleName+"_"+p+"_R"+(r.indexVal+1)+"_"+e.maps[d].api_name}else{var f;c=(f=y.$.model.fieldList[e.maps[d].api_name])?f.columnName:void 0,u="crm-create-fields#"+m.getData("moduleData.module_name")+"_fldRow_"+c}if(c)e.maps[d].pick_list_values.length>0?m.setdropdownProperties(e.maps[d].pick_list_values,u,a,e.maps[d].api_name,c,o,t.api_name,s):m.setdropdownProperties(void 0,u,a,e.maps[d].api_name,c,o,t.api_name,s)}}function ae(e){var t=e.exitRecordVal,a=t||[],i=e.orgPLValues;return t&&"string"==typeof t&&(a=JSON.parse(t)),(a=a||[]).forEach((function(t){if(!e.plOptions.filter((function(e){return e.display_value===t}))[0]){var a=i.filter((function(e){return e.display_value==t}))[0];if(!a)for(var r=(a=m.createDummyPLobject(i[0],t)).maps?a.maps.length:0,o=0;o<r;o++)if("PIPELINE"===curntFldObj.column_name&&"Stage"===optn.maps[o].api_name){var n=m.getData("dataBind.Stage");a.maps[o].pick_list_values=[{actual_value:n,display_value:n}]}else a.maps[o].pick_list_values=[];e.plOptions.push(a)}})),e.plOptions}},toggleOptionsDropdown:function(e){var t=e.id.substr(e.id.indexOf("-")+1);$L("lyte-dropdown#"+t)[0].toggle()},getOriginalPicklistValues:function(e,t,a,i){var r=[];return"Pipeline"===i&&"Stage"===a?e.forEach((function(e){var a=t.filter((function(t){return t.display_value===e.display_value}));a[0]&&r.push(a[0])})):t.forEach((function(t){e.filter((function(e){return e.display_value==t.display_value}))[0]&&r.push(t)})),r},createDummyPLobject:function(e,t){var a=Lyte.deepCopyObject(e);a.actual_value=a.display_value=t;var i=["display_value","actual_value","maps","type"];for(var r in a)i.contains(r)||delete a[r];return a},toggleMandatoryInSubformRecord:function(e,t,a,i){i=i||!1;var r=e.getData("dataBind"),o=e.data.currentInstObjKey,n=r[t];a.forEach((function(t){if(Lyte.Component.registeredHelpers.getViewtype(t.view_type,e.getData("initRoute"))&&t.visible&&"subform"!==t.data_type&&"static_subform"!==t.data_type&&!t.subform)void 0!==n&&n.forEach((function(a){for(var r in a.$.model.fieldList)t.api_name==r&&(e.toggleMandatoryInRecord?e.toggleMandatoryInRecord(i,a,r,t,!0):e.component.toggleMandatoryInRecord(i,a,r,t,!0))}));else if("subform"===t.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===t.data_type){(t[o].aggFields||[]).forEach((function(t){e.toggleMandatoryInRecord?e.toggleMandatoryInRecord(i,r,t.api_name,t):e.component.toggleMandatoryInRecord(i,r,t.api_name,t)}))}}))},toggleMandatoryInRecord:function(e,t,a,i,r){if(i.required&&i.visible){var o=t,n=o.$.model.fieldList[a];n.mandatory=e,Lyte.Component.set(i,"dummy__Mandatory",!e),store.addField(o.$.model._name,a,n.type,n,r)}},setDateTimeLbind:function(e,t){var a=this.data,i=a.currentInstObjKey,r=this.$node.querySelector('lyte-input[lt-prop-type="date"]'),o=this.$node.querySelector('lyte-input[lt-prop-type="time"]'),n=r.ltProp("currentDate");if(o){(!n&&o.ltProp("defaultTime")&&e||e&&!Utils.isValidDate(Crm.userDetails.DATE_PATTERN.toUpperCase(),n))&&r.ltProp("currentDate",Utils.getDateInUserDatePattern(new Date));var s=(n=r.ltProp("currentDate"))?n+"TV"+o.ltProp("defaultTime"):void 0;t?Lyte.Component.set(a.databindSubform,a.subformFields.api_name,s):r.ltProp("currentDate")?Lyte.Component.set(a.dataBind,a.moduledataUicomp.api_name,s):Lyte.Component.set(a.dataBind,a.moduledataUicomp.api_name,"")}else r&&t&&Lyte.Component.set(a.databindSubform,a.subformFields.api_name,n);"DUEDATE"===a.columnName&&"Tasks"===a.modulenameUicomp&&a.dataBind.Due_Date&&Lyte.Component.set(this.data.moduleData[i],"recurring_read_Only",!1)},togglePlaceholder:function(e,t,a,i){var r,o=this.getData("initialPicklistdata"),n=JSON.parse(a),s=[];if(n.length){var l=o.length;for(r=0;r<l&&(!n.contains(o[r].display_value)||(s.push(o[r].display_value),s.length!=n.length));r++);i.setData("ltPropSelected","[]"),i.setData("ltPropSelected",JSON.stringify(s))}var d=this.$node.component.data,c=d.dataBind?d.dataBind:d.databindSubform,u=d.dataBind?d.apiName:d.subformFields.api_name;(validationUtils.isNotEmpty(c.$.error[u])&&"ERR02"==c.$.error[u].code?0:c[u]?"string"==typeof c[u]?JSON.parse(c[u]).length:c[u].length:0)>=1?this.$node.querySelector("lyte-dropdown").ltProp("placeholder",""):this.$node.querySelector("lyte-dropdown").ltProp("placeholder","None")},lookupInit:function(e,t,a,i,r){var o=e.data.module;if(o.module_name){e.setData("moduleName",o.module_name);var n=o.display_field.api_name;if(e.setData("displayField",n),a)e.getCustomView(o,e);else if(e.data.sfBulkLookupModal)e.getRecs();else{if(e.data.selectedSingleId)new Promise((function(t){e.setSelectedId(o.id,e.data.selectedSingleId,t)})).then((function(){e.beforeShowFunc(i,r,!0)}));else e.beforeShowFunc(i,r,!0)}}else store.findRecord("module",t,e.data.sfBulkLookupModal?e.data.requiredLookupProp:void 0).then((function(t){o=t[0],e.setData({module:o,moduleName:o.module_name});var n=o.display_field.api_name;if(e.setData("displayField",n),a)e.getCustomView(o,e);else if(e.data.sfBulkLookupModal)e.getRecs();else{if(e.data.selectedSingleId)new Promise((function(t){e.setSelectedId(o.id,e.data.selectedSingleId,t)})).then((function(){e.beforeShowFunc(i,r,!0)}));else e.beforeShowFunc(i,r,!0)}}),(function(t){e._initRej&&e._initRej();var a=!1;if(403===t.status)a=!0;else if(400===t.status&&t.responseText&&"string"==typeof t.responseText){var i=JSON.parse(t.responseText);i&&"NO_PERMISSION"===i.code&&(a=!0)}if(a)return renderingUtils.displayPermissionDenied(void 0,void 0,void 0,10100),!1}))},getCustomView:function(e,t){store.findAll("custom_view",{module:e.api_name}).then((function(a){for(var i,r=a.length,o=0;o<r;o++)if("ALLVIEWS"===a[o].system_name&&a[o].name.startsWith("All")){i=a[o].id,t.setData("customViewId",i);break}i=i||e.custom_view.id,store.findRecord("custom_view",i,{module:e.api_name}).then((function(a){e.custom_view=a,t.setData("module",e),t.getRecs()}))}),(function(e){403===e.status&&(commonUtils.showHideLoadingDiv(!1),renderingUtils.displayPermissionDenied())}))},setRelatedComponent:function(e){e.getData("relatedFieldComp");for(var t,a=e.getData("moduleName"),i=e.getData("relations"),r=i.length,o=e.getData("moduledataUicomp"),n=o.api_name,s=0,l=0;l<r;l++){if(i[l].thisModule===a&&"Reporting_To"!==n){t=i[l],e.relation=!0;break}if(i[l].thisModule===a&&n===i[l].label){t=i[l],e.relation=!0;break}}if(e.setData({relatedTo:t}),e.relation&&(t.thisCustom||!o.custom_field)){var d=e.getData("moduleData").fields,c=(r=d.length,[]),u=[],m=0;for(l=0;l<r;l++)if("Who_Id"===this.getData("moduledataUicomp").api_name||"What_Id"===this.getData("moduledataUicomp").api_name){if((t.relatedCustom||!d[l].custom_field)&&"lookup"===d[l].data_type&&"PARENTACCOUNTID"!==d[l].column_name){var p,f=!1;if("Events"===this.getData("modulenameUicomp")||"Events"!==this.getData("modulenameUicomp")&&"Who_Id"===this.getData("moduledataUicomp").api_name?"se_module"===d[l].lookup.module.api_name&&("Contacts"===t.thisModule?t.relatedModule1===this.getData("currentPossibleSeModule")&&(p="Accounts",f=!0):"Potentials"!==t.thisModule&&"Quotes"!==t.thisModule&&"SalesOrders"!==t.thisModule&&"Campaigns"!==t.thisModule||(p="Contacts",f=!0)):"Events"!==this.getData("modulenameUicomp")&&"What_Id"===this.getData("moduledataUicomp").api_name&&"Contacts"===d[l].lookup.module.api_name&&("Potentials"!==t.thisModule&&"Quotes"!==t.thisModule&&"SalesOrders"!==t.thisModule&&"Campaigns"!==t.thisModule||(p="Contacts",f=!0)),f){var _;c[s]={apiName:d[l].api_name,index:l},c[s].relatedTo=t,_=moduleRecordMapping[p].id;var y=store.peekRecord("module",_);c[s].module=y,c[s]&&c[s].module&&!c[s].module.related_lists&&-1===u.indexOf(y.id)&&(u[m]=y.id,m++),s++}}}else if((t.relatedCustom||!d[l].custom_field)&&"lookup"===d[l].data_type&&"PARENTACCOUNTID"!==d[l].column_name&&(t.relatedModule1===d[l].lookup.module.api_name||t.relatedModule2===d[l].lookup.module.api_name)){c[s]={apiName:d[l].api_name,index:l},c[s].relatedTo=t;y=store.peekRecord("module",d[l].lookup.module.id);c[s].module=y,c[s]&&c[s].module&&!c[s].module.related_lists&&-1===u.indexOf(y.id)&&(u[m]=y.id,m++),s++}e.setData({relatedFieldComp:c}),c.length&&(e.promise=new Promise((function(t){e.returnRelComp(e,u,t)})))}},returnRelComp:function(e,t,a){var i=this.getData("relatedFieldComp"),r=t.length;store.batch((function(){for(var e=0;e<r;e++)store.findRecord("module",t[e],void 0,void 0,void 0)})).then((function(){r=i.length;for(var t=0;t<r;t++){i[t].module=store.peekRecord("module",i[t].module.id);for(var o=e.getData("module"),n=i[t].module.related_lists,s=n.length,l=0;l<s;l++)n[l].api_name!==o.module_name&&n[l].api_name!==o.api_name||(i[t].relation={relationId:n[l].id,api_name:o.api_name},e.setData({relatedFieldComp:i}));a()}}))},setLookupHeader:function(e,t,a){t=t||{};var i=this.getData("columnList")&&t.lookup_field_properties?t.lookup_field_properties:t.custom_view,r=i.fields,o=r.length,n=!1;e.getData("fieldProperties",i);for(var s=e.data.fieldsId,l=[],d=[],c=[],u=0;u<o;u++)d[u]=r[u].id;for(var m=0,p=0;m<o;m++){u=s.indexOf(d[m]);d[m]===t.display_field.id&&a&&(n=!0),-1!==u&&t.fields[u].visible&&(l[p]=t.fields[u],c[p]={id:t.fields[u].id,api_name:t.fields[u].api_name,field_label:t.fields[u].field_label},"Full_Name"===t.fields[u].api_name&&(l[p].field_label=t.singular_label+" "+I18n.getMsg("crm.follow.label.name"),c[p].field_label=l[p].field_label),p++)}return e.setData({header:l,selFields:c}),n},relatedRecords:function(e,t,a){for(var i,r,o=this.getData("moduleData"),n=t.length,s=this.data.currentInstObjKey,l=0;l<n;l++)(r=(i=o.fields[t[l].index])[s].selectedId)&&t[l].relation&&(t[l].currentRelationQuery={relatedId:r,relationId:t[l].relation.relationId},t[l].lookupSingle=i[s].lookupSingle,a=void 0!==a?a:l);return a},constructQueryparam:function(e,t,a){var i=t.filters?JSON.parse(t.filters):{},r=e.getData("ddValue"),o={};r=r||0,o=JSON.parse(JSON.stringify(t));var n=e.data.currentInstObjKey;if(a&&a.length&&-1!=r)if(a[r].relatedTo.relatedModule2&&a[1]){var s,l={},d=e.getData("moduleData"),c=d.fields[a[0].index],u=d.fields[a[1].index],m=c[n].selectedId,p=u[n].selectedId,f="Contacts"===a[0].module.module_name?"Contact_Name":"Account_Name",_="Contacts"===a[1].module.module_name?"Contact_Name":"Account_Name";s=[{field:{api_name:f,id:c.id},comparator:"equal",value:m},{field:{api_name:_,id:u.id},comparator:"equal",value:p}],m&&p?l.filters={group_operator:"OR",group:s}:m?l.filters=s[0]:p&&(l.filters=s[1]),i&&(i="AND"===i.group_operator&&"OR"===i.group[0].group_operator?{group_operator:"AND",group:[l.filters,i.group[1]]}:t.filters?{group_operator:"AND",group:[l.filters,i]}:l.filters),o.filters=JSON.stringify(i)}else{(l=a[r].currentRelationQuery)&&l.relationId&&(o.relationId=l.relationId,o.relatedId=l.relatedId)}return o},relatedRecordsRequest:async function(e,t,a,i){var r=e.getData("queryParamObject"),o=e.getData("relatedFieldComp"),n=this.getData("isLookupAdvancedSearchEnabled");r.page=1,r.per_page=11,e.setData("ddValue",t);var s,l={},d=e.getData("modId"),c=e.getData("apiName"),u=e.getData("fldId");return l=await e.getactiveProducts(r),(l=e.constructQueryparam(e,l,o)).criteria&&(s={type:"Search",from:"Lookup",criteria:l.criteria}),e.getData("showAll")&&"Reporting_To"!==c?(e.setData("show",!0),void e.setData("ddValue",-1)):new Promise(function(t,o){store.findAll(d,l,!1,!1,s).then((function(s){s=(s=s[d])&&s.length?s:[],e.setData("repRecord",s);var l=document.querySelector("#"+u+"_input");if(l){var c=l.querySelector("lyte-input");c&&c.classList.contains("lyteInputFocus")}var m=s.length;r.page=Math.ceil(m/11),r.per_page=11,e.setData("queryParamObject",r),i&&(n?e.setSelected(s):e.rendHome(),a||(e.setData("show",!0),e.getData("showAll")&&(e.setData("ddValue",-1),e.setData("showAll",!1))),!s||s.length<11?e.setNavigator(s.length):e.setNavigator(s.length,!0)),c||i?t():o()}),(function(t){e.rejectFunc(t),o&&o(t)}))}.bind(this))},rejectFunc:function(e){"NO_PERMISSION"!==JSON.parse(e.response).code&&400!==e.status||renderingUtils.displayPermissionDenied(),this.setData("show",!1)},scrollRequest:async function(e,t,a,i,r){if(!e.scrl&&a.scrollTop+a.offsetHeight>=a.scrollHeight-30){if(t.page+=1,t.per_page=11,e.scrl=!0,r){var o=e.$node.querySelector("#modalElem").component.childComp.querySelector(".lookupFetchLoad");o&&(o.style.display="block")}var n,s=e.data.module.id,l=await e.getactiveProducts(t),d=this.getData("relatedFieldComp"),c=e.getData("apiName");(r||"Reporting_To"===c)&&(l=this.constructQueryparam(this,l,d));const a=this.getData("moduledataUicomp")&&this.getData("moduledataUicomp").criteria;(l.criteria||a)&&(n={type:"Search",from:"Lookup",criteria:l.criteria?a?`(${l.criteria} and ${a.criteria})`:l.criteria:a.criteria});var u=this.getData("fldId")+"_load_img",m=document.querySelector("#"+u);m&&(m.classList.remove("dN"),m.classList.add("dIB")),store.findAll(s,l,!1,!1,n).then((function(a){(a=a[s])&&a.length?(i=i.concat(a),e.setData("record",i),r?Lyte.arrayUtils(e.data.displayArray,"push",a):Lyte.arrayUtils(e.data.ften,"push",a),e.setData("queryParamObject",t),a={}):e.noMoreScroll=!0,setTimeout((function(){e.scrl=!1}),20),r&&o&&(o.style.display="none"),m&&(m.classList.remove("dIB"),m.classList.add("dN"))}),(function(t){e.rejectFunc(t)}))}},cloneCase:function(e,t,a){var i=e.getData("moduledataUicomp"),r=i.multiselectlookup.api_name,o=e.getData("apiName"),n=e.getData("module"),s=document.querySelector("CRM-CREATE-LAYOUT").component.data,l=i.module[0].id;t=t||s.entityrecordData.id,store.triggerAction(l,"fetchrelatedList",{entityid:t,relapiname:r}).then((function(t){for(var i=t.data,r=[],s=i.length,d=0;d<s;d++)r[d]=i[d][o].id;var c=r.toString(),u=[],m=[],p=n.display_field.api_name;l=n.id,store.findAll(l,{ids:c},!1,!1).then((function(t){t=(t=t[l])||[];var i=r.slice();e.setData({selectedArray:r}),s=t.length;for(var o=0,n=0;o<s;o++)-1!==r.indexOf(t[o].id)&&(u[n]=t[o][p],m[n]=t[o],n++);e.setData({lookupList:u,multiselRecords:m}),e.setData("dispInit",!0),a?(e.setData({initComp:!0}),e.initcomp=!0,e.getData("dispInit")&&e.setData({toShow:"sel"}),e.editcloneSetdata(t,r,e.data.initRoute)):e.setData("prevSelectedarray",i)}))}))},newCreate:function(e,t,a,i){var r=e.getData("fldId"),o=e.getData("module"),n=this.getData("relatedFieldComp"),s=this.getData("moduleData"),l=this.getData("moduledataUicomp.id"),d=e.getData("currentLayout"),c=e.getData("lookupSingle");i&&(c="");var u=this.data.currentInstObjKey;if(d=d?d.split(";")[0]:null,e.saveUnsel=!0,e.setData("tempClose",!0),e.setData("show",!1),o.module_name)var m=Crm.getCrmBasePath()+"/QuickCreateAction.do?module="+o.module_name+"&searchmodule="+o.module_name+"&fldName="+r+"&fldId="+r+"&fldLabel="+o.module_name+"&fldValue="+encodeURIComponent(c)+"&newModel="+!0+"&folLayoutId="+d+"&folLookupFieldId="+l;if(this.data.productId&&(m+="&productId="+this.data.productId),this.getData("accDetails")&&this.getData("accDetails").length>0&&(m+="&accDetails="+this.data.accDetails),"Reporting_To"===this.getData("apiName")){var p=n&&n[0]?n[0].index:void 0,f=void 0!==p?s.fields[p][u].lookupSingle:"",_=void 0!==p?s.fields[p][u].selectedId:"";if(_){var y={accounts:[{id:_,name:f}]};m=(m=(m=(m=m+"&productId="+_)+"&entityId="+window[o.module_name].entityId)+"&accDetails="+encodeURIComponent(JSON.stringify(y)))+"&accountid="+_+"&accountname="+encodeURIComponent(f)}}m=networkUtils.getPortalURL(m),1==this.getData("isfromOutlookRightPanel")&&(m+="&isfromOutlookRightPanel=true"),s[u].currencyData&&s[u].currencyData.key&&(m=m+"&currencyISOCode="+s[u].currencyData.key),(e=$("#searchCreatePopup"))[0]&&a&&e[0].classList.add("quickCreateModalOverLyteModal"),e.removeClass("fromAutoComplete"),(void 0===Crm.userDetails.VALIDATIONRULEAVAILABLE||!0===Crm.userDetails.VALIDATIONRULEAVAILABLE&&Crm.userDetails.VRINVOLVEDMODULES.contains(this.getData("module.module_name")))&&Crm.downloadValidationRules(m,this.getData("module.module_name")),Crm.userDetails.isLookupAdvancedSearchEnabled&&(m+="&openInAdvSearch=true");var g=this.getData("modulenameUicomp"),v=this.getData("moduledataUicomp.id"),h=$("#"+r+"_img");h&&h.data({label:r,cid:"showLookup",lookupModule:o.module_name,module:g});var D=$("#"+r);D&&D.data({colname:v.column_name,contentType:"Lookup",customfield:v.custom_field,displaylabel:v.display_label,fieldid:v.id,label:v.display_label,lookupModule:o.module_name,name:v.display_label}),t?commonUtils.openCustomLookup(m,void 0,"searchCreatePopup",void 0,void 0,void 0,void 0,void 0,(function(){if(c){var e=$("#ac-recordname").children().find("input"),t=e.attr("maxlength");c.length>t&&(c=c.substring(0,t)),e.val(c)}})):commonUtils.openCustomLookup(m,void 0,"searchCreatePopup")},saveNewRecord:function(e,t){var a=e.getData("save"),i=e.getData("modId"),r=e.getData("newCreatedid"),o=e.getData("isSingle");if(a||r)if(o)r?store.findRecord(i,r,{approved:"both"}).then((function(a){var i,r=e.getData("displayField");a[0]&&a[0].id&&(i="Full_Name"===(r=e.getData("displayField"))?a[0].First_Name?a[0].First_Name+" "+a[0].Last_Name:a[0].Last_Name:a[0][r],t?e.setData({lookupSingle:i,selectedSingle:a[0].id,selectedSingleRecord:a[0]}):e.setData({lookupSingle:i,selectedSingle:a[0],selectedSingleId:a[0].id}))}),(function(e){n.rejectFunc(e)})):a&&e.showLookupFunc(e,t,!0),e.setData({saveAndAssociate:!1,save:!1,newCreatedid:""});else{var n=e||{},s=n.getData("queryParamObject");n.getData("selectCount");this.$node.classList.remove("currentLookupModal"),s=s.sort_order&&!o?s:{page:1,per_page:11},store.findAll(i,{page:1,per_page:1,approved:"both"},!1,!1).then((function(e){e=e[i];var t=n.getData("unselectedArray"),r=n.getData("unselId"),o=!a,l=a?l:l+1;t[t.length]={id:e[0].id,check:o},r[r.length]=e[0].id,n.setData({unselectedArray:t,unselId:r,selectCount:l+1}),s.approved="both";var d=n.getactiveProducts(s);store.findAll(i,d,!1,!1).then((function(e){e=(e=e[i])&&e.length?e:[],n.setData({record:e,currPage:0}),n.filtered=!1,n.setData("show",!0),n.rendHome()}))})),n.setData({saveAndAssociate:!1,save:!1,newCreatedid:"",queryParamObject:s})}},showLookupFunc:function(e,t,a){if(a="Reporting_To"!==e.getData("apiName")&&a,t||this.getData("renderLookup")){e.setData("show",!1);var i=(e=t?e:this.$node.querySelector("crm-create-lookupmodal").component).data.isSingle,r=e.data.module,o=r.module_name,n=r.id;if(i){var s=store.peekRecord("module",n),l={page:1,per_page:11};store.findRecord("custom_view",s.custom_view.id,{module:s.api_name}).then((function(t){s.custom_view=t,e.setLookupHeader(e,s),(t=t&&t.length?t[0]:t)&&t.sort_by&&(l.sort_by=t.sort_by.api_name,l.sort_order=t.sort_order);var i=e.getactiveProducts(l);store.findAll(moduleRecordMapping[o].id,i,!1,!1).then((function(t){t=(t=t[moduleRecordMapping[o].id])&&t.length?t:[],e.setData({record:t,queryParamObject:l}),e.setData("show",!1),!a&&e.data.relatedFieldComp[0]&&e.data.relatedFieldComp[0].relatedTo?e.relRecs():e.data.isLookupAdvancedSearchEnabled?(e.setData({displayArray:t,show:!0}),a&&e.setData("ddValue",-1)):(e.setData({show:!0}),a&&e.setData("ddValue",-1),!t||t.length<11?e.setNavigator(t.length):e.setNavigator(t.length,!0),e.rendHome()),commonUtils.showHideLoadingDiv(!1)}),(function(e){403===e.status&&(commonUtils.showHideLoadingDiv(!1),renderingUtils.displayPermissionDenied())}))}),(function(e){403===e.status&&(commonUtils.showHideLoadingDiv(!1),renderingUtils.displayPermissionDenied())}))}else{if("unsel"===e.data.toShow){e.setData("show",!1);l={page:1,per_page:11,approved:"both"};var d=e.getactiveProducts(l);store.findAll(moduleRecordMapping[o].id,d,!1,!1).then((function(t){if(t=(t=t[moduleRecordMapping[o].id])&&t.length?t:[],commonUtils.showHideLoadingDiv(!1),e.setData("record",t),t){var a,i=[],r=[],n=[];a=t.length;for(var s=0;s<a;s++)i[s]={id:t[s].id,check:!1},r[s]=t[s],n[s]=t[s].id;e.setData({record:t,unselectedArray:i,curSel:i,displayArray:r,recsId:n,unselId:n,next:[0,10],currentPage:0,queryParamObject:l}),!t||t.length<11?e.setNavigator(a):e.setNavigator(a,!0),e.rendHome(),e.getData("show")&&e.setData("show",!1),e.setData("show",!0)}}))}else if("sel"===e.data.toShow){var c=e.data.selectedArray;(l=e.data.queryParamObject).ids=c.toString(),l.page=1,e.setData({show:!1,preselRecord:[],queryParamObject:l});d=e.getactiveProducts(l);store.findAll(moduleRecordMapping[o].id,d,!1,!1).then((function(t){commonUtils.showHideLoadingDiv(!1),t=(t=t[moduleRecordMapping[o].id])&&t.length?t:[],e.setData({preselRecord:t}),e.rendHome(),e.setData({show:!0}),e.setNavigator(c.length)}))}e.setData("highlightArray",[])}}else{"lookup"===e.getData("moduledataUicomp").data_type?e.setData("isSingle",!0):e.setData("isSingle",!1),e.setData("renderLookup",!0),e.setData("dispInit",!0),a&&e.setData("showAll",!0)}},getactiveProducts:async function(e,t,a,i){var r=this.$node&&"CRM-CREATE-FIELDS"===this.$node.tagName;if(r)return await this.fieldGetCriteria(e,t);var o=Lyte.deepCopyObject(e);if(a)n=$("crm-canvas-form")[0].component.getData("moduleObj");else var n=this.getData("module"),s=this.getData("onlyactiveProducts"),l=this.getData("modulenameUicomp"),d=this.getData("moduledataUicomp.custom_field"),c=this.getData("initRoute");var u=store.peekRecord("field",t||this.data.moduledataUicomp.id);if("Products"===n.module_name&&s)o.product_active=!0,o=await this.filterConstructor(Lyte.deepCopyObject(o),void 0,void 0,!0);else if(n.module_name!==l||d||"edit"!==c)u&&u.lookup&&u.lookup.query_details&&u.lookup.query_details.criteria?(o.query_id||(o.query_id=u.lookup.query_details.query_id),o=await this.filterConstructor(o,u.lookup.query_details.criteria,"static_lookup_filter",void 0,a,i,n)):r&&(o=await this.filterConstructor(Lyte.deepCopyObject(o),void 0,void 0,!0));else{var m=this.getData("dataBind.id");o=await this.filterConstructor(o,{field:{api_name:"id"},comparator:"not_equal",value:[m]},"id",r)}return o.approved="both",o.approval_state="approved,approval_process_pending,approval_process_rejected",Lyte.deepCopyObject(o)},isFieldInvolvedInValue:function(e){return e.group?this.isFieldInvolvedInValue(e.group):e.length>1?!!this.isFieldInvolvedInValue(e[0])||(!!this.isFieldInvolvedInValue(e[1])||void 0):"field"===e.type},fieldGetCriteria:async function(e,t){var a=Lyte.deepCopyObject(e),i=this.getData("module"),r=this.getData("onlyactiveProducts"),o=this.getData("modulenameUicomp"),n=this.getData("moduledataUicomp.custom_field"),s=this.getData("initRoute"),l=store.peekRecord("field",t||this.data.moduledataUicomp.id),d=this.getData("moduledataUicomp");if("Products"===i.module_name&&r){var c=this.getData("module.fields").filter((function(e){return"Product_Active"===e.api_name}))[0],u=c&&c.profiles?c.profiles.some((function(e){return Crm.userDetails.PROFILE_NAME===e.name}))[0]:void 0;c&&(u&&"hidden"!==u.permission_type||c.visible)&&(a=this.queryConstructor(Lyte.deepCopyObject(a),"(Product_Active:equals:true)"))}if(i.module_name===o&&!n&&"edit"===s){var m=this.getData("dataBind.id");a=this.queryConstructor(Lyte.deepCopyObject(a),"(id:not_equal:"+m+")")}var p=this.getData("relatedFieldComp");return"Reporting_To"===d.api_name&&p[0]&&"Account_Name"===p[0].apiName&&p[0].currentRelationQuery&&p[0].currentRelationQuery.relatedId&&(a=this.queryConstructor(Lyte.deepCopyObject(a),"(Account_Name:equals:"+p[0].currentRelationQuery.relatedId+")")),l&&l.lookup&&l.lookup.query_details&&l.lookup.query_details.query_id&&(a.query_id=l.lookup.query_details.query_id,a=await this.filterConstructor(Lyte.deepCopyObject(a),l.lookup.query_details.criteria,"static_lookup_filter",!0)),"Services"===i.module_name&&"SERVICEID"===this.data.columnName&&(a=await this.filterConstructor(a,{comparator:"not_equal",field:{api_name:"Status"},value:["Not in Use"]},void 0,!0)),a.approved="both",a.approval_state="approved,approval_process_pending,approval_process_rejected",Lyte.deepCopyObject(a)},queryConstructor:function(e,t){return e.criteria=e.criteria?e.criteria+"and"+t:t,e},filterConstructor:async function(e,t,a,i,r,o,n){var s,l,d,c,u={},m=[],p=r?void 0:this.getData("displayField");if(e.filters)if("AND"===(s=JSON.parse(e.filters)).group_operator)(m=s.group).forEach((function(e,t){if(e.field)if(e.field.api_name===a)d=t;else if(e.field.api_name===p&&i){var r=[];r[0]={field:{api_name:p},comparator:"starts_with",value:e.value},r[1]={field:{api_name:p},comparator:"contains",value:" "+e.value},r[2]={field:{api_name:p},comparator:"contains",value:"-"+e.value},r[3]={field:{api_name:p},comparator:"contains",value:":"+e.value},r[4]={field:{api_name:p},comparator:"contains",value:","+e.value},r[5]={field:{api_name:p},comparator:"contains",value:";"+e.value},r[6]={field:{api_name:p},comparator:"contains",value:"("+e.value},r[7]={field:{api_name:p},comparator:"contains",value:"["+e.value},r[8]={field:{api_name:p},comparator:"contains",value:"{"+e.value},l={group_operator:"OR",group:r},c=t}})),d||(m[m.length]=t),c&&(m[c]=l),s.group=m,e.filters=JSON.stringify(s);else if(s.field.api_name!==a){if(s.field.api_name===p&&i){var f=[];f[0]={field:{api_name:p},comparator:"starts_with",value:s.value},f[1]={field:{api_name:p},comparator:"contains",value:" "+s.value},f[2]={field:{api_name:p},comparator:"contains",value:"-"+s.value},f[3]={field:{api_name:p},comparator:"contains",value:":"+s.value},f[4]={field:{api_name:p},comparator:"contains",value:","+s.value},f[5]={field:{api_name:p},comparator:"contains",value:";"+s.value},f[6]={field:{api_name:p},comparator:"contains",value:"("+s.value},f[7]={field:{api_name:p},comparator:"contains",value:"["+s.value},f[8]={field:{api_name:p},comparator:"contains",value:"{"+s.value},s={group_operator:"OR",group:f}}a?(u.group_operator="AND",this.isFieldInvolvedInValue(t)||(u.group=[s,t],e.filters=JSON.stringify(u))):e.filters=JSON.stringify(s)}if(t)if("static_lookup_filter"===a){if(Crm.userDetails.isDynamicLookupFilterEnabled&&Lyte.registeredMixins["crm-lookup-filter-mixin"].isDynamicCriteriaInvolved(t)&&!e.hasOwnProperty("child_data")){var _={};let a;if(this.$node){switch(this.$node.tagName){case"CRM-CREATE-FIELDS":a=this.getData("dataBind");break;case"CRM-CONVERT-DEAL-FIELDS":case"CRM-MASS-CONVERT-DEAL":a=this.getLeadConvertPageData();break;case"CRM-CANVAS-AJAXEDITPOPUP":a=this.data.originalRecord;break;default:a=this.data.record?this.data.record:o}if(a.__parent_module__&&(a=a.__parent_module__),this.data.modulenameUicomp){if(this.data.fromSubform){var y={};let e=this.$node.closest("crm-create-subformfields").component.data;y.indexVal=e.indexVal,y.id=e.databindSubform.id,y.subformApiName=this.data.subformapiName;let i=await this.loadChildRelationShip(y,this.data.modulenameUicomp);var g=moduleRecordMapping[this.data.modulenameUicomp].fields.concat(i);this.iterateGroupFieldsAndGetFieldValuesFromRecordData(t,a,_,g,this.data.modulenameUicomp,y)}if(a.__parent_module__&&(a=a.__parent_module__),this.data.modulenameUicomp)if(this.data.fromSubform){y={};let e=this.$node.closest("crm-create-subformfields").component.data;y.indexVal=e.indexVal,y.id=e.databindSubform.id,y.subformApiName=this.data.subformapiName;let i=await this.loadChildRelationShip(y,this.data.modulenameUicomp);g=moduleRecordMapping[this.data.modulenameUicomp].fields.concat(i);this.iterateGroupFieldsAndGetFieldValuesFromRecordData(t,a,_,g,this.data.modulenameUicomp,y)}else this.iterateGroupFieldsAndGetFieldValuesFromRecordData(t,a,_,moduleRecordMapping[this.data.modulenameUicomp].fields,this.data.modulenameUicomp);else"CRM-CONVERT-DEAL-FIELDS"===this.$node.tagName?this.iterateGroupFieldsAndGetFieldValuesFromRecordData(t,a,_,moduleRecordMapping.Deals.fields,"Deals",void 0,"canvas"):this.$node&&"CRM-CANVAS-AJAXEDITPOPUP"===this.$node.tagName?(this.iterateGroupFieldsAndGetFieldValuesFromRecordData(t,a,_,moduleRecordMapping[this.data.moduleData.module_name].fields,this.data.moduleData.module_name,void 0,"canvas"),this.data.record.id&&(_.id=this.data.entityId)):(this.iterateGroupFieldsAndGetFieldValuesFromRecordData(t,a,_,moduleRecordMapping[this.data.module].fields,this.data.module,void 0,"canvas"),this.data.module&&(_.id=this.data.entityId,"CRM-DETAILVIEW-FIELDS"===this.$node.tagName&&this.data.record&&(_.id=this.data.record.id)));"edit"!==this.data.initRoute&&"clone"!==this.data.initRoute||(a.id.includes("_cloneOnEdit")?_.id=a.id.split("_")[0]:_.id=a.id)}else o&&(a=o,Lyte.registeredMixins["crm-lookup-filter-mixin"].iterateGroupFieldsAndGetFieldValuesFromRecordData(t,a,_,n.fields,n.module_name,void 0,"canvas"),"edit"===window[n.module_name].currentStatus&&(_.id=o.id));e.child_data=_}}}else e.filters=JSON.stringify(t);return e},setCustomValidationsforfields:function(e,t,a,i,r){var o=a.$.model.fieldList[t.api_name];if(o){t.required?"picklist"==t.data_type&&i?(o.mandatory=!0,o.validation="picklistValidation"):(o.mandatory=!0,o.validation="emptyValueValidation"):o.mandatory=!1,o.field_validation&&(o.field_validation=!1);var n=$L("crm-create-layout")[0],s=!!n&&n.component;if(s){var l=s.getData("validationRules");if(l&&!t.read_only){var d=l.length;for(let e=0;e<d;e++){var c=l[e];c.field_validation&&c.field.api_name===t.api_name&&(o.field_validation=!0,o.valId=c.id)}}}if("email"==t.data_type)o.validation="emailValidation";else if("website"==t.data_type)o.validation="websiteValidation";else if("date"==t.data_type||"datetime"==t.data_type)t.ui_type===CrmField.UITYPES.MULTI_DATE_SELECT?o.validation="multiselectdateValidation":o.validation="datetimeValidation",o.fieldLabel=t.field_label;else if("time_range"===t.data_type)o.validation="multiselecttimeRangeValidation",o.fieldLabel=t.field_label;else if("currency"==t.data_type||"double"==t.data_type&&"EXCHANGERATE"!=t.column_name)o.validation="decimalValidation",["DISCOUNT","TAX"].contains(t.column_name)&&this.data&&this.data.isdefaultInvSubform&&delete o.validation,o.decimal_place=t.decimal_place,o.length=t.length,a[t.api_name]&&t.read_only&&"string"!=o.type&&"expected-revenue"!=o.type&&a.$.set(t.api_name,Number(a[t.api_name].toFixed(t.decimal_place)));else if("phone"==t.data_type||"FAX"===t.column_name)this.data&&this.data.isfromBulkaddition&&Crm.userDetails.isPhoneNoNewView?(o.validation="SFBulkFieldValidator",o.length=t.length):(o.validation="phonenumValidation",o.length=t.length);else if("integer"!==t.data_type&&"bigint"!==t.data_type||["PARTICIPANTID","SERVICEDURATION","APPOINTMENTDURATION"].contains(t.column_name)||"LAYOUTID"===t.column_name||"WIZARDID"===t.column_name){if("TWITTER"===t.column_name)o.validation="twitteridValidation";else if("Campaign_Name"===t.api_name||"Native__Campaigns__Extn__Campaign_Subject"===t.api_name||"Native__Campaigns__Extn__Sender_Name"===t.api_name){"campaign"===store.peekRecord("layout",r).created_for?(o.maxLength="Native__Campaigns__Extn__Sender_Name"===t.api_name?100:125,o.validation="campaignNameValidation"):o.maxLength&&(o.maxLength=t.length)}else if("Native__Backstage__Extn__Event_Name"===t.api_name){"backstage"===store.peekRecord("layout",r).created_for&&(o.validation="campaignNameValidation")}}else o.validation="integerValidation",o.length=t.length;o.validation||"string"!==o.type||(o.validation="basicFieldLengthValidator"),"SMOWNERID"===t.column_name&&Crm.userDetails.LITE&&Crm.userDetails.LITE.IS_LITE_USER&&(o.mandatory=!0),store.addField(e,t.api_name,o.type,o,!0)}},checkEmailforCaseOrigin:function(e,t){var a=e.$.model.fieldList.Email,i=this.data.currentInstObjKey,r=this.data.isWizard;if(validationUtils.isNotEmpty(a)){var o,n=this.getData("moduleData.fields"),s=this.data.moduleData[i].renderedLayoutId,l=(n=n||[]).filter((function(e){return"CASEORIGIN"===e.column_name&&(o=e),"EMAIL"===e.column_name}));l=l&&l[0]?l[0]:{};var d=o&&o[s]?o[s].pick_list_values:void 0;d=d&&d.length?d.filter((function(e){return e.display_value===t}))[0]:void 0;var c="edit"===this.getData("initRoute")?"edit":"create";if(d&&"Email"===d.actual_value&&validationUtils.isNotEmpty(l)&&l.view_type[c]&&!l.read_only){var u="crm-create-fields#"+this.getData("moduleData.module_name")+"_fldRow_EMAIL",m=$L(u)[0];r?(a.mandatory||(a.mandatory=!0),l.$.set("required",!0),l[i].isMandateByRules=!0):(a.mandatory=!!m,l.$.set("required",a.mandatory))}else l&&!l[i].isLayoutMandatory&&(l.$.set("required",!1),a.mandatory=!1);store.addField(e.$.model._name,"Email",a.type,a)}},unloadWizardComponents:function(e){store.unloadAll("wizard-screen"),store.unloadAll("wizard-segment"),store.unloadAll("wizard-button"),store.unloadAll("transition"),store.unloadAll("custom_button")},clearMandatoryData:function(e){var t=Object.assign({},e.$.error);for(var a in t)if(e.$.error.hasOwnProperty(a)&&"ERR02"===e.$.error[a].code){var i=e.$.model.fieldList[a];i.mandatory=!1,store.addField(e.$.model._name,a,i.type,i),e.$.set(a,void 0)}},resetSubformCachedRecordIds:function(e){if(Crm.userDetails.isSubformNewComponentEnabled){var t=document.querySelectorAll("crm-create-subformsection"),a=this.getData("currsubformApinames"),i=this.data.originalData;e=e||this.data.module,a&&this.data.originalData&&a.forEach((function(a){var r=i[a];if(r&&t.length>0){var o=t.filter((function(t){return t.id===e+"_SubForm_"+a}))[0];if(o){for(var n=r.length,s=[],l=0;l<n;l++)s.push(r[l].id);o.component.setData("processCache",!1),o.component.setData("cacheRecordIds",s)}}}))}},validateLayoutswitchingForSubForm:function(e,t){e.forEach(function(e){var a=this.getData("modifiedCreatebject"),i=this.getData("dataBind")[e],r=[];if(i&&i.length&&i.forEach((function(e){r.push(e.$.toJSON())})),a[e]=r,this.setData("modifiedCreatebject",a),t){var o=this.getData("initialCreatebject");o[e]=r,this.setData("initialCreatebject",o)}}.bind(this))},revertOriginalData:function(){var e=this.getData("originalData"),t=this.getData("dataBind");for(var a in e)"multi-picklist"==t.$.model.fieldList[a].type&&t[a]&&"string"!=typeof t[a]&&(t[a]=JSON.stringify(t[a]))},rollBackCreateEntityRecord:function(e){var{rectobeUnloaded:t,currsubformApinames:a}=e;if(store.clearCachedQuery("user"),t&&validationUtils.isNotEmpty(t.$)){var i=a,r=[];i&&i.length&&t&&i.forEach((function(e){t.$.model.fieldList[e]&&"relation"==t.$.model.fieldList[e].type&&t.$.model.fieldList[e].relatedTo&&r.push(t.$.model.fieldList[e].relatedTo)})),(t=store.peekRecord(t.$.model._name,t.id))&&t.$.rollBack();for(var o=r&&r.length?r.length:0,n=0;n<o;n++)store.rollBack(r[n])}},validateAndFocusMandatorySubform:function(e,t,a,i){for(var r,o=!0,n=e.querySelectorAll("crm-create-subformfields"),s=n.length,l=0;l<s;l++){var d=n[l].component.data;d.subformFields.read_only||"SERIAL_NUMBER"===d.subformFields.column_name||(d.subformFields.read_only||(o=!1),Lyte.Component.set(e.component.data,"mandatoryError",!0),void 0===r&&(r=n[l],$L.fastdom.measure(function(e,t,a){var r=e?e.getBoundingClientRect():"",o=r.top,n=r.left;i=this.getLatestErrorFocusField(i,o,n,e,t,a,!0)}.bind(this,n[l],!0,!1))))}o||(t.mandatoryError=!0,a.isValidMandatorySubforms=!1)},checkMandatorySubForm:function(e,t,a,i){if(Crm.userDetails.isMandatorySubFormEnabled){var r=i&&$("crm-canvas-form"),o=i&&r[0]?r[0].component.getData("module_name"):this.data.module,n=document.querySelector("#"+o+"_SubForm_"+e),s=i&&r[0]?r[0].component.data.currentInstObjKey:this.data.currentInstObjKey;if(!t&&n){var l=n.component.data,d={isValidMandatorySubforms:!0},c=i||l.subformsectionData[s].isvalidSection;if(!c)$L("crm-create-layout#"+o+"LC_layoutNode")[0].component.data.skipMandatory=!0;if(l.isMandatorySubform&&c){Lyte.Component.set(n.component.data,"mandatoryError",!1);for(var u=l.subFieldsarray,m=u.length,p=l.dataBind[l.apiName],f=!0,_=p.length,y=n.component.data.dataBind,g=y&&("approval_process_pending"===y.$approval_state||"approval_process_rejected"===y.$approval_state)&&y.$editable,v=0;v<_;v++){for(var h=!1,D=!1,b=0;b<m;b++)500===u[b].ui_type||!g||Lyte.registeredMixins.approvalprocess.skipMandatoryFieldCheck(n.component.data.moduleInfo,y,u[b].id,!0)||(D=!0);if(!g||D){for(b=0;b<m;b++)if(h=!1,!u[b].subform&&!(116===u[b].ui_type&&void 0===p[v][u[b].api_name]||"SERIAL_NUMBER"===u[b].column_name||2===u[b].ui_type&&("-None-"===p[v][u[b].api_name]||""===p[v][u[b].api_name])||100===u[b].ui_type&&"[]"===p[v][u[b].api_name]||void 0===p[v][u[b].api_name])){if(validationUtils.isEmptyString(p[v][u[b].api_name])||"boolean"===u[b].data_type&&!p[v][u[b].api_name])continue;if(555===u[b].ui_type){for(var L=p[v][u[b].api_name],C=L?L.length:0,I=0;I<C;I++)if(void 0!==L[I].file_id||void 0!==L[I].file_Id){h=!0;break}}else h=!0;if(h)break}h||(f=!1)}}if(i)return!!f;f||this.validateAndFocusMandatorySubform(n,l,d,a)}}}},checkAllMandatorySubForms:function(e,t){if(this.getData("isQuickCreate")||"quickCreate"===this.data.globalData.formType)return!0;if(Crm.userDetails.isMandatorySubFormEnabled){var a=document.querySelectorAll("crm-create-subformsection"),i=a?a.length:0,r={},o="crm-create-layout#"+this.getData("module")+"LC_layoutNode",n=this.data.currentInstObjKey,s=$L(o)[0];if(r.isValidMandatorySubforms=!0,!e&&i>0){for(var l=0;l<i;l++){var d=!0,c=a[l],u=c.component.data,m=u.subformsectionData[n].isvalidSection;if(!m&&s&&(s.component.data.skipMandatory=!0),u.isMandatorySubform&&m){Lyte.Component.set(c.component.data,"mandatoryError",!1);for(var p=u.subFieldsarray,f=p.length,_=u.dataBind[u.apiName],y=_.length,g=0;g<y;g++){for(var v=!1,h=0;h<f;h++)if(!p[h].subform&&116!==p[h].ui_type&&"SERIAL_NUMBER"!==p[h].column_name&&(2!==p[h].ui_type||"-None-"!==_[g][p[h].api_name]&&""!==_[g][p[h].api_name])&&(100!==p[h].ui_type||"[]"!==_[g][p[h].api_name])&&void 0!==_[g][p[h].api_name]){if(validationUtils.isEmptyString(_[g][p[h].api_name])||"boolean"===p[h].data_type&&!_[g][p[h].api_name])continue;if(555===p[h].ui_type){for(var D=_[g][p[h].api_name],b=D?D.length:0,L=0;L<b;L++)if(void 0!==D[L].file_id||void 0!==D[L].file_Id){v=!0;break}}else v=!0;if(v)break}v||(d=!1)}d||this.validateAndFocusMandatorySubform(c,u,r,t)}}if(!r.isValidMandatorySubforms)return!1}}return!0},clearUIError:function(e){for(var t=e||document.querySelectorAll("crm-create-fields,crm-create-subformsection,crm-create-subformfields"),a=t.length,i=[CrmField.UITYPES.SERVICE_TIMING,CrmField.UITYPES.MULTI_DATE_SELECT],r=0;r<a;r++){if(validationUtils.isNotEmpty(t[r].component.data.errorDetails))t[r].component.data.errorDetails.duplicateFdetails||Lyte.Component.set(t[r].component.data,"errorDetails",{});else if(i.contains(t[r].component.data.uiType)){if(Lyte.Component.set(t[r].component.data,"multiSelectErrorDetails",{}),(s=t[r].component.$node.querySelectorAll(".cuserrorFborder")).length)for(var o=s.length,n=0;n<o;n++)s[n].classList.remove("cuserrorFborder")}else if(validationUtils.isNotEmpty(t[r].component.data.aggerrorDetails)){var s;if(Lyte.Component.set(t[r].component.data,"aggerrorDetails",{}),s=t[r].component.$node.querySelector(".cuserrorAborder")){s.classList.remove("cuserrorAborder");var l=$L(s).parents(".lcAggError")[0];l&&l.classList.remove("lcAggError")}}var d=t[r].firstElementChild;if(d&&d.classList&&(d.classList.contains("highL")&&d.classList.remove("highL"),d.classList.contains("errorFieldP"))){var c=d.querySelector(".FValue.uploadDoc");if(c){d.classList.remove("errorFieldP");var u=c.querySelector("span.errMsg");u&&u.remove()}}}},handleOneLayoutrule:function(e,t,a,i){var r=a.component.data.dataBind,o=e.getData("isWizard");o&&!r.Owner&&(r.Owner=5678);var n=e.data.currentInstObjKey,s=[];let l=r&&"draft"===r.$state?"create":i;t&&t.forEach((function(t){if(!(t.screen&&a&&a.component.data.activeScreen&&t.screen.id!==a.component.data.activeScreen.id)){if(t.screen&&a&&!a.component.data.activeScreen&&t.screen.id){let e=a.component.data.screenHistory;if(e&&e.length){let a="draft"===r.$state?e[e.length-1].id:e[0].id;if(t.screen.id!==a)return}}o&&t.execute_on&&"create_edit"!==t.execute_on&&t.execute_on!==l||(t.actions&&t.actions.length&&s.push(t.actions),e.handleOneLayoutruleQuery(e,t,r,a,i))}})),o&&5678===r.Owner&&delete r.Owner;var d=s&&s.length?s.length:0;if(d)for(var c=0;c<d;c++)for(var u=s[c],m=s[c].length,p=0;p<m;p++){var f=u[p];validationUtils.isNotEmpty(f)&&("Mandatory_Fields"===f.type?y(1,f.fields):"Show_Fields"===f.type?y(2,f.fields):"Show_Sections"===f.type?_(f.sections):"Show_Text_Component"===f.type||"Show_Widget"===f.type?f.segments.forEach((function(e){delete store.peekRecord("wizard-segment",e.id).showByCRPassed})):"Set_Lock"===f.type&&f.fields.forEach((function(e){store.peekRecord("field",e.id).hasOwnProperty("isLockedByCR")&&(store.peekRecord("field",e.id).isLockedByCR=!1)})))}function _(t){var r=e.getData("moduleSections");r=r||[],(t=t||[]).forEach((function(t){var o=r.filter((function(e){if(e.name==t)return e}));(o=o&&o[0]?o[0]:void 0)&&(o.fields||[]).forEach((function(t){!t.required||t.visible&&t.view_type[i]&&!t.read_only||e.revertMandatoryForHiddenField(a,t)}))}))}function y(t,r){var o=e.getData("moduleData.fields").filter((function(e){return r.filter((function(t){return t.id==e.id})).length}));o.length&&o.forEach((function(r){r[n].isCurrentFieldHiddenInLR&&(r[n].ShowFldsValidatedAndPassed||e.handleCurrentFieldInLR(r,a,i),delete r[n].isCurrentFieldHiddenInLR),1===t?(r[n].MandFldsValidatedAndPassed=!1,delete r[n].clearedRecordError):r[n].ShowFldsValidatedAndPassed=!1,!r.required||r.visible&&r.view_type[i]&&!r.read_only||e.revertMandatoryForHiddenField(a,r)}))}},revertMandatoryForHiddenField:function(e,t){var a=e.component.data.dataBind,i=a.$.model.fieldList[t.api_name];i&&i.mandatory&&(i.mandatory=!1,store.addField(a.$.model._name,t.api_name,i.type,i))},handleOneLayoutruleQuery:function(e,t,a,i,r){var o=t.criteria;if(t.actions&&t.actions.length){var n=e.checkCriteriaMatch(o,a,void 0,void 0,e,void 0,void 0,void 0,!0);void 0===n&&(n=!1),e.triggerLayoutruleActions(e,t,a,n,i,r)}},handleCurrentFieldInLR:function(e,t,a){var i,r,o=e.api_name,n=this.data.currentInstObjKey;if(this.getData("moduleSections").filter((function(t){(t&&t[n]&&"used"===t[n].type||t.screen)&&t.fields&&t.fields.some((function(a){if(a.id===e.id)return i=a,r=t,a}))})),i){var s=i,l=t.component.data.dataBind,d=r||void 0,c=t.component,u=JSON.parse(JSON.stringify(i.view_type));u[a]=!1,i[n].isHiddenInLayoutRules=!0,Lyte.Component.set(i,"view_type",u),d&&!d.isSubformSection&&this.hideEmptySection(d),this.toggleMandatoryInRecord(!1,l,o,s),c.setData("skipMandatory",!0)}},triggerLayoutruleActions:function(e,t,a,i,r,o){var n=e.data.currentInstObjKey,s=e.data.moduleData;t.actions&&t.actions.forEach((function(t){if(!s[n].skipValidationForlayoutRuleCase||s[n].skipValidationForlayoutRuleCase[t.type])switch(t.type){case"Show_Fields":case"Mandatory_Fields":t.fields&&t.fields.forEach((function(n){e.handleLayoutruleActions(t.type,t,n,a,e,i,r,o)}));break;case"Show_Buttons":if(t.buttons){var l=t.buttons[0];if(!(m=document.querySelector("crm-create-wizard-buttons"))||!m.component)break;for(var d=(p=m.component.data.buttons).length,c=0;c<d;c++){var u=p[c];document.querySelector("[data-button-id="+CSS.escape(u.id)+"]")&&l===u.id&&(Lyte.objectUtils(u,"add","fromCR",!0),i?u.$.set({isCRHide:!0,hide:!0}):u.$.set({isCRHide:!1,hide:!1}))}}break;case"Enable_Buttons":if(t.buttons){var m;l=t.buttons[0];if(!(m=document.querySelector("crm-create-wizard-buttons"))||!m.component)break;var p;for(d=(p=m.component.data.buttons).length,c=0;c<d;c++){l==(u=p[c]).id&&(Lyte.objectUtils(u,"add","fromCR",!0),i?u.$.set("disable",!0):u.$.set("disable",!1))}}break;case"Show_Sections":t.sections&&t.sections.forEach((function(t){var o=e.getData("moduleSections").filter((function(e){if(e.name==t)return e}));if((o=o&&o[0]?o[0]:void 0)&&!o.isSubformSection){if(!i&&o[n].isValidSectionByLayoutRule)return;var s=o.fields;i?!1===o[n].isvalidSection&&Lyte.Component.set(o[n],"isvalidSection",!0):Lyte.Component.set(o[n],"isvalidSection",!1),s.forEach((function(t){var o=t.api_name;"EMAIL"===t.column_name&&"Cases"===r.getData("moduleData.module_name")&&e.checkEmailforCaseOrigin(a,a.Case_Origin),i?e.toggleMandatoryInRecord(!0,a,o,t):e.toggleMandatoryInRecord(!1,a,o,t)})),i&&o&&!o.isSubformSection&&!1===o[n].haveValidFields&&Lyte.Component.set(o[n],"isvalidSection",!1),o[n].isValidSectionByLayoutRule=!!i,o[n].hiddenbyLR=!i}}));break;case"Show_Subforms":t.subforms&&t.subforms.forEach((function(t){var a=e.getData("moduleSections").filter((function(e){if(e.subform_apiname===t&&(e.isSubformSection||e.screen))return e}));if(a=a&&a[0]?a[0]:void 0){if(!i&&a[n].isValidSectionByLayoutRule)return;let r=a.fields.find((e=>"subform"===e.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===e.data_type)),o=r[n]&&r[n].aggFields||[];i?a[n].isvalidSection||(Lyte.Component.set(a[n],"isvalidSection",!0),r[n]&&(r[n].isHiddenInLayoutRules=!1,o.forEach((e=>{e[n].isHiddenInLayoutRules=!1})))):(Lyte.Component.set(a[n],"isvalidSection",!1),r[n]&&(r[n].isHiddenInLayoutRules=!0,o.forEach((e=>{e[n].isHiddenInLayoutRules=!0})))),e.toggleMandatoryInSubformRecord(e,t,a.fields,i),a[n].isValidSectionByLayoutRule=!!i}}));break;case"Show_Text_Component":var f=t.segments,_=f.length;for(let e=0;e<_;e++){const t=f[e].id,a=store.peekRecord("wizard-segment",t);a&&(i?a.$.set("hide",!1):a.$.set("hide",!0))}break;case"Show_Widget":var y=t.segments,g=y.length;for(c=0;c<g;c++){var v=y[c].id;const e=store.peekRecord("wizard-segment",v);i||e.showByCRPassed?i&&(e.showByCRPassed=!0,$L("#"+v).removeClass("dN")):$L("#"+v).addClass("dN")}break;case"Set_Lock":t.fields.forEach((function(t){var r,o=Crm.userDetails.PROFILE_ID;if("team_based"===s.access_type&&(o=s.private_profile.id),e.getData("moduleSections").filter((function(e){(e&&e[n]&&e[n].type&&"used"===e[n].type||e.screen)&&e.fields&&e.fields.some((function(e){if(e.id===t.id)return r=e,e}))})),void 0===r&&(r=store.peekRecord("field",t.id)),!r.disabledElement&&r.view_type&&(r.hasOwnProperty("isLockedByCR")||!r.read_only))if(i&&r.read_only&&(r.isLockedByCR=!0,Lyte.Mixin.get("crm-create-mixin").lockedbyCR.add(r.id)),!r||r.read_only&&!r[n].isCscriptReadOnly){if(r&&!r.isLockedByCR&&!i){if(r[n].isReadOnlyByRules=i,r[n].isCscriptReadOnly)return;if(Lyte.Component.set(r,"read_only",!1),Lyte.Component.set(r,"isLockedByCR",!1),!0===r.required){const e=r.api_name,t=a.$.model.fieldList[e];t.mandatory=!0,store.addField(a.$.model._name,e,t.type,t)}}}else{t._exempted_profiles||(t._exempted_profiles=[]);var l=t._exempted_profiles;window.clientPortalName&&(l=t._exempted_portal_user_types),l||(l=[]);var d=!1;l.forEach((function(e){e.id===o&&(d=!0)})),!d&&i&&(r[n].isReadOnlyByRules=i,Lyte.Component.set(r,"read_only",!0),r.isLockedByCR=!0,Lyte.Mixin.get("crm-create-mixin").lockedbyCR.add(r.id),e.clearUIError())}}));break;case"Set_Value":var h=[CrmField.UITYPES.CURRENCY,CrmField.UITYPES.CURRENCY_ROUND_UP,CrmField.UITYPES.CURRENCY_ROUND_DOWN,CrmField.UITYPES.CURRENCY_ROUND_OFF,CrmField.UITYPES.DECIMAL,CrmField.UITYPES.PERCENT,CrmField.UITYPES.NUMERIC_FIELD];const D=r.component.data,b=r.component;t.fields.forEach((function(t){var r=store.peekRecord("field",t.id);if(r){var o=t._value;if(i&&!r.read_only){if(r.$.set("isWizardCRSetValue",!0),null==o||""===o)return void b.clearFieldValueInWizard(r,b);if("multiselectpicklist"===r.data_type){for(var n=o,s=n.length,l="[",d=0;d<s;d++)l=l+'"'+n[d]+'"',d!==s-1&&(l+=",");o=l+="]"}else if(h.includes(r.ui_type)&&t._value){if(36===r.ui_type||143===r.ui_type||144===r.ui_type||145===r.ui_type){var c=r.length;if(c<o.replace(".","").length)-1!==o.slice(0,c).indexOf(".")&&(c+=1),o=o.slice(0,c);if(-1!==o.indexOf(".")){const e=o.split("."),t=e[1].slice(0,r.decimal_place);0===t.length?o=e[0]:t.length>0&&(o=e[0]+"."+t)}}o=Number(o)}else"datetime"===r.data_type?(o=o.replace(/[+-]\d{2}:\d{2}/,""),o=e.getDateTimeForForm($L.moment(o).toDate(),!0)):"boolean"===r.data_type?o="true"===o:"date"===r.data_type&&(o=o.replace(/[+-]\d{2}:\d{2}/,""),o=CrmDateUtils.convertDateToUserPattern(CrmDateUtils.getDateObjectFromString(o,"YYYY-MM-DD")));let i=r.api_name;var u=a[i];if(!u){let e=Lyte.deepCopyObject(a.$.error)[i];e&&(u=e.value)}var m=!1;o&&!u&&i in a&&(m=!0),a.$.set(r.api_name,o);var p={apiName:r.api_name,fieldId:r.id,columnName:r.column_name},f=[];f.push(p);var _={[r.data_type]:f},y="crm-create-fields#"+D.moduleData.module_name+"_fldRow_"+r.column_name;if("picklist"===r.data_type&&!0===r.enable_colour_code){var g=$L(y)[0].component.data.moduledataUicomp;if("-None-"===o)g.$.set("pkcolor_enabled_class","colorEnabledPicklist colorEnabledPKNone");else{for(var v=r.pick_list_values,L=v.length,C=0;C<L;C++){var I=v[C];if(I.actual_value===o){g.$.set("color_code",I.colour_code);break}}g.$.set("pkcolor_enabled_class","colorEnabledPicklist")}}if("boolean"===r.data_type&&(o=o.toString(),u=u.toString()),o&&u&&o!==u||m){var E="yellowLyteInput";110===r.ui_type?E="yellowLyteTextArea":2===r.ui_type||100===r.ui_type?E="yellowPickList":301===r.ui_type&&(E="yellowCheckBox"),$L(y).addClass(E),setTimeout((function(){$L(y).removeClass(E)}),4e3)}if("picklist"===r.data_type||"datetime"===r.data_type){var R=$L(y)[0];if(R){if("picklist"===r.data_type){var S=r.pick_list_values.find((e=>e.display_value==t._value)),F=R.component.data.initialPicklistdata;if(F&&S)F.some((e=>e.id==S.id||e.actual_value==S.actual_value))||F.push(S)}R.component.handleEntityRecordChanges(_,a),"picklist"===r.data_type&&R.getMethods("getDropdownvalue")&&R.component.executeMethod("getDropdownvalue",{},o,!0,!0)}}}else r.$.set("isWizardCRSetValue",!1)}}))}}))},handleLayoutruleActions:function(e,t,a,i,r,o,n,s){var l,d,c=a.api_name,u=this.data.currentInstObjKey;this.getData("moduleSections").filter((function(e){(e&&e[u]&&e[u].type&&"used"===e[u].type||e.screen)&&e.fields&&e.fields.some((function(t){if(t.id==a.id)return l=t,d=e,t}))}));var m=d||void 0;if(l){if(l.disabledElement||!l.view_type)return;var p=l;switch(e){case"Mandatory_Fields":if(p[u].isLayoutMandatory)return;const e=p[u].isCscriptMandatory,t=m[u].isvalidSection;if(o==p.required&&!e||!p.visible||!t&&o||l[u].MandFldsValidatedAndPassed)o&&(l[u].MandFldsValidatedAndPassed=o,validationUtils.isNotEmpty(l[u].clearedRecordError)&&Lyte.Component.set(p[u],"errorDetails",l[u].clearedRecordError));else{if(p[u].isMandateByRules=o,p[u].isCscriptMandatory)return;var f=i.$.model.fieldList[c];if(l[u].MandFldsValidatedAndPassed=o,f.mandatory=o,f.mandatory&&!f.validation&&(f.validation="emptyValueValidation"),store.addField(i.$.model._name,c,f.type,f),Lyte.Component.set(p,"required",o),"picklist"==p.data_type&&(o?"-None-"==i[c]&&Lyte.Component.set(i,c,""):("-None-"==i[c]?(Lyte.Component.set(i,c,"1"),Lyte.Component.set(i,c,"-None-")):i[c]||"STAGE"===f.columnName||Lyte.Component.set(i,c,"-None-"),store.addField(i.$.model._name,c,f.type,f),Lyte.Component.set(p,"required",o),"picklist"==p.data_type&&(o?"-None-"===i[c]&&Lyte.Component.set(i,c,""):"-None-"==i[c]?(Lyte.Component.set(i,c,"1"),Lyte.Component.set(i,c,"-None-")):i[c]||"STAGE"===f.columnName||Lyte.Component.set(i,c,"-None-")),!o&&validationUtils.isNotEmpty(p[u].errorDetails)&&"ERR02"===p[u].errorDetails.code&&(l[u].clearedRecordError=Lyte.deepCopyObject(p[u].errorDetails),Lyte.Component.set(p[u],"errorDetails",{})),o&&validationUtils.isNotEmpty(l[u].clearedRecordError)&&Lyte.Component.set(p[u],"errorDetails",l[u].clearedRecordError),p[u].isCscriptHidden&&Lyte.Component.set(p[u],"isCscriptHidden",!1))),!o&&validationUtils.isNotEmpty(p[u].errorDetails)&&"ERR02"===p[u].errorDetails.code&&(l[u].clearedRecordError=Lyte.deepCopyObject(p[u].errorDetails),Lyte.Component.set(p[u],"errorDetails",{})),o&&validationUtils.isNotEmpty(l[u].clearedRecordError)&&Lyte.Component.set(p[u],"errorDetails",l[u].clearedRecordError),d[u].showMandatory){Lyte.Component.set(p[u],"isHiddenViaAccesiblity",!o),d[u]&&p.required&&Lyte.Component.set(d[u],"isCustomHidden",!o),p.required||r.hideEmptySection(m,"accessibility");var _=$L("crm-create-layout")[0];Lyte.Component.set(_.getData("messageBox"),"showWarning",!0)}}break;case"Show_Fields":if(o&&l.view_type[s]&&(l[u].ShowFldsValidatedAndPassed=!0),o!=l.view_type[s]){var y=JSON.parse(JSON.stringify(l.view_type)),g=n.component;if(o){if(y[s]=!0,l[u].isHiddenInLayoutRules=!1,l[u].ShowFldsValidatedAndPassed=!0,l[u].disableLyteViewPortForField=!0,l.required&&(l[u].isHiddenViaAccesiblity=!1),d[u].showMandatory){_=$L("crm-create-layout")[0];Lyte.Component.set(_.getData("messageBox"),"showWarning",!0)}Lyte.Component.set(l,"view_type",y),"EMAIL"===l.column_name&&"Cases"===g.data.moduleData.module_name&&r.checkEmailforCaseOrigin(i,i.Case_Origin);var v=r.haveValidFldsinSection(m,l.api_name);!m||m[u].isvalidSection||v||m[u].hiddenbyLR||!m[u].haveValidFields||Lyte.Component.set(m[u],"isvalidSection",!0),r.toggleMandatoryInRecord(!0,i,c,p),g.setData("skipMandatory",!1)}else if(!l[u].ShowFldsValidatedAndPassed){if(r.data.apiName===l.api_name&&"lookup"===l.data_type)return l[u].isCurrentFieldHiddenInLR=!0,void(l.view_type[s]=!1);y[s]=!1,l[u].isHiddenInLayoutRules=!0,Lyte.Component.set(l,"view_type",y),"EMAIL"===l.column_name&&"Cases"===g.data.moduleData.module_name&&r.checkEmailforCaseOrigin(i,i.Case_Origin),m&&!m.isSubformSection&&r.hideEmptySection(m),r.toggleMandatoryInRecord(!1,i,c,p),g.setData("skipMandatory",!0)}}}}},processLayoutRules:function(){var e,t,a,i=this,r=this.data.currentInstObjKey,o=this.getData("dataBind");if(o.$.model){var n=store.peekRecord("module",o.$.model._name),s="crm-create-layout#"+n.module_name+"LC_layoutNode",l=$L(s)[0];if(l&&(e=l.component.data.layoutRules,t=l.component.data.selectedLayoutid,a=l.component.data.moduleSections),t&&l.component.data.isWizard&&(t=t.split(";")[0]),e){var d=i.getViewTypeInfo();Lyte.Mixin.get("crm-create-mixin").lockedbyCR=new Set,e.forEach((function(e){if((e.layout.id?e.layout.id:e.layout)==t){var a=i.getData("moduleData.fields").filter((function(t){return t.id==e.primary_field.id}))[0];if(!!(i&&i.data&&i.data.globalData&&("quickCreate"===i.data.globalData.formType&&"quick_create"===i.data.globalData.currentViewType||i.data.globalData.injectSections))&&i.data.globalData.moduleSections&&i.data.globalData.currentInstObjKey){for(var o=[],n=i.data.globalData.moduleSections,s=i.data.globalData.currentInstObjKey,c=0,u=n.length;c<u;c++)"used"===n[c][s].type&&n[c][s].isvalidSection&&(o=o.concat(n[c].fields));a=o.filter((function(t){return t.id===e.primary_field.id}))[0]}(l&&l.component.data.isWizard||a&&a.visible&&(a.view_type[d]||a[r].isHiddenInLayoutRules||a[r].quickCreatePrimaryField))&&i.handleOneLayoutrule(i,e.queries,l,d)}}));var c=this&&this.getData("globalData");!(c&&c.isThroughQc&&"quickCreate"===c.formType)&&a&&a.length&&(this.data.moduleData[r].createTabIndex=1,a.forEach(function(e){e[r]&&delete e[r].isValidSectionByLayoutRule,e[r]&&e[r].isvalidSection&&this.setTabIndexForFields(this.data.moduleData,e,d,void 0,void 0,!0,void 0,e[r].groupIndex)}.bind(this)))}this.getMethods("processCustomLayoutRules")&&this.executeMethod("processCustomLayoutRules"),this.processAfterLayoutRulesExecution(n.module_name,l)}},processAfterLayoutRulesExecution:function(e,t){if(t){var a=t.component.data.quickCreateDataObj;if(!!a&&!!a.isQuickCreate){var i=a.viewType?a.viewType:"modal",r="."+t.component.data.currentInstObjKey+"qcPopupComponent",o=$L(r,t);"popover"===i&&o&&o[0]&&o[0].alignPopover&&o[0].alignPopover()}}t&&(t.component.data.quickCreateDataObj.isQuickCreate&&"outlet"!==(i=a.viewType?a.viewType:"modal")&&this.updateScrollShadowForQc(e,t))},updateScrollShadowForQc:function(e,t,a){var i;a||(i=t?"crm-create-layout#"+e+"LC_layoutNode":"crm-create-layout#"+e+"LC_layoutNode."+t,a=(a=$L(i))[0]);if(a){var r=$L("#crmQuickCreateSetup",a);r&&r[0]&&r[0].updateScrollShadow()}},deserializeData:function(e,t,a,i,r){if("string"===r&&e?e=e.toString():!e||isNaN(e)||"integer"!==r&&"double"!==r?"boolean"===r&&(e=!!e):e=Number(e),!e||"multi-picklist"==t||"tax"==t||"phone"==t){if("multi-picklist"!=t&&"tax"!=t)return"time-in-hrs"==t?0===e?"0":e:"time-in-minutes"==t&&0===e?"0":e;if("string"==typeof e)return-1!=e.indexOf("; ")?JSON.stringify(e.split("; ").filter((function(e){if(e)return e}))):e?JSON.stringify(e.split().filter((function(e){if(e)return e}))):e;if(!e)return JSON.stringify([]);if(!e.length)return JSON.stringify(e);if("string"==typeof e[0])return JSON.stringify(e.filter((function(e){if(e)return e})));if("object"==typeof e[0]){var o=e.map((function(e){return e.value}));return JSON.stringify(o.filter((function(e){if(e)return e})))}}if("date"==t)return e=e.replace(/[+-]\d{2}:\d{2}/,""),CrmDateUtils.convertDateToUserPattern(CrmDateUtils.getDateObjectFromString(e,"YYYY-MM-DD"));if("datetime"==t)return e=e.replace(/[+-]\d{2}:\d{2}/,""),this.getDateTimeForForm(new Date(e),!0);if("relation"==t&&"hasMany"==a.relType&&e.length>0){for(var n=i.model?i.model.fieldList:{},s=e.length,l=0;l<s;l++)for(var d in n=validationUtils.isEmpty(n)?i[l].$.model.fieldList:n)"date"!=n[d].type&&"datetime"!=n[d].type&&"phone"!=n[d].type&&"multi-picklist"!=n[d].type&&"tax"!=n[d].type&&"time-in-hrs"!==n[d].type&&"time-in-minutes"!==n[d].type||e[l].hasOwnProperty(d)&&(i[l][d]=this.deserializeData(e[l][d],n[d].type,n[d]));return i}if("time-in-hrs"==t){if(e)return Lyte.registeredMixins["crm-services-mixin"].methods.convertDurationTimeDoubleToUserFormat(e);if(0===e)return"0"}else if("time-in-minutes"==t){if(e)return Utils.convertTimeInDoubleToReadableForm(e);if(0===e)return"0"}return e},getDateTimeForForm:function(e,t){var a=Utils.getDateInUserDatePattern(e);if("HH:mm"==Crm.userDetails.TIME_FORMAT)return a+"TV"+(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes());var i=Utils.convertTo12HoursFormatTimeObj(e,t);return a+"TV"+i.hrs+":"+i.mins+" "+I18n.getMsg(i.meridiem)},replaveValueInExp:function(e,t,a,i,r,o){e=e||i.formulaObj.expression;e=crmFormulaInit.prototype.removeWhiteSpaces(e);for(var n=!1,s=!1,l=r.length,d=[32,34,36,38,39,40,52,77,143,144,145,117],c=0;c<l;c++){var u=t[r[c]];validationUtils.isNotEmpty(t.$.error[r[c]])&&(u="ERR02"===t.$.error[r[c]].code||"ERR03"===t.$.error[r[c]].code?u:t.$.error[r[c]].value);var m=t.$.model.fieldList[r[c]],p=m?store.peekRecord("field",m.fieldID):void 0;if(u=void 0===u&&p&&p.default_value?p.default_value:u,m&&"picklist"===m.fieldType)if("-None-"===u)u="";else if(p&&p.pick_list_values)for(var f=p.pick_list_values.length,_=0;_<f;_++)if(p.pick_list_values[_].display_value===u){u=p.pick_list_values[_].reference_value;break}if((u=m&&"number"==m.type&&isNaN(u)?"":u)&&"string"==typeof u&&u.length>0){if(m&&"datetime"==m.fieldType){var y=u.split("TV"),g=new CrmDate(CrmDateUtils.getDateObjectFromString(y[0]));u=i&&i.formulaObj&&!i.formulaObj.assume_default?"Invalid Date"!==String(g.dateObject)?g.getDateInPattern("MMM D,YYYY")+" "+y[1]:"":g.getDateInPattern("MMM D,YYYY")+" "+y[1]}else if(m&&"date"==m.fieldType){g=new CrmDate(CrmDateUtils.getDateObjectFromString(u));u=$L.moment(g.primitiveDateObject).format("MMM D,YYYY")}else m&&"multiselectpicklist"===m.fieldType&&-1!==u.indexOf("[")&&(u=JSON.parse(u).join(";"));u=u.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/,/g,"\\,")}if(u&&"object"==typeof u&&m&&"lookup"!=m.fieldType&&(u=(u=u.name?u.name:u.full_name?u.full_name:"")?u.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/,/g,"\\,"):""),m&&"lookup"==m.fieldType&&(u=(u=a&&r[c]===o?a:validationUtils.isNotEmpty(u)?u.name:"")?u.replace(/'/g,"\\'").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/,/g,"\\,"):""),i&&i.formulaObj&&!i.formulaObj.assume_default){var v=["*","/","%","^"];u?(e=e.replace("${"+r[c]+"}",u),n=!0):(m||"_NO_VALID_FIELDS"===r[c])&&(e=""!==(u=null==u?"":u)||"-"!==e.charAt(e.indexOf("${"+r[c]+"}")-1)&&"+"!==e.charAt(e.indexOf("${"+r[c]+"}")-1)?""===u&&(v.contains(e.charAt(e.indexOf("${"+r[c]+"}")-1))||0===e.indexOf("${"+r[c]+"}")&&v.contains(e.charAt(("${"+r[c]+"}").length)))?e.replace("${"+r[c]+"}",null):e.replace("${"+r[c]+"}",u):"/"===e.charAt(e.indexOf("${"+r[c]+"}")+("${"+r[c]+"}").length)||"*"===e.charAt(e.indexOf("${"+r[c]+"}")+("${"+r[c]+"}").length)||"%"===e.charAt(e.indexOf("${"+r[c]+"}")+("${"+r[c]+"}").length)||"^"===e.charAt(e.indexOf("${"+r[c]+"}")+("${"+r[c]+"}").length)?e.replace("${"+r[c]+"}",null):e.replace(e.charAt(e.indexOf("${"+r[c]+"}")-1)+"${"+r[c]+"}",u),n=!0)}else u||m&&301===m.uiType?(e=e.replace("${"+r[c]+"}",u),n=!0):(m&&"datetime"!==m.fieldType&&"date"!==m.fieldType||"_NO_VALID_FIELDS"===r[c])&&(u=m&&$L.inArray(m.uiType,d)>=0?0:"",e=e.replace("${"+r[c]+"}",u),n=!0);p&&!p.visible&&(s=!0)}return{exp:e,isValidExp:n,isInvisibileFldInvolved:s}},formulaWorkerExecution:function(e,t,a,i,r,o){(!0===Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.SUBFORM_PERMISSIONS)&&objectUtils.getKeys(a.$.error).forEach((function(e){a[e]=a.$.error[e].value}));var n={DATE_PATTERN:Crm.userDetails.DATE_PATTERN,lineItemFormulaCalcFlow:Crm.userDetails.lineItemFormulaCalcFlow,LOCALE:Crm.userDetails.LOCALE,TIME_FORMAT:Crm.userDetails.TIME_FORMAT,TIME_ZONE:Crm.userDetails.TIME_ZONE,am:I18n.getMsg("AM"),pm:I18n.getMsg("PM")},s=t.api_name,l=t&&t.$?t.$.toJSON():t;l.section=[{generated_type:t.section&&t.section[0]?t.section[0].generated_type:void 0}];for(var d=e?e.length:0,c=0;c<d;c++)if(e[c].fieldsInvolved.contains(s)||e[c].fieldsInvolved.contains("_NO_VALID_FIELDS")||r||Crm.userDetails.DYNAMIC_FORMULA_ENABLED&&e[c].formulaObj.stop_compute_conditionally&&(e[c].fieldsInvolvedInSCE.contains(s)||e[c].fieldsInvolvedInSCE.contains("_NO_VALID_FIELDS"))){var u=this.replaveValueInExp(e[c].formulaObj.expression,a,i,e[c],e[c].fieldsInvolved);if(Crm.userDetails.DYNAMIC_FORMULA_ENABLED&&e[c].formulaObj.stop_compute_conditionally){var m=this.replaveValueInExp(e[c].formulaObj.stop_compute_expression,a,i,e[c],e[c].fieldsInvolvedInSCE,o),p="true";m.isValidExp&&!m.isInvisibileFldInvolved&&(p=m.exp)}var f=e[c].formulaApiname,_="",y=!1;if(e[c].formulaObj.stop_compute_conditionally){var g=this.getData("indexVal");if(void 0!==g)if(_="crm-create-subformfields#"+this.getData("moduleName")+"_"+this.getData("apiName")+"_R"+(g+1)+"_"+f,$L(_)&&$L(_)[0]){var v=$L(_)[0].getData();y=!!v.hasOwnProperty("dbValueCondition")&&v.dbValueCondition}}u.isValidExp&&!u.isInvisibileFldInvolved&&crmFormulaInit.prototype.createLFormulaWorker.postMessage({toConvert:u.exp,stopComputeExpression:p,userDetails:n,fromLyteC:{sourcefieldData:l,sourceRecord:a.$.toJSON(),fldData:e[c],sourceRecordKeys:{id:a.id,model:a.$.model._name}},validateStopCondition:a.$.isNew||y,formulaDomId:_}),this.formulaWorkerHandler()}},formulaWorkerHandler:function(){crmFormulaInit.prototype.createLFormulaWorker.onmessage=function(e){if(e.data.isAggregate){if((n=store.peekRecord(e.data.recData.model,e.data.recData.id)).$.set(e.data.aggregateField,e.data.resFromFormulaWorker),e.data.aggregateField){var t=e.data.componentData;t.clonedRecord=n,O=e.data.aggregateField,(w=(k=t).moduleFormulafields)&&w.length&&w.length&&Lyte.registeredMixins["crm-create-mixin"].formulaWorkerExecution(w,{api_name:O},k.clonedRecord)}}else if(e.data.fromBulkAddition){var a=e.data.currentRecMeta?e.data.currentRecMeta:void 0;if(a){for(var i=a._currEntityRec,r=a._fromTaxFldCal,o=a._autoPopulateTax,n=store.peekRecord(a.model_name,i.id),s=a.processedFormulaFields,l=s.length,d=a.formulaApiNameVsFormulaObj,c=a.generated_type,u=0;u<l;u++){var m=s[u],p=d[m],f=i[m];if((L=p.formulaObj)&&("datetime"==L.return_type||"date"==L.return_type)){var _=i[m];if(L.assume_default){y=_.split(" ")[0];_=y&&!Utils.isValidDate(Crm.userDetails.DATE_PATTERN,y)?$L.moment(_).toDate():$L.moment(Utils.convertUsrtoDefaultDatePattern(_)).toDate(),f=_="date"==L.return_type?Utils.getDateInUserDatePattern(_,!1):Utils.getDateTimeInUserFormat(_,!0,"false")}else if(""!==_){var y=_.split(" ")[0];_=y&&!Utils.isValidDate(Crm.userDetails.DATE_PATTERN,y)?new Date(_):new Date(Utils.convertUsrtoDefaultDatePattern(_)),f=_="date"==L.return_type?Utils.getDateInUserDatePattern(_,!1):Utils.getDateTimeInUserFormat(_,!0,"false")}else f=""}if(L&&L.expression.startsWith("Datepart"))try{f=_=i[m]}catch(e){murphy.error(e)}switch(f="string"==typeof f&&f.trim()?f.trim():"",n.$.model.fieldList[m].type){case"number":f=isNaN(parseFloat(f))?void 0:parseFloat(f);break;case"boolean":if(["Quotes","SalesOrders","Invoices","PurchaseOrders"].contains(Crm.current__inventory__module)&&!f&&"custom"!==c&&(f="false"),p.formulaObj.assume_default){f="true"===f;break}f=""===f?void 0:"true"===f}if("currency"==(E=p.formulaObj.return_type)||"double"==E||"number"==E){var g=Math.pow(10,p.decimalPlace);if(f=Math.round((parseFloat(f)+Number.EPSILON)*g)/g,f=isNaN(f)?void 0:f,!isNaN(f)&&["Quotes","SalesOrders","Invoices","PurchaseOrders"].contains(Crm.current__inventory__module)){var v=n.$.model.fieldList[m].fieldID;if((F=store.peekRecord("field",v))&&(S=F.column_name,R=F.subform_api&&validationUtils.isNotEmpty(F.subform)),S&&Crm.userDetails.lineItemFormulaCalcFlow&&objectUtils.getKeys(Crm.userDetails.lineItemFormulaCalcFlow).length>0&&(R&&Crm.userDetails.lineItemFormulaCalcFlow[Crm.current__inventory__module].aggrFields[S]||!R&&Crm.userDetails.lineItemFormulaCalcFlow[Crm.current__inventory__module][S])){var h=Crm.current__inventory__RoundOffDetail;f=(Math.sign(parseFloat(f)*h.roundOffPrecision)*Math.round(Math.abs((parseFloat(f)*h.roundOffPrecision).toFixed(h.roundOff)))/h.roundOffPrecision).toFixed(h.roundOff),f=isNaN(f)?void 0:parseFloat(f)}}}p.formulaObj.assume_default&&void 0===f||n.$.set(m,f)}if(o&&!r){var D={},b=a.componentData;if(!b)return;D._rec=n,D.taxFieldMeta=b.taxFieldMeta,D.selectedTaxArr=b.selectedTaxArr,Lyte.registeredMixins["crm-create-mixin"].getTaxValue(D),crmFormulaInit.prototype.createLFormulaWorker.postMessage({fromLyteC:{fromBulkAddition:"true",data:{curSelectedBulkRecs:a.curSelectedBulkRecs,currEntityRec:n.$.toJSON(),visibleFormulaFields:b.visibleFormulaFields,formulaFldIdVsMetaKeys:b.formulaFldIdVsMetaKeys,formulaFldIdVsMeta:b.formulaFldIdVsMeta,_selectedLookupVal:b._selectedLookupVal,decimalFldDataTypeArr:b.decimalFldDataTypeArr,userDetails:b.userDetails,model_name:b.model_name,autoPopulateTax:!0,_fromTaxFldCal:!0}}})}else Lyte.registeredMixins["crm-bulklookup-mixin"].bulkRecCount++;n&&a&&Lyte.registeredMixins["crm-bulklookup-mixin"].bulkRecCount===a.curSelectedBulkRecs&&Lyte.Component.set(n,"show",!0)}}else{var L,C=e.data.fromLyteC;if(e.data.hasOwnProperty("dbValueCondition")){var I=$L(e.data.formulaDomId)[0].getData();I.hasOwnProperty("dbValueCondition")||(I.dbValueCondition=e.data.dbValueCondition)}if((L=C?C.fldData.formulaObj:void 0)&&("datetime"==L.return_type||"date"==L.return_type)){_=e.data.resFromFormulaWorker;if(L.assume_default){y=_.split(" ")[0];_=y&&!Utils.isValidDate(Crm.userDetails.DATE_PATTERN,y)?$L.moment(_).toDate():$L.moment(Utils.convertUsrtoDefaultDatePattern(_)).toDate(),_="date"==L.return_type?Utils.getDateInUserDatePattern(_,!1):Utils.getDateTimeInUserFormat(_,!0,"false"),e.data.resFromFormulaWorker=_}else if(""!==_){var y=_.split(" ")[0];_=y&&!Utils.isValidDate(Crm.userDetails.DATE_PATTERN,y)?new Date(_):new Date(Utils.convertUsrtoDefaultDatePattern(_)),_="date"==L.return_type?Utils.getDateInUserDatePattern(_,!1):Utils.getDateTimeInUserFormat(_,!0,"false"),e.data.resFromFormulaWorker=_}else e.data.resFromFormulaWorker=""}if(L&&L.expression.startsWith("Datepart"))try{_=e.data.resFromFormulaWorker;e.data.resFromFormulaWorker=_}catch(e){murphy.error(e)}if(!C)return;if((n=store.peekRecord(C.sourceRecordKeys.model,C.sourceRecordKeys.id))&&n.$.model.fieldList[C.fldData.formulaApiname]){var E;switch(f="string"==typeof(f=e.data.resFromFormulaWorker)&&f.trim()?f.trim():"",n.$.model.fieldList[C.fldData.formulaApiname].type){case"number":f=isNaN(parseFloat(f))?void 0:parseFloat(f);break;case"boolean":if(["Quotes","SalesOrders","Invoices","PurchaseOrders"].contains(Crm.current__inventory__module)&&!f&&C.sourcefieldData.section&&C.sourcefieldData.section[0]&&"custom"!==C.sourcefieldData.section[0].generated_type&&(f="false"),C.fldData.formulaObj.assume_default){f="true"===f;break}f=""===f?void 0:"true"===f}if("currency"==(E=C.fldData.formulaObj.return_type)||"double"==E||"number"==E){g=Math.pow(10,C.fldData.decimalPlace);if(f=Math.round((parseFloat(f)+Number.EPSILON)*g)/g,f=isNaN(f)?void 0:f,!isNaN(f)&&["Quotes","SalesOrders","Invoices","PurchaseOrders"].contains(Crm.current__inventory__module)){var R,S,F;v=n.$.model.fieldList[C.fldData.formulaApiname].fieldID;if((F=store.peekRecord("field",v))&&(S=F.column_name,R=F.subform_api&&validationUtils.isNotEmpty(F.subform)),S&&Crm.userDetails.lineItemFormulaCalcFlow&&objectUtils.getKeys(Crm.userDetails.lineItemFormulaCalcFlow).length>0&&(R&&Crm.userDetails.lineItemFormulaCalcFlow[Crm.current__inventory__module].aggrFields[S]||!R&&Crm.userDetails.lineItemFormulaCalcFlow[Crm.current__inventory__module][S])){h=Crm.current__inventory__RoundOffDetail;f=(Math.sign(parseFloat(f)*h.roundOffPrecision)*Math.round(Math.abs((parseFloat(f)*h.roundOffPrecision).toFixed(h.roundOff)))/h.roundOffPrecision).toFixed(h.roundOff),f=isNaN(f)?void 0:parseFloat(f)}}}C.fldData.formulaObj.assume_default&&void 0===f||n.$.set(C.fldData.formulaApiname,f)}}var O,k,w}},getTaxValue:function(e){if(e){var t,a=e.selectedTaxArr,i=a.length||0,r=e._rec,o=0,n=e.taxFieldMeta,s=[];if(i){for(var l=0;l<i;l++){var d=a[l],c=0;if(d.isTaxConsidered&&(isNaN(d.taxPercent)||d.taxPercent>100||isNaN(parseFloat(d.taxPercent))))t=!0,Lyte.objectUtils(d,"add","displayTaxError",!0);else if(d.isTaxConsidered){Lyte.objectUtils(d,"add","displayTaxError",!1);var u=r.Total;u=isNaN(u)?0:u;var m=r.Discount;r.$&&r.$.error&&r.$.error.Discount&&(r.$.error.Discount.value||0===r.$.error.Discount.value&&!isNaN(r.$.error.Discount.value))&&(m=r.$.error.Discount.value);var p=m;p=isNaN(p)?0:p;c=(parseFloat(u)-parseFloat(p))*d.taxPercent/100;c=isNaN(c)?0:c;var f={name:d.taxLabel,percentage:Number(d.taxPercent),value:d.taxAmt};d.taxId?f.id=d.taxId:f.id=null,s.push(f)}o+=isNaN(c)?0:c}if(t)return Lyte.Component.set(e._rec,"Tax",0),!0;o=Lyte.registeredMixins["crm-create-mixin"].getRoundOff(n,o,{}),o=isNaN(o)?o:Number(o),r.$.set("Tax",o),r.$.set("Line_Tax",s)}}},getAggCrtDetails:function(e,t,a,i){if((a=a||{}).crtExp=a.crtExp?a.crtExp:"",a.valid=!1!==a.valid||!0!==a.valid||a.valid,a.fldsUsed=a.fldsUsed?a.fldsUsed:[],e.group)a.crtExp+=e.group_operator+"(",(a=this.getAggCrtDetails(e.group[0],t,a)).crtExp+=",",(a=this.getAggCrtDetails(e.group[1],t,a)).crtExp+=")";else{var r=e.field,o=r.api_name,n=t[r.api_name];n||(n=t[o=r.api_name.substr(0,r.api_name.lastIndexOf("."))]),o=o||r.api_name,(!i||i&&n)&&(a.crtExp=a.crtExp+this.getExpresstion(i?"${"+n.subFormName+"."+n.field_label+"}":"${"+o+"}",e.comparator,e.value,n?n.data_type:null)),a.fldsUsed.pushUniqValues(o||r.api_name),a.valid=a.valid&&t[o]&&t[o].visible}return a},getExpresstion:function(e,t,a,i){if("${EMPTY}"===a&&(t="equal"===t?"EMPTY":"NOTEMPTY"),"text"===i||"multiselectpicklist"===i){if(a="string"!=typeof a?"multiselectpicklist"!==i?a.map((e=>e.toLowerCase().trim())).join("*"):a.map((e=>e.toLowerCase())).join("*"):a.toLowerCase().trim(),"equal"===t)return"Contains(*]Lower("+e+"),"+a+")";if("not_equal"===t)return"Or(Not(Contains(*]Lower("+e+"),"+a+")),Len('"+e+"')==0)"}else{if("boolean"===i)return a?e:"Not("+e+")";if("datetime"===i)return this.getDTConstantsAsExp(a,e,t);if("date"===i)return this.getDTConstantsAsExp(a,e,t,!0);if("picklist"===i)return this.getPicklistCrtAsExp(a,e,t);if("userlookup"===i){if(a.name)a="${CURRENTUSER}"===a.name?[Crm.userDetails.USER_ID]:[a.id];else for(var r=a.length,o=0;o<r;o++){"${CURRENTUSER}"===a[o].name?a[o]=Crm.userDetails.USER_ID:a[o]=a[o].id}return"not_equal"===t?"Not(Contains([*"+a.join("*")+"*],*"+e+"*))":this.getPicklistCrtAsExp(a,e,t)}}switch(t){case"equal":default:return e+"=="+a;case"not_equal":return"Or("+e+"!="+a+",Len('"+e+"')==0)";case"less_than":return e+"<"+a;case"greater_than":return e+">"+a;case"less_equal":return e+"<="+a;case"greater_equal":return e+">="+a;case"between":return"And("+a[0]+"<="+e+","+e+"<="+a[1]+")";case"not_between":return"Or(Not(And("+a[0]+"<="+e+","+e+"<="+a[1]+")),Len('"+e+"')==0)";case"EMPTY":return"Len('"+e+"')==0";case"NOTEMPTY":return"Len('"+e+"')>0";case"contains":return"Contains(]*Lower("+e+"),"+a+")";case"not_contains":return"Or(Not(Contains(]*Lower("+e+"),"+a+")),Len('"+e+"')==0)";case"starts_with":return"Startswith(Lower("+e+"),"+a+")";case"ends_with":return"Endswith(Lower("+e+"),"+a+")"}},getDTConstantsAsExp:function(e,t,a,i){var r=$L.moment().timezone(Crm.userDetails.USER_TIME_ZONE),o=$L.moment().timezone(Crm.userDetails.USER_TIME_ZONE),n=$L.moment().timezone(Crm.userDetails.USER_TIME_ZONE),s=(f=$L.moment().toDate()).getFullYear(),l=f.getFullYear(),d=f.getFullYear(),c=f.getMonth(),u=Crm.userDetails.FISCAL_DETAILS.fiscalMonth,m=c-u;if("${PREVFY}"!==e&&"${THISFY}"!==e&&"${NEXTFY}"!==e||(c<u-1&&(l-=1),r=$L.moment(),o=$L.moment(),r.startOf("month"),r.set("month",Crm.userDetails.FISCAL_DETAILS.fiscalMonth-1),o.set("month",Crm.userDetails.FISCAL_DETAILS.fiscalMonth-1),o.subtract(1,"month").endOf("month")),"${PREVFQ}"===e||"${THISFQ}"===e||"${NEXTFQ}"===e){m=c-u;u>c&&(m=12-u+c,s-=1),c=u+3*Math.floor(m/3)-1,r=$L.moment(),o=$L.moment(),r.startOf("month"),r.set("fullYear",s),o.set("fullYear",s),o.endOf("month")}switch(e){case"${TODAY}":r.startOf("day"),o.endOf("day");break;case"${YESTERDAYMINUS}":return r.endOf("day").subtract(1,"day").endOf("day"),"Datecomp("+t+","+this.getFormatedDT(r,i)+")<=0";case"${YESTERDAY}":r.startOf("day").subtract(1,"day").startOf("day"),o.endOf("day").subtract(1,"day").endOf("day");break;case"${TOMORROW}":r.startOf("day").add(1,"day").startOf("day"),o.endOf("day").add(1,"day").endOf("day");break;case"${TOMORROWPLUS}":return r.startOf("day").add(1,"day").startOf("day"),"Datecomp("+this.getFormatedDT(r,i)+","+t+")<=0";case"${LASTMONTH}":r.startOf("month").subtract(1,"month").startOf("month"),o.endOf("month").subtract(1,"month").endOf("month");break;case"${THISMONTH}":r.startOf("month"),o.endOf("month");break;case"${NEXTMONTH}":r.startOf("month").add(1,"month").startOf("month"),o.endOf("month").add(1,"month").endOf("month");break;case"${LASTWEEK}":r.startOf("day").subtract((n.day()+n.weekLong.indexOf(Crm.userDetails.businessDetails.weekStartOn))%7+7,"day").startOf("day"),o.endOf("day").subtract((n.day()+n.weekLong.indexOf(Crm.userDetails.businessDetails.weekStartOn))%7+1,"day").endOf("day");break;case"${THISWEEK}":r.startOf("day").subtract((n.day()+n.weekLong.indexOf(Crm.userDetails.businessDetails.weekStartOn))%7,"day").startOf("day"),o.endOf("day").subtract((n.day()+n.weekLong.indexOf(Crm.userDetails.businessDetails.weekStartOn))%7-6,"day").endOf("day");break;case"${NEXTWEEK}":r.startOf("day").subtract((n.day()+n.weekLong.indexOf(Crm.userDetails.businessDetails.weekStartOn))%7-7,"day").startOf("day"),o.endOf("day").subtract((n.day()+n.weekLong.indexOf(Crm.userDetails.businessDetails.weekStartOn))%7-13,"day").endOf("day");break;case"${LASTYEAR}":r.startOf("year").subtract(1,"fullYear").startOf("year"),o.endOf("year").subtract(1,"fullYear").endOf("year");break;case"${THISYEAR}":r.startOf("year"),o.endOf("year");break;case"${NEXTYEAR}":r.startOf("year").add(1,"fullYear").startOf("year"),o.endOf("year").add(1,"fullYear").endOf("year");break;case"${PREVFY}":r.set("fullYear",l-1).startOf("month"),o.set("fullYear",d-1).endOf("month");break;case"${THISFY}":r.set("fullYear",l).startOf("month"),o.set("fullYear",d).endOf("month");break;case"${NEXTFY}":r.set("fullYear",l+1).startOf("month"),o.set("fullYear",d+1).endOf("month");break;case"${PREVFQ}":r.set("month",c-3).startOf("month"),o.set("month",c-1).endOf("month");break;case"${THISFQ}":r.set("month",c).startOf("month"),o.set("month",c+2).endOf("month");break;case"${NEXTFQ}":r.set("month",c+3).startOf("month"),o.set("month",c+5).endOf("month");break;default:if("string"==typeof e&&(e.startsWith("${AGEINDAYS}")||e.startsWith("${DUEINDAYS}"))){var p=e.startsWith("${AGEINDAYS}");e=parseInt(e.substring(13)),r=p?r.subtract(e,"date").format("MMM DD YYYY"):r.add(e,"date").format("MMM DD YYYY");var f=$L.moment().timezone(Crm.userDetails.USER_TIME_ZONE).format("MMM DD YYYY");if("equal"===a)return"Datecomp(Datepart("+t+"),"+r+")==0";if(p)switch(a){case"equal":default:return"Datecomp(Datepart("+t+"),"+r+")==0";case"not_equal":return"And(Datecomp(Datepart("+t+"),"+r+")!=0,Datecomp("+t+","+f+")<=0)";case"less_than":return"And(Datecomp("+r+",Datepart("+t+"))<0,Datecomp("+t+","+f+")<=0)";case"greater_than":return"Datecomp(Datepart("+t+"),"+r+")<0";case"less_equal":return"And(Datecomp("+r+",Datepart("+t+"))<=0,Datecomp("+t+","+f+")<=0)";case"greater_equal":return"Datecomp(Datepart("+t+"),"+r+")<=0"}switch(a){case"equal":return"Datecomp(Datepart("+t+"),"+r+")==0";case"not_equal":return"Or(And(Datecomp("+f+",Datepart("+t+"))<=0,Datecomp(Datepart("+t+"),"+r+")<0),Datecomp("+r+",Datepart("+t+"))<0)";case"less_than":return"And(Datecomp("+f+",Datepart("+t+"))<=0,Datecomp(Datepart("+t+"),"+r+")<0)";case"greater_than":return"Datecomp("+r+",Datepart("+t+"))<0";case"less_equal":return"And(Datecomp("+f+",Datepart("+t+"))<=0,Datecomp(Datepart("+t+"),"+r+")<=0)";case"greater_equal":return"Datecomp("+r+",Datepart("+t+"))<=0";default:return"Datecomp("+t+","+r+")==0"}}switch("not_between"===a||"between"===a?e=[this.getFormatedDT($L.moment(e[0]),i),this.getFormatedDT($L.moment(e[1]),i)]:"EMPTY"!==a&&"NOTEMPTY"!==a&&(e=this.getFormatedDT($L.moment(e),i)),a){case"equal":return"Datecomp("+t+","+e+")==0";case"not_equal":return"Or(Datecomp("+t+","+e+")!=0,Len('"+t+"')==0)";case"less_than":return"Datecomp("+t+","+e+")<0";case"greater_than":return"Datecomp("+e+","+t+")<0";case"less_equal":return"Datecomp("+t+","+e+")<=0";case"greater_equal":return"Datecomp("+e+","+t+")<=0";case"between":return"And(Datecomp("+e[0]+","+t+")<=0,Datecomp("+t+","+e[1]+")<=0)";case"not_between":return"Or(Not(And(Datecomp("+e[0]+","+t+")<=0,Datecomp("+t+","+e[1]+")<=0)),Len('"+t+"')==0)";case"EMPTY":return"Len('"+t+"')==0";case"NOTEMPTY":return"Len('"+t+"')>0";default:return t+"=="+e}}return"And(Datecomp("+this.getFormatedDT(r,i)+","+t+")<=0,Datecomp("+t+","+this.getFormatedDT(o,i)+")<=0)"},getFormatedDT:function(e,t){return t?e.i18N("MMM DD YYYY"):e.i18N("MMM DD YYYY HH:mm")},handleEditPromise:function(e,t){var a=this.parent.parent.currentModel.module,i=!this.transition.data.layoutId&&e.data&&e.data[0]&&("draft"===e.data[0].$state||!validationUtils.isEmpty(e.data[0].Wizard)),r=(e.data&&e.data[0]&&e.data[0].$state,this.parent.parent.getDynamicParam());if("PriceBooks"!=r&&"Activities"!=r&&"Quotes"!=r&&"Invoices"!=r&&"SalesOrders"!=r&&"PurchaseOrders"!=r){var o=moduleRecordMapping[r].id,n=store.peekRecord("module",o);if(!n||!(i&&n.creatable||n.editable))return crmHistory.handleAjaxErrorLyte=!0,renderingUtils.displayPermissionDenied(),void this.transition.abort()}if(i){var s,l;if(this.isWizard=!0,l=e.data[0].Layout?e.data[0].Layout:{id:e.layout_jsonarrayObj.currLayoutId},s=l.id,!e.data[0].$editable)return crmHistory.handleAjaxErrorLyte=!0,renderingUtils.displayPermissionDenied(),void this.transition.abort();var d=this,c={};return c.layoutId=s,c.moduleapi=a.api_name,c.moduleName=r,c.entityId=e.data[0],c.wizardId=e.data[0].Wizard.id,c.isOldFlow=!0,this.getModulePromise(c).then((function(i){for(var o,c=e.data[0],u=Object.keys(c),m=u.length,p=["date","datetime","multi-picklist","phone"],f={},_=store.modelFor(a.id),y=_.fieldList,g=0;g<m;g++)null==c[u[g]]?c[u[g]]=void 0:y[u[g]]&&c[u[g]]&&p.indexOf(y[u[g]].type)>-1?f[u[g]]=c[u[g]]:y[u[g]]&&"relation"==y[u[g]].type&&"hasMany"==y[u[g]].relType&&c[u[g]]&&c[u[g]].length&&(f[u[g]]=c[u[g]].slice(0));return"approval_process_pending"!==entData.$approval_state&&"approval_process_rejected"!==entData.$approval_state||!entData.$editable?(n.record_modification=void 0,c&&c.$process_flow?(store.pushPayload(a.id,c),d.getEntityRecordBluePrintProcessInfo(c.id,r).then(function(e){return o=e&&e.blueprint?e.blueprint:void 0,v()}.bind(this))):v()):store.triggerAction(moduleRecordMapping[r].id,"record_modification",{id:entData.id,module:moduleRecordMapping[r].api_name},void 0,"GET",!1).then(function(e){return n.record_modification=e,v()}.bind(this));function v(){var r=_.relations;for(var n in r){var u=r[n];u&&u.length&&"hasMany"==u[0].relType&&!c[u[0].relKey]&&(c[u[0].relKey]=[])}store.pushPayload(a.id,c);var m,p,y=[],g=store.peekRecord("wizard-container",s);if(!g||!g.chart_data)return crmHistory.handleAjaxErrorLyte=!0,renderingUtils.displayPermissionDenied(),void d.transition.abort();if(p=g.chart_data.nodes.length,i.layout=[],c.$wizard_connection_path&&c.$wizard_connection_path.length){var v,h=store.peekRecord("wizard-container",s),D=c.$wizard_connection_path,b=0;D.forEach((function(e,t){if(0===t){var a={id:(i=h.chart_data.screen_connections[e]).source_screen.id,name:i.source_screen.display_label,index:b++,api_name:store.peekRecord("wizard-screen",i.source_screen.id).api_name};y.push(a)}var i;a={id:(i=h.chart_data.screen_connections[e]).target_screen.id,name:i.target_screen.display_label,index:b++,api_name:store.peekRecord("wizard-screen",i.target_screen.id).api_name};y.push(a),v=i.target_screen.id})),m=(I=store.peekRecord("wizard-screen",v)).segments}else for(var L=0;L<p;L++){var C=g.chart_data.nodes[L];if(C.start_node){var I;m=(I=store.peekRecord("wizard-screen",C.screen.id)).segments,y.push({id:I.id,name:I.name,index:0,api_name:I.api_name});break}}if(i.layout.push(store.peekRecord("layout",s)),e.custom_button&&e.custom_button.length){let t=Lyte.registeredMixins["crm-custom-button-mixin"],i={position:t.custom_button_position.EDIT,layoutId:s,moduleName:a.module_name};e.custom_button=t.filterButtonData(e.custom_button,i)}return Lyte.resolvePromises({initRoute:"edit",entityrecordData:store.peekRecord(a.id,e.data[0].id),transitionData:t,layoutRules:i.layout_rule,validationRules:i.validation_rule,customButtons:i.custom_button,moduleData:a,moduleId:a.id,moduleName:a.module_name,currsubformApinames:a.currsubformApinames?a.currsubformApinames:[],layoutddData:[{uservalue:l.name,systemvalue:l.id,id:l.id}],layoutddSelected:l.name,selectedLayoutid:l.id+";"+e.data[0].Wizard.id,moduleSections:m,layoutDet:l,isWizard:!0,screenHistory:y,originalData:f,fcCategory:i.fc_category?i.fc_category.stages:[],bluePrintProcessInfo:o||void 0,zorContributingFields:i.zorContributingFields,zorEnabled:i.zorEnabled,available_actions:i.available_actions})}}))}return e},handleOmitedStageInPotential:function(){var e=this.getData("dataBind"),t=this.data.currentInstObjKey;if(e.Stage){var a=this.getData("moduleData.fields").filter((function(e){return"STAGE"==e.column_name}))[0];if(a&&"Stage"==a.api_name){var i=a.pick_list_values.filter((function(t){return t.display_value==e.Stage}))[0];if(i&&i.id){i=this.getData("fcCategory")?this.getData("fcCategory").filter((function(e){return e.id==i.id}))[0]:void 0;var r=this.getData("initRoute");if(i&&("Closed Lost"===i.deal_category||"Closed Lost"===i.forecast_type)&&(e.Stage!==a[t].old_Stage_Value||"create"===r||"clone"===r)&&!this.getData("isstageSave")&&!Crm.userDetails.ReasonForLoss){var o=document.querySelector("#verifyStageDetailsmodal");if(o){var n=o.closest("crm-create-buttons");n&&i.colour_code&&Lyte.Component.set(n.component.data.stageDetails,"plColorCode",i.colour_code);var s={left:"center",top:"0px"},l={animation:"slideFromTop",duration:"0.3"};return o.ltProp("transition",l),o.ltProp("offset",s),o.ltProp("showCloseButton",!1),o.ltProp("show",!0),!0}}}}}return!1},closeStageDetailsmodal:function(){this.setData("isstageSave",!1),this.setData("disableFormbuttons",!1),this.setData("reasonforLoss","");var e=document.querySelector("crm-create-wizard-buttons");e&&e.component&&e.component.setData("disableFormbuttons",!1);var t=document.querySelector("#verifyStageDetailsmodal");t&&t.ltProp("show",!1)},shownoresultsForSearch:function(e,t,a,i,r,o){var n=function(){if(!document.querySelector(".noresultstyleCPage")){var e="."+this.$node.component.data.picklistsearchKey,t=document.querySelector(e),a=document.createElement("div");a.setAttribute("class","noresultstyleCPage lyteDropdownNoResult");var i=I18n.getMsg("crm.label.no.options.found");this.data.moduledataUicomp&&"Native__Survey__Extn__Survey"===this.data.moduledataUicomp.api_name&&(i=I18n.getMsg("crm.zsurvey.list.empty.msg"),a.classList.add("lzsurveyNoResults")),a.textContent=i,t.appendChild(a)}};if(o){var s,l=e,d=r,c=[],u=[];if(l.forEach((function(e){/lyte-drop-label/i.test(e.tagName)?-1===c.indexOf(e)&&c.push(e):-1===u.indexOf(e)&&u.push(e)})),c.forEach((function(e){var t=Array.from(e.parentNode.children);t.shift(),t.forEach((function(e){/lyte-drop-item/i.test(e.tagName)&&(e=e.children[0]);var t=d.indexOf(e);-1!==t&&(d.splice(t,1),l.push(e))}))})),u.forEach((function(e){var t;t=/span/i.test(e.tagName)?e.parentNode.parentNode.children[0]:e.parentNode.children[0];var a=d.indexOf(t);-1!==a&&(d.splice(a,1),l.push(t))})),d.forEach((function(e){/span/i.test(e.tagName)&&(e=e.parentNode),e.classList.add("lyteSearchHidden"),/lyte-drop-label/i.test(e.tagName)&&e.parentNode.classList.add("lyteSearchHidden")})),l.forEach((function(e,t){/span/i.test(e.tagName)&&(e=e.parentNode),i&&"zsurvey___crm__SYSTEM__NONE"===e.getAttribute("data-value")?(e.classList.add("lyteSearchHidden"),s=t):(e.classList.remove("lyteSearchHidden"),/lyte-drop-label/i.test(e.tagName)&&e.parentNode.classList.remove("lyteSearchHidden"))})),void 0!==s&&l.splice(s,1),l&&l.length)(p=document.querySelector(".noresultstyleCPage"))&&p.remove();else n.call(this);return!1}var m=!0;if("string"==typeof i&&i.length&&!i.trim()&&((e=e.concat(r)).forEach((function(e){e.classList.remove("lyteSearchHidden")})),m=!1),0===e.length)n.call(this);else{var p=document.querySelector(".noresultstyleCPage"),f=e[0];m&&f&&($L(f).parent().find(".lyteDropdownSelection").removeClass("lyteDropdownSelection"),$L(f).addClass("lyteDropdownSelection")),p&&p.remove()}return m},autoFocusSearchField:function(){var e=this.getData("picklistsearchKey");if(e){var t="."+e+" lyte-search lyte-input",a=document.querySelector(t);a&&a.focus()}},calculatorOperationCreate:function(e,t,a,i){if(!a||!a.read_only){var r=$(e),o=r.parents(".FValue").find(".resultValue"),n=t.which?t.which:t.keyCode,s=r.val(),l=!(!t.ctrlKey&&!t.metaKey);if("keypress"===t.type){if(!([43,45,42,47,13,40,41,46,8,9,97,118,99].indexOf(n)>-1||n>=48&&n<=57))return t.preventDefault(),!1;if(13===n)return r.trigger("blur"),!1;if(-1!==[97,99,118].indexOf(n)&&!l)return t.preventDefault(),!1}else if("keyup"===t.type)this.calculationProcessAreaCreate(r);else if("blur"===t.type){if("CRM-BULKLOOKUP-ADDITION"===this.$node._callee.tagName)return;if(s=crmTemplate.memberDataStoreLI,""!==o.attr("data-valueRes")){var d=o.attr("data-valueRes");""!==d&&""!==s?(!0===crmTemplate.setPreviousValueToContainer&&r.attr("data-finalValue",s+" = "+d),r.val(d),o.attr("data-valueRes","").addClass("vH"),Lyte.Component.set(i,a.api_name,d)):d&&isNaN(d)&&this.handleCScriptDispatchEvent({fieldID:a.id,uiType:a.ui_type,fldapiName:a.api_name,calledFrom:"onChange"})}else crmTemplate.calculatorProcessingOrder=[],Lyte.Component.set(i,a.api_name,r.val());crmTemplate.memberDataStoreLI=""}}},calculationProcessAreaCreate:function(e){var t=e,a=t.parents(".FValue"),i=a.find(".resultValue"),r=t.val(),o=a.attr("data-decimal-length"),n=r=r.replace(/ /g,""),s="";if(-1===n.indexOf(","))if(""===n||n.match(/[a-z]/i))crmTemplate.memberDataStoreLI="",i.addClass("vH"),i.attr("data-valueRes",s);else{var l=crmTemplate.checkBrackets(n);if(/^(\+|\*|\/)/.test(n)&&(n=n.substr(1)),""===r&&i.text(s),""!==n){var d=/^((?!([+\-*/.]{2,})).)*$/.test(n);if(d){if("0"==n)s="0";else if(!0===l){if(-1===n.indexOf("()")){var c=n.length-1;if(crmTemplate.checkCorrectInputEle(n))crmTemplate.checkDotCorrectInput(n)&&(-1===["+","-","*","/","."].indexOf(n[c])||"."!==(n=n.slice(0,-1)))&&(n=crmTemplate.clearLeadingZero(n),(s=new Function("return "+n)())%1!=0&&(s=void 0!==o?Number(Math.round(s+"e"+o)+"e-"+o):Math.round(100*s)/100)),crmTemplate.setPreviousValueToContainer=!0,crmTemplate.memberDataStoreLI=n}}else s=i.text();""===t.val()&&(s="",i.addClass("vH")),i.text(s),i.attr("data-valueRes",s)}!0===/[+\-*/(]/.test(r)&&l&&!0===d&&"+"!==n&&""!==n&&""!==s?i.removeClass("vH"):i.addClass("vH")}else crmTemplate.memberDataStoreLI="",i.addClass("vH")}else crmTemplate.memberDataStoreLI=""},filterValidUITypes:function(e,t,a,i,r){var o,n,s=store.modelFor(e.$.model._name).fieldList,l={},d=!1,c={},u=!1,m=!1,p=e.$.toJSON(),f=this.data.currentInstObjKey,_=Object.keys(s),y=_.length,g=["$approved","$state","$transitionid","Data_Source"];"edit"!=(t="edit"===t?"edit":"create")&&g.push("id");var v=!(!r||!r.isCloneOnEdit)&&r.isCloneOnEdit,h=!(!r||!r.isVR)&&r.isVR;this.data.isWizard&&(n=(o=$L("crm-create-layout")[0].getData("screenHistory")).length);for(var D=0;D<y;D++){if(!s[_[D]]||!s[_[D]].fieldID||["QUOTENUMBER","SONUMBER","INVOICENUMBER","WIZARDID","LAYOUTID","TAGMODULEREFID","LASTACTIVITYTIME","EXCHANGERATE"].contains(s[_[D]].columnName)||"relation"===s[_[D]].type||g.contains(_[D])||"picklist"==s[_[D]].fieldType&&("picklist"!=s[_[D]].fieldType||"-None-"==p[_[D]]&&!h)){if(e[_[D]]&&s[_[D]].cusRelationFldType&&"subform"===s[_[D]].cusRelationFldType&&"customButtons"!==i&&Crm.userDetails.ValidationRuleSupportInSubform){var b,L,C=[],I=!1,E=!1;if(this.data.isWizard)for(var R=0;R<n;R++)for(var S=store.peekRecord("wizard-screen",o[R].id).segments,F=S.length,O=0;O<F;O++)"subforms"===S[O].type&&S[O].subform_apiname===_[D]&&(I=S[O][f].isvalidSection,C=S[O].fields);else{var k,w=this.data.moduleSections;if(b=!!Lyte.Router.getRouteInstance()&&"canvas"===Lyte.Router.getRouteInstance().routeName)for(var N=this.data.currentLayout,T=N?N.length:0,M=0;M<T;M++)N[M].module.module_name===this.data.module&&(w=N[M].sections);for(var P=w.length,$=0;$<P;$++)if(k=b?w[$].api_name:w[$].subform_apiname,b){if(w[$].isSubformSection)for(var A=w[$].fields,U=A.length,x=0;x<U;x++)500===A[x].ui_type&&A[x].api_name===_[D]&&(C=w[$].fields,E=w[$].fields.length>1)}else if(k===_[D]){var V=w[$][f];if(C=w[$].fields,"used"===w[$].type||w[$].screen)for(var B=C.length,j=0;j<B;j++)if(C[j].view_type[t]&&Lyte.Component.registeredHelpers.isValidCreateField(C[j],t,this.data.module)){V.isvalidSection=!0,V.haveValidFields=!0;break}I=V.isvalidSection}}var Y=e[_[D]],q=Y.length,z=[];if(!b&&I||b&&E)for(var W=0;W<q;W++){L=this.filterValidUITypes(Y[W],t,C,void 0,r),Object.keys(L).length>0&&(z[W]=L)}l[_[D]]=z}}else{var H=a.filter((function(e){return e.id==s[_[D]].fieldID}))[0];if(H&&H.visible&&(H.view_type[t]||"quickCreate"===i)&&this.fieldInPath(H)){var K;if("customButtons"===i){if("SALUTATION"===s[_[D]].columnName)continue;K=G(p[_[D]],s[_[D]].uiType)}else K=Q(p[_[D]],s[_[D]].uiType,_[D]);H.subform_api&&!H.subform?(u=!0,c[_[D]]=K,!m&&s[_[D]].fieldID&&"SERIAL_NUMBER"!==s[_[D]].columnName&&"formula"!=s[_[D]].fieldType&&"fileupload"!==s[_[D]].fieldType&&(K&&"picklist"!==s[_[D]].fieldType&&"fileupload"!==s[_[D]].fieldType&&"boolean"!==s[_[D]].fieldType||K&&"picklist"===s[_[D]].fieldType&&"-None-"!==K||"boolean"===s[_[D]].fieldType&&"false"!==K)&&(m=!0)):l[_[D]]=K}}m&&D===y-1&&(l=c)}return d&&(l.$se_module=e.$se_module),!g.includes("id")&&e.id&&(u?m&&(l.id=e.id):l.id=e.id),v&&(l=function(e,t){e.id&&-1!==e.id.indexOf("_cloneOnEdit")&&(e.id=e.id.replace("_cloneOnEdit",""));for(var a in e)if(t[a].cusRelationFldType&&"subform"===t[a].cusRelationFldType)for(var i=e[a].length,r=0;r<i;r++)e.id&&e[a][r].id&&-1!==e[a][r].id.indexOf("_cloneOnEdit")&&(e[a][r].id=e[a][r].id.replace("_cloneOnEdit",""));return e}(l,s)),l;function Q(e,t,a){switch(t){case 3:case 116:case 117:case 123:case 200:case 208:case 209:case 444:case 20:case 39:case 51:case 55:case 77:case 96:case 99:case 100:case 110:case 111:case 556:case 445:case 66:case 555:case 111:case 250:return"";case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 12:case 13:case 15:case 133:case 132:case 135:case 221:case 136:return(Crm.userDetails.VALIDATION_RULE_CF_LOOKUPSUPPORT||Crm.userDetails.ValidationAlertPreference)&&e?("What_Id"==a&&(d=!0),e):"";case 24:case 202:return e?Lyte.Transform.date.serialize(e):"";case 14:case 30:case 333:case 786:if(!e)return"";var i=Lyte.Transform.datetime.serialize(e);return Crm&&Crm.userDetails.TIME_ZONE&&(i+=Crm.userDetails.TIME_ZONE.replace(".",":")),i;case 300:case 301:return("true"===e||"1"===e||1==e)+"";case 33:return e?commonUtils.getPlainPhoneNo(e):"";case 2:return"-None-"===e?"":e;default:return void 0===e||""===e||null===e?"":"string"==typeof e?e.trim():e+""}}function G(e,t){switch(t){case CrmField.UITYPES.ACCOUNT_NAME_LOOKUP:case CrmField.UITYPES.CAMPAIGN_NAME_LOOKUP:case CrmField.UITYPES.PRODUCT_NAME_LOOKUP:case CrmField.UITYPES.CONTACT_LOOKUP:case CrmField.UITYPES.OWNER:case CrmField.UITYPES.VENDOR_NAME_LOOKUP:case CrmField.UITYPES.POTENTIAL_ID:case CrmField.UITYPES.SALESORDER_ID:case CrmField.UITYPES.CONTACT_ID:case CrmField.UITYPES.QUOTE_ID:case 116:case CrmField.UITYPES.AGGREGATE_FIELD:case 123:case CrmField.UITYPES.LOOK_UP_ENTITY:case CrmField.UITYPES.CREATED_TIME:case CrmField.UITYPES.LAYOUT:case CrmField.UITYPES.TAGMODULEREFID:case CrmField.UITYPES.USERLOOKUP:case CrmField.UITYPES.MULTISELECT_LOOK_UP:case CrmField.UITYPES.CREATED_BY:case CrmField.UITYPES.RECORD_CURRENCY:case 51:case CrmField.UITYPES.PRODUCT_HANDLER:case 77:case CrmField.UITYPES.COMMENTCONTENTS:case CrmField.UITYPES.MULTI_PICK_LIST:case CrmField.UITYPES.MULTI_LINE_CF:case CrmField.UITYPES.AUTONUMBER:case CrmField.UITYPES.IMAGE_UPLOAD:return"";case CrmField.UITYPES.DATE:case CrmField.UITYPES.DATE_LONG:return e?Lyte.Transform.date.serialize(e):"";case CrmField.UITYPES.DATE_TIME2:case CrmField.UITYPES.DATE_TIME1:case CrmField.UITYPES.DATE_TIME_LONG:case CrmField.UITYPES.DATETIME:if(!e)return"";var a=Lyte.Transform.datetime.serialize(e);return Crm&&Crm.userDetails.TIME_ZONE&&(a+=Crm.userDetails.TIME_ZONE.replace(".",":")),a;case CrmField.UITYPES.BOOLEAN_DEF:case CrmField.UITYPES.BOOLEAN_DEF_NOT:return("true"===e||"1"===e||!0===e)+"";case CrmField.UITYPES.PHONE:return e?commonUtils.getPlainPhoneNo(e):"";default:return void 0===e||""===e||null===e?"":"string"==typeof e?e.trim():e+""}}},handleVRFunctionResponse:function(e,t,a,i,r,o){var n,s={},l={},d=void 0!==Crm.userDetails.ValidationAlertPreference&&Crm.userDetails.ValidationAlertPreference,c=!1,u=i.getData("aggregateFields"),m=!1;if(u&&1===a.length){for(var p=u.length,f=0;f<p;f++)if(u[f].id===a[0]._targetFieldid){n=u[f];break}n&&(n.$.set("verifyDisabled",!1),n.$.set("verifyText",""),m=!0)}m||(i.setData("verifyText",""),i.setData({verifyButton:"",verifyDisabled:!1}));try{for(var _=t.length,y=0;y<_;y++){var g=t[y];if("success"==g.status&&g.details){var v="string"==typeof g.details.output?JSON.parse(g.details.output.replace(/'/g,'"')):g.details.output;if(!v.status){c=!0;break}"success"!=v.status?d?(r.push({message:v.message.substring(0,100),targetField:a[y].api_name,targetFieldId:a[y]._targetFieldid,alert_preference:"on_primary_field",alert_type:"stop_saving_records"}),i.setData("vrPassed",!0)):v.message?r.push({message:v.message.substring(0,100),targetField:a[y].api_name,targetFieldId:a[y]._targetFieldid}):o||(i.setData("vrPassed",!0),commonUtils.showErrorMsg($ESAPI.encoder().encodeForHTML(v.message.substring(0,100)),s,e,undefined,undefined,"checkbox"==s.attr("type"))):m?n.$.set("verifyText",I18n.getMsg("verified")):i.setData("verifyText",I18n.getMsg("verified"))}else if("INTERNAL_ERROR"==g.code||"INVALID_DATA"==g.code){c=!0;break}}}catch(e){c=!0}o||(c?(i.setData("vrPassed",!0),$("#newRelatedListPopUpDiv").css("z-index","100002").html('<div class="crm-heading-font-size p30  alignLeft"><div class="crm-font-bold crm-heading-font-size">'+I18n.getMsg("crm.validation.rule.function.error.heading")+'</div><div class="crm-subheading-font-size mB10 mT10 crm-font-regular">'+I18n.getMsg("crm.validation.rule.function.error.title")+'</div><ul class="m0 bottom0 cutomfunctionalert"><li>'+I18n.getMsg("crm.validation.rule.function.error1")+"</li><li>"+I18n.getMsg("crm.validation.rule.function.error2")+'</li></ul> <br><div class="aligncenter"><input type="button" id="custom_alert_button" class="primarybtn" value="'+I18n.getMsg("crm.mb.newversion.msg4")+'" onclick="crmui.hidePopup(\'newRelatedListPopUpDiv\')"></div></div>',null,!0),crmui.showPopup("newRelatedListPopUpDiv"),$("#FreezeLayer").css("z-index","30")):validationUtils.isEmpty(l)||c||(i.setData("vrPassed",!0),$("#newRelatedListPopUpDiv").removeClass("w860").css("width","30%").html(Handlebars.templates.validationRuleError(l)),crmui.showPopup("newRelatedListPopUpDiv")))},deleteCurrentInstanceProperties:function(e,t,a,i){if(!this.data||!0!==this.data.skipInstObjDeletion){for(var r=e.fields.length,o=0;o<r;o++)delete e.fields[o][a],delete e.fields[o].subformFields,delete e.fields[o].suggestions,delete e.fields[o].dummy__Mandatory,delete e.fields[o].criteria,delete e.fields[o].userSearchCriteria,delete e.fields[o].minValue,delete e.fields[o].maxValue;i?store.peekAll("wizard-screen").mapByKey("segments").forEach((e=>{n(e)})):t&&t.length&&n(t),delete e[a]}function n(e){e.forEach((function(e){delete e[a],delete e.subform_apiname,e.fields&&e.fields.length&&e.fields.forEach((function(e){e&&delete e[a]}))}))}},handleDropDownChanges:function(e,t,a,i){var r=this.$node.component.data.dataBind,o=this.getData("moduleData")?this.getData("moduleData"):this.getData("moduleInfo"),n=this.data.currentInstObjKey;if(i&&(r=this.$node.component.data.databindSubform),"Stage"===t&&"Potentials"===o.module_name){var s=a.filter((function(t){return t.display_value==e})),l=s&&s[0]?s[0].probability:void 0;null!=l&&Lyte.Component.set(r,"Probability","-None-"==e?void 0:l),this.setExpectedRevenue()}if("Currency"===t){var d,c=this.getData("dataBind"),u=this.getData("moduleData.fields").filter((function(e){if(("currency"===e.data_type||"EXCHANGERATE"===e.column_name)&&validationUtils.isEmpty(e.subform)||"subform"===e.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===e.data_type)return"EXCHANGERATE"==e.column_name&&(d=e.api_name),e}));if(!c[d]){let e=o[n].currencyData;Lyte.Component.set(c,d,e?Number(e.er):"")}var m=this.getuserCurrencydata(e);Lyte.Component.set(o[n],"currencyData",m),Lyte.Component.set(o[n],"currentCurrencySymbol",m.symbol);var p=u.length,f=d&&c[d]?c[d]:void 0,_=this.isInventoryModule(o.module_name);_&&this.getInventoryRoundOffDetail();for(var y=0;y<p;y++){var g=u[y];if(f=f||o[n].currencyData.er,"currency"==g.data_type){var v=c[g.api_name],h=c.$.error[g.api_name];if(null!=v||Lyte.Component.registeredHelpers.isNotEmpty(h)){this.convertCurrvalues(v,f,m,g,!1,void 0,void 0,h,c,o.module_name);var D="crm-create-fields#"+o.module_name+"_fldRow_"+g.column_name+" lyte-input input";$L(D).trigger("keypress").trigger("keyup").focus().trigger("blur")}}if("subform"===g.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===g.data_type){var b='crm-create-subformsection[subform-id="'+g.subform.id+'"]',L=document.querySelector(b),C=c[g.api_name],I=C?C.length:0;if(_&&L&&L.component.fetchInventoryProductDetails)for(var E=C.length,R=0;R<E;R++)void 0===C[R]._LC_additional_INV_subform_INFO&&L.component.fetchInventoryProductDetails(C[R]);let e=L.component.data.subFieldsarray,t=L.component.data.formulaInvldFlds,a=t.length,i={},r={};for(let o=0;o<a;o++){let a=e.findIndex((e=>e.api_name===t[o])),n=e[a]?store.peekRecord("field",e[a].id):void 0;n&&(i[e[a].id]=n,r[e[a].api_name]=n)}for(var S,F=objectUtils.getKeys(i),O=g.subformFields,k=O&&O.length?O.length:0,w=0;w<k;w++)if("currency"==O[w].data_type&&!O[w].subform){for(var N=O[w].api_name,T=0;T<I;T++)for(var M in C[T])if(M==N){v=C[T][M],h=C[T].$.error[M];(null!=v||Lyte.Component.registeredHelpers.isNotEmpty(h))&&(this.convertCurrvalues(v,f,m,C[T],!0,M,T,h,C[T],o.module_name,g.api_name),crmFormulaInit.prototype.createLFormulaWorker.postMessage({fromLyteC:{fromBulkAddition:"true",data:{curSelectedBulkRecs:C.length,currEntityRec:C[T],visibleFormulaFields:L.component.getData("visibleFormulafield"),formulaFldIdVsMetaKeys:F,formulaFldIdVsMeta:i,model_name:C[T].$.model._name,_fromTaxFldCal:!1,autoPopulateTax:!0}}}),this.formulaWorkerHandler());break}S=O[w]}S&&S[n]&&Lyte.Component.set(S[n],"triggerFormulaCalcObserver",!S[n].triggerFormulaCalcObserver);b='crm-create-subformsection[subform-id="'+g.subform.id+'"]';(L=document.querySelector(b))&&(L.component.triggerFormulaCalculation&&L.component.triggerFormulaCalculation(void 0,"currConvert",L));for(var P=g[n].aggFields,$=P&&P.length?P.length:0,A=0;A<$;A++)if("currency"==P[A].data_type){v=c[P[A].api_name],h=c.$.error[P[A].api_name];(null!=v||Lyte.Component.registeredHelpers.isNotEmpty(h))&&(this.setCScriptSkipFlagForField(P[A].id),this.convertCurrvalues(v,f,m,P[A],!1,P[A].api_name,void 0,h,c,o.module_name))}}}c.$.set(d,Number(m.er))}for(var U=a.length,x=0;x<U;x++)if(a[x].display_value===e){var V=a[x].maps?a[x].maps.length:0;if(V>=1)for(var B=0;B<V;B++){var j=r.$.model.fieldList[a[x].maps[B].api_name],Y=j?j.columnName:void 0;if(Y){var q="crm-create-fields#"+this.getData("modulenameUicomp")+"_fldRow_"+Y;if(i){var z=this.$node.component.data;q="crm-create-subformfields#"+z.moduleName+"_"+z.parentSubformdata.subform_apiname+"_R"+(z.indexVal+1)+"_"+a[x].maps[B].api_name}a[x].maps[B].pick_list_values.length>0?this.setdropdownProperties(a[x].maps[B].pick_list_values,q,!0,a[x].maps[B].api_name,Y,this.getData("currentLayout"),t,i?"subform":void 0):this.setdropdownProperties(void 0,q,!0,a[x].maps[B].api_name,Y,this.getData("currentLayout"),t,i?"subform":void 0)}}break}},convertCurrvalues:function(e,t,a,i,r,o,n,s,l,d,c){if(s&&Lyte.Component.registeredHelpers.isNotEmpty(s))if("ERR04"===s.code&&s.fieldValue)e=s.fieldValue?s.fieldValue:e;else if("ERR03"===s.code)e="NaN";else{if("ERR02"===s.code&&void 0===s.value)return;"ERR06"===s.code&&s.value&&(e=isNaN(s.value)?e:s.value)}if(!r&&"NaN"==e){var u;u=o?"#AggFld_"+d+"_"+o+" input":"crm-create-fields#"+d+"_fldRow_"+i.column_name+" input";var m=$L(u)[0];m&&(m.value="NaN")}var p=this.convertToCurrentCurrency(e,t,a.er);if(p=Number(p).toFixed(a.decimals),r){var f=l.$&&l.$.model.fieldList[o]&&l.$.model.fieldList[o].decimal_place;p=void 0!==a.decimals&&void 0!==f&&a.decimals>f?Number(p).toFixed(f):p,Lyte.Component.set(l,"__CUSTOM_sequence_NUMBER__",Math.floor(100*Math.random()).toString())}else{var _=i.decimal_place;p=null!=a.decimals&&null!=_&&a.decimals>_?Number(p).toFixed(_):p,Lyte.Component.set(l,o||i.api_name,p)}if(o&&r){var y=$L("crm-create-subformfields#"+d+"_"+c+"_R"+(n+1)+"_"+o+" lyte-input")[0];p=isNaN(p)?p:Number(p),y&&p&&y.ltProp("value",p),!y&&p&&l.$.set(o,p)}},convertToCurrentCurrency:function(e,t,a){return e/t*a},setExpectedRevenue:function(e){var t,a,i=this.getData("dataBind"),r=this;function o(e){if(t=e||i.Amount,validationUtils.isNotEmpty(i.$.error.Probability))a=parseFloat(i.$.error.Probability.value);else if(null==i.Probability){var o=i.Stage;if(o=validationUtils.isNotEmpty(i.$.error.Stage)?i.$.error.Stage.value?i.$.error.Stage.value:"ERR02"==i.$.error.Stage.code?"-None-":i.$.error.Stage.value:o)r.getData("moduleData").fields.filter((function(e){"STAGE"==e.column_name&&e.pick_list_values.forEach((function(e){e.display_value==o&&(a=e.probability)}))}));else a=void 0}else a=i.Probability;var n=function(e,t){return 0==e?"0":roundValue(t*(e/100)+"")}(a,t),s=i.$.model.fieldList.Expected_Revenue;s&&s.hasOwnProperty("decimal_place")&&!isNaN(Number(n))&&0!=n&&s.decimal_place<2&&(n=Number(n).toFixed(s.decimal_place)),Lyte.Component.set(i,"Expected_Revenue",isNaN(Number(n))?void 0:0==n?"0":n)}validationUtils.isEmpty(i.$.error.Amount)&&null!=i.Amount?(e&&this.setCScriptSkipFlagForField(i.$.model.fieldList.Expected_Revenue?i.$.model.fieldList.Expected_Revenue.fieldID:""),o()):validationUtils.isEmpty(i.$.error.Amount)?(e&&this.setCScriptSkipFlagForField(i.$.model.fieldList.Expected_Revenue?i.$.model.fieldList.Expected_Revenue.fieldID:""),Lyte.Component.set(i,"Expected_Revenue",void 0)):(e&&this.setCScriptSkipFlagForField(i.$.model.fieldList.Expected_Revenue?i.$.model.fieldList.Expected_Revenue.fieldID:""),isNaN(i.$.error.Amount.value)?Lyte.Component.set(i,"Expected_Revenue",0):o(i.$.error.Amount.value))},methods:{onDateNavigation:function(e,t,a,i){if(e&&e.target){var r=$L(e.target).closest(".lyteCalCurrentDate");r&&r.length&&i.$node.querySelector(".lyteCalToday").click()}},onCalendarClose:function(e){e&&(e.style.left="",e.style.top=""),this.$node.querySelector("lyte-input").revertToSelected(),this.handleScrollOnDropDownToggle("hide"),this.handleSubformHrzntlScrollforDate("hide")},removeBindToBody:function(e){document.getElementById(e).ltProp("BindToBody",!1)},openDropDownOnEnter:function(e,t){this.setFocusToDropdownOnEnter(e,t),this.handleScrollOnDropDownToggle("hide")},commonDropDownOnShow:function(e,t){if(this.handleScrollOnDropDownToggle("show"),this.autoFocusSearchField(),!!this.$node.querySelector("crux-picklist-component#Crm_Leads_FIRSTNAME_SALUTATION")&&this.data.moduledataUicomp&&t&&t.childComp){var a=t.childComp.querySelector('lyte-drop-item[data-value="-None-"]');a&&a.classList.add("lcsytemNoneValue")}},commonDropDownOnHide:function(e,t){this.handleScrollOnDropDownToggle("hide");var a=this.data.currentInstObjKey;!!this.$node.querySelector("crux-picklist-component#Crm_Leads_FIRSTNAME_SALUTATION")&&this.data.moduledataUicomp&&(this.data.moduledataUicomp[a].is_Lead_SalutationClosed=!0,this.data.moduledataUicomp[a].isSalInputFocused||this.setFocusToDropdownOnEnter(e,t),delete this.data.moduledataUicomp[a].isSalInputFocused)},commonDropDownOnSelect:function(){this.focusDropDownDiv()},timeddOnShow:function(){setTimeout(function(){this.handleScrollOnDropDownToggle("show"),this.handleSubformHrzntlScrollforDate("show")}.bind(this),0)},timeddOnHide:function(e){if(this.handleScrollOnDropDownToggle("hide"),this.handleSubformHrzntlScrollforDate("hide"),e&&e.target){var t=event.target.parentNode;if(/lyte-drop-item/i.test(event.target.tagName)||t&&/lyte-drop-item/i.test(t.tagName))!this.$node.querySelector('lyte-input[lt-prop-type="date"]').ltProp("currentDate")&&this.getMethods("bindTime")&&this.executeMethod("bindTime")}},onAggFormulaValChange:function(e,t){e&&t&&"SUBTOTAL"===t.column_name&&this.updateInvGrandDisAndTaxValues(this.data.dataBind)}},actions:{checkDigitsLength:function(e,t,a,i){this.controlDigitsValue(e,t,a,i)},showHideElement:function(e,t){var a=document.getElementById(e);a&&a.ltProp("show")!==t&&a.ltProp("show",t)}},setFocusToDropdownOnEnter:function(e,t){if(e&&0===e.clientX&&0===e.clientY&&t&&t.$node){var a=t.$node.querySelector("div .lyteDummyEventContainer");a&&a.focus()}},setInitialQueryParam:function(e,t){if(-1===["CustomModule5001","CustomModule5002","CustomModule5003","CustomModule5004"].indexOf(e)){var a=this.parent.getDynamicParam(),i=(e=this.parent.parent.getDynamicParam(),moduleRecordMapping[e].id);!store.model[i]&&store.registerModel(i,{},{extends:"entity"});var r=store.peekRecord(i,a),o=this;r?this.setInitialQueryParamsForRecord(e,t,r,o):store.findRecord(i,a).then((function(a){r=a[0],o.setInitialQueryParamsForRecord(e,t,r,o)}))}},setInitialQueryParamsForRecord:function(e,t,a,i){var r={},o=i.transition.info;if("Activities"==e&&(r.sub_module=i.parent.parent.getQueryParams().sub_module),a&&a.Layout&&a.Layout.id)r.layoutId=a.Layout.id;else{var n=Crm.userDetails.PROFILE_NAME,s=moduleRecordMapping[e];"team_based"===s.access_type&&(n=s.private_profile.name);for(var l=s.layouts,d=l.length,c=0;c<d;c++)for(var u=l[c].profiles.length,m=0;m<u;m++)if(l[c].profiles[m].default&&l[c].profiles[m].name===n){r.layoutId=l[c].id;break}}if(a&&a.Wizard&&a.Wizard.id&&"draft"===a.$state&&(r.state=a.$state),t&&a&&a.Wizard&&a.Wizard.id&&(r.wizardId=a.Wizard.id),r.layoutId)return i.transition.data.skipModuleReqTrigger=!0,i.transition.abort(),i.replaceWith(o.route,o.dynamicParams[0],o.dynamicParams[1],r).data=i.transition.data},bluePencilExtensionExecution:function(e,t){let a,i=e.target,r=t&&t.data&&t.data.availableExtensions;if(r&&r.length&&r.contains("zoho_bluepencil")&&i){if(a=i.closest("#zbp_logo_icon_wrapper_ , #zwp-error-layer-div , #zwp_suggestions_container"),a)return!0;{let t=new CustomEvent("bluePencilTextAreaClickEvent",{detail:{x:e.x,y:e.y,clientX:e.clientX,clientY:e.clientY}});"TEXTAREA"===i.tagName?a=i:"LYTE-WORD"===i.tagName&&(a=i.closest("[data-zbp-bound]")),a&&a.dispatchEvent(t)}}return!1},createglobalhide:function(e,t){var a=e.target,i=a.parentElement;let r=Lyte.registeredMixins["crm-wizard-execution"]||{},o=!!t&&t.bluePencilExtensionExecution(e,t);Lyte.Router.getRouteInstance().getQueryParams().wizardId&&r.isWizardCanvasView||o||$L(a).parents("crm-entity-lookup")[0]||$L(a).parents(".imguploadDoc")[0]||$L(a).parents(".fileUploadLi")[0]&&i&&i.classList.contains("svgIconBoxFileUpload")||"deletelink"===a.id||a.classList.contains("lyteScrollContainer")||e.stopPropagation(),app.globalClickhandling(e)},controlDigitsValue:function(e,t,a,i){switch(t.keyCode){case 8:case 9:case 13:case 16:case 39:case 37:break;default:var r=a.querySelector("input"),o=$L(r).val(),n=o.length,s=currencyUtils.isCurrencyField(i),l=currencyUtils.getOperatorsLen(o);if(setTimeout((function(){if(r.value){var t=r.value.length;-1==r.value.indexOf(".")&&t>n&&(r.value=r.value.substr(0,s?e+currencyUtils.getOperatorsLen(r.value):e))}}),10),r.value&&r.value.substring(r.selectionStart,r.selectionEnd))break;if(s)n&&(n-=l);else if(-1!=o.indexOf(".")&&(n&&n--,190==t.keyCode)){t.preventDefault();break}if(n>=e){if(190==t.keyCode&&-1==o.indexOf("."))break;if((t.ctrlKey||t.metaKey)&&(65==t.which||67==t.which||88==t.which||90==t.which))break;t.preventDefault()}}},createDebounceSearch:function(e,t){return function(){var a=this,i=arguments,r=function(){e.call(a,i)};clearTimeout(this.getData("debounceTimer")),this.setData("debounceTimer",setTimeout(r,t))}.bind(this)},bindEventsForCalculatorOperation:function(e,t,a){var i=e.querySelector("input"),r=$L(e).find("input"),o=this;r.off("keypress keyup blur").on("keypress keyup blur",(function(e){o.calculatorOperationCreate(i,e,t,a)}))},filterValidPickListValues:function(e,t){var a=e.indexOf(";")>-1?e.split(";")[0]:e,i=(t[a]&&t[a].pick_list_values?t[a].pick_list_values:t.pick_list_values)||[];if(!(i&&i.length||"FIRSTNAME"!==t.column_name)){var r=this.data&&this.data.currentInstObjKey,o=t[r].orginalPicklistdata&&t[r].orginalPicklistdata.length?t[r].orginalPicklistdata:[];if((!o||!o.length)&&this.data){var n=(this.data.moduleData&&this.data.moduleData.fields&&this.data.moduleData.fields.length?this.data.moduleData.fields:[]).filter((function(e){return"SALUTATION"===e.column_name}))[0];n&&(o=this.filterValidPickListValues(e,n),n[a]&&n[a].default_value&&t.$.set("default_value",n[a].default_value))}t.pick_list_values=o,i=o}var s=i.filter((function(e){return"used"==e.type}));return s&&s.length?s:i},getRelatedlistapiname:function(e){return e&&e.listRelationId&&!e.isConnectedToField?this.getData("moduleData.fields").filter((function(t){return t.lookup&&t.lookup.id==e.listRelationId}))[0]:e&&e.isConnectedToField?this.getData("moduleData.fields").filter((function(t){return t.multi_module_lookup&&t.multi_module_lookup.modules&&Array.isArray(t.multi_module_lookup.modules)&&t.multi_module_lookup.modules.some((t=>t.module_name===e.primmodule))}))[0]:void 0},setLookupRelatedRecord:function(e,t,a){var i=this,r=this.getData("dataBind"),o=Lyte.deepCopyObject(this.data.modifiedCreatebject||{}),n=this.data.currentInstObjKey;store.findRecord(moduleRecordMapping[e.fillUpModule].id,e.entityid,{approved:"both"},!0,!0).then((function(s){e.entityname=e.entityname||s[0][moduleRecordMapping[e.fillUpModule].display_field.api_name],Lyte.Component.set(t[n],"lookupSingle",e.entityname),Lyte.Component.set(t[n],"selectedId",e.entityid);let l=!1;if(t.ui_type===CrmField.UITYPES.MULTI_MODULE_LOOK_UP_ENTITY){let a=moduleRecordMapping[e.relmodule];Lyte.Component.set(t[n],"modId",a.id)}if(i.data.isWizardView&&e.entityid){var d={id:e.entityid,name:e.entityname};r.$.set(t.api_name,d);var c=moduleRecordMapping[e.fillUpModule],u=c.module_name,m=c.id,p=$L(".fieldupdate_"+t.column_name)[0];if(Lyte.registeredMixins["crm-formview-mixin"]&&p){var f=p.component;f.setData("cxPropValue",d);var _=s[0].Layout&&s[0].Layout.id;_||(_=c.layouts[0].id),Lyte.registeredMixins["crm-formview-mixin"].checkAndUpdateFieldsOfLookupDataInForm(s[0],u,m,_,f.data.cxPropField)}}if(Lyte.Component.set(t[n],"isRelatedListFOLAvailable",!t[n].isRelatedListFOLAvailable),t.custom_field){var y,g=i.getData("moduleName"),v={};if(i.isInventoryModule(g)){var h={Purchase_Orders:["Quotes","Invoices","SalesOrders","PurchaseOrders"],Invoices:["PurchaseOrders"],Sales_Orders:["Invoices","PurchaseOrders"],Quotes:["SalesOrders","PurchaseOrders"]};h.hasOwnProperty(t.lookup.module.api_name)&&h[t.lookup.module.api_name].contains(g)&&(y=!0)}if(v.isValidCustomLookupField=y,i.setCurrencyDetailsonLookupSelect(s[0],store.peekRecord("module",t.lookup.module.id),i.getData("moduleData"),i.getData("initRoute"),t,v),i.isInventoryModule(g)&&["Contacts","Accounts","Quotes","Invoices","Sales_Orders","Purchase_Orders"].contains(t.lookup.module.api_name)){var D=i.getData("moduleData.fields").filter((function(e){return["SALESORDERID","ACCOUNTID","CONTACTID","VENDORID","QUOTEID"].contains(e.column_name)})),b={Sales_Orders:"SALESORDERID",Accounts:"ACCOUNTID",Contacts:"CONTACTID",Quotes:"QUOTEID"};D.forEach((function(a){if(!r[a.api_name]&&b.hasOwnProperty(t.lookup.module.api_name)&&b[t.lookup.module.api_name]===a.column_name?(Lyte.Component.set(a[n],"newLookupcreated",!0),Lyte.Component.set(a[n],"lookupSingle",e.entityname),Lyte.Component.set(a[n],"selectedId",e.entityid)):s&&s[0]&&s[0][a.api_name]&&validationUtils.isNotEmpty(s[0][a.api_name])&&!r[a.api_name]&&(Lyte.Component.set(a[n],"lookupSingle",s[0][a.api_name].name),Lyte.Component.set(a[n],"selectedId",s[0][a.api_name].id)),"Quotes"===t.lookup.module.api_name&&"SalesOrders"===g&&"QUOTEID"===a.column_name||"Sales_Orders"===t.lookup.module.api_name&&"Invoices"===g&&"SALESORDERID"===a.column_name){var i=g+"_fldRow_"+a.column_name,o=$L("crm-create-fields#"+i)[0];o&&o.component.autoFillInventoryDetails(s[0],{isrelatedListFieldDataPresent:{fldApiName:t.api_name,fldValue:{id:e.entityid,name:e.entityname}}})}}))}}else{var L;if(i.data.isWizard&&r.$.set(t.api_name,{id:e.entityid,name:e.entityname}),"Reporting_To"==t.api_name?i.getData("moduleData.fields").filter((function(e){"Account_Name"==e.api_name&&validationUtils.isNotEmpty(s[0].Account_Name)?(Lyte.Component.set(e[n],"lookupSingle",s[0].Account_Name.name),Lyte.Component.set(e[n],"selectedId",s[0].Account_Name.id),i.data.isWizard&&r.$.set(e.api_name,{id:s[0].Account_Name.id,name:s[0].Account_Name.name})):"Vendor_Name"==e.api_name&&validationUtils.isNotEmpty(s[0].Vendor_Name)&&(Lyte.Component.set(e[n],"lookupSingle",s[0].Vendor_Name.name),Lyte.Component.set(e[n],"selectedId",s[0].Vendor_Name.id),i.data.isWizard&&r.$.set(e.api_name,{id:s[0].Vendor_Name.id,name:s[0].Vendor_Name.name}))})):"Deal_Name"==t.api_name||"Deal_Name__s"==t.api_name?i.getData("moduleData.fields").filter((function(e){if("Account_Name"==e.api_name&&validationUtils.isNotEmpty(s[0].Account_Name))Lyte.Component.set(e[n],"newLookupcreated",!0),Lyte.Component.set(e[n],"lookupSingle",s[0].Account_Name.name),Lyte.Component.set(e[n],"selectedId",s[0].Account_Name.id),i.data.isWizard&&r.$.set(e.api_name,{id:s[0].Account_Name.id,name:s[0].Account_Name.name});else if("Related_To"===e.api_name||"Contact_Name"===e.api_name){var t=s[0].Related_To||s[0].Contact_Name||s[0].Reporting_To;validationUtils.isNotEmpty(t)&&(s[0].Account_Name&&s[0].Account_Name.id?("Cases"!==i.data.moduleName&&Lyte.Component.set(e[n],"noAutoFillObser",!0),Lyte.Component.set(e[n],"newLookupcreated",!0)):Lyte.Component.set(e[n],"newLookupcreated",!0),Lyte.Component.set(e[n],"lookupSingle",t.name),Lyte.Component.set(e[n],"selectedId",t.id),i.data.isWizard&&r.$.set(e.api_name,{id:t.id,name:t.name}))}})):"Related_To"!=t.api_name&&"Contact_Name"!=t.api_name||i.getData("moduleData.fields").filter((function(t){if("Account_Name"==t.api_name&&validationUtils.isNotEmpty(s[0].Account_Name)&&(Lyte.Component.set(t[n],"noAutoFillObser",!0),Lyte.Component.set(t[n],"newLookupcreated",!0),Lyte.Component.set(t[n],"lookupSingle",s[0].Account_Name.name),Lyte.Component.set(t[n],"selectedId",s[0].Account_Name.id),i.data.isWizard&&r.$.set(t.api_name,{id:s[0].Account_Name.id,name:s[0].Account_Name.name})),"Cases"===e.module&&"Contacts"===e.relmodule&&s[0][t.api_name]&&("PHONE"===t.column_name||"EMAIL"===t.column_name)){var a="PHONE"===t.column_name&&s.$.meta&&s.$.meta.original?s.$.meta.original[t.api_name]:s[0][t.api_name];r.$.set(t.api_name,a)}})),"Contact_Name"!=t.api_name&&"Related_To"!=t.api_name&&"Reporting_To"!=t.api_name||r[t.api_name]?s&&s[0]&&s[0][t.api_name]&&validationUtils.isNotEmpty(s[0][t.api_name])&&!r[t.api_name]&&(Lyte.Component.set(t[n],"lookupSingle",s[0][t.api_name].name),Lyte.Component.set(t[n],"selectedId",s[0][t.api_name].id)):(L="Contact_Name"==t.api_name?s&&s[0]&&s[0][t.api_name]?t.api_name:s&&s[0]&&s[0].Related_To?"Related_To":"Reporting_To":"Related_To"==t.api_name?s&&s[0]&&s[0][t.api_name]?t.api_name:s&&s[0]&&s[0].Contact_Name?"Contact_Name":"Reporting_To":"Reporting_To",s&&s[0]&&s[0][t.api_name]&&validationUtils.isNotEmpty(s[0][t.api_name])&&(Lyte.Component.set(t[n],"newLookupcreated",!0),Lyte.Component.set(t[n],"lookupSingle",s[0][L].name),Lyte.Component.set(t[n],"selectedId",s[0][L].id))),"Quotes"===e.relmodule&&"SalesOrders"===e.module&&"QUOTEID"===t.column_name||"SalesOrders"===e.relmodule&&"Invoices"===e.module&&"SALESORDERID"===t.column_name){var C=e.module+"_fldRow_"+t.column_name,I=$L("crm-create-fields#"+C)[0];if(I)I.component.autoFillInventoryDetails(s[0]);else if(i.data.isWizard){let a={data:{modulenameUicomp:i.data.moduleName,columnName:t.column_name,module:moduleRecordMapping[e.relmodule],apiName:t.api_name,moduleData:i.data.moduleData,dataBind:i.data.dataBind,currentInstObjKey:i.data.currentInstObjKey},...Lyte.registeredMixins["crm-create-mixin"]};i.autoFillInventoryDetails.call(a,s[0])}l=!0}var E=i.getData("moduleName");if("Contacts"!==E||"Account_Name"!==t.api_name&&"Reporting_To"!==t.api_name)if(!i.isInventoryModule(E)||"ACCOUNTID"!==t.column_name&&"CONTACTID"!==t.column_name){var R;if(t.ui_type===CrmField.UITYPES.MULTI_MODULE_LOOK_UP_ENTITY){R=moduleRecordMapping[e.relmodule].id}else R=t.lookup.module.id;i.setCurrencyDetailsonLookupSelect(s[0],store.peekRecord("module",R),i.getData("moduleData"),i.getData("initRoute"),t)}else{S={moduleName:E,lookupMod:store.peekRecord("module",t.lookup.module.id),fldData:t,recData:s[0]};i.autoFillAddress(!0,S)}else{var S={moduleName:"Contacts",lookupMod:store.peekRecord("module",t.lookup.module.id),fldData:t,recData:s[0]};i.autoFillAddress(!0,S)}}"wizardWidget"!==a&&"cscript"!==a&&(i.setData("initialCreatebject",r.$.toJSON()),i.validateLayoutswitchingForSubForm(i.getData("currsubformApinames"),!0),i.setData("modifiedCreatebject",o)),i.setData("toggleWizardText",!i.getData("toggleWizardText")),"standard_page"===a&&(i.data.isWizard&&!l?i.dispatchOnLoadEvents(i.data.activeScreen):i.data.isWizard||CScript.Engine.Global.dispatchEvent("onLoad"))}),(function(e){if(e&&e.responseText){var t="string"==typeof e.responseText?JSON.parse(e.responseText):e;t&&"NO_PERMISSION"===t.code&&crmui.showMsgBand("error","You do not have permission for the related module, so related module's details can not be auto filled",3e3)}}))},autoPopRelatedRecord:function(e,t){var a=this.getData("dataBind"),i=this.data.currentInstObjKey;store.findRecord(moduleRecordMapping[e.fillUpModule].id,e.entityid,{approved:"both"},!0,!0).then(function(r){this.getData("moduleData.fields").filter((function(t){"Calls"===e.module?("What_Id"===t.api_name&&"Contacts"===e.fillUpModule&&validationUtils.isNotEmpty(r[0].Account_Name)&&!a.What_Id&&(Lyte.Component.set(t[i],"lookupSingle",r[0].Account_Name.name),Lyte.Component.set(t[i],"selectedId",r[0].Account_Name.id)),"Who_Id"===t.api_name&&"Contacts"!==e.fillUpModule&&validationUtils.isNotEmpty(r[0].Contact_Name)&&!a.Who_Id&&(Lyte.Component.set(t[i],"lookupSingle",r[0].Contact_Name.name),Lyte.Component.set(t[i],"selectedId",r[0].Contact_Name.id))):validationUtils.isNotEmpty(r[0].Vendor_Name)&&"VENDORID"===t.column_name&&!a.Vendor_Name&&(Lyte.Component.set(t[i],"lookupSingle",r[0].Vendor_Name.name),Lyte.Component.set(t[i],"selectedId",r[0].Vendor_Name.id))})),"standard_page"===t&&(this.data.isWizard?this.dispatchOnLoadEvents(this.data.activeScreen):CScript.Engine.Global.dispatchEvent("onLoad"))}.bind(this))},setZohoSurveyDetailsInEntity:function(e){var t=this.getData("moduleData"),a=this.data.currentInstObjKey,i=e.Native__Survey__Extn__Survey_Department,r=e.$.model.fieldList,o=t[a].survey_departments.filter((function(e){return e.name===i}))[0];if(o&&e.$.set("Native__Survey__Extn__Department_ID",o.id),"New Survey"==e.Native__Survey__Extn__Survey_Type)switch(["$survey_name","$survey_template_id","$survey_sub_type"].forEach((function(t){!r[t]&&store.addField(e.$.model._name,t,"string")})),e.$.set("$survey_name",t[a].zsurvey_surveyName),e.$survey_name&&("string"!=typeof e.$survey_name||e.$survey_name.trim())||(Lyte.Component.set(t[a],"surveyTexterrorDetails",{isError:!0,message:I18n.getMsg("crm.field.empty.check",I18n.getMsg("New Survey Name"))}),e.isblankSurveyNameError=!0),t[a].zsurvey_subSurvey){case"Blank Survey":if(e.$.set("$survey_sub_type","blank_survey"),r.Native__Survey__Extn__Survey.mandatory){var n=r.Native__Survey__Extn__Survey;n.mandatory=!1,store.addField(e.$.model._name,"Native__Survey__Extn__Survey",r.Native__Survey__Extn__Survey.type,n),e.$.set("Native__Survey__Extn__Survey",t[a].zsurvey_surveyName)}break;case"Template Gallery":e.$.set("$survey_sub_type","template_gallery");for(var s=t[a].zsurvey_templates?t[a].zsurvey_templates.length:0,l=!1,d=0;d<s;d++){for(var c=t[a].zsurvey_templates[d].templates,u=c?c.length:0,m=0;m<u;m++)if(c[m].name===e.Native__Survey__Extn__Survey){l=!0,e.$.set("$survey_template_id",c[m].id);break}if(l)break}break;case"Copy from Existing":e.$.set("$survey_sub_type","copy_from_existing")}if("Associate Existing Survey"==e.Native__Survey__Extn__Survey_Type||"New Survey"==e.Native__Survey__Extn__Survey_Type&&"copy_from_existing"==e.$survey_sub_type)for(var p=o.mappings?o.mappings.length:0,f=0;f<p;f++)for(var _=o.mappings[f].surveys?o.mappings[f].surveys.length:0,y=0;y<_;y++){var g=o.mappings[f].surveys[y];if(g.name==e.Native__Survey__Extn__Survey){e.$.set("Native__Survey__Extn__Survey_URL",g.url);break}}},getTasksOptionsObject:function(){return{recurringType:"dynamicTime",endLessActivity:!1,freq:{N:!1,D:!0,WD:!0,W:!0,M:!0,Y:!0,C:!0,CD:!0,CW:!0,CM:!0,CY:!0},freqFields:{D:{ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},WD:{ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},W:{ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},M:{ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},Y:{ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},CD:{repeatEvery:{interval:!0,daysType:!0,repeatEveryMaxLimit:999,repeatEveryMinLimit:1},ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},CW:{repeatEvery:{interval:!0,repeatEveryMaxLimit:999,repeatEveryMinLimit:1},repeatOn:{weekSelection:!0},ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},CM:{repeatEvery:{interval:!0,repeatEveryMaxLimit:999,repeatEveryMinLimit:1},repeatOn:{dayOfMonth:!0,dayOfWeekOfMonth:!0,rescheduleCheckbox:!0},ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}},CY:{repeatEvery:{interval:!0,repeatEveryMaxLimit:999,repeatEveryMinLimit:1},repeatOn:{dayOfMonth:!0,dayOfWeekOfMonth:!0,rescheduleCheckbox:!0},ends:{never:!0,after:!0,on:!0,afterMaxLimit:999,afterMinLimit:1}}}}},newEditRequestData:function(e){var{module_name:t,dataObject:a,globalDataObject:i,entityRecordId:r,isThroughQc:o,queryParams:n,transData:s,parentTransitionData:l,formViewType:d}=e,c=s?objectUtils.cloneObject(s):{};Crm.editReqFrom=c.reqFrom?c.reqFrom:c.returnAnchor||c.goTo?"":"listView",delete c.backOneLevel;var u={};u.module=t,u.format="json",u=Object.assign(u,c);for(var m=moduleRecordMapping[t].id,p=store.peekRecord("module",m),f=p?p.layouts.filter((function(e){return e.status>=0||"active"===e.status})):[],_=f?f.length:0,y=[],g=0;g<_;g++)y.push({id:f[g].id,name:f[g].name});var v,h,D=[];l&&l.layoutName&&l.layoutId&&(D.push({uservalue:l.layoutName,systemvalue:l.layoutId,id:l.layoutId}),v=l.layoutName,h=l.layoutId),commonUtils.showHideLoadingDiv(!0);var b=this,L={transData:s,dataObject:a};return L.moduleapi=p.api_name,L.moduleName=t,L.entityId=r,L.clonedlayoutId=h,L.queryParamsInfo=n,L.isThroughQc=o,L.formViewTypeInfo=d,this.getModulePromise(L).then(function(e){if(!(this.permissionDeniedForModule||e.isWizardRouteSwitch||e.wizard&&e.wizard.isWizardNotAvailble)){var a,l=store.peekRecord(m,r);return!l||this.isRecordUnAvailableError?this.handleRecNotAvailablityError(o):l&&l.$converted&&!["SalesOrders","Quotes"].contains(t)?this.handleConvertedRecordError(t,l.id,o):"approval_process_pending"!==l.$approval_state&&"approval_process_rejected"!==l.$approval_state||!l.$editable?(p.record_modification=void 0,l&&l.$process_flow&&(!l.$locked_for_me||l.$editable)?this.getEntityRecordBluePrintProcessInfo(l.id,t).then(function(e){return a=e&&e.blueprint?e.blueprint:void 0,d()}.bind(this)):d()):store.triggerAction(moduleRecordMapping[t].id,"record_modification",{id:l.id,module:moduleRecordMapping[t].api_name},void 0,"GET",!1).then(function(e){return p.record_modification=e,d()}.bind(this))}async function d(){var r=l&&("draft"===l.$state||!validationUtils.isEmpty(l.Wizard)),d=l&&"save"===l.$state;if(d&&!validationUtils.isEmpty(l.Wizard)&&l.Wizard.id){let e,t=!1;var c=Crm.userDetails.PROFILE_NAME;"team_based"===p.access_type&&(c=p.private_profile.name);try{e=await store.findRecord("wizard",l.Wizard.id,{layout_id:l.Layout.id,from_cache:!0})}catch{t=!1}if(e&&e[0]&&(t=e[0].profiles.some((e=>e.name===c))),window.clientPortalName){var f=p.layouts.filter((function(e){return e.id===l.Layout.id}))[0].profiles.filter((function(e){return e.id===Crm.userDetails.PROFILE_ID}));f.length>0&&f[0]._default_view.id===l.Wizard.id&&(t=store.peekRecord("wizard",l.Wizard.id).portal_user_types.some((function(e){return e.id===Crm.userDetails.PROFILE_ID})))}if(s&&s.layoutId)r=!1;else if(!t&&(r=!1,n.wizardId)){if(o)return{isSetQueryParams:!0,isWizardNotAvailable:!0,isSetQueryParamsObj:{layoutId:n.layoutId,wizardId:void 0}};b.replaceWith({route:b.transition.info.route,dynamicParams:b.transition.info.dynamicParams,queryParams:{layoutId:n.layoutId}}).data={isWizardNotAvailable:!0}}}if((!p||!(r&&p.creatable||p.editable)||l&&(!l.$editable||l.$stop_processing))&&!(b&&b.data&&b.data.globalData&&b.data.globalData.quickEntityData.isKanbanviewEdit)){var _=null;!l||l.$editable&&!l.$stop_processing||(_=l.$locked_for_me&&!l.$stop_processing?I18n.getMsg("crm.record.locking.permission.denied"):I18n.getMsg("crm.label.insufficient.privileges"));var y={is_Error:!0,errorId:"6",errorFrom:"common",data:{message:_}};return o?y:void(this.handleTransitionAbortErrors?this.handleTransitionAbortErrors(y):(crmHistory.handleAjaxErrorLyte=!0,renderingUtils.displayPermissionDenied(null,null,_),b.transition.abort()))}if(e.editEntitydata=[],e.editEntitydata.push(l),e.layout=[],(d||r)&&!0===Crm.userDetails.ValidationAlertPreference){var g={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},L="/crm/v2.2/"+p.api_name+"/"+l.id+"/actions/get_feature_specific_info";store.findAll("dummy",{features:"validation_rules"},!1,!1,{url:L,method:"GET",headers:g}).then((function(e){var t=$L("crm-create-entity")[0];t&&t.setData("valFeatureSpecinfo",e.data[0].features_info[0].details)}))}if(!h)if(l.Layout)h=l.Layout.id;else{var C=store.peekRecord("module",moduleRecordMapping[t].id).layouts.filter((function(e){return e.status>=0||"active"===e.status}))[0];h=C?C.id:h}var I,E=store.peekRecord("layout",h),R=[];if(r){var S;b.isWizard=!0;var F,O=store.peekRecord("wizard-container",h);if(!O||!O.chart_data){return o?{errorFrom:"common",errorId:"6"}:(crmHistory.handleAjaxErrorLyte=!0,renderingUtils.displayPermissionDenied(),void b.transition.abort())}if(F=O.chart_data.nodes.length,e.layout=[],l.$wizard_connection_path&&l.$wizard_connection_path.length){var k,w=store.peekRecord("wizard-container",h),N=l.$wizard_connection_path,T=0;N.forEach((function(e,t){if(0===t){var a={id:(i=w.chart_data.screen_connections[e]).source_screen.id,name:i.source_screen.display_label,index:T++,api_name:store.peekRecord("wizard-screen",i.source_screen.id).api_name};R.push(a)}var i;a={id:(i=w.chart_data.screen_connections[e]).target_screen.id,name:i.target_screen.display_label,index:T++,api_name:store.peekRecord("wizard-screen",i.target_screen.id).api_name};R.push(a),k=i.target_screen.id})),"save"===l.$state&&(k=R[0].id),S=($=store.peekRecord("wizard-screen",k)).segments}else for(var M=0;M<F;M++){var P=O.chart_data.nodes[M];if(P.start_node){var $;S=($=store.peekRecord("wizard-screen",P.screen.id)).segments,R.push({id:$.id,name:$.name,index:0,api_name:$.api_name});break}}}if(e.layout.push(E),h=r?h+";"+l.Wizard.id:h,e.custom_button&&e.custom_button.length){let a=Lyte.registeredMixins["crm-custom-button-mixin"],i={position:a.custom_button_position.EDIT,layoutId:h,moduleName:t};e.custom_button=a.filterButtonData(e.custom_button,i)}return h=r?h+";"+l.Wizard.id:h,o||(I=Lyte.registeredMixins["crm-create-mixin2"].fetchCustomGlobalData({moduleName:t,formState:"edit",featureInfo:i.loadResourcesOutput.featureInfo,type:i.formType})),Lyte.resolvePromises({initRoute:"edit",entityrecordData:e.editEntitydata?e.editEntitydata[0]:{},transitionData:u,layoutRules:e.layout_rule,validationRules:e.validation_rule,customButtons:e.custom_button,moduleData:p,moduleId:m,moduleName:t,currsubformApinames:p.currsubformApinames?p.currsubformApinames:[],layoutddData:D,layoutddSelected:v,selectedLayoutid:r?h+";"+e.editEntitydata[0].Wizard.id:h,moduleSections:r?S:e.layout[0].sections,layoutDet:e.layout,isWizard:!!r,screenHistory:R,originalData:e.originalData||{},surveyDepartments:e.survey_departments?e.survey_departments:[],webinarIntegration:e.webinarIntegration?e.webinarIntegration:void 0,orgTaxDetails:e.orgTaxDetails&&e.orgTaxDetails.length?e.orgTaxDetails:[],fcCategory:e.fc_category?e.fc_category.stages:[],skyEyeIntegration:!!(e.skyEyeIntegration&&validationUtils.isNotEmpty(e.skyEyeIntegration)&&e.skyEyeIntegration.configured),bluePrintProcessInfo:a||void 0,zorContributingFields:e.zorContributingFields,zorEnabled:e.zorEnabled,documentScrollNeeded:!0,available_actions:e.available_actions,map_dependency:e.mapDependency,globalData:I})}}.bind(this))},checkCriteriaMatchForCanvas:function(e,t,a){if(!e.group_operator&&void 0===e.length)return u(e,a);if(e.group_operator){var i=[],r=0;l=e.group_operator;for(var o=e.group,n=o.length,s=0;s<n;s++)o[s].group_operator?i[r++]=a.checkCriteriaMatchForCanvas(o[s],t,a):i[r++]=u(o[s],a);switch(l){case"AND":return i[0]&&i[1];case"OR":return i[0]||i[1]}}else{i=[],r=0;var l,d=e;for(var c in d)void 0===d[c].length||"string"==typeof d[c]?"object"==typeof d[c]?i[r++]=u(d[c],a):"string"==typeof d[c]&&(l=d[c]):"function"!=typeof d[c]&&(i[r++]=a.checkCriteriaMatchForCanvas(d[c],t,a));if(void 0===i[0]||void 0===i[1])return;switch(l){case"and":return i[0]&&i[1];case"or":return i[0]||i[1]}}function u(e,a){var i=t;if(!e.field)return!1;var r=e.field.api_name;if(r=r.split(".")[0],!i.$.model.fieldList[r]||!store.peekRecord("field",i.$.model.fieldList[r].fieldID).visible)return!1;var o,n=validationUtils.isEmpty(i.$.error[r])?i[r]:i.$.error[r].value,s=e.value;if(n&&"phone"===i.$.model.fieldList[r].type&&"en_US"===Crm.userDetails.COUNTRY_LOCALE&&n.startsWith("(")&&n.includes(")")&&(n=n.replace(/[^a-zA-Z0-9]/g,"")),n&&"Data_Processing_Basis_Details.Data_Processing_Basis"===e.field.api_name&&(n=n.Data_Processing_Basis),"Stage"===e.field.api_name&&"STAGE"===i.$.model.fieldList[r].columnName){for(var l=store.peekRecord("field",i.$.model.fieldList[r].fieldID).pick_list_values,d=[],c=l.length,u=0;u<c;u++)("${OPEN}"!==s||"Open"!==l[u].forecast_type&&"Open"!==l[u].deal_category)&&("${CLOSEDWON}"!==s||"Closed Won"!==l[u].forecast_type&&"Closed Won"!==l[u].deal_category)&&("${CLOSEDLOST}"!==s||"Closed Lost"!==l[u].forecast_type&&"Closed Lost"!==l[u].deal_category)||d.push(l[u].display_value);d.length>0&&(s=d)}if("Tag"===e.field.api_name)switch(Array.isArray(s)||"object"!=typeof s||(s=Array(s)),e.comparator){case"equal":if("${EMPTY}"===s)o=0===n.length;else{var m=s.map((function(e){return e.id})),p=n.map((function(e){return e.id}));o=m.intersection(p).length===m.length}break;case"not_equal":if("${EMPTY}"===s)o=0!==n.length;else{m=s.map((function(e){return e.id})),p=n.map((function(e){return e.id}));o=m.intersection(p).length!==m.length}}else o=a.checkComparator(n,s,e.comparator,i,r,void 0,void 0,void 0,a,!0);return o}},setDatePatternAndPlaceholder:function(){var e=Crm.userDetails.DATE_PATTERN.toUpperCase();this.setData("userDateformat",e.replace(/'/g,""))},getEntityRecordBluePrintProcessInfo:function(e,t){var a=store.peekRecord(moduleRecordMapping[t].id,e,{approved:"both"});return a&&a.$process_flow?a.$.triggerAction("blueprint"):void 0},autoFillAddress:function(e,t){var a,i,r,o,n=this.getData("moduleData.fields"),s=this.getData("apiName");e?(a=t.lookupMod,i=t.fldData,r=t.recData,o=t.moduleName):(a=this.getData("module"),i=this.getData("moduledataUicomp"),r=this.getData("selectedSingle"),o=this.getData("modulenameUicomp"));var l=this.getData("dataBind"),d=n.map((function(e){return e.column_name}));if("Accounts"!==o&&"Contacts"!==o&&!this.isInventoryModule(o)||!a||"Accounts"!==a.api_name&&"Contacts"!==a.api_name||i.custom_field)"Cases"!==o||"Related_To"!==s||i.custom_field||(r&&r.Phone&&!l.Phone&&l.$.set("Phone",r.Phone),r&&r.Email&&!l.Email&&l.$.set("Email",r.Email));else{if(o===a.api_name&&"Accounts"===o)return;for(var c,u,m,p="Accounts"===o||this.isInventoryModule(o)?["BILLINGSTREET","BILLINGCITY","BILLINGSTATE","BILLINGCODE","BILLINGCOUNTRY","SHIPPINGSTREET","SHIPPINGCITY","SHIPPINGSTATE","SHIPPINGCODE","SHIPPINGCOUNTRY"]:["MAILINGSTREET","MAILINGCITY","MAILINGSTATE","MAILINGZIP","MAILINGCOUNTRY","OTHERSTREET","OTHERCITY","OTHERSTATE","OTHERZIP","OTHERCOUNTRY"],f={Mailing_Street:"Billing_Street",Mailing_City:"Billing_City",Mailing_State:"Billing_State",Mailing_Zip:"Billing_Code",Mailing_Country:"Billing_Country",Other_Street:"Shipping_Street",Other_City:"Shipping_City",Other_State:"Shipping_State",Other_Zip:"Shipping_Code",Other_Country:"Shipping_Country",Billing_Street:"Mailing_Street",Billing_City:"Mailing_City",Billing_State:"Mailing_State",Billing_Code:"Mailing_Zip",Billing_Country:"Mailing_Country",Shipping_Street:"Other_Street",Shipping_City:"Other_City",Shipping_State:"Other_State",Shipping_Code:"Other_Zip",Shipping_Country:"Other_Country"},_=p.length,y={},g={},v=0;v<5;v++)if(-1!==(m=d.indexOf(p[v])))if(c=n[m].api_name,this.isInventoryModule(o)&&l.$.set(c,void 0),!r[u=o===a.api_name||this.isInventoryModule(o)&&"Accounts"===a.api_name?c:f[c]]||l[c]&&"Accounts"!==o&&!this.isInventoryModule(o)){if(r[u]){y={};break}}else y[c]=r[u];for(v=5;v<_;v++)if(-1!==(m=d.indexOf(p[v])))if(c=n[m].api_name,this.isInventoryModule(o)&&l.$.set(c,void 0),!r[u=o===a.api_name||this.isInventoryModule(o)&&"Accounts"===a.api_name?c:f[c]]||l[c]&&"Accounts"!==o&&!this.isInventoryModule(o)){if(r[u]){g={};break}}else g[c]=r[u];Object.keys(y).forEach((function(e){l.$.set(e,y[e])})),Object.keys(g).forEach((function(e){l.$.set(e,g[e])}))}this.setCurrencyDetailsonLookupSelect(r,a,this.getData("moduleData"),this.getData("initRoute"),i)},setCurrencyDetailsonLookupSelect:function(e,t,a,i,r,o){var n,s=["Cases","Leads"],l=!1;s.contains(t.module_name)&&s.contains(a.module_name)&&(l=!0),o&&o.isValidCustomLookupField&&(n=o.isValidCustomLookupField);var d=a[this.data.currentInstObjKey].renderedLayoutId;if("edit"!==i&&(n||l||!r.custom_field&&"Contacts"!==a.module_name&&"PARENTACCOUNTID"!==r.column_name&&("Contacts"===t.module_name||"Accounts"===t.module_name))){var c=a.fields.filter((function(e){return"CURRENCYISOCODE"===e.column_name}))[0],u=this.getData("dataBind"),m=!1;if(c&&c.profiles){var p=c.profiles.filter((e=>e.id===Crm.userDetails.PROFILE_ID));void 0!==p&&p.length>0&&(m="read_only"===p[0].permission_type)}var f=!0;if(m&&"Contacts"===t.module_name&&(f=!1),c&&f&&e.Currency&&e.Currency!==u.Currency&&c[d]){u.$.set(c.api_name,e.Currency);var _="crm-create-fields#"+a.module_name+"_fldRow_"+c.column_name+" lyte-dropdown",y=$L(_)[0];y&&y.ltProp({selected:e.Currency,displayValue:e.Currency});var g=c[d].pick_list_values;this.handleDropDownChanges(e.Currency,c.api_name,g);var v="crm-create-fields#"+a.module_name+"_fldRow_"+c.column_name,h=$L(v)[0];if(h&&(validationUtils.isNotEmpty(h.component.data.errorDetails)&&Lyte.Component.set(h.component.data,"errorDetails",{}),!Crm.userDetails.CURRENCY_DETAILS[e.Currency]||!Crm.userDetails.CURRENCY_DETAILS[e.Currency].isActive)){var D={};D.message=I18n.getMsg("crm.currency.active.check"),this.setErrorObject(h,D,!1,c.api_name,!1)}}}},handleLyteCreateAfterModelchanges:function(e,t,a,i){var r="",o=!(!i||!i.isThroughQc)&&i.isThroughQc;switch(a){case"create":r="crm.title.entity.create";break;case"edit":r="crm.title.entity.edit";break;case"clone":r="crm.title.entity.clone"}if(o||this.setTitle(I18n.getMsg(r,[moduleRecordMapping[t].singular_label,Crm.appName])),I18n.properties.COUNTRY_LIST2=I18n.properties.COUNTRY_LIST2.filter((function(e){return null!==e})),e&&!e.isWizard&&e.moduleData&&"team_based"!==e.moduleData.access_type)if(e.layoutDet&&e.layoutDet.length){var n=e.layoutDet[0];n&&!n.visible&&(this.isLayoutPermissionError=!0)}else this.isInvalidLayoutError=!0;if(e&&e.webinarIntegration&&e.webinarIntegration.org&&"Free"===e.webinarIntegration.org.licence)return this.handleWebinarTrialExpiry&&this.handleWebinarTrialExpiry(e,o);if(e&&"Campaigns"===t&&"true"===window.isSandboxAcc&&e.layoutDet&&e.layoutDet[0]&&["webinar","campaign","backstage"].contains(e.layoutDet[0].created_for)){var s={is_Error:!0,errorId:"5",errorFrom:"common",data:{showMsgBandType:"error",showMsgBandContent:I18n.getMsg("crm.campaign.integ.sandbox.not.supported",crmTab.getDisplayName("Campaigns",!1).toLowerCase()),showMsgBandDelay:3e3,transitionRoute:"crm.tab.module.custom-view.list",transitionDynamicParams:["Campaigns",moduleRecordMapping.Campaigns.cvid]}},l={is_Error:!0,errorId:"3",errorFrom:"common",data:{showMsgBandType:s.data.showMsgBandType,showMsgBandContent:s.data.showMsgBandContent,showMsgBandDelay:s.data.showMsgBandDelay}},d={is_Error:!0,errorId:"4",errorFrom:"common",data:{transitionRoute:s.data.transitionRoute,transitionDynamicParams:s.data.transitionDynamicParams}};if(o)return s;this.handleTransitionAbortErrors?(this.handleTransitionAbortErrors(l),this.transition.abort(),this.handleTransitionAbortErrors(d)):(crmui.showMsgBand("error",I18n.getMsg("crm.campaign.integ.sandbox.not.supported",crmTab.getDisplayName("Campaigns",!1).toLowerCase()),3e3),this.transition.abort(),this.transitionTo({route:"crm.tab.module.custom-view.list",dynamicParams:["Campaigns",moduleRecordMapping.Campaigns.cvid]}))}},setExtensionDetails:function(e){let t=$L("crm-create-entity");if(t=t&&t[0],t=t&&t.component,t){let a=t.getData("availableExtensions");a.push(e),t.setData("availableExtensions",a)}},isRowEmpty:function(e,t){let a=e.model.fieldList,i=e[t];if(!i)return!0;for(var r in a)if(a[r].fieldID&&"SERIAL_NUMBER"!==a[r].columnName&&"formula"!=a[r].fieldType){i[r]="string"==typeof i[r]?i[r]&&"[]"==i[r]?"":i[r].trim():i[r];let e=store.peekRecord("field",a[r].fieldID);if(e&&null!==e.default_value&&void 0!==e.default_value)return!1;if(((i[r]||0===i[r])&&"picklist"!==a[r].fieldType&&"fileupload"!==a[r].fieldType||i[r]&&"picklist"===a[r].fieldType&&"-None-"!==i[r]||"fileupload"===a[r].fieldType&&i[r]&&0!==!i[r].filter((function(e){return!e.hasOwnProperty("_delete")})).length)&&"true"!==i.removedRow)return!1}return!0},setCscriptSubFormDataForLyte:async function(e,t,a,i,r,o,n,s){var l,d="draft"===a.$state;Crm.userDetails.SUBFORM_PERMISSIONS&&(l=store.peekRecord("module",r));var c=document.querySelector("crm-create-layout"),u=null;if(c&&c.component.data.initialCreatebject)u=c.component.data.initialCreatebject[e];else{var m=document.querySelector("crm-canvas-form");m&&m.component.data.oldRecord&&(u=m.component.data.oldRecord[e])}var p=!(!l||null===u)&&!!(u&&1===u.length&&store.peekRecord(l.id,"object"==typeof u[0]?u[0].id:u[0]).$.isNew||void 0===u);if(CScript.Utils.is_subform_event_enabled()){var f=a[e];g=store.modelFor(r).fieldList,v="#"+i.moduleName+"_SubForm_"+e;let c=$L(v)[0],u=async function(e,t,a,r,o,n){if(g[e]){var s=store.peekRecord("field",g[e].fieldID),l="crm-create-subformfields#"+i.moduleName+"_"+r+"_R"+(o+1)+"_"+e;let p=$L(l+" lyte-input")[0];if(s&&(!s.read_only||s.isCscriptReadOnly||p&&p.component&&p.component.getData("isCscriptReadOnly"))&&s.visible){var d=null;"Price_Book_Name"===e&&(d="crm-create-subformfields#"+i.moduleName+"_"+r+"_R"+(o+1)+"_List_Price");var u={key:e,value:t,fldInfo:s,dataBind:a,moduleName:i.moduleName,fromSubform:!0,subSelector:l,isWizard:i.isWizard,depFieldSel:d,cscriptFullFormData:n};a.skipCscriptTrigger=e,await Lyte.registeredMixins["crm-create-mixin"].setCscriptDataForLyte(u);var m=$L(l)[0];m&&m.component&&(c&&c.component&&c.component.setData("isaddbutnClicked",!1),await m.component.didConnect(),m.component.setData("isPreventCScriptExecution",!1)),Lyte.Component.set(a,"show",!0),delete a.skipCscriptTrigger}}};L=async function(e,t,a,i){for(let r in e)await u(r,e[r],t,a,i,e)};var _=async function(t,a){if(!f[a]&&c.component.getData("maximumRows")>a&&(!l||l&&l.creatable))if(c)await c.component.createnewRow(c.querySelector("#addbutnSub"),void 0,void 0,!0);else if(!c&&i.isWizard){var r=f.model&&f.model._name,o=store.createRecord(r,{},!0);o.show=!0,f.push(o)}f[a]&&(!l||l&&(!f[a].$.isNew&&l.editable||f[a].$.isNew&&l.creatable))&&L.call(this,t,f[a],e,a)};switch(n){case"add":if(t&&t.length){if(void 0!==o&&(o>a[e].length||o<0))throw CScript.Error("Index out of range");o=void 0!==o?o:1===a[e].length?0:a[e].length,o=1===a[e].length&&0===o?Lyte.registeredMixins["crm-create-mixin"].isRowEmpty(a[e],o)?o:o+1:o;let i=t.length,r=f.length,n=c.querySelector("#addbutnSub");for(let e=1==r&&0==o?1:0;e<i;e++)c.component.createnewRow(n,void 0,void 0,!0);for(let i=a[e].length-1;i>=o;i--)L.call(this,f[i-t.length],f[i],e,i);for(let a=0;a<i;a++)L.call(this,t[a],f[o+a],e,o+a)}break;case"write":t&&t.length&&await t.forEach(_.bind(this));break;case"writeRow":await _(t,o);break;case"writeCell":if(!l||l&&l.editable){u(s,t,f[o],e,o);break}break;default:D=Array.isArray(t);if(null===t||D&&!t.length&&(!l||l&&(!a.$.isNew&&!d&&!p&&l.deletable||(a.$.isNew||d||p)&&l.creatable)))c&&c.component.deleteRows();else if(D)for(const[a,r]of t.entries()){if(!f[a]&&c.component.getData("maximumRows")>a&&(!l||l&&l.creatable))if(c)await c.component.createnewRow(c.querySelector("#addbutnSub"),void 0,void 0,!0);else if(!c&&i.isWizard){let e=!1;for(let t of Object.keys(r))if(g[t]){e=!0;break}if(e){I=f.model&&f.model._name;(C=store.createRecord(I,{},!0)).show=!0,f.push(C)}}f[a]&&(!l||l&&(!f[a].$.isNew&&l.editable||f[a].$.isNew&&l.creatable))&&await L.call(this,r,f[a],e,a)}}}else{var y=a[e],g=store.modelFor(r).fieldList,v="#"+i.moduleName+"_SubForm_"+e,h=$L(v)[0],D=Array.isArray(t);if(Crm.userDetails.isSubformNewComponentEnabled&&h){await h.component.showAllRows();var b=[];y.filter((function(e){b.push(e.id?e.id:e.$.pK)})),h.setData("cacheRecordIds",b)}if(null===t||D&&!t.length&&(!l||l&&(!a.$.isNew&&!d&&!p&&l.deletable||(a.$.isNew||d||p)&&l.creatable)))h.component.deleteRows();else if(D){var L=async function(e,t,a,r){for(const[c,u]of Object.entries(e))if(g[c]){var o=store.peekRecord("field",g[c].fieldID);if(o&&!o.read_only&&o.visible){var n;if("PRODUCTID"===o.column_name&&t&&t.hasOwnProperty("$clone_reference_id")){let e=t[c],a=u;e&&a&&e.id&&a.id&&e.id!==a.id&&(n=!0)}Lyte.Component.set(t,"show",!0);var s="crm-create-subformfields#"+i.moduleName+"_"+a+"_R"+(r+1)+"_"+c,l={key:c,value:u,fldInfo:o,dataBind:t,moduleName:i.moduleName,fromSubform:!0,subSelector:s,isWizard:i.isWizard,cscriptFullFormData:e};await this.setCscriptDataForLyte(l);var d=$L(s)[0];if(d&&d.component){h&&h.component&&h.component.setData("isaddbutnClicked",!1),d.component.didConnect(),(d.component.data||{}).isdefaultInvSubform&&n&&delete t.$clone_reference_id,"TAX"===o.column_name&&d.component.updateTaxValueFromCScript(e,t,o)}}}};for(const[a,r]of t.entries()){if(!y[a]&&(!l||l&&l.creatable))if(h)await h.component.createnewRow(h.querySelector("#addbutnSub"),void 0,void 0,!0);else if(!h&&i.isWizard){let e=!1;for(let t of Object.keys(r))if(g[t]){e=!0;break}if(e){var C,I=y.model&&y.model._name;(C=store.createRecord(I,{},!0)).show=!0,y.push(C)}}y[a]&&(!l||l&&(!y[a].$.isNew&&l.editable||y[a].$.isNew&&l.creatable))&&await L.call(this,r,y[a],e,a)}}}},cscriptFOLWrapper:async function(e){try{commonUtils.showHideLoadingDiv(!0);var t,a=moduleRecordMapping[e.formModuleName]&&moduleRecordMapping[e.formModuleName].id;if(e.fromSubform){var i=e.subSelector+" crm-create-fields",r=$L(e.subSelector)[0],o=$L(i)[0];if(o){var n=o.component.data.moduledataUicomp;if(r){var s=r.component.data,l=s.subformFields;if(l&&(!s.associationDetails||!s.associationDetails.contains(l.api_name)))return void commonUtils.showHideLoadingDiv()}a===(t=n.lookup&&n.lookup.module.id)||store.modelFor(t)||await store.findRecord("module",t);var d=store.peekRecord(t,e.fieldValue.id);d||await store.findRecord(t,e.fieldValue.id),d=store.peekRecord(t,e.fieldValue.id),o.component.getMethods("onSubformLookupSelected")&&(o.component.executeMethod("onSubformLookupSelected",d,void 0,!0),o.component.setData("editInit",!0))}}else{var c=e.fldInfo||{},u="crm-create-fields#"+e.formModuleName+"_fldRow_"+c.column_name,m=$L(u)[0];if(m){var p,f=m.component.data;if(!f.associationDetails||!f.associationDetails.contains(f.apiName))return void commonUtils.showHideLoadingDiv();if(t=c.lookup&&c.lookup.module.id,validationUtils.isEmpty(f.module))a===t?p=moduleRecordMapping[e.formModuleName]:(store.modelFor(t)||await store.findRecord("module",t),p=store.peekRecord("module",t)),m.setData("module",p);store.peekRecord(t,e.fieldValue.id)||await store.findRecord(t,e.fieldValue.id),await m.component.fieldsOfLookupWrapper()}}commonUtils.showHideLoadingDiv(!1)}catch(e){return murphy.error(e),void commonUtils.showHideLoadingDiv(!1)}},deleteSubformRowHandler:function(e,t,a){var i=e.component.data,r=i.moduleName||i.module_name;let o=$L("#"+r+"_SubForm_"+t)[0].component;o&&o.actions.deleteRow(o,a)},isValidJSON:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},getSubformJSONdata:function(e,t){let a=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript(),i=a&&a.component&&a.component.data,r=i.currentInstObjKey,o=store.peekRecord(e,t),n=o.$.toJSON(),s="clone"===i.initRoute?"create":i.initRoute,l=store.modelFor(e).fieldList;if(validationUtils.isNotEmpty(o.$.error)){var d=o.$.error;for(var c in d)n[c]=d[c]?d[c].value:n[c]}var u=o.lookupError||{};for(var c in u)n[c]&&(n[c]=null);if(l){for(var m in l){var p=!0;if(l[m]&&l[m].fieldID){var f=store.peekRecord("field",l[m].fieldID);if("datetime"===l[m].fieldType&&n[m]&&n[m].indexOf("TV")>-1){var _=n[m].split("TV");2===_.length&&(n[m]=_[0]+" "+_[1])}"picklist"===l[m].fieldType&&"-None-"===n[m]&&(n[m]=null),"multiselectpicklist"===l[m].fieldType&&n[m]&&"string"==typeof n[m]&&Lyte.registeredMixins["crm-create-mixin"].isValidJSON(n[m])&&(n[m]=JSON.parse(n[m])),f&&f.view_type[s]&&Lyte.Component.registeredHelpers.isValidCreateField(f,i.initRoute,i.moduleData.module_name)||(delete n[m],p=!1)}else delete n[m],p=!1;p&&(n.hasOwnProperty(m)?void 0===n[m]&&(n[m]=null):n[m]=null);let e=i.moduleData[r].renderedLayoutId;!e||f&&f.hasOwnProperty(e)||delete n[m]}return n}return n},dispatchSubformEvents:function(e,t){if(Crm.userDetails.SUBFORM_BULK_SUPPORT&&this.data.isfromBulkaddition&&(this.data.isPreventCScriptExecution=!0),this.clearCscriptFldInlineError(this),CScriptLib&&!this.getData("preventSubformCscriptExecution")&&(void 0===this.getData("isPreventCScriptExecution")||!this.getData("isPreventCScriptExecution"))&&(void 0===this.getData("subformFields.preventCScriptTrigger")||!this.getData("subformFields.preventCScriptTrigger"))){let a=this.getData("parentSubformdata").fields.find((e=>"subform"===e.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===e.data_type)).id;CScript.Engine.Global.dispatchEvent(e,a,this.getData("subformFields").api_name,t,this.getData("indexVal"))}this.setData("isPreventCScriptExecution",!1),this.setData("subformFields.preventCScriptTrigger",!1)},setCscriptDataForLyte:async function(e){var t,{layoutCompData:a,rowIndex:i,cscriptFullFormData:r,key:o,value:n,fldInfo:s,dataBind:l,moduleName:d,fromSubform:c,depFieldSel:u,subSelector:m,source:p,isWizard:f}=e;if(a=a||{},!(f&&s&&s.isWizardCRSetValue)){var _=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript();_&&_.component&&_.component.data&&(t=_.component.data.currentInstObjKey);var y=async function(e,t,a){var u;u=c&&a?a:"crm-create-fields#"+d+"_fldRow_"+s.column_name;var m=$L(u)[0];if(m){var y=m.component.data,g=y.currentInstObjKey;if(e){var v=m.component.filterValidPickListValues(y.currentLayout,y.subformFields?y.subformFields:y.moduledataUicomp);if("string"==typeof n){var h=v.filter((function(e){return e.display_value===n}))[0];if(!h&&"skyEye"===p){var D=y.initialPicklistdata||[],b=(D=Lyte.deepCopyObject(D)).filter((function(e){return e.display_value===n}))[0];if(b)h=b;else{var L=Lyte.deepCopyObject(v[0]);L.actual_value=L.display_value=n;var C=["display_value","actual_value","maps","type"];for(var I in L)C.contains(I)||delete L[I];for(var E=L.maps?L.maps.length:0,R=0;R<E;R++)L.maps[R].pick_list_values=[];D.push(L),h=L}m.setData("initialPicklistdata",D)}if(h){if(t){var S=y.subformFields,F=y.currentLayout.split(";")[0];m.setData("initialPicklistdata",this.setinitialPicklistdata(S,y.moduleData[g].currencyData,n,y.initRoute,S[F]?S[F].pick_list_values:S.pick_list_values)),l.skipCscriptTrigger=o}l.$.set(o,n),t||m.component.handleEntityRecordChanges(y.cadditionalFielddata,y.dataBind),m.getMethods("getDropdownvalue")&&(delete l.skipCscriptTrigger,m.component.executeMethod("getDropdownvalue",{},n,!0))}}else{if(($=v.filter((function(e){return n.contains(e.display_value)})).mapByKey("display_value")).length){if(t){S=y.subformFields,F=y.currentLayout.split(";")[0];m.setData("initialPicklistdata",this.setinitialPicklistdata(S,y.moduleData[g].currencyData,JSON.stringify($),y.initRoute,S[F]?S[F].pick_list_values:S.pick_list_values))}l.$.set(o,JSON.stringify($))}else n&&!n.length&&l.$.set(o,JSON.stringify([]))}}else m.component.handleEntityRecordChanges(y.cadditionalFielddata,y.dataBind)}else{let t;if(_&&_.component&&_.component.data&&(t=_.component.data.currentInstObjKey),f&&e&&s){let e=s[t].orginalPicklistdata,u=_.component.data.layoutId||Lyte.Router.getRouteInstance().transition.info.queryParams.layoutId;if(e||(e=_.component.filterValidPickListValues(u,s)),"string"==typeof n){var O=e.find((e=>e.display_value===n));if(O&&(l.$.set(o,n),"Currency"!==s.api_name&&"Stage"!==s.api_name||this.handleDropDownChanges.call(_.component,n,s.api_name,e),O.maps&&O.maps.length))for(const e of O.maps){var k=store.modelFor(l.$.model._name).fieldList,w=e.api_name,N=k[w]&&k[w].fieldID,T=store.peekRecord("field",N);if(e.pick_list_values&&e.pick_list_values.length&&T){const o=$L("crm-create-fields#"+d+"_fldRow_"+T.column_name)[0];var M=T.pick_list_values.filter((t=>e.pick_list_values.some((e=>e.id===t.id))));if("picklist"===T.data_type&&(!T.read_only||T[t].isCscriptReadOnly)&&T.visible&&(o&&Lyte.Component.set(o.component.data.moduledataUicomp[t],"dpick_list_values",M),!M.some((e=>e.display_value===l[w])))){var P={key:w,value:e.pick_list_values[0].display_value,fldInfo:T,dataBind:l,moduleName:d,fromSubform:c,subSelector:a,source:p,isWizard:f,cscriptFullFormData:r,rowIndex:i};await Lyte.registeredMixins["crm-create-mixin"].setCscriptDataForLyte(P)}"multiselectpicklist"===T.data_type&&(T.read_only&&!T[t].isCscriptReadOnly||!T.visible||o&&Lyte.Component.set(o.component.data.moduledataUicomp[t],"dpick_list_values",M))}}}else if(Array.isArray(n)){var $=e.filter((function(e){return n.contains(e.display_value)})).mapByKey("display_value");$.length?l.$.set(o,JSON.stringify($)):n&&!n.length&&l.$.set(o,JSON.stringify([]))}}}};if(s)switch(s[t]||(s[t]={}),s.data_type){case"userlookup":case"ownerlookup":if(n&&n.id){const e=store.peekRecord("user",n.id)||(await store.findRecord("user",n.id))[0];if(e){var g={id:e.id,full_name:e.full_name||e.name};if(!l[o]||!$u.isEqual(Lyte.deepCopyObject(l[o]),g)){l.$.set(o,g),await y.call(this);var v=store.peekRecord("user",g.id),h="crm-create-fields#"+d+"_fldRow_"+s.column_name,D=$L(h)[0];D&&D.component&&D.component.executeUserFieldsofLookup&&D.component.executeUserFieldsofLookup(v)}}}else if(!n){let e;l.$.set(o,void 0),c?m&&($L(m)[0].component.data.databindSubform.$.set(o,void 0),e=$L(m+" crux-user-dropdown")[0]):e=$L("crm-create-fields#"+d+"_fldRow_"+s.column_name+" crux-user-dropdown")[0],e&&e.component.setData("cxPropSelectedUser",void 0)}break;case"multiuserlookup":case"multiselectlookup":break;case"lookup":if(n&&n.name&&n.id){g={id:n.id,name:n.name};if(l.$.set(o,g),await y.call(this,void 0,c,m),await this.cscriptFOLWrapper({formModuleName:d,fieldApiname:o,fromSubform:c,subSelector:m,fldInfo:s,currentInstObjKey:t,fieldValue:g}),"BOOKID"===s.column_name&&(n&&(n.priceBookRecid=n.id,n.priceBookName=n.name),u)){$(u)[0].component.executeMethod("onInventoryPriceBookSel",n)}if(!c){let e=_.component,t=store.peekRecord("module",s.lookup.module.id),a={module:d,listRelationId:s.lookup.id,fillUpModule:t.module_name,entityid:n.id,relmodule:t.module_name,entityname:n.name},i=e.getRelatedlistapiname(a);if(!i)break;store.modelFor(t.id)?e.setLookupRelatedRecord(a,i,"cscript"):store.findRecord("module",t.id).then((function(){e.setLookupRelatedRecord(a,i,"cscript")}))}}else if(!n){l.$.set(o,void 0);let e,a="crm-create-fields#"+d+"_fldRow_"+s.column_name;if(c){if(m){e=$L(`${m} ${a}`)[0]}}else Lyte.Component.set(s[t],"lookupSingle",""),Lyte.Component.set(s[t],"selectedId",""),e=$L(a)[0];e&&e.setData({lookupSingle:"",selectedSingle:{},selectedSingleId:""})}break;case"multiselectpicklist":Array.isArray(n)&&await y.call(this,!0,c,m);break;case"picklist":(n=n&&"string"==typeof n&&n.trim()?n:"-None-")&&"string"==typeof n&&await y.call(this,!0,c,m);break;case"integer":case"currency":case"double":if("DISCOUNT"===s.column_name&&c&&_&&_.component&&_.component.isInventoryModule(d)){let e={fieldApiName:o,recordData:l,isGrandDiscount:!1,currentPage:a.initRoute,moduleName:d,fromSubform:c,source:p,value:n,isWizard:f,cscriptFullFormData:r,layoutCompData:a,discFieldSelector:m,currentRow:null!=i?i+1:""};await this.cScriptDiscountFieldHandler(e);break}0===n||n&&!isNaN(n)?"currency"===s.data_type||"double"===s.data_type?l.$.set(o,Number(Number(n).toFixed(s.decimal_place))):l.$.set(o,Number(n)):null===n&&l.$.set(o,n),"PROBABILITY"!==s.column_name&&"AMOUNT"!==s.column_name||_&&this.setExpectedRevenue.call(_.component);break;case"boolean":l.$.set(o,n+""=="true");break;case"datetime":var b=$L.moment(apiDateTimeFormat(n));if("skyEye"===p&&(b=$L.moment(apiDateFormat(n))),b){s[t].isSetValueFromScript=!0;var L=this.getDateTimeForForm(b.getDObj(),!0);""===n&&(L=""),l.$.set(o,L),delete s[t].isSetValueFromScript;var C={};C.moduleName=d,C.value=L,C.fldMeta=s,this.triggerCScriptUIUpdate(C)}break;case"fileupload":null==n&&Lyte.registeredMixins["crm-uploadfields-mixin"].setFileUploadEmptyViaCScript(s.id,c,m);break;case"imageupload":if(null==n)for(var I=$L("crux-image-component"),E=I.length,R=0;R<E;R++){var S=I[R].component;if(S.data.cxPropField.id===s.id)for(var F=$L(".cxMultiImageSelector_label_"+S.data.cxPropField.column_name).find("div"),O=F.length,k=0;k<O;k++)F.eq(k).find(".cxImgCompDeleteIcon").click()}break;default:if(s[t].isSetValueFromScript=!0,"string"===s.json_type){if(n=null!=n?""+n:"",l.$.set(o,n.slice(0,s.length)),3===s.ui_type||110===s.ui_type){let e="#Crm_"+d+"_"+s.column_name,t=$L(e)[0];t&&t.component&&t.component.increaseHeight(!0)}}else l.$.set(o,n);delete s[t].isSetValueFromScript}}},dateFormatCheck:function(e){const t=e.slice(0,e.indexOf(")")),a=t.split(",").length-1;if(3===a){let e=t.indexOf(",",t.indexOf(",")+1);return[t.slice(0,e).trim(),t.slice(e+1).trim()]}if(1===a)return t.split(",");throw CScript.Error("The given date range has an improper number of commas.")},executeCscriptSubformHandlers:function(e,t){const{api_name:a,field_name:i,criteria:r,config:o,value:n}=t;var s=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript();if(s&&t){const h=s.component.data,D=h.moduleData.fields.find((e=>e.api_name===a)),b=i&&D.subformFields.find((e=>!e.subform&&e.api_name===i));if(D){switch(e){case"get":return{api_name:a};case"get_field":return{api_name:i,parent:a};case"set_criteria":{let e=D.subformFields;if(!e&&h.isWizard){let t=store.peekAll("wizard-segment").find((e=>"subforms"===e.type&&e.subformApiName===D.api_name));e=t&&t.fields||[]}switch(b.ui_type){case 133:case 444:return new Promise((async(e,t)=>{try{await CriteriaHandler.init(Object.keys(moduleApiMapping).find((e=>moduleApiMapping[e]===b.lookup.module.api_name))),CriteriaHandler.validate(r),b.$.set({criteria:{criteria:r,criteriaObj:[...CriteriaHandler.convert_to_search_criteria_json(r,"adv_lookup_criteria")],config:o}}),e(!0)}catch(e){throw t(e),e}}));case 2:case 100:CriteriaHandler.generic_validate(r,10,new Set(["starts_with","in","equals","ends_with","contains","not_equals"]),new Set(["id","actual_value","display_value"]));let e=CriteriaHandler.generic_filter(b.pick_list_values,r,new Set(["id","actual_value","display_value"])),t=b[h.currentInstObjKey].orginalPicklistdata||b[h.currentInstObjKey].pick_list_values;e=e.map((e=>t.find((t=>t.id===e.id))));let a=b[h.currentInstObjKey].orginalPicklistdata;a=a&&a.length?a:b.pick_list_values;const i=a.find((e=>"-None-"===e.display_value));var l=i?[i,...e]:e;Lyte.Component.set(b[h.currentInstObjKey],"dpick_list_values",l);break;default:throw CScript.Error("action supported only for lookup, picklist fields")}}case"set_readonly":(!b.$.get("read_only")||b.$.get("read_only")&&b.$.get("isCscriptReadOnly"))&&(b.$.set("read_only",t.value),b.$.set("isCscriptReadOnly",t.value),b.read_only&&b.ui_type!==CrmField.UITYPES.FORMULA&&Lyte.objectUtils(b[h.currentInstObjKey].lyteCreate_tableObj,"add","readOnlyTooltip",I18n.getMsg("crm.lable.read.only")));break;case"set_cell_readonly":if(!0!==b.$.get("read_only")){let e=$L("crm-canvas-form").length,i=h.moduleName||h.module_name,r="crm-create-subformfields#"+i+"_"+t.api_name+"_R"+(t.index+1)+"_"+t.field_name,o=$L(r);o=o&&o[0],o||(Lyte.Component.set(h.dataBind[a][t.index],"show",!0),o=$L(r),o=o&&o[0]);let s="crm-create-subformfields#"+i+"_"+t.api_name+"_R"+(t.index+1)+"_"+t.field_name;e||(s+=" crm-create-fields");let l,d=$L(s);switch(d=d&&d[0],o.component.setData({clientScriptErrorClass:n?"readonlyF lyteInputDisabled lyteInputReadonly":"",isCScriptReadOnly:n}),o&&o.component&&o.component.getData("subformFields.data_type")){case"lookup":d.setData("isCScriptReadOnly",n),l="crm-create-subformfields#"+i+"_"+t.api_name+"_R"+(t.index+1)+"_"+t.field_name+" lyte-autocomplete";break;case"userlookup":case"multiselectpicklist":case"picklist":l="crm-create-subformfields#"+i+"_"+t.api_name+"_R"+(t.index+1)+"_"+t.field_name+" lyte-dropdown";break;case"fileupload":$L(o).find("crux-file-upload-component")[0].component.setData("cxPropReadonly",n);break;default:l="crm-create-subformfields#"+i+"_"+t.api_name+"_R"+(t.index+1)+"_"+t.field_name+" lyte-input"}let c=$L(l);c=c&&c[0],c&&c.component&&(c.ltProp("disabled",n),c.ltProp("readonly",n)),c&&c.component.setData({"lt-prop-title":n?I18n.getMsg("crm.lable.read.only"):""})}break;case"set_mandatory":try{let e=h.dataBind||h.record,r=store.modelFor(e[a].model._name).fieldList[i],o=e[t.api_name][0].$.model,n=store.modelFor(o._name).fieldList[i];if(!(b.$.get("required")&&void 0===b.$.get("isCscriptMandatory"))&&r.mandatory!==t.value){r.mandatory=t.value,(c=(c=$L("#"+h.moduleName+"_SubForm_"+t.api_name))&&c[0])&&c.component.data.cscriptMandatoryFlds.findIndex((e=>e.api_name===t.field_name))<0&&Lyte.arrayUtils(c.component.data.cscriptMandatoryFlds,"push",b),b.$.set({required:t.value,isCscriptMandatory:t.value});let e=D.section[0].fields.find((e=>e[h.currentInstObjKey].lyteCreate_tableObj&&e.api_name===i)),a=e[h.currentInstObjKey].lyteCreate_tableObj.thClass;let s=Crm.userDetails.isMandatorySubFormEnabled?" newmandatory":" mandatoryforothrs";Lyte.objectUtils(e[h.currentInstObjKey].lyteCreate_tableObj,"add","thClass",t.value?a+s:a.split(s).join("")),n.mandatory=t.value,store.addField(o._name,i,n.type,n)}}catch(e){throw CScript.Error(`No ${i} field present in the  ${a} subform`)}break;case"set_visible":if(Crm.userDetails.CSCRIPT_SUBFORM_EVENTS||Crm.userDetails.CSCRIPT_SUBFORM_FIELD_SET_VISIBLE_FUNCTION)try{var d="boolean"==typeof n?n:"true"===n.toLowerCase();let e=h.moduleName||h.module_name,r=$L("crm-canvas-form").length;var c,u;if((c=$L("#"+e+"_SubForm_"+t.api_name))&&c[0]){r&&(u=c.closest(".zcanvassection"));var m=(c=c[0]).getData("actualSubformFields"),p=-1,f=d,_=c.getData("currentInstObjKey");if(m.forEach((function(e,t){e.api_name===i?p=t:(!e[_].hasOwnProperty("isFldVisibleOnCscript")||e[_].hasOwnProperty("isFldVisibleOnCscript")&&e[_].isFldVisibleOnCscript)&&(f=!0)})),!(p>=0))throw CScript.Error(`No ${i} field present in the  ${a} subform`);if(Lyte.Component.set(m[p][_],"isFldVisibleOnCscript",d),r){Lyte.Component.set(c.getData("moduleData")[_],"isSectionHideOnCScript",!f);var y=!c.getData("moduleData")[_].isSectionHideOnLayoutRules;Lyte.registeredMixins["crm-canvas-view-rules"].handlingShowOrhideFld(u,f&&y)}else Lyte.Component.set(c.getData("sectionsCurntInstObj"),"isHiddenOnCScript",!f)}}catch(e){throw murphy.error(e),CScript.Error(`No ${i} field present in the  ${a} subform`)}break;case"set_row_readonly":if(Crm.userDetails.CSCRIPT_SUBFORM_EVENTS||Crm.userDetails.CSCRIPT_SUBFORM_ROW_LOCK_FUNCTION){var g=h.dataBind||h.record;g[a][t.index].hasOwnProperty("$lockedRow")&&Object.defineProperty(g[a][t.index],"$lockedRow",{writable:!0,configurable:!1}),Lyte.Component.set(g[a][t.index],"$lockedRow",n)}break;case"set_info":{let e=D.section[0].fields.find((e=>e.api_name===i));if(!e)throw CScript.Error(`No ${i} field present in the  ${a} subform`);if(!e[h.currentInstObjKey].lyteCreate_tableObj)throw CScript.Error(`Unsupported action 'set_info' for ${i} field`);e.$.set("tooltip",{name:"Info Icon",value:t.value});break}case"set_error":{let e="crm-create-subformfields#"+(h.moduleName||h.module_name)+"_"+t.api_name+"_R"+(t.index+1)+"_"+t.field_name;var v={code:"ERR02",isError:!0,message:$ESAPI.encoder().encodeForHTML(t.message),isCscriptError:!0};let a=$L(e)[0];a&&a.component.setData("errorDetails",v);break}}return!0}throw CScript.Error("No such subform present: "+a)}return!1},executeCscriptUIHandlers:function(e,t){var a,i=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript();if(i&&t){var r=i.component.data,o=r.dataBind,n="crm-create-fields#"+r.moduleData.module_name+"_fldRow_";a=r.currentInstObjKey;var s=r.moduleData.fields.find((e=>e.api_name===t.field_name)),l=store.modelFor(r.moduleData.id).fieldList[t.field_name],d=r.moduleData[a]||{};if("setRequired"===e&&("string"==typeof t.value&&(t.value="true"===t.value),e=t.value?"MANDATE":"UNMANDATE"),"subform"===s.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===s.data_type)throw s=s.subformFields.find((e=>e.api_name===t.subform_field_name)),CScript.Error("Visibility"!==e?"Unsupported action":"visibility action cannot be applied for subform");if(s){const{ui_type:p}=s,f=Lyte.Router.getRouteInstance().transition.info.queryParams.layoutId;switch(e){case"ERROR":var c={code:"ERR02",isError:!0,message:$ESAPI.encoder().encodeForHTML(t.message),isCscriptError:!0};if(Lyte.Component.set(s[a],"errorDetails",c),!i.component.data.setErrorForFirstCscriptErrorField){let e=$L(n+s.column_name);e=e&&e[0],i.component.data.setErrorForFirstCscriptErrorField=!0,this.focusErrorField({firstErrorfield:e})}break;case"MANDATE":if(l&&(!l.mandatory||s[a].isMandateByRules)){if(Lyte.Component.set(s[a],"isCscriptMandatory",!0),l.mandatory)break;if(l.mandatory=!0,s.$.set({required:!0}),l.validation||"imageupload"===s.data_type||"fileupload"===s.data_type||(l.validation="emptyValueValidation"),store.addField(r.moduleData.id,t.field_name,l.type,l),"picklist"===s.data_type){let e=i.getData("dataBind");"-None-"===e[t.field_name]&&Lyte.Component.set(e,t.field_name,"")}if(Lyte.Component.set(s[a],"isHiddenViaAccesiblity",!1),r.mandatoryStyleCheck){var u=$L("crm-create-layout")[0];Lyte.Component.set(u.getData("messageBox"),"showWarning",!0)}}break;case"UNMANDATE":if(l&&(l.mandatory||s.required)&&s[a].isCscriptMandatory){if(Lyte.Component.set(s[a],"isCscriptMandatory",!1),s[a].isMandateByRules)break;if(l.mandatory=!1,s.$.set({required:!1}),Lyte.Component.set(s[a],"errorDetails",{}),store.addField(r.moduleData.id,t.field_name,l.type,l),"picklist"===s.data_type){let e=i.getData("dataBind");e[t.field_name]||"STAGE"===l.columnName||Lyte.Component.set(e,t.field_name,"-None-")}}if(r.mandatoryStyleCheck){Lyte.Component.set(s[a],"isHiddenViaAccesiblity",!0);u=$L("crm-create-layout")[0];Lyte.Component.set(u.getData("messageBox"),"showWarning",!0)}break;case"MaxLength":if(l){if("fileupload"===s.data_type||"imageupload"===s.data_type)throw CScript.Error("Unsupported action");l.length=t.value,s.$.set("length",t.value)}break;case"ReadOnly":if(l&&!s[a].isSystemReadOnly){if("string"==typeof t.value&&(t.value="true"===t.value),Lyte.Component.set(s[a],"isCscriptReadOnly",t.value),s[a].isReadOnlyByRules)break;if("PRICINGDETAILS"===s.column_name){let e=$L("crm-create-pricingdetails")[0];e&&e.component.setData("isPricingDetailsReadonly",t.value)}if(s.required&&!s.read_only&&(l.mandatory=!0,store.addField(r.moduleData.id,t.field_name,l.type,l)),l.field_validation&&Lyte.Component.set(s[a],"field_validation",!t.value),!1===t.value&&("picklist"===s.data_type||"multiselectpicklist"===s.data_type)){let e=d.moduleMapDepSupportedFields||{},t=[];Object.entries(e).forEach((e=>{e[0]&&e[1]&&e[1].childFields&&e[1].childFields.length&&e[1].childFields.includes(s.api_name)&&t.push(e[0])})),t.forEach((t=>{let a=n+e[t].fieldColumnName,i=$L(a)[0];i&&i.component&&i.component.getMethods("getDropdownvalue")&&i.component.executeMethod("getDropdownvalue",{},o[t],!0)}))}if(r.mandatoryStyleCheck){u=$L("crm-create-layout")[0];Lyte.Component.set(u.getData("messageBox"),"showWarning",!0)}}break;case"Visibility":if(l){let e=!!t.value;if(Lyte.Component.set(s[a],"isCscriptHidden",!e),e){const e=$L(n+s.column_name)[0];e&&validationUtils.isNotEmpty(e.component.data.errorDetails)&&Lyte.Component.set(e.component.data,"errorDetails",{})}let i=$L("crm-create-layout")[0];i&&i.component&&i.component.setData("changesInFieldVisibility",!0),r.mandatoryStyleCheck&&Lyte.Component.set(i.getData("messageBox"),"showWarning",!0)}break;case"Info":s.$.set("tooltip",null===t.value?null:{name:"Info Icon",value:`${t.value}`});break;case"Title":Lyte.Component.set(s[a],"fieldTooltipvalue",t.value);break;case"SetCriteria":let e=t.criteria;switch(p){case 8:case 445:case 221:return new Promise((async(a,i)=>{try{await CriteriaHandler.init("Users"),CriteriaHandler.validate(e);const i=CriteriaHandler.convert_to_search_criteria(CriteriaHandler.convert_to_filter_criteria(e,"lookup_criteria"),"lookup_criteria");s.$.set({userSearchCriteria:{criteria:e,config:t.config,userCriteria:[...CriteriaHandler.convert_to_search_criteria_json(i,"lookup_criteria")]}}),a(!0)}catch(e){throw i(e),e}}));case 133:case 444:return new Promise((async(a,i)=>{try{const i=s.lookup.module?s.lookup.module.api_name:s.multiselectlookup.connected_module.api_name;await CriteriaHandler.init(Object.keys(moduleApiMapping).find((e=>moduleApiMapping[e]===i))),CriteriaHandler.validate(e),s.$.set({criteria:{criteria:e,criteriaObj:[...CriteriaHandler.convert_to_search_criteria_json(e,"adv_lookup_criteria")],config:t.config}}),a(!0)}catch(e){throw i(e),e}}));case 2:case 26:case 100:CriteriaHandler.generic_validate(e,10,new Set(["starts_with","in","equals","ends_with","contains","not_equals"]),new Set(["id","actual_value","display_value"]));let i=CriteriaHandler.generic_filter(store.peekRecord("layout",f).fields.find((e=>e.id===s.id)).pick_list_values,e,new Set(["id","actual_value","display_value"]));i=i.map((e=>s[a].orginalPicklistdata.find((t=>t.id===e.id))));let r=s[a].orginalPicklistdata;r=r&&r.length?r:s.pick_list_values;const o=r.find((e=>"-None-"===e.display_value));var m=o?[o,...i]:i;Lyte.Component.set(s[a],"dpick_list_values",m);break;case 24:case 202:case 333:CriteriaHandler.generic_validate(e,1,new Set(["between"]),new Set(["value"]));const n=e.split(":between:")[1],[l="any",d="any"]=this.dateFormatCheck(n),c=Crm.userDetails.DATE_PATTERN.toUpperCase();if("any"!==l&&!$L.moment(l,c)._isValid||"any"!==d&&!$L.moment(d,c)._isValid)throw CScript.Error("improper date format");s.$.set({..."any"!==l&&{minValue:l},..."any"!==d&&{maxValue:d}});break;default:throw CScript.Error("action supported only for lookup, picklist and date fields")}break;case"SetSuggestions":if(!crmTemplate.onTypesSupportedFields.has(`${p}`))throw CScript.Error("action supported only for text fields");s.$.set({suggestions:{minLength:2,method:"startsWith",displayField:"name",idField:"value",content:t.suggestions.map((e=>({name:e,value:e}))),enable:!0}});break;case"GetSuggestions":const{suggestions:_}=s;return _&&_.content&&_.content.length?_.content.map((e=>e.name)):null;case"GetOptions":if([2,100,26].includes(p)){const e=new Set((s[a].dpick_list_values||s.pick_list_values).map((e=>e.id)));let t=s[a].orginalPicklistdata;return t||(t=i.component.filterValidPickListValues(f,s)),t.map((({id:t,display_value:a,actual_value:i})=>({..."-None-"!==i&&{id:t,filtered:!e.has(t)},display_value:a,actual_value:i})))}throw CScript.Error("action supported only for picklist and multiselect picklist fields");case"SetWdFolderPath":s.$.set("workdrive_folder_id_"+r.initRoute,t.folderId)}return!0}throw CScript.Error("no such field present - "+t.field_name)}return!1},executeCscriptButtonHandlers:function(e,t,a){var i=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript();if(i){var r=i.querySelector("crm-create-buttons");if(r){var o=r.component.data.buttons;if(o&&o.length){var n;"record_save"===e?n="save":"record_save_and_new"===e?n="saveAndNew":"record_cancel"===e?n="cancel":"record_save_as_draft"===e?n="saveasdraft":"record_screen_back"===e&&(n="screenBack");var s=o.filter((function(e){return e.name===n}))[0];if(s)switch(Lyte.objectUtils(s,"add","fromCS",!0),t){case"Click":var l=r.querySelector("#"+s.id);l&&l.click();break;case"Enable":s.butnDisabled&&Lyte.objectUtils(s,"add","butnDisabled",!1);break;case"Disable":s.butnDisabled||Lyte.objectUtils(s,"add","butnDisabled",!0);break;case"SetValue":a&&Lyte.objectUtils(s,"add","label",a);break;case"GetValue":return s.label}}}return!0}return!1},executeCscriptForWizardButtonHandlers:function(e,t,a){var i=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript().querySelector("crm-create-wizard-buttons");if(i){var r=i.component.data.buttons;if(r&&r.length){var o=r.find((function(t){return t.name===e}))||r.find((function(t){return(t.resource&&t.resource.name)===e}));if(o)switch(Lyte.objectUtils(o,"add","fromCS",!0),t){case"Click":const e=i.querySelector(`[data-button-id='${o.id}']`);e&&e.click();break;case"Enable":o.$.set({isCscriptDisable:!1});break;case"Disable":o.$.set({isCscriptDisable:!0});break;case"Hide":o.$.set({isCscriptHide:!0});break;case"Show":o.$.set({isCscriptHide:!1});break;case"SetContent":if(a&&a.value){const e=a.value;if(e.length>15)throw CScript.Error("Content must be atmost 15 characters");Lyte.objectUtils(o,"add","display_label",e)}break;case"GetContent":return o.display_label}}}},executeCscriptForWizardTextHandlers:function(e,t,a){var i=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript().querySelector(`[name=${e}]`);if(i&&i.component){$L(i).attr("data-cs-action",!0);var r=i.component;let e=store.peekRecord("wizard-segment",r.getData("id"));switch(t){case"Show":e.$.set({isCscriptHide:!1});break;case"Hide":e.$.set({isCscriptHide:!0});break;case"SetContent":a&&a.value&&"string"==typeof a.value&&e.$.set("content",a.value.substring(0,1e3))}}},getWizardElements:function(){let e={},t=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript(),a=t.querySelector("crm-create-wizard-buttons");if(e.buttons=[],a&&a.component){let t=a.component.data.buttons||[];e.buttons=t.filter((e=>!e.hideForProfile))}let i=t.querySelectorAll("crm-create-wizard-text"),r=[];return i.forEach((e=>{r.push(e.component)})),e.text_components=r,e},setViewPortDebounceTime:function(){if(Lyte.Component.viewPortSettings){var e,t;(e=LyteComponent.pendingViewPortElements&&LyteComponent.pendingViewPortElements.length?LyteComponent.pendingViewPortElements.length:0)<100?t=0:e>=100&&e<200?t=25:e>=200&&e<300?t=50:e>=300&&(t=100),Lyte.Component.viewPortSettings.debounce!==t&&(Lyte.Component.viewPortSettings.debounce=t)}},handleScrollOnDropDownToggle:function(e){var t=$L(this.$node).parents("html");if("show"!==e&&(t=t&&t.length?t:$L("html")),t)if("show"===e){var a=renderingUtils.windowHeight>=$L(document).height()?0:renderingUtils.getScrollBarWidthValue;t.css({overflow:"hidden","margin-right":a})}else t.css({overflow:"","margin-right":""})},handleSubformHrzntlScrollforDate:function(e){var t=this.$node.closest("crm-create-subformsection lyte-table-structure"),a=$L("crm-canvas-quicksavepopup");if(a.length)var i=a[0].getData("showPopup");t&&("show"===e?(t.classList.add("preventWheel"),i&&Lyte.registeredMixins["crm-formview-mixin"]&&Lyte.registeredMixins["crm-formview-mixin"].freezeQuickSavepopScroll()):(t.classList.remove("preventWheel"),i&&Lyte.registeredMixins["crm-formview-mixin"]&&Lyte.registeredMixins["crm-formview-mixin"].rm_freezeQuickSavepopScroll()))},focusDropDownDiv:function(){var e=this.$node.querySelector("div .lyteDummyEventContainer");e&&e.focus()},resetPicklistSearchKey:function(){var e=this.$node.component.data.picklistsearchKey;if(e){var t="lyte-drop-box."+e+" lyte-search",a=document.querySelector(t);a&&a.setValue("")}},setSkyEyeCompanyInRecord:function(e,t,a){var i=e.$.model;i.fieldList.$skyeye_account_id||store.addField(i._name,"$skyeye_account_id","string"),e.$.set("$skyeye_account_id",t[a].external_search_acc_CompanyId)},setZiaOwnerAssignmentStateInRecord:function(e,t,a,i,r,o){if("object"==typeof Crm&&Crm.isZiaOwnerRecommendationEnabled){var n=e.$.model;n.fieldList.$zia_owner_assignment||store.addField(n._name,"$zia_owner_assignment","string");var s={};"assigned_by_zia"!==t?(t="owner_recommendation_unavailable",s={}):(s=a,Crm.client_tracking("Zia Owner Recommendation - Record saved with zia recommended owner from create page",{ModuleName:o})),e.$.set("$zia_owner_assignment",t),n.fieldList.zia_suggested_users||store.addField(n._name,"zia_suggested_users","object"),e.$.set("zia_suggested_users",s),"clone"===i&&r.cloneData&&r.cloneData.dataToSend&&(r.cloneData.dataToSend.$zia_owner_assignment=t,r.cloneData.dataToSend.zia_suggested_users=s)}},setTabIndexForFields:function(e,t,a,i,r,o,n,s){var l,d=this.data.currentInstObjKey,c=e[d].createTabIndex;if(this.data.isWizard&&"string"==typeof t.tab_traversal&&(t.tab_traversal=this.getWizardTabTraversal(t.tab_traversal)),this.globalDataIndex=0,o&&(t&&t[d]&&"used"===t[d].type||t.screen)){i=[],r=[],n=[];var u=this.data.isWizard?t.id:e[d].renderedLayoutId;(t&&t[d]&&"used"===t[d].type||t.screen?t.fields.sort(function(e,t){return e[u].sequence_number-t[u].sequence_number}.bind(this)):t.fields).forEach(function(o){o.view_type&&o.view_type[a]&&Lyte.Component.registeredHelpers.isValidCreateField(o,this.data.initRoute,e.module_name)&&(!t.isSubformSection||t.isSubformSection&&validationUtils.isNotEmpty(o.subform))&&(1===t.column_count?n.push(o):o[u].sequence_number%2!=0?i.push(o):r.push(o))}.bind(this))}for(var m=0,p=i.length,f=0;f<p;f++)if("formula"!==i[f].data_type&&"autonumber"!==i[f].data_type){if(Lyte.Component.set(i[f][d],"tab_index",c),"wizard-query-component"===i[f]._type&&(i[f].data_type="lookup"),c=(l=v(i[f].data_type,c,i[f],this.globalDataIndex,s))[0],this.globalDataIndex=l[1],2===t.tab_traversal)for(var _=r.length,y=m;y<_;y++){if(m++,"formula"!==r[y].data_type&&"autonumber"!==r[y].data_type){Lyte.Component.set(r[y][d],"tab_index",c),"wizard-query-component"===r[y]._type&&(r[y].data_type="lookup"),c=(l=v(r[y].data_type,c,r[y],this.globalDataIndex,s))[0],this.globalDataIndex=l[1];break}Lyte.Component.set(r[y][d],"tab_index",-1)}}else Lyte.Component.set(i[f][d],"tab_index",-1);_=r.length;for(let e=m;e<_;e++)"formula"!==r[e].data_type&&"autonumber"!==r[e].data_type?(Lyte.Component.set(r[e][d],"tab_index",c),"wizard-query-component"===r[e]._type&&(r[e].data_type="lookup"),c=(l=v(r[e].data_type,c,r[e],this.globalDataIndex,s))[0],this.globalDataIndex=l[1]):Lyte.Component.set(r[e][d],"tab_index",-1);t.isSubformSection&&(n=t.fields);var g=n.length;for(let e=0;e<g;e++)"formula"!==n[e].data_type&&"autonumber"!==n[e].data_type||t.isSubformSection?(Lyte.Component.set(n[e][d],"tab_index",c),"wizard-query-component"===n[e]._type&&(n[e].data_type="lookup"),c=(l=v(n[e].data_type,c,n[e],this.globalDataIndex,s,t.isSubformSection))[0],this.globalDataIndex=l[1]):Lyte.Component.set(n[e][d],"tab_index",-1);function v(e,t,a,i,r,o){if(r=JSON.stringify(r),e&&t)return Crm.userDetails.isAccessibilityConfigSupported||(t=e.includes("lookup")?t+4:t+1),a.data_index="group"+r+"-"+i,o?(a.subform&&validationUtils.isNotEmpty(a.subform)&&"subform"!==a.data_type&&"static_subform"!==a.data_type?a.data_index="group"+r+"-1":a.data_index="group"+r+"-0",[t,i]):(8===a.ui_type?(a.data_index="group"+r+"-"+(i+1),i+=2):i+=1,[t,i])}Lyte.Component.set(e[d],"createTabIndex",c)},setCScriptSkipFlagForField:function(e){var t=store.peekRecord("field",e),a=this.data&&this.data.currentInstObjKey;t&&t[a]&&(t[a].skipCscriptExecutionforField=!0)},isCscriptExeSupportedField:function(e,t){return!(!e||!t)&&(["text","picklist","ownerlookup","email","phone","website","integer","currency","textarea","lookup","date","datetime","bigint","double","boolean","userlookup","time_range"].includes(e.data_type)&&![51,208,207].includes(e.ui_type)&&!["SALUTATION","ADJUSTMENT","ADJUSTMENT"].includes(e.column_name)&&e.view_type[t]&&e.visible&&!e.read_only)},getPicklistCrtAsExp:function(e,t,a){switch("string"==typeof e&&(e=[e]),a){case"equal":return"Contains([*"+e.join("*")+"*],*"+t+"*)";case"not_equal":return"Or(Not(Contains([*"+e.join("*")+"*],*"+t+"*)),Not("+t+"!=-None-))";case"EMPTY":return"Not("+t+"!=-None-)";case"NOTEMPTY":return"Not("+t+"==-None-)";default:return"Contains('[*"+e.join("*")+"*]',*"+t+"*)"}},formHandlerWrapperForLyteConversion:async function(e,t,a,i,r,o,n){if(e){var s=Lyte.registeredMixins["crm-detailcanvas-utils"]&&Lyte.registeredMixins["crm-detailcanvas-utils"].isFormViewCommonCheck(),l=e.component.data,d=s?l.record:l.dataBind,c=Lyte.deepCopyObject(l.cscriptOrgValues)||{},u=!1,m=s?Lyte.deepCopyObject(l.oldRecord):Lyte.deepCopyObject(l.initialCreatebject),p=l.currentInstObjKey,f=store.modelFor(d.$.model._name).fieldList,_=l.moduleData.module_name;if(CScriptLib&&CScript.Utils.is_subform_event_enabled()&&["writeRow","writeCell"].includes(o))return void await Lyte.registeredMixins["crm-create-mixin"].setCscriptSubFormDataForLyte(i,t,d,l,f[i].relatedTo,r,o,n);if(t){void 0===l.recordListenerid&&"clone"===l.initRoute&&(u=!0);for(const[i,r]of Object.entries(t))if(f[i])if("relation"===f[i].type&&"hasMany"===f[i].relType)void 0===o&&await Lyte.registeredMixins["crm-create-mixin"].setCscriptSubFormDataForLyte(i,r,d,l,f[i].relatedTo);else{var y=store.peekRecord("field",f[i].fieldID);if(y&&(!y.read_only||y[p].isCscriptReadOnly)&&y.visible){u&&(c[i]=m[i]);var g={key:i,value:r,fldInfo:y,dataBind:d,moduleName:l.moduleData.module_name,source:a,isWizard:e.component.data.isWizard,cscriptFullFormData:t};if(s){var v={action:"field_write",field_name:i,value:r};CanvasCreatePageHandler.field_write.call(v)}else await Lyte.registeredMixins["crm-create-mixin"].setCscriptDataForLyte(g);var h="crm-create-fields#"+l.moduleData.module_name+"_fldRow_"+y.column_name,D=$L(h)[0];D&&D.component.checkLayoutrules(D)}else if(this.isInventoryModule(_)&&"Discount"===i&&y&&"DISCOUNT"===y.column_name&&f.Discount&&"DISCOUNT"===f.Discount.columnName){let a="#AggFld_"+_+"_Discount",o={fieldApiName:i,value:r,recordData:d,isGrandDiscount:!0,currentPage:l.initRoute,moduleName:_,cscriptFullFormData:t,layoutCompData:l,discFieldSelector:a};await this.cScriptDiscountFieldHandler(o);let n=e.querySelector("crm-create-fields");n&&n.component&&n.component.checkLayoutrules(n)}}u&&c&&(l.cscriptOrgValues=c);var b=l&&l.moduleFormulafields;((b=b||[])&&b.length?b.length:0)&&e.component.formulaWorkerExecution(b,{},d,void 0,!0)}}},cScriptDiscountFieldHandler:async function(e){e=e||{};var t,{value:a,discFieldSelector:i,recordData:r,isGrandDiscount:o,currentRow:n}=e,s={},l=0,d=o?"Grand Discount : ":`Line Discount - Row ${o?"":n} : `;if(s.directPriceReductionVal=0,s.disPercentValue=l,s.chkdinvDisPercent=!0,s.showDirectPriceError=!1,s.showPerError=!1,a&&("string"==typeof a&&a.indexOf("%")>-1?((""===(l=a.slice(0,-1))||isNaN(l))&&(t=!0),s.chkdinvDisPercent=!0,s.chkdinvDirectPrice=!1,s.disPercentValue=l):isNaN(a)?t=!0:(s.chkdinvDirectPrice=!0,s.chkdinvDisPercent=!1,s.directPriceReductionVal=a)),t)murphy.error(new Error(`${d}given discount is invalid`));else if(null===a||a||0===a){let e,t=Lyte.deepCopyObject(r._LC_additional_INV_subform_INFO||{});t.discountValueSource="",t.discountObj=s,Lyte.objectUtils(r,"add","_LC_additional_INV_subform_INFO",t);let a=$L(i);if(!a[0])return;if(o){let i=a.parents("crm-create-subformsection")[0];i&&i.component&&(Lyte.objectUtils(i.component.data.invPopoverdata,"add","discountObj",t.discountObj),e=i.component.onGrandInvPopoverSelect({discountObj:t.discountObj}))}else a[0].component&&a[0].component.onInventoryPopoverSelect&&(r.$.set("Price_Book_Name",void 0),Lyte.objectUtils(a[0].component.data.invPopoverdata,"add","discountObj",t.discountObj),e=a[0].component.onInventoryPopoverSelect({discountObj:s}));if(!0===e)return void murphy.error(new Error(`${d}unable to use the given discount value, so value not set`))}},bindRecordErrorValuesToNode:function(e,t,a){if(e&&(["date","datetime"].contains(t)||[36,22,143,144,145].contains(a))){var i=this.$node.querySelector("lyte-input"),r=e.value||"";switch(t){case"date":case"datetime":if("date"===(i?i.getAttribute("lt-prop-type"):""))if(n=i.querySelector("input"))if("datetime"===t){var o=!1;o=""===r||o,this.bindDateTimetoNode(r,this,this.data.apiName,o)}else n.value=r;break;default:var n;(n=i?i.querySelector("input"):"")&&n.value!=r&&(n.value=r)}}},executeCscriptWrapper:function(e,t){if(CScriptLib){var a=e.$.model.fieldList[t],i=this.data.currentInstObjKey;if(a){var r=store.peekRecord("field",a.fieldID);if(!r||!Lyte.Component.registeredHelpers.isValidCreateField(r,this.data.initRoute,this.data.moduleName||this.data.modulenameUicomp)||r[i].skipCscriptExecutionforField)return void(r&&delete r[i].skipCscriptExecutionforField);if(!this.isCscriptExeSupportedField(r,"edit"===this.data.initRoute?"edit":"create"))return;if(Crm.userDetails.isPhoneNoNewView&&r&&"phone"===r.data_type&&!r[i].isExecuteCscriptForPhone)return;r&&(delete r[i].isExecuteCscriptForPhone,this.clearCscriptInlineError(r)),"lookup"!==a.fieldType?(CScript.Engine.Global.dispatchEvent("onChange",void 0,t),CScript.Engine.Global.dispatchEvent("onChange",a.fieldID,CreatePageHandler.field_read.call({field_name:t}))):a.isLookupChanged=!0}}},triggersubfldMousedownaction:function(e){},clearDateTimeErrInDataBind:function(e,t,a,i){if(e&&("date"===e.fieldType||"datetime"===e.fieldType)&&t&&"ERR02"===t.code){if("Native__Backstage__Extn__Event_Start_Date"===i)c("Native__Backstage__Extn__Event_End_Date");else if("Native__Backstage__Extn__Event_End_Date"===i)c("Native__Backstage__Extn__Event_Start_Date");else{var r=crmConstants.dateTimeComparisonFieldsMapping.filter((function(t){if(t.start===e.columnName||t.end===e.columnName)return t}));if(r.length&&r[0]){var o,n=r[0],s=n.start===e.columnName?n.end:n.start,l=!1;for(var d in a.$.model.fieldList){if(a.$.model.fieldList[d].columnName===s&&(l=!0,o=d),l)break}c(o)}}function c(e){if(a.$.error&&a.$.error[e]){var t=a.$.error[e];!t||"ERRDATE01"!==t.code&&"ERRDATE02"!==t.code||delete a.$.error[e]}}}},handleRecNotAvailablityError:function(e){var t={is_Error:!0,errorId:"7",errorFrom:"common",data:{component:"crm-permission-error",componentData:{brandName:Crm.appName,isEntityPresence:1},componentRenderLoc:"#show"},performDestriction:!0};return e?t:($L("#show").empty(),Lyte.Component.render("crm-permission-error",{brandName:Crm.appName,isEntityPresence:1},"#show"),void this.transition.abort())},handleCScriptDispatchEvent:function(e){let t=Lyte.registeredMixins["crm-detailcanvas-utils"]&&Lyte.registeredMixins["crm-detailcanvas-utils"].isFormViewCommonCheck(),a=Lyte.registeredMixins["crm-detailcanvas-utils"]&&Lyte.registeredMixins["crm-detailcanvas-utils"].isWizardView(),i=t?CanvasCreatePageHandler:CreatePageHandler;if(!a&&CScriptLib){if([36,143,144,145].contains(e.uiType)&&"onChange"!==e.calledFrom)return;CScript.Engine.Global.dispatchEvent("onChange",void 0,e.fldapiName),CScript.Engine.Global.dispatchEvent("onChange",e.fieldID,i.field_read.call({field_name:e.fldapiName}))}},executeUserFieldsofLookup:function(e,t,a){var i=this.$node.component.data,r=i.currentInstObjKey,o=i.apiName||t;if(i.associationDetails&&i.associationDetails.contains(o)&&e&&!0===Crm.userDetails.FIELD_OF_LOOKUP_ENABLED&&!0===Crm.userDetails.FIELD_OF_LOOKUP_AVAIALBLE){var n=this.data.moduleData[r].user_module_fields_FOL,s="edit"===i.initRoute?"edit":"create",l=i.moduleData.fields.filter((function(e){if(e.visible&&(e.view_type[s]||e[r].isHiddenInLayoutRules)&&e.association_details&&validationUtils.isNotEmpty(e.association_details)&&e.association_details.lookup_field.api_name===o)return e})),d={};l&&l.length&&(d.fields=l.mapByKey("association_details").mapByKey("related_field").mapByKey("api_name").join());var c={};c.isUsersFOLInitialSet=a,store.findRecord("user",e.id,d,void 0,void 0,{usersAPIversion:"v2.2"}).then(function(t){t&&t[0]&&(e=t[0],n?this.executeFieldsOfLookup(e,"user",void 0,void 0,!0,n,o,c):store.findAll("field",{module:"users"},void 0,void 0,{apiVersion:"2.2"}).then(function(t){Lyte.Component.set(this.data.moduleData[r],"user_module_fields_FOL",t),this.executeFieldsOfLookup(e,"user",void 0,void 0,!0,t,o,c)}.bind(this)))}.bind(this))}},executeFieldsOfLookup:function(e,t,a,i,r,o,n,s){var l=this.$node.component.data,d=n||l.apiName;const c=Lyte.Mixin.get("crm-create-mixin").lockedbyCR;var u=this.data.currentInstObjKey;if(s=s||{},l.associationDetails&&l.associationDetails.contains(d)&&!0===Crm.userDetails.FIELD_OF_LOOKUP_ENABLED&&!0===Crm.userDetails.FIELD_OF_LOOKUP_AVAIALBLE){var m;m="user"===t?store.modelFor("user")?store.modelFor("user").fieldList:void 0:store.modelFor(moduleRecordMapping[t].id).fieldList;var p="edit"===l.initRoute?"edit":"create",f=l.moduleData.fields.filter((function(e){if(e.visible&&(e.view_type[p]||e[u].isHiddenInLayoutRules)&&e.association_details&&validationUtils.isNotEmpty(e.association_details)&&e.association_details.lookup_field.api_name===d)return e})),_=[];if(!r){var y=store.peekRecord("layout",i).fields;y=y?y.map((function(e){return e.id})):[];var g=f.map((function(e){return e.association_details.related_field.id}));(_=(_=store.peekRecord("module",a).fields)||[]).length&&(_=_.filter((function(e){return g.contains(e.id)&&e.visible&&y.contains(e.id)})).map((function(e){return e.id})))}var v=new Map,h="";if(f.forEach(function(t){if(!c.has(t.id)){var a=l.dataBind.$.model.fieldList[t.api_name],i=t.association_details.related_field,n=m[i.api_name]?m[i.api_name].type:void 0;if(!n&&r){var d=o.filter((function(e){return e.api_name===i.api_name}))[0];d&&(n=Lyte.registeredMixins["crm-module-mixin"].getfieldattributeType(d))}if(r&&o&&o.length&&i){var p=o.filter((function(e){return e.id===i.id}))[0];if(p&&!p.visible)return}if(_.contains(i.id)||r){if(a&&s&&s.isUsersFOLInitialSet&&(a.skip__Modified__action=!0),"date"===a.type){if(t[u].isSetValueFromScript=!0,e[i.api_name]){y=(y=e._$&&e._$.original&&e._$.original[i.api_name]?e._$.original[i.api_name]:e[i.api_name]).replace(/[+-]\d{2}:\d{2}/,"");var f=CrmDateUtils.convertDateToUserPattern(CrmDateUtils.getDateObjectFromString(y,"YYYY-MM-DD"));Lyte.Component.set(l.dataBind,t.api_name,f||void 0)}else Lyte.Component.set(l.dataBind,t.api_name,void 0);delete t[u].isSetValueFromScript}else if("datetime"===a.type){if(t[u].isSetValueFromScript=!0,e[i.api_name]){var y;y=(y=e._$&&e._$.original&&e._$.original[i.api_name]?e._$.original[i.api_name]:e[i.api_name]).replace(/[+-]\d{2}:\d{2}/,"");var g=this.getDateTimeForForm(new Date(y),!0);Lyte.Component.set(l.dataBind,t.api_name,g||void 0)}else Lyte.Component.set(l.dataBind,t.api_name,void 0);Lyte.Component.set(t[u],"obsDateTime",!t[u].obsDateTime),delete t[u].isSetValueFromScript}else if(250===a.uiType)v.set(t.api_name,i.api_name),h+=i.api_name+",";else if(a.type===n||"object"!==n&&"relation"!==n)if("lookup"===t.data_type&&"object"===n)Lyte.Component.set(l.dataBind,t.api_name,e[i.api_name]),Lyte.Component.set(t[u],"fromFieldsofLookup",!0),Lyte.Component.set(t[u],"lookupSingle",e[i.api_name]?e[i.api_name].name:""),Lyte.Component.set(t[u],"selectedId",e[i.api_name]?e[i.api_name].id:"");else if("userlookup"===t.data_type&&"object"===n){var D=e[i.api_name];D="deleted"===(D&&store.peekRecord("user",D.id)?store.peekRecord("user",D.id).status:"")?void 0:D,Lyte.Component.set(l.dataBind,t.api_name,D);var b,L=$L("#"+t.module[0].module_name+"_fldRow_"+a.columnName),C=$L("#Crm_"+t.module[0].module_name+"_"+a.columnName)[0];if(L&&C)if(D)C.component.setData("cxPropSelectedUser",{id:D.id,full_name:D.name}),L.find(".clear_lookupfield").addClass("vVIm"),(b=L[0].component.$node.querySelector(".FValue"))&&b.classList.remove("lcSingleUser");else C.component.setData("cxPropSelectedUser",D),L.find(".FValue").addClass("lcSingleUser"),(b=L.find(".clear_lookupfield")[0])&&b.classList.remove("vVIm")}else if("multi-picklist"===n&&e[i.api_name]){var I;if("string"==typeof e[i.api_name])try{var E=JSON.parse(e[i.api_name]);I=E&&E.length?R(E):""}catch(t){I=e[i.api_name]}else"string"!=typeof e[i.api_name]&&e[i.api_name].length&&(I=R(e[i.api_name]));function R(e){var t="",a=e?e.length:0;return e.forEach((function(e,i){t+=e+(i!==a-1?";":"")})),t}Lyte.Component.set(l.dataBind,t.api_name,I)}else if("currency"===a.fieldType&&e&&e[i.api_name]){if(t[u].isSetValueFromScript=!0,l.dataBind.Currency&&e.Currency&&e.Currency!==l.dataBind.Currency){var S=this.getuserCurrencydata(l.dataBind.Currency),F=this.convertToCurrentCurrency(e[i.api_name],e.Exchange_Rate,S.er);F=isNaN(F)?e[i.api_name]:F,F=Number(F).toFixed(t.decimal_place),Lyte.Component.set(l.dataBind,t.api_name,F)}else if(!e.Currency&&l.dataBind.Currency&&l.dataBind.Currency!==Crm.userDetails.BASE_CURRENCY&&Crm.userDetails.BASE_CURRENCY){S=this.getuserCurrencydata(l.dataBind.Currency);var O=this.getuserCurrencydata(Crm.userDetails.BASE_CURRENCY);F=this.convertToCurrentCurrency(e[i.api_name],O.er,S.er);F=isNaN(F)?e[i.api_name]:F,F=Number(F).toFixed(t.decimal_place),Lyte.Component.set(l.dataBind,t.api_name,F)}else Lyte.Component.set(l.dataBind,t.api_name,Number(e[i.api_name]).toFixed(t.decimal_place));delete t[u].isSetValueFromScript;var k="crm-create-fields#"+l.modulenameUicomp+"_fldRow_"+t.column_name+" lyte-input input";$L(k).trigger("keypress").trigger("keyup").focus().trigger("blur")}else t[u].isSetValueFromScript=!0,Lyte.Component.set(l.dataBind,t.api_name,e&&void 0!==e[i.api_name]?e[i.api_name]:void 0),delete t[u].isSetValueFromScript;else"string"===a.type?e[i.api_name]&&validationUtils.isNotEmpty(e[i.api_name])?Lyte.Component.set(l.dataBind,t.api_name,e[i.api_name].name):Lyte.Component.set(l.dataBind,t.api_name,""):void 0===e[i.api_name]&&Lyte.Component.set(l.dataBind,t.api_name,e[i.api_name]);a&&a.skip__Modified__action&&delete a.skip__Modified__action}}}.bind(this)),v.size>0){var D=this;commonUtils.showHideLoadingDiv(!0),h=h.slice(0,-1),store.findAll("dummy",null,!1,!1,{url:"crm/v6/"+moduleApiMapping[t]+"/"+e.id+"/actions/fetch_full_data?fields="+h}).then((function(e){for(var[t,a]of v.entries()){var i=e.data[0][a];Lyte.Component.set(l.dataBind,t,i)}commonUtils.showHideLoadingDiv(!1),D.processLayoutRules()}))}else this.processLayoutRules()}},fillSkeEyeCompanyResponse:function(e){var t=Lyte.registeredMixins["crm-create-init-mixin"].getLyteCreateComponentForCscript(),a=this.data.dataBind.$.model.fieldList,i=(e=e||{},{});for(var r in a){var o=a[r];if(o&&e.hasOwnProperty(o.columnName)&&e[o.columnName]&&"null"!==e[o.columnName]&&(i[r]=e[o.columnName],"date"===o.fieldType||"datetime"===o.fieldType)){var n=$L.moment(Number(e[o.columnName]))._dateObj,s=Utils.getDateInUserDatePattern(n);i[r]=s}}t&&Object.keys(i).length&&this.formHandlerWrapperForLyteConversion(t,i,"skyEye")},handleConvertedRecordError:function(e,t,a){if(a)return{is_Error:!0,errorId:"8",errorFrom:"common"};Lyte.Router.transitionTo({route:"crm.tab.module.entity",dynamicParams:[e,t]})},getSubformCachedIds:function(e,t,a){var i="crm-create-subformsection#"+t+"_SubForm_"+a,r=e.querySelector(i);return r?r.getData("cacheRecordIds"):[]},cscriptReadFormClientHandler:function(e,t){if(!e)return{Data:{}};function a(e){try{return JSON.parse(e),!0}catch(e){return!1}}var i=e.component.data,r=i.currentInstObjKey;if(i&&i.supportClientscript){const R=i.isWizard;var o=i.dataBind.$.toJSON(),n=i.moduleData[r].renderedLayoutId;if(validationUtils.isNotEmpty(i.dataBind.$.error)){var s=i.dataBind.$.error;for(var l in s)o[l]=s[l]?s[l].value:o[l]}var d=i.dataBind.lookupError||{};for(var l in d)o[l]&&(o[l]=null);var c=i.dataBind.$.model.fieldList,u="clone"===i.initRoute?"create":i.initRoute;function m(e,t){if(e){for(var r in e){var o=!0;if(e[r]&&e[r].fieldID){var s=store.peekRecord("field",e[r].fieldID);if("datetime"===e[r].fieldType&&t[r]&&t[r].indexOf("TV")>-1){var l=t[r].split("TV");2===l.length&&(t[r]=l[0]+" "+l[1])}"picklist"===e[r].fieldType&&"-None-"===t[r]&&(t[r]=null),"multiselectpicklist"===e[r].fieldType&&t[r]&&"string"==typeof t[r]&&a(t[r])&&(t[r]=JSON.parse(t[r])),s&&s.view_type[u]&&Lyte.Component.registeredHelpers.isValidCreateField(s,i.initRoute,i.moduleData.module_name)||(delete t[r],o=!1)}else delete t[r],o=!1;o&&(t.hasOwnProperty(r)?void 0===t[r]&&(t[r]=null):t[r]=null),!n||s&&s.hasOwnProperty(n)||delete t[r]}return t}return t}if(c)for(var p in c)if(c[p]&&(c[p].fieldID||"relation"===c[p].type)){var f=store.peekRecord("field",c[p].fieldID);if(Crm.userDetails.isSubformNewComponentEnabled&&"relation"===c[p].type){var _=this.getSubformCachedIds(e,i.moduleName,p);o[p]=_&&_.length>0?_:o[p]}if("relation"===c[p].type&&o[p]&&o[p].length){var y=[];o[p].forEach((function(e){var a=store.peekRecord(c[p].relatedTo,e),r=a.$.toJSON();if(a.$&&a.$.validate(),validationUtils.isNotEmpty(a.$.error)){var o=a.$.error;for(var n in o)r[n]=o[n]?o[n].value:r[n]}var s=a.lookupError||{};for(var n in s)r[n]&&(r[n]=null);var l=m(store.modelFor(c[p].relatedTo).fieldList,r);["Quotes","Invoices","SalesOrders","PurchaseOrders"].contains(i.moduleData.module_name)&&["Invoiced_Items","Purchase_Items","Ordered_Items","Quoted_Items"].contains(p)&&t&&(t.is_zdk_beta||t.widgetsRead)&&l&&l.Product_Name&&l.Product_Name.name&&(l.Product_Id=l.Product_Name.id,l.Product_Name=l.Product_Name.name),y.push(l)})),o[p]=y;continue}if("subform"===c[p].cusRelationFldType){o[p]=[];continue}if("relation"===c[p].type&&R&&!o[p]){o[p]=null;continue}const{fieldType:s}=c[p];if("datetime"===s&&o[p]&&o[p].indexOf("TV")>-1){var g=o[p].split("TV");2===g.length&&(o[p]=g[0]+" "+g[1])}else if(["imageupload","fileupload","multiuserlookup"].includes(s)||"picklist"===s&&"-None-"===o[p])o[p]=null;else if("multiselectpicklist"===s&&o[p]&&"string"==typeof o[p])a(o[p])&&(o[p]=JSON.parse(o[p]));else if("multiselectlookup"===s){var v="";if(o[p]?o[p].length:0){var h="crm-create-fields#"+i.moduleName+"_fldRow_"+c[p].columnName,D=$L(h)[0];if(D&&D.component){D.component.data.lyteViewPort&&D.component.setData("lyteViewPort",!1);var b=D.querySelector(".createmxnlookupDIV input");b&&b.value&&(v=b.value)}}o[p]=v||null}else if(["ownerlookup","userlookup","lookup"].includes(s)&&o[p]&&validationUtils.isNotEmpty(o[p])){const{id:e,name:t,full_name:a}=o[p],i="lookup"===s?t:t||a;o[p]={...e&&{id:e},...i&&{name:i}}}var L=!1;f&&f.view_type[u]&&Lyte.Component.registeredHelpers.isValidCreateField(f,i.initRoute,i.moduleData.module_name)?!o[p]&&f&&f.default_value&&(o[p]="boolean"!==c[p].fieldType&&"picklist"!==c[p].fieldType||!o.hasOwnProperty(p)?f.default_value:o[p]):(!f||f&&f[r]&&!f[r].isHiddenInLayoutRules)&&(delete o[p],L=!0),o.hasOwnProperty(p)?(f&&f[r]&&f[r].isHiddenInLayoutRules&&!R||void 0===o[p])&&(o[p]=null):L||(o[p]=null),!n||f&&f.hasOwnProperty(n)||delete o[p]}else delete o[p];var C=[];o=o||{};for(var I in o)C.push([I,o[I]]);C=C.sort((function(e,t){var a=e[0].toUpperCase(),i=t[0].toUpperCase();return a<i?-1:a>i?1:0}));var E={};if(C.forEach((function(e){E[e[0]]=e[1]})),R&&i.activeScreen){let e=[...i.activeScreen.container.fields,...i.activeScreen.container.subform_fields.map((e=>e.api_name))],t={};for(let a in E)e.contains(a)&&(t[a]=E[a]);E=t}return{Data:E}}},triggerCScriptUIUpdate:function(e){var t=(e=e||{}).fldMeta,a=e.value,i="crm-create-fields#"+e.moduleName+"_fldRow_"+(t=t||{}).column_name,r=$L(i)[0];t&&r&&r.component&&r.component.bindRecordErrorValuesToNode&&!r.component.data.lyteViewPort&&r.component.bindRecordErrorValuesToNode({value:a},t.data_type,t.ui_type)},setForMandatoryField:function(e,t,a,i){var r=e.$.model.fieldList[t];r.mandatory=i,store.addField(a,t,r.type,r)},checkForLayoutRulePopup:function(e){var t=this,a=[],i=void 0!==Crm.userDetails.ValidationAlertPreference&&Crm.userDetails.ValidationAlertPreference,r=t.getData("createObject");t.data.moduleData=this.getData("moduleObject");var o=t.getData("fieldsList")[0].sectionCustomDetails.fields,n=o.length,s=t.checkForTotalMandatoryLength(o,n,"count"),l=t.checkForTotalMandatoryLength(o,n,"isNewlyAdded"),d=r[t.data.dataObj.parseFieldDeatils.field.api_name];t.data.dataObj.parseFieldDeatils.actual_value!==r[t.data.dataObj.parseFieldDeatils.field.api_name]&&(r[t.data.dataObj.parseFieldDeatils.field.api_name]=t.data.dataObj.parseFieldDeatils.actual_value),t.checkForLayoutRule(e,{},t.getData("layoutRuleArr"),r,a,t,this.data.dataObj.field,"edit",l),r[t.data.dataObj.parseFieldDeatils.field.api_name]=d;var c=t.getData("record"),u=(c=c||t.data.dataObj.parseFieldDeatils.record)&&c.$process_flow?t.data.dataObj.parseFieldDeatils.bluePrintInfo?t.data.dataObj.parseFieldDeatils.bluePrintInfo:Lyte.Router.getRouteInstance().currentModel.blueprint_exec_info:void 0;a=this.checkForVisiblity(a,o,t.data.dataObj.parseFieldDeatils.editableFieldsRL,u,"edit");for(let r=0;r<n;r++){o[r].fieldRecord&&o[r].fieldRecord[e]&&o[r].fieldRecord[e].isLayoutMandatory&&(o[r].fieldRecord[e].isLayoutMandatory=!1);var m=a.filter((function(e){return e.id===o[r].fieldRecord.id})).length;if(!o[r].fieldRecord.view_type.edit&&m>0){var p=o[s];Lyte.objectUtils(o[s].fieldCustomDetails,"add","sequence_number",r+1),Lyte.objectUtils(o[r].fieldCustomDetails,"add","sequence_number",++s),Lyte.objectUtils(o[r].fieldRecord,"add","required",!0),Lyte.objectUtils(o[r].fieldRecord,"add","isNewlyAdded",!0),Lyte.objectUtils(o[r].fieldRecord.view_type,"add","edit",!0),Lyte.arrayUtils(o,"replaceAt",s-1,o[r]),Lyte.arrayUtils(o,"replaceAt",r,p),this.setForMandatoryField(t.data.createObject,o[s-1].fieldRecord.api_name,t.data.moduleData.id,!0)}else o[r].fieldRecord.view_type.edit&&m>0&&!o[r].fieldRecord.required?(Lyte.objectUtils(o[r].fieldRecord,"add","required",!0),this.setForMandatoryField(t.data.createObject,o[r].fieldRecord.api_name,t.data.moduleData.id,!0)):!o[r].fieldRecord.isNewlyAdded||m>0||(Lyte.objectUtils(o[r].fieldRecord,"add","required",!1),this.setForMandatoryField(t.data.createObject,o[r].fieldRecord.api_name,t.data.moduleData.id,!1));if(o[r].fieldRecord.view_type.edit&&o[r].fieldRecord.forValidationRule&&"true"===o[r].fieldRecord.forValidationRule.split("-")[0]&&"true"===o[r].fieldRecord.forValidationRule.split("-")[1]){var f=t.getData("moduleName")+"_fldRow_"+o[r].fieldRecord.column_name,_=$L("crm-create-fields#"+f)[0],y={isError:!0,inFocusNow:!1},g=o[r].fieldRecord.forValidationRuleError;i?g&&(y.isVRError=!0,y[o[r].fieldRecord.id]=g,y.fieldId=o[r].fieldRecord.id):y.message=$ESAPI.encoder().encodeForHTML(g);var v=_?_.component.data:void 0;i?Lyte.Component.set(v,"errorDetailsNew",y):Lyte.Component.set(v,"errorDetails",y),o[r].fieldRecord.forValidationRule="true-false"}}},checkForValidationRulePopup:function(e){var t=this,a=[],i=t.getData("createObject");t.data.moduleData=this.getData("moduleObject");var r=t.getData("fieldsList")[0].sectionCustomDetails.fields,o=r.length,n=t.checkForTotalMandatoryLength(r,o,"count"),s=t.executeValidationRuleQuickCreate(e,{},"",i,t.getData("validationRuleArr"),t.getData("moduleObject"),this.data.dataObj.field.api_name,"",t,a,"edit");return s&&s.then?Promise.resolve(s).then((function(e){return a=e,t.resultValidationRule(t,a,r,n)})):t.resultValidationRule(t,a,r,n)},resultValidationRule:function(e,t,a,i){var r=a.length;for(let e=0;e<r;e++){var o=t.filter((function(t){return t.targetFieldId===a[e].fieldRecord.id&&"allow_by_alert"!==t.alert_type})).length,n=t.filter((function(t){return t.targetFieldId===a[e].fieldRecord.id&&"allow_by_alert"===t.alert_type})).length;if(!a[e].fieldRecord.view_type.edit&&o>0){var s=a[i];Lyte.objectUtils(a[i].fieldCustomDetails,"add","sequence_number",e+1),Lyte.objectUtils(a[e].fieldCustomDetails,"add","sequence_number",++i),Lyte.objectUtils(a[e].fieldRecord.view_type,"add","edit",!0),Lyte.arrayUtils(a,"replaceAt",i-1,a[e]),Lyte.arrayUtils(a,"replaceAt",e,s)}n&&Lyte.objectUtils(a[e].fieldRecord.view_type,"add","isVRField",!0)}var l=this.getData("dataObj");if(l.contentHeader){var d=!0;l.parseFieldDeatils&&l.parseFieldDeatils.skipHeaderChangeAllTime&&l.contentDetails.header&&(d=!1),d&&Lyte.objectUtils(l.contentDetails,"add","header",t&&1===t.length?I18n.getMsg("crm.vr.ajax.edit.failed.subfield.single.field"):I18n.getMsg("crm.vr.ajax.edit.failed.subfield.multiple.fields"))}},checkForTotalMandatoryLength:function(e,t,a){var i=0,r=[];for(let o=0;o<t;o++)"count"===a&&e[o].fieldRecord.view_type.edit?++i:"isNewlyAdded"===a&&void 0!==e[o].fieldRecord.isNewlyAdded&&r.push(e[o].fieldRecord.id);return"isNewlyAdded"===a?r:i},checkForLayoutRule:function(e,t,a,i,r,o,n,s="normal",l=0){a&&a.forEach((function(a){a.queries.forEach((function(n,d){o.handleOneLayoutruleQueryQuickCreate(e,d,a,t,n,i,r,o,s,l)}))}))},handleOneLayoutruleQueryQuickCreate:function(e,t,a,i,r,o,n,s,l,d){var c=r.criteria;if(r.actions&&r.actions.length){var u=s.checkCriteriaMatchForCanvas(c,o,this);s.triggerLayoutruleActionsQuickCreate(e,t,a,i,r,o,n,u,s,l,d)}},triggerLayoutruleActionsQuickCreate:function(e,t,a,i,r,o,n,s,l,d,c){l.data.dataObj?i.customReturnData=l.data.dataObj.parseFieldDeatils.customReturnData?l.data.dataObj.parseFieldDeatils.customReturnData:{}:i.customReturnData=i.customReturnData?i.customReturnData:{},i.customReturnData[a.id]=i.customReturnData[a.id]?i.customReturnData[a.id]:[],i.customReturnData[a.id].length<=t?i.customReturnData[a.id].push(s):i.customReturnData[a.id].splice(t,1,s),r.actions.forEach((function(t){"Mandatory_Fields"===t.type||"Show_Fields"===t.type?t.fields.forEach((function(a){var i=store.peekRecord("field",a.id);if(s&&"Mandatory_Fields"===t.type&&i&&!1!==i[e].ShowFldsValidatedAndPassedQC&&!1!==i[e].ShowFldsValidatedAndPassedSecQC)l.handleRequestQuickCreate(e,a,o,n,s,l,d,c);else if(!s&&"Show_Fields"===t.type&&n&&n.length>0&&i&&!i[e].ShowFldsValidatedAndPassedQC){var r=n.findIndex((function(e){if(e.id===a.id)return!0}));r>=0&&(a.required=!1,n.splice(r,1))}else"Show_Fields"===t.type&&i&&!i[e].ShowFldsValidatedAndPassedQC&&(i[e].ShowFldsValidatedAndPassedQC=s,i[e].isHiddenInLayoutRules=!s)})):"Show_Sections"===t.type&&t.sections.forEach((function(t){var a=l.getData("moduleSections")?l.getData("moduleSections"):l.data.globalData.moduleSections;if(a){var i=a.filter((function(e){if(e.name===t)return e}));if((i=i&&i[0]?i[0]:void 0)&&!i.isSubformSection){var r=i.fields;s?r.forEach((function(t){var a=store.peekRecord("field",t.id);a&&!a[e].ShowFldsValidatedAndPassedSecQC&&(a[e].ShowFldsValidatedAndPassedSecQC=s)})):r.forEach((function(t){var a=store.peekRecord("field",t.id);if(a&&!a[e].ShowFldsValidatedAndPassedSecQC){a[e].ShowFldsValidatedAndPassedSecQC=s;var i=n.findIndex((function(e){if(e.id===t.id)return!0}));i>=0&&(t.required=!1,n.splice(i,1))}}))}}}))}))},handleRequestQuickCreate:function(e,t,a,i,r,o,n,s){var l,d=o.getData("layoutArr")&&o.getData("layoutArr")[0]?o.getData("layoutArr")[0].id:"";if((l=store.peekRecord("field",t.id)).layouts&&!l.layouts.filterBy({id:d})[0]&&(l={}),d){var c=o.getData("moduleSections")?o.getData("moduleSections"):o.getData("layoutArr")[0].sections;o.setSecisvalid(c,t,e)}("picklist"!==l.data_type||""!==a[t.api_name]&&"-None-"!==a[t.api_name])&&("lookup"!==l.data_type||a[t.api_name]&&""!==a[t.api_name])&&("currency"!==l.data_type||a[t.api_name]&&"null"!==a[t.api_name]&&""!==a[t.api_name])?556!==parseInt(l.ui_type)&&""===a[t.api_name]?i.push(t):a[t.api_name]&&""!==a[t.api_name]?"edit"===n&&r&&s.filter((function(e){return e===t.id})).length>0&&i.push(t):i.push(t):i.push(t)},executeValidationRuleQuickCreate:function(e,t,a,i,r,o,n,s,l,d,c="normal",u=!1){var m=i,p=r,f=o.fields,_=void 0!==Crm.userDetails.ValidationAlertPreference&&Crm.userDetails.ValidationAlertPreference,y=this.getData("valFeatureSpecinfo"),g={},v={},h={},D=[],b=!1;if(this.setData("vrPassed",!1),p){var L=0,C=p.filter((function(e){return e.active&&"function"===e.validation_type})),I=p.filter((function(e){return e.active&&"criteria"===e.validation_type}));if(I.length+C.length){var E=[],R=0;C.forEach((function(a){var i=a.field.api_name,r=f.filter((function(e){return e.id===a.field.id}))[0];if(r.errorDetails&&(r.errorDetails={}),r.aggerrorDetails&&(r.aggerrorDetails={}),r&&r.visible&&!r.read_only&&(!t.editableFieldsRL||t.editableFieldsRL.contains(r.id))&&(++R,r.api_name===n||Crm.userDetails.CVRFuncExecuteForAllFields)){var o={};o.column_name=r.column_name,o.uitype=r.ui_type,o.value=m[i]?m[i]+"":"",o.api_name=r.api_name,o.field_label=r.field_label,o.id=a.associated_function.id,o._targetFieldid=r.id,!l.data.moduleSections&&e&&e.moduleSections&&(l.data.moduleSections=e.moduleSections),o.record=l.filterValidUITypes(m,"edit",f,"quickCreate",{isCloneOnEdit:!0,isVR:!0}),o.value&&[24,14,30,202,333,786].contains(o.uitype)&&(o.value=o.record[o.api_name]),E.push(o)}}));var S=R+I.length;if(I.forEach((function(r){var o,u;if(r.field){o=r.field.api_name,u=r.field.id;var p=f.filter((function(e){return e.id===u}))[0];delete p.isSecVal,p.errorDetails&&(p.errorDetails={}),p.aggerrorDetails&&(p.aggerrorDetails={}),r.conditions.forEach((function(e){const a=n;n=t.valitionRuleApplyFields&&t.valitionRuleApplyFields.includes(o)?o:n;var s=Crm.userDetails.isRelatedListLyteEnabled?p.api_name:e.primary_condition.field.api_name,f=!(!n||!l.checkForLookup)&&l.checkForLookup(e.primary_condition.field.api_name,e.primary_condition.field.id,n);!(n&&(s===n||f||l.checkForsubCondition(n,e.sub_conditions,"validationRule")||"edit"===c&&(i.$.getDirtyAttributes().contains(e.primary_condition.field.api_name)||l.checkForsubConditionForDirty(i.$.getDirtyAttributes(),e.sub_conditions,"validationRule",l)))||!n)||!p.visible||p.read_only||t.editableFieldsRL&&!t.editableFieldsRL.contains(p.id)||l.handleValidationRuleCondition(e,o,r.execution_type,l,m,u,d,!1,void 0,y),n=a}))}++L,I.length===L&&_&&(d.forEach((function(e){var t=[];Lyte.arrayUtils(t,"push",e),"on_primary_field"===e.alert_preference?(b=!0,g&&g.hasOwnProperty(e.targetFieldId)?(t=g[e.targetFieldId],Lyte.arrayUtils(t,"push",e),g[e.targetFieldId]=t):Lyte.objectUtils(g,"add",e.targetFieldId,t)):"top_of_page"===e.alert_preference?(b=!0,v&&v.hasOwnProperty(e.targetFieldId)?(t=v[e.targetFieldId],Lyte.arrayUtils(t,"push",e),v[e.targetFieldId]=t):(Lyte.arrayUtils(D,"push",e.targetFieldId),Lyte.objectUtils(v,"add",e.targetFieldId,t))):b||"allow_by_alert"!==e.alert_type||(h&&h.hasOwnProperty(e.targetFieldId)?(t=h[e.targetFieldId],Lyte.arrayUtils(t,"push",e),h[e.targetFieldId]=t):(Lyte.arrayUtils(D,"push",e.targetFieldId),Lyte.objectUtils(h,"add",e.targetFieldId,t)))})),!b&&Object.keys(h).length>0&&Lyte.objectUtils(v,"add","AllowByAlert",h),Object.keys(v).length>0&&l.setData("valRuleData",v),Object.keys(g).length>0&&l.setData("valErrorDetails",g),l.setData("fieldIds",D)),S===L&&l.vrErrorCallbackFunctionQuickCreate(t,a,l,d,i,s,n,c,e)})),R)return!0,E.length?store.triggerAction(m.$.model._name,"execute",{type:"POST",jsonData:E}).then((function(r){return r&&r.functions&&l.handleVRFunctionResponse(l.getData("module"),r.functions,E,l,d,u),S===(L+=R)&&l.vrErrorCallbackFunctionQuickCreate(t,a,l,d,i,s,n,c,e),d}),(function(){return l.vrErrorCallbackFunctionQuickCreate(t,a,l,d,i,s,n,c,e),d})):(l.vrErrorCallbackFunctionQuickCreate(t,a,l,d,i,s,n,c,e),d)}else"edit"===c||t.dontSave||this.entitySave(t,i,e)}},checkForsubConditionForDirty:function(e,t,a,i){for(var r=e.length,o=0;o<r;o++)if(i.checkForsubCondition(e[o],t,a))return!0;return!1},checkForsubCondition:function(e,t,a){if("layoutRule"!==a){var i=!1;function r(e,t,a){if(e.field)(!!a.checkForLookup&&a.checkForLookup(e.field.api_name,e.field.id,t)||e.field.api_name===t)&&(i=!0);else if(!e.field)for(var o=e.length,n=0;n<o;n++){if("string"!=typeof e[n]&&e[n].field)(!!a.checkForLookup&&a.checkForLookup(e[n].field.api_name,e[n].field.id,t)||e[n].field.api_name===t)&&(i=!0);else"string"==typeof e[n]||e[n].field||r(e[n],t,a)}}for(o=t.length,n=0;n<o;n++){if(t[n].criteria.field){if(!!this.checkForLookup&&this.checkForLookup(t[n].criteria.field.api_name,t[n].criteria.field.id,e)||t[n].criteria.field.api_name===e)return!0}else if(!t[n].criteria.field)for(s=t[n].criteria.length,l=0;l<s;l++){if("string"!=typeof t[n].criteria[l]&&t[n].criteria[l].field){if(!!this.checkForLookup&&this.checkForLookup(t[n].criteria[l].field.api_name,t[n].criteria[l].field.id,e)||t[n].criteria[l].field.api_name===e)return!0}else"string"==typeof t[n].criteria[l]||t[n].criteria[l].field||r(t[n].criteria[l],e,this)}}return i}for(var o=t.length,n=0;n<o;n++)if(t[n].criteria.field){if(t[n].criteria.field.id===e.id)return!0}else for(var s=t[n].criteria.length,l=0;l<s;l++)if("string"!=typeof t[n].criteria[l]&&t[n].criteria[l].field&&t[n].criteria[l].field.id===e.id)return!0;return!1},vrErrorCallbackFunctionQuickCreate:function(e,t,a,i,r,o,n,s,l){var d=void 0!==Crm.userDetails.ValidationAlertPreference&&Crm.userDetails.ValidationAlertPreference,c=a.getData("moduleData");if(0!==i.length&&"edit"!==s){a.setData("vrPassed",!0);let s=i.length;if(i[0].targetField===n){if(d){var u=!1;for(let e=0;e<s;e++)if(null!==i[e].alert_preference){u=!0;break}if(u&&e.callback&&e.callback.onError)e.callback.onError(i,d);else if(!u){var m=a.getData("valRuleData");Lyte.Component.render("crm-validation-alert",{alertDetails:m.AllowByAlert,fieldIds:Object.keys(m.AllowByAlert),isQc:!0,entityData:r,isDirectSave:!0,parseFieldDetails:e,instanceRelatedData:l,isVRError:!0,layoutData:a},"#basic")}return}for(let t=0;t<s;t++){var p={};return p=i[t],void(e.callback&&e.callback.onError&&(e.callback.onError(p),this.resetInstanceData(l.instanceKey,l.moduleData,l.moduleSections)))}}else{var f=c.fields.sortBy("api_name"),_=f.length,y=0,g=[],v=a.getData("valErrorDetails"),h=c.module_name;for(let e=0;e<_;e++){g.push({api_name:f[e].api_name,id:f[e].id,fieldRecord:f[e]});var D=i.filter((function(t){return t.targetFieldId===f[e].id}));g[e].fieldRecord.forValidationRule="true",D.length>0?(++y,g[e].fieldRecord.forValidationRule=g[e].fieldRecord.forValidationRule+"-true",d?d&&v&&(g[e].fieldRecord.forValidationRuleError=v[f[e].id]):g[e].fieldRecord.forValidationRuleError=D[0].message,g[e].sequence_number=y,g[e].fieldRecord.view_type.edit=!0):(g[e].fieldRecord.forValidationRule=g[e].fieldRecord.forValidationRule+"-false",g[e].sequence_number=s-e+y,g[e].fieldRecord.view_type.edit=!1)}var b=i&&1===i.length?{header:I18n.getMsg("crm.vr.ajax.edit.failed.subfield.single.field")}:{header:I18n.getMsg("crm.vr.ajax.edit.failed.subfield.multiple.fields")};if(e.isRelatedListCase){p=i[0];e.callback&&e.callback.onError&&(e.callback.onError(p),this.resetInstanceData(l.instanceKey,l.moduleData,l.moduleSections))}else{m=this.getData("valRuleData");var L=this.getData("fieldIds");m&&m.hasOwnProperty("AllowByAlert")?Lyte.Component.render("crm-validation-alert",{alertDetails:m.AllowByAlert,fieldIds:L,isQc:!0,entityData:r,isVRError:!0,isDirectSave:!0,parseFieldDetails:e,instanceRelatedData:l,layoutData:this},"#basic"):this.openQuickCreatePopup(e,n,o,t,h,g,r,I18n.getMsg("crm.lr.heading.details.required"),b,!0,!1,a,!1,l)}}}else"edit"===s||a.getData("vrPassed")||e.dontSave?"edit"!==s&&a.getData("vrPassed")&&e.callback&&e.callback.onError&&(e.callback.onError({case:"errorOnFunctionRule"}),this.resetInstanceData(l.instanceKey,l.moduleData,l.moduleSections)):this.entitySave(e,r,l)},openQuickCreatePopup:function(e,t,a,i,r,o,n,s,l,d,c,u,m,p){if(e.callback&&e.callback.onBeforeOpen){var f=e.callback.onBeforeOpen();f&&f.then?f.then(function(f){!1!==f&&this.proceedToOpenQuickCraete(e,t,a,i,r,o,n,s,l,d,c,u,m,p.instanceKey)}.bind(this)):!1!==f&&this.proceedToOpenQuickCraete(e,t,a,i,r,o,n,s,l,d,c,u,m,p.instanceKey)}else this.proceedToOpenQuickCraete(e,t,a,i,r,o,n,s,l,d,c,u,m,p.instanceKey)},proceedToOpenQuickCraete:function(e,t,a,i,r,o,n,s,l,d,c,u,m,p){var f,_=this.getData("valRuleData"),y=this.getData("fieldIds");f=n.$&&n.$.getDirtyAttributes().length>0?this.parseOnlyDirtyAttributes(n.$.getDirtyAttributes(),n):$L.extend(!0,[],n),e.otherFieldValues&&(f=Object.assign(f,e.otherFieldValues)),n&&n.hasOwnProperty("Expected_Revenue")&&0===n.Expected_Revenue&&n.$.model.fieldList.Expected_Revenue&&"expected-revenue"===n.$.model.fieldList.Expected_Revenue.type&&(f.Expected_Revenue="0");var g=[];for(var v in e.otherFieldValues)g.push(v);n.$.rollBackAttributes(g),Lyte.objectUtils(n,"add",t,a);let h=[];i.layoutRulesResponse&&i.layoutRulesResponse.layout_rule&&i.layoutRulesResponse.layout_rule.length>0&&this.getLayoutAndvalidationRuleFields(i.layoutRulesResponse.layout_rule,h,"layoutRule"),i.validationRuleResponse&&i.validationRuleResponse.length>0&&this.getLayoutAndvalidationRuleFields(i.validationRuleResponse,h,"validationRule"),u.parseFieldsList=Lyte.deepCopyObject(u.constructParseFieldsList(o,h,p)),e.field[p]?e.field[p].quickCreatePrimaryField=!0:e.field[p]={quickCreatePrimaryField:!0};var D=!1;s===I18n.getMsg("crm.field.of.lookup.fields.related.fields")&&(D=!0),_&&_.hasOwnProperty("AllowByAlert")?Lyte.Component.render("crm-validation-alert",{alertDetails:_.AllowByAlert,fieldIds:y,isQc:!0,entityData:n,isVRError:!0,layoutData:u},"#basic"):Lyte.triggerEvent("quickCreate",{parseFieldDeatils:e,field:e.field,moduleName:r,type:"edit",fieldsList:u.constructParseFieldsList(o,h,p),recordId:n.id,headerName:s,disableQuickCreate:!0,allowSections:!1,recordGetQp:{approved:"both"},updateRecDetails:f,contentFooter:c,contentHeader:d,contentDetails:l,isKanbanviewEdit:!0,preventRecUnload:!0,skipMandatory:!0,isKanbaReasonForLoss:m,onlyValidateVisibleFields:!0,isLayoutRuleExecutionSkipOnRender:D,valRuleData:_,fieldIds:y,closeOnEsape:void 0===e.closeOnEsape||e.closeOnEsape,skipRequest:{auto_enrichment:!0},cloneOnEdit:!0,currentLayoutId:e.currentLayoutId,layoutRequestCustomData:e.layoutRequestCustomData,callbacks:{onSave:function(t,a,i){u.resetFieldData(i.currentInstObjKey),e.callback&&e.callback.onSave&&(e.isRequiredAdditionalInfo?e.callback.onSave(a,"success",i.parseFieldDeatils.customReturnData):e.callback.onSave(a,"success"))},onCancel:function(t,a){u.resetFieldData(a.currentInstObjKey),e.callback&&e.callback.onCancel&&e.callback.onCancel()},getEntitySaveQp:function(){var t={affected_data:"true",formatted_currency:!0};if(e.callback&&e.callback.getEntitySaveQp){var a=e.callback.getEntitySaveQp();a&&(t=Object.assign(t,a))}return t},beforeRender:function(t){u.setDataObjValues(t,u),u.setRLreadOnlyAndToolTip(t,u,e)},beforeReady:function(e,t){u.setSecisvalid(t.layoutArr[0].sections,e.field,e.currentInstObjKey)},onRecValueChange:function(e,t,a){!0===Crm.userDetails.FIELD_OF_LOOKUP_ENABLED&&!0===Crm.userDetails.FIELD_OF_LOOKUP_AVAIALBLE&&u.fieldLookupHandleForQuickCreate(e,t,a)},onBeforeSaveFailure:function(t,a){if(e.callback&&e.callback.onBeforeSaveFailure)return e.callback.onBeforeSaveFailure(t,a,$L("."+r+"QC_EntitySetup_"+p)[0].closePop)},onSaveFailure:function(){e.callback&&e.callback.onSaveFailure&&e.callback.onSaveFailure(response,data,$L("."+r+"QC_EntitySetup_"+p)[0].closePop)}},initialReqDetail:i,currentInstObjKey:p,disableDetails:{currsubformApinames:!0},formConfigurations:e.formConfigurations})},fieldLookupHandleForQuickCreate:function(e,t,a){a.fieldsList[0].sectionCustomDetails.fields.forEach((function(e){e.fieldRecord.visible&&e.fieldRecord.association_details&&validationUtils.isNotEmpty(e.fieldRecord.association_details)&&e.fieldRecord.association_details.lookup_field.api_name===t[0]&&Lyte.objectUtils(e.fieldRecord.view_type,"add","edit",!0)}))},parseOnlyDirtyAttributes:function(e,t){for(var a={},i=e.length,r=0;r<i;r++)a[e[r]]=t[e[r]];return a},setDataObjValues:function(e,t){for(var a=e.currentInstObjKey,i=t.parseFieldsList,r=e.fieldsList[0].sectionCustomDetails.fields.length,o=0;o<r;o++){var n=i[0].sectionCustomDetails.fields.filter((function(t){return t.fieldRecord.id===e.fieldsList[0].sectionCustomDetails.fields[o].fieldRecord.id}));n&&n.length>0&&(e.fieldsList[0].sectionCustomDetails.fields[o].fieldRecord.required=n[0].fieldRecord.required,e.fieldsList[0].sectionCustomDetails.fields[o].fieldRecord.read_only=n[0].fieldRecord.read_only,e.fieldsList[0].sectionCustomDetails.fields[o].fieldRecord.read_only&&(e.fieldsList[0].sectionCustomDetails.fields[o].fieldRecord[a].validate_read_only=!0),e.fieldsList[0].sectionCustomDetails.fields[o].fieldRecord.view_type.edit=n[0].fieldRecord.view_type.edit)}},setRLreadOnlyAndToolTip:function(e,t,a){var i=e.currentInstObjKey,r=a.editableFieldsRL;if(r&&r.length)for(var o=e.fieldsList&&e.fieldsList.length&&e.fieldsList[0].sectionCustomDetails&&e.fieldsList[0].sectionCustomDetails.fields?e.fieldsList[0].sectionCustomDetails.fields.length:0,n=0;n<o;n++)r.contains(e.fieldsList[0].sectionCustomDetails.fields[n].fieldRecord.id)||(e.fieldsList[0].sectionCustomDetails.fields[n].fieldRecord.read_only=!0,e.fieldsList[0].sectionCustomDetails.fields[n].fieldRecord[i].fieldTooltipvalue=I18n.getMsg("crm.locking.field.locked"))},setSecisvalid:function(e,t,a){var i;e.filter((function(e){(e&&e[a]&&e[a].type&&"used"===e[a].type||e.screen)&&e.fields&&e.fields.some((function(r){if(r.id===t.id)return i=e,r;r.visible&&(e[a].isvalidSection=!0)}))})),i[a].isvalidSection=!0},constructParseFieldsList:function(e,t,a){var i=[];return e.forEach((e=>{(t.filter((function(t){return e.id===t.id})).length>0||e.fieldRecord.view_type.edit||e.fieldRecord.association_details&&validationUtils.isNotEmpty(e.fieldRecord.association_details))&&(e.fieldRecord[a].quickCreateEditField=!0,i.push({fieldRecord:e.fieldRecord,fieldCustomDetails:{sequence_number:e.sequence_number,reqYield:!1}}))})),t.forEach((t=>{if(0==e.filter((function(e){return t.id===e.id})).length){var r=store.peekRecord("field",t.id);r&&(r[a].quickCreateEditField=!0,r.view_type.edit=!1,i.push({fieldRecord:r,fieldCustomDetails:{sequence_number:i.length+1,reqYield:!1}}))}})),[{sectionRecord:{display_label:"QuickCreateview QC",name:"QuickCreateview QC",type:"used",sequence_number:1},sectionCustomDetails:{display_label:"QuickCreateview QC",sequence_number:1,tab_traversal:1,fields:i}}]},checkForVisiblity:function(e,t,a,i,r=null){var o,n=[];return i&&i.blueprint&&i.blueprint.process_info&&i.blueprint.process_info.field&&(o=i.blueprint.process_info.field.id),e.forEach((function(e){var i=t.filter((function(t){var a=t;return"edit"===r&&(a=t.fieldRecord),a.id===e.id}));if(i&&i.length>0){var s="edit"===r?i[0].fieldRecord:i[0];!s.visible||s.read_only||a&&!a.contains(s.id)||void 0!==o&&o===s.id||n.push(e)}})),n},executeLayoutValidationRuleForQuickCreate:function(e){var t=e.moduleInfo,a={},i=e.getEntityData?e.entityData:e.entityData[0];this.setData("moduleData",t);var r=this.getData("valRuleData");r&&r.AllowByAlert&&this.setData("valRuleData",void 0);var o=i.Layout?i.Layout.id:t.layouts[0].id;e.isCsriptNotNeeded=!1,e.currentLayoutId=o;var n=store.peekRecord("layout",o);this.setData("moduleSections",n.sections);var s=Lyte.registeredMixins["crm-create-init-mixin"],l=s.getDynamicCurrentInstanceObjKey({actionName:"KvAjaxEdit"});s&&l&&(this.setData("currentInstObjKey",l),s.generateCurrentInstanceObject({instanceObjKey:l,moduleData:t,moduleSections:n.sections,moduleFields:t.fields}));var d={instanceKey:l,moduleData:t,moduleSections:n.sections};e.layoutRule||!0!==Crm.userDetails.LAYOUTRULEAVAILABLE||-1===Crm.userDetails.LRINVOLVEDMODULES.indexOf(t.module_name)||(a.layoutRule=store.findAll("layout_rule",{module:t.api_name},{layoutId:o,module:t.api_name},!0,o)),e.validationRule||!0!==Crm.userDetails.VALIDATIONRULEAVAILABLE||-1===Crm.userDetails.VRINVOLVEDMODULES.indexOf(t.module_name)||(a.validationRule=store.findAll("validation_rule",{layout_id:o,module:t.api_name,download_rules:!0},{layoutId:o,module:t.api_name})),e.getEntityData&&(!0===Crm.userDetails.LAYOUTRULEAVAILABLE&&-1!==Crm.userDetails.LRINVOLVEDMODULES.indexOf(t.module_name)||!0===Crm.userDetails.VALIDATIONRULEAVAILABLE&&-1!==Crm.userDetails.VRINVOLVEDMODULES.indexOf(t.module_name)||e.isclosedWonLostCase)?a.recordInfo=store.findRecord(t.id,i.id,{approved:"both"},!0,!0,{}):a.recordInfo=e.entityData,Lyte.resolvePromises(a).then(function(t){var a=i[e.field.api_name];Lyte.objectUtils(i,"add",e.field.api_name,e.actual_value);var r=e.layoutRule?e.layoutRule:t.layoutRule,n=e.validationRule?e.validationRule:t.validationRule,s=[],c=0,u=!0,m=e.moduleInfo.module_name,p=e.moduleInfo,f=e.field.pick_list_values?this.getForecastType(e.field.pick_list_values,e.actual_value):"";e.record=t.recordInfo[0],p[l].skipValidationForlayoutRuleCase={Show_Fields:!1,Show_Sections:!1,Mandatory_Fields:!0,Show_Subforms:!1};var _={layoutRulesResponse:{layout_rule:r},validationRuleResponse:n,moduleObject:p,layoutResponse:e.layoutData?e.layoutData:void 0,entityResponse:t.recordInfo},y=p.fields.sortBy("api_name");this.existingFieldsOnUpdate=Lyte.deepCopyObject(y);var g=this,v=y.length,h=[],D=!1,b=!1;"Potentials"===m&&(!f||"Closed Won"!==f&&"Closed Lost"!==f||(u=!1,D=!0,(O=y.filter((function(e){return("Amount"===e.api_name||"Closing_Date"===e.api_name||"Stage"===e.api_name)&&e[o]&&e.visible}))).forEach(function(e){++c,"Stage"===e.api_name&&(e.read_only=!0),e.required=e[o].required,h.push({api_name:e.api_name,id:e.id,fieldRecord:e,sequence_number:c})}.bind(this)),(O=y.filter((function(e){return"Reason_For_Loss__s"===e.api_name})))&&O.length>0&&O[0].visible&&"Closed Lost"===f&&(i.Reason_For_Loss__s=void 0,O[0].required=O[0][o]?O[0][o].required:O[0].required,h.push({api_name:O[0].api_name,id:O[0].id,fieldRecord:O[0],sequence_number:++c}))));var L=!this.data.record||!this.data.record.$approval_state||"approval_process_pending"!==this.data.record.$approval_state;if(!0===Crm.userDetails.FIELD_OF_LOOKUP_ENABLED&&!0===Crm.userDetails.FIELD_OF_LOOKUP_AVAIALBLE&&e.actual_value&&L){var C=y.filter((function(t){if(t.visible&&t.association_details&&validationUtils.isNotEmpty(t.association_details)&&t.association_details.lookup_field.api_name===e.field.api_name&&(void 0===e.editableFieldsRL||e.editableFieldsRL.contains(t.id)))return t}));C.forEach(function(e){h.push({api_name:e.api_name,id:e.id,fieldRecord:e,sequence_number:++c})}.bind(this)),C&&0==C.length&&(u=!1)}else u=!1;r&&r.length>0&&this.checkForLayoutRule(l,e,r,i,s,g,e.field);var I=g.getData("record"),E=(I=I||i)&&I.$process_flow?e.bluePrintInfo?e.bluePrintInfo:Lyte.Router.getRouteInstance().currentModel.blueprint_exec_info:void 0;s=this.checkForVisiblity(s,y,e.editableFieldsRL,E);var R=h.length+s.length,S=0;if(r&&r.length>0&&s&&s.length>0){var F=h.length;for(let e=0;e<v;e++){let t=h.filter((function(t){return t.id===y[e].id}));var O=s.findIndex((function(t){if(t.id===y[e].id)return!0}));if(t&&t.length>0)--F,-1!==O&&(++S,t[0].fieldRecord.required=!0);else if(h.push({api_name:y[e].api_name,id:y[e].id,fieldRecord:y[e],sequence_number:0}),-1!==O){u=!1;var k=O+1+c-S;h[F+e].sequence_number=k>c?k:O+1+c,h[F+e].fieldRecord.required=!0,h[F+e].fieldRecord.view_type.edit=!0}else++R,h[F+e].sequence_number=R,h[F+e].fieldRecord.view_type.edit=!1}this.openQuickCreatePopup(e,e.field.api_name,a,_,m,h,i,D?I18n.getMsg("crm.potential.verify"):I18n.getMsg("crm.lr.heading.details.required"),D?{}:{footer:I18n.getMsg("crm.lr.sub.heading.details.required")},!1,!D,g,b,d)}else D?this.openQuickCreatePopup(e,e.field.api_name,a,_,m,h,i,I18n.getMsg("crm.potential.verify"),{},!1,!1,g,b,d):u?(e.isCsriptNotNeeded=!0,this.openQuickCreatePopup(e,e.field.api_name,a,_,m,h,i,I18n.getMsg("crm.field.of.lookup.fields.related.fields"),{header:I18n.getMsg("crm.field.of.lookup.fields.related.fields.custom.message3",$ESAPI.encoder().encodeForHTML(e.field.field_label))+I18n.getMsg("crm.field.of.lookup.fields.related.fields.custom.message2")},!0,!1,g,b,d)):n&&n.length>0?(e.isCsriptNotNeeded=!0,this.executeValidationRuleQuickCreate(d,e,_,i,n,p,e.field.api_name,a,g,[])):this.entitySave(e,i,d)}.bind(this))},resetFieldData:function(e){var t=this.existingFieldsOnUpdate,a=this.getData("moduleData");a[e]&&delete a[e].skipValidationForlayoutRuleCase;var i=a.fields.sortBy("api_name"),r=t.length;for(let a=0;a<r;a++)i[a].required!==t[a].required&&Lyte.objectUtils(i[a],"add","required",t[a].required),i[a].view_type.edit!==t[a].view_type.edit&&Lyte.objectUtils(i[a].view_type,"add","edit",t[a].view_type.edit),i[a].read_only!==t[a].read_only&&Lyte.objectUtils(i[a],"add","read_only",t[a].read_only),e&&i[a][e]&&(delete i[a][e].validate_read_only,delete i[a][e].quickCreateEditField,delete i[a][e].ShowFldsValidatedAndPassedQC,delete i[a][e].ShowFldsValidatedAndPassedSecQC,delete i[a][e].quickCreatePrimaryField),delete i[a].isNewlyAdded,delete i[a].forValidationRule},resetInstanceData:function(e,t,a){for(var i=t.fields.length,r=0;r<i;r++)delete t.fields[r][e];a&&a.length&&a.forEach((function(t){delete t[e],t.fields&&t.fields.length&&t.fields.forEach((function(t){t&&delete t[e]}))})),delete t[e]},pushTextField:function(e,t){var a={api_name:"Reason_For_Loss",id:"",fieldRecord:{api_name:"Reason_For_Loss",data_type:"textarea",display_label:"Reason For Loss",field_label:"Reason For Loss",length:32e3,read_only:!1,required:!1,ui_type:3,view_type:{view:!0,edit:!0,quick_create:!0,create:!0}}};a.fieldRecord[t]={},e.push(a)},entitySave:function(e,t,a){var i={},r=store.peekRecord(moduleRecordMapping[e.moduleInfo.module_name].id,t.id);Lyte.objectUtils(r,"add","api_name",e.actual_value);var o={affected_data:"true",formatted_currency:!0};if(e){var n,s;if(e.moduleInfo&&"Tasks"===e.moduleInfo.module_name)(s=(n=$L("crm-task-markascompleted-popup")[0])?n.component.data:void 0)&&s.showNotifyOwnerChecked&&(i=n.component.executeMethod("setCustomDataToSendMail"));e.customDataFeature&&(i.feature=e.customDataFeature),e.newAffectedDataNeeded&&(o.affected_data_new=!0,i.record_dirty_props=r.$.getDirtyAttributes(),e.customReturnData||(e.customReturnData={}),e.customReturnData.record_dirty_props=i.record_dirty_props)}(e&&e.skipFreezeLayer||renderingUtils.freezeBackground(),commonUtils.showHideLoadingDiv(!0),a&&a.moduleData&&"Tasks"===a.moduleData.api_name)&&((s=(n=$L("crm-tasks-markascomplete")[0])?n.component.data:void 0)&&s.showNotifyOwnerChecked&&(i=n.component.executeMethod("setCustomDataToSendMail",i)),s&&n.component.removePopup(n.component.data.elementId));if(this.getData("unblockEmailandUpdateRecord")&&(i.skipblocklistValidation=!0,this.setData("unblockEmailandUpdateRecord",!1)),"email"===e.field.data_type){let t=$L("#"+e.field.$ids.value_containerId+"_comp")[0];t&&t.setData("email_unsubscribed_info",void 0)}r.$.save(i,o).then(function(t){var i=$("crm-multi-selection-popup")[0];if("multiselectlookup"===e.field.data_type&&i&&i.component.AfterSave(e.actual_value,"confirm"===i.component.data.action),commonUtils.showHideLoadingDiv(),renderingUtils.removeFreezeLayer(),e.callback&&e.callback.onSave&&(e.isRequiredAdditionalInfo?e.callback.onSave(t,"success",e.customReturnData):e.callback.onSave(t,"success")),"Campaigns"===e.moduleInfo.module_name&&"ACTUALCOST"===e.field.column_name){var o=document.querySelector("crm-campaign-analytics");o&&o.setData({reInit:!o.getData("reInit"),isLoading:!0})}"email"===e.field.data_type&&this.updateEmailUnsubscriptionDetails(r,e.moduleInfo),this.resetInstanceData(a.instanceKey,a.moduleData,a.moduleSections)}.bind(this),function(t){commonUtils.showHideLoadingDiv(),renderingUtils.removeFreezeLayer(),e.callback&&e.callback.onSave&&e.callback.onSave(t,"error"),this.resetInstanceData(a.instanceKey,a.moduleData,a.moduleSections)}.bind(this))},getForecastType:function(e,t){for(var a=e.length,i=0;i<a;i++)if(e[i].display_value===t)return e[i].forecast_type?e[i].forecast_type:""},portalErrorResponse:function(e){if(e&&e.response){if((e=JSON.parse(e.response))&&e.data&&e.data[0]&&("INVALID_DATA"===e.data[0].code||"NO_PERMISSION"===e.data[0].code)){if("You cannot assign this email address to this portal user type, since the domain matches the super admin's domain."===e.data[0].message)return crmui.showMsgBand("error",I18n.getMsg("custmr.prtl.email.domain.check.failed"),4e3),void commonUtils.showHideLoadingDiv();if("You cannot send the portal invitation since the email address has the following characters"===e.data[0].message)return crmui.showMsgBand("error",I18n.getMsg("portal_invite_email_is_not_supported")+" "+e.data[0].details.inValidChars,4e3),void commonUtils.showHideLoadingDiv();if("Invalid phone number kindly check country code or extension should not be present"===e.data[0].message)return _cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.inv.rstrct.phone.invld"),ltPropType:"error",ltPropDuration:4e3}}),void commonUtils.showHideLoadingDiv();"You don't have permission to edit the primary invitation field of the portal user. To update this field, please contact the portal admin."===e.data[0].message&&(_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("custmr.prtl.perm.den.inv.fld.edit"),ltPropType:"error",ltPropDuration:4e3}}),commonUtils.showHideLoadingDiv())}if("NOT_ALLOWED"===e.code&&"portal users cannot edit invited field value"===e.message)$("crm-create-buttons")[0].setData("disableFormbuttons",!1),renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("custmr.prtl.inv.fld.ed.no.perm"))}},getValidationFeatureSpecificInfo:function(){var e=!1;if(this&&this.getData()){var t=this.getData("validationRule");t&&t.forEach((function(t){var a=t.conditions;a&&a.forEach((function(t){t.alert_type&&"allow_by_alert"===t.alert_type?e=!0:t.sub_conditions&&t.sub_conditions.length>0&&t.sub_conditions.forEach((function(t){t.alert_type&&"allow_by_alert"===t.alert_type&&(e=!0)}))}))}))}if(e){var a={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},i="/crm/v2.2/"+this.getData("moduleData").api_name+"/"+this.getData("entityId")+"/actions/get_feature_specific_info";store.findAll("dummy",{features:"validation_rules"},!1,!1,{url:i,method:"GET",headers:a}).then((function(e){$L("crm-detail-view")[0].setData("valFeatureSpecinfo",e.data[0].features_info[0].details)}))}},getLayoutAndvalidationRuleFields:function(e,t,a){e.forEach((function(e){"layoutRule"===a?(0===t.filter((function(t){return e.primary_field.id===t.id})).length&&t.push(e.primary_field),e.queries.forEach((function(e){e.criteria.field?0===t.filter((function(t){return e.criteria.field.id===t.id})).length&&t.push(e.criteria.field):e.criteria.forEach((function(e){"string"!=typeof e&&e.field&&0===t.filter((function(t){return e.field.id===t.id})).length&&t.push(e.field)})),e.actions.forEach((function(e){"Mandatory_Fields"===e.type&&e.fields.forEach((function(e){0===t.filter((function(t){return e.id===t.id})).length&&t.push(e)}))}))}))):(0===t.filter((function(t){return e.field.id===t.id})).length&&t.push(e.field),e.conditions&&e.conditions.length>0&&e.conditions.forEach((function(e){e.sub_conditions.forEach((function(e){e.criteria.field?0===t.filter((function(t){return e.criteria.field.id===t.id})).length&&t.push(e.criteria.field):e.criteria.forEach((function(e){"string"!=typeof e&&e.field&&0===t.filter((function(t){return e.field.id===t.id})).length&&t.push(e.field)}))}))})))}))},isValidInventorySubField:function(e,t){return!t||!["BOOKID","ITEMDESCRIPTION","TOTALAFTERDISCOUNT","LINETAX"].contains(e.column_name)},showExistingPBLookup:function(){if(!moduleRecordMapping||!validationUtils.isEmpty(moduleRecordMapping.PriceBooks)){var e=this.data.subformFields,t=this.data.parentSubformdata,a=this.data.currentInstObjKey;if(t&&t[a].isdefaultInvSubform&&t.fields){var i=t.fields.filter((function(e){return"BOOKID"===e.column_name}))[0];i&&(e=i)}var r=document.querySelector(".frominvSubPBLyteFields");r&&r.classList.remove("frominvSubPBLyteFields"),this.$node.classList.add("frominvSubPBLyteFields");var o="",n=this.data.id,s=this.data.currentLayout,l=this.data.moduleData,d=e.id,c=this.data.moduleData.module_name,u=moduleRecordMapping.PriceBooks;if(s=s?s.split(";")[0]:null,u.module_name){o=Crm.getCrmBasePath()+"/Search.do?searchmodule="+u.module_name+"&fldName="+n+"&fldId="+n+"&fldLabel="+u.module_name+"&fldValue=&newModel="+!0;Crm.userDetails.isLookupAdvancedSearchEnabled?o=o+"&condition=null&parentLayoutId="+s+"&parentModule="+c+"&fieldId="+d:(o=o+"&layoutId="+s+"&lookupFieldId="+d+"&condition=null&notInMultiModLookup="+void 0,u.module_name!==c||e.custom_field||"edit"!==this.getData("initRoute")||(o=o+"&seId="+this.getData("dataBind.id")))}l[a].currencyData&&l[a].currencyData.key?o=o+"&currencyISOCode="+l[a].currencyData.key:o+="&currencyISOCode=",t&&t[a].isdefaultInvSubform&&(o+="&isSubFormField=true");var m,p=this.data.databindSubform.$.model.fieldList;for(var f in p){if("PRODUCTID"===p[f].columnName){var _=this.data.databindSubform[f];if(_&&_.id&&_.name){m=_.id;break}}}m&&(o+="&productId="+m),commonUtils.openCustomLookup(o,void 0,"topBandPopup",renderingUtils.windowWidth-300)}},getRoundOff:function(e,t,a){var i,r=e.column_name;if(a&&a.isGrandField&&(i=!0),Crm.userDetails.lineItemFormulaCalcFlow&&objectUtils.getKeys(Crm.userDetails.lineItemFormulaCalcFlow).length>0&&(i&&Crm.userDetails.lineItemFormulaCalcFlow[Crm.current__inventory__module].aggrFields[r]||!i&&Crm.userDetails.lineItemFormulaCalcFlow[Crm.current__inventory__module][r]))return this.getRoundOffValue(t,!0,void 0,{roundOffDetail:this.getInventoryRoundOffDetail()});var o=e.ui_type,n=e.decimal_place;n=void 0===n?0:n;var s=Math.pow(10,n);if(t&&t.toString().indexOf("e")>-1||t.toString().indexOf("E")>-1)t=Number(Math.round(t,s));else switch(o){case 36:case 143:case 144:case 145:t=Number(this.getRoundOffValue(t,!0,n))}return void 0===t?0:parseFloat(currencyUtils.getWholeOrDecimalValue(t,n))},getRoundOffValue:function(e,t,a,i){var r={roundOff:2,roundOffPrecision:Math.pow(10,2)};if(i&&i.roundOffDetail&&objectUtils.getKeys(i.roundOffDetail).length>0&&(r=i.roundOffDetail),void 0!==a){var o=Math.pow(10,a),n=Math.sign(parseFloat(e)*o)*Math.round(Math.abs((parseFloat(e)*o).toFixed(a)));return t?(n/o).toFixed(a):n/o}n=Math.sign(parseFloat(e)*r.roundOffPrecision)*Math.round(Math.abs((parseFloat(e)*r.roundOffPrecision).toFixed(r.roundOff)));return t?(n/r.roundOffPrecision).toFixed(r.roundOff):n/r.roundOffPrecision},getTaxDisplayNameSFLineItem:function(e){if(e.lastIndexOf("-")>-1&&e.indexOf("%")>-1){var t=e.lastIndexOf("-");return-1!==e.substring(t).indexOf("%)")?(e=e.substring(0,t)).trim().substring(0,e.lastIndexOf("-")-1).trim():e.substring(0,t).trim()}return e},getTaxPercentSFLineItem:function(e){var t;if(e&&e.lastIndexOf("-")>-1&&e.indexOf("%")>-1){var a=e.lastIndexOf("-"),i=e.substring(a);t=-1!==i.indexOf("%)")?i.substring(0,i.indexOf("%")).trim():e.substring(a+1,e.lastIndexOf("%")).trim()}return t},isInventoryModule:function(e){return"Quotes"===e||"Invoices"===e||"SalesOrders"===e||"PurchaseOrders"===e},setGrandTaxValue:function(e){if(e){var t,a=e.selectedTaxArr,i=[],r=a.length||0,o=this.data.clonedRecord||this.data.dataBind,n=0,s=e.taxFieldMeta||this.data.aggregateFields.filter((function(e){return"TAX"===e.column_name}))[0],l={isGrandField:!0};if(r){for(var d=0;d<r;d++){var c=a[d],u=0;if(c.isTaxConsidered&&(isNaN(c.taxPercent)||c.taxPercent>100||isNaN(parseFloat(c.taxPercent))))t=!0,Lyte.objectUtils(c,"add","displayTaxError",!0);else if(c.isTaxConsidered){Lyte.objectUtils(c,"add","displayTaxError",!1);var m=o.Sub_Total;m=isNaN(m)?0:m;var p=o.Discount;o.$&&o.$.error&&o.$.error.Discount&&(o.$.error.Discount.value||0===o.$.error.Discount.value&&!isNaN(o.$.error.Discount.value))&&(p=o.$.error.Discount.value);var f=p;f=isNaN(f)?0:f;u=(parseFloat(m)-parseFloat(f))*c.taxPercent/100;u=isNaN(u)?0:u,u=this.getRoundOff(s,u,l);var _={name:c.taxLabel,percentage:c.taxPercent,value:c.taxAmt};c.taxId?_.id=c.taxId:_.id=null,i.push(_)}n+=isNaN(u)?0:Number(u)}if(t)return!0;n=this.getRoundOff(s,n,l),n=isNaN(n)?n:Number(n),o.$.set("Tax",n),o.$.set("$line_tax",i)}}},updateInvGrandDisAndTaxValues:function(e){var t,a,i=e._LC_additional_INV_subform_INFO||{};if(i.discountObj){var r=i.discountObj;if(r.chkdinvDisPercent){t=r.disPercentValue;var o=e.Sub_Total;o=isNaN(o)?0:o,o=parseFloat(o),t=isNaN(t)?0:t,t=o*(t=parseFloat(t))/100}else r.chkdinvDirectPrice&&(a=!0)}t=parseFloat(!t||isNaN(t)?0:t);var n=e.$.model.fieldList,s={isGrandField:!0};if(!a&&n&&n.Discount){var l=n.Discount;if("DISCOUNT"===l.columnName){var d=store.peekRecord("field",l.fieldID);if(d){var c=this.getRoundOff(d,t,s);c=isNaN(c)?c:Number(c),e.$.set("Discount",c)}}}if(n&&n.Tax){var u=n.Tax;if("TAX"===u.columnName){var m=store.peekRecord("field",u.fieldID);if(m){var p=i.currentTaxDetails;p&&p.selectedTaxArr?this.setGrandTaxValue({selectedTaxArr:p.selectedTaxArr,taxFieldMeta:m}):e.$.set("Tax",0)}}}this.formulaWorkerExecution(this.getData("moduleFormulafields"),{},e,void 0,!0)},updateGrandInvTaxBasedOnGrandDiscount:function(){var e=this.data.dataBind,t=e._LC_additional_INV_subform_INFO||{},a=e.$.model.fieldList;if(a&&a.Tax){var i=a.Tax;if("TAX"===i.columnName){var r=store.peekRecord("field",i.fieldID);if(r){var o=t.currentTaxDetails;o&&o.selectedTaxArr?this.setGrandTaxValue({selectedTaxArr:o.selectedTaxArr,taxFieldMeta:r}):e.$.set("Tax",0)}}}},validatePricingDetails:function(e,t,a){let i="saveasdraft"===t;if(!e)return!0;var r,o,n=e.recordObj,s=e.compData,l=!1;s&&(r=s.component.data);var d=e.currentInstObjKey?e.currentInstObjKey:this.data.currentInstObjKey;r&&(r.moduleSections||[]).forEach((function(e){"default"===e.generated_type&&"Pricing Details"===e.name&&(o=e[d].pricingDetApiName,e[d].isvalidSection||(l=!0))}));o=o||"Pricing_Details",e.pricingDetApiName=o;var c=n[o],u=I18n.getMsg("From Range"),m=I18n.getMsg("To Range"),p=I18n.getMsg("Discount (%)"),f=(c=c||[]).length,_=$L("#PriceBooks_fldRow_PRICINGDETAILS")[0],y=!1;f&&c.forEach((function(e){Lyte.objectUtils(e,"add","fromRangeError",""),Lyte.objectUtils(e,"add","toRangeError",""),Lyte.objectUtils(e,"add","discountError","")}));for(var g=0;g<f;g++){var v,h,D,b="string"==typeof c[g].from_range?c[g].from_range.trim():c[g].from_range,L="string"==typeof c[g].to_range?c[g].to_range.trim():c[g].to_range,C="string"==typeof c[g].discount?c[g].discount.trim():c[g].discount,I=void 0!==b?""===b?void 0:parseFloat(b):void 0,E=void 0!==L?""===L?void 0:parseFloat(L):void 0,R=void 0!==C?""===C?void 0:parseFloat(C):void 0;if(void 0===I||""===b)i||(v=I18n.getMsg("crm.field.empty.check",u));else if(isNaN(b))v=I18n.getMsg("crm.field.valid.check",u);else{var S={val:I,maxLen:19,decimalPlace:2,fldLabel:u};v=this.getPricingDetailsError(S)}if(void 0===E||""===L)i||(h=I18n.getMsg("crm.field.empty.check",m));else if(isNaN(L))h=I18n.getMsg("crm.field.valid.check",m);else{var F={val:E,maxLen:19,decimalPlace:2,fldLabel:m};h=this.getPricingDetailsError(F)}if(void 0===R||""===C)i||(D=I18n.getMsg("crm.field.empty.check",p));else if(isNaN(C))D=I18n.getMsg("crm.field.valid.check",p);else{var O={val:R,maxLen:19,decimalPlace:2,fldLabel:p};D=this.getPricingDetailsError(O)}v&&Lyte.objectUtils(c[g],"add","fromRangeError",v),h&&Lyte.objectUtils(c[g],"add","toRangeError",h),D&&Lyte.objectUtils(c[g],"add","discountError",D),E<I&&Lyte.objectUtils(c[g],"add","toRangeError",c[g].toRangeError||I18n.getMsg("crm.alert.selected.rangevalue"));for(var k=0;k<f;k++)if(g!==k){var w="string"==typeof c[k].from_range?c[k].from_range.trim():c[k].from_range,N="string"==typeof c[k].to_range?c[k].to_range.trim():c[k].to_range,T=void 0!==w?""===w?void 0:parseFloat(w):void 0,M=void 0!==N?""===N?void 0:parseFloat(N):void 0;(I>=T&&I<=M||E>=T&&E<=M&&k>g)&&Lyte.objectUtils(c[k],"add","fromRangeError",c[k].fromRangeError||I18n.getMsg("crm.alert.selected.rangevalue"))}}c&&(c||[]).some((function(e){if(!y&&(e.fromRangeError||e.toRangeError||e.discountError))return y=!0,!0}));if(r&&_&&(r.moduleData[d].skipPricingDtlsInPayload=!!l),"crm-canvas-form"===e.compData.tagName.toLowerCase()&&!_&&(r.moduleData[d].skipPricingDtlsInPayload=!!l,!l))return!1;if(y&&_)return _.classList.add("pderrorField"),l||!1;if(_)_.classList.remove("pderrorField");else if(y&&a)return!1;return!y&&c&&c.length&&c.forEach((function(e){delete e.fromRangeError,delete e.toRangeError,delete e.discountError,e.from_range=parseFloat(e.from_range),e.to_range=parseFloat(e.to_range),e.discount=parseFloat(e.discount)})),!0},getPricingDetailsError:function(e){return e?function(e,t,a){var i=(t+="").length;a&&-1!==t.indexOf(".")&&(i=i?--i:i);return i<=e}(e.maxLen,e.val,!0)?validationUtils.decimalLengthCheck(e.val,e.decimalPlace)?"":I18n.getMsg("crm.field.valid.decimal.check2",[e.fldLabel,e.decimalPlace]):I18n.getMsg("crm.field.length.check",[e.fldLabel]):""},confirmInvoiceCreationWithLowStock:function(e,t){for(var a,i=(e=e||[]).length,r=0;r<i;r++){var o=e[r],n=parseFloat(o.Quantity);n=isNaN(n)?0:n;var s,l=(o._LC_additional_INV_subform_INFO||{}).selProdDetails;if(l){if(!(s=l.Layout&&l.Layout.id?l.Layout.id:void 0)){var d=moduleRecordMapping&&moduleRecordMapping.Products&&moduleRecordMapping.Products.layouts;d&&d[0]&&d[0].id&&(s=d[0].id)}if(s&&!Crm.userDetails.QuantityInStockAvailableLayoutIds.contains(s))continue;if(n>(l.Qty_in_Stock||0)){a=!0;break}}}a&&commonUtils.showHideLoadingDiv(!1);var c=t?I18n.getMsg("crm.invoice.lineitem.ajax.stock.notavailable",[moduleRecordMapping.Products.singular_label,moduleRecordMapping.Invoices.singular_label]):I18n.getMsg("crm.invoice.stock.notavailable.new",[moduleRecordMapping.Products.plural_label,moduleRecordMapping.Invoices.singular_label]);return!a||window.confirm(c)},autoFillInventoryDetails:function(e,t,a){a=a||this.data;var i={},r=["Ordered_Items","Quoted_Items"],o=a.currentInstObjKey;if("SalesOrders"===a.modulenameUicomp&&"QUOTEID"===a.columnName||"Invoices"===a.modulenameUicomp&&("QUOTEID"===a.columnName||"SALESORDERID"===a.columnName)){var n=a.selectedSingle||{};if(Object.keys(n).length||(n=e),n&&n.id){var s="QUOTEID"===a.columnName?"Quotes":"SalesOrders";if(moduleRecordMapping[s]&&moduleRecordMapping[s].id){commonUtils.showHideLoadingDiv(!0);var l={invRECORDSversion:"v4"};store.findRecord(moduleRecordMapping[s].id,n.id,{approved:"both",converted:"both"},void 0,void 0,l).then(function(e){var n=a.module&&a.module.id;n||(n=moduleRecordMapping[s].id);var l=store.modelFor(n),d=l&&l.fieldList,c=e=e&&e[0],u=Promise.resolve();if(d)for(var m in d){var p=d[m];if(p&&"SMOWNERID"===p.columnName&&c[m]){let e=store.peekRecord("user",c[m].id);u=e?Promise.resolve(e):store.findRecord("user",c[m].id)}}var f=this;u.then((n=>{if(commonUtils.showHideLoadingDiv(!1),e){var s;e&&e.$&&e.$.meta&&validationUtils.isNotEmpty(e.$.meta.original)&&(s=e.$.meta.original);var l=a.moduleData&&a.moduleData.fields,u=(l=l||[]).mapByKey("column_name"),m=["LAYOUTID","MODIFIEDBY","MODIFIEDTIME","TAGMODULEREFID","SMCREATORID","CREATEDTIME","SMCREATORID"];if(validationUtils.isNotEmpty(s)&&d&&Object.keys(s).length>0)for(var p in s)c[p]=f.deserializeData(s[p],d[p].type,d[p],c[p]);if(d)for(var _ in d){var y=d[_];if(y&&y.hasOwnProperty("columnName")&&!m.contains(y.columnName)){var g=u.indexOf(y.columnName);if(-1===g&&["SALESORDERSUBJECT","QUOTESUBJECT"].contains(y.columnName)){var v="SalesOrders"===a.modulenameUicomp?"SALESORDERSUBJECT":"INVOICESUBJECT";g=u.indexOf(v)}if(-1!==g&&void 0!==c[_]){var h=l[g];if("SMOWNERID"===y.columnName&&c[_].id){let e=n;if(e&&"active"!==e.status){let e=store.peekRecord("user",Crm.userDetails.USER_ID),t={};for(let a in c[_])t[a]="name"===a?e.full_name:e[a];i[h.api_name]=t;continue}}i[h.api_name]=c[_]}}else if(y&&"relation"===y.type&&r.contains(_)){var D="SalesOrders"===a.modulenameUicomp?"Ordered_Items":"Invoiced_Items",b=a.dataBind&&a.dataBind[D]&&a.dataBind[D].model&&a.dataBind[D].model.fieldList,L=c[_]||[],C=[];L.forEach((function(e,t,a){var i=a.key,r=void 0!==a&&a.key?e.__parent_module__._$.original[i]:void 0,o=Object.assign({},e);for(var n in o.$parent_line_item_id=o.id,delete o.id,delete o.__parent_module__,o)if(b&&b[n]&&b[n].fieldID){var s=store.peekRecord("field",b[n].fieldID);if(s&&s.custom_field&&delete o[n],"CREATEDTIME"===b[n].columnName&&"datetime"===b[n].type&&void 0!==r&&r[t]&&r[t][n]){var l=r[t][n];l=l.replace(/[+-]\d{2}:\d{2}/,""),o[n]=Lyte.registeredMixins["crm-create-mixin"].getDateTimeForForm($L.moment(l).toDate(),!0)}}C.push(o)})),i[D]=C}else"$line_tax"===_&&(i[_]=c[_])}if(i.hasOwnProperty(a.apiName)||(i[a.apiName]=a.dataBind[a.apiName]),Object.keys(i).length&&Lyte.Router.getRouteInstance()){var I=a.moduleData[o].curr_transition_Data;if(I=I||{},t&&validationUtils.isNotEmpty(t.isrelatedListFieldDataPresent)&&(i[t.isrelatedListFieldDataPresent.fldApiName]=t.isrelatedListFieldDataPresent.fldValue),I.isWizard){let e={};const t=$L("crm-create-layout")[0].component;e.screenHistory=t.getData("screenHistory");let a=t.getData("activeScreen");e.activeScreenId=a.id,I.wizardProgress=e}i.$parent_inventory_id=c.id,I.inventoryAutoFillData=i,I.skipDirtyCheck=!0,Lyte.Router.getRouteInstance().refresh({refreshTemplate:!0}).data=I}}}))}.bind(this),(function(){commonUtils.showHideLoadingDiv(!1)}))}}}},fetchInventoryProductDetails:function(e){var t=this;if(e&&e.Product_Name&&e.Product_Name.id&&moduleRecordMapping.Products&&moduleRecordMapping.Products.id&&store.modelFor(moduleRecordMapping.Products.id)&&!e.hasOwnProperty("_LC_additional_INV_subform_INFO")&&e.Product_Name){var a=e.Product_Name,i={};for(var r in a){var o=r;"name"===r&&(o="Product_Name"),i[o]=a[r]}i.__original={},i.__original.Tax=a.Tax,store.pushPayload(moduleRecordMapping.Products.id,i),function(a){a.__original||(a.__original={});var i=a||{},r=a.__original,o=i.$.model.fieldList;if(Object.keys(r).length>0)for(var n in r)o[n]||(o[n]="Tax"===n?{type:"tax"}:{}),i[n]=t.deserializeData(r[n],o[n].type,o[n],i[n]);e._LC_additional_INV_subform_INFO||(e._LC_additional_INV_subform_INFO={});var s=e._LC_additional_INV_subform_INFO;"object"==typeof e._LC_additional_INV_subform_INFO&&(s.selProdDetails=i);var l={selectedTaxArr:t.getUpdatedTaxValue(s,e)},d=e.Line_Tax||[];l.selectedTaxArr.forEach((function(e){var t=e.taxPercent;t="string"==typeof t?t.trim():t,t=isNaN(t)?t:Number(t),d.filter((function(a){var i=a.percentage;return i="string"==typeof i?i.trim():i,i=isNaN(i)?i:Number(i),!a.id&&!e.taxId&&a.name===e.taxLabel&&i===t||e.taxId&&a.id&&e.taxId===a.id}))[0]&&(e.isTaxConsidered=!0)})),s.currentTaxDetails=l;var c={},u=e.Discount;u=parseFloat(!u||isNaN(u)?0:u);var m=e.Total,p=0;p=0!==(m=parseFloat(!m||isNaN(m)?0:m))?u/m*100:isNaN(p)?0:p,c.disPercentValue=p,c.chkdinvDisPercent=!0,validationUtils.isNotEmpty(e.Price_Book_Name)&&e.Price_Book_Name.id&&(c.chkdFromPricebook=!0,c.chkdinvDirectPrice=!1,c.chkdinvDisPercent=!1,s.discountValueSource="priceBook"),s.discountObj=c,Lyte.objectUtils(e,"add","_LC_additional_INV_subform_INFO",s)}(store.peekRecord(moduleRecordMapping.Products.id,i.id))}},setGeneratedTypeForSegments:function(){let e=store.peekRecord("layout",Lyte.Router.getRouteInstance().getQueryParams().layoutId);if(!e)return;let t=e.sections;store.peekAll("wizard-segment").forEach((e=>{if("subforms"===e.type){let a=t.find((t=>t.isSubformSection&&t.fields.find((t=>t.api_name===e.subformApiName))));e.generated_type=a.generated_type}if("composite"===e.type||"fields"===e.type){if(1===e.fields.length&&"PRICINGDETAILS"===e.fields[0].column_name){let a=t.find((e=>1===e.fields.length&&"PRICINGDETAILS"===e.fields[0].column_name));e.generated_type=a.generated_type,e.name=a.name}}}))},getUpdatedTaxValue:function(e,t,a){var i=[];if(e.selProdDetails&&e.selProdDetails.hasOwnProperty("Tax")){var r,o=this.data.databindSubform||t,n=o.$.model.fieldList,s=e.selProdDetails.Tax;if(s=s||[],a&&s.length>0){var l=[];(this.data.moduleData?this.data.moduleData.orgTaxDetails:this.data.moduleInfo.orgTaxDetails).forEach((e=>{var t="string"==typeof s&&s.split(";");t&&t.indexOf(e.display_label)>=0&&l.push({id:e.id,value:e.display_label})})),"string"==typeof s&&(s=l,e.selProdDetails.Tax=s)}if(s&&"string"==typeof s){if(s=JSON.parse(s),e.selProdDetails.__original&&e.selProdDetails.__original.Tax&&(r=e.selProdDetails.__original.Tax),void 0!==r&&s&&s.length){var d=r||[];if(d.length){var c=d.filter((function(e){return s.contains(e.value)}));s=c}}s=s||[]}var u=[],m=Lyte.deepCopyObject(this.data.moduleData?this.data.moduleData.orgTaxDetails:this.data.moduleInfo.orgTaxDetails);if(m.forEach(function(e){u.push({orgTaxString:this.getFinalTaxStringFromNameAndPerc({tax_name:e.name,tax_percent:e.value}),orgTaxId:e.id})}.bind(this)),o&&o.Line_Tax){var p=o.Line_Tax||[];s=this.getFinalMergedTaxArr({isGrandTax:!1,existingTax:p,productTaxInfo:s,orgTaxDetails:m})}for(var f=s.length||0,_=e.currentTaxDetails,y=_&&_.hasOwnProperty("selectedTaxArr")?_.selectedTaxArr:[],g=0;g<f;g++){var v=s[g],h=v.value||v,D={};h=h||"";var b=this.getTaxDisplayNameSFLineItem(h),L={},C={},I=this.getTaxPercentSFLineItem(h);if(!v.id&&e.isNewLineItemadded){var E=this.getFinalTaxStringFromNameAndPerc({tax_name:b,tax_percent:I}),R=u.filter((function(e){return e.orgTaxString===E}))[0];R&&(D=R,L.taxId=D.orgTaxId)}if(o&&o.Line_Tax){var S=(o.Line_Tax||[]).filter((function(e){return e.name===h||e.name===b}));(S&&S.length||0)&&(C=S.filter((function(e){return!(!v.id||!e.id||v.id!==e.id)||(!(!D||!e.id||D.orgTaxId!==e.id)||(!e.id&&!v.id&&e.percentage==I||(void 0===I&&!e.id&&h===e.name||void 0)))}))[0]),(C=C||{}).id&&(L.taxId=C.id)}var F=C.hasOwnProperty("percentage")?C.percentage:this.getTaxPercentSFLineItem(h);if(y&&y.length)for(var O=y||[],k=O.length,w=0;w<k;w++){var N,T=O[w];N="string"==typeof(N=Crm.userDetails.canEditTaxValue&&T.isTaxConsidered?T.taxPercent:"string"==typeof F?F.trim():F)?N.trim():N,N=isNaN(N)?N:Number(N);var M=T.taxPercent;if(M="string"==typeof M?M.trim():M,M=isNaN(M)?M:Number(M),T.taxLabel===b&&N===M&&!T.isFoundandExecuted){T&&T.hasOwnProperty("isTaxConsidered")&&(L.isTaxConsidered=T.isTaxConsidered,Crm.userDetails.canEditTaxValue&&L.isTaxConsidered&&(F=T.taxPercent)),T.isFoundandExecuted=!0;break}}F="string"==typeof F?F.trim():F;var P=o.Total,$=o.Discount;o.$&&o.$.error&&o.$.error.Discount&&(o.$.error.Discount.value||0===o.$.error.Discount.value&&!isNaN(o.$.error.Discount.value))&&($=o.$.error.Discount.value);var A=(P-$)*F/100;if(n&&n.Tax&&"TAX"===n.Tax.columnName){var U=store.peekRecord("field",n.Tax.fieldID);U&&(A=this.getRoundOff(U,A))}F=parseFloat(F);var x=b+"_"+F+"_tax_checkbox",V=b+"_"+F+"_percentage";L.zcqa_check_box=x,L.zcqa_tax_perc=V,L.taxPercent=F,L.taxAmt=A,L.taxLabel=b,v.id&&(L.taxId=v.id),v.hasOwnProperty("id")&&null===v.id&&(D&&D.orgTaxId?L.isTaxIdNull=!1:L.isTaxIdNull=!0),!(!e.isNewLineItemadded||!L.isTaxIdNull)||i.push(L)}y&&y.length&&y.forEach((function(e){e&&e.hasOwnProperty("isFoundandExecuted")&&delete e.isFoundandExecuted}))}return i},setTaxValue:function(e,t){if(e){for(var a,i=e.selectedTaxArr,r=i.length||0,o=t||this.data.databindSubform,n=0,s=e.taxFieldMeta||this.data.subformFields,l=[],d=0;d<r;d++){var c=i[d],u=0;if(c.isTaxConsidered&&(isNaN(c.taxPercent)||c.taxPercent>100||isNaN(parseFloat(c.taxPercent))))a=!0,Lyte.objectUtils(c,"add","displayTaxError",!0);else if(c.isTaxConsidered){Lyte.objectUtils(c,"add","displayTaxError",!1);var m=o.Total;m=isNaN(m)?0:m;var p=o.Discount;o.$&&o.$.error&&o.$.error.Discount&&(o.$.error.Discount.value||0===o.$.error.Discount.value&&!isNaN(o.$.error.Discount.value))&&(p=o.$.error.Discount.value);var f=p;f=isNaN(f)?0:f;u=(parseFloat(m)-parseFloat(f))*c.taxPercent/100;u=isNaN(u)?0:u;var _={name:c.taxLabel,percentage:Number(c.taxPercent),value:c.taxAmt};c.taxId?_.id=c.taxId:_.id=null,l.push(_)}n+=isNaN(u)?0:u}if(a)return!0;n=this.getRoundOff(s,n,{}),n=isNaN(n)?n:Number(n),o.$.set("Tax",n);var y=this.data,g=y.parentSubformdata?y.parentSubformdata.subform_apiname:void 0;y.iscpqVerifyDetailsSubform&&(g=y.parentSubformdata.cpq_subform_apiname);var v="crm-create-subformfields#"+y.moduleName+"_"+g+"_R"+(y.indexVal+1)+"_Tax",h=$L(v+" lyte-input")[0];if(h&&h.ltProp("value",n),o.$.set("Line_Tax",l),!e||!e.skipFormulaUpdate){var D=$L(v)[0];D&&D.component.triggerFormulaCalcWrapper()}}},getGrandTaxArrayDetails:function(e){var t,a=(e=e||{}).entityRecord;e.taxDetails&&(t=e.taxDetails);var i=[],r=t;if(r&&"string"==typeof r&&(r=(r=JSON.parse(r))||[]),a&&a.$line_tax){var o=a.$line_tax||[];r=this.getFinalMergedTaxArr({isGrandTax:!0,existingTax:o,productTaxInfo:r,orgTaxDetails:Lyte.deepCopyObject(this.data.moduleData?this.data.moduleData.orgTaxDetails:this.data.moduleInfo.orgTaxDetails)})}for(var n=r&&r.length||0,s={isGrandField:!0},l=0;l<n;l++){var d=r[l],c=d.display_label||d.value||d,u=this.getTaxDisplayNameSFLineItem(c),m={};c=c||"";var p={};if(a&&a.$line_tax){var f=(a.$line_tax||[]).filter((function(e){return e.name===c||e.name===u}));if(f&&f.length||0){var _=this.getTaxPercentSFLineItem(c);p=f.filter((function(e){return!(!d.id||!e.id||d.id!==e.id)||(!e.id&&!d.id&&e.percentage==_||(void 0===_&&!e.id&&c===e.name||void 0))}))[0]}(p=p||{}).id&&(m.taxId=p.id)}var y=p.hasOwnProperty("percentage")?p.percentage:this.getTaxPercentSFLineItem(c);y="string"==typeof y?y.trim():y;var g=((a.hasOwnProperty("Sub_Total")?a.Sub_Total:0)-a.Discount)*y/100,v=a.$.model.fieldList;if(v&&v.Tax&&"TAX"===v.Tax.columnName&&v.Tax.fieldID){var h=store.peekRecord("field",v.Tax.fieldID);h&&(g=this.getRoundOff(h,g,s))}y=parseFloat(y);var D=u+"_"+y+"_tax_checkbox",b=u+"_"+y+"_percentage";m.zcqa_check_box=D,m.zcqa_tax_perc=b,m.taxPercent=y,m.taxAmt=g,m.taxLabel=u,d.id&&(m.taxId=d.id),d.hasOwnProperty("id")&&null===d.id&&(m.isTaxIdNull=!0),i.push(m)}return i},fillBillingAddForPurchaseOrder:function(e){var t=Crm.userDetails.orgAddress,a="Billing_Street|Billing_City|Billing_State|Billing_Code|Billing_Country";if(t){t=t.split("|");for(var i=(a=a.split("|")).length,r=e.$.model.fieldList,o=0;o<i;o++)t[o]&&r[a[o]]&&e.$.set(a[o],t[o])}},isValidVRFieldForInventory:function(e,t){return!(!this.isInventoryModule(t)||!["DISCOUNT","TAX"].contains(e.column_name)||e.custom_field||!validationUtils.isNotEmpty(e.subform))},setDynamiHeightForProductLookup:function(e,t){if(t){var a,i,r=0,o=t.querySelector("textarea"),n=$L(t).parents(".subFrmLayout")[0];i=n.querySelector("#createSfDummyTxtArea"),o&&(r=0!==o.offsetWidth?o.offsetWidth:320),i||((i=document.createElement("div")).setAttribute("id","createSfDummyTxtArea"),i.setAttribute("class","bold sf-dummy-div"),i.setAttribute("style","width: "+r+"px"),n.appendChild(i)),i.innerHTML=$ESAPI.encoder().encodeForHTML(e),a=i.offsetHeight,o.style.height=a+"px"}},removeOwnerDivFocus:function(){var e=document.querySelector(".editModeOwnerdiv"),t=e&&e.parentElement;t&&t.classList.contains("highlBorder")&&t.classList.remove("highlBorder")},getInventoryRoundOffDetail:function(e){var t={roundOff:2,roundOffPrecision:Math.pow(10,2)},a=e;if(!a){var i=this.data&&(this.data.moduleData||this.data.moduleInfo);a=i&&i[this.data.currentInstObjKey]?i[this.data.currentInstObjKey].currencyData:void 0}if(objectUtils.getKeys(Crm.userDetails.CURRENCY_DETAILS).length>0){var r=a&&a.key;r||(r=Crm.userDetails.BASE_CURRENCY);var o=Crm.userDetails.CURRENCY_DETAILS[r];o&&(t.roundOff=o.decimals)}else isNaN(Crm.userDetails.productRoundOff)||(t.roundOff=Crm.userDetails.productRoundOff,t.roundOff>5&&(t.roundOff=5));return t.roundOffPrecision=Math.pow(10,t.roundOff),Crm.current__inventory__RoundOffDetail=t,t},getFinalMergedTaxArr:function(e){e||(e={});var t=e.productTaxInfo,a=e.existingTax,i=e.orgTaxDetails;t=t||[];var r=[],o=[];return(i=i||[]).forEach(function(e){o.push({orgTaxString:this.getFinalTaxStringFromNameAndPerc({tax_name:e.name,tax_percent:e.value}),orgTaxId:e.id})}.bind(this)),t.forEach(function(e){var t=e,a=t.display_label||t.value||t;a=a||"";var i=this.getTaxDisplayNameSFLineItem(a),o=t&&t.hasOwnProperty("percentage")?t.percentage:this.getTaxPercentSFLineItem(a);void 0!==o&&!isNaN(Number(o))&&r.push(this.getFinalTaxStringFromNameAndPerc({tax_name:i,tax_percent:o}))}.bind(this)),a.forEach(function(a){var i=a,n=i.name||i;n=n||"";var s=this.getTaxDisplayNameSFLineItem(n);if("clone"!==this.data.initRoute||e.isGrandTax){var l,d=a&&a.hasOwnProperty("percentage")?a.percentage:this.getTaxPercentSFLineItem(n);if(void 0!==d&&!isNaN(Number(d))&&(l=this.getFinalTaxStringFromNameAndPerc({tax_name:s,tax_percent:d})),l&&(null===a.id||!r.contains(l))){var c;if(a.id){var u=o.filter((function(e){return e.orgTaxId===a.id}))[0];u&&r.contains(u.orgTaxString)&&(c=!0)}if(!c)if(a.id)t.push({id:a.id,value:l});else if(null===a.id&&r.contains(l)){var m=r.indexOf(l);if(-1!==m){var p=t[m];p&&p.id&&t.push(l)}}else t.push(l)}}}.bind(this)),t},mergeDeletedTaxWithOrgTax:function(e){e||(e={});var t=e.orgTaxDetails,a=[];(t=t||[]).forEach(function(e){a.push({orgTaxString:this.getFinalTaxStringFromNameAndPerc({tax_name:e.name,tax_percent:e.value}),orgTaxId:e.id})}.bind(this));var i=e.record,r=e.lineItemRecords||[];if(i&&i.$line_tax){var o=i.$line_tax||[];this.fillIdsForNullTax({prevTaxArr:o,orgTaxDetailsIDsArr:a})}r&&r.length&&r.forEach(function(e){var t=e.Product_Name&&e.Product_Name.Tax||[];t&&t.length&&this.fillIdsForNullTax({prevTaxArr:t,orgTaxDetailsIDsArr:a})}.bind(this))},fillIdsForNullTax:function(e){e||(e={});var t=e.prevTaxArr||[],a=e.orgTaxDetailsIDsArr||[],i=[];t.forEach((function(e){e.id&&i.push(e.id)})),t.forEach(function(e){if(e&&null===e.id){var t=e,r=t.display_label||t.name||t.value||t;r=r||"";var o,n=this.getTaxDisplayNameSFLineItem(r),s=t&&t.hasOwnProperty("percentage")?t.percentage:this.getTaxPercentSFLineItem(r);void 0!==s&&!isNaN(Number(s))&&(o=this.getFinalTaxStringFromNameAndPerc({tax_name:n,tax_percent:s}));var l=a.filter((function(e){return e.orgTaxString===o}))[0];l&&!i.contains(l.orgTaxId)&&(e.id=l.orgTaxId)}}.bind(this))},getFinalTaxStringFromNameAndPerc:function(e){var t=(e=e||{}).tax_name,a=e.tax_percent,i=Number(a);return i<0?t+" - ("+i+" %)":t+" - "+i+" %"},getCanvasViewsMetaForWizard:function(e,t,a){return store.findAll("canvasview",{module:moduleRecordMapping[e].api_name,feature:"WizardView",page:t}).then((function(i){if(i.length&&i.$.meta.more_records)return a.getCanvasViewsMetaForWizard(e,t+1,a)}))},getCurrentLayoutDetails:function(e,t,a,i,r,o,n,s){e&&e.length&&(e=(e=Lyte.deepCopyObject(e)).sort((function(e,t){var a=e.name.toUpperCase(),i=t.name.toUpperCase();return a<i?-1:a>i?1:0})));var l,d,c=a.module_name,u=a.id,m=e?e.length:0,p=[],f=!1,_=0,y=Crm.userDetails.PROFILE_NAME;"team_based"===a.access_type&&(y=a.private_profile.name);var g,v=!1;Lyte.Router.getRouteInstance().transition.data.wizardSwitch=o;for(var h=0;h<m;h++)if(e[h].status>=0||!0===e[h].status||"active"===e[h].status){f="Campaigns"===c&&"active"===e[h].status&&"campaign_integration"===e[h].source||f;var D=!1;if(e[h].profiles)for(var b=e[h].profiles.length,L=(v=!1,0);L<b;L++)if(e[h].profiles[L].name===y&&(D=!0),e[h].profiles[L].default&&y===e[h].profiles[L].name){l=e[h].name,d=e[h].id,v=!0;break}D&&(p[_]={uservalue:e[h].name,systemvalue:e[h].id,id:e[h].id,isDefault:v,status:e[h].status,source:e[h].source},_++)}if(i.queryParams.layoutId&&i.queryParams.wizardId?(d=i.queryParams.layoutId,g=i.queryParams.wizardId,t.selectedLayoutid=t.selectedLayoutid?t.selectedLayoutid:i.queryParams.layoutId+";"+i.queryParams.wizardId):t.isWizard?(d=t.selectedLayoutid.split(";")[0],g=t.selectedLayoutid.split(";")[1]):i.queryParams.layoutId&&(d=i.queryParams.layoutId),"Campaigns"===c&&(r.layoutId||i.queryParams.layoutId)){var C=r.layoutId||i.queryParams.layoutId,I=p.filter((function(e){return e.id===C}))[0];I&&(l=I.uservalue,d=I.id)}if(!d&&p&&p.length)if("Campaigns"===c){var E=p.filter((function(e){return"crm"===e.source}))[0];E=E||p[0],l=E.name,d=E.id,E.isDefault=!0}else l=p[0].name,d=p[0].id,p[0].isDefault=!0;n||commonUtils.showHideLoadingDiv(!0);var R={};return R.layoutId=d,R.moduleapi=a.api_name,R.moduleName=c,R.wizardId=g,R.isOldFlow=!this.lyteConvertionSupported,R.isPortalPreview=n,this.getModulePromise(R).then((function(e){if(e.wizard){var o=store.peekRecord("wizard-container",d);if(portalPreview){var m=store.peekRecord("user_type",s),_=r.module;"Potentials"===_&&(_="Deals");var v=m.modules.filter((function(e){return e.api_name===_})),h=v[0].fields.mapByKey("field_id"),D=o.screens;let e=D.length;for(var b=0;b<e;b++){var L=D[b].segments.filter((function(e){return"fields"===e.type||"composite"===e.type}));L.length&&L[0].fields.forEach((function(e){if(h.contains(e.id)){var t=v[0].fields.filter((function(t){return t.field_id===e.id}));t.length>0&&(e.read_only=t[0].read_only)}else e.visible=!1}));var C=D[b].segments.filter((function(e){return"subforms"===e.type}));if(C.length){let e=C.length;for(var I=0;I<e;I++)C[I].fields.forEach((function(e){h.contains(e.id)||(e.visible=!1)}))}}}for(var E,R=o.chart_data.nodes.length,S=[],F=0;F<R;F++){var O=o.chart_data.nodes[F];if(O.start_node){var k=store.peekRecord("wizard-screen",O.screen.id);E=k.segments,S.push({id:k.id,name:k.name,index:0});break}}}var w,N=a.wizard,T=N?N.length:0,M=[];for(F=0;F<T;F++){var P=N[F];if(P.active){for(var $=P.profiles.length,A=!1,U=0;U<$;U++)if(y===P.profiles[U].name){A=!0;break}if(!A)continue;if(A=a.layouts.filter((e=>P.layouts.some((t=>t.id===e.id)))).some((e=>!!e.profiles.some((e=>e.name===y)))),t.isWizard){var x=t.selectedLayoutid?t.selectedLayoutid.split(";")[0]:i.queryParams.layoutId,V=N[F].layouts.length;for(U=0;U<V;U++)x===P.layouts[U].id&&(w=P.layouts[U].name)}if(A){if(p&&p.length&&P.layouts&&P.layouts.length){var B=p.mapByKey("id"),j=[];P.layouts.forEach((function(e){B.contains(e.id)&&j.push(e)})),P.layouts=j&&j.length?j:P.layouts}M.push({uservalue:P.name,layouts:P.layouts,id:P.id})}}}return d=d||(e.layout&&e.layout[0]?e.layout[0].id:d),{initRoute:"create",entityrecordData:e.editEntitydata?e.editEntitydata[0]:{},transitionData:r,showInteglayoutoption:f,layoutRules:e.layout_rule,validationRules:e.validation_rule,customButtons:e.custom_button,moduleData:a,moduleId:u,moduleName:c,currsubformApinames:a.currsubformApinames?a.currsubformApinames:[],layoutddData:p,layoutddSelected:l,selectedLayoutid:g?d+";"+g:d,moduleSections:g?E:e.layout&&e.layout[0]?e.layout[0].sections:[],layoutDet:e.layout,wizardData:M,isWizard:t.isWizard,wizardId:t.selectedLayoutid,wizardName:w,screenHistory:S,surveyDepartments:e.survey_departments?e.survey_departments:[],webinarIntegration:e.webinarIntegration?e.webinarIntegration:void 0,fcCategory:e.fc_category?e.fc_category.stages:[],skyEyeIntegration:!!(e.skyEyeIntegration&&validationUtils.isNotEmpty(e.skyEyeIntegration)&&e.skyEyeIntegration.configured),isPortalPreview:n}}))},generateDynamicInstanceKey:function(){var e=this.data.currentInstObjKey,t=Lyte.registeredMixins["crm-create-init-mixin"];!e&&t&&(e=Lyte.registeredMixins["crm-create-init-mixin"].getDynamicCurrentInstanceObjKey({actionName:"LyteCRUD"}),this.setData("currentInstObjKey",e)),t&&e&&t.generateCurrentInstanceObject({instanceObjKey:e,moduleData:this.data.moduleData})},setDuplicateError:function(e,t){var a=t.data.fieldLabel?t.data.fieldLabel:"",i={isError:!0},r="crm-create-fields#"+t.data.moduleData.module_name+"_fldRow_"+t.data.columnName,o=document.querySelectorAll(r);o=o&&o.length>=1?o[0]:void 0,e.details&&e.details.more_records&&Crm.userDetails.permissions["Crm_Implied_Merge_"+t.data.moduleData.module_name]?(i.message=I18n.getMsg("crm.duplicate.value.not.allowed")+" "+I18n.getMsg("crm.duplicate.value.available.multiple",[void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?$ESAPI.encoder().encodeForHTML(moduleRecordMapping[e.details.duplicate_record.module.api_name].singular_label.toLowerCase()):$ESAPI.encoder().encodeForHTML(t.getData("moduleData").singular_label.toLowerCase()),$ESAPI.encoder().encodeForHTML(a)]),i.more_records=!0):i.message=I18n.getMsg("crm.duplicate.value.not.allowed")+" "+I18n.getMsg("crm.duplicate.value.available",[void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?$ESAPI.encoder().encodeForHTML(moduleRecordMapping[e.details.duplicate_record.module.api_name].singular_label.toLowerCase()):$ESAPI.encoder().encodeForHTML(t.getData("moduleData").singular_label.toLowerCase()),$ESAPI.encoder().encodeForHTML(a)]),i.duplicateFdetails={},i.duplicateFdetails.id=e.details&&e.details.duplicate_record?e.details.duplicate_record.id:void 0,i.duplicateFdetails.key=e.details.api_name,i.duplicateFdetails.dupFieldLabel=a,i.duplicateFdetails.dupColName=t.data.columnName,i.duplicateFdetails.modLabel=void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].singular_label:t.getData("moduleData").singular_label,i.duplicateFdetails.moduleN=void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].api_name:t.getData("moduleData").module_name,i.duplicateFdetails.modPluLabel=void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].plural_label:t.getData("moduleData").plural_label,i.duplicateFdetails.detailsFromserver=e.details,Lyte.Component.set(o.component.data,"errorDetails",i),o.querySelector(".FValue").classList.add("cuserrorFborder")},setDuplicateErrorForAggregateFields:function(e,t,a,i){var r,o=a.data.fieldLabel?a.data.fieldLabel:"",n={isError:!0},s="crm-create-fields#"+t.data.moduleData.module_name+"_fldRow_"+i.column_name;if(r=(r=r&&r.length?document.querySelectorAll(s):document.querySelectorAll(".aggField."+i.api_name))&&r.length>=1?r[0]:void 0,e.details&&e.details.more_records&&Crm.userDetails.permissions["Crm_Implied_Merge_"+t.data.moduleData.module_name]?(n.message=I18n.getMsg("crm.duplicate.value.not.allowed")+" "+I18n.getMsg("crm.duplicate.value.available.multiple",[void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].singular_label.toLowerCase():t.getData("moduleData").singular_label.toLowerCase(),$ESAPI.encoder().encodeForHTML(o)]),n.more_records=!0):n.message=I18n.getMsg("crm.duplicate.value.not.allowed")+" "+I18n.getMsg("crm.duplicate.value.available",[void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].singular_label.toLowerCase():t.getData("moduleData").singular_label.toLowerCase(),$ESAPI.encoder().encodeForHTML(o)]),n.duplicateFdetails={},n.duplicateFdetails.id=e.details&&e.details.duplicate_record?e.details.duplicate_record.id:void 0,n.duplicateFdetails.key=e.details.api_name,n.duplicateFdetails.dupFieldLabel=o,n.duplicateFdetails.dupColName=i.column_name,n.duplicateFdetails.modLabel=void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].singular_label:t.getData("moduleData").singular_label,n.duplicateFdetails.moduleN=void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].api_name:t.getData("moduleData").module_name,n.duplicateFdetails.modPluLabel=void 0!==moduleRecordMapping[e.details.duplicate_record.module.api_name]?moduleRecordMapping[e.details.duplicate_record.module.api_name].plural_label:t.getData("moduleData").plural_label,n.duplicateFdetails.detailsFromserver=e.details,Lyte.Component.set(r.component.data,"errorDetails",n),r.classList.contains("aggField")){var l=$L(r).parents("crm-create-subformsection")[0];Lyte.Component.set(l.component.data.aggerrorDetails,e.details.api_name,n),r.querySelector("input").classList.add("cuserrorAborder"),r.classList.add("lcAggError")}},isPrevalidateNeeded:function(e){if(null!==e.relatedTarget){if("BUTTON"===e.relatedTarget.nodeName&&("save"===e.relatedTarget.name||"saveAndNew"===e.relatedTarget.name||"cancel"===e.relatedTarget.name))return!1;if("wizards"===this.data.globalData.formType&&e.relatedTarget.dataset.zcqa&&null!==e.relatedTarget.dataset.zcqa.match("button"))return!1}return!0},setSubformRecordIdsForFinalSave:function(){document.querySelectorAll("crm-create-subformsection").forEach((function(e){var t=e.component.data.apiName;Crm.subformVsRemovedRowIds[t]=e.component.data.removedRowIds,Crm.subformVsCachedRowIds[t]=e.component.data.cacheRecordIds,Crm.subformVsNewRowIds[t]=e.component.data.newRecordIds}))},invokeURL:function(e,t){var a;let i;t&&e.url&&"same_tab"===e.url.open_in&&Lyte.registeredMixins["crm-create-mixin2"].removeBeforeUnloadEvent();let r=!0;switch(e.url.open_in){case"new_tab":default:a="_blank";break;case"same_tab":a="_self";break;case"new_window":if(a="_blank",Crm.userDetails.CUSTOM_BUTTON_CUSTOM_FUNCTION_OPEN_URL_NEW_FLOW){i=`height=${e.url.height||1e3},width=${e.url.width||800},menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes`}}if(e.web_tab){var o=window.location.href.split("crm/")[0]+"crm/ShowTab.do?webTab=true&module="+e.web_tab;window.open(networkUtils.getOrgSpecificURL(o),a)}else{const t=Lyte.registeredMixins["crm-view-utils"];t&&t.toTransitionToWebTab(e.url.open_url,e.url.open_in)?(r=!1,t.transitionToWebTab(e.url.open_url)):networkUtils.openUrl(e.url.open_url,a,i)}t&&r&&this.onWizardCustomButtonComplete(t)},openURL:function(e,t){const{url:a}=e,i=a.open_in,r=a.height||1e3,o=a.width||800;let n,s="_blank";switch(t&&"same window"===i&&Lyte.registeredMixins["crm-create-mixin2"].removeBeforeUnloadEvent(),i){case"same window":s="_self";break;case"parent window":window.opener&&(window.opener.open(a.open_url,"_blank"),s=void 0);break;case"popup window":n=`height=${r},width=${o},menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes`}s&&networkUtils.openUrl(a.open_url,s,n),t&&this.onWizardCustomButtonComplete(t)},callCustomButtonExecution:function(e,t,a,i,r,o){const n=r.dataBind,s=r.initRoute;if(a.wizButtonId&&!i){this.custombuttonWizardDetails={buttonId:e,custombuttonEmptymodal:a};const t=!!n.$.isNew||"draft"===n.$state;return void this.validateCreateform("custom_button",void 0,void 0,t)}i&&(t={});const l=function(e,t,i,r){const o={};return"edit"===e&&(o.ids=t.id),i&&(o.ids=a.recordId),r&&(o.proceed_empty=!0),o}(s,n,a.recordId,a.proceed_empty),d=function(e,t){const a={arguments:e||{}};return t&&(a.lookup_values=t),a}(t,a.lookup_values),c={button_id:e,type:"POST",fromForm:!0,custom_buttons:[d],cascadedResponse:i?this.cascadedResponse:void 0},u=this.customButtonErrorCallback;commonUtils.showHideLoadingDiv(!0),Lyte.resolvePromises({actionResolved:store.triggerAction(moduleRecordMapping[r.moduleData.module_name].id,"custom_buttons",c,l),filesResolved:new Promise((function(e){networkUtils.loadFeatureScripts(["zohocrm_customButtonTemplate.js"],(function(){e()}))}))}).then(function(t){o&&(this.custombuttonWizardDetails=void 0);const n=t.actionResolved.details,s=n.custom_function?n.custom_function.creator_response:void 0,l=s instanceof Object?JSON.stringify(s):s,d=n.custom_function?n.custom_function.status:void 0,c=function(e,t){try{const a=JSON.parse(e),i=a.message instanceof Object?JSON.stringify(a.message):a.message,r=a.status?a.status:t,o=a.acknowledgement,n="false"!==a.reloadRecord.toString().toLowerCase();return{executionStatus:r,acknowledgementInfo:o,reloadRecord:n,isCascadeEnabled:"true"===a.isCascadeEnabled.toString().toLowerCase(),responseObj:a,response:i}}catch(a){return{executionStatus:t,acknowledgementInfo:null,reloadRecord:!0,isCascadeEnabled:!1,responseObj:e,response:e}}}(l,d);if(!a.skip&&i){const t={executionStatus:d,hasEmptyFields:validationUtils.isEmpty(n.empty_fields),functionResponseObj:l},s={buttonId:a.wizButtonId,recordId:a.recordId},u=function(t,s,l){this.cascadedResponse=c.isCascadeEnabled?c.responseObj:void 0;const d=store.peekRecord("wizard-button",t.buttonId);if(c.reloadRecord&&d&&"save"!==d.type&&s.hasEmptyFields){const s=$L("crm-create-layout")[0].component,d=s.getData("dataBind").$.model._name;s.setData("preventSubformCscriptExecution",!0),store.findRecord(d,t.recordId,void 0,void 0,void 0,{isWizardReloadRecord:!0}).then(function(t){t[0]&&(s.setData("preventSubformCscriptExecution",!1),s.reloadRecordForWizard(s,t)),l(e,a,i,n,r,o,c)}.bind(this)).catch(function(){l(e,a,i,n,r,o,c)}.bind(this))}else l(e,a,i,n,r,o,c)};u.call(this,s,t,this.customButtonExecutionHandler.bind(this))}else this.customButtonExecutionHandler(e,a,i,n,r,o,c)}.bind(this)).catch(u.bind(this))},customButtonExecutionHandler:function(e,t,a,i,r,o,n){const s={circuits:function(){var e=Crm.userDetails.permissions.hasOwnProperty("Crm_Implied_Advanced_Dev_Access")&&Crm.userDetails.permissions.Crm_Implied_Advanced_Dev_Access;if(i.hasOwnProperty("circuits")&&i.circuits.hasOwnProperty("circuitId")&&!i.circuits.hasOwnProperty("scheduled")&&e&&"success"===i.circuits.status)if(i.circuits.hasOwnProperty("executionUrl")){a=i.circuits.executionUrl;var t=i.circuits.name;crmui.showMsgBand("success",I18n.getMsg("crm.circuits.trigger.success")+'. <span class="crmLinkColor cP" onClick="crmRelatedList.showCircuitPreview(\''+a+"','"+t+"')\">"+I18n.getMsg("crm.circuits.rl.view.execution")+"</span>",5e3)}else{var a=Crm.getCrmBasePath()+"/settings/circuits/executionLogs?circuit_id="+i.circuits.circuitId;crmui.showMsgBand("success",I18n.getMsg("crm.circuits.trigger.success")+". <span class='crmLinkColor cP' onClick='networkUtils.openUrl(\""+a+'", "_blank", "");\'>'+I18n.getMsg("crm.circuits.rl.view.execution")+"</span>",5e3)}else i.circuits&&"failure"===i.circuits.status?crmui.showMsgBand("error",i.circuits.message,4e3):i.hasOwnProperty("circuits")&&i.circuits.hasOwnProperty("scheduled")&&e?crmui.showMsgBand("success",I18n.getMsg("crm.circuits.schedule.success"),4e3):crmui.showMsgBand("success",I18n.getMsg("crm.circuits.trigger.success"),4e3)},invoke_url:function(e,t,a){this.invokeURL(a,e.wizButtonId)},web_tab:function(e,t,a){this.invokeURL(a,e.wizButtonId)},custom_function:function(e,t,a){if(a.custom_function.url&&0!==Object.keys(a.custom_function.url).length&&a.custom_function.url.constructor===Object&&(Crm.userDetails.CUSTOM_BUTTON_CUSTOM_FUNCTION_OPEN_URL_NEW_FLOW?this.openURL(a.custom_function,e.wizButtonId):this.invokeURL(a.custom_function,e.wizButtonId)),t){const t=store.peekRecord("wizard-button",e.wizButtonId),a=!("success"!==n.executionStatus||!t||"save"!==t.type);n.acknowledgementInfo?this.processAcknowledgement(n.acknowledgementInfo,t,a):n.response?this.setData("customButtonPopDetails",{show:!0,content:n.response,isSave:a,display_label:t.display_label,wizardButton:t}):this.onWizardCustomButtonComplete(e.wizButtonId)}else a.custom_function&&"success"===n.executionStatus&&n.response&&(Handlebars.registerPartial("cbSuccessPopup",Handlebars.templates.cbSuccessPopup),$("body").append(Handlebars.templates.cbSuccessPopup()),$L("#cbSuccessPopup").addClass("zcrm-show"),setTimeout((function(){$L("#cbSuccessPopup").css("display","block")}),150),$L("#cbSuccessPopupRespContent").text(n.response),$L("#cbExecutedPage").val("create"))}};if(commonUtils.showHideLoadingDiv(),validationUtils.isNotEmpty(i.empty_fields)){const a=r.moduleData,n=function(e,t,a,r){const o=[];return $L.each(i.empty_fields,(function(i,n){if((i===e||i===t)&&n&&n.length){const e=[];if(n.forEach((function(t){const i=a.find((e=>t===e.api_name||t===e.display_label));i&&i.view_type[r]&&!["207","208"].contains(i.ui_type)&&e.push(i.field_label)})),e.length){var s={module:i,fields:e};o.push(s)}}else{const e={module:i,fields:n};o.push(e)}})),o},s=n(a.api_name,a.plural_label,a.fields,"edit"===r.initRoute?"edit":"create");if(s.length)return t.proceed_empty=!0,t.modulesArr=s,t.response=i,this.displayEmptyModal(t,e);if("custom_function"===i.action){const a=!(!this.data||!this.data.isWizard);return t.proceed_empty=!0,t.response=i,this.callCustomButtonExecution(e,t.arginfo,t,a,r,o)}}else s.hasOwnProperty(i.action)&&s[i.action].call(this,t,a,i)},customButtonErrorCallback:function(e){commonUtils.showHideLoadingDiv();const t=JSON.parse(e.responseText),a={UNABLE_EXECUTE_THE_SCRIPT:function(e,t){const a={SOCKET_CLOSED:{type:"warning",message:"crm.custombutton.function.time.exceed",delay:7e3},TOO_MANY_REQUESTS:{type:"error",message:"crm.custombutton.function.limit.exceed",delay:5e3},CIRCUITS_EXECUTION_LIMIT_REACHED:{type:"error",message:"crm.circuits.limit.exceeded",delay:5e3},CIRCUITS_FEATURE_NOT_AVAILABLE:{type:"error",message:I18n.getMsg("crm.circuits.button.feature.not.available",Crm.brandName),delay:5e3,isI18nMsg:!0},CIRCUITS_ACCOUNT_FREEZED:{type:"error",message:I18n.getMsg(Crm.userDetails.IS_ADMIN_ROLE?"crm.circuits.accfreeze.button.admin":"crm.circuits.accfreeze.button.nonadmin",Crm.brandName),delay:5e3,isI18nMsg:!0},CIRCUITS_TYPE_NOT_ALLOWED:{type:"error",message:Crm.userDetails.IS_ADMIN_ROLE?I18n.getMsg("crm.circuits.associate.non.payment",Crm.brandName):I18n.getMsg("crm.circuits.associate.non.payment",Crm.brandName)+". "+I18n.getMsg("crm.circuits.contact.admin"),delay:5e3,isI18nMsg:!0}};return e.details&&e.details.creator_error?a[e.details.creator_error]?a[e.details.creator_error]:"wizards"===t.position?{type:"warning",message:"crm.custombutton.function.execute.error.wizard",delay:1500}:{type:"warning",message:"crm.label.button.function.execute.error",delay:1500}:{type:"warning",message:"crm.security.error.add.user",delay:1500}},INVALID_DATA:function(e){if("invalid custom button id"===e.message)return{type:"error",message:"crm.label.insufficient.privileges",delay:5e3}},INTERNAL_ERROR:function(){return{type:"warning",message:"crm.security.error.add.user",delay:1500}}},i={};this.data&&this.data.isWizard&&(i.position="wizards");const r=a[t.code]?a[t.code].call(this,t,i):{type:"error",message:"crm.security.error.add.user",delay:5e3},o=r.isI18nMsg?r.message:I18n.getMsg(r.message);"wizards"===i.position?function(e){document.querySelector("#wiz_cf_failure").ltProp({transition:{animation:"slideFromTop",duration:"0.3"},offset:{top:"0",left:"center"},show:!0});const t="warning"===e.type?["wiz-war-icon","zcrm_svgIcons"]:["wiz-err-icon","zcrm_svgIcons"];$L("#cfErrorIcon").addClass(t),$L("#wizCFErrorInfo").text(e.message)}(r):crmui.showMsgBand(r.type,o,r.delay)},executeCustomButtonFlowForCanvas:function(e,t,a,i,r,o){const n=function(e,t,a){const i=t&&1!==t?"cbedit":"createclone";let r={Entity:a};t&&1!==t&&(r.EntityId=t);var o="undefined"!=typeof WidgetHandler?WidgetHandler.getWidget("CustomButtons",e):void 0;if(o){var n=WidgetHandler.Utils.readForm();r=jQuery.extend(r,n),WidgetHandler.CustomButtons.render(o,r,i)}},s=function(e,t,a,i,r){const o={id:t};a.arginfo=o,this.callCustomButtonExecution(e,o,a,void 0,i,r)},l=function(e,t,r,o,n){const s=["id","ownerId"],l=o.dataBind,d=o.moduleData.module_name,c={};(CustomButtonJSObjectInit.getAPINameFromMergeField(t)||[]).forEach((function(e){const t=e&&e.module===d&&e.module_field?e.module_field:void 0;if(t&&l.$.model.fieldList[t]||s.includes(t)){const e=function(e){let t=l[e];return l.$.error[e]&&(t=l.$.error[e].value),"id"===e?a:"ownerId"===e?i:t}(t),r=function(e,t){const a=!(!l.$.model.fieldList[t]||!l.$.model.fieldList[t].uiType||133!==l.$.model.fieldList[t].uiType);if(e){if("string"==typeof e)return encodeURIComponent(e);if(Array.isArray(e))return encodeURIComponent("["+e+"]");if("object"==typeof e){if(a&&e.id&&Crm.userDetails.CUSTOM_BUTTON_INVOKE_URL_LOOKUP_ID_SUPPORT)return encodeURIComponent(e.id);if(e.full_name)return encodeURIComponent(e.full_name);if(e.name)return encodeURIComponent(e.name)}}return e}(e,t);r&&(c[t]=r)}})),r.arginfo=c,this.callCustomButtonExecution(e,c,r,void 0,o,n)},d=function(e,t,r,o,n,s){const l=n.dataBind,d=n.moduleData.module_name,c=n.moduleData.fields,u=n.initRoute;t&&(o.skip=!1);const m=["id","ownerId"],p={},f={};if(!t)if(r&&r.length)r.forEach(function(e){if("variables"!==e.type){const t=CustomButtonJSObjectInit.getAPINameFromMergeField(e.api_name),r=t[0].module_field,o=t[0].module;if(l.$.model.fieldList[r]||m.includes(r)){const n=function(e,t,r){let o;return"id"!==e&&"ownerId"!==e&&t===d&&(o=l[e],l.$.error[e]&&(o=l.$.error[e].value)),t!==d||r[0].hasOwnProperty("lookup_field")||("id"===e?o=a:"ownerId"===e&&(o=i)),o}(r,o,t);if(n&&t[0].hasOwnProperty("lookup_field")&&"object"==typeof n&&n.hasOwnProperty("id"))f[r]=n.id;else{const t=function(e,t){const a=!(!l.$.model.fieldList[e].uiType||133!==l.$.model.fieldList[e].uiType);if(t){if(a&&t.id&&Crm.userDetails.CUSTOM_BUTTON_CUSTOM_FUNCTION_LOOKUP_ID_SUPPORT)return t.id;if("object"==typeof t)return t.full_name?t.full_name:t.name?t.name:"";if(t&&"string"==typeof t&&-1!==t.indexOf("TV")){let a=c.filter((function(t){return t.api_name===e}))[0];a&&"datetime"===a.data_type&&(t=t.split("TV")[0])}return t}return t}(r,n);t&&(p[e.name]=t)}}if(["parameters","all_fields"].includes(r)&&"request"===o){const t=this.filterValidUITypes.call(n.viewComp,l,u,c,"customButtons")||{};for(const e in t)(void 0===t[e]||""===t[e]||"string"==typeof t[e]&&""===t[e].trim())&&delete t[e];p[e.name]=t}}}.bind(this));else{const e=this.filterValidUITypes.call(n.viewComp,l,u,c,"customButtons")||{};for(const t in e)(void 0===e[t]||""===e[t]||"string"==typeof e[t]&&""===e[t].trim())&&delete e[t];Object.assign(p,e)}o.arginfo=p,o.lookup_values=f,this.callCustomButtonExecution(e,p,o,void 0,n,s)},c=r.moduleData.module_name,u=moduleApiMapping[c];var m={};m.wizButtonId=t,m.skip=!0,m.moduleName=c,m.modulesArr=[],m.fromStandardFormPage=o,function(e){if(e){const t=document.querySelector("crm-create-layout").component,a=store.peekRecord("wizard-button",e);this.isRecordSubmission="save"===a.type,a&&a.message&&(t.setData("ack_message",a.message),t.setData("currentWizardButton",a))}}(),store.findRecord("custom_button",e,{module:u},!1,!0,{new:!0}).then(function([i]){if(m.response=i,i.custom_function){const a=i.custom_function.arguments;d.call(this,e,t,a,m,r,o)}else i.widget?n.call(this,e,a,c):i.url?l.call(this,e,i.url,m,r,o):"circuits"===i.action&&s.call(this,e,a,m,r,o)}.bind(this))},constructBeforeEntitySaveData:function(e){var{moduleSections:t,currView:a,currentInstObjKey:i,entityRecord:r}=e,o={};return t.forEach((function(e){(e&&e[i]&&"used"===e[i].type||e.screen)&&(e.fields||[]).forEach((function(t){t[i]&&t[i].isLayoutMandatory&&(!e[i].isvalidSection||t[i].isHiddenInLayoutRules||t[i].isCscriptHidden)&&(!r.hasOwnProperty(t.api_name)||!r[t.api_name]||"picklist"===t.data_type&&"-None-"===r[t.api_name]||"multiselectpicklist"===t.data_type&&"[]"===r[t.api_name]||"subform"===t.data_type||Crm.userDetails.isStaticSubFormEnabled&&"static_subform"===t.data_type)&&(o.skipMandatory=!0)}))})),o.hasOwnProperty("skipMandatory")||(o.skipMandatory=!1),o},setMultiLineFldHeightInSubformRow:function(e,t){if(Crm.userDetails.SUBFORM_MULTILINE_CONTENT_HEIGHT_UI){var a=t.getData("multiLineFlds"),i=a.length;if(i>0){for(var r,o=[],n=0;n<i;n++){var s=a[n].api_name,l="crm-create-subformfields#"+t.getData("moduleName")+"_"+t.data.apiName+"_R"+e+"_"+s,d=t.$node.querySelector(l);if(d){var c=d.component,u=d.querySelector("textarea");if(u){var m=u.scrollHeight;r=void 0===r||r<m?m:r,d.querySelector("lyte-input").component.setData("ltPropHeight",m),o.push(c)}}}var p=o.length;for(n=0;n<p;n++)o[n].setData("__multiline_max_height",r)}}},getViewTypeInfo:function(e){return e||(this&&this.data.globalData&&this.data.globalData.currentViewType?this.data.globalData.currentViewType:this&&this.data.initRoute&&"edit"===this.data.initRoute?"edit":"create")},displayEmptyModal:function(e,t){if(!e.fromStandardFormPage){var a=$L("crm-canvas-form")[0].component;a.setData("custombuttonEmptymodal",e);var i=document.querySelector("#cbEmptyfieldsmodal");if(i){var r={left:"center",top:"0px"},o={animation:"slideFromTop",duration:"0.3"};return i.ltProp("transition",o),i.ltProp("offset",r),i.ltProp("showCloseButton",!1),a.setData("currntButtonid",t),i.ltProp("show",!0),!0}}},minDateValidator:function(e={}){let{record:t,min_date:a,min_date_time:i}=e,r={};try{let e=t&&t.$&&t.$.model.fieldList||{};for(let o in e){let n=e[o];if(n&&["date","datetime"].includes(n.fieldType)){let e=t[o];if(!(t.$.error&&!validationUtils.isEmpty(t.$.error[o]))&&e){let t=!1;if(a&&"date"===n.fieldType){let i=Crm.userDetails.DATE_PATTERN.toUpperCase(),r=-1!==e.indexOf("TV")?`${i}TV`:i,o=$L.moment(a,"YYYY-MM-DD").fromNow($L.moment(e,r,{i18n:!0}));o&&o.past&&(t=!0)}else if((i||a)&&"datetime"===n.fieldType&&this.getDateTimeFormatFromString){let r,o,n=this.getDateTimeFormatFromString(e);if(i?(r=i,o="YYYY-MM-DDTHH:mm:ss"):a&&(r=a,o="YYYY-MM-DD"),n&&n.moment){let e=$L.moment(r,o).fromNow(n.moment);e&&e.past&&(t=!0)}}if(t){let t={code:"ERR03"},a=o,i=store.peekRecord("field",n.fieldID);i&&i.field_label&&(a=i.field_label),t.message=I18n.getMsg("crm.field.valid.check",$ESAPI.encoder().encodeForHTML(a)),t.value=e,r[o]=t}}}}}catch(e){r={}}return r}}),Lyte.Mixin.register("crm-lookup-filter-mixin",{iterateGroupFieldsAndGetFieldValuesFromRecordData:function(e,t,a,i,r,o,n,s){this.convertNamesToFullNames(t,r);var l=e.group;if(l){if(l.length>1){var d=e.group[0],c=e.group[1];this.iterateGroupFieldsAndGetFieldValuesFromRecordData(d,t,a,i,r,o,n,s),this.iterateGroupFieldsAndGetFieldValuesFromRecordData(c,t,a,i,r,o,n,s)}}else{var u="string"==typeof e.value?e.value:e.value.api_name;if("field"===e.type){var m,p=!1;if((u=this.getFieldApiName(u)).includes(".")&&u.split(".")[0].endsWith("__r")&&(p=!0,m=u.split(".")[1],o.id))var f=t[o.subformApiName].filter((function(e){if(e.id===o.id)return e}));var _=this.getFieldMeta(u,i,s);if(_.length>0){var y=_[0].ui_type;if(_[0].visible&&(Object.keys(t).includes(u)||p&&o&&o.subformApiName&&(Object.keys(o).includes("indexVal")&&Object.keys(t[o.subformApiName][o.indexVal]).includes(m)||f&&f.length>=1&&Object.keys(f[0]).includes(m)))){var g;if(p?g=f?f[0][m]:t[o.subformApiName][o.indexVal][m]:(g=t[u],t.$&&t.$.error&&t.$.error[_[0].api_name]&&"ERR02"===t.$.error[_[0].api_name].code&&(g=t.$.error[_[0].api_name].value)),"LAYOUTID"===_[0].column_name)if(Object.keys(t).contains("Layout"))g=t.Layout.id;else{var v=$L("#"+r+"_fldRow_LAYOUTID");if(v){g=v[0].component.data.currentLayout}}if(g||"number"==typeof g&&"0"===g.toString()){if(36!==y&&143!==y&&144!==y&&145!==y||!Crm.userDetails.IS_MULTI_CURRENCY_ENABLED||(a.Currency=t.Currency,a.Exchange_Rate=t.Exchange_Rate),333!==y&&200!==y&&786!==y||(g=Lyte.Transform[_[0].data_type].serialize(g,u,t)),33===y&&(g=Lyte.Transform[_[0].data_type].serialize(g,u,t)),24!==y&&202!==y||(g=Lyte.Transform[_[0].data_type].serialize(g,u,t)),221===y&&(g=g.id),133===y&&(g=g.id),100===y)try{g=JSON.parse(g.split(";").map((e=>e.trim())))}catch(e){g=g.split(";").map((e=>e.trim()))}if(p)if("number"==typeof g&&"0"===g.toString()||g||301===y||(g=null),a[o.subformApiName]){let e=a[o.subformApiName];e[0][m]=g,a[o.subformApiName][0]=e[0]}else{let e=[];e.push({[m]:g,id:o.id}),a[o.subformApiName]=e}else 209!==y&&(a[u]=g)}else if(p)if(g||301===y||(g=null),a[o.subformApiName]){let e=a[o.subformApiName];e[0][m]=g,a[o.subformApiName][0]=e[0]}else{let e=[];e.push({[m]:g,id:o.id}),a[o.subformApiName]=e}else 38===y&&n&&"canvas"!==n&&!g&&t.$.error[u]?(g=t.$.error[u].fieldValue,a[u]=g):25===y&&n&&"canvas"!==n&&!g&&t.$.error[u]?(g=t.$.error[u].value,a[u]=g):a[u]=301===y?g:null}else if(r&&window[r]&&("create"===window[r].currentStatus||"edit"===window[r].currentStatus))if(p)if(!g&&301!==y&&_[0].visible&&(g=null),a[o.subformApiName]){let e=a[o.subformApiName];e[0][m]=g,a[o.subformApiName][0]=e[0]}else{let e=[];e.push({[m]:g,id:o.id}),a[o.subformApiName]=e}else"LAYOUTID"===_[0].column_name?a[u]=Lyte.Router.getRouteInstance().getQueryParams().layoutId:"create"===window[r].currentStatus&&"SMCREATORID"===_[0].column_name&&(a[u]=Crm.userDetails.USER_ID)}}}},getChildRecordFieldData:function(e,t,a,i,r){var o=store.peekRecord("field",e),n={};return o&&o.lookup&&o.lookup.query_details&&o.lookup.query_details.query_id?(a?this.iterateGroupFieldsAndGetFieldValuesFromRecordData(o.lookup.query_details.criteria,a,n,t,i,void 0,r):crmTemplate.iterateGroupFieldsAndGetFieldValues(o.lookup.query_details.criteria,t,n,i),n):n},convertDynamicValueToStaticValue:function(e,t){if(e.group)this.convertDynamicValueToStaticValue(e,t);else{var a=this.getFieldApiName(e.value);"field"===e.type&&(t[a]?e.value=t[a]:e.value="${EMPTY}",e.type="value")}},getFieldApiName:function(e){if(e.includes(".")){if(e.split(".")[0].endsWith("__r")){if(3===e.split(".").length)return e.split(".")[0]+"."+e.split(".")[1];if(2===e.split(".").length)return e}return e.split(".")[0]}return e},getFieldMeta:function(e,t,a){let i;return e=this.getFieldApiName(e),i=t.filter((function(t){if(t.api_name===e)return t})),0===i.length&&a&&e.split(".")[0].endsWith("__r")&&(e=e.split(".")[1],i=a.filter((function(t){if(t.api_name===e)return t}))),i},getLeadConvertPageData:function(){var e=document.querySelector("crm-mass-convert-deal").getData("layoutFields_new");let t={};if(e)for(var a=e.length-1;a>=0;a--){if("contact_roles"===e[a].api_name)continue;var i=$L("#component_"+a);t[i.e.component.data&&i.e.component.data.apiName?i.e.component.data.apiName:i.e.component.data.cxPropField.api_name]=i.e.component.getValue()}return t},convertNamesToFullNames:function(e,t){if("Leads"===t||"leads"===t||"Contacts"===t||"contacts"===t){let t=e.First_Name?e.First_Name:"",a=e.Last_Name?e.Last_Name:"";e.Full_Name=t+" "+a,e.Full_Name=e.Full_Name.trim()}},isDynamicCriteriaInvolved:function(e){let t=!1;if(e)return e.group?(t=this.isDynamicCriteriaInvolved(e.group[0]),!!t||this.isDynamicCriteriaInvolved(e.group[1])):e[0]?(t=this.isDynamicCriteriaInvolved(e[0]),!!t||this.isDynamicCriteriaInvolved(e[1])):"field"===e.type},loadChildRelationShip:async function(e,t){var a=e.subformApiName,i=networkUtils.returnDependencyFiles(["child_relationship_model.js"],ResourceConstants.CRMClient);await Lyte.injectResources(i);let r=(await store.findAll("child_relationship",{module:moduleRecordMapping[t].api_name},!0)).filter((function(e){if(e.module.api_name===a&&"Parent_Id"===e.field.api_name)return e}))[0].api_name;e.subformApiName=a;var o=Object.keys(moduleRecordMapping).filter((function(e){return moduleRecordMapping[e].api_name===a}))[0].module_name;e.subformName=o;let n=[];if(window[t]&&window[t].currentStatus&&("create"===window[t].currentStatus||"clone"===window[t].currentStatus||"edit"===window[t].currentStatus)){let e=Lyte.Router.getRouteInstance().transition.info.queryParams.layoutId;n=(store.peekRecord("layout",e)&&store.peekRecord("layout",e).fields&&store.peekRecord("layout",e).fields.length>0?store.peekRecord("layout",e).fields:await store.findRecord("layout",e,{module:t})).filter((e=>e.section&&e.section.some((e=>e.subform_apiname&&e.subform_apiname===a))))}else n=moduleRecordMapping[o]&&moduleRecordMapping[o].fields?moduleRecordMapping[o].fields:await store.findAll("field",{module:a,type:"all"},void 0,void 0,{apiVersion:"4"});let s=n.map((e=>Object.assign({},e)));return s=s.map((function(e){let t=e.api_name;return t.startsWith(r)||(t=r+"."+t,e.api_name=t),e})),s}});
