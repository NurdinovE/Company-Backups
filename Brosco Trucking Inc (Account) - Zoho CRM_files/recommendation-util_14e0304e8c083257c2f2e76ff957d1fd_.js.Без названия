Lyte.Mixin.register("recommendation-util",{checkAndAddConsentFields:function(e,t,o){if(Lyte.registeredMixins["crm-dataprivacy-mixin"].isGDPREnabledForModule(e)){let e=Lyte.registeredMixins["crm-dataprivacy-mixin"].getRequiredConsentFieldsColumnNames(t);return e.length>0?this.addConsentFields(o,e,t):t}return t},addConsentFields:function(e,t,o){let r=e.length;for(let n=0;n<r;n++)t.includes(e[n].column_name)&&(o.push(e[n]),t.splice(n,1));return o},modelLoaderForEdit:function(e){var t=this.gettingValidModuleList();return e.module_list=t,e.module_listwhat=t,e.name=e.recommendationJson.name,e.whatModuleList=this.getWhatModuleList(),e.whatModuleId=e.recommendationJson.what_module.id,e.whatModule=e.recommendationJson.what_module,e.whatFields=e.recommendationJson.what_module.fields,e.whatCriteriaIsEnable=null!==e.recommendationJson.what_criteria,e.whatCriteriaIsEnable&&(e.whatCriteria=e.recommendationJson.what_criteria),e.whomModuleList=this.getWhomModuleList(e.recommendationJson.id,e.whatModuleId),e.whomModuleId=e.recommendationJson.whom_module.id,e.whomModule=e.recommendationJson.whom_module,e.whomFields=e.recommendationJson.whom_module.fields,e.whomCriteriaIsEnable=null!==e.recommendationJson.whom_criteria,e.whomCriteriaIsEnable&&(e.whomCriteria=e.recommendationJson.whom_criteria),e.basedOnModuleList=this.getBasedOnModuleList(e.whatModuleId,e.whomModuleId),e.basedOnModuleId=e.recommendationJson.based_module.id,e.basedOnModule=e.recommendationJson.based_module,e.basedOnFields=e.recommendationJson.based_module.fields,e.basedOnFieldId=e.recommendationJson.based_timestamp?e.recommendationJson.based_timestamp.id:void 0,e.basedOnField=e.recommendationJson.based_timestamp?e.recommendationJson.based_timestamp:void 0,e.basedOnCriteria=e.recommendationJson.based_criteria?e.recommendationJson.based_criteria:"{}",e.recommendationsJson=store.peekRecord("recommendations",e.componentId),e.editCruxType="view",e.uiEditMode="inEditMode",e},getWhomModuleList:function(e,t){var o=store.peekAll("recommendations").filter((function(t){return t.id!==e})).map((function(e){return e.whom_module.id})),r=store.peekAll("recommendation_gallery"),n=[];return r.filter((function(e){return e.what_module.id===t})).map((function(e){o.contains(e.whom_module.id)||(n[e.whom_module.id]=e.whom_module)})),Object.values(n)},getWhatModuleList:function(){var e=store.peekAll("recommendation_gallery"),t=[];return e.map((function(e){t[e.what_module.id]=e.what_module})),Object.values(t)},getBasedOnModuleList:function(e,t){var o=store.peekAll("recommendation_gallery"),r=[];return o.filter((function(t){return t.what_module.id===e})).filter((function(e){return e.whom_module.id===t})).map((function(e){r[e.based_module.id]=e.based_module})),Object.values(r)},gettingValidModuleList:function(){var e=store.peekAll("module"),t=[],o=["Visits","Forecasts","Services","Appointments"];return e.forEach((function(e){e.api_supported&&e.presence_sub_menu&&!o.contains(e.module_name)&&"Activities"!==Crm.activityGrp[e.api_name]&&"linking"!==e.generated_type&&0!==e.profiles.filter((function(e){return e.name===Crm.userDetails.PROFILE_NAME})).length&&!0===e.visible&&t.push(e)})),t},loadUnUseFieldForViewAndEdit:function(e,t){var o=store.peekRecord("recommendations",e);if(void 0===o){var r=Lyte.Router.getRouteInstance();return Lyte.Router.transitionTo("crm.settings.section.zia.recommendation.error",null).data={errorMsg:"crm.recommendation.error.module.permissions"},void r.transition.abort()}var n=[];n.push(o.what_module.api_name),n.push(o.whom_module.api_name),n.push(o.based_module.api_name);var a=[],i=Lyte.registeredMixins["crm-dataprivacy-mixin"].isGDPREnabledForModule(o.what_module.api_name)||Lyte.registeredMixins["crm-dataprivacy-mixin"].isGDPREnabledForModule(o.whom_module.api_name)||Lyte.registeredMixins["crm-dataprivacy-mixin"].isGDPREnabledForModule(o.based_module.api_name);return t||n.forEach((function(e){var t=store.findAll("field",{module:e,type:"unused"},!1,!0,{apiVersion:"2.1"}).then((function(e){e&&e.map((function(e){e.unused=!0}))}));a.push(t)})),{componentId:e,editView:!0,recommendationJson:o,prom1:Lyte.resolvePromises(a),consents_module:Lyte.resolvePromises(i?store.findAll("field",{module:"Consents",type:"all"},!0,!0,{apiVersion:"2.2"}):[]),portalsInfo:void 0}},loadRecommendationModuleForEditAndView:function(e,t,o){var r=[],n=[],a=[];return o||(a.push(t.what_module.id),a.push(t.whom_module.id),a.push(t.based_module.id)),a.forEach((function(e){var t=e;if(!r.contains(t)){r.push(t);var o=void 0===store.peekRecord("module",t).fields||0===store.peekRecord("module",t).fields.length?store.findRecord("module",t,void 0,void 0,void 0):store.peekRecord("module",t);n.push(o)}})),e.transition.pause(),(t=t.id.length>10&&void 0===t.suggestion_type?store.findRecord("recommendations",t.id):Promise.resolve(store.peekRecord("recommendations",t.id))).then((function(){e.transition.resume()}),(function(){Lyte.Router.transitionTo("crm.settings.section.zia.recommendation.error",null).data={errorMsg:"crm.recommendation.error.module.permissions"},e.transition.abort()})),{prom1:Lyte.resolvePromises(n)}},collectProductId:function(e){var t=[];return e.first_buy&&e.first_buy.recommended&&e.first_buy.recommended.map((function(e){t.push(e.id)})),e.next_buy&&e.next_buy.recommended&&e.next_buy.recommended.map((function(e){t.push(e.id)})),e.rebuy&&e.rebuy.map((function(e){t.push(e.recommended.id)})),e.frequently_bought_together&&e.frequently_bought_together.map((function(e){t.push(e.primary_product.id),e.recommended.map((function(e){t.push(e.id)}))})),e.customer_also_bought&&e.customer_also_bought.map((function(e){t.push(e.primary_product.id),e.recommended.map((function(e){t.push(e.id)}))})),$u.uniq(t)},dataPageInitLoader:function(e,t,o){var r=o;if(void 0!==r){var n=Lyte.registeredMixins["recommendation-util"].collectProductId(r),a=null;window.clientPortalName&&(a={headers:{"X-CRMPORTAL":window.clientPortalName}}),Lyte.resolvePromises({productMeta:store.peekRecord("module",r.what_to.id).fields&&0!==store.peekRecord("module",r.what_to.id).fields.length?Promise.resolve(store.peekRecord("module",r.what_to.id)):store.findRecord("module",r.what_to.id),recommendationDetailPageRecords:r,productGetRecord:networkUtils.lyteInitiateRequest("/crm/v2/"+r.what_to.api_name+"?ids="+n.toString(),"GET",a),recommendations:store.peekRecord("recommendations",r.recommendation_id)?Promise.resolve(store.peekRecord("recommendations",r.recommendation_id)):store.findRecord("recommendations",r.recommendation_id)}).then((function(t){Lyte.registeredMixins["recommendation-util"].renderRecommendationProcess(e,t)}))}},resizeGallaryPage:function(e){var t=renderingUtils.windowHeight-$L(".galleryTableRecom").offset().top+30,o=$L("#wmstoolbar"),r=$L("#setupInnerLinks"),n=o.outerHeight()?o.outerHeight():28,a=renderingUtils.tabLayerOuterHeight()?renderingUtils.tabLayerOuterHeight():52,i=r.outerHeight()?r.outerHeight():85;e.setData("tableHeight",t);var s=renderingUtils.windowHeight-(a+n+i+$L(".recommendationGalleryTitle").outerHeight()+$L(".recGalBtnSec").outerHeight()+102);e.setData("offToph",s)},businessCardJsonLoader:function(e,t,o){if(e.id)e.businessCardJson={data:t[e.id],fields:o};else if(0!==e.length){var r=[];e.forEach((function(e){e.businessCardJson={data:t[e.id],fields:o},r.push(e)})),e=r}return e},renderRecommendationProcess:function(e,t){var o=Lyte.registeredMixins["recommendation-util"],r={},n=[],a={},i=t.recommendationDetailPageRecords,s=t.recommendations,d=t.productGetRecord,c=t.productMeta[0]?t.productMeta[0]:t.productMeta;d.data.forEach((function(e){r[e.id]=e}));var l=[];s.selected_view[0].fields.forEach((function(e){var t=c.fields.filter((function(t){return e.id===t.id}));0!==t.length&&l.push(t[0].$.toJSON())}));var u=i.first_buy,m=i.frequently_bought_together,h=i.rebuy,p=i.next_buy,g=i.customer_also_bought;u&&u.recommended&&u.recommended.length&&u.recommended.forEach((function(e){(a={}).source=o.businessCardJsonLoader(e,r,l),a.type="First buy",a.displayType="crm.filter.label.firstbuy"===s.suggestion_type.first_buy.label?I18n.getMsg("crm.filter.label.firstbuy"):s.suggestion_type.first_buy.label,a.products=[a.source],a.count=a.products.length-1,a.reference_records=u.reference_records,n.push(a)})),m&&m.forEach((function(e){e.recommended.forEach((function(t){(a={}).source=o.businessCardJsonLoader(e.primary_product,r,l),a.type="Bought Together",a.displayType="crm.filter.label.fbt"===s.suggestion_type.frequently_bought_together.label?I18n.getMsg("crm.filter.label.fbt"):s.suggestion_type.frequently_bought_together.label,a.products=o.businessCardJsonLoader([e.primary_product,t],r,l),a.count=2,a.reference_records=e.reference_records,n.push(a)}))})),h&&h.map((function(e){var t,i=new CrmDate(e.next_purchase_date),d=new CrmDate,c=Math.floor((Date.UTC(d.userDisplayYear,d.userDisplayMonth,d.userDisplayDate)-Date.UTC(i.userDisplayYear,i.userDisplayMonth,i.userDisplayDate))/864e5),u=Math.abs(c);t=0===c?I18n.getMsg("crm.recommendation.rebuy.today"):c<0?I18n.getMsg(1===u?"crm.recommendation.rebuy.within.day":"crm.recommendation.rebuy.within.days",u):I18n.getMsg(1===u?"crm.recommendation.rebuy.ago.day":"crm.recommendation.rebuy.ago.days",u);var m=i.userDisplayMonthName+" "+i.userDisplayDate+", "+i.userDisplayYear;(a={}).source=o.businessCardJsonLoader(e.recommended,r,l),a.type="Rebuy",a.displayType="crm.filter.label.rebuy"===s.suggestion_type.rebuy.label?I18n.getMsg("crm.filter.label.rebuy"):s.suggestion_type.rebuy.label,a.date=e.next_purchase_date,a.reasons=e.reasons,a.diffDays=Math.abs(c),a.displayDiffDays=t,a.dateString=m,a.products=[a.source],a.count=a.products.length-1,c<=6&&n.push(a)})),p&&p.recommended&&p.recommended.length&&p.recommended.forEach((function(e){(a={}).source=o.businessCardJsonLoader(e,r,l),a.type="Next Buy",a.displayType="crm.filter.label.nextbuy"===s.suggestion_type.next_buy.label?I18n.getMsg("crm.filter.label.nextbuy"):s.suggestion_type.next_buy.label,a.products=[a.source],a.count=a.products.length-1,a.reference_records=p.reference_records,n.push(a)})),g&&g.forEach((function(e){e.recommended.forEach((function(t){var a={};a.source=o.businessCardJsonLoader(e.primary_product,r,l),a.type="Already bought",a.displayType="crm.filter.label.cwbab"===s.suggestion_type.customer_also_bought.label?I18n.getMsg("crm.filter.label.cwbab"):s.suggestion_type.customer_also_bought.label,a.products=[o.businessCardJsonLoader(t,r,l)],a.count=e.count,a.reference_records=e.reference_records,n.push(a)}))}));var f=[];["First buy","Rebuy","Next Buy","Already bought","Bought Together","Products for user"].map((function(e){var t=n.filter((function(t){return t.type===e}));0!==t.length&&t.forEach((function(e){f.push(e)}))}));var y={what_to:i.what_to,whom_to:i.whom_to,data:f};e.renderAfterProcess(y)},actionPerformed:function(e){var t=$L(e),o=t.next(".recommendationStep");o.length<1&&(o=t.next().next(".recommendationStep"));var r=o.is(":visible");if(r)var n=t.outerHeight()-20-t.find(".recommendationRound").outerHeight()+30;$L(".thisisCurrentActiveClass").removeClass("thisisCurrentActiveClass"),$L(e).find(".recommendationFieldStep").addClass("thisisCurrentActiveClass"),r&&t.find(".vertLine").css({height:n,opacity:"1"})},showLoader:function(e){$('<div id="wave" class="waverecommendation mT15 mB10"><div class="dIB mR10 crmParagraphColor crm-font-regular">Loading</div><span class="zvoice-dot"></span><span class="zvoice-dot"></span><span class="zvoice-dot"></span></div>').insertAfter(e)},criteriaIsModified:function(e,t){return null===e&&(e=void 0),null===t&&(t=void 0),!$u.isEqual(t,e)},showGroupByPopupfunc:function(){this.setData("isShowPopOver",!1),this.setData("isShowPopOver",!0);var e=this.getData("selectedRecords"),t=this.getData("recommendationAnalyticRecord"),o=this.getData("selectedRecordsTemp");this.setData("displayVal",(0===e.length?I18n.getMsg("gs.custom"):e.length)+" "+t.what_module.plural_label);var r=_.isEqual(e,o);this.setData("isCancelBtnEnable",r),this.setData("isApplyBtnEnable",r)},toggleDropDownFunc:function(e){if(!0===e.ltProp("show"))return e.setData("ltPropValue",""),e.toggle(),!1},closeModalFunc:function(){this.setData("selectedRecords",this.getData("selectedRecordsTemp").map((function(e){return e})));var e=this.getData("selectedRecords");if(0===e.length)return this.setData("groupByOption",this.getData("oldGroupByOption")),void this.setData("isShowPopOver",!1);this.setData("displayVal",(0===e.length?I18n.getMsg("gs.custom"):e.length)+" "+this.getData("recommendationAnalyticRecord").what_module.plural_label),this.setData("isShowPopOver",!1)},applyGroupByFunc:function(){var e=this;e.setData("displayVal",e.getData("selectedRecords").length+" "+e.getData("recommendationAnalyticRecord").what_module.plural_label),e.fetchDataFromApi(e.getData("groupByOption"))},actions:{toggleDropDown:function(e){this.toggleDropDownFunc(e)},showGroupByPopup:function(){this.showGroupByPopupfunc()},closeModal:function(){var e=this.getData("cancelButtonUsed");void 0===e||e||this.setData("cancelButtonUsed",!0),this.closeModalFunc()},applyGroupBy:function(){this.chartCleanUp(),this.applyGroupByFunc()}},methods:{addToSelectedRecords:function(e,t){var o=this.getData("records").filter((function(e){return e.id===t})),r=this.getData("selectedRecords"),n=this.getData("selectedRecordsTemp");this.setData("searchRecordInputValue",""),Lyte.arrayUtils(r,"push",o);var a=_.isEqual(r,n);this.setData("isCancelBtnEnable",a),this.setData("isApplyBtnEnable",a||0===r.length)},removeFromSelectedRecords:function(e,t){var o=this.getData("selectedRecords");o.forEach((function(e,r){e.id===t&&Lyte.arrayUtils(o,"removeAt",r,1)})),this.getData("records").length>1&&this.setData("noRecordsFoundHeader",!1);var r=this.getData("selectedRecords"),n=this.getData("selectedRecordsTemp"),a=_.isEqual(r,n);this.setData("isCancelBtnEnable",a),this.setData("isApplyBtnEnable",a||0===r.length)},onSearchRecords:function(e){var t=this;if(t.setData("records",[]),t.setData("noRecordsFoundHeader",!0),e.newValue.length>1){t.setData("searchRecordNoResult",I18n.getMsg("crm.chosen.searching.text"));var o=!1,r=this.getData("recommendationAnalyticRecord"),n=r.what_module.display_field.api_name,a=store.peekRecord("module",r.what_module.id);a.$.triggerAction("searchRecordsByName",{url:"/crm/v2/"+a.api_name+"/search?criteria=("+a.display_field.api_name+"%3Astarts_with%3A"+e.newValue+")"},{},"GET").then((function(e){if(e.hasOwnProperty("data")){t.setData("records",[]);var a=t.getData("records"),i=t.getData("selectedRecords");e.data.map((function(e){return{name:e[n],id:e.id,type:"module"}})).forEach((function(e,r){(i.length<1||i.every((function(t){return t.id!==e.id})))&&r<=10&&(o=!0,Lyte.arrayUtils(a,"push",e),t.setData("noRecordsFoundHeader",!1))}))}if(!1===o){var s=r.what_module.plural_label.toLowerCase();t.setData("noRecordsFoundHeader",!0),t.setData("searchRecordNoResult",I18n.getMsg("crm.module.empty.message",s))}}))}else{var i=I18n.getMsg("crm.chosen.minimum.input.text",2-e.newValue.length);t.setData("searchRecordNoResult",i)}},noResultDisplay:function(){var e=I18n.getMsg("crm.chosen.minimum.input.text",2);this.setData("noRecordsFoundHeader",!0),this.setData("searchRecordNoResult",e)},closeModal:function(){var e=this.getData("cancelButtonUsed");void 0===e||e?void 0!==e&&e&&this.setData("cancelButtonUsed",!1):this.closeModalFunc()}},editGroupByOptionChange:function(e){var t=e.newValue;this.setData("oldGroupByOption",e.oldValue),Crm.client_tracking("Zia RA - Drop Down Click Rate",{Type:t}),"custom"!==t?(this.setData("selectedRecordsTemp",[]),this.setData("selectedRecords",[]),this.chartCleanUp(),this.setData("displayVal","none"===t?I18n.getMsg("crm.report.none"):"most"===t?I18n.getMsg("zia.recommendation.analytic.most",this.getData("recommendationAnalyticRecord").what_module.plural_label):I18n.getMsg("zia.recommendation.analytic.least",this.getData("recommendationAnalyticRecord").what_module.plural_label)),this.fetchDataFromApi(t)):(this.setData("displayVal",I18n.getMsg("gs.custom")),this.setData("isShowPopOver",!1),this.setData("isShowPopOver",!0),this.dataLoadImage())}.observes("groupByOption"),_unbindCharts:function(e){thirdPartyUtils.unbindHighcharts(e),thirdPartyUtils.unbindZohoCharts(e)}});
