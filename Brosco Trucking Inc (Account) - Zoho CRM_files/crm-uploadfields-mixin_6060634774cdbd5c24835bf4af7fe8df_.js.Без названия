Lyte.Mixin.register("crm-uploadfields-mixin",{getCruxImageUploadComponents:function(e,t,a,i,o,n,r){void 0===a&&(a="cx-prop-id");var l=$L('crux-image-component[cx-prop-from="'+t+'"]['+a+'="'+e+'"]')[0];if(o&&(l=r&&n?$L('crux-image-component[cx-prop-from="'+t+'"][id = "'+n+'"][record-id = "'+r+'"]['+a+'="'+e+'"]')[0]:$L('crux-image-component[cx-prop-from="'+t+'"]['+a+'="'+e+'"].zc_value_edit_blur')[0]),i&&(l=i.find('crux-image-component[cx-prop-from="'+t+'"]['+a+'="'+e+'"]')[0]),void 0!==l)return l.component},getAllCruxImageUploadCreateComponents:function(){return $L('crux-image-component[cx-prop-from="create"]')},updateCruxImageUploadComponentsForCanvas:function(e,t,a){var i=$L('crux-image-component[cx-prop-from="view"][cx-prop-id="'+e+'"]');a&&(i=$L('crux-image-component[record-id="'+a+'"][cx-prop-from="view"][cx-prop-id="'+e+'"]'));for(var o=i.length,n=0;n<o;n++)i[n].setData("cxPropValue",[]),i[n].setData("cxPropValue",t),i[n].setData("cxPropValidationTooltip",Lyte.registeredMixins["crm-uploadfields-mixin"].setTooltipValue(t))},setTooltipValue:function(e){if(void 0!==e&&1===e.length){if("processing"===e[0].state||"processing"===e[0].State)return"Zia is validating this image";if("waiting_for_approval"===e[0].state||"waiting_for_approval"===e[0].State)return"The image has failed validation by Zia."}return""},constructImageUrl:function(e,t,a,i,o,n,r,l){if("processing"!==n&&"system_rejected"!==n&&"waiting_for_approval"!==n){l||(l=!1);var d=o.replace(/ /g,"+"),s=Crm.getCrmBasePath()+"/ViewImage?fileId="+e+"&module="+t+"&fieldId="+r+"&parentId="+a+"&id="+i+"&name="+encodeURIComponent(d)+"&downLoadMode=inline&skipPermission="+l;return s=networkUtils.getPortalURL(s)}},setAttachmentsUrl:function(e,t){return{url:Crm.getCrmBasePath()+"/fileattach.do?action=imageUFBlobAttach&fieldId="+t+"&module="+e+"&type=image",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken}}},constructImageDataFromServer:function(e,t,a,i,o){var n=[],r=this;return e&&e.forEach((function(e){var l=e.File_Name||e.filename,d=r.constructImageUrl(e.File_Id||e.fileId,t,a,e.id,l,e.state,i,o);n.push({uploadid:e.id,id:e.id,filename:l,fileId:e.File_Id||e.fileId,extn:l.substring(l.lastIndexOf("."),l.length),stream:e.Size,description:e.Description,state:e.State,sequence:e.Sequence_Number,src:e.src,preview_url:d,original_src:d,download_url:d,cxValidationStatus:e.State,name:l})})),this.sortImagesComplete(n)},constructImageSrcWithExistingData:function(e,t){var a=t.map((function(e){return e.src})),i=t.map((function(e){return e.fileId}));return e.forEach((function(e){if(e.fileId){var t=i.findIndex((t=>t===e.fileId));e.src=a[t]}})),e},constructImageData:function(e){var t=e.responseJSON.uploadedImages[0],a=t.filename;return{uploadid:t.uploadid,id:t.uploadid,filename:a,fileId:t.fileId,extn:a.substring(a.lastIndexOf("."),a.length),encryptedUploadId:t.encryptedUploadId,description:t.Description,stream:t.stream,src:e.xhr.file.src,isNew:!0,name:a}},constructImageDataByState:function(e,t){return e.forEach((function(e){t[0]&&(e.state=t[0].State,e.cxValidationStatus=t[0].State)})),e},setCropImage:function(e,t){return t.length>0&&t.forEach((t=>{t.Encrypted_Id!==e.encryptedUploadId&&t.id!==e.id||(t.Encrypted_Id=e.encryptedUploadId)})),t},onCropSuccess:function(e,t){var a=e.uploadedImages[0];return t.fileId=a.fileId,t.stream=a.stream,t.encryptedUploadId=a.encryptedUploadId,t},updateImageDetailsMap:function(e,t,a){var i,o=(i=a?document.querySelector("crm-canvas-form").component:document.querySelector("crm-create-layout").component).data.uploadedImageDetailsMap;if(o[e]=t,i.setData("uploadedImageDetailsMap",o),a&&"WizardView"===i.getData("currView").feature){var n=$L("crm-create-layout")[0];n&&((o=n.component.data.uploadedImageDetailsMap)[e]=t,n.component.setData("uploadedImageDetailsMap",o))}},updateGetValueMap:function(e,t,a,i){var o;if(i&&"WizardView"!==(o=document.querySelector("crm-canvas-form").component).getData("currView").feature)return o.data.imageGetValueMap;var n=(o=document.querySelector("crm-create-layout").component).data.imageGetValueMap;return o.getData("isWizard")&&(n[e]&&(t=this.compareGetValue(n[e],t,a)),n[e]=t),o.setData("imageGetValueMap",n),n},compareGetValue:function(e,t,a){var i=e.map((function(e){return e.id})),o=t.map((function(e){return e.id})),n=i.filter((e=>!o.includes(e))),r=[],l=n.length;t.forEach((function(e){if(void 0===e._delete){var t=0;a.forEach((function(a){a.id===e.id&&a.isNew?(delete e.id,void 0===e.Encrypted_Id&&(e.Encrypted_Id=a.encryptedUploadId),r.push(e),t++):a.id===e.id&&(r.push(e),t++)})),0===t&&r.push(e)}else a.forEach((function(t){t.id!==e.id||t.isNew||r.push(e)}))}));for(var d=0;d<l;d++)n[d]&&r.push({id:n[d],_delete:null});return r},makeRequestForThumbnailForAlLIU:function(e,t,a,i,o){o||(o=!1);var n=Crm.getCrmBasePath()+"/EntityImageAttach.do?actionName=getGroupedThumbnailImages&fieldId="+t+"&parentId="+a+"&module="+$ESAPI.encoder().encodeForURL(e)+"&allImages=false&skipPermission="+o;n=networkUtils.getPortalURL(n),$L.ajax({url:n,type:"GET",dataType:"JSON",processData:!1,contentType:!1,success:function(e){switch(i){case"create":$L("crm-create-layout")[0].component.setData("getThumbnailDataMap",e);break;case"detailview":detailView.getThumbnailDataMap=e;break;case"canvas":document.querySelector("crm-detailview-canvas").setData("getThumbnailDataMap",e);break;case"formView":document.querySelector("crm-canvas-form").setData("getThumbnailDataMap",e);break;case"publicField":document.querySelector("crm-public-fields-view").setData("getThumbnailDataMap",e);break;case"DVLyte":document.querySelector("crm-detailview-content").setData("getThumbnailDataMap",e)}document.querySelectorAll("crux-image-component").forEach((t=>{let o=t.component.getData("cxPropValue");if(o){let n=t.component.getData("cxPropField").id||t.component.getData("cxPropField").fieldid,r=t.component.getData("cxPropField").apiName;o=Lyte.registeredMixins["crm-uploadfields-mixin"].sortImagesComplete(o),!e[n]||i.includes("canvas")&&t.component.getData("recordId")!==a&&!i.includes("canvasBuilder")||Lyte.registeredMixins["crm-uploadfields-mixin"].addSrcToImageData(o,e[n],n,!0,r,t.component.getData("cxPropId"),!1,!1,!1,!!i.includes("canvas"),a)}}))},error:function(){hideAnimatePopup("aa")}})},addSrcToImageData:function(e,t,a,i,o,n,r,l,d,s,c,p){if(e){var m=e.length,u=[];for(var f in t)for(var g=0;g<m;g++)if(f===e[g].uploadid){!1===t[f]&&null===e[g].state?u.push(e[g]):(e[g].src=t[f],Lyte.arrayUtils(e,"replaceAt",g,e[g]));break}u.length>0&&Lyte.registeredMixins["crm-uploadfields-mixin"].fetchThumbnails(u,0).then((function(t){for(var a=t.length,i=0;i<m;i++)for(var o=0;o<a;o++)if(e[i].uploadid===t[o].uploadid){Lyte.arrayUtils(e,"replaceAt",i,t[o]);break}}));var h="create";("v"===n.charAt(0)||"v"===n.charAt(1)||p&&"DVLyte"===p)&&(h="view"),d&&a&&(a="Image_"+a);var v=Lyte.registeredMixins["crm-uploadfields-mixin"].getCruxImageUploadComponents(n,h,"cx-prop-id",r,s,"Image_"+a,c),I=e;v&&I&&(v.setData("cxPropValue",I),i||r||l||d||p&&"DVLyte"===p||Lyte.registeredMixins["crm-uploadfields-mixin"].updateImageDetailsMap(o,I,s))}},combineImageDataWithSrc:function(e,t,a,i,o,n,r,l){var d=[].concat(e);if((d=Lyte.registeredMixins["crm-uploadfields-mixin"].sortImagesComplete(d)).length>0){var s="crux-image-component[id=Image_"+t+"]",c=document.getElementById("dvinner"),p=$L.debounce(function(){if(this.isInViewport(s,n)){if(a){var e=document.getElementById("dvinner");e.removeEventListener("scroll",p),e.removeEventListener("resize",p),e.removeEventListener("orientationchange",p)}else window.removeEventListener("scroll",p),window.removeEventListener("resize",p),window.removeEventListener("orientationchange",p);if(this.addSrcToImageData(d,detailView.getThumbnailDataMap[t],t,a,o,i,n,!1,l),detailView){var r=Lyte.registeredMixins["crm-uploadfields-mixin"].getCruxImageUploadComponents(i,"view");r&&!r.getData("cxPropReadonly")&&r.setData("cxPropReadonly",detailView.readOnlyField||detailView.recordLocked)}n||$L(s)[0].parentElement.classList.remove("contentLoading")}}.bind(this),300);if(Lyte.registeredMixins["crm-detailcanvas-utils"]&&(Lyte.registeredMixins["crm-detailcanvas-utils"].isFormViewCommonCheck()||Lyte.registeredMixins["crm-detailcanvas-utils"].isWizardView()))$L(".crm-canvas-forms-container")[0].addEventListener("scroll",p);a?(c.addEventListener("scroll",p),c.addEventListener("resize",p),c.addEventListener("orientationchange",p)):(window.addEventListener("scroll",p),window.addEventListener("resize",p),window.addEventListener("orientationchange",p)),p()}},makeRequestForThumbnail:function(e,t,a,i,o,n,r,l,d,s){s||(s=!1);var c=Crm.getCrmBasePath()+"/EntityImageAttach.do?actionName=getGroupedThumbnailImages&fieldId="+a+"&parentId="+i+"&module="+$ESAPI.encoder().encodeForURL(t)+"&allImages=false&skipPermission="+s;c=networkUtils.getPortalURL(c),$L.ajax({url:c,type:"GET",dataType:"JSON",processData:!1,contentType:!1,success:function(t){Lyte.registeredMixins["crm-uploadfields-mixin"].addSrcToImageData(e,t[a],a,o,n,r,l,d,s)},error:function(){hideAnimatePopup("aa")}})},sortImagesComplete:function(e){return e.sort((function(e,t){return e.sequence-t.sequence})),e},isInViewport:function(e,t){if(e){var a,i=$L(window).scrollTop(),o=renderingUtils.windowHeight,n=i+o,r=(a=t?t.find(e):$L(e)).offset()&&a.offset().top,l=a.height(),d=r+l;return r>=i&&r<n||d>i&&d<=n||l>o&&r<=i&&d>=n}},fetchThumbnails:function(e,t){var a=this;return new Promise((function(i){t>e.length-1&&i(e),a.constructSizeMinimizedImage(e[t].original_src).then((function(o){e[t].src=o.url,a.fetchThumbnails(e,t+1).then((function(){i(e)}))}))}))},constructSizeMinimizedImage:function(e){return new Promise((function(t){var a=new Image;a.addEventListener("load",(function(){var e=a.width,i=a.height;e>i&&e>400?(i*=400/e,e=400):i>300&&(e*=300/i,i=300);var o=document.createElement("canvas");o.width=e,o.height=i;var n=o.getContext("2d");n.imageSmoothingEnabled=!1,Lyte.injectResources([networkUtils.returnDependencyFiles(["exif-plugin.js"],ResourceConstants.CRMClient)],void 0,function(){$L.exif({target:a,getData:function(r){var l=r.exifdata.Orientation,d=$L(".temporaryImageOrientationCheck")[0];if(void 0!==d&&"from-image"!==getComputedStyle(d).imageOrientation)switch(l){default:n.drawImage(a,0,0,e,i);break;case 6:o.width=a.height,o.height=a.width,n.rotate(90*Math.PI/180),n.drawImage(a,0,-a.height);break;case 8:o.width=a.height,o.height=a.width,n.rotate(-90*Math.PI/180),n.drawImage(a,-a.width,0);break;case 3:o.width=a.width,o.height=a.height,n.rotate(Math.PI/180*180),n.drawImage(a,0,0,-a.width,-a.height)}else n.drawImage(a,0,0,e,i);n.drawImage(a,0,0,e,i);var s=o.toDataURL("image/jpeg");t({url:s,status:"ok"})}})}.bind(this))})),a.addEventListener("error",(function(){t({url:void 0,status:"ok"})})),a.src=e}))},constructImageDataBySrc:function(e,t,a,i,o,n,r,l,d,s,c,p){for(var m=[].concat(e),u="dvinner",f=(m=Lyte.registeredMixins["crm-uploadfields-mixin"].sortImagesComplete(m)).length,g=0;g<f;g++)void 0===m[g].original_src&&(m[g].original_src=this.constructImageUrl(fileId,a,i,m[g].uploadid,m[g].filename,m[g].state,t));if(f>0){var h,v="crux-image-component[id=Image_"+t+"]";if(h=document.getElementById(u),o||p)this.makeRequestForThumbnail(e,a,t,i,n,l,r,null,s,c,!p&&o);else{var I=$L.debounce(function(){if(this.isInViewport(v,d)){var o;if(n)(o=document.getElementById(u)).removeEventListener("scroll",I),o.removeEventListener("resize",I),o.removeEventListener("orientationchange",I);else window.removeEventListener("scroll",I),window.removeEventListener("resize",I),window.removeEventListener("orientationchange",I);if(this.makeRequestForThumbnail(e,a,t,i,n,l,r,d,!1,c),detailView){var s=Lyte.registeredMixins["crm-uploadfields-mixin"].getCruxImageUploadComponents(r,"view");s&&!s.getData("cxPropReadonly")&&s.setData("cxPropReadonly",detailView.readOnlyField||detailView.recordLocked)}d||$L(v)[0].parentElement.classList.remove("contentLoading")}}.bind(this),300);if(Lyte.registeredMixins["crm-detailcanvas-utils"]&&(Lyte.registeredMixins["crm-detailcanvas-utils"].isFormViewCommonCheck()||Lyte.registeredMixins["crm-detailcanvas-utils"].isWizardView()))$L(".crm-canvas-forms-container")[0].addEventListener("scroll",I);n?(h.addEventListener("scroll",I),h.addEventListener("resize",I),h.addEventListener("orientationchange",I)):(window.addEventListener("scroll",I),window.addEventListener("resize",I),window.addEventListener("orientationchange",I)),I()}}},isInEditMode:function(e){e?($L(".detailViewContainer").addClass("editModeEnable"),$L(".newBusinessCardView").addClass("editModeEnable")):($L(".detailViewContainer").removeClass("editModeEnable"),$L(".newBusinessCardView").removeClass("editModeEnable"))},openFeaturePopup:function(e,t,a,i,o,n,r,l){if(null!==t)if("processing"!==t){if("waiting_for_approval"===t||"system_rejected"===t){var d=[];d=(d=(d=d.concat(networkUtils.returnDependencyFiles(["crm-vision-match-utils.js","crm-vision-create.js","crm-vision-validation.js","crm-image-upload-ziaError.js","crm-vision-helper.js"],ResourceConstants.CRMClient))).concat(networkUtils.returnDependencyFiles(["crm-image-upload-ziaError.css"],ResourceConstants.CRMClient))).concat(Crm.getVisionMyJobsDependency());var s=l;s||(s=store.peekRecord("field",o).api_name),Lyte.injectResources(d,void 0,(function(){return Lyte.registeredMixins["crm-vision-create"].renderVisionErrorPopUpForOtherFields(i,!0,n,a,r,e,s,"system_rejected"===t?"do_not_create":void 0)}))}}else detailView.renderVisionErrorPopUp("image_processing",n,r,void 0,void 0,void 0,!0)},validateAllImageUploadCreateFields:function(){var e=this.getAllCruxImageUploadCreateComponents();let t=e.length;var a=!0;for(let a=0;a<t;a++)e[a].component.setData("cxPropErrorMessage","");for(let i=0;i<t;i++)e[i].component.validate()||(a=!1);return a},validateImageUploadField:function(e){var t=!0;return e.validate()||(t=!1),t},thumbnailRequestForDV:function(e,t,a){if(!Object.keys(detailView.getThumbnailDataMap).length){let i=[];t.each(((e,t)=>{let a=t.id.split("_")[1];a&&i.push(a)})),i=i.join("."),Lyte.registeredMixins["crm-uploadfields-mixin"].makeRequestForThumbnailForAlLIU(e,i,a,"detailview")}},thumbnailRequestForCanvas:function(e,t,a,i){a=e?e.component.getData("module"):a,i=e?e.component.getData("entityId"):i;let o=t?[t]:Lyte.registeredMixins["crm-canvas-builder-process"].imageUploadFieldIdsInBuilder;!o||e&&(!e||!e.component||e.component.getData("getThumbnailDataMap")&&Object.keys(e.component.getData("getThumbnailDataMap")).length&&e.component.getData("getThumbnailDataMap")[t])||(o=o.join("."),Lyte.registeredMixins["crm-uploadfields-mixin"].makeRequestForThumbnailForAlLIU(a,o,i,"canvasBuilder"))},constructFinalValueForCanvas:function(e,t){let a=Lyte.registeredMixins["crm-uploadfields-mixin"].getCruxImageUploadComponents(t,"view").getValue().map((function(e){return e.id})),i=e.map((function(e){return e.id})),o=a.filter((e=>!i.includes(e))),n=o.length;for(var r=0;r<n;r++)e.push({id:o[r],_delete:null});return e},OnFormViewPopupImageChange:function(e){var t=e.getData("cxPropId");Lyte.registeredMixins["crm-uploadfields-mixin"].updateImageDetailsMap(e.getData("cxPropField").api_name,Lyte.registeredMixins["crm-uploadfields-mixin"].getCruxImageUploadComponents(t,"create").getData("images"),!0),document.querySelector("crm-canvas-form").component.data.record.$.set(e.getData("cxPropField").api_name,Lyte.registeredMixins["crm-uploadfields-mixin"].getCruxImageUploadComponents(t,"create").getValue())},updateThumbnailBasedOnSrc:function(e,t,a,i,o,n){if(e[a.id]){let r=t.component.getData("cxPropValue");this.addSrcToImageData(r,e[a.id],a.id,!1,a.api_name,t.component.data.cxPropId,!1,!1,!1,o,i,n)}},getCruxFileUploadCreateComponents:function(e){return $L('crux-file-upload-component[cx-prop-from="create"][cx-prop-id="'+e+'"]')},getCruxFileUploadViewComponents:function(e,t){return t?$L('crux-file-upload-component[cx-prop-from="view"][cx-prop-id="'+e+'"][fieldid="'+t+'"]'):$L('crux-file-upload-component[cx-prop-from="view"][cx-prop-id="'+e+'"]')},getAllCruxFileUploadComponents:function(){return $L("crux-file-upload-component")},getAllCruxFileUploadCreateComponents:function(){return $L('crux-file-upload-component[cx-prop-from="create"]')},validateAllFileuploadCreateFields:function(){var e=this.getAllCruxFileUploadCreateComponents();let t=e.length;var a=!0;for(let a=0;a<t;a++)e[a].component.setData("cxPropErrorMessage","");for(let i=0;i<t;i++)e[i].component.data.cxPropField.subform_api||e[i].component.validate()||(a=!1);return a},getFileUploadAttachedSize:function(e){var t=0;return this.getCruxFileUploadCreateComponents(e)[0].component.data.cxPropFiles.forEach((e=>{e.size&&(t+=parseInt(e.size))})),t},getFileUploadAttachedCount:function(e){return this.getCruxFileUploadCreateComponents(e)[0].component.data.cxPropFiles.length},setUploadDetailInRecordCrux:function(e){var t=this.getCruxFileUploadCreateComponents(fileupload.cxPropId)[0].component,a=t.$node.parentElement;if(e){var i=[];if(e.fromFileUpload)e.fromFileUpload.forEach((e=>{var t=e.uploadedValues;"object"!=typeof e.uploadedValues&&(t=JSON.parse(e.uploadedValues));var a={};a.fileName=t.fileName,a.fileType=this.getFileType(t),a.size=t.streamsize,a.encryptedUploadId=e.encryptedUploadId,a.preview_Url=t.preview_Url,a.download_Url=t.download_Url,a.link_Docs=t.link_Docs,a.extn=t.extn,a.mode=t.mode,a.is_Preview_Available=t.is_Preview_Available,a.file_Id=t.resourceId,i.push(a)}));else if(e.resources){var o=e.resources.length;e.resources.forEach((e=>{var t={};t.fileName=e.fileName,t.fileType=this.getFileType(e),t.size=e.sizeInBytes,t.encryptedUploadId=e.encryptedUploadId,t.preview_Url=e.link,t.link_Docs=3,t.file_Id=e.link.substring(e.link.lastIndexOf("/")+1),i.push(t),Crm.trackSpotLightAction("Workdrive Files Attached",{Place:"file upload field",Count:o})}))}else e.uploadedDetails&&e.uploadedDetails.forEach((e=>{var t=e.uploadeddetails,a={};a.fileName=t.filename,a.fileType=this.getFileType(t),a.size=t["content-length"],a.encryptedUploadId=e.encryptedUploadId,a.file_Id=t.resourceId,a.link_Docs=e.link_Docs,a.preview_Url=e.preview_Url,a.download_Url=e.download_Url,a.extn=e.extn,a.mode=e.mode,a.is_Preview_Available=e.is_Preview_Available,i.push(a)}));i.forEach((e=>{3!==e.link_Docs?t.setFiles({fileName:e.fileName,fileType:this.getFileType(e),size:e.size,encryptedUploadId:e.encryptedUploadId,preview_Url:e.preview_Url,download_Url:e.download_Url,mode:e.mode,is_Preview_Available:e.is_Preview_Available,link_Docs:e.link_Docs,extn:e.extn,encryptedUploadId:e.encryptedUploadId?e.encryptedUploadId:null,file_Id:e.file_Id,attachment_Id:e.attachment_Id?e.attachment_Id:null,unique_file_selector:e.encryptedUploadId?e.encryptedUploadId:e.attachment_Id}):t.setFiles({fileName:e.fileName,fileType:this.getFileType(e),encryptedUploadId:e.encryptedUploadId,attachment_Id:e.attachment_Id?e.attachment_Id:null,preview_Url:e.preview_Url,file_Id:e.file_Id,link_Docs:e.link_Docs,unique_file_selector:e.encryptedUploadId?e.encryptedUploadId:e.attachment_Id})}));let a=$L(t.$node);t.data.cxPropFiles.length>=t.data.cxPropFileLimit&&a.closest("crm-canvas-form").length&&a.closest(".zcanvas-field").addClass("zc_disabledstate")}var n=$L("crm-canvas-form")[0],r=$L("crm-create-layout")[0];const l=store.peekRecord("field",t.data.cxPropField&&t.data.cxPropField.id),d=l&&l.isWizardCRSetValue;if(CScriptLib&&!d){var s=t.data.cxPropField.api_name,c=t.data.cxPropField.id;CScript.Engine.Global.dispatchEvent("onChange",void 0,s),n?CanvasCreatePageHandler.intercept_field(c):CScript.Engine.Global.dispatchEvent("onChange",c,CreatePageHandler.field_read.call({field_name:s}))}if(n&&n.component.data&&("form_edit"===n.component.data.form_type||"form_create"===n.component.data.form_type))return a.parentElement&&a.parentElement.component&&a.parentElement.component.data.isSubformField&&(p=!0,a=a.parentElement.component.data),void u(p?a.dataBind:n.component.data.record,p?a.subformFields.api_name:t.data.cxPropField.api_name);if((!a.dataset||"canvas_ajax_edit_component"!==a.dataset.zcqa)&&"Users"!==fileupload.module){a=a.parentElement;var p=!1;if(a.component&&a.component.data.isSubformField)p=!0,a=a.component.data;else{if(!a.parentElement.component)return;a=a.parentElement.component.data}var m=a.initRoute;if("edit"===m||"create"===m||"detail"===m||"clone"===m)u(a.dataBind,p?a.subformFields.api_name:a.apiName)}function u(e,i){var o=t.getValue();if(!r&&n&&(r=n),r){var l=r.component.data.fileuploadFieldsData,d=l;p&&(l[a.apiName]||(l[a.apiName]={}),l[a.apiName][a.dataBind.id]||(l[a.apiName][a.dataBind.id]={}),d=l[a.apiName][a.dataBind.id]),Lyte.Component.set(d,i,t.data.cxPropFiles)}e[i]&&r&&r.component.data.isWizard&&e[i].forEach((e=>{if(e.hasOwnProperty("_delete")){var a=0!==t.data.cxPropFiles.filter((t=>t.attachment_Id&&t.attachment_Id===e.attachment_id)).length,i=0!==o.filter((t=>t.attachment_id&&t.attachment_id===e.attachment_id)).length;a||i||o.push(e)}else if(e.hasOwnProperty("file_id")){var n=0!==t.data.cxPropFiles.filter((t=>t.encryptedUploadId&&t.encryptedUploadId===e.encryptedUploadId)).length,r=0!==o.filter((t=>t.file_id&&t.file_id===e.encryptedUploadId)).length;n&&!r&&o.push(e)}})),Lyte.Component.set(e,i,o)}},getFileDataInCruxFormat:function(e){var t=[];return!e&&""===e||e===I18n.getMsg("crm.tpi.ctiapi.config.choosefile")?e=[]:"string"==typeof e&&(e=JSON.parse(e)),e&&0!==e.length&&e.forEach((e=>{null!==e._delete&&(e.fileName||e.file_Name)&&(e.link_Docs&&3===e.link_Docs?t.push({fileName:e.fileName?e.fileName:e.file_Name,fileType:this.getFileType(e),attachment_Id:e.attachment_Id,preview_Url:e.preview_Url,file_Id:e.preview_Url.substring(e.preview_Url.lastIndexOf("/")+1),mode:e.mode,encryptedUploadId:e.encryptedUploadId?e.encryptedUploadId:null,cxNewFile:!!e.encryptedUploadId,is_Preview_Available:e.is_Preview_Available,link_Docs:e.link_Docs,extn:e.extn,unique_file_selector:e.encryptedUploadId?e.encryptedUploadId:e.attachment_Id}):t.push({fileName:e.fileName?e.fileName:e.file_Name,fileType:this.getFileType(e),size:e.size?e.size:e.original_Size_Byte,attachment_Id:e.attachment_Id,download_Url:e.download_Url,preview_Url:e.preview_Url,file_Id:e.file_Id,mode:e.mode,encryptedUploadId:e.encryptedUploadId?e.encryptedUploadId:null,cxNewFile:!!e.encryptedUploadId,is_Preview_Available:e.is_Preview_Available,link_Docs:e.link_Docs,extn:e.extn,unique_file_selector:e.encryptedUploadId?e.encryptedUploadId:e.attachment_Id}))})),t},getFileType(e){var t;if(e.link_Docs&&3===e.link_Docs)return"zwdrive";var a=e.filename;e.fileName?a=e.fileName:e.file_Name&&(a=e.file_Name),t=a.substring(a.lastIndexOf(".")+1).toLowerCase();return["jpeg","jpg","gif","png","webp","bmp","svg"].includes(t)?"image":["pdf"].includes(t)?"pdf":["zip","zipx","tar","gz","z","cab","rar","bz2","lzh","7z","img","iso"].includes(t)?"zip":["avi","wmv","mp4","mpeg","mpg","mov","flv","mkv","webm"].includes(t)?"video":["mp3","ogg","oga","wma","m4p","m4a","au","3gp"].includes(t)?"audio":["doc","docx","odt","rtf"].includes(t)?"docx":["odp","pps","pot","pptx","ppt"].includes(t)?"ppt":["csv","xls","xlsx","ods","xlsm","sxc","tsv"].includes(t)?"xls":["html","htm"].includes(t)?"html":"allfile"},setFilesDataFromRecord:function(e,t){var a=this.getFileDataInCruxFormat(t);return e.setData("files",a),a},setFilesDataForCanvasAndUsers:function(e,t,a,i){var o={},n=[];t&&t[0]&&"string"==typeof t[0]?t.forEach((e=>{var t=store.peekRecord("field",e);t&&n.push(t)})):n=t,n.forEach((e=>{if("fileupload"===e.data_type&&!e.subform_api){var t=a[e.api_name],n=this.getFileDataInCruxFormat(t);if(o[e.api_name]=n,i){let t="label_"+e.column_name,a=e.id;for(var r=this.getCruxFileUploadViewComponents(t,a),l=r.length,d=0;d<l;d++)r[d].component.setData("cxPropValue",n)}}})),e.setData("fileUploadFilesData",o)},getOptionsForFileUploadField:function(){var e=Lyte.registeredMixins["crm-detail-view-utils"].getAttachmentActions("FileuploadField"),t=[];return e.forEach((e=>{var a;switch(e["data-cid"]){case"attachDesktop":a='<crmutil-icon icon-name="fileupload" icon-class="zcicn-fileupload"></crmutil-icon>';break;case"attachDocuments":a='<crmutil-icon icon-name="attachment-document" icon-class="zcicn-attachment-document zcicn-attachment-document-plain"></crmutil-icon>';break;case"teamDrivePicker":a='<span class="dIF jcCenter aiCenter h16 mAuto w16 br3 zcicn_oceanBlue_mask"> <crmutil-icon icon-name="zoho-workdrive" icon-class="zcicn-zoho-workdrive zcicn12 zcicn_white"> </crmutil-icon> </span>';break;case"attachZDocs":a='<span class="aiCenter br3 dIF h16 jcCenter mAuto w16 zcicn_oceanBlue_mask"> <crmutil-icon icon-name="docs" icon-class="zcicn-docs zcicn12 zcicn_white">  </crmutil-icon>  </span>';break;case"cloudPicker":a='<crmutil-icon icon-name="cloud-upload" icon-class="zcicn-cloud-upload zcicn16"></crmutil-icon>'}a&&t.push({system_value:e.name,display_value:e.label,cxIconHTML:a})})),t},setOptionsForFileUploadField:function(e){e.setData("optionsForFileUpload",this.getOptionsForFileUploadField())},setShowPreviewMethodForAllFileUploadFieldCruxComponents:function(){for(var e=this.getAllCruxFileUploadComponents(),t=e.length,a=0;a<t;a++)e[a].component.setMethods({showPreview:function(e){this.showPreviewImpl(e)}.bind(this)})},setMethodsForFileUploadCruxComponetByCxPropId:function(e){var t=this.getCruxFileUploadCreateComponents(e)[0],a=Lyte.registeredMixins["crm-uploadfields-mixin"],i=$L("crm-canvas-form")[0];if(t&&i){var o=i.co;t.component.setMethods({onMenuClick:function(e,t){a.onFileUploadOptionClickImpl(o,e,t)},showUploadModal:function(e){a.showAttachFilePopupImpl(o,e)},onRemoveFile:function(e,t){a.onRemoveFileClickImpl(e,t)},showPreview:function(e){a.showPreviewImpl(e)}})}},setMethodsForImageUploadCruxComponetByCxPropId:function(e){var t=this.getCruxImageUploadComponents(e,"create"),a=$L("crm-canvas-form")[0],i=Lyte.registeredMixins["crm-uploadfields-mixin"];t.setMethods({onFileSuccess:function(e){return i.constructImageData(e)},onAttach:function(){i.OnFormViewPopupImageChange(t)},onRemove:function(){i.OnFormViewPopupImageChange(t)},onEdit:function(){i.OnFormViewPopupImageChange(t)},onDrop:function(){i.OnFormViewPopupImageChange(t)},onCropSuccess:function(e,a){var o=t.getData("cxPropId"),n=i.onCropSuccess(e,a);return i.updateImageDetailsMap(t.getData("cxPropField").api_name,i.setCropImage(n,i.getCruxImageUploadComponents(o,"create").getData("images")),!0),document.querySelector("crm-canvas-form").component.data.record.$.set(t.getData("cxPropField").api_name,i.setCropImage(n,i.getCruxImageUploadComponents(o,"create").getValue())),n},openZiaVisionPopup:function(e){i.openFeaturePopup(e.uploadid,e.state,!0,!1,a.getData("moduledataUicomp.id"),a.getData("moduleData.module_name"),a.getData("dataBind.id"),t.getData("cxPropField").api_name)}})},setFileUploadEmptyViaCScript:function(e,t,a){var i;if(t&&a)$L(a).find("crux-file-upload-component").find("ul").children().each(((e,t)=>$L(t).find(".cxRemoveFile").click()));else for(var o=(i=$L("crux-file-upload-component")).length,n=0;n<o;n++){var r=i[n];if(r.component.data.cxPropField.id===e)for(var l=$L(r).find("ul").children(),d=l.length,s=0;s<d;s++)l.eq(s).find(".cxRemoveFile").click()}},methods:{onFileUploadOptionClick:function(e,t,a){a&&a.data.cxPropField&&a.data.cxPropField.module&&a.data.cxPropField.module[0].module_name&&(e=a.data.cxPropField.module[0].module_name),this.onFileUploadOptionClickImpl(e,t,a)},onRemoveFileClick:function(e,t){this.onRemoveFileClickImpl(e,t)},showPreview(e){this.showPreviewImpl(e)},showAttachFilePopup:function(e,t){t&&t.data.cxPropField&&t.data.cxPropField.module&&t.data.cxPropField.module[0].module_name&&(e=t.data.cxPropField.module[0].module_name),this.showAttachFilePopupImpl(e,t)},onImageAddOrRemove:function(){$L(".crmImgUploadModal").length&&crmInteraction.modalShadow(".crmImgUploadModal")},setImageData:function(e){return this.constructImageData(e)},onImageCompRendered:function(e,t){let a=this.getData("getThumbnailDataMap"),i=t.component.getData("cxPropField");Lyte.registeredMixins["crm-uploadfields-mixin"].updateThumbnailBasedOnSrc(a,t,i)},makeRequestForThumbnailCE:function(e,t,a,i){let o=document.querySelector("crm-create-layout").component.getData("getThumbnailDataMap");Lyte.registeredMixins["crm-uploadfields-mixin"].updateThumbnailBasedOnSrc(o,i,e,t,a)},openZiaVisionPopup:function(e,t,a){e&&this.openFeaturePopup(a.uploadid,a.state,e,!e,t.id,this.getData("moduleName"),this.getData("recordId"),t.api_name),this.getData("ajaxEditFld")?this.openFeaturePopup(a.uploadid,a.state,!1,!0,t.id,this.data.module,this.data.entityId,t.api_name):this.getData("moduledataUicomp.id")?this.openFeaturePopup(a.uploadid,a.state,!0,!1,t.id,this.getData("moduleData.module_name"),this.getData("dataBind.id"),this.getData("apiName")):this.getData("isWizard")&&this.getData("showRecordSummary")&&this.openFeaturePopup(a.uploadid,a.state,!0,!1,t.id,this.getData("moduleName"),this.getData("dataBind.id"),t.api_name)},onImageChange:function(){var e="label_"+this.getData("columnName");this.updateImageDetailsMap(this.getData("apiName"),this.getCruxImageUploadComponents(e,"create").getData("images"));var t=this.updateGetValueMap(this.getData("apiName"),this.getCruxImageUploadComponents(e,"create").getValue(),this.getCruxImageUploadComponents(e,"create").getData("cxPropValue"));t[this.getData("apiName")]?this.setData("dataBind."+this.getData("apiName"),t[this.getData("apiName")]):this.setData("dataBind."+this.getData("apiName"),this.getCruxImageUploadComponents(e,"create").getValue())},onCropSuccess:function(e,t,a){if(e)return this.onCropSuccess(t,a);var i="label_"+this.getData("columnName"),o=this.onCropSuccess(t,a),n=this.updateGetValueMap(this.getData("apiName"),this.setCropImage(o,this.getCruxImageUploadComponents(i,"create").getValue()),this.getCruxImageUploadComponents(i,"create").getData("cxPropValue"));return this.updateImageDetailsMap(this.getData("apiName"),this.setCropImage(o,this.getCruxImageUploadComponents(i,"create").getData("images"))),n[this.getData("apiName")]?this.setData("dataBind."+this.getData("apiName"),n[this.getData("apiName")]):this.setData("dataBind."+this.getData("apiName"),this.setCropImage(o,this.getCruxImageUploadComponents(i,"create").getValue())),o}},showAttachFilePopupImpl:function(e,t){var a=t.getData("cxPropField"),i=a.length?a.length:parseInt(a.maxlength),o=a.id?a.id:a.fieldid;if(fileupload.column_name=a.column_name?a.column_name:a.colname,fileupload.module=e,fileupload.fieldID=o,fileupload.cxPropId=t.data.cxPropId,a.maximum_allowed_size){let e=fileupload.formatBytes(a.maximum_allowed_size);fileupload.maximum_allowed_size=Number(e.split(" ")[0])}else fileupload.maximum_allowed_size=void 0;!e&&a.module&&a.module[0]&&(e=a.module[0].api_name),this.data&&this.data.isSubformField?(fileupload.isSubformField=!0,fileupload.rowNum=this.data.rowNum?this.data.rowNum:"",fileupload.subformApiName=this.data.apiName):(fileupload.isSubformField=!1,fileupload.rowNum="",fileupload.subformApiName=""),showCustomizePopup("Attach",e,null,"",!0,i,void 0,void 0,void 0,t)},onRemoveFileClickImpl:function(e,t){fileupload.cxPropId=t.data.cxPropId,this.setUploadDetailInRecordCrux();let a=$L(t.$node);t.data.cxPropFiles.length<t.data.cxPropFileLimit&&a.closest("crm-canvas-form").length&&a.closest(".zcanvas-field").removeClass("zc_disabledstate")},showPreviewImpl:function(e){switch(e.link_Docs){case 0:e.is_Preview_Available?"pdf"===e.extn?openSheetForExport(e.preview_Url,"pdfViewPlugin"):""!==e.mode?openSheetForExport(e.preview_Url):"png"===e.extn&&networkUtils.openUrl(e.preview_Url,"_blank"):networkUtils.openUrl(e.preview_Url,"_blank");break;case 1:"png"===e.extn?networkUtils.openUrl(e.preview_Url,"_blank"):triggerLinkDocsView(e.preview_Url,e.extn,e.attachment_Id,"fileupload");break;case 3:networkUtils.openUrl(e.preview_Url,"_blank")}sE(event)},onFileUploadOptionClickImpl:function(e,t,a){const i=Lyte.registeredMixins["crm-related-list-utils"];var o=a.getData("cxPropField"),n=o.length?o.length:parseInt(o.maxlength),r=o.sysRefName?o.sysRefName:o.api_name,l=o.id?o.id:o.fieldid;if(fileupload.column_name=o.column_name?o.column_name:o.colname,fileupload.module=e,fileupload.fieldID=l,fileupload.cxPropId=a.data.cxPropId,o.maximum_allowed_size){let e=fileupload.formatBytes(o.maximum_allowed_size);fileupload.maximum_allowed_size=Number(e.split(" ")[0])}else fileupload.maximum_allowed_size=void 0;if(!e&&o.module&&o.module[0]&&(e=o.module[0].api_name),this.data&&this.data.isSubformField?(fileupload.isSubformField=!0,fileupload.rowNum=this.data.rowNum?this.data.rowNum:"",fileupload.subformApiName=this.data.apiName):(fileupload.isSubformField=!1,fileupload.rowNum="",fileupload.subformApiName=""),"Zoho WorkDrive"===t.system_value){var d,s,c,p=$L("crm-detailview-canvas")[0],m=`workdrive_folder_id_${d=this.$node&&this.$node.component&&this.$node.component.data&&this.$node.component.data.initRoute?this.$node.component.data.initRoute:this.$node}`;switch(p&&(c=p.component.data.moduleData.fields.find((e=>e.api_name===r)),d="canvas",m="workdrive_folder_id_canvas"),d){case"create":case"edit":case"clone":s=o&&o.$?o.$.get(m):s;break;case"canvas":s=c&&c.$?c.$.get(m):s;break;default:s=detailView&&detailView.cscriptFieldAttribs&&detailView.cscriptFieldAttribs[r]&&detailView.cscriptFieldAttribs[r].workdriveFolderId?detailView.cscriptFieldAttribs[r].workdriveFolderId:s}}switch(t.system_value){case"Upload File":showCustomizePopup("Attach",e,null,"",!0,n,void 0,!0,void 0,a);var u=$L("#canvasquicksavemodal")[0];"Users"===e?document.querySelector("#topBandPopup").style.zIndex="1000":u&&u.ltProp("show")&&$L("#topBandPopup").addClass("fu_zi302");break;case"Document":openZDocsLinkDialog(Crm.userDetails.ZGID,!0);break;case"Zoho WorkDrive":Crm.userDetails.isRelatedListLyteEnabled?i.attachFromTeamDrive(!0,n,s):crmRelatedList.attachFromTeamDrive(!0,n,s);break;case"Zoho Docs":openForDocs("zdoc","<%= docUrl%>",null,!0);break;case"Cloud Picker":Crm.userDetails.isRelatedListLyteEnabled?i.attachFromCloudPickerForFileupload(l,e):crmRelatedList.attachFromCloudPickerForFileupload(l,e)}},formatBytes:function(e){return e?fileupload.formatBytes(e):"20 MB"}});
