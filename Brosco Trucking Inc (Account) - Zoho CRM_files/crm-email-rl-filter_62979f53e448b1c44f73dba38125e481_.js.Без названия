Lyte.Component.register("crm-email-rl-filter",{_template:'<template tag-name="crm-email-rl-filter"> <div class="dF aiCenter"> <template is="if" value="{{isDropdownNeeded}}"><template case="true"> <crux-dropdown id="moduleId" data_zcqa="associatedDropDown" cx-prop-type="single" cx-prop-user-value="value" cx-prop-system-value="name" cx-prop-selected="{{lbind(moduleSelected)}}" cx-prop-options="{{emailAssociatedOptions}}" class="dIB mL10 emails_rl_dropdown_list {{if(isCanvasView,\'w250\',\'\')}} mW160 {{if(isRlLyteNew,\'crmSmallDropdown\',\'\')}}" on-option-select="{{method(\'emailAssociatedOptionsSelected\')}}" cx-prop-freeze="true"></crux-dropdown> </template></template> <template is="if" value="{{isModuleSelected}}"><template case="true"> <crux-dropdown id="recordId" data_zcqa="moduleRelatedDropDown" cx-prop-type="single" cx-prop-user-value="value" cx-prop-system-value="name" cx-prop-selected="{{lbind(recordsSelected)}}" cx-prop-options="{{emailModuleRelatedOptions}}" class="dIB mL10 mW160 emails_rl_dropdown_list {{if(isRlLyteNew,\'crmSmallDropdown\',\'\')}}" on-option-select="{{method(\'emailModuleRelatedOptionsSelected\')}}" cx-prop-freeze="true"></crux-dropdown> </template></template> <template is="if" value="{{expHandlers(isNewDropDownNeeded,\'&amp;&amp;\',isCustomEmailPreferenceEnabled)}}"><template case="true"> <template is="if" value="{{isRecordSelected}}"><template case="true"> <lyte-dropdown id="emailsId" data_zcqa="emailsOnlyDropDown" name="emailsId" lt-prop-no-result="{{getI18n(&quot;crm.rl.filter.no.emails&quot;)}}" on-option-selected="{{method(\'emailIdOptionsSelected\')}}" lt-prop-multiple="true" lt-prop-remove-multiple="true" lt-prop-selected="{{lbind(emailsSelected)}}" class="dIB mL10 maxW160 emails_rl_dropdown_list {{if(isRlLyteNew,\'crmSmallDropdown\',\'\')}}" on-show="{{method(\'emailRlDropOpen\')}}" lt-prop-tooltip="{}"> <template is="registerYield" yield-name="yield"> <lyte-drop-box> <template is="if" value="{{expHandlers(emailIdOptions.length,\'>\',6)}}"><template case="true"> <lyte-search lt-prop-close-icon="true" lt-prop-component="dropdown" lt-prop-maxlength="100" lt-prop-query-selector=" { &quot;scope&quot; : &quot;.lyte-drop-bodyRL&quot; , &quot;search&quot; : &quot;lyte-drop-item&quot;} " id="emailRlDropSearch" on-search="{{method(\'onSearch\')}}"> </lyte-search> </template></template> <lyte-drop-body class="lyte-drop-bodyRL emailsRlDropBody"> <template is="for" items="{{emailIdOptions}}" item="email" index="index"> <template is="if" value="{{expHandlers(expHandlers(email.name,\'!==\',\'allEmails\'),\'&amp;&amp;\',expHandlers(email.name,\'!==\',\'allEmailsSentFrom\'))}}"><template case="true"> <lyte-drop-item email-label="{{email.label}}" class="emailsRl aiCenter dF spaceBetween" email="{{email.value}}" data-value="{{concat(email.value,\'_\',index)}}"><lyte-text lt-prop-value="{{trim(email.value)}}"> </lyte-text><lyte-text class="crm-small-font-size crmLabelColor mL20 minW50" lt-prop-value="{{concat(\'(\',email.label,\')\')}}"></lyte-text> </lyte-drop-item> </template><template case="false"> <lyte-drop-item class="emailsRl aiCenter dF spaceBetween" data-value="{{email.name}}"><lyte-text lt-prop-value="{{trim(email.value)}}"> </lyte-text></lyte-drop-item> </template></template> </template> </lyte-drop-body> </lyte-drop-box> </template> </lyte-dropdown> </template></template> </template></template> </div> </template>',_dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,5]},{type:"if",position:[1,5],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,3,1]},{type:"for",position:[1,3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,0]},{type:"componentDynamic",position:[1,0]},{type:"attr",position:[1,1]},{type:"componentDynamic",position:[1,1]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,0]},{type:"componentDynamic",position:[1,0]},{type:"componentDynamic",position:[1]}]}},default:{}}]},{type:"componentDynamic",position:[1,3]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}}],_observedAttributes:["rid","isRecordLocked","users","currentModule","isModuleSelected","isRecordSelected","isDropdownNeeded","isCanvasView","selectRecordId","selectedRlDropdownLabel","allEmailsOptions","emailAssociatedOptions","emailModuleRelatedOptions","emails","emailIdOptions","emailTypes","contactPrimaryEmails","contactAddnEmails","isNewDropDownNeeded","mailobj","moduleSelected","recordsSelected","emailsSelected","isVendorModule","vendorOrPO","vendorRLOptions","purchaseOrderId","isPurchaseOrderSelected","purchaseOrdersList","poSelected","isMultiplePO","primaryEmail","addnEmail","primaryEmailLabel","addnEmailLabel","record","isMailConfigured","contactModuleDetailsPopulated","useCustomEmails","fromDetailView","isCustomEmailPreferenceEnabled","isRlLyteNew","relatedToContactId","relatedToContact"],data:function(){return{rid:Lyte.attr("string"),isRecordLocked:Lyte.attr("boolean"),users:Lyte.attr("object"),currentModule:Lyte.attr("string",{default:$L("#module").val()}),isModuleSelected:Lyte.attr("boolean",{default:!1}),isRecordSelected:Lyte.attr("boolean",{default:!1}),isDropdownNeeded:Lyte.attr("boolean",{default:!1}),isCanvasView:Lyte.attr("boolean",{default:!1}),selectRecordId:Lyte.attr("string"),selectedRlDropdownLabel:Lyte.attr("string"),allEmailsOptions:Lyte.attr("array",{default:[]}),emailAssociatedOptions:Lyte.attr("array",{default:[]}),emailModuleRelatedOptions:Lyte.attr("array",{default:[]}),emails:Lyte.attr("object",{default:{}}),emailIdOptions:Lyte.attr("array",{default:[]}),emailTypes:Lyte.attr("array",{default:[]}),contactPrimaryEmails:Lyte.attr("object",{default:{}}),contactAddnEmails:Lyte.attr("object",{default:{}}),isNewDropDownNeeded:Lyte.attr("boolean",{default:!0}),mailobj:Lyte.attr("object"),moduleSelected:Lyte.attr("string",{default:"ACCOUNTS_ALL"}),recordsSelected:Lyte.attr("string",{default:"allContacts"}),emailsSelected:Lyte.attr("string"),isVendorModule:Lyte.attr("string",{default:!1}),vendorOrPO:Lyte.attr("string"),vendorRLOptions:Lyte.attr("array",{default:[]}),purchaseOrderId:Lyte.attr("string"),isPurchaseOrderSelected:Lyte.attr("boolean",{default:!1}),purchaseOrdersList:Lyte.attr("array",{default:[]}),poSelected:Lyte.attr("string"),isMultiplePO:Lyte.attr("boolean",{default:!1}),primaryEmail:Lyte.attr("string"),addnEmail:Lyte.attr("string"),primaryEmailLabel:Lyte.attr("string",{default:I18n.getMsg("crm.rl.filter.primary.email")}),addnEmailLabel:Lyte.attr("string",{default:I18n.getMsg("crm.email.autocomplete.label.secondaryemail")}),record:Lyte.attr("object"),isMailConfigured:Lyte.attr("boolean",{default:!1}),contactModuleDetailsPopulated:Lyte.attr("boolean",{default:!1}),useCustomEmails:Lyte.attr("boolean",{default:Crm.userDetails.isCustomEmailPreferenceEnabled}),fromDetailView:Lyte.attr("boolean"),isCustomEmailPreferenceEnabled:Lyte.attr("boolean",{default:Crm.userDetails.isCustomEmailPreferencePageEnabled}),isRlLyteNew:Lyte.attr("boolean",{default:Crm.userDetails.isRelatedListLyteEnabled}),relatedToContactId:Lyte.attr("string"),relatedToContact:Lyte.attr("object",{default:{}})}},didConnect:function(){Lyte.Router.getRouteInstance()&&"canvas"!==Lyte.Router.getRouteInstance().routeName&&!this.getData("fromDetailView")&&(this.setData("isCanvasView",!1),this.executeMethod("didConnectReRender"));var e=$L(".emailsRlDropBody .emailsRl")[0];if(e){var t=e.getAttribute("data-value"),a=$L("#emailsId");if("allEmails"!==t&&"allEmailsSentFrom"!==t){var l=e.getAttribute("email-label"),i=Lyte.Component.registeredHelpers.concat(t.slice(0,-2),"(",l,")");a.attr("lt-prop-title",i)}else"allEmails"===t?a.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails")):"allEmailsSentFrom"===t&&a.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails.sent.from.crm"))}},actions:{},methods:{didConnectReRender:function(){Lyte.Router.getRouteInstance()&&"canvas"===Lyte.Router.getRouteInstance().routeName&&this.setData("isCanvasView",!0);var e=this.getData("mailobj");if(e){var t=this.getData("currentModule");t||(t=e.module);var a=e.entityId,l=store.peekRecord(moduleRecordMapping[t].id,a);if(this.setData("record",l),this.setData("isMailConfigured",e.mailConfigured),"Accounts"===t){var i=e.contacts_details;if(i){this.setData("isDropdownNeeded",!0);var s=i.length;let e=[];if(1===s)e=[{name:"ACCOUNTS_ALL",value:I18n.getMsg("crm.label.all.accounts.email.sent")},{name:i[0].id,value:I18n.getMsg("crm.rl.filter.associated.singular.dropdown")}];else if(s>1){e=[{name:"ACCOUNTS_ALL",value:I18n.getMsg("crm.label.all.accounts.email.sent")},{name:"emailassociatedcontacts",value:I18n.getMsg("crm.rl.filter.associated.plural.dropdown")}];var o=this.populateAccountRLDropDown.call(this,s,i);this.setData("emailModuleRelatedOptions",o)}this.setData("emailAssociatedOptions",e),this.getData("contactModuleDetailsPopulated")&&store.findRecord("module",moduleRecordMapping[module].id).then((function(e){e&&e.data&&this.setData("contactModuleDetailsPopulated",!0)}))}}else if("Vendors"===t||"Leads"===t||"Contacts"===t)this.populateEmailIdsDropdown.call(this,t,a);else if("Cases"===t&&Crm.userDetails.isEmailsForCasesModuleEnabled){this.setData("moduleSelected","CASES_ALL");var r=store.peekRecord(moduleRecordMapping.Cases.id,a);if(r&&r.Related_To){this.setData("isDropdownNeeded",!0);var n=moduleRecordMapping.Cases.plural_label,d=r.Related_To.id;this.setData({relatedToContactId:d,relatedToContact:r.Related_To}),emailAssociatedOptions=[{name:"CASES_ALL",value:Lyte.Component.registeredHelpers.concat(n," - ",I18n.getMsg("crm.rl.filter.sent"))},{name:d,value:I18n.getMsg("crm.rl.filter.associated.singular.dropdown")}],this.setData({moduleSelected:"CASES_ALL",emailAssociatedOptions:emailAssociatedOptions})}}else{var c=e.singularMod;Object.keys(Object.keys(Crm.moduleInfo).filter((e=>e.includes("CustomModule"))).reduce(((e,t)=>Object.assign(e,{[Crm.moduleInfo[t].singularLabel]:[t]})),{})).indexOf(c)>=0&&this.populateEmailIdsDropdown.call(this,t,a)}}},emailAssociatedOptionsSelected:function(e,t){var a,l=$L(".selectTab").attr("id"),i=this.getData("currentModule"),s=this.getData("mailobj"),o=i;switch(t){case"ACCOUNTS_ALL":o="Accounts";break;case"CASES_ALL":o="Cases";break;default:o="Contacts"}if("ACCOUNTS_ALL"!==t&&"CASES_ALL"!==t){var r=$L("#recordId");if(r&&r.length>0&&"allContacts"!==r.get(0).cxProp("selected"))return;var n=[];if("Accounts"===i){var d=s.contacts_details,c=d.length;let e=[];switch(l){case"mails":e=[{name:"ACCOUNTS_ALL",value:I18n.getMsg("crm.label.all.accounts.email.sent")}];break;case"scheduledMails":e=[{name:"ACCOUNTS_ALL",value:I18n.getMsg("crm.label.all.accounts.email.scheduled")}];break;default:e=[{name:"ACCOUNTS_ALL",value:I18n.getMsg("crm.rl.filter.accounts.drafts")}]}1===c?(e.push({name:d[0].id,value:I18n.getMsg("crm.rl.filter.associated.singular.dropdown")}),this.setData("recordsSelected",d[0].name),this.getContactAndPopulateEmails.call(this,d[0].id,l)):c>1&&($L("#emailsId").css("display","none"),e.push({name:"emailassociatedcontacts",value:I18n.getMsg("crm.rl.filter.associated.plural.dropdown")}),n=this.populateAccountRLDropDown.call(this,c,d),this.setData("emailModuleRelatedOptions",n),this.setData("recordsSelected","allContacts"),this.setData("isModuleSelected",!0),showMailsListViaAPI(t,"-10","next",null,l,"ALL")),this.setData("emailAssociatedOptions",e)}else if("Cases"===i){var m=moduleRecordMapping.Cases.plural_label;let e=[];switch(l){case"mails":e=[{name:"CASES_ALL",value:Lyte.Component.registeredHelpers.concat(m," - ",I18n.getMsg("crm.rl.filter.sent"))}];break;case"scheduledMails":e=[{name:"CASES_ALL",value:Lyte.Component.registeredHelpers.concat(m," - ",I18n.getMsg("crm.rl.filter.scheduled"))}];break;default:e=[{name:"CASES_ALL",value:Lyte.Component.registeredHelpers.concat(m," - ",I18n.getMsg("crm.rl.filter.drafts"))}]}var p=this.getData("relatedToContactId");e.push({name:p,value:I18n.getMsg("crm.rl.filter.associated.singular.dropdown")}),this.setData("recordsSelected",this.getData("relatedToContact").name),this.getContactAndPopulateEmails.call(this,p,l),this.setData("emailAssociatedOptions",e)}}else showMailsListViaAPI(t,"-10","next",null,l,t),this.setData("isModuleSelected",!1),this.setData("isRecordSelected",!1);var u=Lyte.Component.registeredHelpers.isUserHasSendMailPermission(o);try{(a=$L("crm-rl-share-email")[0].component)&&a.setData("isUserHasSendMailPermission",u)}catch(e){murphy.error(err)}},emailModuleRelatedOptionsSelected:function(e,t){var a=$L(".selectTab").attr("id");"allContacts"!==(t=t)?(this.getContactAndPopulateEmails.call(this,t,a),$L(".emails_rl_dropdown_list").addClass("email_rl_acc_deal_dropdown")):(showMailsListViaAPI(t,"-10","next",null,a,"ALL"),this.setData("isRecordSelected",!1))},emailIdOptionsSelected:function(e,t,a,l){var i=$L("#emailsId"),s=i[0],o=(t=t,l.getAttribute("email-label"));"allEmails"===t?(s.ltProp("displayValue",I18n.getMsg("crm.rl.filter.all.emails")),i.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails"))):"allEmailsSentFrom"===t?(s.ltProp("displayValue",I18n.getMsg("crm.rl.filter.all.emails.sent.from.crm")),i.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails.sent.from.crm"))):(t=t.slice(0,-2),s.ltProp("displayValue",t));var r=$L(".selectTab").attr("id");if(o&&"allEmails"!==t&&"allEmailsSentFrom"!==t){var n=Lyte.Component.registeredHelpers.concat(t," (",o,")");i.attr("lt-prop-title",n)}else t&&"allEmails"===t?i.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails")):t&&"allEmailsSentFrom"===t&&i.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails.sent.from.crm"));var d=this.getData("selectRecordId");"allEmails"!==t&&"allEmailsSentFrom"!==t?showMailsListViaAPI(t,"-10","next",null,r,d,t):"allEmailsSentFrom"===t?showMailsListViaAPI("ALLUSERSMAILS","-10","next",null,r,d):showMailsListViaAPI(t,"-10","next",null,r,d)},onSearch:function(e){0===e.length?$L(".lyte-drop-bodyRL .lyteDropdownNoResult").css("display","block"):$L(".lyte-drop-bodyRL .lyteDropdownNoResult").css("display","none")},emailRlDropOpen:function(){var e=$L("#emailRlDropSearch").get(0);e&&(e.setValue(""),e.focus())}},setPrimaryAndSecondaryEmail:function(){var e=this.getData("record"),t=e.Email,a=e.Secondary_Email;this.setData("primaryEmail",t),this.setData("addnEmail",a)},getContactAndPopulateEmails:function(e,t){var a="Contacts",l=store.peekRecord(moduleRecordMapping[a].id,e),i=moduleRecordMapping[a].fields;if(l&&i)this.setData("record",l),this.populateEmailIdsDropdown.call(this,a,e,l),showMailsListViaAPI(e,"-10","next",null,t,e);else{"mails"!==t&&showMailsListViaAPI(e,"-10","next",null,t,e);var s=this;store.findRecord("module",moduleRecordMapping[a].id).then((function(i){i&&i.length>0&&(l?(s.setData("record",l),s.populateEmailIdsDropdown.call(s,a,e,l),"mails"===t&&showMailsListViaAPI(e,"-10","next",null,t,e)):store.findRecord(moduleRecordMapping[a].id,e).then((function(i){i&&i.length>0&&(l=i[0]?i[0]:{},s.setData("record",l),"mails"===t&&(s.populateEmailIdsDropdown.call(s,a,e,l),showMailsListViaAPI(e,"-10","next",null,t,e)))})))}))}},populateEmailIdsDropdown:function(e,t,a){var l=this.getData("record");a&&(l=a,this.setData("record",l));var i=moduleRecordMapping[e].fields,s=(this.getData("isMailConfigured"),[]),o=0,r=l.Email,n=l.Secondary_Email;if(r&&""!==r){o+=r.length;var d={label:this.getData("primaryEmailLabel"),value:r};s.push(d)}if(n&&""!==n){o+=n.length;d={label:this.getData("addnEmailLabel"),value:n};s.push(d)}var c=i.filter((e=>25===e.ui_type&&"Email"!==e.api_name&&"Secondary_Email"!==e.api_name)),m=(c=c.sort((function(e,t){let a=Date.parse(e.created_time),l=Date.parse(t.created_time);return a-l<0?-1:a-l>0?1:0}))).length;if(m>0&&this.getData("useCustomEmails"))for(var p=0;p<m;p++){var u=l[c[p].api_name];if(u&&""!==u){o+=u.length;d={label:c[p].display_label,value:u};s.push(d)}}if(s.length>=2){if(this.setData("isRecordSelected",!0),this.setPrimaryAndSecondaryEmail(),o+4<=500&&s.length<=5){var y={name:"allEmails",value:I18n.getMsg("crm.rl.filter.all.emails")},f="allEmails";s.unshift(y)}else{Crm.client_tracking("Email RL - Emails with more than 5");r=this.getData("primaryEmail");var g=this.getData("addnEmail");if(r&&""!==r)f=r+"_0";else if(g&&""!==g)f=g+"_0";else f=s[0].value+"_0";var L={name:"allEmailsSentFrom",value:I18n.getMsg("crm.rl.filter.all.emails.sent.from.crm")};s.push(L)}this.setData("emailIdOptions",s);var h=$L("#emailsId");if(h.css("display","block"),h.length>0){var D=h.get(0);D.ltProp("selected",""),this.setData("emailsSelected",f),D.ltProp("selected",f);var v=$L(".emailsRlDropBody .emailsRl")[0];if(v){var b=v.getAttribute("data-value");if("allEmails"!==b&&"allEmailsSentFrom"!==b){var C=v.getAttribute("email-label"),M=Lyte.Component.registeredHelpers.concat(b.slice(0,-2),"(",C,")");h.attr("lt-prop-title",M)}else"allEmails"===b?h.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails")):"allEmailsSentFrom"===b&&h.attr("lt-prop-title",I18n.getMsg("crm.rl.filter.all.emails.sent.from.crm"))}}}else this.setData("isRecordSelected",!1);this.setData("selectRecordId",t)},populateAccountRLDropDown:function(e,t){var a=[];switch($L(".selectTab").attr("id")){case"mails":var l={name:"allContacts",value:I18n.getMsg("crm.label.all.contacts.email.sent")};break;case"scheduledMails":l={name:"allContacts",value:I18n.getMsg("crm.label.all.contacts.email.scheduled")};break;default:l={name:"allContacts",value:I18n.getMsg("crm.rl.filter.contacts.drafts")}}if(a.push(l),1!==e)for(var i=0;i<e;i++){l={name:t[i].id,value:t[i].name};a.push(l)}return a}});
