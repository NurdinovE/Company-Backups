store.registerModel("zia_reasoning",{root_element_name:Lyte.attr("string",{primaryKey:!0}),extraDetails:Lyte.attr("object"),properties:Lyte.attr("array")},{actions:{zia_assignment_suggestions:{},user_assignment_threshold:{},user_criteria_suggestions:{},zia_suggested_users:{},zia_threshold_configuration:{}}}),store.registerAdapter("zia_reasoning",{namespace:"crm/v2.2/settings/automation/",buildURL:function(e,i,s,r,t){return"findRecord"===i?t.replace("/v2.2/settings/automation/zia_reasoning/assignment_rules","/v2/definition"):t.replace("zia_reasoning/","assignment/")}}),store.registerSerializer("zia_reasoning",{payloadKey:function(){return"definition"}}),store.registerModel("owner_suggestion_configuration",{id:Lyte.attr("string",{primaryKey:!0}),enabled:Lyte.attr("boolean",{default:!1}),module:Lyte.attr("object"),enabled_for_current_user:Lyte.attr("boolean",{default:!1}),shared_to:Lyte.attr("array")},{actions:{update:{},statistics:{},assignments:{},enable_user_threshold:{}}}),store.registerAdapter("owner_suggestion_configuration",{namespace:"crm/v2.2/settings/automation/",buildURL:function(e,i,s,r,t){return"action"===i?t.replace("/actions/update",""):t.replace("/owner_suggestion_configurations","/owner_suggestion_configuration")}}),store.registerSerializer("owner_suggestion_configuration",{payloadKey:function(){return"owner_suggestion_configuration"},normalizeResponse:function(e,i,s,r,t){if("findAll"===i&&(200===t||204===t)){var n=s.owner_suggestion_configuration;if(void 0===n)n=[];else for(var a=n.length,o=0;o<a;o++)n[o].id=n[o].module.id;s.owner_suggestion_configuration=n}return s}}),Lyte.Mixin.register("crm-zia-reasoning-mixin",{fetchDataForZiaReasoningTab:function(e,i){var s=e.extraDetails.ziaReasoningPermittedModules;if(void 0===s)return renderingUtils.displayPermissionDenied(),{permission_denied:!0};var r,t=Lyte.registeredMixins["crm-assignment-rules-mixin"].getModulesList(!0,e.extraDetails.ziaReasoningPermittedModules),n=Lyte.deepCopyObject(store.model.module.data.filterBy({module_name:i}));if(!(void 0!==i&&void 0!==n&&n.length>0))return r=t[0].api_name,i=t[0].module_name,Lyte.Router.getRouteInstance().setQueryParams({module:i});if(r=n[0].api_name,!s.contains(i))return Lyte.Router.getRouteInstance().transitionTo("crm.settings.section.zia-reasoning"),renderingUtils.displayPermissionDenied(),{permission_denied:!0};var a,o,l=e.extraDetails.ziaAvailableModules[i];if(!(l=void 0!==l&&l))return{isZiaAvailable:l,module:r,modulesList:t};var u=$L.moment().timezone(Crm.userDetails.USER_TIME_ZONE);a=u.format("YYYY-MM-DDT00:00:00Z"),o=u.format("YYYY-MM-DDT23:59:59Z");var _="object"==typeof Crm&&Crm.isZiaOwnerRecommendationEnabled;return Lyte.resolvePromises({module:r,modulename:i,modulesList:t,isZiaAvailable:l,module_info:store.findRecord("module",n[0].id).then((function(e){return Lyte.deepCopyObject(e)})),fields:store.findAll("field",{module:r},void 0,void 0,{apiVersion:"2.2"}).then((function(e){return Object.assign([],e)})),statistics:_?store.triggerAction("owner_suggestion_configuration","statistics",void 0,{module:r,from_datetime:a,to_datetime:o},"GET"):null,zia_threshold_configuration:_?store.triggerAction("zia_reasoning","zia_threshold_configuration",void 0,{module:r},"GET"):null,zia_assignment_suggestions:store.triggerAction("zia_reasoning","zia_assignment_suggestions",void 0,{module:r},"GET"),user_assignment_threshold:store.triggerAction("zia_reasoning","user_assignment_threshold",void 0,{module:r,per_page:200,page:1,include_inner_details:"user.status"},"GET"),user_criteria_suggestions_criteriagrouped:store.triggerAction("zia_reasoning","user_criteria_suggestions",void 0,{module:r,group_by:"criteria",per_page:200,page:1,include_inner_details:"user.status"},"GET"),user_criteria_suggestions_usergrouped:store.triggerAction("zia_reasoning","user_criteria_suggestions",void 0,{module:r,group_by:"user",per_page:200,page:1,include_inner_details:"user.status"},"GET"),owner_suggestion_configuration:_?store.findAll("owner_suggestion_configuration",{module:r}).then((function(e){return Object.assign({},e[0])})):null,cv_details:_?store.findAll("custom_view",{module:r}).then((function(e){for(var i=e.length,s={module:r},t=0;t<i;t++)if("ALLVIEWS"===e[t].system_name)return s.cvid=e[t].id,store.findRecord("custom_view",e[t].id,{module:r}).then((function(e){return s.cvfields=Object.assign([],e.fields),s}))})):null,profiles:_?store.findAll("profile",{include_lite_profile:"true"}):null,roles:_?store.findAll("role"):null}).then((function(e){return e}),(function(i){if(void 0!==i){var s,n,a="error",o=JSON.parse(i.response).code,l=$L("#assignmentRulesAlert")[0];if(void 0===l&&((l=Lyte.Component.render("lyte-alert",{ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.button.ok"),appearance:"primary"}]},"body")).ltProp("showCloseButton",!1),l.ltProp("contentAlign","center"),l.ltProp("buttonPosition","center"),l.ltProp("wrapperClass","arWarnAlert"),l.ltProp("top","0")),void 0!==i.response)switch(o){case"FEATURE_NOT_SUPPORTED":a="warning",s=I18n.getMsg("crm.zes.mobile.error.feature");break;case"INVALID_MODULE":s=I18n.getMsg("crm.label.module.invalid"),n=I18n.getMsg("crm.label.invalid.module");break;case"INTERNAL_ERROR":s=I18n.getMsg("crm.assignment.rule.internal.error"),n="";break;default:return store.unloadAll("zia_reasoning"),Lyte.Router.getRouteInstance().transitionTo("crm.settings.section.assignment-rule.index-assignment-rule"),renderingUtils.displayPermissionDenied(),{permission_denied:!0}}else a="warning",s=I18n.getMsg("crm.unable.to.process.request"),n="";return l.ltProp("primaryMessage",s),l.ltProp("type",a),void 0!==n&&l.ltProp("secondaryMessage",n),l.ltProp("show",!0),{module:r,modulesList:t,permission_denied:!0,is_error:!0,errorResponse:e}}}))},constructModelDataForZiaResoningTab:function(e){if(e.permission_denied)return e;var i={},s=e.module;if(i.selected_module_api_name=s,i.selected_modulename=e.modulename,i.modules_list=e.modulesList,void 0!==e.is_error&&e.is_error)return i.is_error=!0,i;if(!e.isZiaAvailable)return i;if(i.is_model_available_for_module=e.isZiaAvailable,i.module_fields=e.fields,i.module_info=e.module_info[0],i.module_info.fields=i.module_fields,"object"==typeof Crm&&Crm.isZiaOwnerRecommendationEnabled){var r=e.owner_suggestion_configuration;i.owner_suggestion_configuration=r,i.accessible_by=Lyte.registeredMixins["crm-zia-reasoning-mixin"].constructAccessibleByFromResponse(r.shared_to),i.zor_enabled_for_module=r.enabled,i.cv_details=e.cv_details;var t=Lyte.registeredMixins["crm-zia-reasoning-mixin"].constructCustomFieldsForLV(e.cv_details.cvfields,e.fields,e.module_info[0],s);i.listview_details=t}if(e.zia_assignment_suggestions=e.zia_assignment_suggestions.zia_assignment_suggestions,void 0===e.zia_assignment_suggestions)return i.is_model_available_for_module=!1,i;var n,a=e.zia_assignment_suggestions.length;if(i.is_model_available_for_module=a>0,!i.is_model_available_for_module)return i;i.is_scheduled_for_update=!1,i.is_failed=!1;for(var o=0;o<a;o++){var l=JSON.parse(JSON.stringify(e.zia_assignment_suggestions[o]));n=JSON.parse(JSON.stringify(l));var u=[];if(l.contributing_fields=Lyte.registeredMixins["crm-assignment-rules-mixin"].getDetailedFieldsList(l.contributing_fields,e.fields,u),i.is_model_available_for_module=l.contributing_fields.length>0,!i.is_model_available_for_module)return i;if("scheduled_for_remodelling"===l.type&&null===l.failure_type)i.contributing_fields_userview=l,i.is_scheduled_for_update=!0,i.unmodified_contributing_fields_userview=n;else if("scheduled_for_remodelling"===l.type&&null!==l.failure_type){i.is_failed=!0;var _=new CrmDate(new Date(l.last_updated_time),!1),d=_.getTimeInUserPattern()+", "+_.getDateInUserPattern();"minimum_records_unavailable"===l.failure_type?i.failure_reason=I18n.getMsg("crm.ziareasoning.min.records.unreached.failure.on",d):"same_ownership_across_records"===l.failure_type?i.failure_reason=I18n.getMsg("crm.ziareasoning.same.owner.failure.on",d):i.failure_reason=I18n.getMsg("crm.ziareasoning.unknown.failure.on",d)}else"current_model"===l.type&&(i.contributing_fields_model=Object.assign({},l),i.field_details_array=u)}return i.is_scheduled_for_update||(i.contributing_fields_userview=i.contributing_fields_model,i.unmodified_contributing_fields_userview=n),void 0===e.user_assignment_threshold.user_assignment_threshold&&(e.user_assignment_threshold.user_assignment_threshold=[],e.user_assignment_threshold.meta={}),i.user_assignment_threshold=e.user_assignment_threshold,void 0===e.user_criteria_suggestions_criteriagrouped.user_criteria_suggestions&&(e.user_criteria_suggestions_criteriagrouped.user_criteria_suggestions=[],e.user_criteria_suggestions_criteriagrouped.meta={}),i.user_criteria_suggestions_criteriagrouped=e.user_criteria_suggestions_criteriagrouped,void 0===e.user_criteria_suggestions_usergrouped.user_criteria_suggestions&&(e.user_criteria_suggestions_usergrouped.user_criteria_suggestions=[],e.user_criteria_suggestions_usergrouped.meta={}),i.user_criteria_suggestions_usergrouped=e.user_criteria_suggestions_usergrouped,null!==e.statistics&&null!==e.statistics.statistics&&(i.statistics=e.statistics.statistics[0]),null!==e.zia_threshold_configuration&&null!==e.zia_threshold_configuration.zia_threshold_configuration&&(i.zia_threshold_enabled_for_module=e.zia_threshold_configuration.zia_threshold_configuration[0].enabled),i},fetchCriteriaData:function(e,i,s){var r,t,n;if(i)t=1,"criteria"===e?(r="user_criteria_suggestions_criteriagrouped",n="issearching_CV"):(r="user_criteria_suggestions_usergrouped",n="issearching_LV");else{var a=this.getData("meta");if(!0!==a.more_records||!1!==this.getData("isFetchingDataOnScroll"))return;t=void 0===(t=a.page)?1:t+1,s=this.getData("selected_user").user_id}var o={module:this.getData("selected_module_api_name"),per_page:200,page:t,group_by:e,include_inner_details:"user.status"};s&&"All"!==s&&(o.user_id=s);var l=this;return commonUtils.showHideLoadingDiv(!0),store.triggerAction("zia_reasoning","user_criteria_suggestions",void 0,o,"GET").then((function(e){if(void 0===e.user_criteria_suggestions&&(e.user_criteria_suggestions=[],e.meta={}),i)l.setData(r,e),l.setData(n,!1);else{l.setData("meta",e.meta);var s=l.getData("user_criteria_suggestions");Lyte.arrayUtils(s,"push",e.user_criteria_suggestions)}commonUtils.showHideLoadingDiv(!1)}),(function(e){"NO_PERMISSION"===JSON.parse(e.response).code&&renderingUtils.displayPermissionDenied();var s={};if(void 0===s.user_criteria_suggestions&&(s.user_criteria_suggestions=[],s.meta={}),i)l.setData(r,s),l.setData(n,!1);else{l.setData("meta",s.meta);var t=l.getData("user_criteria_suggestions");Lyte.arrayUtils(t,"push",s.user_criteria_suggestions),l.setData("isFetchingDataOnScroll",!1)}commonUtils.showHideLoadingDiv(!1)}))},filterActiveUsers:function(e){if(null===e)return e;for(var i=[],s=e.length,r=0;r<s;r++)void 0!==e[r].status&&"active"!==e[r].status&&"ACTIVE"!==e[r].status||i.push(e[r]);return i.length>0?i:null},constructAccessibleByFromResponse:function(e){for(var i=[],s=null!==e?e.length:0,r=0;r<s;r++){var t=e[r],n={};switch(n.id=t.id,n.name=t.name,t.type){case"groups":n.prefix="G",n.type="user_group";break;case"profiles":n.prefix="P",n.type="profile";break;case"roles":n.type="role",n.prefix=t.subordinates?"RS":"R";break;case"users":n.prefix="U",n.type="user"}i[r]=n}return i},constructCustomFieldsForLV:function(e,i,s,r){var t=Object.assign({},crmConstants.defaultUiTypeToCruxMapping),n=[];Object.assign(t,{20:"user",127:"lookup",2:"text",133:"lookup"});var a=[],o={},l={};if(null!==e){for(var u=e.length,_=i.length,d=0;d<u;d++)for(var g=0;g<_;g++)if("Owner"===i[g].api_name&&e[d].id===i[g].id&&(i[g].available_in_user_layout=!0,(l=i[g]).list_display_label=i[g].field_label,n[i[g].api_name]=t[i[g].ui_type]),e[d].api_name===i[g].api_name&&"Owner"!==e[d].api_name&&e[d].id===i[g].id){i[g].available_in_user_layout=!0,i[g].list_display_label=i[g].field_label,a.push(i[g]),n[i[g].api_name]=t[i[g].ui_type];break}if(validationUtils.isEmpty(l)){i.forEach((function(e){"Owner"===e.api_name&&(l=e)})),l.available_in_user_layout=!0,l.list_display_label=l.field_label,n.Owner=t[l.ui_type]}for(var c=0;c<_;c++){o[i[c].api_name]=i[c].field_label}}var m=[],f=[],p=[];m.push(l),m=m.concat(a);var v=Lyte.registeredMixins["crm-view-utils"].fieldYieldMapping(m,!1,s,r);f=m.slice(),Lyte.arrayUtils(f,"insertAt",1,Lyte.deepCopyObject(l)),p=m.slice(),Lyte.arrayUtils(p,"insertAt",1,Lyte.deepCopyObject(l)),f[1].api_name="zia_suggested_user";var y=I18n.getMsg("crm.zia.recommended.owner");f[1].display_label=y,f[1].display_field_label=y,f[1].field_label=y,f[1].available_in_user_layout=!0,i.push(f[1]);var h=Lyte.registeredMixins["crm-view-utils"].fieldYieldMapping(f,!1,s,r);p[1].api_name="zia_suggested_user_1",y=I18n.getMsg("crm.zor.recommender.user"),p[1].display_label=y,p[1].display_field_label=y,p[1].field_label=y,p[1].available_in_user_layout=!0,i.push(p[1]);var b=Lyte.registeredMixins["crm-view-utils"].fieldYieldMapping(p,!1,s,r),z=i.length;for(d=0;d<z;d++)if("zia_suggested_user_1"===i[d].api_name){i[d].api_name="zia_suggested_user";break}return{fieldMapping:n,fieldsList:a,ownerFieldObj:l,apiNameVsDisplayLabel:o,column_list:{assigned_records:v,records_reassigned_manually:h,records_with_recommendation:b}}}});
