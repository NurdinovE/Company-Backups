Lyte.Mixin.register("crm-vision-image-utils",{getGallerylistFromDI:function(e){var t=$L("crm-ziavision-trainingdetails-criteria")[0].component;t.setData("gallery_list",[]);var a="imgValidation"===e?"match":"detect";store.triggerAction("visions","gallery_list",{action:a},null,"GET").then((function(e){!function(e){if(e){for(var a=e.gallery_models,i=a.length,n=0;n<i;n++){var r="crm.zia.vision.gallery.".concat(a[n]);a[n]=I18n.getMsg(r)}t.setData("gallery_list",a)}}(e)}),(()=>{}))},makeReqPoolCallToDI:function(e,t){store.findAll("dummy",void 0,!1,!1,{url:e,method:"GET"}).then((function(e){return t(e)}))},deleteUploadedZipFiles:function(e,t,a){if(e.length>0){var i=e.join(",");store.triggerAction("visions","delete_zips",{ids:i},null,"DELETE").then((function(e){var t=e.data_sets,a=[],i=t.length;for(let e=0;e<i;e++)"SUCCESS"===t[e].code&&t[e].details.id&&a.push(t[e].details.id)}),(()=>{commonUtils.showHideLoadingDiv(!1)}))}else commonUtils.showHideLoadingDiv(!1)},deleteVisionImages:function(e,t,a){var i=[];e.forEach((e=>{var t={};"grouped"===a&&(t.label={},t.label.id=void 0!==e.label_id?e.label_id:"",t.sub_config_type=void 0!==e.sub_config_type?e.sub_config_type:""),t.name=e.name,i.push(t)}));var n={images:i,type:a};return store.triggerAction("visions","delete_images",{id:t,delete_request_body:n})},getVisionImages:function(e,t,a,i,n){var r={group_operator:"or",group:[]};if(void 0!==t){var s={field:{api_name:"stage"},comparator:"in",value:t};r.group.push(s)}if(void 0!==a){s={field:{api_name:"label"},comparator:"in",value:a};r.group.push(s)}if(void 0!==i){s={field:{api_name:"created_time"},comparator:"between",value:i};r.group.push(s)}if(void 0!==n){s={field:{api_name:"source"},comparator:"in",value:n};r.group.push(s)}var l=encodeURIComponent(JSON.stringify(r));return store.triggerAction("visions","get_images",{id:e,filters:l})},getGalleryImages:function(e,t,a){var i=$L("crm-ziavision-snapshot")[0],n=this;store.triggerAction("visions","gallery_images",{config_id:e,label_id:t},null,"GET").then((function(e){!function(e){if(e=e.gallery_images){if(a)return a(e);var t=n.formatGalleryResponse(e);i.component.setData("gallery_images",t),$L("#galleryModal")[0].ltProp("show",!0)}}(e)})).catch((function(){_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.label.InternalServerError"),ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.button.okay.capitalized"),appearance:"default"}]}})}))},formatGalleryResponse:function(e){var t=[],a=0,i=e.length<10?e.length:9;for(a=0;a<i;a++){var n={};n.url=e[a].image_url,t.push(n)}return t},getTrainingLabels:function(e,t){if(void 0!==e.group&&e.group.length>0)t.concat(this.getTrainingLabels(e.group,t));else{if(!Array.isArray(e)){var a=e;(e=[]).push(a)}e.forEach((e=>{if(void 0!==e.group&&e.group.length>0)t.concat(this.getTrainingLabels(e.group,t));else{var a={};a.id=e.label.id,a.isDetected="${DETECTED}"===e.value,t.push(a)}}))}return t},addTrainingLabelName:function(e,t){e.forEach((e=>{var a=t.findIndex((t=>e.id===t.id));e.name=t[a].name}))},getMatchLabels:function(e){var t=[];return e.desired_set&&e.desired_set.labels.forEach((e=>{var a={};a.id=e.id,a.name=e.name,a.isDesired=!0,t.push(a)})),e.undesired_set&&e.undesired_set.labels.forEach((e=>{var a={};a.id=e.id,a.name=e.name,a.isDesired=!1,t.push(a)})),t},isTestRecordSuccess:function(e,t,a,i){var n=e.validation_type,r={},s=!1,l=!1;if(r.match=[],r.detect=[],"image_validation"===n||"match_detect"===n&&t){var d=t.positive.match.length>0?t.positive.match:t.negative.match,o=-1;d.forEach((e=>{if(o<80){o=e.confidence>=80?e.confidence:o;var t=a.findIndex((t=>t.id===e.id)),i=t>-1;(a[t].isDesired&&i&&o>=80||!a[t].isDesired&&!i||!a[t].isDesired&&i&&o<80)&&(s=!0)}}))}return"object_detection"!==n&&"match_detect"!==n||(i.forEach((e=>{var a=e,i=t[e.isDetected?"positive":"negative"],n=i.detect.findIndex((t=>e.id===t.id)),s=n>=0;a.isPresent=s;var l=!1;s&&i.detect[n].occurrences.forEach((e=>{e.confidence>=80&&(l=!0)})),a.has_good_confidence=l,r.detect.push(a)})),null!==e.training_details&&(l=this.criteria_validator(e.training_details.pattern_criteria,r,"and"))),"image_validation"===n?s:("object_detection"===n||s)&&l},criteria_validator:function(e,t,a){var i=[],n=!1;if(void 0!==e.group_operator&&(a=e.group_operator),void 0!==e.group)i.push(this.criteria_validator(e.group,t,a));else{if(!Array.isArray(e)){var r=e;(e=[]).push(r)}e.forEach((e=>{if("${DETECTED}"===e.value){var a=t.detect.findIndex((t=>t.id===e.label.id));t.detect[a].isPresent&&"${DETECTED}"===e.value&&t.detect[a].has_good_confidence?i.push(!0):i.push(!1)}}))}return 2===i.length?n="and"===a?!(!i[0]||!i[1]):!(!i[0]&&!i[1]):1===i.length&&(n=i[0]),n},processTrainingDataResponse:function(e){e=e.sort(((e,t)=>$L.moment(e.trained_time).toDate()>$L.moment(t.trained_time).toDate())),e=this.formatData(e);var t=[],a=$u.groupBy(e,"trained_time");Object.entries(a).forEach((([e,a])=>{var i=$u.groupBy(a,"source");Object.entries(i).forEach((([e,a])=>{if("upload"===e&&a.length>0){var i={source:"upload"};i.groups=a,i.group_key=a[0].trained_time,i.isSelected=!1,t.push(i)}if("suggestion"===e&&a.length>0){var n={source:"learning"};n.groups=a,n.group_key=a[0].trained_time,t.push(n)}}))}));var i=this.constructLabelListForTrainedImages(t);return{images:t,label_list:i}},formatData:function(e){var t=[];return e.forEach((e=>{var a={isSelected:!1};a.url=e.url,a.key=e.name,a.label_name=e.label.name,a.label_id=e.label.id,a.sub_config_type=e.sub_config_type,a.source=e.source,a.trained_time=CrmDateUtils.convertDateAndTimeApiFormatToUserViewFormat(e.created_time),a.trained_time=a.trained_time.slice(0,a.trained_time.length-9),t.push(a)})),t},groupBy:function(e,t){return e.reduce(((e,a)=>{const i=a[t];return e[i]||(e[i]=[]),e[i].push(a),e}),{})},addLabel:function(e,t){var a=t.length;for(let i=0;i<a;i++)if(t[i].name===e.name&&t[i].visionType===e.visionType)return;t.push(e)},processApprovedImagesResponse:function(e){var t=[];this.processAndSetSuggestionDet(e.images,t);var a=new Map,i=[];for(var n of t)if(!a.has(n.label_id)){a.set(n.label_id);var r={id:n.label_id,name:n.label_name,type:n.sub_config_type,source:n.source};i.push(r)}return{processed_response:t,label_arr:i}},constructLabelListForTrainedImages:function(e){var t=[];return e.forEach((e=>{e.groups.forEach((e=>{var a={};a.name=e.label_name,a.id=e.label_id,a.visionType=e.sub_config_type,this.addLabel(a,t),e.suggestion_details&&e.actual_inference&&e.actual_inference.forEach((e=>{var a={};a.name=e.label_details.label_occurences.label_name,a.id=e.label_details.label_occurences.label_id,a.visionType=e.sub_config_type,this.addLabel(a,t)}))}))})),t},trainingDataPagination:function(e,t,a,i){var n=0,r=i,s=0,l={};switch(t){case"trained":for(var d=[],o=e.length;0!==o&&r<o;){var c;c=0===n?20:Math.abs(20-n);var u=JSON.parse(JSON.stringify(e[r]));if(r===i&&u.groups.splice(0,a+1),u.groups.splice(c),n+=u.groups.length,d.push(u),s=a+u.groups.length,20===n)break;r++}l.reachedMax=r>=o,l.images=d,l.curr_image_index=s,l.curr_section_index=r<=0?0:r-1;break;case"approved":var g=JSON.parse(JSON.stringify(e));g.splice(0,a+1),g.splice(20);s=a+g.length;l.reachedMax=a>=e.length,l.images=g,l.curr_image_index=s;break;case"suggested":var _=JSON.parse(JSON.stringify(e));_.splice(0,a+1),_.splice(20);s=a+_.length;l.reachedMax=a>=e.length,l.images=_,l.curr_image_index=s}return l},getCountFromAPIResponse:function(e,t){var a={match:{desired_set:[],undesired_set:[],count:0},detect:{detected:[],not_detected:[],count:0},count:0},i={};i.gallery=Lyte.deepCopyObject(a),i.uploaded=Lyte.deepCopyObject(a),i.added_via_learning=Lyte.deepCopyObject(a),i.suggested={count:0};var n,r=0,s=0,l=0,d={};if(e.undesired_set&&e.undesired_set.labels.forEach((e=>{var t={};t.label_id=e.id,t.label_name=e.name,n=e.model_details.findIndex((e=>"upload"===e.type)),d=JSON.parse(JSON.stringify(t)),n<0?(n=e.model_details.findIndex((e=>"gallery"===e.type)),d.count=n>=0?e.model_details[n].count:0,i.gallery.match.undesired_set.push(d)):(r=n>=0?r+e.model_details[n].count:r+0,d.count=n>=0?e.model_details[n].count:0,i.uploaded.match.undesired_set.push(d)),n=e.model_details.findIndex((e=>"approved"===e.type));var a=JSON.parse(JSON.stringify(t));-1!==n&&(a.count=n>=0?e.model_details[n].count:0,i.added_via_learning.match.undesired_set.push(a)),s=n>=0?s+e.model_details[n].count:s+0,-1!==(n=e.model_details.findIndex((e=>"suggestion"===e.type)))&&(l=n>=0?l+e.model_details[n].count:l+0)})),e.desired_set&&e.desired_set.labels.forEach((e=>{var t={};t.label_id=e.id,t.label_name=e.name,n=e.model_details.findIndex((e=>"upload"===e.type)),d=JSON.parse(JSON.stringify(t)),n<0?(n=e.model_details.findIndex((e=>"gallery"===e.type)),d.count=n>=0?e.model_details[n].count:0,i.gallery.match.desired_set.push(d)):(r=n>=0?r+e.model_details[n].count:r+0,d.count=n>=0?e.model_details[n].count:0,i.uploaded.match.desired_set.push(d)),n=e.model_details.findIndex((e=>"approved"===e.type));var a=JSON.parse(JSON.stringify(t));-1!==n&&(a.count=n>=0?e.model_details[n].count:0,i.added_via_learning.match.desired_set.push(a)),s=n>=0?s+e.model_details[n].count:s+0,-1!==(n=e.model_details.findIndex((e=>"suggestion"===e.type)))&&(l=n>=0?l+e.model_details[n].count:l+0)})),e.training_details){var o=[];this.getLabelDetectedOrNot(e.training_details.pattern_criteria,o),e.training_details.labels.forEach((e=>{var t={};t.label_id=e.id,t.label_name=e.name;var a=o.findIndex((t=>t.label_id===e.id)),c=o[a];n=e.model_details.findIndex((e=>"upload"===e.type)),d=JSON.parse(JSON.stringify(t)),n<0?(n=e.model_details.findIndex((e=>"gallery"===e.type)),d.count=n>=0?e.model_details[n].count:0,i.gallery.detect[c?"detected":"not_detected"].push(d)):(r=n>=0?r+e.model_details[n].count:r+0,d.count=n>=0?e.model_details[n].count:0,i.uploaded.detect[c?"detected":"not_detected"].push(d)),n=e.model_details.findIndex((e=>"approved"===e.type));var u=JSON.parse(JSON.stringify(t));-1!==n&&(u.count=n>=0?e.model_details[n].count:0,i.added_via_learning.detect[c?"detected":"not_detected"].push(u)),s=n>=0?s+e.model_details[n].count:s+0,-1!==(n=e.model_details.findIndex((e=>"suggestion"===e.type)))&&(l=n>=0?l+e.model_details[n].count:l+0)}))}return i.count=t.total_image_count,t.image_types.forEach((e=>{"upload"===e.type&&(i.uploaded.count=e.count),"learning"===e.type&&(i.added_via_learning.count=e.count),"suggestion"===e.type&&(i.suggested.count=e.count)})),i.gallery.match.count=i.gallery.match.desired_set.length+i.gallery.match.undesired_set.length,i.gallery.detect.count=i.gallery.detect.detected.length+i.gallery.detect.not_detected.length,i.gallery.count=i.gallery.match.count+i.gallery.detect.count,i.uploaded.match.count=i.uploaded.match.desired_set.length+i.uploaded.match.undesired_set.length,i.uploaded.detect.count=i.uploaded.detect.detected.length+i.uploaded.detect.not_detected.length,i.added_via_learning.match.count=i.added_via_learning.match.desired_set.length+i.added_via_learning.match.undesired_set.length,i.added_via_learning.detect.count=i.added_via_learning.detect.detected.length+i.added_via_learning.detect.not_detected.length,i},processSuggestedImagesApiResponse:function(e){this.processAndSetSuggestionDet(e)},processAndSetSuggestionDet:function(e,t){e.forEach((e=>{var a={};if(e.suggestion_details&&e.suggestion_details.inference.length>0){var i=[];e.suggestion_details.inference.forEach((e=>{e.label_details.label_occurrences?e.label_details.label_occurrences.forEach((e=>{i.push({label_id:e.label_id,label_name:e.name,sub_config_type:"detect"})})):i.push({label_id:e.label_details.label_id,label_name:e.label_details.label_name,sub_config_type:"match"})})),i.forEach((e=>{var t=i.filter((t=>t.label_id===e.label_id));e.count=t.length}));var n=(i=[...new Map(i.map((e=>[e.label_id,e]))).values()]).filter((e=>"match"===e.sub_config_type)),r=i.filter((e=>"detect"===e.sub_config_type));e.suggestion_details.label_count={match_count:n.length,detect_count:r.length,label_details:i},t&&(a.suggestion_details=e.suggestion_details)}t&&(a.key=e.name,a.url=e.url,a.isSelected=!1,a.label_name=e.label.name,a.label_id=e.label.id,a.sub_config_type=e.sub_config_type,t.push(a))}))},getLabelDetectedOrNot:function(e,t){function a(e,t){var a={};a.label_id=e.label.id,a.detected="${DETECTED}"===e.value,t.push(a)}e.group_operator&&e.group?e.group.forEach((e=>{e.group?e.group.forEach((e=>{a(e,t)})):a(e,t)})):a(e,t)},getLabelNameVsModTypeArr:function(e){var t=[];return e.desired_set&&e.desired_set.labels&&e.desired_set.labels.length>0&&a(e.desired_set.labels,"match"),e.undesired_set&&e.undesired_set.labels&&e.undesired_set.labels.length>0&&a(e.undesired_set.labels,"match"),e.training_details&&e.training_details.labels&&e.training_details.labels.length>0&&a(e.training_details.labels,"detect"),t;function a(e,a){for(var i=e.length,n=0;n<i;n++)if(e[n].model_details&&"gallery"!==e[n].model_details[0].type){var r={},s=a.capitalize();r.name=e[n].name+"("+("Detect".includes(s)?I18n.getMsg("crm.zia.vision.detect"):I18n.getMsg("crm.zia.vision.match"))+")",r.value=e[n].id,t.push(r)}}},getGroupedLabelsWithHeaders:function(e,t){var a,i,n,r=[];return(a={}).name=I18n.getMsg("crm.zia.vision.all.images"),a.value="ALLIMAGES",(i=[]).push(a),(n={})[I18n.getMsg("crm.zia.vision.based.data")]=i,r.push(n),(a={}).name=I18n.getMsg("crm.zia.vision.trainingdata.all.custom.images"),a.value="ALLCUSTOMUPLOAD",(i=[]).push(a),t.forEach((e=>{i.push(e)})),(n={})[I18n.getMsg("crm.zia.vision.custom.upload")]=i,r.push(n),r},getLabelsForApproved:function(e,t){var a=[],i={};return i.name=I18n.getMsg("crm.zia.vision.all.images"),i.value="ALLIMAGES",a.push(i),t.forEach((e=>{a.push(e)})),a},constructPLForAddToLearn:function(e,t,a,i,n){var r={};r.name=t,r.labelling_details=a;var s=[];s.push(r),this.addImgToLearning(e,s,i,n)},addImgToLearning:function(e,t,a,i){return Lyte.resolvePromises({add_Image_to_learning:app.store.makeRequest("triggerAction","visions","add_Image_to_learning",{id:a,images:t})}).then((function(){var t=i.getData("curr_image_index"),a=i.getData("feedbackImages");Lyte.arrayUtils(a,"removeAt",t,1),i.setData("feedbackImages",a);var n=i.getData("totalResponse");Lyte.arrayUtils(n,"removeAt",t,1),i.setData("totalResponse",n);var r=i.getData("feedbackCount");r-=1,i.setData("feedbackCount",r),i.setData("approvedCount",i.getData("approvedCount")+e)}),(function(e){if(e){var t=JSON.parse(e.response);t.images[0]&&t.images[0].code&&"MAX_LIMIT_REACHED"===t.images[0].code?_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.zia.vision.suggestion.to.approve.error",300),ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.reports.integ.okay"),appearance:"default"}]}}):t.images[0]&&t.images[0].code&&"TRAINING_IN_PROGRESS"===t.images[0].code&&_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.zia.vision.model.inprogress.learn"),ltPropButtons:[{type:"accept",text:I18n.getMsg("crm.reports.integ.okay"),appearance:"default"}]}})}}))},setLabelFilter:function(e,t){if(void 0!==e){var a=t.findIndex((t=>t.value===e[0]));return this.setData("labelFilter",t[a].value),!0}return!1},getNoOfImagesSelected:function(e){for(var t=e?e.length:0,a=0,i=0;i<t;i++){e[i].isSelected&&(a+=1)}return a},createSelector:function(e,t){$L(e).selector({selections:t.getData("pre_selector_array"),onCreate:function(e){var a=document.createElement("span"),i=parseInt(e.classList[0].replace("lyteSelector",""))-1,n=t.getData("labelNameVsTagColor");e.classList.add(n[i].colorClass),n.length>0&&(a.setAttribute("class","vision_select_inputEle"),a.innerText=n[i].label),e.append(a)}})}});
