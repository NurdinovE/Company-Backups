Lyte.Mixin.register("crm-image-mixin",{changeUsedName:function(e,t){var i,a,r=this.getData("usedNames"),n=1,o=e,s=o.lastIndexOf(".");if(o=e.substring(0,s),void 0===t&&(t=e.substring(s,e.length)),!r.includes(e))return o+t;i=e.lastIndexOf("("),a=e.lastIndexOf(")");var d=e.substring(i+1,a);return 0!==Number(d)&&Number.isInteger(Number(d))?n=parseInt(d)+1:(i=-1,a=-1),-1!==i&&-1!==a&&(o=e.substring(0,i)),o+"("+n+")"+t},checkNameAvailability:function(e){return!!this.getData("usedNames").includes(e)},convertStreamToActualSize:function(e){var t,i,a,r,n,o,s;if(i=0,a="B",e>0){for(t=o=0,s=(n=["TB","GB","MB","KB","B"]).length;o<s;t=++o)if(r=n[t],e>=Math.pow(1024,4-t)){i=e/Math.pow(1024,4-t),a=r;break}i=Math.round(10*i)/10}return i+" "+a},convertAllFormatsToMBCount:function(e){var t,i=e;return-1!==e.indexOf("MB")?t=Number(i.substring(0,i.length-2)):-1!==e.indexOf("KB")?t=Number(i.substring(0,i.length-2))/1024:-1!==e.indexOf("B")&&(t=Number(i.substring(0,i.length-1))/1048576),t},setModifiedDetails:function(e,t,i,a){for(var r=this.getData("previewPageChanges"),n=r.length,o=0;o<n;o++)if(r[o].uploadid===e)return void 0!==t&&(r[o].name=t),void 0!==i&&(r[o].description=i),void(void 0!==a&&(r[o].encryptedUploadId=a));var s={};void 0!==t&&(s.name=t),void 0!==i&&(s.description=i),void 0!==a&&(s.encryptedUploadId=a),s.uploadid=e,s.fieldId=this.getData("fieldid"),r.push(s),this.setData("previewPageChanges",r)},retreiveNameData:function(e,t,i){for(var a=[].concat(this.getData("imageData")),r=a.length,n=0;n<r;n++)if(e===a[n].uploadid){if(void 0!==a[n].uploadedValues){var o=JSON.parse(a[n].uploadedValues);o.fileName=t,a[n].uploadedValues=JSON.stringify(o)}this.setModifiedDetails(e,t,void 0,void 0),a[n].filename=t;break}this.setData("imageData",a),i&&this.setData("imageView",a)},retreiveDescriptionData:function(e,t,i){for(var a=[].concat(this.getData("imageData")),r=a.length,n=0;n<r;n++)if(e===a[n].uploadid){if(void 0!==a[n].uploadedValues){var o=JSON.parse(a[n].uploadedValues);o.description=t,a[n].uploadedValues=JSON.stringify(o)}this.setModifiedDetails(e,void 0,t,void 0),a[n].description=t;break}this.setData("imageData",a),i&&this.setData("imageView",a)},retreiveCropData:function(e,t,i){for(var a=[].concat(this.getData("imageData")),r=a.length,n=this.getData("maxUploadedSize"),o=0;o<r;o++)if(e===a[o].uploadid){var s=this.convertStreamToActualSize(a[o].stream);void 0!==t.uploadedValues?(a[o]=t,a[o].encryptedUploadId=t.encryptedUploadId):(a[o].src=t.src,a[o].original_src=t.original_src,a[o].stream=t.stream,a[o].fileId=t.fileId,a[o].size=this.convertStreamToActualSize(t.stream)),this.setModifiedDetails(e,void 0,void 0,t.encryptedUploadId);var d=Number(n)-Number(this.convertAllFormatsToMBCount(s));n=d<0?0:d,n=Number(n)+Number(this.convertAllFormatsToMBCount(this.convertStreamToActualSize(t.stream)));break}this.setData("imageData",a),i&&this.setData({maxUploadedSize:n,barsize:n/20*100,imageView:a})},isInViewport:function(e){if(e){var t=$L(window).scrollTop(),i=renderingUtils.windowHeight,a=t+i,r=$L(e),n=r.offset().top,o=r.height(),s=n+o;return n>=t&&n<a||s>t&&s<=a||o>i&&n<=t&&s>=a}},fetchThumbnails:function(e,t){var i=this;return new Promise((function(a){t>e.length-1&&a(e),i.constructSizeMinimizedImage(e[t].original_src).then((function(r){e[t].src=r.url,i.fetchThumbnails(e,t+1).then((function(){a(e)}))}))}))},getMimeTypeFromExtn:function(e){switch(e){case".jpg":case".jpeg":return"image/jpeg";case".png":return"image/png";case".bmp":return"image/bmp";case".gif":return"image/gif"}},checkForFailedUploads:function(e){for(var t=e.length,i=!1,a=0;a<t;a++)if(!0===e[a].failed){i=!0;break}return i},constructImageUrl:function(e,t,i,a,r,n,o){if("processing"!==n&&"system_rejected"!==n&&"waiting_for_approval"!==n){var s=r.replace(/ /g,"+"),d=Crm.getCrmBasePath()+"/ViewImage?fileId="+e+"&module="+t+"&fieldId="+o+"&parentId="+i+"&id="+a+"&name="+encodeURIComponent(s)+"&downLoadMode=inline&skipPermission="+this.getData("skipPermission");return d=networkUtils.getPortalURL(d)}},constructSizeMinimizedImage:function(e){return new Promise((function(t){var i=new Image;i.addEventListener("load",(function(){var e=i.width,a=i.height;e>a?e>400&&(a*=400/e,e=400):a>300&&(e*=300/a,a=300);var r=document.createElement("canvas");r.width=e,r.height=a;var n=r.getContext("2d");n.imageSmoothingEnabled=!1,Lyte.injectResources([networkUtils.returnDependencyFiles(["exif-plugin.js"],ResourceConstants.CRMClient)],void 0,function(){$L.exif({target:i,getData:function(o){var s=o.exifdata.Orientation,d=$L(".temporaryImageOrientationCheck")[0];if(void 0!==d&&"from-image"!==getComputedStyle(d).imageOrientation)switch(s){default:n.drawImage(i,0,0,e,a);break;case 6:r.width=i.height,r.height=i.width,n.rotate(90*Math.PI/180),n.drawImage(i,0,-i.height);break;case 8:r.width=i.height,r.height=i.width,n.rotate(-90*Math.PI/180),n.drawImage(i,-i.width,0);break;case 3:r.width=i.width,r.height=i.height,n.rotate(Math.PI/180*180),n.drawImage(i,0,0,-i.width,-i.height)}else n.drawImage(i,0,0,e,a);n.drawImage(i,0,0,e,a);var u=r.toDataURL("image/jpeg");t({url:u,status:"ok"})}})}.bind(this))})),i.addEventListener("error",(function(){t({url:void 0,status:"ok"})})),i.src=e}))},rearrangeSequenceComplete:function(e){for(var t=this.getData("imageData"),i=t.length,a=e,r=a.length,n=1,o=this.getData("sequenceChanges"),s=0;s<r;s++)for(var d=a[s].id,u=0;u<i;u++)if(t[u].uploadid===d){if(t[u].sequence=n++,void 0!==t[u].uploadedValues){var l=JSON.parse(t[u].uploadedValues);l.sequence=t[u].sequence,t[u].uploadedValues=JSON.stringify(l)}else o[t[u].uploadid]=t[u].sequence;break}t.sort((function(e,t){return e.sequence-t.sequence}));for(s=0;s<i;s++)Lyte.arrayUtils(t,"replaceAt",s,t[s]);this.setData("sequenceChanges",o),this.getMethods("onImageSequenceChange")&&this.executeMethod("onImageSequenceChange",t)},fetchDeletedImageIdsPopup:function(e){for(var t=e.length,i=this.getData("tempRemovedIds"),a=i.length,r=this.getData("removedIds"),n=0;n<a;n++)for(var o=0;o<t;o++)if(e[o].uploadid===i[n]){r.push(i[n]);break}this.setData("removedIds",r)},fetchPreviewPageChangesPopup:function(e){if(void 0!==e&&e.length>0)for(var t=e.length,i=0;i<t;i++){var a,r,n;void 0!==e[i].name&&(a=e[i].name),void 0!==e[i].description&&(r=e[i].description),void 0!==e[i].encryptedUploadId&&(n=e[i].encryptedUploadId),this.setModifiedDetails(e[i].uploadid,a,r,n)}},sortImagesComplete:function(e){return e.sort((function(e,t){return e.sequence-t.sequence})),e},constructAPIRequestBody:function(){var e=[],t=this.getData("removedIds");if(t.length>0)for(var i=t.length,a=0;a<i;a++){(d={}).id=t[a],d._delete=null,e.push(d)}var r=this.getData("imageData"),n=this.getData("previewPageChanges"),o=n.length;if(r.length>0){var s=r.length;for(a=0;a<s;a++){var d={};void 0!==r[a].uploadedValues?d.Encrypted_Id=r[a].encryptedUploadId:d.id=r[a].uploadid,d.Sequence_Number=r[a].sequence;for(var u=0;u<o;u++)if(n[u].uploadid===r[a].uploadid){void 0!==n[u].name&&(d.File_Name=n[u].name),void 0!==n[u].description&&(d.Description=n[u].description),void 0!==n[u].encryptedUploadId&&(d.Encrypted_Id=n[u].encryptedUploadId);break}e.push(d)}}return e},addUsedImageNames:function(e,t){var i=[].concat(this.getData("usedNames"));void 0!==t&&i.removeLastOccurenceOfElement(t),i.includes(e)||i.push(e),this.setData("usedNames",i)},openFeaturePopup:function(e,t,i,a,r){if(null!==i&&"Image_Validation"===e.getData("parentFeature")){if("processing"===i)return void detailView.renderVisionErrorPopUp("image_processing",e.getData("module"),e.getData("entityId"),void 0,void 0,void 0,!0);if("waiting_for_approval"===i||"system_rejected"===i){var n=[];n=(n=(n=n.concat(networkUtils.returnDependencyFiles(["crm-vision-match-utils.js","crm-vision-create.js","crm-vision-validation.js","crm-image-upload-ziaError.js","crm-vision-helper.js"],ResourceConstants.CRMClient))).concat(networkUtils.returnDependencyFiles(["crm-image-upload-ziaError.css"],ResourceConstants.CRMClient))).concat(Crm.getVisionMyJobsDependency());var o=e.getData("apiName");o||(o=store.peekRecord("field",e.getData("fieldid")).api_name),Lyte.injectResources(n,void 0,function(){e.renderVisionErrorPopUpForOtherFields(r,!0,moduleRecordMapping[e.getData("module")].api_name,a,e.getData("entityId"),t,o,"system_rejected"===i?"do_not_create":void 0)}.bind(e))}}}}),Lyte.Component.registerHelper("renderNameToolTip",(function(e){if(e){var t=e.substring(0,e.lastIndexOf(".")),i=e.substring(e.lastIndexOf("."),e.length);return Crm.userDetails.RTL_ENABLED?i.substring(1,i.length)+"."+t:t+i}return e})),Lyte.Component.registerHelper("getNameHeadFromFileName",(function(e){return void 0!==e?-1!==e.lastIndexOf(".")?e.substring(0,e.lastIndexOf(".")):e.substring(0,e.length-1):e})),Lyte.Component.registerHelper("getExtnFromFileName",(function(e){return e.substring(e.lastIndexOf("."),e.length)}));
