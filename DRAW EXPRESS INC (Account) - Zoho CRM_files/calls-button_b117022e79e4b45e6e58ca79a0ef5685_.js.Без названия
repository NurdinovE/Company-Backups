Lyte.Component.register("call-button-new",{_template:'<template tag-name="call-button-new" class="ZPBListnerCls"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(from,\'===\',&quot;canvas&quot;),\'&amp;&amp;\',phoneNumbers),\'&amp;&amp;\',expHandlers(expHandlers(noOfKeys(phoneNumbers),\'<=\',0),\'||\',expHandlers(pbServiceName,\'!\')))}}"><template case="true"> <lyte-button lt-prop-disabled="true" onmouseover="{{action(\'checkDisableBtn\',this)}}" onmouseout="{{action(\'newhidett\')}}"> <template is="registerYield" yield-name="text">{{getI18n(\'Call\')}}</template> </lyte-button> </template><template case="false"><template is="if" value="{{expHandlers(phoneNumbers,\'&amp;&amp;\',expHandlers(expHandlers(pbServiceName,\'===\',&quot;ZPB&quot;),\'||\',expHandlers(pbServiceName,\'===\',&quot;CRM_TELEPHONY&quot;)))}}"><template case="true"><template is="if" value="{{expHandlers(noOfKeys(phoneNumbers),\'==\',1)}}"><template case="true"> <lyte-button lt-prop-appearance="primary" data-zcqa="Call" onclick="{{action(\'initiateCall\',getFirstValueOfJson(phoneNumbers),if(generateNewCall,\'\',callEntityId))}}"> <template is="registerYield" yield-name="text"> {{getI18n(\'Call\')}} </template> </lyte-button> </template><template case="false"><template is="if" value="{{expHandlers(noOfKeys(phoneNumbers),\'>\',1)}}"><template case="true"> <lyte-button lt-prop-appearance="primary" id="callBtnForMultipleNos_{{callEntityId}}" data-zcqa="Call"> <template is="registerYield" yield-name="text"> {{getI18n(\'Call\')}} </template> </lyte-button> <lyte-menu lt-prop-yield="true" id="phoneNosList_{{callEntityId}}" lt-prop-callout="true" lt-prop-event="click" lt-prop-query="{{if(menuorigin,menuorigin,expHandlers(&quot;#callBtnForMultipleNos_&quot;,\'+\',callEntityId))}}"> <template is="registerYield" yield-name="yield"> <lyte-menu-body> <template is="forIn" object="{{phoneNumbers}}" value="value" key="key"> <lyte-menu-item data-zcqa="Call_{{value}}" onclick="{{action(\'initiateCall\',value,if(generateNewCall,\'\',callEntityId))}}"> <lyte-menu-label> {{value}}  <lyte-menu-description> {{key}} </lyte-menu-description> </lyte-menu-label></lyte-menu-item> </template> </lyte-menu-body> </template> </lyte-menu> </template></template></template></template></template></template></template></template> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[0]}]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"forIn",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,1]},{type:"text",position:[1,1,3,1]},{type:"componentDynamic",position:[1,1,3]},{type:"componentDynamic",position:[1,1]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[3]}]}},default:{}}]}},default:{}}]}},default:{}}]}},default:{}}],_observedAttributes:["callEntityId","whoId","whoModule","entityName","phoneNumbers","generateNewCall","pbServiceName","hasData","isFromCanvas","record","callrecord","from"],init:function(){this.getData("hasData")||this.loadCallData()},data:function(){return{callEntityId:Lyte.attr("string"),whoId:Lyte.attr("string"),whoModule:Lyte.attr("string"),entityName:Lyte.attr("string"),phoneNumbers:Lyte.attr("object",{default:{}}),generateNewCall:Lyte.attr("boolean",{default:!0}),pbServiceName:Lyte.attr("string"),hasData:Lyte.attr("boolean",{default:!1}),isFromCanvas:Lyte.attr("boolean",{default:!1}),record:Lyte.attr("object",{watch:!0}),callrecord:Lyte.attr("object",{watch:!0}),from:Lyte.attr("string")}},actions:{initiateCall:function(e,t){var a=this.getData("pbServiceName"),i=this.getData("whoModule");if(i="PhoneNumbers"!==i?i:"Unknown","ZPB"===a)crmCallsNew.initiateCallViaZPB(e,this.getData("whoId"),i,this.getData("entityName"),t);else if("CRM_TELEPHONY"===a){var r=Lyte.Component.registeredHelpers.getUserDetail("ZGID"),o=Lyte.Component.registeredHelpers.getUserDetail("USER_ID");ctiApiNotifier.click2Call(e,r,o,this.getData("whoId"),t,i,this.getData("entityName"))}},checkDisableBtn:function(e,t,a){CrmDetailViewHandler.prototype.disableBtnMsg(e,t,a)},newhidett:function(){newhidett()}},loadCallData:function(){var e=this.getData("module");if("Calls"===e||"Leads"===e||"Contacts"===e){var t=this.getData("recordId"),a=store.peekRecord(moduleRecordMapping[e].id,t);if("Calls"===e){"Calls"!==e||this.getData("record")||this.setData("record",a);var i=this.setAndReturnRelatedRecordProm(a,"Calls");i&&Lyte.resolvePromises(i).then(function(t){(a=t[0])&&this.isConsentAvailable(a)&&this.processCallBtnWithLR(a,e)}.bind(this))}else this.setData("whoModule",e),this.setData("whoId",t),this.setData("record",a),this.isConsentAvailable(a)&&this.processCallBtnWithLR(a,e)}},isConsentAvailable:function(e){return!(e.Data_Processing_Basis_Details&&!e.Data_Processing_Basis_Details.Contact_Through_Phone)},getModuleData:function(e){return store.findRecord("module",moduleRecordMapping[e].id,void 0,void 0,void 0,{allowMultiple:!0})},getDefaultLayoutId:function(e){if(moduleRecordMapping[e].layouts){var t=moduleRecordMapping[e].layouts[0];return moduleRecordMapping[e].layouts.length>1&&(t=moduleRecordMapping[e].layouts.filter((function(e){return"system"===e.generated_type}))[0]),t.id}},processCallBtnWithLR:function(e,t){var a=this.getData("whoModule");a="PhoneNumbers"===a?"Calls":a;var i=e.Layout?e.Layout.id:this.getDefaultLayoutId(a);i||(i=this.getModuleData(a).then((function(){var e=moduleRecordMapping[a].layouts[0];return moduleRecordMapping[a].layouts.length>1&&(e=moduleRecordMapping[a].layouts.filter((function(e){return"system"===e.generated_type}))[0]),e.id}))),Lyte.resolvePromises([i]).then(function(i){var r=i[0];if(void 0!==a){var o,s={layoutId:r,moduleSet:!0,peekField:!1,from:"CallBtn"},n=[],l={};if(!this.getData("isLayoutDetailsFetched_"+a)&&("Calls"===t&&Crm.renderDVLyteFlow("Calls")?(Lyte.triggerEvent("detail_view_trigger_request_listener_"+this.data.unique_listener_id,{case:"activity_rel_module_layout",requests:l,module:a,record:this.getData("record")}),o=l.layoutReq):o=Crm.renderDVLyteFlow(t)&&moduleRecordMapping[a]&&moduleRecordMapping[a].fields&&moduleRecordMapping[a].layouts?[moduleRecordMapping[a]]:o=store.findRecord("module",moduleRecordMapping[a].id,{include_inner_details:"lookup.query_details.criteria"},void 0,!0,s),n.push(o),void 0===Crm.userDetails.LAYOUTRULEAVAILABLE||!0===Crm.userDetails.LAYOUTRULEAVAILABLE&&Crm.userDetails.LRINVOLVEDMODULES.contains(a))){var d=store.peekAll("layout_rule"),c=[],u={};d&&d.forEach((function(e){e.layout&&e.layout.id===r&&c.push(e)})),u.layout_rule=c,0===c.length&&(u=store.findAll("layout_rule",{module:a},!1,!1,r)),n.push(u)}Lyte.resolvePromises(n).then(function(t){var i=e,o=this.getData("layout_"+a);o||(o=t[0][0].layouts.filter((function(e){return e.id===r}))[0]);var s={};s["layout_"+a]=o,s["isLayoutDetailsFetched_"+a]=!0,this.setData(s);var n=this.getData("layoutRules_"+a)?this.getData("layoutRules_"+a):t[1]?t[1].layout_rule:void 0;n&&(this.setData("layoutRules_"+a,n),n&&Lyte.registeredMixins["crm-detailview-parser"].processOneLayoutRules(o,n,i,"view")),this.showHideCallBtn(i,o)}.bind(this))}}.bind(this))},showHideCallBtn:function(e,t){var a={},i=[],r=this.isConsentAvailable(e),o=this.getData("whoModule"),s=this;t.sections.forEach((function(e){if(!e.isHiddenInLR){var t=e.fields.filter((function(e){return!(33!==e.ui_type||!e.view_type.view)}));if("PhoneNumbers"===o){var a=s.getData("isOutboundCall")?"To_Number__s":"From_Number__s";t=t.filter((function(e){return e.api_name===a}))}i=i.concat(t)}})),i.forEach((function(t){e[t.api_name]&&(a[t.field_label]=e[t.api_name])}));var n=!1;if(r){this.setData("phoneNumbers",a);var l=Lyte.Component.registeredHelpers.whichPBService();this.setData("pbServiceName",l),Object.keys(a).length&&(n=!0)}for(var d=$(".ZPBcallListener"),c=d.length,u=0;u<c;u++)d[u].component&&d[u].component.setData("callBtRendered",n)},setAndReturnRelatedRecordProm:function(e,t){var a,i,r;if(e.Who_Id)r=e.Who_Id.id,i="Contacts",a=e.Who_Id.name;else if(e.What_Id)r=e.What_Id.id,i=e.$se_module,a=e.What_Id.name;else{if(e.$phone_number&&!Crm.userDetails.CALLS_PREFERENCE){this.setData("whoModule","PhoneNumbers");var o={};o.phoneNumber=e.$phone_number,this.setData("phoneNumbers",o);var s=Lyte.Component.registeredHelpers.whichPBService();return void this.setData("pbServiceName",s)}if(!Crm.userDetails.CALLS_PREFERENCE)return}if(Lyte.Component.registeredHelpers.hasCallSupportedModules(i)||"Calls"===t){this.setData("callEntityId",this.getData("recordId"));var n,l,d,c=this.getCallStatus(e);if("Scheduled"!==c&&"Overdue"!==c||this.setData("generateNewCall",!1),this.setData("entityName",a),this.setData("whoModule",i),this.setData("whoId",r),d="canvas"===this.getData("from")||Crm.renderDVLyteFlow(moduleApiMapping.Calls)?"Outbound"===Lyte.registeredMixins["crm-detailview-common-utils"].getCallType(e):this.isOutboundCall(e.Call_Type),this.setData("isOutboundCall",d),d?(n=e.To_Number__s,l=!this.checkFieldPermission("To_Number__s")):(n=e.From_Number__s,l=!this.checkFieldPermission("From_Number__s")),!l||!Crm.userDetails.CALLS_PREFERENCE){if(n){this.setData("whoModule","PhoneNumbers");s=Lyte.Component.registeredHelpers.whichPBService();return this.setData("pbServiceName",s),[store.peekRecord(moduleRecordMapping.Calls.id,this.getData("callEntityId"))]}if(i)return store.modelFor(moduleRecordMapping[i].id)||store.registerModel(moduleRecordMapping[i].id,{},{extends:"entity"}),this.getData("isLayoutDetailsFetched_"+i)?[store.peekRecord(moduleRecordMapping[i].id,r)]:store.findRecord(moduleRecordMapping[i].id,r);this.setData("phoneNumbers",{})}}},checkFieldPermission:function(e){var t=moduleRecordMapping.Calls.fields.find((t=>t.api_name===e)),a=!1;return t&&(a=t.visible),a},getCallStatus:function(e){var t;Crm.renderDVLyteFlow(moduleApiMapping.Calls)||(t=returnJson.business_card_meta[0].sections[0].fields);return Lyte.registeredMixins["crm-entity-utils"].getCallStatus(e,t)},isOutboundCall:function(e){var t=returnJson.business_card_meta[0].sections[0].fields,a=e;return t.forEach((function(t){"Call_Type"===t.api_name&&t.pick_list_values.forEach((function(t){t.display_value===e&&(a=t.actual_value)}))})),"Outbound"===a},changeCallBt:function(){if(null===this.$node||!returnJson)return!1;("Calls"!==this.getData("module")||Crm.userDetails.CALLS_PREFERENCE)&&this.loadCallData()}.observes("record.*")}),Lyte.Component.registerHelper("enableCallBtn",(function(){var e=this;return Lyte.Component.registeredHelpers.whichPBService()&&CTIAPI.zpbCallback.successLoaded?(this.setData("showCallNowButton",!0),!0):(CTIAPI.zpbCallback.succListeners.push((function(){e.setData("showCallNowButton",!0)})),!1)})),Lyte.Mixin.register("crm-detailview-parser",{afterModelHandler:function(e){if(e.converted_detail)return void 0!==e.converted_detail[0].Converted_Account&&(e.accountObj=e.converted_detail[0].Converted_Account),void 0!==e.converted_detail[0].Converted_Contact&&(e.contactObj=e.converted_detail[0].Converted_Contact),void 0!==e.converted_detail[0].Converted_Deal&&(e.dealObj=e.converted_detail[0].Converted_Deal),void("Leads"===e.module?(e.Leads=e.converted_detail[0],e.singularModName=moduleRecordMapping.Leads.singular_label,e.acntsingularModName=moduleRecordMapping.Accounts.singular_label,e.cntsingularModName=moduleRecordMapping.Contacts.singular_label,e.dealsingularModName=moduleRecordMapping.Deals.singular_label,e.fromConvertAction=!1,e.converted=!0,e.detailview_page=!0):(e.Leads=e.converted_detail[0],e.singularModName=moduleRecordMapping[e.module].singular_label,e.linkingObj=e.converted_detail[0].$converted_detail,e.linkingMoodulesingularModName=moduleRecordMapping[e.converted_detail[0].$converted_detail.module].singular_label,e.linkingMoodulepurlModName=moduleRecordMapping[e.converted_detail[0].$converted_detail.module].plural_label,e.fromConvertAction=!1,e.converted=!0,e.detailview_page=!0));if(e.validationRule){var t=e.validationRule,a=t.length,i={};for(let e=0;e<a;e++){var r=t[e];r.field_validation&&(i[r.field.api_name]=r.id)}e.fieldValidationDet=i}if(e.messages)return validationUtils.isEmpty(e.messages)&&(this.model.messages.error=!0),e.module="Messages",e.transitionData=objectUtils.cloneObject(this.transition.data),e.transitionData.recordId=this.transition.info.dynamicParams[1],this.constructComponentJson(e),void commonUtils.showHideLoadingDiv(!0);"Meetings"===e.module&&(e.module="Events"),e.transitionData=objectUtils.cloneObject(this.transition.data),void 0!==this.getQueryParams().sub_module&&"Activities"===e.module&&(e.parent_module=e.module,e.module=this.getQueryParams().sub_module),e.related_list||(e.related_list=[]),e.record=store.peekRecord(moduleRecordMapping[e.module].id,e.entId),e.detailview_buttons?e.detailview_buttons.actions.forEach((function(t){"portal_user_preference"===t.name&&(e.portalsUserTypeId=t.details.user_type.id)})):e.detailview_buttons={};var o=e.record.id+"_"+Math.floor(100*Math.random())+1;e.unique_listener_id=o;var s,n=store.peekRecord("module",moduleRecordMapping[e.module].id);e.module_sysrefname=n.api_name,s=e.record.$layout_id?e.record.$layout_id.id:e.record.Layout?e.record.Layout.id:n.layouts[0].id,e.layoutId=s,e.layout=e.layout_response[0].layouts.filter((function(t){return t.id===e.layoutId})),e.layout=e.layout[0],e.currentInstObjKey=this.getDynamicCurrentInstanceObjKey({actionName:"dv_lyte"});var l=Lyte.registeredMixins["crm-create-init-mixin"];l&&e.currentInstObjKey&&l.generateCurrentInstanceObject({instanceObjKey:e.currentInstObjKey,moduleData:n,moduleSections:e.layout.sections,moduleFields:n.fields}),e.cscript_properties={},this.constructComponentJson(e);var d=e.layoutRule;if("Calls"===e.module&&d&&Lyte.registeredMixins["crm-call-form-mixin"].removeMandatoryFromLayoutRules(d.layout_rule,"Who_Id"),d&&d.layout_rule){for(var c=d.layout_rule.length,u=0;u<c;u++)d.layout_rule[u].id=e.layoutId+"_"+u,d.layout_rule[u].layout=e.layoutId;store.pushPayload("layout_rule",d.layout_rule)}e.layout_rule=d,e.rules_execution_result={lr_exec_result:{}},this.data||(this.data={}),this.data.currentInstObjKey=e.currentInstObjKey,this.execute_layoutRules(e.record,e,this);var p=this.transition.data.affected_data;if(delete this.transition.data.affected_data,!1===Lyte.Router.history.fromHistory&&p){var _=e.tobe_highlighted_fields,m=e.content_json.meta_info.fieldAPINameVsIdMap,f=Math.floor(1e4*Math.random());for(let e in p[0])!m[e]||116!==m[e][1]&&118!==m[e][1]||Lyte.objectUtils(_,"add",e,f);e.tobe_highlighted_fields=_,setTimeout(this.removeHighlightedFields,5e3,f)}var v=this.fetchFilesForRenderingUsingData(e,moduleRecordMapping[e.module].related_lists);return Lyte.resolvePromises({filesResolved:Lyte.injectResources(v)})},constructComponentJson:function(e){var t=e.module;if(this.formHeaderData(e),e.messages)return this.parseBusinessCardFieldsForMessages(e),void this.formRightPanelData(e,t);"Events"!==e.sub_module&&this.parseBusinessCardFields(e,t),this.parseRecordActions(e,t),this.parseContentJson(e),this.populateLeftPanelInfo(e),this.formRightPanelData(e,t)},formRightPanelData:function(e,t){if("Activities"===Crm.activityGrp[t]){e.show_right_panel=!0;var a={};if(l=e.record.Who_Id?e.record.Who_Id:e.record.What_Id){var i=e.record.Who_Id&&e.record.Who_Id.id?crmModuleConstants.Contacts:moduleApiVsNameMapping[e.record.$se_module];this.populateRPShowInfo(a,i,t)}else e.show_right_panel=!1;var r=[];if(l){var o=l;o.record_module=i,r.push(o)}if(e.record.Who_Id&&e.record.What_Id){var s=e.record.What_Id;s.record_module=moduleApiVsNameMapping[e.record.$se_module],r.push(s)}if(e.record.$in_project_sync){var n={};n.id=e.record.id,n.name=I18n.getMsg("crm.project.integration.title"),n.record_module=moduleRecordMapping.Projects.module_name,r.push(n)}this.populateRPInfoModel(l,i,a,e,r)}if("Messages"===t){e.show_right_panel=!0;var l;a={};if(l=e.messages.record.sender){i=e.messages.record.sender?moduleApiVsNameMapping[e.messages.record.semodule]:crmModuleConstants.Contacts;this.populateRPShowInfo(a,i,t)}this.populateRPInfoModel(l,i,a,e)}},populateRPInfoModel:function(e,t,a,i,r){var o={};o.entity_name=e?e.name:void 0,o.rel_record_id=e?e.id:void 0,o.module=e?t:void 0,i.right_panel_info={},i.right_panel_info.module=t,i.right_panel_info.record_info=o,i.right_panel_info.show_info=a,r&&(i.right_panel_info.rp_records=r)},populateRPShowInfo:function(e,t,a){t===crmModuleConstants.Leads||t===crmModuleConstants.Contacts?(e.show_conversation_tab=!0,"Activities"!==Crm.activityGrp[a]&&(e.show_timeline_tab=!0)):t&&"Projects"!==t&&"Activities"!==Crm.activityGrp[a]&&(e.show_timeline_tab=!0),e.show_info_tab=!0},formHeaderData:function(e){e.header_model={}},formNavigationData:function(e,t){var a={};return a.id=e.recordId,a.recordNum=e.recordNum,a.cvid=e.cvid,a.userId=Crm.userDetails.USER_ID,a.module=t,a.fromIndex=e.FROM_INDEX,a.toIndex=e.TO_INDEX,e&&e.stageId&&(a.stageId=e.stageId),this.appendActivityNavigationData(t,a),JSON.stringify(a)},appendActivityNavigationData:function(e,t){"Activities"===Crm.activityGrp[e]&&("Activities"===e||(t.fromActSubModuleListView="true"),t.fromActivityListView="true",t.fromDetailView=!0)},parseContentJson:function(e){e.user_id=Crm.userDetails.USER_ID;var t,a,i,r,o,s=e.layout,n=e.layoutId,l=e.record,d=e.module,c=moduleRecordMapping[d],u=e.cscript_properties?e.cscript_properties:{},p=[],_=[],m=[],f=[],v={},h={},g={},y={},b={},C={},I={},D={},L={},R={},E={},w={},A={};this.populatePickListOptionsAsMapDependency(s.sections,l,n,h,R,A,E,w);var k=this.populateLockingInfo(e,c),M=s.sections;this.generateCurrentInstanceObject({instanceObjKey:e.currentInstObjKey,moduleSections:M});var N=M.length,S=!1,F=0,T=0,P=0,O=document.createElement("canvas"),x=getComputedStyle(document.querySelector(":root")),j=O.getContext("2d");j.font=`1.4rem ${x.getPropertyValue("--crm-font-regular")}`;var U=Lyte.Router.getRouteInstance().transition&&Lyte.Router.getRouteInstance().transition.isRequesterDV;if(e.record.$process_flow){var V=$L("crm-blueprint-layer");void 0!==e.blueprint_exec_info?this.blueprintFldId=e.blueprint_exec_info.blueprint.process_info.field_id:V.length>0&&(this.blueprintFldId=V[0].getData("processInfo").field.id),y[this.blueprintFldId]=I18n.getMsg("blueprint.field.lock.tooltip")}for(var Y=0;Y<N;Y++){var B=M[Y];if("used"===B.type){if("default"===B.generated_type){if("Record Image"===B.name){B.fields&&B.fields[0]&&(e.header_model.isProfileImageAccessible=!!B.fields[0].visible&&B.fields[0].visible,e.header_model.isProfileImageReadOnly=B.fields[0].read_only);continue}if("Quick create"===B.name||"Business Card"===B.name)continue;if(this.isSkipableDefaultSection(d,B,l))continue}B.contId=this.getSectionNameWithoutSpace(B.name);var $,q=2===B.column_count,H=[],W=[],Z=B.fields;$=n+"_"+B.id,this.sectionFldKey=$,Z=Z.sort(function(e,t){return e[this.sectionFldKey].sequence_number-t[this.sectionFldKey].sequence_number}.bind(this)),delete this.sectionFldKey;for(var J=!1,K=Z.length,z=0,G=0;G<K;G++){var Q=Z[G];if(!B.isSubformSection||(!J&&"SERIAL_NUMBER"!==Q.column_name&&!Q.subform&&Q.visible&&Q.view_type.view&&(J=!0),Q.subform)){var X=objectUtils.cloneObject(Q);if(this.populateFieldAttributes(Q,X,"view",d,l),this.populateCsriptPropInToField(X,u,v,y),"STAGE"===Q.column_name&&(i=!0,m=Q[n]&&Q[n].pick_list_values&&Q[n].pick_list_values.length?Q[n].pick_list_values:[]),"PIPELINE"===Q.column_name&&(r=!0,Q[n]&&Q[n].pick_list_values&&Q[n].pick_list_values.length)){var ee=Q[n].pick_list_values.filter((function(e){if(e.display_value===l.Pipeline)return e}));ee.length&&ee[0].maps&&ee[0].maps.length&&(f=ee[0].maps[0].pick_list_values)}if("CTIVOICEURL"===Q.column_name&&"Calls"===d&&(X.preview=!0),Crm.userDetails.IS_SMART_PROMPT_AVAILABLE&&Lyte.registeredMixins.smart_prompt_handler.detailLyteFieldCheck(d,Q.column_name,Q,l)&&(b[Q.api_name]=!0),S||"Segment_Label"!==Q.api_name||13!==Q.show_type||(S=!0),this.populateFOL(Q,L),this.getDefaultCriteriaForLookupField(C,d,Q,l),this.getRelatedRecordInfoForLookup(I,D,Q,l,R,A),h[Q.api_name]&&0!==h[Q.api_name].length||!Q[n]||!Q[n].pick_list_values||(h[Q.api_name]=Q[n].pick_list_values),Q.pick_list_values&&Q.pick_list_values.length>0){var te=this.checkAndAppendOptionToPicklist(l[Q.api_name],h[Q.api_name],Q);h[Q.api_name]=te}if(Q.colour_code_enabled&&"Events"===d&&Crm.calPreferences.USERCOLOURCODE&&(h[Q.api_name].forEach((function(e){Crm.calPreferences.USERCOLOURCODE[e.id]&&(e.colour_code=Crm.calPreferences.USERCOLOURCODE[e.id])})),X.pick_list_values.forEach((function(e){Crm.calPreferences.USERCOLOURCODE[e.id]&&(e.colour_code=Crm.calPreferences.USERCOLOURCODE[e.id])}))),Q.lookup&&Q.lookup.query_details){var ae=Q.lookup.query_details,ie={};ie.query_id=ae.query_id,g[Q.api_name]=JSON.stringify(ie)}if("CLOSINGDATE"===Q.column_name&&Q.read_only&&(o=!0),"CURRENCYISOCODE"===Q.column_name&&(t=Q.api_name),"EXCHANGERATE"===Q.column_name&&(a=Q.api_name),Q.ui_type!==CrmField.UITYPES.TAGS||U||(e.header_model.tag_supported_mod=!0),this.isViewableField(Q,d,l)){z++;var re=this.getDVFieldLabelWidthColumnWise(Q.field_label,j);if(q&&(Q[$].sequence_number+1)%2==1?(W.push(X),re>P&&(P=re)):(H.push(X),re>T&&(T=re)),this.showLock_supported_fields[e.module]&&this.showLock_supported_fields[e.module].contains(Q.column_name))v[Q.api_name]="showLock";else if(this.isAjaxEditableField(X,d,l)||X.read_only){var oe=this.handleMouseActions(X,l,e.module,s.id,k);v[Q.api_name]=oe}X[n]&&X[n].required&&(X[n].isLayoutConfigLevelMandatory=!0)}else{var se=this.handleMouseActions(Q,l,e.module,s.id,k);this.handleNonViewAbleField(e,X,v,se)}}}if(!B.isSubformSection||J){var ne=[];ne.push(H),q&&ne.push(W),(H.length||W.length)&&(B.detailviewColumns=ne,F>100?_.push(B):p.push(B),F+=z)}}}if(r&&m.length&&f.length&&(f=this.getStages(f,m)),0!==e.header_model.title_card_fields.length){var le=Lyte.Component.registeredHelpers.getFieldViewValue(e.header_model.title_card_fields[0],l,d,!0);le&&"multi_module_lookup"===e.header_model.title_card_fields[0].data_type&&(le=le.name),e.entity_name=le}var de={};de.currency_apiname=t,de.exchangerate_apiname=a,de.show_strip=i,de.pipeline_enabled=r,de.stage_object={},de.stage_object.record_stages=r?f:m,de.stage_object.closing_date_readonly=o,de.fieldvsEditType=v,de.fieldvsOptions=h,de.fieldvsQuery=g,de.fieldvsdefaultCriteria=C,de.folFieldDetails=L,de.fieldColumnNameMap=R,de.moduleVsLookupFields=A,de.fieldAPINameVsIdMap=E,de.fieldVsRelatedRecInfo=I,de.fieldVsRelatedRecords=D,de.subordinate_listing_needed=!0===Crm.userDetails.permissions.Crm_Implied_List_Subordinate_Users,de.isSegmentAvailable=S,de.fieldVsTooltip=y,de.smart_prompt_field=b,de.phone_new_view=Crm.userDetails.isPhoneNoNewView,de.ziaOwnerRecommendationEnabled=e.ziaOwnerRecommendationEnabled,e.tobe_highlighted_fields=w;var ce=void 0!==e.transitionData&&e.transitionData.kafkaWFData,ue=!1;ce&&(ue=ce.refreshInWms);var pe={};pe.show_business_card=s.show_business_card&&!d.startsWith("Orchestration")&&!0==!d.startsWith("PathFinder"),e.nobcFieldsVisible&&(pe.show_business_card=!1),pe.show_section_info=!ue&&!0===Crm.userDetails.CUSTOMIZE_INFO.show_detail_view,pe.show_timeline_tab=!ue&&!Crm.userDetails.CLIENT_ACCOUNT,pe.show_data_privacy_tab=!ue&&this.canWeShowDataPrivacyTab(e.detailview_buttons?e.detailview_buttons.actions:[]),pe.show_tab_header=!ue&&!U;var _e=Crm.userDetails.LICENSE_TYPE,me={};me.premium_user="U"===_e||"A"===_e||"E"===_e||"C"===_e||"Z"===_e,c.presence_sub_menu&&!0===c.visible&&"linking"!==c.generated_type&&this.zia_unsupported_modules.indexOf(d)<0&&(me.prediction_supported=!0,me.churn_supported=!0,me.recommend_supported=!0,"Leads"!==d&&"Potentials"!==d&&"Deals"!==d||(me.zia_score_supported=!0),"Potentials"!==d&&"Deals"!==d&&"Leads"!==d||(me.nba_supported=!0),!Crm.userDetails.isBestTimeEnabled||"Leads"!==d&&"Contacts"!==d&&"Deals"!==d&&"Potentials"!==d||-1!==this.best_time_unsupported_status.indexOf(l.$approval_state)||(me.best_time_supported=!0),(d===moduleRecordMapping.Leads.module_name||d===moduleRecordMapping.Contacts.module_name||moduleRecordMapping.Calls&&d===moduleRecordMapping.Calls.module_name)&&(me.zia_call_analytics_supported=!0),"Leads"!==d&&"Contacts"!==d||!moduleRecordMapping[d].isCompetitorMentionEnabled||(me.competitor_mentions_supported=!0));var fe={isKioskAssocLimitReached:!1},ve={};void 0!==e.approval_process_data&&(ve.approval_state=e.record.$approval_state,ve.showRespondLink=e.record.$approval.approve,ve.delegateDeactivate=e.record.$approval.delegate,ve.hasresubmitLink=e.record.$approval.resubmit,ve=this.constructApprovalDetails(e));var he=this.constructReviewDetails(e),ge=p.length>=1?p:_;ge.length>=1&&void 0!==e.review_process_data&&this.constructFieldIndexing(he,ge);var ye={};ye.viewable_sections=p,ye.columnwise_fld_width=[T,P],ye.after_render_sections=_,ye.show_info=pe,ye.meta_info=de,ye.zia_info=me,ye.kiosk_info=fe,ye.recordLockingDetails=k,ye.approvalProcessDetails=ve,ye.reviewProcessDetails=he,e.content_json=ye},populateCsriptPropInToField:function(e,t,a,i){if(t&&t[e.api_name])for(var r=t[e.api_name],o=Object.keys(r),s=o.length,n=0;n<s;n++){var l=o[n];switch(l){case"tooltip":e.tooltip||(e.tooltip={}),e.tooltip.name=r[l].name,e.tooltip.value=r[l].value;break;case"masking_info":a&&!a[e.api_name]&&(a[e.api_name]="showEmpty");break;case"value_tooltip":i&&!i[e.id]&&(i[e.id]=r[l]);break;case"length":case"read_only":e[l]=r[l]}}},isSkipableDefaultSection:function(e,t,a){switch(e){case"Events":if("Event Quick View"===t.name||"Event Additional Information"===t.name||"Event Information"===t.name&&t.fields.filterBy({column_name:"SMCREATORID"}).length)return!0;break;case"Services":return"Availability Information"===t.name;case"Calls":return!this.isAvailableSectionForCallType(t.name,a);case"PriceBooks":return"Pricing Details"===t.name&&!a.Pricing_Model}return!1},getDVFieldLabelWidthColumnWise:function(e,t){var a=t.measureText(e).width;return a>170&&(a=170),a},handleNonViewAbleField:function(e,t,a,i){t.ui_type===CrmField.UITYPES.TERRITORY&&1===Crm.userDetails.TMENABLED&&Crm.userDetails.TERRITORY_COUNT_BASED_USER>1&&(e.business_card_section.detailviewColumns[0].push(t),a[t.api_name]=i)},populateLeftPanelInfo:function(e){var t=e.module,a=[],i={};if("Activities"===Crm.activityGrp[t]||t.startsWith("Orchestration")||t.startsWith("PathFinder")||this.transition.isRequesterDV)i.show_panel=!1,i.show_open_icon=!1;else{var r=void 0!==e.transitionData&&e.transitionData.kafkaWFData,o=!1;r&&(o=r.refreshInWms),o||a.push("list"),"Potentials"===t&&a.push("summary"),"Services"===t||"Appointments"===t||Crm.userDetails.LITE.IS_LITE_USER||a.push("link"),a.push("followers"),i.leftPanelItems=a,Crm.userDetails.CUSTOMIZE_INFO.show_left_panel?(i.show_panel=!0,i.tool_tip_label=I18n.getMsg("crm.accessibility.hide.detail.panel")):(i.show_panel=!1,i.tool_tip_label=I18n.getMsg("crm.accessibility.show.detail.panel")),i.show_open_icon=!0}i.loadExistingCount=!0,e.left_panel_info=i},populatePickListOptionsAsMapDependency:function(e,t,a,i,r,o,s,n){for(var l=e.length,d=0;d<l;d++){var c=e[d];if("used"===c.type&&("default"!==c.generated_type||"Record Image"!==c.name&&"Quick create"!==c.name&&"Business Card"!==c.name))if(c.isSubformSection)c.fields.forEach((function(e){500!==e.ui_type&&e.subform&&(s[e.api_name]=[e.id,e.ui_type],n[e.api_name]=0)}));else for(var u=c.fields,p=u.length,_=0;_<p;_++){var m=u[_];r[m.column_name]=[m.id,m.api_name],s[m.api_name]=[m.id,m.ui_type],n[m.api_name]=0;var f=m.lookup;if("lookup"===m.data_type&&f&&f.module){var v=moduleApiVsNameMapping[f.module.api_name],h=o[v];h||(h=[]),h.push(m.column_name),o[v]=h}this.populateFieldVsOptionsForField(m,a,i,t)}}},populateFieldVsOptionsForField:function(e,t,a,i){var r=e[t];if(r&&r.pick_list_values)for(var o=r.pick_list_values,s=o.length,n=0;n<s;n++){var l=o[n];if(i&&l&&l.maps&&(!i[e.api_name]&&"-None-"===l.display_value||i[e.api_name]===l.display_value))for(var d=l.maps,c=d.length,u=0;u<c;u++){var p=d[u];a[p.api_name]=p.pick_list_values}}},getSectionNameWithoutSpace:function(e){return e?e.replace(/ |'/g,"_"):""},parseBusinessCardFieldsForMessages:function(e){for(var t=[],a=e.fields,i=a.length,r=0;r<i;r++){var o=a[r],s=objectUtils.cloneObject(o);"sender__s"===o.api_name&&(s.api_name="sender",this.populateFieldAttributes(o,s,"title"))}t.push(s),e.header_model.isProfileImageAccessible=!0,e.header_model.title_card_fields=t},parseBusinessCardFields:function(e,t){var a=e.layout?e.layout:e.business_card,i=e.layoutId,r=e.record,o=e.cscript_properties?e.cscript_properties:{},s=["Leads","Contacts","Accounts","Potentials","Campaigns","Cases","Products","PurchaseOrders","PriceBooks"],n=["Campaigns"],l=[],d=[],c=this.getBusinessCardSection(a);e.business_card||(e.header_business_card=c);var u=c.fields,p=u.length;"Calls"===t&&(p=6);var _=i+"_"+c.id;u.sort((function(e,t){return e[_].sequence_number-t[_].sequence_number}));for(var m=0;m<p;m++){var f=u[m],v=objectUtils.cloneObject(f);if(v[i]&&v[i].required&&(v[i].isLayoutConfigLevelMandatory=!0),f.visible)switch(this.populateFieldAttributes(f,v,"business_card",t,r),this.populateCsriptPropInToField(v,o),f[_].sequence_number){case 1:if("Calls"===t){if(void 0!==e.record[v.api_name]||"Leads"===e.record.$se_module&&void 0!==e.record.What_Id){d.push(v);var h=objectUtils.cloneObject(v);l.push(h),this.populateFieldAttributes(f,h,"title",t,r);break}d.push(v)}else l.push(v),this.populateFieldAttributes(f,v,"title",t,r);break;case 2:if(s.contains(t)){l.push(v),this.populateFieldAttributes(f,v,"title",t,r);break}if("Calls"===t&&0===l.length&&void 0!==e.record[v.api_name]){d.push(v);h=objectUtils.cloneObject(v);l.push(h),this.populateFieldAttributes(f,h,"title",t,r);break}d.push(v);break;case 3:if(n.contains(t)){l.push(v),this.populateFieldAttributes(f,v,"title",t,r);break}d.push(v);break;default:d.push(v)}}e.header_model.title_card_fields=l,0===l.length&&"Calls"===e.module&&this.populateDefaultValue(e),0===d.length&&(e.nobcFieldsVisible=!0);var g=[];g.push(d),e.business_card_section={},e.business_card_section.name=c.name,e.business_card_section.contId=this.getSectionNameWithoutSpace(c.name),e.business_card_section.detailviewColumns=g},getBusinessCardSection:function(e){for(var t,a=(t=e[0]?e[0].sections:e.sections).length,i=0;i<a;i++){var r=t[i];if(r&&"Business Card"===r.api_name)return r}},populateFieldAttributes:function(e,t,a,i,r,o){var s={},n={},l={};switch(this.getLookupIconClass&&this.getLookupIconClass(t,l),t.component_data_type=t.data_type,t.ui_type){case CrmField.UITYPES.LAYOUT:case CrmField.UITYPES.WIZARD:t.component_data_type="layout";break;case CrmField.UITYPES.SKYPE_FIELD:t.component_data_type="skype";break;case CrmField.UITYPES.TERRITORY:t.component_data_type="territory";break;case CrmField.UITYPES.FAX:t.component_data_type="fax_phone";break;case CrmField.UITYPES.TWITTER:t.component_data_type="twitter";break;case CrmField.UITYPES.DATA_PARAM:t.component_data_type=t.rollup_summary.return_type;break;case CrmField.UITYPES.RICHTEXT:t.component_data_type="richtext";break;default:"formula"===t.data_type&&(t.component_data_type=t.formula.return_type),"STARTDATETIME"!==e.column_name&&"ENDDATETIME"!==e.column_name||"Events"!==i||!0!==r.All_day||(t.component_data_type="date"),"Activities"===Crm.activityGrp[i]&&("CONTACTID"===e.column_name&&"Calls"===i||"SEID"===e.column_name)&&(t.component_data_type="activity_mml"),"Events"!==i||1234!==e.ui_type&&104!==e.ui_type?1234===e.ui_type&&(t.component_data_type="remindat"):t.component_data_type="multi_reminder","CTIVOICEURL"===e.column_name&&(t.component_data_type="voicenote")}var d=e.column_name;switch(o&&(d=o+"_"+d),a){case"view":s.valueZcqa="value_"+e.display_label,s.valueIputZcqa=e.display_label,s.labelZcqa="dtVw_lbl_"+e.column_name,s.fldLblManZcqa="mandate_ast_"+e.column_name,n.valueId="subvalue_"+d,n.labelId="labelTD_"+d,n.ajaxEdit_containerId="ajaxEdit_"+d,n.value_containerId="value_"+d,n.fld_containerId="mouseArea__"+d,n.fldLblManId="mandate_ast_"+d,n.saveCancelContainerId=a+"_"+d,n.fldAjxSaveId=a+"_"+d,n.fldAjxCancelId=a+"_"+d,s.fldAjxSaveZcqa="saveAjaxEdit_"+a+"_"+d,s.fldAjxCancelZcqa="cancelAjaxEdit_"+a+"_"+d,s.fldAjxEditIconZcqa="edit_icon_"+a+"_"+d,l.is_highlight=!1;break;case"business_card":s.valueZcqa="bc_value_"+e.display_label,s.valueIputZcqa=e.display_label,s.labelZcqa="bc_dtVw_lbl_"+e.column_name,s.fldLblManZcqa="mandate_ast_"+e.column_name+"_header",n.valueId="headervalue_"+e.column_name,n.labelId="headerlabel_"+e.column_name,n.ajaxEdit_containerId="headerAjaxEdit_"+e.column_name,n.value_containerId="header_"+e.column_name,n.fld_containerId="bc_mouseArea__"+e.column_name,n.fldLblManId="mandate_ast_"+e.column_name+"_header",n.saveCancelContainerId=a+"_"+d,n.fldAjxSaveId=a+"_"+d,n.fldAjxCancelId=a+"_"+d,s.fldAjxSaveZcqa="saveAjaxEdit_"+a+"_"+d,s.fldAjxCancelZcqa="cancelAjaxEdit_"+a+"_"+d,s.fldAjxEditIconZcqa="edit_icon_"+a+"_"+d,l.is_highlight=!1;break;case"title":s.valueZcqa="value_"+e.column_name,s.labelZcqa="titlecard_dtVw_lbl_"+e.column_name,n.valueId="titlecard_"+e.column_name,n.labelId="titlecard_labelTD_"+e.column_name,n.containerId="titlecard_mouseArea__"+e.column_name,n.value_containerId="title_"+e.column_name,n.fld_containerId="tc_mouseArea__"+e.column_name,l.is_highlight=!1;break;case"ajaxpopup":s.valueZcqa="ajaxPop_"+e.display_label,n.valueId="ajaxPop_Crm_"+i+"_"+e.column_name,n.labelId="ajaxPop_"+n.valueId+"_label",n.containerId="ajaxPop_"+i+"_fldRow_"+e.column_name;break;case"right_panel":s.valueZcqa="rp_value_"+e.display_label,s.labelZcqa="rp_dtVw_lbl_"+e.column_name,n.valueId="rpvalue_"+e.column_name,n.labelId="rplabel_"+e.column_name,n.value_containerId="rightPanel_"+e.column_name,n.fld_containerId="rp_mouseArea__"+e.column_name,l.rp_bcIcon=this.rightPanelFieldsIcons[e.column_name];break;case"right_panel_deal_summary":s.valueZcqa="rp_ds_value_"+e.display_label,s.labelZcqa="rp_ds_dtVw_lbl_"+e.column_name,n.valueId="rp_ds_value_"+e.column_name,n.labelId="rp_ds_label_"+e.column_name,n.value_containerId="rP_dealSum_"+e.column_name,n.fld_containerId="rP_dealSum__mouseArea__"+e.column_name}t.$ids=n,t.$zcqa=s,t.$classes=l},parseRecordActions:function(e){var t=e.detailview_buttons;if(t&&t.actions){var a,i=t.actions,r=i.length,o=0,s=!1,n=!1;"Calls"!==e.module&&"Appointments"!==e.module||i.forEach((function(e){"clubbed_button"===e.type&&(n=!0)}));for(var l=0;l<r;l++){if("delete"===i[l].name&&"review_process_rejected"===e.record.$approval_state&&(e.detailview_buttons.actions[l].type="button"),"enrich_data"===i[l].name&&e.enrich_data&&(e.show_enrich_strip=!0),"icon"===i[l].type&&"shared_icon"===i[l].name){e.shared_details=i[l].details;var d=$ESAPI.encoder().encodeForHTML(e.shared_details.shared_by.name);e.shared_details.sharedUserName=d,e.shared_details.shared_user_count=e.shared_details.shared_user_count-1,e.detailview_buttons.actions.splice(l,1),r-=1}if("call"===i[l].name&&(s=!0),"button"===i[l].type&&("send_mail"===i[l].name||"send_dm"===i[l].name)){if(a)(u={}).display_label=i[l].display_label,u.name=i[l].name,u.type="clubbed_button",u.category="1",a.club_actions.push(u);else(a={}).display_label=i[l].display_label,a.name=i[l].name,a.type="clubbed_button",a.category="1",a.club_actions=[],a.hide=!0;o=l+1}if(!n&&"Calls"===e.module&&"0"===i[l].category)if(a){(u={}).display_label=i[l].display_label,u.name=i[l].name,u.type="clubbed_button",u.category="1",a.club_actions.push(u)}else{(a={}).display_label=i[l].display_label,a.name=i[l].name,a.type="clubbed_button",a.category="1",a.club_actions=[];var c=Lyte.Component.registeredHelpers.whichPBService();"ZPB"!==c&&"CRM_TELEPHONY"!==c||(a.hide=!0),o=l}if(!n&&"Appointments"===e.module&&("mark_as_completed"===i[l].name||"reschedule"===i[l].name||"cancel"===i[l].name)){var u;if(a)(u={}).display_label=i[l].display_label,u.name=i[l].name,u.type="clubbed_button",u.category="1",a.club_actions.push(u);else(a={}).display_label=i[l].display_label,a.name=i[l].name,a.type="clubbed_button",a.category="1",a.club_actions=[];e.detailview_buttons.actions.splice(l,1),r-=1,l-=1}if("team_based"===moduleRecordMapping[e.module].access_type&&"Requesters"===moduleRecordMapping[e.module].private_profile.name){t.actions={};break}if("meet_now"===i[l].name||"schedule_online_meeting"===i[l].name){let t=!1;if(!Crm.calPreferences||!Crm.calPreferences.MEETINGPREFDETAILS||"Leads"!==e.module&&"Contacts"!==e.module||"Free"===Crm.userDetails.LICENSE_TYPE_ACTUAL_NAME||Crm.userDetails.LITE.IS_LITE_USER||(t=!0),t){if("meet_now"===i[l].name){var p=JSON.parse(Crm.calPreferences.MEETINGPREFDETAILS);let e=p.length;if(e>1){var _=[];for(let t=0;t<e;t++){let e=p[t].toolName,a={name:e,display_label:Events.displayToolName[e],toolType:"provider"};_.push(a)}i[l].sub_actions=_}else 1===e&&(i[l].toolName=p[0].toolName)}}else e.detailview_buttons.actions.splice(l,1),r-=1,l-=1}}var m=i.length;for(l=0;l<m;l++){if(i[l]&&"send_dm"===i[l].name){i.splice(l,1);break}i[l]&&"send_mail"===i[l].name&&l+1<m&&"send_mail"===i[l+1].name&&i.splice(l,1)}if(!a||!a.name||"send_mail"!==a.name&&"send_dm"!==a.name||"Leads"!==e.module&&"Contacts"!==e.module||i.splice(o-1,0,a),!s&&("Leads"===e.module||"Contacts"===e.module||"Calls"===e.module)){var f={category:"1",display_label:I18n.getMsg("Call"),name:"call",type:"button"};i.splice(o,0,f)}!n&&a&&"Calls"===e.module&&i.splice(o+1,0,a),!n&&a&&"Appointments"===e.module&&i.splice(0,0,a)}},parseRightPanelData:function(e,t){for(var a=[],i={},r={},o=t.sections,s=o.length,n=this.rightPanelFields[e],l=e===crmModuleConstants.Leads||e===crmModuleConstants.Contacts,d=0;d<s;d++){var c=o[d];if(c.fields)for(var u=(_=c.fields).length,p=0;p<u;p++){r[(m=_[p]).column_name]=[m.id,m.api_name]}if(l||"default"===c.generated_type&&"Business Card"===c.name){if(l){if("used"!==c.type)continue;if("default"===c.generated_type&&("Record Image"===c.name||"Quick create"===c.name||"Business Card"===c.name))continue}var _;for(u=(_=c.fields).length,p=l?0:1;p<u;p++){var m=_[p];if(!(l&&n.indexOf(m.column_name)<0)){var f=objectUtils.cloneObject(m);this.populateFieldAttributes(m,f,"right_panel"),a.push(f)}}}}i.fieldColumnNameMap=r,this.setData("meta_info",i),this.setData("info_fields",a)},parseAndSetCurrencyValue:function(e,t,a,i,r,o){var s,n=[],l=(n=featuresAvailable.MultiCurrency&&void 0!==Crm.userDetails.CURRENCY_DETAILS[e]?returnJson.entityMapJson.EXCHANGERATE&&returnJson.entityMapJson.EXCHANGERATE.defaultvalue?currencyUtils.returnValueInDefaultCurrencyAsArray(e,t,Crm.userDetails.CURRENCY_DETAILS[e].decimals,parseFloat(returnJson.entityMapJson.EXCHANGERATE.defaultvalue)):currencyUtils.returnValueInDefaultCurrencyAsArray(e,t,Crm.userDetails.CURRENCY_DETAILS[e].decimals):currencyUtils.returnValueInDefaultCurrencyAsArray(e,t))[0];featuresAvailable.MultiCurrency&&a.Currency&&Crm.userDetails.BASE_CURRENCY!==a.Currency&&(l=n[1],(s=a.$home_converted_currency?Lyte.deepCopyObject(a.$home_converted_currency):{})[i]=n[0].trim(),Lyte.objectUtils(a,"add","$home_converted_currency",s));(s=a.$formatted_currency?Lyte.deepCopyObject(a.$formatted_currency):{})[i]=l.trim();var d=isNaN(s[i]);if(d&&delete s[i],Lyte.objectUtils(a,"add","$formatted_currency",s),Crm.userDetails.isSubformNewComponentEnabled){var c=isNaN(t)||d?void 0:parseFloat(t);c=r&&o?o:c;var u={id:a.id};u[i]=""===c?void 0:c,store.pushPayload(a.$.model._name,u)}else Lyte.objectUtils(a,"add",i,isNaN(t)||d?void 0:parseFloat(t))},processOneLayoutRules:function(e,t,a,i){var r=e.sections,o=e.fields,s=Lyte.registeredMixins["crm-create-mixin"];t.forEach((function(e){var t=o.filter((function(t){return t.id===e.primary_field.id}))[0];t&&t.visible&&e.queries.forEach((function(e){var t=s.checkCriteriaMatchForCanvas(e.criteria,a,s);e.actions.forEach((function(e){"Show_Fields"===e.type&&e.fields.forEach((function(e){var a=o.filter((function(t){return t.id===e.id}))[0];a&&t!==a.view_type[i]&&(t?(a.view_type[i]=!0,a.isHiddenInLR=!1):(a.view_type[i]=!1,a.isHiddenInLR=!0))})),"Show_Sections"===e.type&&e.sections.forEach((function(e){var a=r.filter((function(t){return t.name===e}))[0];a&&(a.isHiddenInLR=!t)}))}))}))}))},getStages:function(e,t){for(var a=e.length,i=[],r=0;r<a;r++)i.push(e[r].id);return e=[],i.forEach((function(a){t.filter((function(t){t.id===a&&e.push(t)}))})),e},getRecurringInfoForTask:function(e){if(e){var t=crmTasks.convertRruleToMap(e.RRULE),a=t.FREQ,i=t.INTERVAL,r=CrmDateUtils.convertDateToUserPattern(t.DTSTART,void 0,!0),o=t.UNTIL?t.UNTIL:void 0;"-1"===o&&(o=this.getEndDateForNeverEndingTask(t)),o=CrmDateUtils.convertDateToUserPattern(o,void 0,!0);var s="",n={1:"First",2:"Second",3:"Third",4:"Fourth",5:"Last","-1":"Last"},l={1:"Sunday",2:"Monday",3:"Tuesday",4:"Wednesday",5:"Thursday",6:"Friday",7:"Saturday"};switch(a){case"DAILY":s=I18n.getMsg("crm.event.day2",[i,r,o]);break;case"WEEKLY":for(var d="",c=["SU","MO","TU","WE","TH","FR","SA"],u=t.BYDAY.split(","),p=u.length,_=0;_<p;_++){var m=c.indexOf(u[_])+1;d+=""===d?I18n.getMsg(l[""+m]):","+I18n.getMsg(l[""+m])}s=I18n.getMsg("crm.every.week",[d,r,o,i]);break;case"MONTHLY":_=0;if(h=t.BYMONTHDAY)s=I18n.getMsg("crm.every.month1",[h,i,r,o]);else{h=t.BYSETPOS,h=I18n.getMsg("lowercase"+n[h].toLowerCase());var f=t.BYDAY,v=(c=["SU","MO","TU","WE","TH","FR","SA"]).indexOf(f)+1;v=I18n.getMsg(l[""+v]),s=I18n.getMsg("crm.every.month2",[h,v,i,r,o])}break;case"YEARLY":var h=t.BYMONTHDAY,g=I18n.getMsg({1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"}[t.BYMONTH]);if(h)s=I18n.getMsg("crm.every.year1",[h,g,r,o]);else{f=t.BYDAY;c=["SU","MO","TU","WE","TH","FR","SA"],h=t.BYSETPOS,h=I18n.getMsg("lowercase"+n[h].toLowerCase());v=c.indexOf(f)+1;v=I18n.getMsg(l[""+v]),s=I18n.getMsg("crm.every.year2",[h,v,g,r,o])}}return s}},getEndDateForNeverEndingTask:function(e){var t=e.FREQ,a=parseInt(e.INTERVAL),i=$L.moment(e.DTSTART).toDate();switch(t){case"DAILY":if(e.BYDAY)for(var r=a*(crmConstants.recurringEndDateLimit[t.toLowerCase()]-1),o=e.BYDAY;r>0;){i.setDate(i.getDate()+1);const e=["SU","MO","TU","WE","TH","FR","SA"][i.getDay()];o.includes(e)&&r--}else i.setDate(i.getDate()+a*(crmConstants.recurringEndDateLimit[t.toLowerCase()]-1));break;case"WEEKLY":crmTasks.setPossibleEndDateForWeekly(i,e.BYDAY.split(","),a,!0);break;case"MONTHLY":case"YEARLY":var s,n,l;if(s=e.BYMONTHDAY,n="YEARLY"===t?parseInt(e.BYMONTH)-1:void 0,s)s=parseInt(s),l=1;else{l=2;var d=parseInt(e.BYSETPOS);d=-1===d?5:d;var c=["SU","MO","TU","WE","TH","FR","SA"].indexOf(e.BYDAY)+1;s=crmTasks.getmonthspecificday(i,c,d)}crmTasks.setPossibleEndDateForMonthlyOrYearly(i,l,a,s,d,c,t,n)}return i},canWeShowDataPrivacyTab:function(e){if(!e)return!1;let t=e.length;for(let a=0;a<t;a++)if(e[a]&&"data_privacy"===e[a].name)return e.splice(a,1),!0;return!1},populateLockingInfo:function(e,t,a){var i={allowed_fields:[],fieldIds:[],recordDtl:{LockedReason:""},isLocked:!1,restricted_actions:[],restricted_communications:[],restricted_custom_buttons:[]},r=t.fields.filter((function(e){return"ISLOCKED"===e.column_name}))[0];r=r?r.api_name:r,i.lockedFieldApiName=r;var o=e.locking_configuration,s=e.lockedRecordDetails?e.lockedRecordDetails.data:void 0,n=e.record,l=!1,d="Pending for Review"===n.$review||"Pending for ReReview"===n.$review||"Review in Progress"===n.$review||"zia_vision_pending"===n.$approval_state||"zia_vision_validation"===n.$approval_state||"approval_process_pending"===n.$approval_state;if(n&&(n[r]||a)&&!n.$stop_processing&&o&&!d){var c,u,p,_=Crm.userDetails.permissions["Crm_Implied_Lock_"+e.module],m=_,f=s?s.length:0,v=[],h=[],g=[],y=[],b=!1;n&&n[r]&&(_=!1,l=n.$locked_for_me);var C=e.lockingInfoFields;C&&C.length&&(C=C.filter((function(e){return"Lock_Source__s"===e.api_name}))),C=C&&C[0]?C[0].pick_list_values:void 0;for(var I=o.length,D=0;D<I;D++){var L=o[D];if("automatic"!==L.lock_type&&a&&(p=!0),s&&f){var R=s.filter((function(e){return e.Record_Locking_Configuration_Id__s===L.id}));if(R&&R.length){if(l){var E=!0;if("all_profiles"!==L.locked_for)for(var w=L.lock_excluded_profiles?L.lock_excluded_profiles.length:0,A=0;A<w;A++){if(L.lock_excluded_profiles[A].name===Crm.userDetails.PROFILE_NAME){E=!1;break}}E&&y.push(L.id)}for(var k=0;k<f;k++){var M=R[k],N=C?C.filter((function(e){return e.display_value===M.Lock_Source__s})):void 0;"Automatic"===(N=N&&N[0]?N[0].actual_value:void 0)?(u="automatic",g.push(L)):"Manual"===N&&"automatic"!==u&&(u="manual","orchestration"===L.feature_type?(b=!0,h.push(L)):"record_locking"!==L.feature_type||b||v.push(L))}}}}if(a&&(i.isLockAllowed=_&&p),u){c="automatic"===u?g:"manual"===u&&b?h:v;var S=[];if(i.isLocked=!0,c&&c.length){var F=!0;for(D=0;D<f;D++){var T=c.filter((function(e){return e.id===s[D].Record_Locking_Configuration_Id__s}));if(T){if(T=T[0],l&&!y.contains(T.id))continue;if(T.excluded_fields=T.excluded_fields?T.excluded_fields:[],F&&(i.allowed_fields=T.excluded_fields,i.recordDtl.Locked_Time=s[D].Locked_Time__s,F=!1),i.allowed_fields=i.allowed_fields.intersection(T.excluded_fields),l){T.restricted_actions&&(i.restricted_actions=Array.from(new Set(i.restricted_actions.concat(T.restricted_actions)))),T.restricted_communications&&(i.restricted_communications=Array.from(new Set(i.restricted_communications.concat(T.restricted_communications))));var P=T.restricted_custom_buttons?T.restricted_custom_buttons.map((e=>e.id)):[];i.restricted_custom_buttons=Array.from(new Set(i.restricted_custom_buttons.concat(P)))}if($L.moment(i.recordDtl.Locked_Time).toDate()>$L.moment(s[D].Locked_Time__s).toDate()&&(i.recordDtl.Locked_Time=s[D].Locked_Time__s),"manual"===u)i.recordDtl.lock_type="manual",i.recordDtl.LockedBy=s[D].Locked_By__s?s[D].Locked_By__s.name:void 0,i.recordDtl.LockedReason=s[D].Locked_Reason__s,i.recordDtl.id=s[D].id,i.isUnLock=Crm.userDetails.IS_ADMIN||s[D].Locked_By__s.id===Crm.userDetails.USER_ID;else if("automatic"===u){i.recordDtl.lock_type="automatic";var O=T.locking_rules.filter((function(e){return e.id===s[D].Record_Locking_Rule_Id__s}));O&&O[0]&&S.push(O[0].name)}}}var x=l&&i.restricted_actions.contains("update");i.fieldIds=[];var j=i.allowed_fields?i.allowed_fields.length:0;i.fieldNames=j>0?"":"-";for(var U=0;U<j;U++){var V=store.peekRecord("field",i.allowed_fields[U].id);V&&(x&&i.fieldIds.push(V.id),i.fieldNames+=V.field_label,j-1!==U&&(i.fieldNames+=", "))}var Y=S.length;i.recordDtl.Locked_Time=Utils.getDateInLocaleDefaultFormat(Utils.ISO8601toDateObject(i.recordDtl.Locked_Time)),Y>0&&(i.recordDtl.LockedReason=S),i.canViewDetails=!Crm.userDetails.CLIENT_ACCOUNT,i.isLockedForMe=l,i.lockToolPerm=m}}}if("Tasks"===t.api_name&&!a){var B,q="true"===$("#iskanbanview").val(),H=I18n.getMsg("crm.record.lock.record.locked");B=q?'<span id="reclock_'+n.id+'" class="iconlock_ap zcrm_svgIcons recordLockingiconlock_ap mL5" lt-prop-title=\''+H+'\' lt-prop-tooltip-config=\'{"position":"bottom","appearance":"box","keeptooltip":"true","margin":"5"}\'></span>':'<span id="reclock_'+n.id+'" class="dIB mL8 zcrm_svgIcons rlc_lockIcon vat" lt-prop-title=\''+H+'\' lt-prop-tooltip-config=\'{"position":"bottom","appearance":"box","keeptooltip":"true","margin":"5"}\'></span>',l&&0===$("#reclock_"+n.id).length?q?$(".kv_Name_"+n.id).after(B):$(".lp_Subject_"+n.id).after(B):l||$("#reclock_"+n.id).remove()}return i},constructReviewDetails:function(e){var t={};if(void 0!==e.review_process_data){for(var a,i=e.review_process_data.review.process_fields,r=e.review_process_data.review.record.status,o=e.review_process_data.review.rule.id,s=void 0!==i?i.length:0,n=0,l=0,d=0,c=!1,u="none",p={},_={},m=[],f={},v=0;v<s;v++){var h=i[v].subform_records;if(void 0!==h){var g=i[v].api_name,y=this.getSubformFieldStatus(h,n,l,d);f[g]=y.subformRecordIdVsRpFldStatus,n+=y.totalCount,l+=y.approvedCount,d+=y.rejectedCount;for(var b=h.length>0?h[0].process_fields:{},C=b.length,I=0;I<C;I++)m.push(b[I].id)}else{var D=i[v].id,L=i[v].api_name,R=i[v].status;p[D]=L,_[D]=R,"Approved"===R?l++:"Rejected"===R&&d++,n++,m.push(D)}}"Rejected"===r&&(c=!0),(a=l+d)>0&&a!==n&&!c&&(u="block");var E={};E.module=e.module,E.id=e.record.id,E.calleeObj="Crm",E.clickId="deleteEntity",t.rpdeleteParams=E,t.fieldVsName=p,t.fieldVsStatus=_,t.subformNameVsRecordRpFldStatus=f,t.approvedCount=l,t.rejectedCount=d,t.reviewedCount=a,t.totalCount=n,t.record_status=r,t.isResubmit=c,t.ruleId=o,t.styledisplay=u,t.reviewFields=m}else t.styledisplay="none","Pending for Review"===e.record.$review||"Review in Progress"===e.record.$review?t.record_status="pending_for_review":"Pending for ReReview"===e.record.$review&&(t.record_status="pending_for_re-review");return t},getSubformFieldStatus:function(e,t,a,i){for(var r={},o={},s=e.length,n=0;n<s;n++){for(var l=e[n].process_fields,d=void 0!==l?l.length:0,c=e[n].id,u={},p={},_=0;_<d;_++){var m=l[_];if(void 0!==m){var f=m.api_name,v=m.id,h=m.status;u[v]=f,p[v]=h,"Approved"===h?a++:"Rejected"===h&&i++}t++}o[c]=p}return r.totalCount=t,r.approvedCount=a,r.rejectedCount=i,r.subformRecordIdVsRpFldStatus=o,r},constructFieldIndexing:function(e,t){var a={},i={};this.allFieldIndexing=1,this.fieldIndexing=1;for(var r=t.length,o=0;o<r;o++){var s,n=t[o],l=[],d=[],c={};n.isSubformSection&&(a[s=n.fields.filter((function(e){return e.subform}))[0].api_name]=this.setSubformFieldIndexing(n.fields,e.subformNameVsRecordRpFldStatus[s])),void 0!==n.detailviewColumns?(l=void 0!==n.detailviewColumns[0]?n.detailviewColumns[0]:[],d=void 0!==n.detailviewColumns[1]?n.detailviewColumns[1]:[]):l=n.fields;for(var u=n.fields.length,p=0,_=0,m=0;m<u;m++)(m%2==0||0===d.length)&&p<l.length?(this.setFieldIndexing(l[p],e.reviewFields,e.fieldVsStatus,c),p++):m%2!=0&&_<d.length&&(this.setFieldIndexing(d[_],e.reviewFields,e.fieldVsStatus,c),_++);n.isSubformSection&&Object.keys(c)&&(i[s]=c)}e.subformNameVsRecordFieldIndexing=a,e.subformNameVsAggFieldIndexing=i},setFieldIndexing:function(e,t,a,i){t.contains(e.id)&&(e.allFieldIndexing=this.allFieldIndexing++,"yet_to_review"===a[e.id]&&(e.fieldIndexing=this.fieldIndexing++),e.subform&&(i[e.id]={},i[e.id].allFieldIndexing=e.allFieldIndexing,"yet_to_review"===a[e.id]&&(i[e.id].fieldIndexing=e.fieldIndexing)))},setSubformFieldIndexing:function(e,t){var a={};for(var i in t){for(var r=e.length,o={},s=t[i],n=0;n<r;n++){var l=e[n];void 0!==s[l.id]&&(o[l.id]={},o[l.id].allFieldIndexing=this.allFieldIndexing++,"yet_to_review"===s[l.id]&&(o[l.id].fieldIndexing=this.fieldIndexing++))}a[i]=o}return a},constructApprovalDetails:function(e){var t=Crm.userDetails.APPROVALPROCESS_EVERYONE,a={},i=e.approval_process_data.approval_process,r=i.length,o=null,s=[],n=0,l=0,d={status:"2"},c=[],u=[],p={},_={},m="",f="",v={},h={},g=[],y=i[0].allow_cc_during_rejection,b=i[0].allow_cc_during_approval;a.approval_state=e.record.$approval_state,a.showRespondLink=e.record.$approval.approve,a.delegateDeactivate=e.record.$approval.delegate,a.overall_approval_config=e.approval_process_data.approval_process[0].overall_approval_config,"anyone"===a.overall_approval_config?a.totalApproverLevel=1:a.totalApproverLevel=r;for(var C=0;C<r;C++){var I=i[C].approval_status,D=t?I.length:1,L=i[C].approver;o=i[C].rejection_type;var R=[],E=0,w=0,A=0,k=[],M=[];g.push(L.type),t&&void 0===I.length&&"pending"===I.status?E=1:null!==i[C].user_approval_config&&(l=1,w=1);for(var N=0;N<D;N++){var S=t||!t&&I.length?I[N].user.name:L.resource.name,F=t||!t&&I.length?I[N].delegated_user:I.delegated_user,T=t||!t&&I.length?I[N].status:I.status;if(F&&R.push(S),w&&(_[S]="https://contacts.csez.zohocorpin.com/file?ID=15955884&fs=thumb"),"anyone"===a.overall_approval_config)E=1,k.push(S),"rejected"===T&&(m=S,f=S),null===i[C].user_approval_config&&(k=[]);else if("everyone"===i[C].user_approval_config||null===i[C].user_approval_config){switch(T){case"pending":k.push(S),E=1;break;case"rejected":k.push(S),m=S,f=S,E=1;break;case"approved":M.push(S),A++}null===i[C].user_approval_config&&(k=[],M=[])}else switch(T){case"approved":M.push(S),A++,E=0;break;case"rejected":k.push(S),m=S,f=S,E=1;break;default:E=1,k.push(S)}}E&&n++;var P="";"users"!==L.type&&"record_owner"!==L.type&&"reporting_manager"!==L.type&&void 0!==I.length&&E&&(P="splitername"+A+"/"+I.length),L.hasOwnProperty("resource")?(s.push(L.resource.name),P=L.resource.name+P):(s.push("Level"+L.level),P="Level"+L.level+P);var O=!1;w&&(v[P+"delegateUsers"]=R),""===m?(c.push(P),E&&"2"===d.status&&u.push(P),M.length!==I.length&&0!==E||(O=!0,M=[])):(d.warnUser=P,d.iconUser=f,d.status="3",u=[],m="");var x=[];(w||null===i[C].user_approval_config)&&(x.push(k),x.push(M),x.push(O),h[P]=x)}a.currLevel=i.length-n;i.length;var j=-1;a.overall_approval_config.includes("_sequential")&&a.currLevel,l||(d.usersArray={}),void 0!==h&&Object.keys(h).forEach((function(e){j++,"3"!==d.status&&"users"===g[j]||(p[e]=h[e][0],p["apr-"+e]=h[e][1],"3"===d.status&&(p["isApproved-"+e]=h[e][2]))})),d.isPortalUser="true","anyone"===a.overall_approval_config||a.overall_approval_config.includes("_parallel")?d.parllel="true":d.parllel="2",d.currLevel=a.currLevel+1,d.fullUserList=c,d.fullUserMapDelegate=v,d.activeUserList=u,d.usersArray=p,d.userIcon=_;var U="2",V=[],Y={};if("current_approver_decide"===o?U="3":null===o&&(U="1"),"3"===U)for(C=a.currLevel;C>=0;C--){V.push((C+1).toString());var B=s[C];0===C?B+=" (Start from first)":C===a.currLevel?B+=" (Current Stage)":C===a.currLevel-1&&(B+=" (Previous Stage)"),Y[C+1]=B}d.rejectorsType=U,d.approverList=V,d.rejectorObj=Y,d.rejectActionCC=y,d.approveActionCC=b;var $={approversNameList:d};if(a.thisObj=$,a.hasresubmitLink=e.record.$approval.resubmit,a.hasresubmitLink&&void 0!==e.timeline_info){var q=e.timeline_info.timelines[0].automation_details.approval_process,H=void 0!==q?q.comments:q;void 0===H&&(H="N/A"),a.comments=H}return a},populateDefaultValue:function(e){var t,a=e.business_card?e.business_card[0].fields:e.header_business_card.fields,i=!1,r=e.record.Call_Type;a.forEach((function(e){"Call_Type"===e.api_name&&e.pick_list_values.forEach((function(e){e.display_value===r&&(t=e.actual_value)}))})),"Outbound"===t&&(i=!0),i&&!isCallerInfoDisabled&&e.record.To_Number__s?(e.defaultValue=e.record.To_Number__s,e.record.$phone_number=e.record.To_Number__s):i||isCallerInfoDisabled||!e.record.From_Number__s?!Crm.userDetails.CALLS_PREFERENCE&&e.record.$phone_number?e.defaultValue=e.record.$phone_number:e.defaultValue=I18n.getMsg("crm.activities.call.unknown.entityname"):(e.defaultValue=e.record.From_Number__s,e.record.$phone_number=e.record.From_Number__s)}});
