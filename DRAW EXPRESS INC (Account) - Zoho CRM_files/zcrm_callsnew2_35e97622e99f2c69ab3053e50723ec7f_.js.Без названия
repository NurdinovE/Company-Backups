var crmCallsNew={alpha_mappings:{A:"2",B:"2",C:"2",D:"3",E:"3",F:"3",G:"4",H:"4",I:"4",J:"5",K:"5",L:"5",M:"6",N:"6",O:"6",P:"7",Q:"7",R:"7",S:"7",T:"8",U:"8",V:"8",W:"9",X:"9",Y:"9",Z:"9"},sections:{CallInfo:{sysRefName:"Call Information",divId:"secDiv_Call_Information"},Purpose:{sysRefName:"Purpose Of Outgoing Call",divId:"secDiv_Purpose_Of_Outgoing_Call"},Outcome:{sysRefName:"Outcome Of Outgoing Call",divId:"secDiv_Outcome_Of_Outgoing_Call"},Reason:{sysRefName:"Reason For Incoming Call",divId:"secDiv_Reason_For_Incoming_Call"}},fields:{Call_Duration:"Calls_fldRow_CALLDURATION",Call_Type:"Calls_fldRow_CALLTYPE",Call_StartDate:"Crm_Calls_CALLSTARTDATETIME",Call_StartTime:"Crm_Calls_CALLSTARTDATETIME_TimeOption",Reminder:"Calls_fldRow_REMINDAT",Call_Owner:{fieldRow:"Calls_fldRow_SMOWNERID",dataElement:"Crm_Calls_SMOWNERID",displayNameEl:"ownerNameLookupSpan"}},buttons:{SaveBt:"saveCallBtn",CallBt:"startCallingBtn"},remindBefore:[{value:"0",i18nKey:"None",i18nParams:null,valueInMin:0},{value:"5 mins",i18nKey:"crm.event.remind.mins",i18nParams:[5],valueInMin:5},{value:"10 mins",i18nKey:"crm.event.remind.mins",i18nParams:[10],valueInMin:10},{value:"15 mins",i18nKey:"crm.event.remind.mins",i18nParams:[15],valueInMin:15},{value:"30 mins",i18nKey:"crm.event.remind.mins",i18nParams:[30],valueInMin:30},{value:"1 hrs",i18nKey:"crm.event.remind.hrs",i18nParams:[1],valueInMin:60},{value:"2 hrs",i18nKey:"crm.event.remind.hrs",i18nParams:[2],valueInMin:120},{value:"1 days",i18nKey:"crm.event.remind.day",i18nParams:[1],valueInMin:1440},{value:"2 days",i18nKey:"crm.event.remind.days",i18nParams:[2],valueInMin:2880}],getSections:function(e,a){if(!isNewCallView)return e;var l,t=[];return"Outbound"==a?l=crmCallsNew.sections.Reason.sysRefName:"Inbound"!=a&&"Missed"!=a||(l=crmCallsNew.sections.Outcome.sysRefName),e&&e.each((function(e){e.name===l&&(e.FL&&(e.FL=e.FL.filter((function(e){return"DESCRIPTION"!=e.colname}))),e.splFL&&e.splFL[0]&&(e.splFL[0]=e.splFL[0].filter((function(e){return"DESCRIPTION"!=e.colname})))),t.push(e)})),t},getCallStartTimeWithInfo:function(e,a,l){var t=crmCallsNew.getCallStartCrmDate(e,a,l);return t.whichCall||(t.isFutureTime()?t.whichCall="ScheduledCall":t.whichCall="CompletedCall"),t},getCallStartCrmDate:function(e,a,l){var t=$("#createEditCallPopup"),i=e||t.find("#"+crmCallsNew.fields.Call_StartDate),r=(a||t.find("#"+crmCallsNew.fields.Call_StartTime)).val(),s=i.val().trim(),n=CrmDateUtils.splitDateVal(s),o=r.split(":"),d=n[0],m=n[1],c=n[2],C=o[0],u=o[1],v=null;if(l)v=l.val();else if("HH:mm"!==Crm.userDetails.TIME_FORMAT){var p=o[1].split(" ");u=p[0],v=p[1]}return CrmDateUtils.getCrmDateFromUserTime(m,d,c,C,u,null,v)},initiateCallViaZPB:function(e,a,l,t,i){crmCallsNew.getClick2CallPromise(a,l,t,i).then((function(t){ZPB.clickToDial.trigger(e,l,a,t)}))},getClick2CallPromise:function(e,a,l,t,i,r){if(isNaN(t)&&(t=void 0),"Calls"===a){if(!i){var s=event&&event.target?event.target.closest("zpb-phone"):void 0;void 0!==s&&(i=s.component.getData("number"))}return t=e,new Promise((function(s,n){store.modelFor(moduleRecordMapping.Calls.id)||store.registerModel(moduleRecordMapping.Calls.id,{},{extends:"entity"});var o,d=[store.findRecord("module",moduleRecordMapping.Calls.id)],m=store.peekRecord(moduleRecordMapping.Calls.id,e);if(void 0!==m&&m.hasOwnProperty("Who_Id")&&(void 0!==m.Who_Id||m.hasOwnProperty("What_Id"))&&m.hasOwnProperty("Outgoing_Call_Status")&&m.hasOwnProperty("Call_Type")&&m.hasOwnProperty("From_Number__s")&&m.hasOwnProperty("To_Number__s"))o=crmCallsNew.getCallAssociatedRecordJson(m);else{var c=store.findRecord(moduleRecordMapping.Calls.id,e);d.push(c)}Lyte.resolvePromises(d).then((function(d){d[1]&&(m=d[1][0],o=crmCallsNew.getCallAssociatedRecordJson(m));var c=crmCallsNew.isOutboundCall(m.Call_Type);if(c&&("TONUMBER"===r||i===m.To_Number__s)||!(c||"FROMNUMBER"!==r&&i!==m.From_Number__s)){a=o.Who_Id?"Contacts":o.What_Id?o.$se_module:void 0,e=o.Who_Id?o.Who_Id.id:o.What_Id?o.What_Id.id:void 0,l=o.Who_Id?o.Who_Id.name:o.What_Id?o.What_Id.name:void 0,a||(a="PhoneNumbers");var C,u=crmCallsNew.isOpenCall(m.Outgoing_Call_Status);if(!CTIAPI.CTI.showC2Cform||u)return validationUtils.isNotEmpty(t)&&u&&(C=JSON.stringify({isActivityCreated:!0,callActivityId:t})),void ZPB.clickToDial.trigger(i,a,e,C);crmCallsNew.openClick2CallForm(o,(function(l){l?s():(Calls.c2cResolveFun=function(l){ZPB.clickToDial.trigger(i,a,e,l)},Calls.c2cRejectFun=n)}))}else ZPB.clickToDial.trigger(i)})),n()}))}return isNewCallView&&CTIAPI.CTI.showC2Cform&&validationUtils.isEmpty(t)?new Promise((function(t,i){var r={};validationUtils.isNotEmpty(e)&&validationUtils.isNotEmpty(a)&&validationUtils.isNotEmpty(l)&&((r="Contacts"===a?{Who_Id:{id:e,name:l},$se_module:"Contacts"}:{What_Id:{id:e,name:l},$se_module:a}).autoPopRelated=!0),crmCallsNew.openClick2CallForm(r,(function(e){e?t():(Calls.c2cResolveFun=t,Calls.c2cRejectFun=i)}))})):(validationUtils.isNotEmpty(t)&&(n=JSON.stringify({isActivityCreated:!0,callActivityId:t})),new Promise((function(e){e(n)})));var n},getCallAssociatedRecordJson:function(e){var a={};return void 0!==e.Who_Id?(a.Who_Id=e.Who_Id,a.$se_module="Contacts",a.autoPopRelated=!0):void 0!==e.What_Id&&(a.What_Id=e.What_Id,a.$se_module=e.$se_module,a.autoPopRelated=!0),a},openClick2CallForm:function(e,a){var l=networkUtils.returnDependencyFiles(["crm-call-menu.js"],ResourceConstants.CRMClient);Lyte.injectResources(l,void 0,(function(){Lyte.registeredMixins["crm-call-form-mixin"].initCallForm("Click2Call_Form",a,e)}))},validateEntity:function(e,a,l,t,i,r){var s,n=!0,o={result:!0},d=r||a;if(e.length){var m=e.data(),c=m.name,C=m.uitype+"";s="string"==typeof(s=commonUtils.getValue(e))?s.trim():s;var u=m.colname,v=m.oldValue,p=m.mandate+"",_=Crm.getSaveParamName(e,l,a),f=e.data();C+="";var h={};if("true"===p&&"ADDCOMMENT"===u&&validationUtils.isFieldEmpty(e)&&!/create|clone/.test(window[a].currentStatus)?(o.mandateFailed=!0,n=!1):"true"!=p||"HANDLER"!==u&&"221"!=C||e.data("id")?"true"===p&&("duration"!==u&&"durationUnit"!==u||!$("#Crm_Consents_duration_radio1").prop("checked"))&&validationUtils.isFieldEmpty(e)&&"HANDLER"!==u&&"221"!==C&&"SMOWNERID"!==u&&"ADDCOMMENT"!==u&&(o.mandateFailed=!0,n=!1):(o.mandateFailed=!0,n=!1),n||""!=s)switch(C){case"27":case"555":case"42":case"123":case"41":default:break;case"33":case"35":validationUtils.isValidPhoneNo(e,e.val())||(o.checkFailed=!0,n=!1);break;case"34":case"38":var y=m.maxlength-(U=m.decimalLength);if(validationUtils.isValidDecimal(s,y,U))validationUtils.decimalLengthCheck(s,U)||(o.decimalLengthCheckFailed=!0,n=!1);else o.checkFailed=!0,n=!1;break;case"32":case"52":""===s||validationUtils.isValidInteger(s)||(o.integerFailed=!0,n=!1);break;case"1":case"2":"-None-"===s&&(s=""),"CALLDURATION"===u&&(""===s||validationUtils.isValidInteger(s)?(s=parseInt(s,10),/^\d{1}$/.test(s)&&(s="0"+s)):(o.integerFailed=!0,n=!1));break;case"100":s||(s=""),s&&(s=s.join(";"));break;case"17":s=t.find("input[type='radio'][name='"+c+"']:checked").val();break;case"18":t.find("."+m.colname).each((function(){this.checked&&(h[this.name]="on")}));break;case"21":var I=e.val().trim();validationUtils.isValidWebUrl(I)||(o.checkFailed=!0,n=!1);break;case"22":var T=e.val().trim();validationUtils.isValidTwitter(T)||(o.checkFailed=!0,n=!1);break;case"25":I=e.val().trim();validationUtils.isValidEmail(I)||(o.checkFailed=!0,n=!1);break;case"301":case"300":s=e.is(":checked")?"on":"";break;case"24":case"202":case"14":case"786":case"30":case"333":if(s=s.replace(Crm.userDetails.DATE_PATTERN,""),"24"!=C&&"202"!=C)var g=t.find("#"+e.attr("id")+"_TimeOption").val().split(" ")[0];if(m.mandate+""=="true"&&"24"!=C&&"202"!=C&&""==g&&(n=!1,o.mandateFailed=!0),""==s||Utils.isValidDate(Crm.userDetails.DATE_PATTERN,s,void 0,!0)||(o.checkFailed=!0,n=!1),("786"==C||"30"==C||"14"==C||"333"==C)&&""!=s&&""!=g){var N=g.split(":"),O=Utils.getMeridiem(t.find("#"+e.attr("id")+"_TimeOption").timeEntry("getTime")).toUpperCase(),D=N[0],E=N[1];Utils.isValidTime(D,E)||(o.checkFailed=!0,n=!1),D&&(h[_.substring(0,_.indexOf(")"))+"hour)"]=D),E&&(h[_.substring(0,_.indexOf(")"))+"minute)"]=E),O&&"HH:mm"!==Crm.userDetails.TIME_FORMAT&&(h[_.substring(0,_.indexOf(")"))+"ampm)"]=O);var w=s+" "+D+":"+E;"HH:mm"!==Crm.userDetails.TIME_FORMAT&&(w=w+" "+O),i[u]=crmCallsNew.getColumnParamsObj(c,C,w)}break;case"Time":Utils.isValidTime(e.val())||(n=!1);break;case"221":s=e.data().id;break;case"8":s=e.val(),h["property(ownerId)"]=e.data().id,h["property(ownerName)"]=t.find("#ownerNameLookupSpan").text(),i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id);break;case"208":h["property(Layout)"]=e.val();break;case"55":s=e.val(),h["property(ownerName:Handler)"]=e.data().id,i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id);break;case"4":case"5":case"6":case"7":case"9":case"10":case"12":case"13":case"15":case"133":(s=e.data("id"))&&"null"!=s?s+="":s="";var R=t.find("#Crm_"+d+"_SEID_label_select").val()||t.find("#Crm_"+d+"_SEID_select").val(),b=t.find("#Crm_"+d+"_SEID"),M="$se_module";if((S=t.find("#Crm_"+d+"_CONTACTID_WhoId_select").val())||(h["property(modsel)"]=R,h["property(modname)"]=b.val(),""!=trimBoth(b.val())&&(h["property(modid)"]=b.data("id"))),/Events|Calls|Tasks/.test(a)&&"CONTACTID"==u&&S&&"None"!=S){var k=t.find("#Crm_"+d+"_CONTACTID").val();"Leads"==S||"Contacts"==S||"Accounts"==S?(h["property(leContModId)"]=s,h["property(leContModSel)"]=S,h["property(leContModName)"]=k,h["property(modsel)"]=R,h["property(modname)"]=b.val(),""!=trimBoth(b.val())&&(h["property(modid)"]=b.data("id")),"Contacts"===S?i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id):"Leads"===S&&(i.SEID=crmCallsNew.getColumnParamsObj(c,C,e.data().id),i.$se_module=crmCallsNew.getColumnParamsObj(M,void 0,S))):"Others"==S?(h["property(modsel)"]=R,h["property(modname)"]=b.val(),""!=trimBoth(b.val())&&(h["property(modid)"]=b.data("id"))):"PhoneNumbers"==S&&(h["property(Customer Number)"]=k),s=void 0}else if("SEID"==u)i.$se_module||(i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id),i.$se_module=crmCallsNew.getColumnParamsObj(M,void 0,R)),s=void 0;else{var A="true"==f.customfield?f.colname:f.name;h["property("+A+")"]=e.val()}if("Calls"===a&&isNewCallView&&"CONTACTID"===u&&validationUtils.isEmpty(h["property(leContModId)"]))if("ScheduledCall"==crmCallsNew.getCallStartTimeWithInfo(t.find("#Crm_Calls_CALLSTARTDATETIME"),t.find("#Crm_Calls_CALLSTARTDATETIME_TimeOption")).whichCall){var P=I18n.getMsg("crm.call.callto.empty.check.qcreate");renderingUtils.showCustomAlert(P),n=!1}else validationUtils.isEmpty(f.oldid)||(o.mandateFailed="true",n=!1);break;case"444":var L="";(s=e.data("id"))&&"null"!=s||(s=e.data("selectedid"))&&"null"!=s||(s=""),e.data("unselectedid")&&(L=e.data("unselectedid")),s=s+"-"+L;var S;R=t.find("#Crm_"+d+"_SEID_label_select").val()||t.find("#Crm_"+d+"_SEID_select").val(),b=t.find("#Crm_"+d+"_SEID");if("Tasks"===a||"Calls"===a)(S=t.find("#Crm_"+d+"_CONTACTID_WhoId_select").val())||(h["property(modsel)"]=R,h["property(modname)"]=b.val(),""!=trimBoth(b.val())&&(h["property(modid)"]=b.data("id")));if(/Events|Calls|Tasks/.test(a)&&"CONTACTID"==u&&S&&"None"!=S)"Leads"==S||"Contacts"==S?(h["property(leContModId)"]=s,h["property(leContModSel)"]=S,h["property(leContModName)"]=t.find("#Crm_"+d+"_CONTACTID").val(),h["property(modsel)"]=R,h["property(modname)"]=b.val(),""!=trimBoth(b.val())&&(h["property(modid)"]=b.data("id"))):"Others"==S&&(h["property(modsel)"]=R,h["property(modname)"]=b.val(),""!=trimBoth(b.val())&&(h["property(modid)"]=b.data("id"))),s=void 0;else if("SEID"==u)s=void 0;else if(-1!=u.indexOf("MXNDUMMYCOLUMN")){A="true"==f.customfield?f.colname:f.name;h["property("+A+")"]=s}else{A="true"==f.customfield?f.colname:f.name;h["property("+A+")"]=e.val()}if("Calls"===a&&isNewCallView&&"CONTACTID"===u&&validationUtils.isEmpty(h["property(leContModId)"]))if("ScheduledCall"==crmCallsNew.getCallStartTimeWithInfo(t.find("#Crm_Calls_CALLSTARTDATETIME"),t.find("#Crm_Calls_CALLSTARTDATETIME_TimeOption")).whichCall){P=I18n.getMsg("crm.call.callto.empty.check.qcreate");renderingUtils.showCustomAlert(P),n=!1}break;case"1234":var F=t.find("#Crm_"+a+"_REMINDAT").val();F&&"none"!=F&&"0"!=F&&(h.remCheckTask="on",h.remTime=F,h.remTaskRepeat="none");break;case"143":case"144":case"145":case"36":var U;y=m.maxlength-(U=m.decimalLength);if(s&&!currencyUtils.isValidCurrency(s,y,U))return o.checkFailed=!0,o.result=!1,o;validationUtils.decimalLengthCheck(s,U)||(o.decimalLengthCheckFailed=!0,n=!1)}if(null!=s&&"555"!=C&&(h[_]=s,u&&!i[u]&&("300"!==C&&"301"!==C||(s="on"===s),i[u]=crmCallsNew.getColumnParamsObj(c,C,s))),"Calls"===a&&"CALLDURATION"==u){w=t.find("#Crm_Calls_CALLDURATION_Mins").val()+":"+t.find("#Crm_Calls_CALLDURATION_Secs").val();i[u]=crmCallsNew.getColumnParamsObj(c,C,w),h["property(Call Duration)"]=w}s!==v&&(Crm.isRecordModified=!0)}return o.paramvalues=h,o.result=n,o},validateEntityAndShowErrorMsg:function(e,a,l,t,i,r){a=a||{},l=l||{};var s,n={},o="Calls";e.find(".mandatory").removeClass("mandatory");var d=!0,m=!0;return Calls.fieldSet.forEach((function(i){var d=e.find("#"+i);if(d.length){var c=d.data();if("116"==c.uitype||"117"==c.uitype||"RECURRING_WEEKLY_REPEAT"===d.colname)return;if((void 0===c.restricted||void 0!==c.restricted&&!c.restricted)&&c.readonly)return;if(isNewCallView&&!d.is(":visible")&&"SUBJECT"!=c.colname)return;var C=c.name,u=c.displaylabel;e.find("#errorMsg_"+d.attr("id")).remove(),d.closest(".tabDiv,.tabDivCreate").removeClass("errorFieldP"),"786"===c.uitype&&e.find("#"+i+"_TimeOption").closest(".tabDiv,.tabDivCreate").removeClass("errorFieldP");var v=crmCallsNew.validateEntity(d,o,true,e,n,t);for(var p in v.paramvalues)a[p]=v.paramvalues[p];l&&"scheduleCallUpdate"===l.subtype&&"Call_Duration"===c.sysrefname&&0===parseInt(a["property(DurationInMinute)"])&&0===parseInt(a["property(DurationInSecond)"])&&(v.result=!1,v.inboundCondition=!0);var _=r||0;for(var f in n)if(n.hasOwnProperty(f)){var h=0==_?"columnName":"columnName"+_,y=0==_?"fieldValue":"fieldValue"+_,I=0==_?"fieldLabel":"fieldLabel"+_,T=n[f];l[h]=f,l[y]=T.paramValue,l[I]=T.fieldLabel,_++}!(m=v.result?m:v.result)&&!s&&d&&d[0]&&(s=d),Crm.showErrorMessage(v,d,o,C,u,c)}})),d=!!m&&d,s&&("SELECT"===s[0].nodeName?(s.focus(),s.select2("open")):s.focus()),d},getColumnParamsObj:function(e,a,l){var t={};return t.fieldLabel=e,t.uitype=a,t.paramValue=l,t},submitCreate:function(){var e=$("#saveCallBtn"),a=$("#startCallingBtn"),l=$("#c2cResolveBtn");return e.is(":visible")?e.click():a.is(":visible")?a.click():l.is(":visible")&&l.click(),!1},filterBestTimeClicked:function(e){var a=$L(e),l=a.parent();l.find("li:not(.bestTime)").toggle(),l.find("ul").scrollTop(0);var t=a.data("hovermessage");t=t===I18n.getMsg("crm.best.time.tooltip.show.best.time")?I18n.getMsg("crm.best.time.tooltip.show.all.time"):I18n.getMsg("crm.best.time.tooltip.show.best.time"),a.data("hovermessage",t)},filterBestTimeHovered:function(e){var a=$(e).data("hovermessage");crmui.showTooltip({content:a,position:"showOnRight"})},isOutboundCall:function(e){var a;return store.peekRecord("module",moduleRecordMapping.Calls.id).fields.forEach((function(l){"Call_Type"===l.api_name&&l.pick_list_values.forEach((function(l){l.display_value===e&&(a=l.actual_value)}))})),"Outbound"===a},isOpenCall:function(e){var a=store.peekRecord("module",moduleRecordMapping.Calls.id).fields,l=e;return a.forEach((function(a){"Outgoing_Call_Status"===a.api_name&&a.pick_list_values.forEach((function(a){a.display_value===e&&(l=a.actual_value)}))})),"Scheduled"===l||"Overdue"===l}};