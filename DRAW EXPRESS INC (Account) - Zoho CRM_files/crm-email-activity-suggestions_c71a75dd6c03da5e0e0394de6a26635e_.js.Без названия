store.registerModel("activity_suggestions",{id:Lyte.attr("string"),name:Lyte.attr("string"),modified_time:Lyte.attr("string")},{actions:{update:{}}}),store.registerAdapter("activity_suggestions",{namespace:"crm/v5",buildURL:function(t,e,i,a,s,o,r){return s="update"===o?s.replace("activity_suggestions/actions/update",r.module+"/"+r.entityId+"/Emails/"+r.msgid+"/activity_suggestions"):s.replace("activity_suggestions",r.module+"/"+r.id+"/Emails/"+r.msgid+"/activity_suggestions")},methodForRequest:function(t){return"PATCH"===t?"PUT":t}}),store.registerSerializer("activity_suggestions",{serialize:function(t,e,i,a){if("update"===t){var s={};return s.id=a.linked_record,e.activity_suggestions[0].linked_record=s,delete e.activity_suggestions[0].dirty,e.activity_suggestions[0].id=a.activityid,e}if("action"===t)return(e={}).activity_suggestions=[],e.activity_suggestions[0]={},e.activity_suggestions[0].id=a.massmailid,e.activity_suggestions[0].activities=[],e.activity_suggestions[0].activities[0]={},e.activity_suggestions[0].activities[0].id=a.activityid,e.activity_suggestions[0].activities[0].linked_record={},e.activity_suggestions[0].activities[0].linked_record.id=a.linked_record,e},normalizeResponse:function(t,e,i){if("findAll"===e){store.unloadAll("activity_suggestions");var a={};if(i.activity_suggestions&&i.activity_suggestions[0]&&i.activity_suggestions[0].activities){for(var s=i.activity_suggestions[0].activities,o=i.activity_suggestions[0].activities.length,r=0;r<o;r++){var n=s[r];"Events"===n.module.api_name?i.activity_suggestions[0].activities[r]={time:n.linked_record?n.linked_record.Start_Date_Time:void 0,linked_record:n.linked_record?n.linked_record.id:void 0,is_created:!!n.linked_record,type:n.module.api_name,title:n.data.subject,id:n.id,End_Date_Time:n.data.End_Date_Time,Start_Date_Time:n.data.Start_Date_Time}:"Calls"===n.module.api_name?i.activity_suggestions[0].activities[r]={time:n.linked_record?n.linked_record.Call_Start_Time:void 0,linked_record:n.linked_record?n.linked_record.id:void 0,is_created:!!n.linked_record,type:n.module.api_name,title:n.data.subject,id:n.id,Call_Start_Time:n.data.Call_Start_Time}:"Tasks"===n.module.api_name&&(i.activity_suggestions[0].activities[r]={time:n.linked_record?n.linked_record.Due_Date:void 0,linked_record:n.linked_record?n.linked_record.id:void 0,is_created:!!n.linked_record,type:n.module.api_name,title:n.data.subject,id:n.id,Due_Date:n.data.Due_Date})}return a[t+"s"]=i.activity_suggestions,a}return a[t+"s"]=i.activity_suggestions,a}if("update"===e)return i.activity_suggestions[0]},methodForRequest:function(t){return"PATCH"===t?"PUT":t}}),Lyte.Component.register("crm-email-activity-suggestions",{_template:'<template tag-name="crm-email-activity-suggestions"> <lyte-modal lt-prop-close-on-escape="false" data-zcqa="activity_modal_closeBtn" lt-prop-allow-multiple="true" lt-prop-show="{{lbind(showActivitySuggestion)}}" id="activitysuggestion" lt-prop-freeze="true" on-close="{{method(&quot;close&quot;)}}" lt-prop-wrapper-class="ziaCallAnalyticswrapper" lt-prop="{&quot;width&quot; : &quot;600px&quot;, &quot;offset&quot; : {&quot;top&quot;:&quot;0px&quot;,&quot;left&quot;:&quot;center&quot;} }" lt-prop-show-close-button="true"> <template is="registerYield" yield-name="modal"> <lyte-modal-header class="activitysuggestionborderbottom"> <div class="w100_per dIB crm-font-bold crm-heading-font-size mB5"> {{label}} </div> </lyte-modal-header> <lyte-modal-content class="p0 pB30"> <template is="for" items="{{activityList}}" item="activity" index="index"> <div class="dIB w100_per activitysuggestionbordertop pL30 pR30 boxBB pT8 pB8"> <div class="flexAlignCenter spaceBetween"> <template is="if" value="{{activity.respActivityId}}"><template case="true"> <div class="dF"> <div class="w18 aligncenter"> <span class="{{activity.class}} zcicn-cssIcons vaM"></span> </div> <link-to class="mL10 mR10" data-zcqa="con_AcntDet" lt-prop-rel="noopener noreferrer" lt-prop-target="_blank" lt-prop-route="crm.tab.module.entity" lt-prop-dp="[&quot;{{activity.type}}&quot;,&quot;{{activity.respActivityId}}&quot;]" lt-prop-class="crmLinkColor cP">{{unescape(activity.text)}}</link-to> </div> </template><template case="false"> <div class="dF"> <div class="w18 aligncenter"> <span class="{{activity.class}} zcicn-cssIcons vaM"></span> </div> <div class="mL10 mR10">{{unescape(activity.text)}}</div> </div> </template></template> <template is="if" value="{{activity.is_created}}"><template case="true"> <div class="dIB vaM"> <crmutil-icon data-zcqa="activity_createdBtn" class="pT8 pB9" icon-name="tick-filled-md" icon-class="zcicn-tick-filled-md zcicn_green zcicn16"></crmutil-icon> </div> </template><template case="false"> <div class="dIB vaM"> <lyte-button class="mR0" data-zcqa="activity_{{activity.type}}" lt-prop-appearance="primary" onclick="{{action(&quot;eventCreation&quot;,activity)}}" lt-prop-class="outlineprimary"> <template is="registerYield" yield-name="text"> {{activity.label}} </template> </lyte-button> </div> </template></template> </div> </div> </template> </lyte-modal-content> </template> </lyte-modal> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1,1,1]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1]},{type:"for",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"if",position:[1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"attr",position:[1,3]},{type:"text",position:[1,3,0]},{type:"componentDynamic",position:[1,3]}]},false:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"text",position:[1,3,0]}]}},default:{}},{type:"attr",position:[1,1,3]},{type:"if",position:[1,1,3],cases:{true:{dynamicNodes:[{type:"componentDynamic",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"registerYield",position:[1,1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,1]}]}},default:{}}]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[1]}],_observedAttributes:["isFromCompose","showActivitySuggestion","showActivity","activityList","name","msgid","sourceIdentifier","label"],data:function(){return{isFromCompose:Lyte.attr("boolean",{default:!1}),showActivitySuggestion:Lyte.attr("boolean",{default:!1}),showActivity:Lyte.attr("boolean",{default:!1}),activityList:Lyte.attr("array",{default:[]}),name:Lyte.attr("string",{default:""}),msgid:Lyte.attr("string",{default:""}),sourceIdentifier:Lyte.attr("object",{default:{}}),label:Lyte.attr("string",{default:I18n.getMsg("crm.email.zia.activityv2.description")})}},actions:{eventCreation:function(t){switch(t&&(t.msgid=this.getData("msgid")),this.setData("sourceIdentifier",t),$L("#qCreate").addClass("ziaForEmailsCheck"),$L("#createEditCallDiv").addClass("ziaForEmailsCheck"),$L(".eventPop").addClass("ziaForEmailsCheck"),EmailCompose.aiData.activityId=t.id,t.type){case"Events":null===t.title&&(t.title=I18n.getMsg("crm.new.meeting")),activityCreate("events","Event",t.title,t.startMillis,t.endMillis,null,t.entityId,t.module);break;case"Calls":activityCreate("events",t.type,t.title,t.startMillis,null,null,t.entityId,t.module);break;case"Tasks":activityCreate("events","Task",t.title,t.endMillis,null,null,t.entityId,t.module)}}},methods:{close:function(){Lyte.registeredMixins["crm-email-activity-mixin"].closeAction(this)}},didConnect:function(){Lyte.addEventListener("beforeRouteTransition",this.hideFn)},hideFn:function(){var t=$L("#activitysuggestion")[0];t&&t.ltProp("show",!1)},init:function(){var t;this.getData("isFromCompose")?((t=store.peekAll("activity_suggestions"))&&t.length?(EmailCompose.aiData.massmailid=t[0].id,Lyte.registeredMixins["crm-email-activity-mixin"].objectConstruction(t[0].activities)):_cruxUtils.showCustomMessage({params:{ltPropType:"warning",ltPropYield:!0,ltPropCloseManually:!0,ltPropMessage:I18n.getMsg("crm.zia.CI.email.permission.denied")}}),store.unloadAll("activity_suggestions")):(t=this.getData("activityList"))&&t.length?(this.setData("activityList",[]),Lyte.registeredMixins["crm-email-activity-mixin"].objectConstruction(t)):_cruxUtils.showCustomMessage({params:{ltPropType:"warning",ltPropYield:!0,ltPropCloseManually:!0,ltPropMessage:I18n.getMsg("crm.zia.CI.email.permission.denied")}});this.setData("showActivitySuggestion","true")}},{mixins:["crm-email-activity-mixin.js"]}),Lyte.Mixin.register("crm-email-activity-mixin",{isToday:function(t){return $L.moment().toDate().toDateString()===t.toDateString()},isTomorrow:function(t){const e=$L.moment().toDate();return e.setDate(e.getDate()+1),e.toDateString()===t.toDateString()},convertDateTimeIntoUIFormat:function(t,e){var i=Crm.userDetails.TIME_FORMAT,a=t.substring(5,7),s=t.substring(8,10),o=Number(t.substring(11,13)),r=t.substring(14,16),n=o>=12?I18n.getMsg("crm.zia.CI.pm"):I18n.getMsg("crm.zia.CI.am"),c=t.substring(0,4),l="";l="HH:mm"===i?o+":"+r:(o=(o%=12)||12)+":"+r+" "+n;var d=t.split("T");return Lyte.registeredMixins["crm-email-activity-mixin"].isToday($L.moment(d[0]).toDate())?"Tasks"!==e?I18n.getMsg("acs.task.today")+" "+I18n.getMsg("crm.homepage.at")+"  "+l:I18n.getMsg("acs.task.today"):Lyte.registeredMixins["crm-email-activity-mixin"].isTomorrow($L.moment(d[0]).toDate())?"Tasks"!==e?I18n.getMsg("acs.task.tomorrow")+" "+I18n.getMsg("crm.homepage.at")+"  "+l:I18n.getMsg("acs.task.tomorrow"):"Tasks"!==e?I18n.getMsg("acs.month."+Number(a-1))+" "+s+", "+c+"  "+I18n.getMsg("crm.homepage.at")+"  "+l:I18n.getMsg("acs.month."+Number(a-1))+" "+s+", "+c},closeAction:function(t){$("#qCreate").removeClass("ziaForEmailsCheck"),$("#createEditCallDiv").removeClass("ziaForEmailsCheck"),$(".eventPop").removeClass("ziaForEmailsCheck"),t.$node.remove(),renderingUtils.removeFreezeLayer()},objectConstruction:function(t,e,i){var a=t.length,s=$L("crm-email-activity-suggestions")[0];if(s&&s.component){(s=s.component).setData("activityList",[]);var o=0;for(let e=0;e<a;e++){var r="",n=t[e];let i=n.type;if("Events"===i&&n.Start_Date_Time&&n.End_Date_Time){r=n.time?I18n.getMsg("crm.email.zia.activityv2.event.created",[Lyte.registeredMixins["crm-email-activity-mixin"].convertDateTimeIntoUIFormat(n.time,i)]):I18n.getMsg("crm.email.zia.activityv2.event",[Lyte.registeredMixins["crm-email-activity-mixin"].convertDateTimeIntoUIFormat(n.Start_Date_Time,i)]);var c={class:"zcicncss-calendar",respActivityId:n.linked_record?n.linked_record:void 0,is_created:!!n.is_created,label:I18n.getMsg("crm.zia.activity.meeting"),title:n.title,startMillis:$L.moment(n.Start_Date_Time).toDate().getTime(),endMillis:$L.moment(n.End_Date_Time).toDate().getTime(),type:i,text:r,id:n.id,module:s.getData("module"),entityId:s.getData("entityId")};Lyte.arrayUtils(s.getData("activityList"),"push",c)}else if("Calls"===i&&n.Call_Start_Time){r=n.time?I18n.getMsg("crm.email.zia.activityv2.call.created",Lyte.registeredMixins["crm-email-activity-mixin"].convertDateTimeIntoUIFormat(n.time,i)):I18n.getMsg("crm.email.zia.activityv2.call",Lyte.registeredMixins["crm-email-activity-mixin"].convertDateTimeIntoUIFormat(n.Call_Start_Time,i));c={class:"zcicncss-calls",respActivityId:n.linked_record?n.linked_record:void 0,is_created:!!n.is_created,label:I18n.getMsg("crm.zia.activity.call"),title:n.title,startMillis:$L.moment(n.Call_Start_Time).toDate().getTime(),endMillis:0,type:i,text:r,id:n.id,module:s.getData("module"),entityId:s.getData("entityId")};Lyte.arrayUtils(s.getData("activityList"),"push",c)}else if("Tasks"===i&&n.Due_Date){r=n.time?I18n.getMsg("crm.email.zia.activityv2.task.created",Lyte.registeredMixins["crm-email-activity-mixin"].convertDateTimeIntoUIFormat(n.time,i)):I18n.getMsg("crm.email.zia.activityv2.task",Lyte.registeredMixins["crm-email-activity-mixin"].convertDateTimeIntoUIFormat(n.Due_Date,i));c={class:"zcicncss-tasks",respActivityId:n.linked_record?n.linked_record:void 0,is_created:!!n.is_created,label:I18n.getMsg("crm.button.create.task"),title:n.title,startMillis:0,endMillis:$L.moment(n.Due_Date).toDate().getTime(),type:i,text:r,id:n.id,module:s.getData("module"),entityId:s.getData("entityId")};Lyte.arrayUtils(s.getData("activityList"),"push",c)}n.linked_record&&o++}try{1===a&&(s.setData("label",I18n.getMsg("crm.email.zia.activityv2.description2")),e&&e.getData("mailArray")[i.getData("index")]&&e.getData("mailArray")[i.getData("index")].hasOwnProperty("viewactivitylabel")&&Lyte.Component.set(e.getData("mailArray")[i.getData("index")],"viewactivitylabel",I18n.getMsg("crm.email.zia.activityv2.suggestions.available"))),a===o&&(e&&e.getData("mailArray")[i.getData("index")]&&e.getData("mailArray")[i.getData("index")].hasOwnProperty("activityCreated")&&Lyte.Component.set(e.getData("mailArray")[i.getData("index")],"activityCreated",!0),1===a?(s.setData("label",I18n.getMsg("crm.zia.activity.captured")),e&&e.getData("mailArray")[i.getData("index")]&&e.getData("mailArray")[i.getData("index")].hasOwnProperty("activityCreated")&&Lyte.Component.set(e.getData("mailArray")[i.getData("index")],"viewactivitylabel",I18n.getMsg("crm.zia.activity.view.activity"))):(s.setData("label",I18n.getMsg("crm.zia.activity.captured2")),e.getData("mailArray")[i.getData("index")]&&e.getData("mailArray")[i.getData("index")].hasOwnProperty("activityCreated")&&Lyte.Component.set(e.getData("mailArray")[i.getData("index")],"viewactivitylabel",I18n.getMsg("crm.zia.activity.view.activity2"))))}catch(t){murphy.error(t)}}},errorHandling:function(t){var e=$L("crm-email-activity-suggestions")[0];e&&(e=e.component),"AUTHENTICATION_FAILURE"===t.code&&_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.zia.CI.email.permission.denied"),ltPropType:"error",ltPropDuration:"2000"}})},errorHandling:function(t){("AUTHENTICATION_FAILURE"===t.code&&"authentication error"===t.message||"NO_PERMISSION"===t.code)&&_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.zia.CI.email.permission.denied"),ltPropType:"error",ltPropDuration:"3000"}})},entityUpdateCall:function(t,e){var i=e;if(t&&t.sourceIdentifier&&!t.isFromCompose)var a={linked_record:e.entityId,activityid:t.sourceIdentifier.id,module:t.module?t.module:EmailCompose.aiData.module,entityId:t.entityId?t.entityId:EmailCompose.aiData.entityId,msgid:t.msgid?t.msgid:EmailCompose.aiData.msgid,massmailid:t.massmailid?t.massmailid:void 0};else a={linked_record:e.entityId,activityid:EmailCompose.aiData.activityId,module:EmailCompose.aiData.module,entityId:EmailCompose.aiData.entityId,msgid:EmailCompose.aiData.msgid,massmailid:t.massmailid?t.massmailid:void 0};a.msgid||(a.msgid=EmailCompose.aiData.msgid),i.msgidAPI=a.msgid,i.entityIdAPI=a.entityId,i.moduleAPI=a.module,Crm.client_tracking("Email Intelligence - Activity created"),store.triggerAction("activity_suggestions","update",a,void 0,"PUT").then((function(){var t=$L("crm-email-activity-suggestions")[0];t&&(t=t.component);var e={module:i.moduleAPI,id:i.entityIdAPI,msgid:i.msgidAPI};store.findAll("activity_suggestions",{include_inner_details:"linked_record->Events.Start_Date_Time,linked_record->Tasks.Due_Date,linked_record->Calls.Call_Start_Time"},void 0,void 0,e).then((function(e){if(e){let a=$L("crm-emailconversation-view")[0];var i;a&&(i=a.component),i&&e[0].activities?Lyte.registeredMixins["crm-email-activity-mixin"].objectConstruction(e[0].activities,i,t):e[0].activities&&Lyte.registeredMixins["crm-email-activity-mixin"].objectConstruction(e[0].activities,void 0,void 0)}}),(function(t){var e=JSON.parse(t.response);Lyte.registeredMixins["crm-email-activity-mixin"].errorHandling(e)}))}),(function(t){var e=JSON.parse(t.response);Lyte.registeredMixins["crm-email-activity-mixin"].errorHandling(e)}))}});
