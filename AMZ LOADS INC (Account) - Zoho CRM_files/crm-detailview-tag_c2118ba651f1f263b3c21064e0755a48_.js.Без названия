Lyte.Component.register("crm-detailview-tag",{_template:'<template tag-name="crm-detailview-tag"> <template is="if" value="{{expHandlers(from,\'==\',&quot;import&quot;)}}"><template case="true"> <crux-tag id="importtag" cx-prop-scope="#ITF-container .itb-body-class" cx-prop-class="hello" cx-prop-tag-options="{{tagarray}}" cx-prop-tags="{{selectedtags}}" cx-prop-allow-dropdown="true" cx-prop-comma-seperation="true" cx-prop-prevent-key-list="[&quot;<&quot;,&quot;>&quot;,&quot;,&quot;]" on-error="{{method(\'onError\')}}" on-before-add-tag="{{method(&quot;validate_tags&quot;)}}" on-before-remove-tag="{{method(&quot;beforeremove&quot;)}}" on-color-tag-palette-hide="{{method(&quot;hideColor2&quot;)}}"> </crux-tag> </template><template case="false"> <div class="crm-detailview-tag"> <template is="if" value="{{expHandlers(displaytags.length,\'>\',0)}}"><template case="true"> <lyte-nav class="dvTagView pL25 pR mT5 dF aiCenter"> <template is="if" value="{{add_tag}}"><template case="true"> <span class="zcicncss-tag zcicn-cssIcons zcicn_grey_mask mR7 vaM pA left0 top2 dvTagIcon"></span> </template></template> <crux-tag-component data-zcqa="cruxTagCompdetailView" class="dIB vaM {{if(ifEquals(inEditMode,\'true\'),\'vH\',\'\')}}" cx-prop-module="{{module}}" cx-prop-trigger-tag-click="true" cx-prop-clip-mode="true" cx-prop-value="{{displaytags}}" cx-prop-is-color-code-enabled="true" cx-prop-width="{{expHandlers(tagscompwidth,\'+\',&quot;px&quot;)}}" cx-prop-redirect-url="{{redirectUrl}}"></crux-tag-component> <span data-zcqa="cruxTagComponentTagEditIcon" class="zcicncss-editFilled-hover tagEditIcon cP vH vaM mT1 mL5 zcicn-cssIcons zcicncss13 {{if(ifEquals(inEditMode,true),\'hide\',\'\')}} {{if(ifEquals(isRecordLocked,true),\'noEventTag\',\'\')}} {{if(ifEquals(cursor,true),\'defcursor\',\'\')}} {{if(ifNotEquals(tooltip,getI18n(\'crm.label.add.tags\')),\'addPermissionDenied\',\'\')}}" onclick="{{action(\'showAddTag\')}}" lt-prop-tooltip-config=" { &quot;showdelay&quot;:500,&quot;appearance&quot;:&quot;box&quot;,&quot;position&quot;:&quot;bottomright&quot;,&quot;margin&quot;:10} " tabindex="0" lt-prop-aria-keydown="true" role="button" aria-label="{{getI18n(\'crm.button.edit\')}}" lt-prop-title="{{tooltip}}"></span> </lyte-nav> </template><template case="false"> <div class="mT4"> <template is="if" value="{{add_tag}}"><template case="true"> <span class="zcicncss-tag zcicn-cssIcons zcicn_grey_mask dvTagIcon dIB vaM"></span> <span data-zcqa="detailViewLyteAddTag" tabindex="0" class="dIB vaM crm-base-font-size cP add_tag crmBaseColor accessibility-clickable-elem {{if(ifEquals(cursor,true),\'defcursor\',\'\')}} {{if(ifNotEquals(tooltip,getI18n(\'crm.label.add.tags\')),\'addPermissionDenied\',\'\')}}" lt-prop-tooltip-config=" { &quot;showdelay&quot;:500,&quot;appearance&quot;:&quot;box&quot;,&quot;position&quot;:&quot;bottomright&quot;,&quot;margin&quot;:10} " lt-prop-title="{{tooltip}}" onclick="{{action(\'showAddTag\')}}" lt-prop-aria-keydown="true" role="button" aria-label="{{getI18n(\'crm.label.add.tags\')}}">{{getI18n(\'crm.label.add.tags\')}}</span> </template></template> </div> </template></template> </div> <lyte-popover id="detailview_add_tag" lt-prop-width="570px" lt-prop-origin-elem=".crm-detailview-tag .dvTagIcon" lt-prop-placement="bottomLeft" lt-prop-freeze="false" lt-prop-show-close-button="false" lt-prop-show="false" lt-prop-wrapper-class="detailview_add_tag" lt-prop-type="box" lt-prop-boundary="{&quot;left&quot;:&quot;100&quot;,&quot;top&quot;:&quot;0&quot;}" lt-prop-content-padding="13px 35px" lt-prop-footer-padding="5px 35px 25px" lt-prop-close-on-body-click="true" lt-prop-allow-multiple="true" on-before-close="{{method(&quot;open_pop&quot;)}}"> <template is="registerYield" yield-name="popover"> <lyte-popover-content> <span class="zcicncss-tag zcicn-cssIcons zcicn_grey_mask pA mR7 left10 top20"></span> <crux-tag id="defaulttag" cx-prop-id="view" cx-prop-tag-options="{{tagarray}}" cx-prop-tags="{{selectedtags}}" cx-prop-allow-dropdown="true" cx-prop-comma-seperation="true" cx-prop-prevent-key-list="[&quot;<&quot;,&quot;>&quot;,&quot;,&quot;]" on-before-add-tag="{{method(&quot;validate_tags&quot;)}}" on-before-remove-tag="{{method(&quot;beforeremove&quot;)}}" on-error="{{method(\'onError\')}}" on-color-tag-palette-hide="{{method(&quot;hideColor&quot;)}}"> </crux-tag> </lyte-popover-content> <lyte-popover-footer class="alignRight"> <lyte-button lt-prop-size="small" lt-prop-tabindex="0" onclick="{{action(\'hideAddTag\')}}" lt-prop-appearance="default" data-zcqa="canceltag_btn"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.button.cancel\')}} </template> </lyte-button> <lyte-button lt-prop-appearance="primary" lt-prop-tabindex="0" lt-prop-size="small" onclick="{{action(\'savetags\')}}" lt-prop-disabled="{{lbind(saveEnabled)}}" data-zcqa="savetag_btn"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.button.save\')}} </template> </lyte-button> </lyte-popover-footer> </template> </lyte-popover> </template></template> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[]}},default:{}},{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]},{type:"attr",position:[1,5]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[3]},{type:"text",position:[3,0]}]}},default:{}}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1]},{type:"registerYield",position:[3,1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[3,1]},{type:"attr",position:[3,3]},{type:"registerYield",position:[3,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[3,3]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[3]}]}},default:{}}],_observedAttributes:["tagarray","selectedtags","idvsname","module","removedtags","displaytags","tagscompwidth","cvid","tagnamevstagid","tagidvstagname","tag","tagnamevsmodrefid","added_count","saveEnabled","tagnames","tooltip","added_count","from","add_tag","tagged_icon","isActivitySplitDone","sandboxAccount","cursor","showMoreTags","inEditMode","tagValuesNew","recordTagCount","editionCount","entityId","recordLockedinGDPR","tagsPermissionAvail","recordLockingDetails","approvalState","rerenderTagsComponent","isRecordLocked","sharingPermission","redirectUrl"],data:function(){return{tagarray:Lyte.attr("array",{default:[]}),selectedtags:Lyte.attr("array",{default:[]}),idvsname:Lyte.attr("object",{default:{}}),module:Lyte.attr("string",{default:""}),removedtags:Lyte.attr("string",{default:""}),displaytags:Lyte.attr("array",{default:[]}),tagscompwidth:Lyte.attr("number",{default:0}),cvid:Lyte.attr("string",{default:""}),tagnamevstagid:Lyte.attr("object",{default:{}}),tagidvstagname:Lyte.attr("object",{default:{}}),tag:Lyte.attr("array",{default:[]}),tagnamevsmodrefid:Lyte.attr("object",{default:{}}),added_count:Lyte.attr("number",{default:0}),saveEnabled:Lyte.attr("boolean",{default:!0}),tagnames:Lyte.attr("array",{default:[]}),tooltip:Lyte.attr("string",{default:""}),added_count:Lyte.attr("number",{default:0}),from:Lyte.attr("string",{default:"detailview"}),add_tag:Lyte.attr("boolean",{default:!0}),tagged_icon:Lyte.attr("boolean",{default:!0}),isActivitySplitDone:Lyte.attr("boolean"),sandboxAccount:Lyte.attr("boolean",{default:!1}),cursor:Lyte.attr("boolean",{default:!1}),showMoreTags:Lyte.attr("boolean",{default:!1}),inEditMode:Lyte.attr("boolean",{default:!1}),tagValuesNew:Lyte.attr("object",{default:{}}),recordTagCount:Lyte.attr("number",{default:0}),editionCount:Lyte.attr("number",{default:0}),entityId:Lyte.attr("string",{default:""}),recordLockedinGDPR:Lyte.attr("boolean",{default:!1}),tagsPermissionAvail:Lyte.attr("boolean",{default:!1}),recordLockingDetails:Lyte.attr("object",{default:{}}),approvalState:Lyte.attr("string",{default:""}),rerenderTagsComponent:Lyte.attr("boolean",{default:!1}),isRecordLocked:Lyte.attr("boolean",{default:!1}),sharingPermission:Lyte.attr("boolean",{default:!1}),redirectUrl:Lyte.attr("string")}},tagnamevscolor:[],init:function(){var t=moduleRecordMapping[this.getData("module")];if(t.timeline_view||t.canvas_view||t.card_view||t.table_view||t.kanban_view||t.chart_id&&t.chart_view_supported&&t.chart_view){var e=this.getCurrentListViewURL(this.getData("module")),a=t.canvas_view||t.card_view||t.table_view?"&":"?";this.setData("redirectUrl",e+a)}if(void 0===this.getData("redirectUrl")){var o=this.getData("module");e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.list",dynamicParams:[o,moduleRecordMapping[o].cvid]});this.setData("redirectUrl",e+"?")}if("import"!==this.getData("from")){o=this.getData("module");this.setData("isActivitySplitDone",Crm.isActivitySplitDone),moduleRecordMapping[o].custom_view&&("Tasks"!==o&&"Calls"!==o&&"Events"!==o||this.getData("isActivitySplitDone")?this.setData("cvid",moduleRecordMapping[o].custom_view.id):this.setData("cvid",moduleRecordMapping.Activities.custom_view.id))}if(!0!==isSandboxAcc&&"true"!==isSandboxAcc||this.setData("sandboxAccount",!0),void 0!==moduleRecordMapping[o]&&void 0!==store.peekRecord(moduleRecordMapping[o].id,detailView.entityId)){var i=[];if(i=Crm.lyteHeaderNeeded(o)?this.getData("tagValuesNew").Tag:store.peekRecord(moduleRecordMapping[o].id,detailView.entityId).Tag,this.setData("displaytags",i),void 0!==i){var r=i.length;r>3&&this.setData("count",r-3)}}this.setData({recordLockedinGDPR:this.getData("tagValuesNew").$stop_processing,sharingPermission:"read_only"===this.getData("tagValuesNew").$sharing_permission,tagsPermissionAvail:Crm.userDetails.permissions.hasOwnProperty("Crm_Implied_Tags_"+this.getData("module")),approvalState:this.getData("approvalState")})},didConnect:function(){var t=this,e=t.getData("module");if("Activities"===e&&(e=$("#module").val()),"Events"===e){var a=t.calculateTagsComponentWidth(t.getData("module"));t.setData("tagscompwidth",a),$L(".dv_profileTitle_cont").css({width:a+"px"})}"detail"===Lyte.Router.getRouteInstance().routeName&&window.addEventListener("resize",this.applyResizeHeight),$L("#detailviewTags").empty(),$L("#detailviewInfo").empty(),t.setData("module",e),t.setData("entityId",t.getData("tagValuesNew").id);var o=moduleRecordMapping[e].api_name,i=t.getData("tagValuesNew").Tag;if("Free"===Crm.userDetails.EDITION_NAME||"Starter"===Crm.userDetails.EDITION_NAME)"Free"===Crm.userDetails.EDITION_NAME?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.records.downgrade.free.edition")):(this.setData("tagged_icon",!1),this.setData("add_tag",!1)),t.disablecursor("default");else{var r=moduleRecordMapping[e].module_name;"linking"==Crm.userDetails.MODULE_LIST[r].generated_type||Crm.userDetails.MODULE_LIST[r].parent_module&&"Orchestration"==Crm.userDetails.MODULE_LIST[r].parent_module.module_name?(this.setData("tagged_icon",!1),this.setData("add_tag",!1),$(".tagged_icon").hide(),t.disablecursor("default")):("detail"!==Lyte.Router.getRouteInstance().routeName&&"entity"!==Lyte.Router.getRouteInstance().routeName&&store.unloadAll("tag"),store.findAll("tag",{module:o,fromPage:"view"},!0,!0).then((function(e){void 0===t.getData("tag")&&(t=$L("crm-detailview-tag")[0].component),t.setData({tag:e,recordTagCount:e.$.meta.record_limit,editionCount:e.$.meta.allowed_count});var a=0;t.getData("tagValuesNew").Tag&&(a=t.getData("tagValuesNew").Tag.length),a>3&&t.setData("count",a-3);var o=e.length,r={},s={},d={},n={};for(c=0;c<o;c++)Lyte.objectUtils(t.getData("idvsname"),"add",e[c].modRefId,e[c].name),r[e[c].name]=e[c].id,d[e[c].name]=e[c].modRefId,n[e[c].name]=e[c].color_code,s[e[c].id]=[e[c].name],name=e[c].name,"detailview"!==t.getData("from")||t.getData("tagarray").includes(e[c].modRefId)||Lyte.arrayUtils(t.getData("tagarray"),"push",{name:name,id:e[c].id,color_code:e[c].color_code}),Lyte.arrayUtils(t.getData("tagnames"),"push",name);t.setData("tagnamevstagid",r),t.setData("tagnamevsmodrefid",d),t.setData("tagnamevscolor",n),t.setData("tagidvstagname",s);var l=0;void 0!==i&&(l=i.length);for(var g=[],c=0;c<l;c++)g.push(i[c].name);for(var p=g.length,m=[],u=0;u<p;u++)m.push(d[g[u]]);var v=t.getData("idvsname");t.setData("selectedtags",[]);for(c=0;c<l;c++){var D=v[m[c]],h={name:D,id:r[D],color_code:n[D]};Lyte.arrayUtils(t.getData("selectedtags"),"push",h)}if(void 0===t.getData("displaytags")||0===t.getData("displaytags").length){var y=t.getData("selectedtags").slice();t.setData("displaytags",y)}var f=$L("#ApprovalProcess").children().length,_=t.getData("approvalState")&&"approved"!==t.getData("approvalState")&&"approval_process_rejected"!==t.getData("approvalState"),L=t.getData("approvalState")&&"approved"!==t.getData("approvalState")&&"approval_process_rejected"!==t.getData("approvalState")&&"approval_process_pending"!==t.getData("approvalState")&&"review_process_rejected"!==t.getData("approvalState"),w=t.getData("recordLockingDetails")?t.getData("recordLockingDetails").isLocked&&t.getData("recordLockingDetails").restricted_actions.includes("tags"):detailView.recordLockingDetails&&detailView.recordLockingDetails.lockedRecordDetails&&detailView.recordLockingDetails.lockedRecordDetails.length>0&&detailView.recordLockingDetails.lockingConfigJSON[0]&&detailView.recordLockingDetails.lockingConfigJSON[0].restricted_actions.contains("tags"),b=t.getData("recordLockedinGDPR"),C=t.getData("sharingPermission"),R=t.getData("tagsPermissionAvail");if(C||Crm.userDetails.ISROMODE||_||L||w||b||!R||Crm.userDetails.CLIENT_ACCOUNT)if(L?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.reviewprocess.detailview.create.no.permission.msg")):_?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")):Crm.userDetails.CLIENT_ACCOUNT?(t.setData("tagged_icon",!1),$L(".tagged_icon").hide(),t.setData("add_tag",!1),t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"))):R?w||b?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.lock.tag.restricted")):m.length>0||0==t.getData("selectedtags").length&&f||!f||C?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")):t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags")):(t.setData("tagged_icon",!1),$L(".tagged_icon").hide(),t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"))),"import"!==t.getData("from")){t.disablecursor();n=this.tagnamevscolor}else $("#importTagFieldId").empty();else w?(t.setData("add_tag",!1),t.setData("tagged_icon",!1),t.disablecursor("default"),$L(".tag_edit_icon").hide()):t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags"))}),(function(){t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"));var e=$L(".add_tag"),a=$L(".tag_edit_icon");(e.length>0||a.length>0)&&t.setData("cursor",!0)})))}},applyResizeHeight:function(){if(this.tagDVComp||(this.tagDVComp=$L("crm-detailview-tag")),this.tagDVComp&&this.tagDVComp[0]&&this.tagDVComp[0].component&&null!==this.tagDVComp[0].component){var t=this.tagDVComp[0].component,e=t.calculateTagsComponentWidth(t.getData("module"));t.setData("tagscompwidth",e),$L(".dv_profileTitle_cont").css({width:e+50+"px"})}},rerenderComponent:function(){var t=this,e=t.getData("recordLockingDetails");if(e){var a=e.restricted_actions.includes("tags");t.setData("isRecordLocked",a)}this.resetToolTipValue(t)}.observes("recordLockingDetails","recordLockedinGDPR","approvalState"),resetToolTipValue:function(t){var e=t.getData("approvalState")&&"approved"!==t.getData("approvalState")&&"approval_process_rejected"!==t.getData("approvalState"),a=t.getData("approvalState")&&"approved"!==t.getData("approvalState")&&"approval_process_rejected"!==t.getData("approvalState")&&"approval_process_pending"!==t.getData("approvalState")&&"review_process_rejected"!==t.getData("approvalState"),o=!!t.getData("recordLockingDetails")&&(t.getData("recordLockingDetails").isLocked&&t.getData("recordLockingDetails").restricted_actions.includes("tags")),i=t.getData("recordLockedinGDPR"),r=t.getData("tagsPermissionAvail");Crm.userDetails.ISROMODE||e||a||o||i||!r?a?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.reviewprocess.detailview.create.no.permission.msg")):e?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")):r?o||i?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.lock.tag.restricted")):t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags")):t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")):o?(t.setData({add_tag:!1,tagged_icon:!1}),t.disablecursor("default"),$L(".tag_edit_icon").hide()):(t.enablecursor(!0),t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags")))},getCurrentListViewURL:function(t){if(t&&moduleRecordMapping[t]&&moduleRecordMapping[t].cvid){var e="";return moduleRecordMapping[t].kanban_view?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.kanban",dynamicParams:[t,moduleRecordMapping[t].cvid]}):moduleRecordMapping[t].chart_view?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.chart",dynamicParams:[t,moduleRecordMapping[t].cvid]}):moduleRecordMapping[t].canvas_view&&moduleRecordMapping[t].viewid?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.canvas",dynamicParams:[t,moduleRecordMapping[t].cvid,moduleRecordMapping[t].viewid],queryParams:{viewType:"CustomizedView"}}):moduleRecordMapping[t].card_view&&moduleRecordMapping[t].cardid?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.canvas",dynamicParams:[t,moduleRecordMapping[t].cvid,moduleRecordMapping[t].cardid],queryParams:{viewType:"CardView"}}):moduleRecordMapping[t].table_view&&moduleRecordMapping[t].tableid?e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.canvas",dynamicParams:[t,moduleRecordMapping[t].cvid,moduleRecordMapping[t].tableid],queryParams:{viewType:"TableView"}}):moduleRecordMapping[t].timeline_view&&(e=Lyte.Router.getURL({route:"crm.tab.module.custom-view.timeline",dynamicParams:[t,moduleRecordMapping[t].cvid]})),e}},disablecursor:function(t){var e=$L(".add_tag"),a=$L(".tag_edit_icon");e.length>0?(e[0].setAttribute("click",""),void 0!==t&&e.css("cursor",t)):a.length>0&&(a[0].setAttribute("click",""),a.css("cursor",t))},enablecursor:function(t){var e=$L(".add_tag"),a=$L(".tag_edit_icon");e.length>0?(e[0].setAttribute("click","crm-detailview-tag => showAddTag()"),void 0!==t&&e.css("cursor",t)):a.length>0&&(a[0].setAttribute("click","crm-detailview-tag => showAddTag()"),a.css("cursor",t))},addTags:function(t){var e=this,a=e.getData("module");a="Activities"===a?store.peekRecord(moduleRecordMapping.Activities.id,selectedIds[0]).$activity_type:a;var o,i=e.getData("selectedtags"),r=[];if(o=Crm.renderDVLyteFlow(a)?e.getData("entityId"):detailView.entityId,0===i.length){var s=e.getData("removedtags"),d=0;if(1===(d=s.includes(",")?(s=s.split(",")).length:1)){var n={name:s};r.push(n)}else for(var l=0;l<d;l++){n={name:s[l]};r.push(n)}var g={tags:r,ids:o.toString()};e.addtagstoRec(e,g,o,!1,a,"detailview","remove",t,i.map((t=>t.name)),e.getData("displaytags").map((t=>t.name)))}else{var c=i.length;for(l=0;l<c;l++){var p=i[l].color_code;"#noFill"!==p&&"noFill"!==p||(p=null);n={name:i[l].name.replace(/  +/g," "),color_code:p};r.push(n)}g={tags:r,ids:o,over_write:!0};e.addtagstoRec(this,g,o,!0,moduleRecordMapping[a].api_name,"detailview","add",t,i.map((t=>t.name)),e.getData("displaytags").map((t=>t.name)))}},afteradd_detailview:function(t,e,a,o,i){CScriptLib&&(i?i.resolve_cscript():CScript.Engine.Global.dispatchEvent("onTagChanged",void 0,a.map((t=>({name:t}))),(a.diff(o)||[]).map((t=>({name:t}))),(o.diff(a)||[]).map((t=>({name:t}))))),t.setData("tag",e);var r=t.getData("tagnamevsmodrefid"),s=e.data[0].details.tags,d=s.length,n=[],l="";t.setData("selectedtags",[]),t.setData("displaytags",[]);for(var g=this.getData("tagnamevscolor"),c=0;c<d;c++){var p=s[c].name;l=r[p],n.push(l);var m={name:p,color_code:s[c].color_code};Lyte.arrayUtils(t.getData("selectedtags"),"push",m),Lyte.arrayUtils(t.getData("displaytags"),"push",m),void 0===g[p]&&(g.tag_name=s[c].color_code)}t.setData("tagnamevscolor",g),Crm.renderDVLyteFlow(t.getData("module"))?t.setData(t.getData("tagValuesNew").Tag,n):CrmTags.clientJSON.value=n;var u=n.length,v=t.getData("selectedtags");u>3&&t.setData("count",v.length-3),t.setData("removedtags","");var D=t.getData("tagarray"),h=t.getData("tagnamevsmodrefid");t.setData("tagarray",[]);var y=[];y=Crm.renderDVLyteFlow(t.getData("module"))?t.getData("tagValuesNew").Tag:CrmTags.clientJSON.value;var f=D.length;for(c=0;c<f;c++){var _=D[c].name;if(!y.includes(h[_])){m={name:_,color_code:g[_]};Lyte.arrayUtils(t.getData("tagarray"),"push",m)}}store.peekRecord(moduleRecordMapping[t.getData("module")].id,detailView.entityId)&&(store.peekRecord(moduleRecordMapping[t.getData("module")].id,detailView.entityId).Tag=t.getData("selectedtags")),CrmTags.edited=!0;var L=e.data.length;for(c=0;c<L;c++){var w=e.data[c];void 0!==w.details.$approval_state&&"approval_process_pending"===w.details.$approval_state&&reloadCurrentEntityView()}document.getElementById("detailview_add_tag").ltProp("show",!1),this.setData("inEditMode",!1),commonUtils.showHideLoadingDiv(!1),crmTab.deleteFromCache(t.getData("module"))},aftercreate_dv:function(t,e){if(e){for(var a=e.length,o=t.getData("tagnamevstagid"),i=t.getData("tagnamevsmodrefid"),r=t.getData("tagnamevscolor"),s=t.getData("tagnames"),d=0;d<a;d++){var n=e[d],l=n.modRefId,g=n.name;Lyte.objectUtils(t.getData("idvsname"),"add",l,g),o[g]=n.id,i[g]=l,r[g]=n.color_code,Lyte.objectUtils(t.getData("tagidvstagname"),"add",n.id,g);g=e[d].name;t.getData("tagnames").indexOf(g)&&Lyte.arrayUtils(t.getData("tagarray"),"push",{name:g,id:n.id,color_code:n.color_code}),s.push(g)}t.setData("tagnamevstagid",o),t.setData("tagnamevsmodrefid",i),t.setData("tagnamevscolor",r),t.setData("tagnames",s),t.addTags()}},methods:{onError:function(t,e){if(1===e.errorCode){renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.need.alphanumeric.characters"));var a=document.querySelector("#defaulttag");null!==a&&(a.blur(),a.toggle("close"))}},validate_tags:function(t){var e;if(!(e=this.getData("tagnames").contains(t)?this.validatetags(t,this.getData("recordTagCount"),this.getData("selectedtags").length+1,0,0,"add","dv"):this.validatetags(t,this.getData("recordTagCount"),this.getData("selectedtags").length+1,this.getData("editionCount"),this.getData("tag").length+this.getData("added_count")+1,"add","dv"))){var a=document.querySelector("#defaulttag");return null!==a&&(a.blur(),a.toggle("close")),!1}if(!this.getData("tagnames").contains(t)){var o=this.getData("added_count");this.setData("added_count",o+1)}if(!e)return e;if(this.setData("saveEnabled",!1),"import"===this.getData("from")){var i=$L("#tagConfig");this.getData("tagnames").contains(t)||$("<input>",{type:"hidden",id:"newTags",name:"newTags",val:$ESAPI.encoder().encodeForHTML(t)}).appendTo(i)}return CrmTags.checkCharacter(t,!0)?void 0:(renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.need.alphanumeric.characters")),a.blur(),a.toggle("close"),!1)},beforeremove:function(t){if(!this.data.tagnames.contains(t)){var e=this.getData("added_count");e--,this.setData("added_count",e)}var a=this.getData("removedtags"),o=null,i=null;a=""!==a?a+","+t:t;var r=this.getData("selectedtags"),s=r.length;for(c=0;c<s;c++){var d=r[c];if(d.name!==t||d.hasOwnProperty("isNewTag")){if(d.name===t&&d.hasOwnProperty("isNewTag")){e=this.getData("added_count");return this.setData("added_count",e),this.setData("removedtags",a),void this.setData("saveEnabled",!1)}}else o=d.color_code,d.hasOwnProperty("id")&&(i=d.id)}this.setData("removedtags",a),this.setData("saveEnabled",!1);for(var n=this.getData("tagarray"),l=n.length,g=!1,c=0;c<l;c++)n[c].name===t&&(g=!0);g||Lyte.arrayUtils(this.getData("tagarray"),"push",{name:t,color_code:o,id:i})},open_pop:function(){return null==document.querySelector(".alertPopup")&&(this.getData("inEditMode")?(this.setData("inEditMode",!1),!0):void 0)},hideColor:function(t,e){var a=this.$node.querySelector("lyte-popover"),o=a.component.childComp.querySelector("crux-tag"),i=o.component.bodyDrop.querySelector("crux-color-palette lyte-popover");!e||!e.target||a.component.childComp.contains(e.target)||o.component.bodyDrop.contains(e.target)||i.component.childComp.contains(e.target)||(o.toggle("close"),document.getElementById("detailview_add_tag").ltProp("show",!1),this.setData("inEditMode",!1))},hideColor2:function(t,e){var a=this.$node.querySelector("crux-tag"),o=a.component.bodyDrop.querySelector("crux-color-palette lyte-popover");e&&e.target&&!a.component.bodyDrop.contains(e.target)&&!o.component.childComp.contains(e.target)&&a.toggle("close")}},actions:{showAddTag:function(){$L("crux-tag").removeClass("eventNone");var t=Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags");if(this.getData("tooltip")===t&&detailView.isApproved){var e=moduleRecordMapping[this.getData("module")].api_name,a=this.getData("tagValuesNew").Tag,o=this.getData("tagarray");o&&this.setData("tagarray",""),store.findAll("tag",{module:e,fromPage:"view"},!0,!0,{apiVersion:"2.2"}).then((t=>{o&&this.setData("tagarray",[]),this.setData("tag",t);var e=0;this.getData("tagValuesNew").Tag&&(e=this.getData("tagValuesNew").Tag.length),e>3&&this.setData("count",e-3);var i=t.length,r=this.getData("tagnamevstagid"),s=(this.getData("tagidvstagname"),this.getData("tagnamevsmodrefid")),d=this.getData("tagnamevscolor");for(p=0;p<i;p++){Lyte.objectUtils(this.getData("idvsname"),"add",t[p].modRefId,t[p].name),name=t[p].name;var n=!!this.getData("tagValuesNew").Tag&&this.getData("tagValuesNew").Tag.includes(t[p].modRefId);"detailview"!==this.getData("from")||n||Lyte.arrayUtils(this.getData("tagarray"),"push",{name:name,id:t[p].id,color_code:t[p].color_code}),Lyte.arrayUtils(this.getData("tagnames"),"push",name)}for(var l=[],g=this.getData("displaytags"),c=g.length,p=0;p<c;p++)l.push(g[p].name);for(var m=l.length,u=[],v=0;v<m;v++)u.push(s[l[v]]);if(void 0!==(a=u))var D=a.length;var h=this.getData("idvsname");this.setData("selectedtags",[]);for(p=0;p<D;p++){var y=h[a[p]],f={name:y,id:r[y],color_code:d[y]};Lyte.arrayUtils(this.getData("selectedtags"),"push",f)}if(void 0===this.getData("displaytags")||0===this.getData("displaytags").length){var _=this.getData("selectedtags").slice();this.setData("displaytags",_)}var L=$L("#ApprovalProcess").children().length,w=this.getData("approvalState")&&"approved"!==this.getData("approvalState")&&"approval_process_rejected"!==this.getData("approvalState"),b=!!this.getData("recordLockingDetails")&&(this.getData("recordLockingDetails").isLocked&&this.getData("recordLockingDetails").restricted_actions.includes("tags")),C=this.getData("recordLockedinGDPR"),R=this.getData("tagsPermissionAvail"),I=this.getData("approvalState")&&"approved"!==this.getData("approvalState")&&"approval_process_rejected"!==this.getData("approvalState")&&"approval_process_pending"!==this.getData("approvalState")&&"review_process_rejected"!==this.getData("approvalState");if(Crm.userDetails.ISROMODE||w||I||b||C||!R)if(I?this.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.reviewprocess.detailview.create.no.permission.msg")):w?comp.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")):R?b||C?this.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.lock.tag.restricted")):a.length>0||0===this.getData("selectedtags").length&&L||!L?this.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")):this.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags")):(this.setData("tagged_icon",!1),$(".tagged_icon").hide(),this.setData("add_tag",!1),this.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"))),"import"!==this.getData("from")){this.disablecursor();d=this.tagnamevscolor}else $("#importTagFieldId").empty();else b?(comp.setData({add_tag:!1,tagged_icon:!1}),comp.disablecursor("default"),$L(".tag_edit_icon").hide()):this.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags"))})),document.getElementById("detailview_add_tag").ltProp("show",!0),this.setData("inEditMode",!0)}},hideAddTag:function(){this.setData("saveEnabled",!0);var t=$("#defaulttag")[0];""!==t.cxProp("inputValue")&&t.resetSearch();var e,a=this.getData("displaytags").slice(),o=this.getData("tagnamevscolor"),i=this.getData("tagnamevstagid"),r=[],s=a.length;for(e=0;e<s;e++)r[e]=a[e].name;i=this.getData("tagnamevstagid");var d=a.slice();s=d.length;for(e=0;e<s;e++){var n=d[e];if(!r.includes(n.name)){var l=n.name,g=o[l],c=i[l];n.id=c,n.color_code=g,Lyte.arrayUtils(this.getData("tagarray"),"push",n)}}this.setData("selectedtags",a),t.toggle("close"),document.getElementById("detailview_add_tag").ltProp("show",!1),this.setData("inEditMode",!1)},savetags:function(){var t=this.getData("selectedtags"),e=$L("#defaulttag")[0],a=$L("crux-tag");a.addClass("eventNone");var o=e.cxProp("inputValue");if(t.length===this.getData("recordTagCount")&&""!==o){var i=I18n.getMsg("crm.tags.records.limit.reached",this.getData("recordTagCount"));return _cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:i,ltPropContentAlign:"center"}}),a.removeClass("eventNone"),this.setData("inEditMode",!0),!1}if(""!==o){if(t.length>0)return a.removeClass("eventNone"),this.setData("inEditMode",!0),CrmTags.checkCharacter(o)?void renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.not.selected.text")):void renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.need.alphanumeric.characters"));if(0===t.length)return renderingUtils.showAlertMsg(I18n.getMsg("crm.no.tag.selected")),a.removeClass("eventNone"),void this.setData("inEditMode",!0)}this.setData("saveEnabled",!0);var r=JSON.stringify(t);if(commonUtils.showHideLoadingDiv(!0),null!==t&&t.length>0&&r.includes('"isNewTag":true')){for(var s=this,d=moduleRecordMapping[s.getData("module")].api_name,n=t.length,l=[],g=0;g<n;g++)if(t[g].isNewTag){var c=t[g].color_code;"#noFill"!==c&&"noFill"!==c||(c=null);var p={name:t[g].name.replace(/  +/g," "),color_code:c};l.push(p)}s.createtagRec(l,s.getData("tagnames")),s.createtags(d,"dv","dv"),e.component&&void 0!==e.component.bodyDrop&&e.component.bodyDrop.querySelector("crux-color-palette").resetColorPalette()}else this.addTags();store.unloadAll("tag")}},didDestroy:function(){this.tagDVComp=null,window.removeEventListener("resize",this.applyResizeHeight)}},{mixins:["crm-tag-mixin"]});
