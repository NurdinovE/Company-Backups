Lyte.Mixin.register("kiosk_execute",{loadKioskListViewPopup:function(e,t,i,s,a){s||(s=[]);var o={queryParams:{}};if("home_page"===e){if(!$(".kioskHomeComp").hasClass("permissionAvail"))return _cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.label.cf.error.authorization"),ltPropType:"error"}}),!1;$L(".customHomePageContainer").length>0&&$(".dashBrdContent").each((function(){s.push(this.id)})),o.queryParams.include_inner_details="kiosk._associations.home_page.page"}else if("detail_view"===e){if(Crm.renderDVLyteFlow(a.data.module)){var r=$L("crm-kiosk-record-detail-view-container-wrapper")[0];if(r)for(var n=r.getData("kioskDvComponentData"),l=n.length,d=0;d<l;d++)s.push(n[d].kioskId)}else for(d=1;d<=5;d++){var c=$L("#kioskDetailView_"+d),u=c.find("crm-kiosk-screen-output");if(c&&u.length>0){var m=u[0].getAttribute("kiosk-id");s.push(m)}}o.queryParams.include_inner_details="kiosk._associations.detail_view_page.module"}commonUtils.showHideLoadingDiv(!0),store.findAll("kiosk",o.queryParams).then((function(a){commonUtils.showHideLoadingDiv(!1);var o={};if(a&&0!==a.length){var r=Lyte.registeredMixins.kiosk_execute.getGroupedkiosk(a),n=Lyte.registeredMixins.kiosk_execute.getActivekiosksList(r);n=Lyte.registeredMixins.kiosk_execute.setKioskUsed(n,e,i,s,t),o.kiosksInfo=n}else o.kiosksInfo=[];t&&(o.dep_obj=t),o.showListPopup=!0,o.featureName=e,renderingUtils.removeFreezeLayer(),Lyte.Component.render("crm-kiosk-listview-popup",o,"body")}),function(){commonUtils.showHideLoadingDiv(!1)}.bind(this))},setKioskUsed:function(e,t,i,s,a){for(var o=e.length,r=0;r<o;r++)if(e[r].used=!1,s.length>0)s.includes(e[r].id)&&(e[r].used=!0);else if(e[r].associated){var n=e[r]._associations;if(!n)continue;if("home_page"===t){for(var l=n.length,d=0;d<l;d++)if(n[d].type===t){if(!i){e[r].used=!0;break}for(var c=n[d].resources.length,u=0;u<c;u++)if(n[d].resources[u]._details.page.id==i){e[r].used=!0;break}}}else if("detail_view"===t)for(l=n.length,d=0;d<l;d++)if(n[d].type===t)for(var m=n[d].detail_view_page,_=0;_<m;_++){var p=n[d].detail_view_page[_];p.module.id===a.module.id&&p.layout.id===a.layout&&(e[r].used=!0)}}return e},getDetailViewAddJson:function(e,t,i){var s={};return s.name=e,s.layout={},s.layout.id=i.id,s.module={},s.module.api_name=t.api_name,s.module.id=t.id,s},getDetailViewAssociationJson:function(e,t,i,s,a,o){var r=[],n={};return o?(n.id=s,n._delete=null):a?(n.name=e,n.layout={},n.layout.id=i.id,n.id=s):n=this.getDetailViewAddJson(e,t,i),r.push(n),r},checkIfLastOrderComp:function(e){var t=$("#kioskDetailView_"+(Number(e)+1))[0];return!t||!t.querySelector("crm-kiosk-screen-output")},addOrUpdateKioskToComponent:function(e,t,i,s,a,o,r,n,l){var d=this,c="/crm/v7/settings/kiosks/"+e+"/associations",u={type:"detail_view_page"};u.detail_view_page=this.getDetailViewAssociationJson(t,i,s,o,r,n);var m=i.module_name,_=[];_[0]=u;var p={};p.id=e,p._associations=_;var k={kiosks:[p]};store.triggerAction("dummy","kioskAssociation",{url:c,payLoad:JSON.stringify(k),method:"PUT"}).then((function(s){if(s)if(r||n||Crm.client_tracking("Kiosk - Association",{"Associated Place":"Record detail view"}),Lyte.registeredMixins.kiosk_execute.dropDetailViewCache(i),commonUtils.showHideLoadingDiv(!1),a&&"detail_view"===a){var o=$L("crm-kiosk-record-detail-view-popup")[0],c=!1;if(n){if(Crm.renderDVLyteFlow(m)){var u=$L("crm-kiosk-record-detail-view-container-wrapper")[0];if(u){var _=(P=u.getData("kioskDvComponentData")).length;for(v=0;v<_&&P[v].kioskId!==e;v++);Lyte.arrayUtils(P,"removeAt",v,1)}}else{var p=$("#detail_view_kiosk_screen_comp_"+e).eq(0)[0];if(p){var k=p.parentElement.parentElement.parentElement,g=k.id,f=Number(g.split("_")[1]);if(d.checkIfLastOrderComp(f))$(k).css("display","none");else{p.parentElement.parentElement.parentElement.id="kioskDetailView_0";for(var v=f+1;v<=5;v++)$("#kioskDetailView_"+v)[0].id="kioskDetailView_"+(v-1);$(k).remove();var h=document.createElement("div");h.setAttribute("id","kioskDetailView_5"),h.setAttribute("class","newRelDetails flex-grid-skeleton-table relatedlist-bg"),h.setAttribute("style","display:none;");var y=document.getElementById("kioskDetailView_4");$(y).eq(0).after(h)}p.parentElement.parentElement.remove(),$(p).remove()}}c=!0;var b=$L("crm-kiosk-common-popup")[0];b&&b.component.$node.remove(),$L("#drop_action_kiosk").removeClass("disabled lyteMenuItemDisabled")}else if(r){var w=$L("crm-kiosk-record-detail-view-wrapper");if(w)for(_=w.length,v=0;v<_;v++){var L=w[v];if(L)L.component.data.kioskId===e&&w[v].setData("name",t)}}else{var x,D={},C={};if(D.kioskId=e,D.name=t,D.module=i.api_name,D.isRendered=!0,D.resourceId=s.kiosks[0].details.id,C.kioskId=e,C.execute_from="detail_view",D.detailViewKioskData=C,Crm.renderDVLyteFlow(m)){var M=$L("crm-detailview-content")[0];Lyte.objectUtils(M.component.getData("show_info"),"add","kiosk_components",!0);var I=document.getElementsByTagName("crm-kiosk-record-detail-view-wrapper"),P=$L("crm-kiosk-record-detail-view-container-wrapper")[0].getData("kioskDvComponentData");Lyte.arrayUtils(P,"push",D),x=I.length}else{$L("crm-kiosk-record-detail-view-container-wrapper")[0]||Lyte.Component.render("crm-kiosk-record-detail-view-container-wrapper",void 0,"#kioskDetailView"),$("#kioskDetailView").css("display","block");for(v=1;v<=5;v++){var E=$L("#kioskDetailView_"+v)[0];if(!E||!E.querySelector("crm-kiosk-screen-output"))break}x=v,$("#kioskDetailView_"+v)[0].style.display="block",Lyte.Component.render("crm-kiosk-record-detail-view-wrapper",D,"#kioskDetailView_"+v)}if(o)if(c=o.component.getData("fromDetailView"),o.setData("kioskOrderForScroll",x),o.setData("lastAddedComponentId",D.resourceId),v>=("A"===Crm.userDetails.LICENSE_TYPE?3:"P"===Crm.userDetails.LICENSE_TYPE?1:5)){var A=$L("crm-detailview-actions")[0];A&&(A.setData("isKioskAssocLimitReached",!0),$L("#drop_action_kiosk").addClass("disabled",!0))}}c&&(n?_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.component.deleted.success"),ltPropType:"success"}}):_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.component.added.success"),ltPropType:"success"}})),o&&o.component.setData("showAddModal",!1)}else{var R=$L("crm-kiosk-details")[0];R&&R.setData("isDeleteKioskDetailViewAssoc",!1),d.setData("showAddModal",!1);var T=!1,N=!1,S=!1,U=!1;switch(l){case"deactivateFlow":T=!0;break;case"deleteFlow":N=!0;break;case"draftPublishFlow":S=!0;break;case"showAssociationFlow":U=!0}n&&(T||N)&&_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.component.deleted.success"),ltPropType:"success"}}),d.getKioskAssociations(e,!0,void 0,N,T,S,U,!1)}}),(function(e){commonUtils.showHideLoadingDiv(!1),Lyte.registeredMixins.kiosk_execute.kioskRouteErrorHandling(e,"kiosks")}))},getAllValidLayouts:function(e){return e.filter(this.isValidLayoutRecord)},isValidLayoutRecord:function(e){return e.status+""!="-3"&&e.status+""!="-1"},fetchLayoutsArrForModule:function(e,t){var i=t;store.findAll("layout",{module:e.api_name,skip_permission:!0},!1,!0,{apiVersion:"2.2"}).then((function(e){commonUtils.showHideLoadingDiv();var s=i.getAllValidLayouts(e);s.forEach((function(e){e.name=Lyte.Component.registeredHelpers.getTranslatedLayoutNameForDetailView(e)})),i.setData("layoutDropArr",s),s&&s.length>0&&t.setData("layout",s[0]),t.setData("disableLayout",!1)}),function(){commonUtils.showHideLoadingDiv(),this.displayMsgBox(I18n.getMsg("invalid.module"),"error")}.bind(this))},getListViewResources:function(){var e=networkUtils.returnDependencyFiles(["kiosk-listview-component.js","crm-model-kiosk.js","kiosk-pb-builder-output.js","crm-emailconversation-view-helpers.js","kiosk-file-api.js","lyte-fileupload.js"],ResourceConstants.CRMClient);return e=(e=(e=(e=e.concat(networkUtils.returnDependencyFiles(["kiosk-associate-record-pop.js"],ResourceConstants.CRMClient))).concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("kiosk")],ResourceConstants.CRM))).concat(networkUtils.returnDependencyFiles(["zlib_phonenumber.js"],ResourceConstants.CRM))).concat(networkUtils.returnDependencyFiles(["kiosk-common.css"],ResourceConstants.CRMClient,ResourceConstants.LESSDEFAULT))},renderExecuteKiosk:function(e,t,i,s,a,o,r){!detailView||"home_page"!==t&&"canvas"!==t&&"setup"!==t&&"test_run"!==t&&"buttons"!==t||Lyte.registeredMixins.kiosk_execute.setKioskRefreshLoad(!1);var n="/crm/v7/settings/kiosks/"+e;commonUtils.showHideLoadingDiv(!0);var l=this;if("home_page"!==t&&"canvas"!==t&&"detail_view"!==t||i){var d={},c={};s&&(c.Current_Record={id:s}),d.data=c;var u,m=n+"/actions/";"test_run"===t?(m+="test_run",u={kiosk_test_run:[d]}):(m+="execute",u={kiosk_execute:[d]}),commonUtils.showHideLoadingDiv(!0),store.findAll("dummy",null,!1,!1,{url:m,payLoad:JSON.stringify(u),method:"POST"}).then((function(s){if(s){if("test_run"!==t){var o=t;"kiosk_execute"===t&&(o="buttons"),Crm.client_tracking("Kiosk - Execute",{"Execute From":o})}var r;if(a&&(a.requestButtonSend=!1),CustomButtonJSObjectInit&&(CustomButtonJSObjectInit.requestButtonSend=!0),commonUtils.showHideLoadingDiv(!1),"test_run"===t){var d=$L("crm-kiosk-current-record")[0];if(d){d.component.setData("isShowPop",!1);var c=document.getElementById("kioskCurrentRecordPop");void 0!==c&&c.length>0&&c[0].remove();var u=document.getElementsByTagName("crm-kiosk-current-record");void 0!==u&&u.length>0&&u[0].remove()}r=s.dummy.kiosk_test_run[0].details}else r=s.dummy.kiosk_execute[0].details;if(featuresAvailable&&featuresAvailable.KIOSK_NEW_ACTIONS&&r.executed_dependent_states&&r.executed_dependent_states.length>0)for(var m=r.executed_dependent_states.length,_=0;_<m;_++){var p=r.executed_dependent_states[_];p.action_type&&"convert"===p.action_type&&(Lyte.registeredMixins.kiosk_execute.setKioskExecution(!0),Lyte.registeredMixins.kiosk_execute.setKioskRefreshLoad(!0))}if(r.next_executable_state){commonUtils.showHideLoadingDiv(!0);store.findAll("dummy",{include_inner_details:"kiosk_executions.kiosk,elements.get_record.associated_fields.data_type,elements.get_record.ui_type,elements.get_record.associated_fields.ui_type,elements.get_record.associated_fields.api_name,elements.get_record.module,elements.get_record.type,elements.get_record.limit,elements.get_record.range,elements.get_record.api_name,elements.get_record.associated_fields.field_label,elements.zia_insight.parent_record_field,elements.data_hub.associated_fields.data_type,elements.data_hub.ui_type,elements.data_hub.associated_fields.ui_type,elements.data_hub.associated_fields.api_name,elements.data_hub.module,elements.data_hub.type,elements.data_hub.limit,elements.data_hub.range,elements.data_hub.api_name,elements.data_hub.associated_fields.field_label"},!1,!1,{url:n+"/executions/"+r.id}).then((function(s){s.kiosk_executions?(l.showKioskStateOutputInfo(s.kiosk_executions[0],e,t,i),"test_run"===t&&$L("crm-kiosk-builder")[0].component.setData({isDisableAllBtns:!1,kioskPublishBtnDisabled:!1,testRunBtnDisabled:!1})):commonUtils.showHideLoadingDiv(!1)}),(function(e){(e&&Lyte.registeredMixins.kiosk_execute.kioskRouteErrorHandling(e,"kiosk_executions"),"test_run"===t)&&$L("crm-kiosk-builder")[0].component.setData({isDisableAllBtns:!1,kioskPublishBtnDisabled:!1,testRunBtnDisabled:!1});commonUtils.showHideLoadingDiv(!1)}))}else if("blueprint"!==t||r.next_executable_state){if("test_run"===t&&r.executed_dependent_states){var k=$L("crm-kiosk-builder");if(k&&k.length>0){var g=r.executed_dependent_states[r.executed_dependent_states.length-1],f=g.id;if(f){var v=Lyte.registeredMixins.kiosk.getStateDetails(f);if(v&&"decision"===v.type){var h=g.transition.name;"Default"===h&&(h=I18n.getMsg("gs.default"));var y=v.name+" - "+h,b=k[0].component;b.setData("flowValidationContent",I18n.getMsg("crm.kiosk.testrun.incomplete.path",y)),b.setData("flowValidationHeader",I18n.getMsg("crm.kiosk.testrun.incomplete.header")),$L("#kioskPathErrorPop")[0].ltProp("show",!0)}}}}}else ProcessFlow.proceedBPFromKiosk(),Lyte.registeredMixins.kiosk_execute.isKioskExecution()&&featuresAvailable&&featuresAvailable.KIOSK_NEW_ACTIONS&&(Lyte.registeredMixins.kiosk_execute.setKioskExecution(!1),Lyte.registeredMixins.kiosk_execute.isKioskRefresh()&&(Lyte.registeredMixins.kiosk_execute.loadKioskRefreshPop(),Lyte.registeredMixins.kiosk_execute.setKioskRefreshLoad(!1))),Lyte.registeredMixins.kiosk_execute.setKioskExecution(!1)}}),(function(s){if(commonUtils.showHideLoadingDiv(!1),a&&(a.requestButtonSend=!1),CustomButtonJSObjectInit&&(CustomButtonJSObjectInit.requestButtonSend=!0),("test_run"===t||"canvas"===t||"blueprint"===t)&&s.response){var r=JSON.parse(s.response);if(r.message&&("Invalid configuration available please check in kiosk details view"===r.message||r.details.invalid_modules||r.details.invalid_components)){var n=$L("crm-kiosk-builder")[0].component;return n.setData({isDisableAllBtns:!1,kioskPublishBtnDisabled:!1,testRunBtnDisabled:!1}),void n.showInvalidConfigPopup(s)}if(r.kiosk_test_run&&"LIMIT_EXCEEDED"!==(r=r.kiosk_test_run[0]).code&&("Invalid current record"===r.message||"Converted record not supported"===r.message||"No permission for current record"===r.message))return void Lyte.registeredMixins.kiosk_execute.renderExecuteKiosk(e,"test_run",!1,void 0);if(r.kiosk_execute&&"LIMIT_EXCEEDED"!==(r=r.kiosk_execute[0]).code&&("Invalid current record"===r.message||"Converted record not supported"===r.message||"No permission for current record"===r.message)){if("canvas"===t){var l=$(Lyte.registeredMixins.kiosk_execute.getKioskElementIdFromCanvas(e)),d=l&&l.length>0?l.find("crm-kiosk-screen-output"):void 0;d&&d.length>0&&d[0].component&&d[0].component.setData("current_record_id",void 0)}return void Lyte.registeredMixins.kiosk_execute.renderExecuteKiosk(e,t,i,void 0,a,o)}}s&&Lyte.registeredMixins.kiosk_execute.kioskRouteErrorHandling(s,"test_run"===t?"kiosk_test_run":"kiosk_execute",!1,e,t)}))}else{let a={include_inner_details:"kiosk_preview.kiosk,elements.get_record.associated_fields.data_type,elements.get_record.ui_type,elements.get_record.associated_fields.ui_type,elements.get_record.associated_fields.api_name,elements.get_record.module,elements.get_record.type,elements.get_record.limit,elements.get_record.range,elements.get_record.api_name,elements.get_record.associated_fields.field_label,elements.zia_insight.parent_record_field,elements.data_hub.associated_fields.data_type,elements.data_hub.ui_type,elements.data_hub.associated_fields.ui_type,elements.data_hub.associated_fields.api_name,elements.data_hub.module,elements.data_hub.type,elements.data_hub.limit,elements.data_hub.range,elements.data_hub.api_name,elements.data_hub.associated_fields.field_label"};s&&(a.current_record_id=s),a.invoked_from=t,store.findAll("dummy",a,!1,!1,{url:n+"/actions/preview"}).then((function(a){a&&(a.kiosk_preview&&a.kiosk_preview.length>0&&!a.kiosk_preview[0].hasOwnProperty("Current_Record")&&(a.kiosk_preview[0].Current_Record=s),l.showKioskStateOutputInfo(a.kiosk_preview[0],e,t,i,o,r))}),(function(i){commonUtils.showHideLoadingDiv(!1);var s=JSON.parse(i.responseText);if(!s.message||"LIMIT_EXCEEDED"===s.code||"Invalid current record"!==s.message&&"Converted record not supported"!==s.message&&"No permission for current record"!==s.message)if("FEATURE_NOT_SUPPORTED"===s.code||"NOT_ALLOWED"===s.code){let i;if(i="NOT_ALLOWED"===s.code?"<br><br><div class='noPermissionDiv'><p class='noPermissionText'>"+I18n.getMsg(Crm.userDetails.IS_ADMIN?"crm.kiosk.deactive.admin.msg":"crm.kiosk.deactive.user.msg")+"</div>":"<br><br><div class='noPermissionDiv'><p class='noPermissionText'>"+I18n.getMsg("crm.dashboard.component.not.available.in.this.edition")+"</div>","canvas"===t){let t=Lyte.registeredMixins.kiosk_execute.getKioskElementIdFromCanvas(e);$(t).html(i)}else if("detail_view"===t){var a="#detail_view_kiosk_screen_comp_"+e;$(a).html(i)}else{var o=Lyte.registeredMixins.kiosk_execute.getCompIdfromKioskId(e);$("#layout_"+o).html(i),$("#datafetchdate_"+o).addClass("hide")}}else{let i="<br><br><div class='noPermissionDiv'><p class='noPermissionText'>"+I18n.getMsg("voc.gc.save.error")+"</div>";if("canvas"===t){let t=Lyte.registeredMixins.kiosk_execute.getKioskElementIdFromCanvas(e);$(t).html(i)}else if("detail_view"===t){a="#detail_view_kiosk_screen_comp_"+e;$(a).html(i)}else{o=Lyte.registeredMixins.kiosk_execute.getCompIdfromKioskId(e);$("#layout_"+o).html(i),$("#datafetchdate_"+o).addClass("hide")}}else{if("canvas"===t){var r=$(Lyte.registeredMixins.kiosk_execute.getKioskElementIdFromCanvas(e)),n=r&&r.length>0?r.find("crm-kiosk-screen-output"):void 0;n&&n.length>0&&n[0].component&&n[0].component.setData("current_record_id",void 0)}Lyte.registeredMixins.kiosk_execute.renderExecuteKiosk(e,t,!1,void 0,void 0,void 0)}}))}},showKioskStateOutputInfo:function(e,t,i,s,a,o){var r=Lyte.registeredMixins.kiosk_execute.constructScreenOutputData(e,t,i,s,a);"right_to_left"===e.button_align?r.btnAlignProp="alignRight dF flexReverse fwWrap":"center"===e.button_align?r.btnAlignProp="aligncenter":r.btnAlignProp="alignLeft",featuresAvailable&&featuresAvailable.KIOSK_NEW_ACTIONS&&(r.screenWidth=e.width,"1000px"===e.width?r.popoverProperties={popoverProperties:{class:"kioskTextAreaPop",width:"680px",height:"500px"}}:"670px"===e.width&&(r.popoverProperties={popoverProperties:{class:"kioskTextAreaPopover",width:"350px",height:"400px"}}),r.screenName=e.title),e.previous_states&&e.previous_states.forEach((function(e){"Start"===e.name&&(r.executeFromStart=!0)})),Lyte.registeredMixins.kiosk_execute.getModifiedOutputJson(e.elements,!1,r.isReadOnlyMode).then((function(e){Lyte.registeredMixins.kiosk_execute.renderScreenOutput(r,e,i,t,r.isReadOnlyMode,s,o)})),commonUtils.showHideLoadingDiv(!1)},renderScreenOutput:function(e,t,i,s,a,o,r){e.outputFields=t;let n="canvas"===i,l="home_page"===i,d="detail_view"===i;if(l||n||d){var c,u;l?r?u=r.startsWith("#")?r:"#"+r:(u="#layout_"+(c=Lyte.registeredMixins.kiosk_execute.getCompIdfromKioskId(s)),$L("#datafetchdate_"+c).addClass("hide")):n?u=Lyte.registeredMixins.kiosk_execute.getKioskElementIdFromCanvas(s):d&&(u="#detail_view_kiosk_screen_comp_"+s);var m,_=$(u),p=_.find("crm-kiosk-screen-output");if($("#datafetchdate_"+c).addClass("hide"),p&&p.length>0)if(!n&&!d||!p[0].component||p[0].component.getData("isNeedReRenderComp")||o){var k=p.find("kiosk_screen_output_builder");void 0!==k&&k.remove(),p[0].remove()}else m=p[0].component;else _.length>0&&_.html("");if(e.isBlankScreenMode?(_.addClass("dF w100_per aiCenter"),d&&_.addClass("h250")):_.removeClass("dF w100_per aiCenter h250"),m&&m.getData("isPreviewLimitReached")&&d&&_.addClass("w100_per aiCenter h250"),m?(m.setData(e),m.setData("enableExecution",!0),m.didConnect()):Lyte.Component.render("crm-kiosk-screen-output",e,u),_.find(".componentLoader").addClass("dN"),$L('[data-dashletid="'+s+'"]').attr("data-loaded","true"),l){var g=$L("#"+c).find(".grid-stack-item-content");if(a){g.addClass("oH");var f=g.outerHeight(),v=f/2-70;f>g.find("crm-kiosk-screen-output").outerHeight()&&(v=g.find(".kioskHomepageOverlay").outerHeight()/2-15),g.find(".kioskOverlayBtn").css("top",v/2)}else g.removeClass("oH")}else d&&m&&$("#kioskDetailView").css("display","block")}else if("test_run"===i)Lyte.Component.render("crm-kiosk-screen-output",e,"#kiosk_screen_output_preview");else{var h=$L("#kiosk_output_popup");h&&h.length>0?(h.removeClass("dN"),Lyte.Component.render("crm-kiosk-screen-output",e,"#kiosk_output_popup")):Lyte.Component.render("crm-kiosk-screen-output",e,"body")}},getCompIdfromKioskId:function(e){var t=$("[data-dashletid="+e+"]")[0];if(t)return t.id},filterObjArrByApiName:function(e,t){return t.indexOf("_Insights__s")>0?{plural_label:t.replace("_Insights__s"," Insights"),api_name:t}:e.filter((e=>e.api_name===t))[0]},filterObjArrByFieldLabelName:function(e,t){return e.filter((e=>e.field_label===t))[0]},getModifiedOutputJson:async function(e,t,i){if(e){for(var s,a=store.peekAll("module"),o=Lyte.registeredMixins.kiosk_execute,r=e.length,n=[],l=0;l<r;l++){var d,c=!1,u=Lyte.deepCopyObject(e[l]),m={},_=1;if("field"!==u.type&&"screen_field"!==u.type||(m=u.field,_=Number(m.ui_type),"field"===u.type&&u.field.tooltip_value&&(m.tooltip={name:u.field.tooltip_name,value:u.field.tooltip_value})),"get_records"===u.type&&((m=u.get_record).name||(m.name=m.field_label),m.get_record_data=u.get_record_data,_=u.get_record.ui_type),"data_hubs"===u.type)if(c=!0,null===u.data_hub)_=133,m.ui_type=133,m.status="inactive",m.isDataHubDisabled=!0;else{(m=u.data_hub).name||(m.name=m.field_label);var p=!0;if(u.data_hub.status&&(p=!1),_=u.data_hub.ui_type,p&&null===u.value&&!t){var k,g;Crm.client_tracking("Kiosk - Components",{"Component Name":"Queries - Execution","Action Type":"Total"}),commonUtils.showHideLoadingDiv(!0);var f=store.peekRecord("kiosk_datahub",u.data_hub.id);if(g=u.data_hub.module?u.data_hub.module.id:f.module.id,void 0!==(d=store.peekRecord("automation_datahub_module",g))||void 0!==Crm.userDetails.CLIENT_ACCOUNT&&Crm.userDetails.CLIENT_ACCOUNT||await store.findAll("automation_datahub_module"),void 0===(d=store.peekRecord("automation_datahub_module",g)))m.isDataHubDisabled=!0,m.status="inactive";else{k=d.data_hub.uuid;var v={},h=u.data_hub.dynamic_variable_mappings;if(h&&h.length>0)for(var y=h.length,b=0;b<y;b++){var w=h[b];v[w.variable_name]=w.value}var L=[],x="single"===u.data_hub.type,D=await DataHub.getQueries(k);if(D&&0===D.length)m.isDataHubDisabled=!0,m.status="inactive",Crm.client_tracking("Kiosk - Components",{"Component Name":"Queries - Execution","Action Type":"NotAccessible"});else{var C,M=await D[0].schema,I=await D[0].nodes;try{var P=(C=await D[0].invoke(v)).result,E=C.$response;m.status="success";var A=E.status_code;if(void 0===A||A<200||A>206)m.status="failure",Crm.client_tracking("Kiosk - Components",{"Component Name":"Queries - Execution","Action Type":"Failure"});else{Crm.client_tracking("Kiosk - Components",{"Component Name":"Queries - Execution","Action Type":"Success"});var R,T=M.type,N=d.schema_props,S=o.constructPathNameVsFldLabel(N,I,o);if(x)(R="array"===T?P[0]:P)&&L.push(o.constructDataHubData(I,R,S,d,o));else if("array"===T)for(var U=P.length,O=0;O<U;O++)(R=P[O])&&L.push(o.constructDataHubData(I,R,S,d,o))}}catch(e){"INACCESSIBLE_QUERY"===e.err_msg?(m.isDataHubDisabled=!0,m.status="inactive",Crm.client_tracking("Kiosk - Components",{"Component Name":"Queries - Execution","Action Type":"NotAccessible"})):(m.status="failure",Crm.client_tracking("Kiosk - Components",{"Component Name":"Queries - Execution","Action Type":"Failure"}))}}L.length>0&&(m.data_hub_data=L)}commonUtils.showHideLoadingDiv()}else m.status=u.data_hub.status,m.status&&"inactive"===m.status&&(m.isDataHubDisabled=!0),m.value=u.value;m.associated_fields=m.display_fields}"text"===u.type&&((m=u).ui_type=110,m.field_label="Display Text"),"zia_insights"===u.type&&((m=u).className="",r>1&&(m.className=0===l?"mB20":l===r-1?"mT20":"mT20 mB20")),m.value=u.value,m.type=u.type;var K=m.required&&"false"!==m.required;if(featuresAvailable&&featuresAvailable.KIOSK_NEW_ACTIONS?m.property={required:K,field_label:m.field_label,decimal_place:m.decimal_place}:m.property={required:K,field_label:m.field_label},i&&!m.read_only&&(m.disabled=!0,m.custom_class="kioskReadOnlyField"),m.read_only&&(m.custom_class="kioskReadOnlyField"),!i&&m.read_only&&"screen_field"!==m.type?(m.custom_title=I18n.getMsg("crm.lable.read.only"),m.custom_class="kioskReadOnlyField"):m.custom_title="",m.tooltip&&"info_icon"!==m.tooltip.name&&(m.place_holder=m.tooltip.value),34===_&&(m.length=5),1!==_&&m.length||(m.length=255),"get_records"===m.type||"data_hubs"===m.type){var $="data_hubs"===m.type?"kiosk_datahub":"kiosk_getrecord";c="data_hubs"===m.type;if(t)(j=store.peekRecord($,m.id)).selection_details.range>1||c&&"multiple"===j.selection_details.type?(_=140,m.ui_type=140):(_=133,m.ui_type=133);else m.range>1&&(_=140,m.ui_type=140);if(133===_){var F=!0,V=!1,H=[],B=[];if(t){var j=store.peekRecord($,m.id),z=c?j.display_fields:j.associated_fields;H=Lyte.deepCopyObject(z);var q=j.module.api_name;re=c?m.name:Lyte.registeredMixins.kiosk_execute.filterObjArrByApiName(a,q).plural_label;for(var J=await store.findAll("field",{module:q,feature_name:"kiosk",component:"kiosk_criteria",type:"all"},!0,!1,{apiVersion:"7"}),W=H.length,Q=0;Q<W;Q++){var Y;(Y=c?Lyte.registeredMixins.kiosk_execute.filterObjArrByFieldLabelName(J.field,H[Q].api_name):Lyte.registeredMixins.kiosk_execute.filterObjArrByApiName(J.field,H[Q].api_name))&&(H[Q].field_label=Y.field_label,H[Q].ui_type=Y.ui_type)}}else H=c?m.display_fields:m.associated_fields,c?(m.selected_ind=[],"failure"===m.status||"inactive"===m.status?V=!0:F=!m.value&&!m.data_hub_data):F=!m.value&&!m.get_record_data,F||V?(m.get_record_ids=null,m.selected_ind=null):m.get_record_ids=c?m.value?[m.value[0].id]:null:m.get_record_data?[m.get_record_data[0].id]:[m.value[0].id];if((F||V)&&!t&&!i){F&&(m.no_records=!0,m.info_message=I18n.getMsg("crm.new.label.no.records")+"."),V&&(m.isFailed=!0,m.info_message=I18n.getMsg("crm.kiosk.datahub.query.failure")),m.isDataHubDisabled&&(m.info_message=I18n.getMsg("crm.kiosk.queries.disabled.or.inaccessible")),n.push(m);continue}for(var X=H.length,Z=0;Z<X;Z++){var G={};H[Z].id&&(G.id=H[Z].id),G.ui_type=H[Z].ui_type,G.data_type=H[Z].data_type,G.read_only=!0,G.property={required:!1},G.place_holder="";var ee="",te="";if(t)ee="${"+re+"."+(te=H[Z].field_label)+"}";else{if(te=H[Z].field_label,i)ve="${"+m.module.display_label+"."+te+"}";else{var ie=H[Z].api_name;(ve=c?m.data_hub_data?m.data_hub_data[0][ie]:m.value[0][ie]:m.get_record_data?m.get_record_data[0][ie]:m.value[0][ie])&&ve.name&&(ve=ve.name)}if(ve&&("Sent_To"===H[Z].api_name||"Sender"===H[Z].api_name)){let e=ve.indexOf("<"),t=ve.indexOf(">");e>0&&t>0&&(ve=ve.substring(e+1,t))}if("Note_Content"!==H[Z].api_name&&"Note_Title"!==H[Z].api_name||(G.ui_type=3),!1===ve||ve&&""!==ve)if(!i&&33===G.ui_type&&ve)ve=commonUtils.getFormatPhoneNo(ve);else if(i||24!==G.ui_type&&202!==G.ui_type&&"date"!==G.data_type||!ve){if(!i&&(333===G.ui_type||"datetime"===G.data_type)&&ve){ve=(fe=new CrmDate(ve)).getDateTimeInUserPattern()}}else ve=CrmDateUtils.convertDateToUserPattern($L.moment(ve).toDate(),void 0,!0);else ve="-";ee=ve}G.field_label=te,G.value=ee,t&&!te||B.push(G)}m.fields=B,m.isEmpty=F,m.isFailed=V,m.classNams=s&&133===s?"mT20":""}else if(140===_){var se="",ae=(H=[],[]);if(t){j=store.peekRecord($,m.id);m.limit=j.selection_details.limit;z=c?j.display_fields:j.associated_fields,X=(H=Lyte.deepCopyObject(z)).length;var oe={},re=(q=j.module.api_name,c?m.name:Lyte.registeredMixins.kiosk_execute.filterObjArrByApiName(a,q).plural_label);for(J=await store.findAll("field",{module:q,type:"all"},!0,!1,{apiVersion:"7"}),W=H.length,Q=0;Q<W;Q++){var ne,le=H[Q];if(ne=c?Lyte.registeredMixins.kiosk_execute.filterObjArrByFieldLabelName(J.field,le.api_name):Lyte.registeredMixins.kiosk_execute.filterObjArrByApiName(J.field,le.api_name))le.field_label=ne.field_label,le.field_label=ne.field_label,le.ui_type=ne.ui_type,oe[c?ne.field_label:ne.api_name]="${"+re+"."+ne.field_label+"}",oe.id=ne.id,"Note_Content"!==H[Q].api_name&&"Note_Title"!==H[Q].api_name||(H[Q].ui_type=3),116!==H[Q].ui_type&&117!==H[Q].ui_type||(H[Q].formula={return_type:"text"}),118===H[Q].ui_type&&(H[Q].rollup_summary={return_type:"text"})}ae.push(oe)}else{if(c&&"failure"===m.status&&(m.isFailed=!0),H=m.associated_fields,!m.associated_fields){m.get_record_ids=null,m.no_records=!0,m.info_message=I18n.getMsg("crm.new.label.no.records")+".",n.push(m);continue}for(var de=H.length,ce=0;ce<de;ce++)"Note_Content"!==H[ce].api_name&&"Note_Title"!==H[ce].api_name||(H[ce].ui_type=3),116!==H[ce].ui_type&&117!==H[ce].ui_type||(H[ce].formula={return_type:"text"}),118===H[ce].ui_type&&(H[ce].rollup_summary={return_type:"text"}),110!==H[ce].ui_type&&3!==H[ce].ui_type||(H[ce].width="350px");var ue=0;i?ue=1:m.value?ue=m.value.length:m.get_record_data?ue=m.get_record_data.length:m.data_hub_data&&(ue=m.data_hub_data.length);var me;F=!ue;if(!i&&ue>5){var _e=39*ue+35;se=_e>350?"350px":_e+"px"}if(m.record_selection_msg=I18n.getMsg("crm.kiosk.getrecord.select.limit.msg",m.limit),(me=c?m.data_hub_data?m.data_hub_data:m.value:m.get_record_data?m.get_record_data:m.value)||i)for(Z=0;Z<ue;Z++){var pe=H.length,ke={};i?ke.id=null:ke=Object.assign({},me[Z]);for(var ge=0;ge<pe;ge++){if(ke[H[ge].api_name]&&("Sent_To"===H[ge].api_name||"Sender"===H[ge].api_name)){let e=ke[H[ge].api_name],t=e.indexOf("<"),i=e.indexOf(">");t>0&&i>0&&(e=e.substring(t+1,i),ke[H[ge].api_name]=e)}if(i)ke[H[ge].api_name]="${"+m.module.display_label+"."+H[ge].field_label+"}";else if(33===H[ge].ui_type&&ke[H[ge].api_name])ke[H[ge].api_name]=commonUtils.getFormatPhoneNo(ke[H[ge].api_name]);else if(24!==H[ge].ui_type&&202!==H[ge].ui_type&&"date"!==H[ge].data_type||!ke[H[ge].api_name])if(333!==H[ge].ui_type&&"datetime"!==H[ge].data_type||!ke[H[ge].api_name])ke[H[ge].api_name]&&ke[H[ge].api_name].name&&(ke[H[ge].api_name]=ke[H[ge].api_name].name);else{var fe=new CrmDate(ke[H[ge].api_name]);ke[H[ge].api_name]=fe.getDateTimeInUserPattern()}else ke[H[ge].api_name]=CrmDateUtils.convertDateToUserPattern($L.moment(ke[H[ge].api_name]).toDate(),void 0,!0)}ae.push(ke)}F&&(ae=[])}m.tableHeight=se,m.checkbox_need=!0,!F||i||t?(m.get_record_data||m.data_hub_data?m.allow_selection=!1:m.allow_selection=!0,m.output_allow_selection=!m.allow_selection):(m.output_allow_selection=!1,F&&(m.checkbox_need=!1)),(i||t)&&(m.allow_selection=!1),m.table_header=JSON.stringify(H),m.table_body=JSON.stringify(ae),m.cxPropFieldTypeMapping={3:"text-area",110:"text-area"},m.get_record_ids=[],m.selected_ind=[]}}else{var ve="";if(t)m._merge_field&&(ve=m._merge_field,"text"!==m.type&&3!==m.ui_type&&110!==m.ui_type&&(m.ui_type=1)),"text"===m.type&&(ve=m.value),301!==_||m._merge_field||(ve=m.value),100===_&&"screen_field"!==m.type&&(ve=[]),110===m.ui_type&&"text"===m.type&&(ve=m.value);else if(36===m.ui_type||143===m.ui_type||144===m.ui_type||145===m.ui_type){if((ve=m.value)&&"screen_field"!==m.type&&ve.split(" ").length>1)if(ve=ve.split(" ")[1],m.length&&m.read_only)(ve=ve.substring(0,m.length)).endsWith(".")&&(ve+="0");else{var he=(ve=(ve=ve.replaceAll(",","")).replaceAll(" ","")).split(".")[1];ve=he&&0===Number(he)?ve.split(".")[0]:ve.split(".")[0]+"."+Number(ve.split(".")[1])}}else if(24!==m.ui_type&&202!==m.ui_type||!m.value)if(333===m.ui_type&&m.value){if(m.read_only&&"screen_field"!==m.type)ve=(fe=new CrmDate(m.value)).getDateTimeInUserPattern();else ve=m.value}else ve=m.value,"screen_field"!==m.type||ve&&""!==ve||!1===ve||(ve="-"),301===_&&(m._merge_field="");else ve=m.read_only&&"screen_field"!==m.type?CrmDateUtils.convertDateToUserPattern($L.moment(m.value).toDate(),void 0,!0):m.value;100!==_||t||(m.read_only||"screen_field"===m.type?m.value?ve=m.value:"screen_field"!==m.type&&(ve=""):ve=m.value?m.value.split(";"):[]),33===_&&ve&&(m.read_only||"screen_field"===m.type)&&(ve=commonUtils.getFormatPhoneNo(ve)),32===_&&ve&&(ve=ve.replaceAll(",",""),m.length&&m.read_only&&(ve=ve.substring(0,m.length))),33===_&&(m.isCountryCode=Crm.userDetails.isPhoneNoNewView),m.value=ve}133!==m.ui_type&&140!==m.ui_type||t||i||(m.isDataHubDisabled?m.info_message=I18n.getMsg("crm.kiosk.queries.disabled.or.inaccessible"):m.isFailed?m.info_message=I18n.getMsg("crm.kiosk.datahub.query.failure"):m.no_records&&(m.info_message=I18n.getMsg("crm.new.label.no.records")+".")),m.ui_type&&133!==m.ui_type&&140!==m.ui_type&&301!==m.ui_type&&555!==m.ui_type&&"text"!==m.type&&!m.value&&(m.value=""),s=_,n.push(m)}return n}},loadAndRenderExecuteKiosk:function(e,t,i,s){var a=Lyte.registeredMixins.kiosk_execute.getListViewResources();Lyte.injectResources(a,void 0,(function(){Lyte.registeredMixins.kiosk_execute.renderExecuteKiosk(e,t,i,s)}))},constructDataHubData:function(e,t,i,s,a){var o={},r=s.date_time_format,n=null!==r?r.date_format:null,l=null!==r?r.dt_date_format:null;return e.forEach((e=>{if("string"===e.type||"number"===e.type||"boolean"===e.type){var s=e.path,d=s.split("."),c=t,u=d.length,m="";for(let e=1;e<u;e++)if(d[e].includes("[]")){var _=d[e].split("[]")[0],p=parseInt(d[e+1]);c=c[_][p],e++}else void 0!==c[m=""===m?d[e]:m+"."+d[e]]&&(c=c[m],m="");var k=i[s];if(void 0!==k){var g=e.format;c&&("date"===g&&null!==n||"datetime"===g&&null!==l)&&(c=a.convertDateTimeFieldValues(c,g,r,a)),o[k]=c}}})),o},convertDateTimeFieldValues:function(e,t,i,s){if("date"===t)e=$L.moment(e,i.date_format.toLocaleUpperCase(),{timezone:i.time_zone}).format();else if("datetime"===t){var a=i.dt_date_format,o=i.dt_time_format;i.dt_time_format&&(o=s.convertDateTimePattern(o),e&&e.includes("T")?(a=a.toLocaleUpperCase()+"T"+o,e.includes("+")&&(a+="Z")):a=a.toLocaleUpperCase()+" "+o),e=$L.moment(e,a,{timezone:i.time_zone}).format()}return e},convertDateTimePattern:function(e){return e=(e=e.toLowerCase()).replace(/h/g,"H")},constructPathNameVsFldLabel:function(e,t,i){var s={};return e.forEach((e=>{const a=i.getFieldPath(t,e.field_label,e.api_name);a&&Object.assign(s,a)})),s},getFieldPath:function(e,t,i){for(var s=e.length,a=0;a<s;a++){if(e[a].label===t)return{[e[a].path]:i}}return null},getGroupedkiosk:function(e){var t={};return e.forEach((function(e){t[e.group_id]?t[e.group_id].push(e):t[e.group_id]=[e]})),t},getActivekiosksList:function(e){var t=[],i=this;return Object.keys(e).forEach((function(s){var a=e[s],o=i.getActivekioskInList(a);o&&t.push(o)})),t.sort((function(e,t){return e.sequence_number-t.sequence_number})),t},getActivekioskInList:function(e){var t;return e.forEach((function(e){"active"!==e.status||(t=e)})),t},kioskRouteErrorHandling:function(e,t,i,s,a){if(e.response){commonUtils.showHideLoadingDiv(!1);var o=JSON.parse(e.response);o[t]&&(o=o[t][0]);var r=$L(".dummy_Body");if(i&&"INTERNAL_ERROR"===o.code)return crmui.showMsgBand("error",I18n.getMsg("error.database.problem"),3e3),void r.hide();switch(o.code){case"INVALID_DATA":if("kiosk_test_run"!==t||"Invalid current record"!==o.message&&"Converted  record not supported"!==o.message&&"invalid data"!==o.message)if(s&&"Invalid current record"===o.message)Lyte.registeredMixins.kiosk_execute.renderExecuteKiosk(s,a,!1,void 0);else if("Invalid Kiosk execution id"===o.message){var n=$L("crm-kiosk-screen-output")[0].component;n.setData("showScreen",!1),commonUtils.showHideLoadingDiv(!1),n.destoryPreviewPop(),_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.invalid.flow.access"),ltPropType:"error"}})}else if("No such Kiosk exists"===o.message)if("kiosk_execute"!==t&&"kiosk_executions"!==t&&"kiosk_test_run"!==t){var l=$L("crm-kiosk-record-detail-view-popup")[0],d=$L("crm-kiosk-common-popup")[0];l||d?(l?l.component.setData("showAddModal",!1):d.component.$node.remove(),_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.doesnotexist"),ltPropType:"error"}})):Lyte.Router.getRouteInstance().transition.data.noNeedToShowErrorMsg?Lyte.Router.getRouteInstance().transitionTo("crm.settings.section.kiosk.index-kiosk"):Lyte.Router.getRouteInstance().transitionTo("crm.settings.section.kiosk.index-kiosk").data={invalidProcess:!0}}else{if(_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.doesnotexist"),ltPropType:"error"}}),!$L("crm-detailview-header")[0])if(u=$L("crm-kiosk-screen-output")[0])(m=u.component).setData("showScreen",!1),m.destoryPreviewPop()}else if("Kiosk detail view associated component has been removed"===o.message){_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.detail.view.limit.user.message"),ltPropType:"error"}}),(l=$L("crm-kiosk-record-detail-view-popup")[0])&&l.component.setData("showAddModal",!1)}else _cruxUtils.showCustomMessage({params:{ltPropMessage:o.message,ltPropType:"error"}});else{var c=$L("#test_current_rec_id")[0];c.setData("cxPropErrorMessage",I18n.getMsg("crm.field.valid.check",I18n.getMsg("pf.recordid"))),c.focus()}break;case"NO_PERMISSION":s&&"No permission for current record"===o.message?Lyte.registeredMixins.kiosk_execute.renderExecuteKiosk(s,a,!1,void 0):(renderingUtils.displayPermissionDenied(),r.hide());break;case"NOT_ALLOWED":if("Converted record not supported"===o.message)_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.current.record.invalid.action"),ltPropType:"error"}});else if("Invalid configuration available please check in kiosk details view"===o.message)_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.invalid.config.check"),ltPropType:"error",ltPropDuration:"3000"}});else if("kiosk_execute"===t||"kiosk_executions"===t&&"Kiosk not published"===o.message){var u,m;if(_cruxUtils.showCustomMessage({params:{ltPropMessage:Crm.userDetails.IS_ADMIN?I18n.getMsg("crm.kiosk.deactive.admin.msg"):I18n.getMsg("crm.kiosk.invalid.flow.access"),ltPropType:"error"}}),u=$L("crm-kiosk-screen-output")[0])(m=u.component).setData("showScreen",!1),m.destoryPreviewPop()}else"Only active Kiosk can be associated"===o.message?_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.invalid.flow.access"),ltPropType:"error"}}):_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("voc.gc.save.error"),ltPropType:"error"}});r.hide();break;case"FEATURE_NOT_SUPPORTED":renderingUtils.displayPermissionDenied(void 0,void 0,I18n.getMsg("crm.zes.mobile.error.feature")),r.hide();break;case"ACCESS_DENIED":var _=o.MODULE_DISABLED[0];if(validationUtils.isNotEmpty(_)){$L("crm-kiosk-details")[0]?($L("crm-kiosk-details")[0].component.setData("disabledModules",_),$L("#kiosk_deny_pop")[0].ltProp("show",!0)):Lyte.Router.getRouteInstance().transitionTo("crm.settings.section.kiosk.index-kiosk").data={disabledModulesList:_,moduleDisabledWarning:!0};break}case"LIMIT_EXCEEDED":if("Kiosk test run limit reached"===o.message){var p=$L("crm-kiosk-builder")[0].component;p.setData("testRunBtnDisabled",!0),p.setData("testRunLimitReached",!0),_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.testrun.limit.exceed",o.details.limit),ltPropType:"error"}})}else"Kiosk Draft limit reached"===o.message||"Kiosk Execution limit reached"===o.message?(_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.execution.limit.exceed"),ltPropType:"error"}}),$L("crm-kiosk-screen-output")[0].component.setData("showScreen",!1)):"Kiosk GetRecord Execution limit reached"===o.message?(_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.getrecords.execution.limit.reached"),ltPropType:"error"}}),$L("crm-kiosk-screen-output")[0].component.setData("showScreen",!1)):"Maximum active kiosks count reached for this edition"===o.message?_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.limit.exceeded",o.details.limit),ltPropType:"error"}}):"Maximum detail view kiosks association count reached"===o.message&&_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.detail.view.association.limit.reached.message"),ltPropType:"error"}});break;case"DUPLICATE_DATA":"Duplicate Kiosk component name"===o.message?_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.detail.view.layout.duplicate.name"),ltPropType:"error"}}):"Kiosk already associated with this layout"===o.message&&_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("crm.kiosk.detail.view.layout.duplicate"),ltPropType:"error"}});break;default:_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("voc.gc.save.error"),ltPropType:"error"}}),r.hide()}}else i?Lyte.Router.getRouteInstance().transitionTo("crm.settings.section.kiosk.index-kiosk").data={invalidProcess:!0}:_cruxUtils.showCustomMessage({params:{ltPropMessage:I18n.getMsg("voc.gc.save.error"),ltPropType:"error"}}),$L(".dummy_Body").hide();commonUtils.showHideLoadingDiv(!1)},closeAssociationPopHelper:function(e,t){e&&e.setData("showAssociatePop",!1);var i=document.getElementsByTagName("crm-kiosk-association-popup");(void 0!==i&&i.length>0&&(i[0].remove(),this.$node.remove()),t)&&(Lyte.Router.transitionTo({route:"crm.settings.section.kiosk.index-kiosk"}).data={})},showkioskCruxErrorMsg:function(e){0===document.getElementsByClassName("kioskCruxError").length&&_cruxUtils.showCustomMessage({params:{ltPropMessage:e.message,ltPropType:"error",ltPropClass:"kioskCruxError"}})},showkioskCruxWarningMsg:function(e){0===document.getElementsByClassName("kioskCruxWarning").length&&_cruxUtils.showCustomMessage({params:{ltPropMessage:e.message,ltPropType:"warning",ltPropDuration:"4000",ltPropYield:!0,ltPropClass:"kioskCruxWarning"}})},trackActionsDoneInKiosk:function(e){if((!localStorage.getItem("trackActionsInPFDisabledTime")||t.getTime()-localStorage.getItem("trackActionsInPFDisabledTime")<72e5)&&(!localStorage.getItem("api_enable_time")||localStorage.getItem("api_enable_time")<=t.getTime()||!JSON.parse(localStorage.getItem("is_limit_reached")))&&"false"===RebrandLinkUtil.getProperties("IS_LOCAL_ZOHO").IS_LOCAL_ZOHO&&"false"===RebrandLinkUtil.getProperties("ISDEVELOPMENT").ISDEVELOPMENT&&"US"===RebrandLinkUtil.getProperties("DeploymentLocation").DeploymentLocation){var t=$L.moment().toDate(),i=$("<div/>").html(Crm.userDetails.EMAIL).text(),s="",a="";"create"===e&&(a="514000003101415",s="fffe0af5db6eca31f5425d10796cc8613275914f8732c3dd1360cac6202909b3"),"publish"===e&&(a="514000003126810",s="bac14e932ac1f815ddee1f2593e2e799313aadcd3fe9c558663b9cc5494f3624"),"associate"===e&&(a="514000003128195",s="a467b6af2a68a16c67081fc4ac79c26fd5523d29eb1a16b9f2b9ff3d3e9c2dad");var o="https://"+RebrandLinkUtil.getProperties("CCSIGNALS").CCSIGNALS+"/signals/v1/Signals__s/"+a+"/actions/invoke_webhook?digest="+s+"&email="+i;$L.ajax({url:o,type:"POST",success:function(e){if(e){var t=e.responseText;if(t){var i=JSON.parse(t);i&&i.code&&("SUCCESS"===i.code&&JSON.parse(localStorage.getItem("is_limit_reached"))?localStorage.setItem("is_limit_reached",!1):"LIMIT_EXCEEDED"===i.code&&localStorage.setItem("is_limit_reached",!0))}}},error:function(e){if(e){var t=e.responseText;if(t){var i=JSON.parse(t);i&&i.code&&"LIMIT_EXCEEDED"===i.code&&localStorage.setItem("is_limit_reached",!0)}}}})}},loadZiaWidgetsInScreen:function(e,t,i){if(e){for(var s=store.peekAll("module"),a=e.length,o={},r=0;r<a;r++){var n=e[r];if("zia_insights"===n.type&&n.zia_insight){var l=n.zia_insight,d=l.value;if(d&&d.length>0){var c=d[0].parent_record_details;let e=c.id;var u,m=[];o[e]?(u=o[e],m=u.ziaFeatures):((u={}).ziaFeatures=m,u.record=c,u.module_name=Lyte.registeredMixins.kiosk_execute.filterObjArrByApiName(s,c.module.api_name).module_name,o[e]=u),m.push(l)}}}var _=Lyte.registeredMixins["zia-insights-utils"];for(var p in o){if(o.hasOwnProperty(p))!function(e,t,i,s){let a=i.module_name,o=i.ziaFeatures,r=i.record,n=o.map((e=>e.component_name));var l=store.peekRecord("features-status",moduleRecordMapping[a].api_name);(l=l||store.findAll("features-status",{module:moduleRecordMapping[a].api_name,group:"zia",page:1,per_page:20},!0,!0))&&_.invokeZiaInsightsAPI(moduleRecordMapping[a],e,n).then((function(){let i=o.length;for(let n=0;n<i;n++){let i=o[n],l="#process_flow_zia_output_"+t+"_"+e+"_"+i.api_name+"_"+i.component_name;_.renderZiaFeatureComponent(i.component_name,a,r,l,s,"kiosk",t,i.api_name)}}))}(p,t,o[p],i)}}},isKioskReadOnlyMode:function(e){var t=!1;return e&&(null!==e.data?t=!1:e.previous_states&&e.previous_states.length>1?t=!0:e.elements&&e.elements.forEach((function(e){"get_records"!==e.type&&"zia_insights"!==e.type||(t=!0)}))),t},constructScreenOutputData:function(e,t,i,s,a){var o={};o.kioskId=t;var r=null!==e.data;Lyte.registeredMixins.kiosk_execute.setKioskPreviewResponseData(e,o);var n=!1,l=!1;return a?n=!0:"home_page"!==i&&"canvas"!==i&&"detail_view"!==i||s||r||(l=!0,n=Lyte.registeredMixins.kiosk_execute.isKioskReadOnlyMode(e)),o.executeFromStart=l,o.isReadOnlyMode=n,o.showScreen=!0,o.execute_from=i,o.tableHeight=o.isReadOnlyMode?"":"350px",o.isBlankScreenMode=o.isReadOnlyMode,o.isPreviewMode=!1,o.isLoadInSameScreen="home_page"===i||"canvas"===i||"detail_view"===i,o.isHomePage="home_page"===i,o},setKioskPreviewResponseData:function(e,t){e&&(e.executable_info&&(featuresAvailable&&featuresAvailable.KIOSK_NEW_ACTIONS?t.screenName=e.title:t.screenName=e.executable_info.state.name,t.stateId=e.executable_info.state.id,t.screenButtons=e.executable_info.transitions),e.Current_Record&&e.Current_Record.hasOwnProperty("id")?t.current_record_id=e.Current_Record.id:t.current_record_id=e.Current_Record,null!==e.data&&(t.defaultLoadData=e.data),e.kiosk&&(t.kioskName=e.kiosk.name),e.id&&(t.recordId=e.id))},dropCanvasCache:function(){"undefined"!=typeof Customization&&Customization&&Object.keys(Customization.canvasRefresh).length>0&&(Customization.canvasRefresh[Object.keys(Customization.canvasRefresh)[0]]=!0)},dropDetailViewCache:function(e,t){e?store.clearCachedQuery("dummy",{module:e.api_name,include_inner_details:"_associations.detail_view_page.module,_associations.detail_view_page.layout"}):t.forEach((function(e){store.clearCachedQuery("dummy",{module:e.api_name,include_inner_details:"_associations.detail_view_page.module,_associations.detail_view_page.layout"})}))},getKioskElementIdFromCanvas:e=>"#canvas_kiosk_screen_"+e,setKioskRefreshLoad:function(e){var t=$L("crm-detailview-header");t&&t.length>0&&t[0].component.setData("isKioskRefresh",e)},setKioskExecution:function(e){var t=$L("crm-detailview-header");t&&t.length>0&&t[0].component.setData("isKioskExecution",e)},isKioskRefresh:function(){var e=$L("crm-detailview-header");if(e&&e.length>0)return e[0].component.getData("isKioskRefresh")},isKioskExecution:function(){var e=$L("crm-detailview-header");if(e&&e.length>0)return e[0].component.getData("isKioskExecution")},loadKioskRefreshPop:function(){var e=$L("crm-detailview-header");e&&e.length>0&&e[0].component.handlingKioskRefreshMessagePopup()},destoryKioskRefreshPop:function(){$L(".wfRefreshInfo").length>0&&_cruxUtils.removeCustomMessage()},getDetailViewKioskSupportedModules:function(e){return store.peekAll("module").filter((function(e){if(e.visible&&e.api_supported&&e.show_as_tab&&1===e.visibility&&("default"===e.generated_type||"custom"===e.generated_type||"linking"===e.generated_type)&&e.viewable&&"team_based"===e.access_type)return e.private_profile&&"Admins"===e.private_profile.name||Crm.userDetails.IS_ADMIN})).forEach((function(t){e.includes(t)||e.push(t)})),e},addKiosk:function(e,t,i,s){if(Crm.isKioskEnabled){var a=Lyte.registeredMixins.kiosk_execute.getListViewResources();Lyte.injectResources(a,void 0,(function(){var t={},a=moduleRecordMapping[moduleApiVsNameMapping[e.api_name]];t.module=a,t.layout=i,Lyte.registeredMixins.kiosk_execute.loadKioskListViewPopup("detail_view",t,null,null,s)}))}},previewKiosk:function(){for(var e=$("div[id^='kioskDetailView_']:visible"),t=$L("#dvinner").scrollTop(),i=t+renderingUtils.windowHeight,s=e.length,a=0;a<s;a++){var o=e.eq(a),r=renderingUtils.findPosY(e[a]),n=r+o.height();if("true"!==o.attr("istriggered")&&n>=t&&r<=i&&n<=i&&r>=t){o.attr("istriggered","true");var l=$L("crm-kiosk-record-detail-view-wrapper")[a];l&&l.component.setData("isRendered",!0)}}},getKioskDetailViewJson:function(e,t,i){var s=[];if(e.associated_kiosks){var a=e.associated_kiosks.length,o="A"===Crm.userDetails.LICENSE_TYPE?3:5;if(a>0)for(var r=1;r<=a;r++){var n={},l={};if(e.associated_kiosks[r]){var d=e.associated_kiosks[r].kioskId;n.kioskId=d,n.name=e.associated_kiosks[r].name,n.currentRecordId=t,n.module=moduleRecordMapping[i].api_name,n.resourceId=e.associated_kiosks[r].resourceId,l.kioskId=d,l.module=i,l.execute_from="detail_view",l.currentRecordId=t,r>o&&(l.isPreviewLimitReached=!0),n.detailViewKioskData=l,s.push(n)}}}return s},getDetailViewAssociations:function(e,t,i){var s=moduleRecordMapping[e].api_name,a=[];return store.findAll("dummy",{module:s,include_inner_details:"_associations.detail_view_page.module,_associations.detail_view_page.layout"},!0,!1,{url:"/crm/v6/settings/kiosks/associations"}).then((function(s){if(s){if(a=Lyte.registeredMixins.kiosk_execute.getDetailViewKioskAssociationsFromResponse(s,e,t),!Crm.renderDVLyteFlow(e))return a;var o="A"===Crm.userDetails.LICENSE_TYPE?3:5;if(a&&a.length-1>=o){var r=$L("crm-detailview-actions")[0];r&&(r.setData("isKioskAssocLimitReached",!0),$L("#drop_action_kiosk").addClass("disabled",!0))}if(a&&a.length>0){var n=Lyte.registeredMixins.kiosk_execute.getListViewResources();Lyte.injectResources(n,void 0,(function(){Lyte.objectUtils(i.getData("kiosk_info"),"add","associated_kiosks",a),Lyte.objectUtils(i.getData("show_info"),"add","kiosk_components",!0)}))}}}),(function(e){if(e)return commonUtils.showHideLoadingDiv(!1),a}))},getDetailViewKioskAssociationsFromResponse:function(e,t,i){for(var s=[],a=e.kiosks.length,o=0;o<a;o++){var r=e.kiosks[o]._associations;if(r)for(var n=r.length,l=0;l<n;l++)if(r[l].detail_view_page)for(var d=r[l].detail_view_page,c=d.length,u=0;u<c;u++){var m=d[u];if(m.module.id===moduleRecordMapping[t].id&&m.layout.id===i){var _={};_.kioskId=e.kiosks[o].id,_.name=m.name,_.resourceId=m.id,s[m.sequence_number]=_}}}return s},renderKiosk:function(e,t,i){var s=e.associated_kiosks.length,a="A"===Crm.userDetails.LICENSE_TYPE?3:"P"===Crm.userDetails.LICENSE_TYPE?1:5;s>0&&($L("crm-kiosk-record-detail-view-container-wrapper")[0]||Lyte.Component.render("crm-kiosk-record-detail-view-container-wrapper",void 0,"#kioskDetailView"),$("#kioskDetailView").css("display","block"));for(var o=1;o<=s;o++){var r=$L("#kioskDetailView_"+o);if(r.length>0){var n={},l={};if(e.associated_kiosks[o]){var d=e.associated_kiosks[o].kioskId;n.kioskId=d,n.name=e.associated_kiosks[o].name,n.currentRecordId=t,n.module=moduleRecordMapping[i].api_name,n.resourceId=e.associated_kiosks[o].resourceId,l.kioskId=d,l.module=i,l.execute_from="detail_view",l.currentRecordId=t,o>a&&(l.isPreviewLimitReached=!0),n.detailViewKioskData=l,r[0].style.display="block",Lyte.Component.render("crm-kiosk-record-detail-view-wrapper",n,"#kioskDetailView_"+o)}}}}}),store.registerModel("kiosk_datahub",{id:Lyte.attr("string",{primaryKey:!0}),name:Lyte.attr("string",{default:""}),datahub:Lyte.attr("object",{default:{}}),selection_details:Lyte.attr("object",{default:{}}),dynamic_variable_mappings:Lyte.attr("array",{default:[]}),display_fields:Lyte.attr("array",{default:[]})}),store.registerAdapter("kiosk_datahub",{namespace:"crm/v6/settings/kiosks/datahubs",buildURL:function(e,t,i,s,a,o,r){return a=a.replace("kiosks/datahubs/kiosk_datahub","kiosks/"+r.processId+"/datahub_associations")},processRequest:function(){commonUtils.showHideLoadingDiv(!0)},methodForRequest:function(e){return"PATCH"===e?"PUT":e},parseResponse:function(e,t,i,s){return s=this.super(arguments)}}),store.registerSerializer("kiosk_datahub",{serialize:function(e,t){var i={};return i.datahub_associations=[t.kiosk_datahub],i},normalizeResponse:function(e,t,i){return"createRecord"!==t&&"updateRecord"!==t||(i.datahub_associations=i.datahub_associations[0].details),i.datahub_associations||(i.datahub_associations=[]),i},payloadKey:function(){return"datahub_associations"}});
