var CrmPhoneNumbers={currentActivityId:void 0!==CrmPhoneNumbers&&CrmPhoneNumbers.currentActivityId?CrmPhoneNumbers.currentActivityId:null,showConversionForm:function(e,n,o,r,t){"NO_CHANGE"!=r&&(CrmPhoneNumbers.currentActivityId=r),null!=n&&"null"!=n&&n!==I18n.getMsg("crm.tpi.ctiapi.label.notification.unknowncaller")||(n=""),n=n.trim();var i=Crm.getCrmBasePath()+"/QCreate.do",a={fromCreate:"QuickCreate",module:e,ctiapi:!0,isPhoneNoConversion:!0,phoneno:n,phoneNoId:o};t&&(a.layoutId=t),networkUtils.setCsrfParam(a),(new crmRequestPool).initiate({action:i,cache:!1,type:"GET",data:a,success:function(e){if(-1!==e.indexOf("createEntityForm")){Crm.downloadValidationRules(Crm.getCrmBasePath()+"/QCreate.do?module="+a.module,a.module);var o=$("#ctinotifier_center");CrmPhoneNumbers.setupFormBackground(),o.html(e).show();var t=o.outerHeight()/2;o.css("margin-top","-"+t+"px"),commonUtils.showHideLoadingDiv(),CrmPhoneNumbers.populatePhoneNumberInForm($("form[name=createEntityFormbyPhoneConversion]"),n)}else"noPhoneFields"===e?CrmPhoneNumbers.noFieldErrFn():CrmPhoneNumbers.closeConversionForm();"NO_CHANGE"!=r&&(CrmPhoneNumbers.currentActivityId=r)},error:function(){CrmPhoneNumbers.closeConversionForm()}})},saveAndConvertToEntity:function(e,n,o,r){var t=$(n),i=t.closest("form").get(0).name;new Promise((function(n){n(CVRExec.evalRules("edit",e))})).then((function(n){if(n&&quickCreateValidateAction("All",e,i)){multiSelectRemoval(i),t.attr("disabled",!0);var a=commonUtils.formData2QueryString(document.createEntityFormbyPhoneConversion,e);(new crmRequestPool).initiate({action:Crm.getCrmBasePath()+"/QuickCreateCommonModule.do?isload=true",type:"POST",data:a,success:function(e){if(e.entityId)crmui.showMsgBand("success",I18n.getMsg("crm.label.creator.created.successMsg"),4e3),CrmPhoneNumbers.convertPhoneNoToEntity(r,o,e.entityModule,e.entityId,e.entityName,CrmPhoneNumbers.noFieldErrFn);else if("DUPLICATE"===e.STATUS){var n=commonUtils.getDuplicateErrorMsg(e.INFO[0],!1,!1);crmui.showMsgBand("error",n,4e3),t.attr("disabled",!1)}else crmui.showMsgBand("error",I18n.getMsg("crm.unable.to.process.request"),4e3),t.attr("disabled",!1)},error:function(){crmui.showMsgBand("error",I18n.getMsg("crm.unable.to.process.request"),4e3),t.attr("disabled",!1)}})}}))},convertPhoneNoToEntity:function(e,n,o,r,t,i){var a={phoneNoId:e,fromActivityId:CrmPhoneNumbers.currentActivityId,toModule:o,toEntityId:r,toEntityName:t};if("undefined"!=typeof ctiApiNotifier){var s=ctiApiNotifier.getCallRefIdForPhoneNo(n);s&&(a.callRefId=s)}networkUtils.setCsrfParam(a),(new crmRequestPool).initiate({action:Crm.getCrmBasePath()+"/ConvertPhoneNumber.do",type:"POST",data:a,success:function(e){if(e&&"FAILURE"===e.STATUS)return CrmPhoneNumbers.closeConversionForm(),void i();var a=new BasicEntityInfo(o,r,t);CrmPhoneNumbers.closeConversionForm(a),$(".phoneNo_"+n).parent().trigger("convertedFromPhone",[r,o,t]),CrmPhoneNumbers.currentActivityId&&Lyte.triggerEvent("phone_entity_conversion_"+CrmPhoneNumbers.currentActivityId,o,r,t)},error:function(){CrmPhoneNumbers.closeConversionForm(),i()}})},setupFormBackground:function(){Crm.menu.globalHideMenu();$("#crm_phnoconversion_freezeLayers").remove(),$("body").append("<div id='crm_phnoconversion_freezeLayers' class='ctiapiFreezeLayer' style='opacity:0.1;z-index:20;'></div>")},closeConversionForm:function(e){$("#ctinotifier_center,#availField").empty().hide(),$("#crm_phnoconversion_freezeLayers").remove(),Crm.isHeadless&&"undefined"!=typeof WindowsCommunicator&&(e?WindowsCommunicator.notifyParent("crm-quick-create",e):WindowsCommunicator.notifyParent("cancel-operation"))},populatePhoneNumberInForm:function(e,n){if(n!==I18n.getMsg("crm.tpi.ctiapi.label.notification.unknowncaller")){var o=e.find("input[data-sysrefname='Phone']"),r=e.find("input[data-sysrefname='Mobile']");o.length>0?Crm.userDetails.isPhoneNoNewView?CrmPhoneNumberInput.setPhoneValue(o,n):o.val(n):r.length>0?Crm.userDetails.isPhoneNoNewView?CrmPhoneNumberInput.setPhoneValue(r,n):r.val(n):$("#qcFieldsContent").find(".labelValCreate").each((function(e,o){var r=$(o).find("input");if(r.data("uitype")==CrmFieldConstants.PHONE)return Crm.userDetails.isPhoneNoNewView?CrmPhoneNumberInput.setPhoneValue(r,n):r.val(n),!1}))}},showAssociateForm:function(e,n,o,r){CrmPhoneNumbers.currentActivityId=r,CrmPhoneNumbers.getAvailablePhoneFields(e,void 0,void 0,void 0,(function(){var r="associatePhNoForm"+o,t=Crm.getCrmBasePath()+"/Search.do?searchmodule="+e+"&fldName=assocWithName&fldId=assocWithId&targetForm="+r;Crm.menu.globalHideMenu(),$("#assocWithModule").val(e),commonUtils.openCustomLookup(t,void 0,"topBandPopup",renderingUtils.windowWidth-300),CRMLookupCallBack=function(){CRMLookupCallBack=null,$("form[name="+r+"]").each((function(){var r=$(this).find("#assocWithId").val();if(r){var t=$(this).find("#assocWithName").val();return CrmPhoneNumbers.onInputChange(r,t,e,n,o),!1}}))}}),CrmPhoneNumbers.noFieldErrFn)},onInputChange:function(e,n,o,r,t){CrmPhoneNumbers.setupFormBackground();var i="CrmPhoneNumbers.saveFieldAndConvertToEntity('"+o+"','"+e+"','"+$ESAPI.encoder().encodeForJavaScript(n)+"','"+r+"','"+t+"');";CrmPhoneNumbers.getAvailablePhoneFields(o,e,i,"CrmPhoneNumbers.closeConversionForm()",CrmPhoneNumbers.populateAvailablePhoneFields,CrmPhoneNumbers.noFieldErrFn)},getAvailablePhoneFields:function(e,n,o,r,t,i){var a={mode:"getAvailablePhoneFieldMap",entityId:n,module:e};(new crmRequestPool).initiate({action:Crm.getCrmBasePath()+"/CtiApiConfig.do",type:"GET",data:a,success:function(n){n.length?t(e,n,o,r):i&&i()}})},populateAvailablePhoneFields:function(e,n,o,r){if(n.sort(CrmPhoneNumbers.sortPhoneFields),n.filter((e=>!1===e.isFieldLocked)).length>0){var t={};t.availFields=n,t.module=e,t.saveFn=o,t.cancelFn=r;var i=Handlebars.templates.show_available_phn_fields(t);$("#availField").html(i).show();var a=$("input.availPhnField:not(:disabled)");a.eq(0).siblings(".fieldValue").length<1&&a.eq(0).attr("checked",!0),a.on("change",CrmPhoneNumbers.changePhoneField)}else CrmPhoneNumbers.noFieldErrFn()},saveFieldAndConvertToEntity:function(e,n,o,r,t){var i=$("input[type=radio][name='availPhnField']:checked"),a=JSON.parse(i.attr("value")),s="/crm/v2/"+e+"/"+n+"?affected_data=true",l={},m=[],c={};l[a.SYS_REF_NAME]=r,m.push(l),c.data=m;var u={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken};clientPortalName&&(u["X-CRMPORTAL"]=window.clientPortalName),(new crmRequestPool).initiate({action:s,type:"PUT",data:JSON.stringify(c),headers:u,contentType:"application/json",success:function(){$("#availField").empty().hide();var i=I18n.getMsg("PHONE NUMBER");crmui.showMsgBand("success",I18n.getMsg("crm.social.entity.associate.success",i),4e3),CrmPhoneNumbers.convertPhoneNoToEntity(r,t,e,n,o,(function(){crmui.showMsgBand("error",I18n.getMsg("crm.privileges.restrict"),"infinity",null)}))},error:function(){crmui.showMsgBand("error",I18n.getMsg("crm.privileges.restrict"),"infinity",null)}})},sortPhoneFields:function(e,n){return e.fieldValue||n.fieldValue?e.fieldValue?n.fieldValue&&!0===e.isPrimaryCol?-1:1:-1:!0===e.isPrimaryCol?-1:1},noFieldErrFn:function(){renderingUtils.showCustomAlert(I18n.getMsg("crm.calls.error.noassociate.field"),void 0,void 0,CrmPhoneNumbers.closeConversionForm)},changePhoneField:function(){1===$(this).siblings(".fieldValue").length?$("#rcpref").find("#save").attr({value:I18n.getMsg("crm.button.replace")}):$("#rcpref").find("#save").attr({value:I18n.getMsg("Save")})}};