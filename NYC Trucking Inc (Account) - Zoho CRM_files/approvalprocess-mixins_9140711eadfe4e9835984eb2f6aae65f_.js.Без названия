Lyte.Mixin.register("approvalprocess",{setIpType:function(e){detailView.adminapproval="","2"===e?($L("#currentStage").addClass("hide"),$L("#currentAndUpcoming").removeClass("hide")):"1"===e&&($L("#currentStage").removeClass("hide"),$L("#currentAndUpcoming").addClass("hide")),this.setData("adminUsers",e)},closeModal:function(e){this.setData("show",!1),Lyte.registeredMixins.approvalprocess.onCloseActions(this.getData("fromSource"),e,this.getData("subformPromise")),this.$node.remove()},onCloseActions:function(e,a,r){(detailView.appObj="",r&&r[1]&&r[1](),"removeFOL"===e&&crmui.hidePopup("VRAjaxEdit"),"removeDVS"===e&&hideAnimatePopup("subSecondaryPopup",!1),"removeLRMandatoryFields"===e&&CFRExec.hideWorkingContainer(),"removedvCanvas"===e)&&((n=$L("crm-canvas-ajaxeditpopup"))&&n.length>0&&n[0].setData("showAjaxPop",!1));if(("MXNdv"===e||"removeMXNdv"===e)&&((n=$L("crm-multi-selection-popup"))&&n.length>0&&(n[0].setData("loader",!1),n[0].setData("showUnassignPopup",!1),"MXNdv"===e))){for(var o=$L("#mlSelectedRecord"),t=$L(o.closest("lyte-modal-content")).find(".lyteExpTableRowGroup lyte-checkbox"),i=t.length,s=0;s<i;s++)t[s].ltProp("checked",!1);n[0].setData({selectcount:"0",unassigncount:"0",tempIds:"0",remove_tempIds:"0",remove_confirm_tempIds:"0"})}if("dv"===e&&(itsonview=!0),"editFromTasks"===e){var l=saveTasksBtn?saveTasksBtn.length:0,d=$L("#cancelTasksBtn");if(l>0)for(var p=0;p<l;p++)saveTasksBtn[p].prop("disabled",!1);else $L("#saveTasksBtn").prop("disabled",!1),d.prop("disabled",!1)}var n,c=$L("crm-create-buttons");("edit"===Lyte.Router.getRouteInstance().routeName&&0!==c.length&&c[0].component.setData("disableFormbuttons",!a),"canvas"===Lyte.Router.getRouteInstance().routeName)&&("form_edit"===Lyte.Router.getRouteInstance().currentModel.form_type?Lyte.registeredMixins.approvalprocess.disableBtnActions(!a):(n=$L("#AjaxEditComponent,#elementEditConfirm, #elementSpanCancel")).removeClass("zc-disabled-tool"));Lyte.Router.getRouteInstance().currentModel.isWizard&&$L("crm-create-layout")[0].component.setData("disableFormbuttons",!1)},getSelectedFieldsData:function(e,a,r){if(0!==approvalProcess.arrayApprover.length){for(var o=void 0!==approvalProcess.arrayApproverJson[e+""]?approvalProcess.arrayApproverJson[e+""].length:0,t=1;t<=o;t++){var i=r?t:"waitingArr",s=a[i+"dAp"],l=a[i+"dRp"];void 0===s&&(s="No Fields"),void 0===l&&(l="All Fields"),s=void 0!==approvalProcess.approvalField[i+"dAp"]?approvalProcess.approvalField[i+"dAp"]:s,l=void 0!==approvalProcess.approvalField[i+"dRp"]?approvalProcess.approvalField[i+"dRp"]:l,a[i+"dAp"]=s,a[i+"dRp"]=l;var d=a[i+"Ap"],p=a[i+"Rp"];if(void 0!==d){for(var n=d.length,c=[],u=0;u<n;u++)d[u].api_name&&c.push(d[u].api_name);0!==c.length&&(a[i+"Ap"]=c),void 0===approvalProcess.approvalField[i+"Ap"]&&(approvalProcess.approvalField[i+"Ap"]=c)}if(void 0!==approvalProcess.approvalField[i+"Ap"]&&(a[i+"dAp"]=s,"object"==typeof approvalProcess.approvalField[i+"Ap"]?a[i+"Ap"]=approvalProcess.approvalField[i+"Ap"]:a[i+"Ap"]=JSON.parse(replace(approvalProcess.approvalField[i+"Ap"],'\\"','"'))),void 0!==p){for(n=p.length,c=[],u=0;u<n;u++)p[u].api_name&&c.push(p[u].api_name);0!==c.length&&(a[i+"Rp"]=c),void 0===approvalProcess.approvalField[i+"Rp"]&&(approvalProcess.approvalField[i+"Rp"]=c)}if(void 0!==approvalProcess.approvalField[i+"Rp"]&&(a[i+"dRp"]=l,a[i+"Rp"]="object"==typeof approvalProcess.approvalField[i+"Rp"]?approvalProcess.approvalField[i+"Rp"]:JSON.parse(replace(approvalProcess.approvalField[i+"Rp"],'\\"','"'))),approvalProcess.approvalField[i+"dAp"]=s,approvalProcess.approvalField[i+"dRp"]=l,!r)break}approvalProcess.unmodifiedApprovalField=Lyte.deepCopyObject(approvalProcess.approvalField),approvalProcess.approvalFieldJson[e+""]=approvalProcess.approvalField}},constructDataForApprovalProcess:function(e,a,r){var o={};o.data=[e];var t=$L("crm-create-layout")[0];if(t=Lyte.registeredMixins["crm-detailcanvas-utils"]&&Lyte.registeredMixins["crm-detailcanvas-utils"].isFormViewCommonCheck()?$L("crm-canvas-form")[0]:t){o.skip_mandatory=t.component.data.skipMandatory;var i=t.component.data.currsubformApinames;i&&i.length&&i.forEach((function(e){var a=o.data[0][e];a&&a.forEach((function(e){delete e.__CUSTOM_sequence_NUMBER__}))}))}var s=a.$.getDirtyAttributes()||[];for(var l in s.forEach((function(e){"fileupload"===a.$.model.fieldList[e].fieldType&&o.data[0][e].filter((function(e){e.file_id&&(e.File_Id__s=e.file_id,delete e.file_id)}));var r=$L("crm-stage-verify-popup");if("Closing_Date"===e&&"date"===a.$.model.fieldList[e].fieldType&&0!==r.length){var t=r[0].getData("modalFields");"Potentials"===r[0].getData("module")&&t&&t.filter((function(e){"Closing_Date"===e.api_name&&e.read_only&&delete o.data[0].Closing_Date}))}var i=$L("crm-create-pricingdetails");appMod&&"PriceBooks"===appMod&&"Pricing_Details"===e&&"text"===a.$.model.fieldList[e].fieldType&&0!==i.length&&(i[0].getData("isPricingDetailsReadonly")&&delete o.data[0].Pricing_Details)})),o.data[0].hasOwnProperty("__DUMMY_Request_Trigger__FIELD")&&delete o.data[0].__DUMMY_Request_Trigger__FIELD,o.data[0])void 0===o.data[0][l]&&(o.data[0][l]=null);if(Crm.curr_sub_Form_DetailS&&Crm.userDetails.isSubformNewComponentEnabled){Crm.curr_sub_Form_DetailS.subRecDetails={},Crm.curr_sub_Form_DetailS.modulesData={};var d=!!a&&a.$.getDirtyAttributes().contains("Currency");Crm.curr_sub_Form_DetailS.apiNames.forEach((function(e){var t=[];if(o.data[0][e]){var i=a[e],s=o.data[0][e],l=i.model._name,p=i.model.fieldList,n=[],c=[];i=[],a[e].forEach((function(a,r){(a.$.getDirtyAttributes()||[]).forEach((function(a){"fileupload"===p[a].fieldType&&o.data[0][e][r][a].filter((function(e){e.file_id&&(e.File_Id__s=e.file_id,delete e.file_id)}))}))}));var u={},f={},m={};r&&(u=r.subformVsCachedRowIds,f=r.subformVsRemovedRowIds,m=r.subformVsNewRowIds),u[e]&&u[e].forEach((function(a){if(-1===f[e].indexOf(a)){var r=store.peekRecord(l,a).$.toJSON();i.push(r)}})),moduleDetailedInfo.modules.forEach((function(a){a.api_name===e&&(Crm.curr_sub_Form_DetailS.modulesData[e]=store.peekRecord("module",a.id))}));var v=Crm.curr_sub_Form_DetailS.modulesData&&Crm.curr_sub_Form_DetailS.modulesData[e]&&Crm.curr_sub_Form_DetailS.modulesData[e].editable;i.forEach((function(a){var r=!1,o=store.peekRecord(l,a.id),i=o.$.getDirtyAttributes();for(var u in p)p[u].fieldID&&-1===["SERIAL_NUMBER","SMCREATORID","CREATEDTIME"].indexOf(p[u].columnName)&&"formula"!==p[u].fieldType&&(a[u]="string"==typeof a[u]?a[u]&&"[]"===a[u]?"":a[u].trim():a[u],((a[u]||0===a[u])&&"picklist"!==p[u].fieldType&&"fileupload"!==p[u].fieldType||a[u]&&"picklist"===p[u].fieldType&&"-None-"!==a[u]||"fileupload"===p[u].fieldType&&!Lyte.registeredMixins.approvalprocess.isFileUploadFieldEmpty(a[u]))&&(r="true"!==a.removedRow)),Crm.userDetails.SUBFORM_PERMISSIONS&&!v&&!o.$.isNew&&p[u].fieldID&&("formula"===p[u].fieldType||d&&"currency"===p[u].fieldType||"SERIAL_NUMBER"===p[u].columnName)&&i.contains(u)&&delete s.find((function(e){return a.id===e.id}))[u];var f=m[e].indexOf(a.id)>-1?void 0:a.id;r&&(n.push(a),t.push(f)),c.push({isValid:r,id:f})}));var _=[];if(c.forEach((function(e){e.isValid||_.push(e.id)})),n=Lyte.registeredMixins.approvalprocess.serializeSubformCahedRowsData(n,p),Crm.curr_sub_Form_DetailS.orgSubformData&&Crm.curr_sub_Form_DetailS.orgSubformData[e])for(var y=Crm.curr_sub_Form_DetailS.orgSubformData[e].filter((function(a){return-1===_.indexOf(a.id)&&(f[e]&&f[e].contains(a.id)||!t.contains(a.id))})),h=y&&y.length?y.length:0,g=0;g<h;g++){var R={id:y[g].id,_delete:null};n.push(R)}var D=[],b=0;this.subformApiNameVsRecIndices=this.subformApiNameVsRecIndices?this.subformApiNameVsRecIndices:{},this.sfPartialPayLoadRecIds=this.sfPartialPayLoadRecIds?this.sfPartialPayLoadRecIds:{},this.sfPartialPayLoadRecIds[e]=o.data[0][e].mapByKey("$"),this.sfPartialPayLoadRecIds[e]&&this.sfPartialPayLoadRecIds[e].length>0&&(this.sfPartialPayLoadRecIds[e]=this.sfPartialPayLoadRecIds[e].mapByKey("pK")),this.sfPartialPayLoadRecIds[e]&&0!==this.sfPartialPayLoadRecIds[e].length||(this.sfPartialPayLoadRecIds[e]=o.data[0][e].mapByKey("id"));var I=[];n.forEach((function(a,t){var i=!1;o.data[0][e].forEach((function(e){if(e.$.pK===a.id&&I.push(t),e.id===a.id)return i=!0,void(a.hasOwnProperty("_delete")||(a=e))})),(r&&r.cloneData||m&&-1!==m[e].indexOf(a.id))&&delete a.id,i||!a.hasOwnProperty("id")?D[b]=a:a.hasOwnProperty("_delete")?(D[b]={id:a.id},D[b]._delete=a._delete):(D[b]={id:a.id},a.hasOwnProperty("_delete")&&(D[b]._delete=a._delete)),b++})),this.subformApiNameVsRecIndices[e]=I,o.data[0][e]=D,Lyte.registeredMixins.approvalprocess.setPayLoadValues(o,e,l),Crm.curr_sub_Form_DetailS.subRecDetails[e]=c}else if(!o.data[0][e]&&a[e]&&a[e].length>0){var F=a[e],C=[];F.forEach((function(e){C.push({id:e.id})})),o.data[0][e]=C}}))}else if(Crm.curr_sub_Form_DetailS&&!Crm.userDetails.isSubformNewComponentEnabled){Crm.curr_sub_Form_DetailS.subRecDetails={},Crm.curr_sub_Form_DetailS.modulesData={};d=!!a&&a.$.getDirtyAttributes().contains("Currency");Crm.curr_sub_Form_DetailS.apiNames.forEach((function(e){var t=[];if(o.data[0][e]){var i=a[e],s=o.data[0][e],l=i.model.fieldList,p=[],n=[];moduleDetailedInfo.modules.forEach((function(a){a.api_name===e&&(Crm.curr_sub_Form_DetailS.modulesData[e]=store.peekRecord("module",a.id))}));var c=Crm.curr_sub_Form_DetailS.modulesData&&Crm.curr_sub_Form_DetailS.modulesData[e]&&Crm.curr_sub_Form_DetailS.modulesData[e].editable;i.forEach((function(a,r){var i=!1,u=a.$.getDirtyAttributes();for(var f in l){l[f].fieldID&&"SERIAL_NUMBER"!==l[f].columnName&&"formula"!==l[f].fieldType&&(a[f]="string"==typeof a[f]?a[f]&&"[]"===a[f]?"":a[f].trim():a[f],((a[f]||0===a[f])&&"picklist"!==l[f].fieldType&&"fileupload"!==l[f].fieldType||a[f]&&"picklist"===l[f].fieldType&&"-None-"!==a[f]||"fileupload"===l[f].fieldType&&!Lyte.registeredMixins.approvalprocess.isFileUploadFieldEmpty(a[f]))&&(i="true"!==a.removedRow)),Crm.userDetails.SUBFORM_PERMISSIONS&&!c&&!a.$.isNew&&l[f].fieldID&&("formula"===l[f].fieldType||d&&"currency"===l[f].fieldType)&&u.contains(f)&&delete s.find((function(e){return a.id===e.id}))[f],(a.$.getDirtyAttributes()||[]).forEach((function(a){"fileupload"===l[a].fieldType&&o.data[0][e][r][a].filter((function(e){e.file_id&&(e.File_Id__s=e.file_id,delete e.file_id)}))}))}i&&(p.push(Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.SUBFORM_PERMISSIONS?a.$.toJSON():o.data[0][e][r]),t.push(a.id)),n.push({isValid:i,id:a.id})}));var u=[];if(n.forEach((function(e){e.isValid||u.push(e.id)})),Crm.curr_sub_Form_DetailS.orgSubformData&&Crm.curr_sub_Form_DetailS.orgSubformData[e])for(var f=Crm.curr_sub_Form_DetailS.orgSubformData[e].filter((function(e){return-1===u.indexOf(e.id)&&!t.contains(e.id)})),m=f&&f.length?f.length:0,v=0;v<m;v++){var _={id:f[v].id,_delete:null};p.push(_)}if(Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.SUBFORM_PERMISSIONS){var y=[],h=0,g=void 0!==r.subformVsNewRowIds?r.subformVsNewRowIds:[];p=Lyte.registeredMixins.approvalprocess.serializeSubformCahedRowsData(p,l),this.subformApiNameVsRecIndices=this.subformApiNameVsRecIndices?this.subformApiNameVsRecIndices:{},this.subformDeletedRowIds=this.subformDeletedRowIds?this.subformDeletedRowIds:{},this.subformModRowType=this.subformModRowType?this.subformModRowType:{};var R=[],D=[],b=[];p.forEach((function(a,r){var t=!1;o.data[0][e].forEach((function(e){if(e.$.pK===a.id&&(R.push(r),a.hasOwnProperty("_delete")?(b.push(-1),D.push(a.id)):b.push(1)),e.id===a.id)return a.hasOwnProperty("_delete")||(a=e),void(t=!0)})),t||g&&g[e]&&-1!==g[e].indexOf(a.id)?(g&&g[e]&&-1!==g[e].indexOf(a.id)&&delete a.id,y[h]=a):a.hasOwnProperty("_delete")?(y[h]={id:a.id},y[h]._delete=a._delete):(y[h]={id:a.id},a.hasOwnProperty("_delete")&&(y[h]._delete=a._delete)),h++})),this.subformModRowType[e]=b,this.subformDeletedRowIds[e]=D,this.subformApiNameVsRecIndices[e]=R,o.data[0][e]=y,Lyte.registeredMixins.approvalprocess.setPayLoadValues(o,e,i.model._name)}else p.length?(p.forEach((function(e){for(var a in e)e[a]=void 0===e[a]?null:e[a]})),o.data[0][e]=p):o.data[0][e]=null;Crm.curr_sub_Form_DetailS.subRecDetails[e]=n}else if((Crm.userDetails.FIELD_OF_LOOKUP_IN_SUBFORM||Crm.userDetails.SUBFORM_PERMISSIONS)&&!o.data[0][e]&&a[e]&&a[e].length>0&&!r.cloneData){var I=a[e],F=(l=I.model.fieldList,[]);I.forEach((function(a){var r=!1;for(var t in l)l[t].fieldID&&"SERIAL_NUMBER"!==l[t].columnName&&"formula"!==l[t].fieldType&&(a[t]="string"==typeof a[t]?a[t]&&"[]"===a[t]?"":a[t].trim():a[t],((a[t]||0===a[t])&&"picklist"!==l[t].fieldType&&"fileupload"!==l[t].fieldType||a[t]&&"picklist"===l[t].fieldType&&"-None-"!==a[t]||"fileupload"===l[t].fieldType&&!Lyte.registeredMixins.approvalprocess.isFileUploadFieldEmpty(a[t]))&&(r="true"!==a.removedRow));(a.$.getDirtyAttributes()||[]).forEach((function(a){"fileupload"===l[a].fieldType&&o.data[0][e][index][a].filter((function(e){e.file_id&&(e.File_Id__s=e.file_id,delete e.file_id)}))})),r&&F.push({id:a.id})})),F.length&&(o.data[0][e]=F,o.data[0][e].forEach((function(e){for(var a in e)e[a]=void 0===e[a]?null:e[a]})))}}))}if(r&&r.subformAPIName){var p=this,n=r.subformAPIName,c=r[n],u=c&&c.cxSubformEdit&&c.cxFilterData?c.cxFilterData:{};if(c&&c.isDetailView){o.data[0][n]||(o.data[0][n]=[]);var f=o.data[0][n],m=f[0]?f[0]:{id:Object.keys(u)[0]};if(c.records){var v=[],_=c.cxSubformCreate?m.$.pK:m.id;c.records.forEach((function(e,a){var r,o=e.id;_!==o?r={id:o}:(p.currentRecIndex=a,r=m);var t=u[o]?u[o]:{};for(var i in t)r[i]=t[i];v.push(r)})),c.cxSubformDelete&&(m._delete=null,v.push(m)),o.data[0][n]=v}}}return o},isFileUploadFieldEmpty:function(e){return!e||0===e.filter((function(e){return e.file_id&&(e.File_Id__s=e.file_id,delete e.file_id),!e.hasOwnProperty("_delete")})).length},serializeSubformCahedRowsData:function(e,a){var r,o=[];return e.forEach((function(e){r||(r=Object.keys(e)),r.forEach((function(r){a[r]&&Lyte.Transform[a[r].type]&&(e[r]=Lyte.Transform[a[r].type].serialize(e[r]))})),o.push(e)})),o},setPayLoadValues(e,a,r){e.data[0][a].length?e.data[0][a].forEach((function(e){var a;if(Crm.userDetails.SUBFORM_PERMISSIONS){var o=store.peekRecord(r,e.id);a=o&&!o.$.isNew?o.$.getInitialValues():{}}for(var t in e)e[t]=void 0===e[t]?null:e[t],a&&null===a[t]&&!e[t]&&delete e[t]})):e.data[0][a]=null},saveRecordWithApprovalResponse:function(e,a,r,o,t,i,s){var l="canvas"===Lyte.Router.getRouteInstance().routeName,d="detail"===Lyte.Router.getRouteInstance().routeName,p=l?o:Lyte.Router.getRouteInstance().currentModel,n=!1;"undefined"!=typeof businessCardJson&&"edit"===Lyte.Router.getRouteInstance().routeName&&(n=e.contains("takeover")?!businessCardJson.approversNameList.pendingForApprovalStage:businessCardJson.approversNameList.rejectedData?Object.keys(businessCardJson.approversNameList.rejectedData).length>0:businessCardJson.approversNameList.rejectedData),l&&"form_edit"!==Lyte.Router.getRouteInstance().currentModel.form_type||"undefined"!=typeof businessCardJson&&!n?openRejectorComp(e.contains("takeover")?"takeover":"respond",null,!1,l?"MXNdv"===r?t:t.module_name:d?businessCardJson.module:"editFromTasks"===r?p.module:p.moduleName,void 0,void 0,a,e,i,s,r):store.triggerAction("entity","approval_details",{entityId:l?o.id:"editFromTasks"===r?p.entityId:p.entityrecordData.id,module:l?t.api_name:moduleRecordMapping["editFromTasks"===r?p.module:p.moduleName].api_name},void 0,"GET",!1).then((function(d){for(var n=d.approval_process,c="everyone_sequential"!==n[0].overall_approval_config,u=n.length,f=[],m=[],v="anyone"===n[0].overall_approval_config?1:-1,_="current_approver_decide"===n[0].rejection_type?3:"all_previous_stages"===n[0].rejection_type?1:2,y={},h=[],g=0;g<u;g++){var R=n[g],D={};D.id=R.id;var b=R.approval_status,I=b?b.length:b;if(!I&&R.approval_status)if("approved"!==R.approval_status.status&&-1!==v||3!==_)"pending"===R.approval_status.status&&(0===m.length&&(m.push(R.id),-1===v&&(v=R.order)),D.name=void 0!==R.approver.resource?"groups"===R.approver.type?"Group - "+R.approver.resource.name:"roles"===R.approver.type?"Role - "+R.approver.resource.name:R.approver.resource.name:"levels"===R.approver.type?"Level "+R.approver.level:R.approver.resource.name,f.push(D));else{h.push(R.order+"");var F=void 0!==R.approver.resource?"groups"===R.approver.type?"Group - "+R.approver.resource.name:"roles"===R.approver.type?"Role - "+R.approver.resource.name:R.approver.resource.name:"levels"===R.approver.type?"Level "+R.approver.level:R.approver.resource.name;y[R.order]=F}else if(I&&I>0){for(var C=!1,L=0;L<I;L++)if("pending"===b[L].status){0===m.length&&(m.push(R.id),-1===v&&(v=R.order)),D.name=void 0!==R.approver.resource?"groups"===R.approver.type?"Group - "+R.approver.resource.name:"roles"===R.approver.type?"Role - "+R.approver.resource.name:R.approver.resource.name:"levels"===R.approver.type?"Level "+R.approver.level:R.approver.resource.name,f.push(D),C=!0;break}if((!C||-1===v||v===R.order)&&3===_){h.push(R.order+"");F=void 0!==R.approver.resource?"groups"===R.approver.type?"Group - "+R.approver.resource.name:"roles"===R.approver.type?"Role - "+R.approver.resource.name:R.approver.resource.name:"levels"===R.approver.type?"Level "+R.approver.level:R.approver.resource.name;y[R.order]=F}}}u=h.length;h.reverse();for(g=0;g<u;g++){var S=parseInt(h[g]),P=y[S];v>=S&&(1===S?P=P+" ("+I18n.getMsg("crm.approval.processes.reject.start")+")":v===S?P=P+" ("+I18n.getMsg("crm.transition.current.stage")+")":v===S+1&&S>0&&(P=P+" ("+I18n.getMsg("crm.approval.processes.reject.previous")+")"),y[S]=P)}Lyte.registeredMixins.approvalprocess.openApprovalProcessResponseOnEdit(e,l,l?"MXNdv"===r?t:t.module_name:"editFromTasks"===r?p.module:p.moduleName,l?o:p,c,a,f,m,v,n[0].allow_cc_during_approval,n[0].allow_cc_during_rejection,i,s,r,h,y,_)})).catch((function(){renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("error.database.problem"))}))},openApprovalProcessResponseOnEdit:function(e,a,r,o,t,i,s,l,d,p,n,c,u,f,m,v,_){var y,h=e.contains("takeover")?"takeover":"respond",g=!1;var R=h,D=p;if("takeover"===h){y=[];var b=0,I=s.length;for(b=0;b<I;b++){var F=s[b].id;y.push(F)}g=!(!e||1!==e.length)||g,R=g?R:"respond",D=!g&&D}D="respond"===R?p:D;var C=I18n.getMsg("crm.approvalProcess.label.yourCommentsHere"),L=[];(p||n)&&(Lyte.arrayUtils(L,"push",Crm.userDetails.USER_ID),Lyte.arrayUtils(L,"push",a?record.Owner.id:"editFromTasks"===f?o.entityMapJson.SMOWNERID.dataObj["data-id"]:o.entityrecordData.Owner.id));var S=$L("crm-approval-process-rejectors");S.length>0&&S[0].remove();var P=[c,u],A=networkUtils.returnDependencyFiles(["crm-approval-process-rejectors.js","crm-automation-userswrapper.js"],ResourceConstants.CRMClient);A=(A=A.concat(networkUtils.returnDependencyFiles(["crm-approval-process-rejectors.css","crm-automation-userswrapper.css"],ResourceConstants.CRMClient))).concat(networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("approvalprocess")],ResourceConstants.CRM)),Lyte.injectResources(A,void 0,(function(){Lyte.Component.render("crm-approval-process-rejectors",{show:!0,approverList:m,userNameLists:v,isRejecorsAvailable:0!==m.length,comment:C,currUser:Crm.userDetails.USER_ID,mod:r,parllel:t,myJob:!1,iscommentSecneeded:!0,orginElem:h,response:R,waitingArr:l,adminUsers:"",onlytakeOver:g,parallelCheck:t,checkbox_enabled:D,excludeUsers:L,data:i,approvers:s,approverIds:y,currentStage:d,cc_approve:p,cc_reject:n,disableCurrentAndUpcoming:y&&1===y.length,subformPromise:P,fromSource:f,rejectionStage:_},"body");var e=document.getElementById("approvalprocessModal");e.ltProp("offset",{top:"0px",left:"center"}),"edit"===Lyte.Router.getRouteInstance().routeName&&commonUtils.showHideLoadingDiv(!1),"respond"!==h&&"takeover"!==h||e.ltProp("width","600px")}))},copyAddressCheck:function(e,a,r){var o=e&&("approval_process_pending"===e.$approval_state||"approval_process_rejected"===e.$approval_state)&&e.$editable;if(a&&a.record_modification){var t=a.record_modification;if(t&&"specific_fields"===t.approval_record_modification[0].update_allowed_for)for(var i=t.approval_record_modification[0].specific_fields,s=t.approval_record_modification[0].specific_fields.length,l=0;l<s;l++)if(i[l].api_name===r)return!0}return!o},subformFieldsValidationInApprovalProcess:function(e,a,r,o,t){var i=e;if("canvas"===Lyte.Router.getRouteInstance().routeName&&"form_edit"===Lyte.Router.getRouteInstance().currentModel.form_type&&(i=e&&e.$approval_state?e:$L("crm-canvas-form")[0].component.data.oldRecord),i&&("approval_process_pending"===i.$approval_state||"approval_process_rejected"===i.$approval_state)&&i.$editable&&a&&a.record_modification){var s=a.record_modification;if(s&&"specific_fields"===s.approval_record_modification[0].update_allowed_for){t.setData({disableAddBtn:!0,disableGsAddBtn:!0,disableSfBtnForAp:!1});for(var l=s.approval_record_modification[0].specific_fields,d=s.approval_record_modification[0].specific_fields.length,p=0;p<d;p++){var n=!0;if(l[p].api_name===r)for(var c=l[p].subform_records[0].process_fields,u=c.length,f=0;f<u;f++)if(c[f].id===o.id&&!o.read_only){n=!1;break}if(!n)break}!o.read_only&&n&&(o.read_only=!0)}else s&&"all_fields"===s.approval_record_modification[0].update_allowed_for&&"approval_process_pending"===e.$approval_state&&"556"===o.ui_type&&(o.read_only=!0)}},skipMandatoryFieldCheck:function(e,a,r,o){if(a&&("approval_process_pending"===a.$approval_state||"approval_process_rejected"===a.$approval_state)&&a.$editable&&e&&e.record_modification){var t=e.record_modification;if(t&&"specific_fields"===t.approval_record_modification[0].update_allowed_for)for(var i=t.approval_record_modification[0].specific_fields,s=t.approval_record_modification[0].specific_fields.length,l=0;l<s;l++)if(o&&i[l].subform_records){for(var d=i[l].subform_records[0].process_fields,p=d.length,n=0;n<p;n++)if(d[n].id===r)return!1}else if(i[l].id===r)return!1}return!0},disableBtnActions:function(e){let a=[];a.push(...Array.from($L("[data-apiname='save']"))),a.push(...Array.from($L("[data-apiname='cancel']")));let r=a.length;if(e)for(let e=0;e<r;e++)a[e].classList.add("op5","peNone");else for(let e=0;e<r;e++)a[e].classList.remove("op5","peNone")},restrictFieldsConfiguredInAP:function(e,a,r){if(8!==e.ui_type&&a&&a.$approval_state&&("approval_process_pending"===a.$approval_state||"approval_process_rejected"===a.$approval_state)&&a.$editable){var o=r.record_modification;if(o&&"specific_fields"===o.approval_record_modification[0].update_allowed_for){for(var t=o.approval_record_modification[0].specific_fields,i=o.approval_record_modification[0].specific_fields.length,s=!0,l=0;l<i;l++)if(t[l].id===e.id){s=!1;break}e.read_only||(e.read_only=s)}else!o||"all_fields"!==o.approval_record_modification[0].update_allowed_for||"approval_process_pending"!==a.$approval_state||"556"!==e.ui_type&&556!==e.ui_type||(e.read_only=!0)}},restrictedFields:function(e,a,r){if(8!==e.ui_type&&a&&a.$approval_state&&("approval_process_pending"===a.$approval_state||"approval_process_rejected"===a.$approval_state)&&a.$editable){var o=r.record_modification;if(o&&"all_fields"===o.approval_record_modification[0].update_allowed_for&&"556"===e.ui_type)return!0}},constructPayloadFromDetailViewTemplate:function(e,a){var r={},o={},t=[],i={},s="",l=$("#mouseArea__"+e.columnName).data("params");if("STATUS"===e.columnName&&"Tasks"===a)o.Status=e.fieldValue;else if("DUEDATE"===e.columnName)o.Due_Date=apiDateFormat(e.fieldValue);else if(void 0===l&&"AMOUNT"===e.columnName)o.Amount=e.fieldValue;else if(void 0===l){var d=$("#AjaxEditComponent");if(void 0!==d[0]){d=(d=d[0]).children[0].component;var p=JSON.parse(d.getData("cxPropValue"));o[d.data.cxPropField.api_name]=p.id}else"STAGE"===e.columnName?o[customViewObject.stageSysRefName]=Crm.getDealsStageValue(e.fieldValue):o[customViewObject.stageSysRefName]=e.fieldValue}else{R=-1!==(R=l.sysRefName).indexOf(".")?R.replace(".","__"):R;var n=l.uitype;if(o[R]=e.fieldValue,24===parseInt(n)||202===parseInt(n))""===e.fieldValue?o[R]=e.fieldValue:o[R]=apiDateFormat(e.fieldValue);else if(786===parseInt(n)||333===parseInt(n)||14===parseInt(n))""===e.fieldValue?o[R]=e.fieldValue:o[R]=apiDateTimeFormat(e.fieldValue);else if(21!==parseInt(n)&&"Stage"===R)o[R]=Crm.getDealsStageValue(e.fieldValue);else if(100===parseInt(n)||96===parseInt(n)){for(var c=[],u=(b=e.fieldValue.split(";")).length,f=0;f<u;f++)c.push(b[f]);o[R]=c}else 300!==parseInt(n)&&301!==parseInt(n)||(o[R]="true"===e.fieldValue||!0===e.fieldValue)}""===s&&(s=s+e.fieldLabel+"##"+e.fieldValue+"##"+e.fieldColumn);var m=Object.keys(e).length,v=new RegExp("CustomModule\\d+_Name");for(f=1;f<m;f++){var _="columnName"+f.toString(),y="fieldValue"+f.toString();if(!e.hasOwnProperty(_)||!e.hasOwnProperty(y))break;y.split(":")&&y.split(":").length>1&&(e[y]=e[y].split[1]),i[e[_]]=e[y]}for(var h in i){var g=$("#mouseArea__"+h).data("params"),R="";n="";if(void 0===g){var D=$("#Crm_"+a+"_"+h);R=-1!==(R=D.data("sysrefname")).indexOf(".")?R.replace(".","__"):R,n=D.data("uitype")}else R=-1!==(R=g.sysRefName).indexOf(".")?R.replace(".","__"):R,n=g.uitype;if("Stage"===R)o[R]=Crm.getDealsStageValue(i[h]);else if(24===parseInt(n)||202===parseInt(n))""===e.fieldValue?o[R]=e.fieldValue:o[R]=apiDateFormat(i[h]);else if(786===parseInt(n)||333===parseInt(n)||14===parseInt(n))""===e.fieldValue?o[R]=e.fieldValue:o[R]=apiDateTimeFormat(i[h]);else if(100===parseInt(n)||96===parseInt(n)){var b;for(c=[],u=(b=i[h].split(";")).length,f=0;f<u;f++)c.push(b[f]);""===i[h]&&(c=""),o[R]=c}else 1===parseInt(n)&&v.test(R)?o.Name=i[h]:300===parseInt(n)||301===parseInt(n)?o[R]="true"===i[h]||"false"!==i[h]&&i[h]:o[R]=i[h];""===s?s=s+R+"##"+i[h]+"##"+h:s.includes(h)||(s=s+"||"+R+"##"+i[h]+"##"+h)}return void 0!==e.isNotifyOwnerChecked&&(o.Send_Notification_Email="true"===e.isNotifyOwnerChecked||!0===e.isNotifyOwnerChecked,s=s+"||Send_Notification_Email##"+o.Send_Notification_Email+"##SENDNOTIFICATION"),void 0!==e.isDontAskAgainChecked&&localStorage.setItem("isDontAskAgainChecked_"+Crm.userDetails.ZUID,!0),t.push(o),r.data=t,r},disableGuidedSellingInAp:function(e,a){if(("approval_process_pending"===e.$approval_state||"approval_process_rejected"===e.$approval_state)&&e.$editable&&a&&a.record_modification){var r=a.record_modification;if(r&&"specific_fields"===r.approval_record_modification[0].update_allowed_for)return!0}return!1},restrictFieldsConfiguredInAPFromDetailView:function(e,a,r,o){if(8!==e.ui_type&&a&&a.$approval_state&&("approval_process_pending"===a.$approval_state||"approval_process_rejected"===a.$approval_state)&&a.$editable){var t="true"!==e.read_only&&!0!==e.read_only,i=r.EditFieldsType;return!(t&&i&&2===i&&r.ApprovalProcessEditFields.contains(o))&&(!(!t||!i||1!==i||"approval_process_pending"!==a.$approval_state||"556"!==e.ui_type&&556!==e.ui_type)||1!==i)}return!1},restrictMandatoryFieldCheckForClosingDate:function(e,a){if(a&&a.$approval_state&&("approval_process_pending"===a.$approval_state||"approval_process_rejected"===a.$approval_state)&&a.$editable){var r=e&&e.component?e.component.data.cxPropField:void 0,o="canvas"===Lyte.Router.getRouteInstance().routeName?Lyte.Router.getRouteInstance().currentModel.entityDetails:void 0;r&&r.read_only&&o&&2===o.EditFieldsType&&!o.ApprovalProcessEditFields.contains(r.id)&&(r.required=!1)}},updateUsers:function(e,a){var r=$L("#addUsers"+a);if(r.length>0)if(void 0!==e[0])$L("#adminEdit"+a).removeClass("hide"),r[0].innerHTML=e[0],$L("#apAddUsers"+a).addClass("hide"),r.removeClass("hide");else{$L("#adminEdit"+a).addClass("hide"),$L("#apAddUsers"+a).removeClass("hide"),r.addClass("hide"),$L("#approvalprocessAdminradio"+a).addClass("op5 eventNone");var o=$L("#fields"+a),t=$("#allFields"+a),i=$("#processField"+a),s=$L("#viaEmail6"+a),l=$L("#viaApp6"+a);t[0].checked=!1,i[0].checked=!1,o[0].checked=!1,s[0].checked=!1,l[0].checked=!1}}});
