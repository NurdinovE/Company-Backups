Lyte.Component.register("rfm-segment-history",{_template:'<template tag-name="rfm-segment-history"> <template is="if" value="{{segmentHistory.length}}"><template case="true"> <div class="rfm-entityListCont pB30"> <template is="for" items="{{segmentHistory}}" item="segment" index="index"> <div class="rfm-entityListItem"> <div class="alignRight dIB mR30 rfm-entityDateCont vaT w150"> <span class="dIB crm-base-font-size mT6 rfm-entityDate">{{getDateTime(segment.label.assigned_time,24,\'-\')}}</span> </div> <div class="br_left_border3 dIB pR rfm-entityTransCont pL30 minW500"> <span id="rfm-entityLabel_{{index}}" class="br3 cDefault pA rfm-entityLabel top0 {{if(index,\'\',\'curnt\')}}" onmouseenter="{{action(&quot;rfm_historylabelhover&quot;,this)}}" onmouseout="{{action(&quot;rfm_historylabelhoverLeave&quot;)}}">{{segment.label.name}}</span> <template is="if" value="{{expHandlers(expHandlers(segmentHistory.length,\'-\',1),\'!=\',index)}}"><template case="true"> <div class="br_border1 br3 mB30 mT60 pR rfm-entityTrans dIB"> <template is="for" items="{{rfmArray}}" item="obj" index="index"> <template is="if" value="{{segment[obj.val]}}"><template case="true"> <div class="rfm-entityTransField dIB"> <div class="dIB vaM mR20 maxW188"> <span class="dB ellipsistext crm-base-font-size mB8 crm-font-bold" onmouseenter="{{action(\'tool_tip\',this,segment[obj.val].field.field_label)}}">{{segment[obj.val].field.field_label}}</span> <div class="crmBaseColor crm-small-font-size"> <span class="dIB vaM">{{if(ifNotEquals(segment[obj.val].prevValue,null),segment[obj.val].prevValue,\'-\')}} </span> <span class="dIB mL7 mR3 op5 rfm-rangeTransit vaM"></span> <span class="dIB vaM"> {{if(ifNotEquals(segment[obj.val].value,null),segment[obj.val].value,\'-\')}} </span> </div> </div> <div class="dIB crm-font-bold vaM"> <span class="dIB vaM">{{obj.char}}</span> <template is="if" value="{{expHandlers(segment[obj.val].isEqual,\'!\')}}"><template case="true"> <span class="dIB vaM {{if(segment[obj.val].isIncreased,\'rfm-labelIncrease\',\'rfm-labelDecrease\')}}"></span> <span class="dIB vaM">{{segment[obj.val].scoreDiff}}</span> </template></template> </div> </div> </template></template> </template> </div> <template is="if" value="{{expHandlers(expHandlers(segment.recency.isEqual,\'&amp;&amp;\',segment.frequency.isEqual),\'&amp;&amp;\',segment.monetary.isEqual)}}"><template case="true"> <span class="rfm_slider_info op3 dIB cP vaM mL5" lt-prop-title="{{getI18n(\'crm.segmentation.scores.nochange\')}}" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;}"></span> </template></template> </template></template> </div> </div>  </template> </div></template><template case="false"> <div class="aligncenter pB30">{{getI18n(\'crm.segmentation.nohistoryfound\')}}</div> </template></template> <lyte-popover id="historyPopup" lt-prop-show="{{popoverShow}}" lt-prop-duration="1" lt-prop-origin-elem=".popoverEleOrgin" lt-prop-height="auto" lt-prop-show-close-button="false" lt-prop-freeze="false" lt-prop-content-padding="15px" lt-prop-scrollable="true"> <template is="registerYield" yield-name="popover"> <lyte-popover-content class="rfm-history-popCont crm-small-font-size"> <template is="for" items="{{rfmArray}}" item="obj" index="index"> <div class="flexAlignStart {{if(expHandlers(index,\'>\',0),\'mT5\',\'\')}}"> <div> <span class="mR5">{{obj.name}} </span> <span class="crm-font-bold">{{popoverRecord[obj.val].score}} </span> </div> <template is="if" value="{{expHandlers(obj.val,\'===\',recency_const)}}"><template case="true"><span class="mL20 alignRight flexOne"> {{expHandlers(popoverRecord[obj.val].value,\'?:\',popoverRecord[obj.val].value,\'-\')}} </span></template><template case="false"><template is="if" value="{{expHandlers(obj.val,\'===\',frequency_const)}}"><template case="true"><span class="mL20 alignRight flexOne"> {{if(ifNotEquals(popoverRecord[obj.val].value,null),popoverRecord[obj.val].value,\'-\')}} </span></template><template case="false"><span class="mL20 alignRight flexOne"> {{popoverRecord[obj.val].value}} </span></template></template></template></template> </div> </template> </lyte-popover-content> </template> </lyte-popover> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"text",position:[1,1,1,0]},{type:"attr",position:[1,3,1]},{type:"text",position:[1,3,1,0]},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"text",position:[1,1,1,0]},{type:"text",position:[1,1,3,1,0]},{type:"text",position:[1,1,3,5,1]},{type:"text",position:[1,3,1,0]},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[3,0]}]}},default:{}}]}},default:{}}]},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}},default:{}}]}]},false:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,1,0]},{type:"text",position:[1,1,3,0]},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"text",position:[0,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[0,1]}]},false:{dynamicNodes:[{type:"text",position:[0,1]}]}},default:{}}]}},default:{}}]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[3]}],_observedAttributes:["segmentHistory","rfmArray","popoverShow","popoverRecord","popoverShow_id","popoverDuration","recency_const","frequency_const","monetary_const"],data:function(){return{segmentHistory:Lyte.attr("array"),rfmArray:Lyte.attr("array"),popoverShow:Lyte.attr("boolean",{default:!1}),popoverRecord:Lyte.attr("object"),popoverShow_id:Lyte.attr("string"),popoverDuration:Lyte.attr("string",{default:"undifined"}),recency_const:Lyte.attr("string",{default:"recency"}),frequency_const:Lyte.attr("string",{default:"frequency"}),monetary_const:Lyte.attr("string",{default:"monetary"})}},didConnect:function(){var e=document.getElementsByClassName("rfm_segmentTbl"),t=e[0].scrollHeight,o=e[0].clientHeight;e[0].style.boxShadow=t>o?"inset 0 -7px 10px -12px rgba(0, 0, 0, 0.6)":null},init:function(){var e=this.getData("segmentHistory");if(e&&e.length){for(var t=e.length,o=0;o<t-1;o++){var s=e[o],a=e[o+1];if(s.recency.prevValue=a.recency.value,s.recency.isEqual=s.recency.score===a.recency.score,s.recency.value){var n=s.recency.value;s.recency.value=Utils.getDateInUserDatePattern(new Date(n),!1)}if(s.recency.prevValue){n=s.recency.prevValue;s.recency.prevValue=Utils.getDateInUserDatePattern(new Date(n),!1)}s.recency.isEqual||(s.recency.isIncreased=s.recency.score>a.recency.score,s.recency.isIncreased?s.recency.scoreDiff=s.recency.score-a.recency.score:s.recency.scoreDiff=a.recency.score-s.recency.score),s.frequency.prevValue=a.frequency.value,s.frequency.isEqual=s.frequency.score===a.frequency.score,s.frequency.isEqual||(s.frequency.isIncreased=s.frequency.score>a.frequency.score,s.frequency.isIncreased?s.frequency.scoreDiff=s.frequency.score-a.frequency.score:s.frequency.scoreDiff=a.frequency.score-s.frequency.score),s.monetary.prevValue=a.monetary.value,s.monetary.isEqual=s.monetary.score===a.monetary.score,null!=s.monetary.value&&(s.monetary.value=currencyUtils.returnValueInDefaultCurrency(null,s.monetary.value)),null!=s.monetary.prevValue&&(s.monetary.prevValue=currencyUtils.returnValueInDefaultCurrency(null,s.monetary.prevValue)),s.monetary.isEqual||(s.monetary.isIncreased=s.monetary.score>a.monetary.score,s.monetary.isIncreased?s.monetary.scoreDiff=s.monetary.score-a.monetary.score:s.monetary.scoreDiff=a.monetary.score-s.monetary.score)}(s=e[t-1]).recency.value&&(s.recency.value=Utils.getDateInUserDatePattern(new Date(s.recency.value),!1)),s.monetary.value=currencyUtils.returnValueInDefaultCurrency(null,s.monetary.value),this.setData("segmentHistory",e);var r=[{val:"recency",name:I18n.getMsg("crm.segmentation.recency"),char:"R"},{val:"frequency",name:I18n.getMsg("crm.segmentation.frequency"),char:"F"},{val:"monetary",name:I18n.getMsg("crm.segmentation.monetary"),char:"M"}];this.setData("rfmArray",r)}},actions:{rfm_historylabelhover:function(e){$L(".popoverEleOrgin").removeClass("popoverEleOrgin"),$L(e).addClass("popoverEleOrgin"),$L("#historyPopup")[0].ltProp("duration",void 0);var t=parseInt(e.id.slice(-1)),o=store.peekAll("rfm_history")[t];this.setData("popoverRecord",o),this.setData("popoverShow",!0)},rfm_historylabelhoverLeave:function(){$L(".popoverEleOrgin").removeClass("popoverEleOrgin"),this.setData("popoverShow",!1)},tool_tip:function(e,t){e.offsetWidth<Math.floor(e.scrollWidth)&&e.offsetWidth!==Math.floor(e.scrollWidth)&&$L(e).attr({"lt-prop-title":t,"lt-prop-tooltip-config":'{"appearance":"callout","position" : "top"}'})}}}),Lyte.Component.register("related-list-segment",{_template:'<template tag-name="related-list-segment"> <div class="rl_Header"><span class="relListHead crm-sub-heading-font-size crmBaseColor">{{getI18n(\'crm.segmentation\')}}</span></div> <div class="sementalInfo_detPage pR zI1"> <div class="dIB mR30 vaM maxW30per pB5 pT5"> <template is="if" value="{{label.name}}"><template case="true"> <div class="ellipsistext crm-medium-large-font-size crm-font-semibold mB7 lh25 segmentation_subtitle" onmouseenter="{{action(\'tool_tip\',this,label.name)}}">{{label.name}}</div> </template><template case="false"> <div class="aligncenter mB7 crm-medium-large-font-size lh25">-</div> </template></template> <div class="crmNotFoundColor crm-font-regular">{{getI18n(\'crm.segmentation.segment.label\')}}</div> </div> <ul class="dIB segmentScore_detPage vaM clearAfterB"> <li> <span class="crm-medium-large-font-size crm-font-semibold mB5 dIB lh25 segmentation_subtitle">{{if(recency.value,getDateTime(recency.value,24,\'-\'),\'-\')}}</span> <div class="crm-base-font-size crm-font-regular"><span class="crmNotFoundColor dIB vaM segmentation_content">{{getI18n(\'crm.segmentation.recency\')}}</span><span class="segmentScore_part boldFont mL8 vaM {{if(recency.score,\'dIB\',\'dN\')}}">{{recency.score}}</span></div> </li> <li> <span class="crm-medium-large-font-size crm-font-semibold mB5 dIB lh25 segmentation_subtitle">{{if(ifNotEquals(frequency.value,null),frequency.value,\'-\')}}</span> <div class="crm-base-font-size crm-font-regular"><span class="crmNotFoundColor dIB vaM segmentation_content">{{getI18n(\'crm.segmentation.frequency\')}}</span><span class="segmentScore_part boldFont mL8 vaM {{if(frequency.score,\'dIB\',\'dN\')}}">{{frequency.score}}</span></div> </li> <li> <span class="crm-medium-large-font-size crm-font-semibold mB5 dIB lh25 segmentation_subtitle">{{formatCurrencyValue(monetary.value,baseCurrency)}}</span> <div class="crm-base-font-size crm-font-regular"><span class="crmNotFoundColor dIB vaM segmentation_content">{{getI18n(\'crm.segmentation.monetary\')}}</span><span class="segmentScore_part boldFont mL8 vaM {{if(monetary.score,\'dIB\',\'dN\')}}">{{monetary.score}}</span></div> </li> </ul> <span class="fR mT20 cP {{if(showHistory,\'dN\',\'\')}}" data-zcqa="segment_viewhistory" onclick="{{action(\'viewHistory\')}}"><span class="crmLinkColor dIB crm-base-font-size mR5 vaM">{{getI18n(\'crm.segmentation.viewhistory\')}}</span> <span class="dIB vaM svgIcons rfm_HistoryLink"></span></span> <span class="fR mT20 cP {{if(showHistory,\'\',\'dN\')}}" data-zcqa="segment_hidehistory" onclick="{{action(\'hideHistory\')}}"><span class="crmLinkColor dIB crm-base-font-size mR5 vaM">{{getI18n(\'crm.segmentation.hidehistory\')}}</span> <span class="dIB vaM svgIcons rfm_HistoryLink" style="transform: rotate(180deg);"></span></span> </div> <div class="bg_white borderTop"> <div class="rfm_segmentTbl pT30 {{if(showHistory,\'\',\'dN\')}} br_bottom_border3" onscroll="{{action(\'shawdowEnable\',this)}}"> <div id="segmentHistory"></div> </div> </div> </template>',_dynamicNodes:[{type:"text",position:[1,0,0]},{type:"attr",position:[3,1,1]},{type:"if",position:[3,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]},false:{dynamicNodes:[]}},default:{}},{type:"text",position:[3,1,3,0]},{type:"text",position:[3,3,1,1,0]},{type:"text",position:[3,3,1,3,0,0]},{type:"attr",position:[3,3,1,3,1]},{type:"text",position:[3,3,1,3,1,0]},{type:"text",position:[3,3,3,1,0]},{type:"text",position:[3,3,3,3,0,0]},{type:"attr",position:[3,3,3,3,1]},{type:"text",position:[3,3,3,3,1,0]},{type:"text",position:[3,3,5,1,0]},{type:"text",position:[3,3,5,3,0,0]},{type:"attr",position:[3,3,5,3,1]},{type:"text",position:[3,3,5,3,1,0]},{type:"attr",position:[3,5]},{type:"text",position:[3,5,0,0]},{type:"attr",position:[3,7]},{type:"text",position:[3,7,0,0]},{type:"attr",position:[5,1]}],_observedAttributes:["showHistory","eventNne","baseCurrency"],data:function(){return{showHistory:Lyte.attr("boolean",{default:!1}),eventNne:Lyte.attr("boolean",{default:!1}),baseCurrency:Lyte.attr("string",{default:Crm.userDetails.BASE_CURRENCY})}},actions:{viewHistory:function(){var e=this;store.unloadAll("rfm_history",void 0,!1),this.setData("eventNne","true"),store.findAll("rfm_history",null,null,null,{module:this.getData("module"),entityId:this.getData("record").id}).then((function(){var t=store.peekAll("rfm_history"),o={segmentHistory:[]};t.length>0&&(o.segmentHistory=t),Lyte.Component.render("rfm-segment-history",o,"#segmentHistory"),e.setData("showHistory",!0),e.setData("eventNne",!1)}),(function(t){var o=JSON.parse(t.response).__segmentations_history.message;e.showAlertBox("error",I18n.getMsg(o))})),$L(".rfm_segmentTbl").scroll({preventOnEnd:!1})},hideHistory:function(){document.getElementById("segmentHistory").innerHTML="",this.setData("showHistory",!1)},shawdowEnable:function(e){var t=e.scrollHeight,o=e.clientHeight,s=e.scrollTop;s>0?$L(".sementalInfo_detPage").css("box-shadow","0 8px 7px -5px rgba(0, 0, 0, 0.1)"):$L(".sementalInfo_detPage").css("box-shadow","none"),t<=Math.round(o+s)?$L(".rfm_segmentTbl").css("box-shadow","none"):$L(".rfm_segmentTbl").css("box-shadow","inset 0 -7px 10px -12px rgba(0, 0, 0, 0.6)")},tool_tip:function(e,t){e.offsetWidth<Math.floor(e.scrollWidth)&&e.offsetWidth!==Math.floor(e.scrollWidth)&&$L(e).attr({"lt-prop-title":t,"lt-prop-tooltip-config":'{"appearance":"callout","position" : "top"}'})}}},{mixins:["segmentation-utils"]}),store.registerModel("rfm_history",{label:Lyte.attr("object",{primaryKey:!0}),recency:Lyte.attr("object"),frequency:Lyte.attr("object"),monetary:Lyte.attr("object")}),store.registerAdapter("rfm_history",{namespace:"crm/v2/",buildURL:function(e,t,o,s,a,n,r){return"findAll"===t&&(a=a.replace("rfm_history",r.module).concat("/"+r.entityId).concat("/__segmentations_history")),a}}),store.registerSerializer("rfm_history",{normalizeResponse:function(e,t,o){return o.rfm_history=o.__segmentations_history,o},payloadKey:function(e){return e}}),store.registerModel("rfm_entity",{record:Lyte.attr("object",{primaryKey:!0}),recency:Lyte.attr("object"),frequency:Lyte.attr("object"),monetary:Lyte.attr("object"),label:Lyte.attr("object")}),store.registerAdapter("rfm_entity",{namespace:"crm/v2/",buildURL:function(e,t,o,s,a,n,r){return"findRecord"===t&&(a=a.replace("rfm_entity",r).concat("/__segmentations_details")),a}}),store.registerSerializer("rfm_entity",{normalizeResponse:function(e,t,o){if("findRecord"===t){var s={};return s.rfm_entity=o.__segmentations_details,s}return o},payloadKey:function(e){return e}});
