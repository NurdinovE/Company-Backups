Lyte.Component.register("crux-territory",{_template:'<template tag-name="crux-territory"> <template is="if" value="{{cxPropShowModal}}"><template case="true"> <lyte-modal lt-prop-offset="{&quot;top&quot;:&quot;0&quot;}" lt-prop-width="60%" lt-prop-height="auto" lt-prop-wrapper-class="cxBoxModal cxTerritoryModalWrapper" on-show="{{method(\'onModalShow\')}}" lt-prop-show-close-button="{{cxPropShowCloseIconModal}}" lt-prop-prevent-focus="true" lt-prop-allow-multiple="{{cxPropAllowMultipleModal}}" on-close="{{method(\'onModalClose\')}}"> <template is="registerYield" yield-name="modal"> <lyte-modal-header> <template is="if" value="{{cxPropModalHeaderYield}}"><template case="true"> <lyte-yield yield-name="modalHeaderYield"></lyte-yield> </template><template case="false"> {{modalTitle}} </template></template> </lyte-modal-header> <lyte-modal-content class="cxTerritoryModalContent"> <div> <template is="if" value="{{expHandlers(cxPropSearch,\'==\',\'treeSearch\')}}"><template case="true"> <lyte-search lt-prop-query-selector="{&quot;scope&quot;:&quot;lyte-tree#cxTerritoryTree&quot;,&quot;search&quot;:&quot;p.treeValue&quot;,&quot;target&quot;:&quot;.lyteTreeBodyDiv&quot;}" lt-prop-component="tree" on-search="{{method(\'error\')}}" lt-prop-placeholder="{{cxPropSearchPlaceholder}}" data-zcqa="territoryTreeSearch"> </lyte-search> </template><template case="false"><template is="if" value="{{expHandlers(cxPropSearch,\'==\',\'dropdownSearch\')}}"><template case="true"> <crux-territory-search cx-prop-territory="{{cxPropTerritory}}" cx-prop-model-name="{{cxPropModelName}}" cx-prop-query-params="{{cxPropQueryParams}}" cx-prop-custom-data="{{cxPropCustomData}}" on-territory-selected="{{method(\'scrollTerritory\')}}" cx-prop-placeholder="{{cxPropSearchPlaceholder}}" cx-prop-id="{{cxPropId}}"></crux-territory-search> </template></template></template></template> <template is="if" value="{{cxPropSearchSuffixYield}}"><template case="true"> <lyte-yield yield-name="searchSuffixYield"></lyte-yield> </template></template> </div> <div class="cxTerritoryModalTreeWrap"> <lyte-tree lt-prop-max-level="{{cxPropTreeMaxLevel}}" id="cxTerritoryTree" class="cxTerritoryTree" lt-prop-data="{{cxPropTerritory}}" lt-prop-open-class="lyteTreeOpen" lt-prop-close-class="lyteTreeClose" on-toggle="{{method(\'treeToggle\')}}" on-open="{{method(\'treeOpen\')}}" on-close="{{method(\'treeClose\')}}" lt-prop-children-value="{{if(cxPropLazyLoadingEnabled,\'_children\',\'children\')}}" on-before-open="{{method(\'treeBeforeOpen\')}}"> <template is="registerYield" yield-name="content"> <lyte-tree-content id="territoryTree{{listValue.id}}"> <lyte-tree-icon data-zcqa="territoryTreeIcon_{{listValue.name}}" lyte-custom-icon="true"> <div class="collapseBox"> <div class="arrow"></div> </div> </lyte-tree-icon> <template is="if" value="{{expHandlers(expHandlers(cxPropTerritory[0].id,\'!=\',listValue.id),\'||\',cxPropSelectableOrg)}}"><template case="true"><template is="if" value="{{expHandlers(cxPropType,\'==\',\'multiple\')}}"><template case="true"> <lyte-checkbox class="cxTerritoryCheckbox" lt-prop-checked="{{cruxContains(selectedIds,listValue.id,selectedIds.length)}}" on-before-checked="{{method(\'checkBoxBeforeChange\',\'check\',listValue.id)}}" on-before-unchecked="{{method(\'checkBoxBeforeChange\',\'uncheck\',listValue.id)}}" lt-prop-disabled="{{cruxContains(cxPropDisabledIds,listValue.id,cxPropDisabledIds.length)}}" lt-prop-label-class="cxTerritoryCkboxEmptyLabel" data-zcqa="territoryCheckbox_{{listValue.name}}" lt-prop-prevent-callback-observers="true"></lyte-checkbox> </template><template case="false"><template is="if" value="{{cxPropShowRadioButton}}"><template case="true"> <lyte-radiobutton class="cxTerritoryCheckbox" lt-prop-checked="{{cruxContains(selectedIds,listValue.id,selectedIds.length)}}" on-checked="{{method(\'radioCheckedTerritory\',listValue.id)}}" on-before-checked="{{method(\'radioBoxBeforeChange\',\'check\',listValue.id)}}" on-before-unchecked="{{method(\'radioBoxBeforeChange\',\'uncheck\',listValue.id)}}" lt-prop-disabled="{{cruxContains(cxPropDisabledIds,listValue.id,cxPropDisabledIds.length)}}" lt-prop-label-class="cxTerritoryCkboxEmptyLabel" lt-prop-name="cxTerritoryRadioButton" lt-prop-value="{{listValue.id}}" data-zcqa="territoryRadio_{{listValue.name}}"></lyte-radiobutton> </template></template></template></template></template></template> <div class="cxTerritoryTreeValueWrapper cxFlex"> <p class="cxTerritoryLabel treeValue {{if(cruxAnd(cruxContains(selectedIds,listValue.id,selectedIds.length),ifEquals(cxPropType,\'single\'),negate(cxPropShowRadioButton)),\'pEvents\',\'\')}} {{if(cruxAnd(ifEquals(cxPropTerritory[0].id,listValue.id),negate(cxPropSelectableOrg)),\'cxTerritoryNoSelect\')}}" onclick="{{action(\'selectTerritory\',listValue.id,event)}}" data-zcqa="cxTerritoryName_{{listValue.name}}"> {{listValue.name}} </p> <template is="if" value="{{cxPropItemYield}}"><template case="true"> <lyte-yield class="cxTerritoryItemYield" yield-name="itemYield" item-value="{{listValue}}"></lyte-yield> </template></template> </div> </lyte-tree-content> <template is="if" value="{{cxPropItemSuffixYield}}"><template case="true"> <lyte-yield class="cxTerritoryItemSuffixWrap" yield-name="itemSuffixYield" item-value="{{listValue}}"></lyte-yield> </template></template> </template> </lyte-tree> </div> </lyte-modal-content> <lyte-modal-footer class="right"> <template is="if" value="{{cxPropModalFooterYield}}"><template case="true"> <lyte-yield yield-name="modalFooterYield"></lyte-yield> </template><template case="false"> <template is="if" value="{{expHandlers(expHandlers(cxPropType,\'!=\',\'single\'),\'||\',cxPropShowRadioButton)}}"><template case="true"> <lyte-button onclick="{{action(\'closeModal\')}}" data-zcqa="cx_territory_cancel"> <template is="registerYield" yield-name="text"> {{cruxGetI18n(\'crm.button.cancel\')}} </template> </lyte-button> <lyte-button lt-prop-appearance="primary" onclick="{{action(\'saveModal\')}}" data-zcqa="cx_territory_save"> <template is="registerYield" yield-name="text"> <template is="if" value="{{cxPropShowRadioButton}}"><template case="true"> {{cruxGetI18n(\'crm.label.assign.manually\')}} </template><template case="false"> <template is="if" value="{{expHandlers(cxPropValue,\'&amp;&amp;\',cxPropValue.length)}}"><template case="true"> {{cruxGetI18n(\'crm.button.save\')}} </template><template case="false"> {{cruxGetI18n(\'crm.button.add\')}} </template></template> </template></template> </template> </lyte-button> </template></template> </template></template> </lyte-modal-footer> </template> </lyte-modal> </template><template case="false"> <div class="cxTerritoryTreeWrap"> <lyte-tree lt-prop-max-level="{{cxPropTreeMaxLevel}}" class="cxTerritoryTree" lt-prop-data="{{cxPropTerritory}}" lt-prop-open-class="lyteTreeOpen" lt-prop-close-class="lyteTreeClose" on-toggle="{{method(\'treeToggle\')}}" on-open="{{method(\'treeOpen\')}}" on-close="{{method(\'treeClose\')}}" on-before-open="{{method(\'treeBeforeOpen\')}}" lt-prop-children-value="{{if(cxPropLazyLoadingEnabled,\'_children\',\'children\')}}"> <template is="registerYield" yield-name="content"> <lyte-tree-content class="cxTerritoryTreeContentClass" id="territoryTree{{listValue.id}}"> <lyte-tree-icon lyte-custom-icon="true"> <div class="collapseBox"> <div class="arrow"></div> </div> </lyte-tree-icon> <div class="cxTerritoryTreeValueWrapper cxFlex"> <p class="cxTerritoryLabel treeValue {{if(cruxContains(cxPropDisabledIds,listValue.id,cxPropDisabledIds.length),\'pEvents\',\'\')}}" onclick="{{action(\'selectTerritory\',listValue.id)}}" data-zcqa="cxTerritoryName_{{listValue.name}}">{{listValue.name}} </p> <template is="if" value="{{cxPropItemYield}}"><template case="true"> <lyte-yield class="cxTerritoryItemYield" yield-name="itemYield" item-value="{{listValue}}"></lyte-yield> </template></template> </div> </lyte-tree-content> <template is="if" value="{{cxPropItemSuffixYield}}"><template case="true"> <lyte-yield class="cxTerritoryItemSuffixWrap" yield-name="itemSuffixYield" item-value="{{listValue}}"></lyte-yield> </template></template> </template> </lyte-tree> </div> </template></template> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"insertYield",position:[1]}]},false:{dynamicNodes:[{type:"text",position:[1]}]}},default:{}},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1,1]},{type:"if",position:[3,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}},{type:"attr",position:[3,1,3]},{type:"if",position:[3,1,3],cases:{true:{dynamicNodes:[{type:"insertYield",position:[1]}]}},default:{}},{type:"attr",position:[3,3,1]},{type:"registerYield",position:[3,3,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}}]}},default:{}},{type:"attr",position:[1,5,1]},{type:"text",position:[1,5,1,1]},{type:"attr",position:[1,5,3]},{type:"if",position:[1,5,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"insertYield",position:[1]}]}},default:{}},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"insertYield",position:[1]}]}},default:{}}]},{type:"componentDynamic",position:[3,3,1]},{type:"componentDynamic",position:[3]},{type:"attr",position:[5,1]},{type:"if",position:[5,1],cases:{true:{dynamicNodes:[{type:"insertYield",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1]}]},false:{dynamicNodes:[{type:"text",position:[1]}]}},default:{}}]}},default:{}}]},{type:"componentDynamic",position:[3]}]}},default:{}}]}},default:{}},{type:"componentDynamic",position:[5]}]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"registerYield",position:[1,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3,1]},{type:"text",position:[1,3,1,0]},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"insertYield",position:[1]}]}},default:{}},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"insertYield",position:[1]}]}},default:{}}]},{type:"componentDynamic",position:[1,1]}]}},default:{}}],_observedAttributes:["cxPropTerritory","cxPropType","cxPropValue","modalTitle","selectedIds","cxPropShowModal","cxPropItemYield","cxPropModelName","cxPropHeight","cxPropDisabledIds","cxPropQueryParams","cxPropCustomData","cxPropSearch","cxPropModalHeaderYield","cxPropShowRadioButton","cxPropModalFooterYield","cxPropSearchSuffixYield","cxPropShowCloseIconModal","cxPropSearchPlaceholder","cxPropAllowMultipleModal","cxPropItemSuffixYield","cxPropLazyLoadingEnabled","cxPropSelectableOrg","cxPropId","cxPropTreeMaxLevel"],data:function(){return{cxPropTerritory:Lyte.attr("array"),cxPropType:Lyte.attr("string",{default:"multiple"}),cxPropValue:Lyte.attr("array"),modalTitle:Lyte.attr("string"),selectedIds:Lyte.attr("array",{default:[]}),cxPropShowModal:Lyte.attr("boolean",{default:!0}),cxPropItemYield:Lyte.attr("boolean",{default:!1}),cxPropModelName:Lyte.attr("string",{default:"territory"}),cxPropHeight:Lyte.attr("string"),cxPropDisabledIds:Lyte.attr("array",{default:[]}),cxPropQueryParams:Lyte.attr("object"),cxPropCustomData:Lyte.attr("object"),cxPropSearch:Lyte.attr("string",{default:"none"}),cxPropModalHeaderYield:Lyte.attr("boolean",{default:!1}),cxPropShowRadioButton:Lyte.attr("boolean",{default:!1}),cxPropModalFooterYield:Lyte.attr("boolean",{default:!1}),cxPropSearchSuffixYield:Lyte.attr("boolean",{default:!1}),cxPropShowCloseIconModal:Lyte.attr("boolean",{default:!1}),cxPropSearchPlaceholder:Lyte.attr("string",{default:_cruxUtils.getI18n("crm.globalsearch.search.title")}),cxPropAllowMultipleModal:Lyte.attr("boolean",{default:!1}),cxPropItemSuffixYield:Lyte.attr("boolean",{default:!1}),cxPropLazyLoadingEnabled:Lyte.attr("boolean",{default:!0}),cxPropSelectableOrg:Lyte.attr("boolean",{default:!1}),cxPropId:Lyte.attr("string",{default:"cxTerritory1"}),cxPropTreeMaxLevel:Lyte.attr("number",{default:35})}},init:function(){this.$node.show=function(){this.component.show()},this.$node.collapseTerritories=function(){this.component.expandCollapseFn("collapseAll")},this.$node.expandTerritories=function(){this.component.expandCollapseFn("expandAll")},this.$node.scrollToTerritory=function(e){this.component.scrollIntoTerritory(e)},this.$node.toggleTerritory=function(e,t){this.component.internalOperation=!0,"check"!=t?this.component.performUnCheckedOperation(e):this.component.performCheckedOperation(e),this.component.internalOperation=!1},this.$node.checkTerritory=function(e){this.component.internalOperation=!0,this.component.performCheckedOperation(e),this.component.internalOperation=!1},this.$node.uncheckTerritory=function(e){this.component.internalOperation=!0,this.component.performUnCheckedOperation(e),this.component.internalOperation=!1},this.$node.removeTerritoryNode=function(e,t){var o=store.peekRecord("territory",e)._children,r=o.cruxFindIndexOfObject("id",t.id);Lyte.arrayUtils(o,"removeAt",r);var i=this;if(this.component.data.cxPropShowModal&&(this.component.modalBody||(this.component.modalBody=this.$node.querySelector("lyte-modal").component.childComp),i=this.component.modalBody),0==o.length){var a=$L("lyte-tree",i)[0],l=$L("#territoryTree"+e,i)[0];l=l.closest("lyte-tree-body"),a.removeIcon(l)}},this.$node.addTerritoryNode=function(e,t){var o=store.peekRecord("territory",e),r=!1;if(o._children||(Lyte.objectUtils(o,"add","_children",[]),r=!0),o=o._children,Lyte.arrayUtils(o,"push",t),r){var i=this;this.component.data.cxPropShowModal&&(this.component.modalBody||(this.component.modalBody=this.$node.querySelector("lyte-modal").component.childComp),i=this.component.modalBody);var a=$L("lyte-tree",i)[0],l=$L("#territoryTree"+e,i)[0];l=l.closest("lyte-tree-body"),a.showIcon(l),a.openIcon(l.querySelector("lyte-tree-icon"))}},this.$node.getSelected=function(){var e=[];return this.component.data.selectedIds.forEach(function(t){e.push(store.peekRecord(this.component.data.cxPropModelName,t))}.bind(this)),this.setData("cxPropValue",e),e},this.$node.getSelectedIds=function(){return this.component.data.selectedIds},this.$node.close=function(){this.component.closeModalPopup()},this.$node.getTreeLevel=function(){var e=this;return this.component.data.cxPropShowModal&&(this.component.modalBody||(this.component.modalBody=this.querySelector("lyte-modal").component.childComp),e=this.component.modalBody),$L("lyte-tree",e)[0].getLevel()},this.rendered=0,this.data.cxPropTerritory&&0!=this.data.cxPropTerritory.length?this.data.cxPropLazyLoadingEnabled&&(this.setCollapsed(this.data.cxPropTerritory[0],!0),this.renderTreeNodes(this.data.cxPropTerritory[0])):store.peekAll(this.data.cxPropModelName)&&0!=store.peekAll(this.data.cxPropModelName).length?(this.setData("cxPropTerritory",[].concat(store.peekAll(this.data.cxPropModelName)[0])),this.data.cxPropLazyLoadingEnabled&&(this.setCollapsed(this.data.cxPropTerritory[0],!0),this.renderTreeNodes(this.data.cxPropTerritory[0]))):store.findAll(this.data.cxPropModelName,this.data.cxPropQueryParams,void 0,void 0,this.data.cxPropCustomData).then(function(e){var t=[];e.$&&e.$.meta&&e.$.meta.more_records&&t.push(store.findAll(this.data.cxPropModelName,Object.assign({page:2},this.data.cxPropQueryParams),void 0,void 0,this.data.cxPropCustomData)),Lyte.resolvePromises(t).then(function(){this.setData("cxPropTerritory",[].concat(store.peekAll(this.data.cxPropModelName)[0])),this.data.cxPropLazyLoadingEnabled&&this.setCollapsed(this.data.cxPropTerritory[0],!0)}.bind(this))}.bind(this))},didConnect:function(){this.data.cxPropLazyLoadingEnabled&&!this.data.cxPropShowModal&&this.openTerritoryTree("#territoryTree"+this.data.cxPropTerritory[0].id,this.$node)},setCollapsed:function(e,t){var o=e.children?e.children.length:0;if(o){Lyte.objectUtils(e,"add","collapsed",!0);for(var r=0;r<o;r++)this.setCollapsed(e.children[r],!1),this.renderTreeNodes(e.children[r])}},renderTreeNodes:function(e){e.children&&e.children.length;Lyte.objectUtils(e,"add","_children",e.children)},show:function(){"single"==this.data.cxPropType?this.setData("modalTitle",_cruxUtils.getI18n("crm.territory.title.assign.territories")):this.data.cxPropValue&&0!=this.data.cxPropValue.length?this.setData("modalTitle",_cruxUtils.getI18n("crm.title.edit.territory")):this.setData("modalTitle",_cruxUtils.getI18n("crm.territory.addterritory")),this.resetValues(),this.$node.querySelector("lyte-modal").ltProp("show",!0)},scrollIntoTerritory:function(e){var t=this.$node;this.data.cxPropShowModal&&(this.modalBody||(this.modalBody=this.$node.querySelector("lyte-modal").component.childComp),t=this.modalBody);var o=[];this.data.cxPropLazyLoadingEnabled&&o.push(new Promise(function(o,r){for(var i=[],a=store.peekRecord(this.data.cxPropModelName,e);a.id!=this.data.cxPropTerritory[0].id;)i.push(a.reporting_to.id),a=a.reporting_to;if(i.length){var l=i.length-1;this.openAllParents=setInterval(function(){this.openTerritoryTree("#territoryTree"+i[l],t),--l<0&&(clearInterval(this.openAllParents),o())}.bind(this),10)}else o()}.bind(this))),Lyte.resolvePromises(o).then(function(){setTimeout(function(){var o=$L("#territoryTree"+e,t)[0];this.data.cxPropTerritory[0].id!=e&&("multiple"==this.data.cxPropType?o.querySelector("lyte-checkbox").focus():this.data.cxPropShowRadioButton&&o.querySelector("lyte-radiobutton").focus());var r=o.querySelector(".cxTerritoryTreeValueWrapper");r.classList.add("cxTerritoryHighlightElement");var i=function(){r.classList.remove("cxTerritoryHighlightElement"),r.removeEventListener("animationend",i)};r.addEventListener("animationend",i),o.scrollIntoView({behavior:"smooth"});var a=$L(o).cxGetScrollParent();if(a){var l,s=function(){clearTimeout(l),l=setTimeout(function(){if(this.data.cxPropShowModal){var e=a.getBoundingClientRect(),t=r.getBoundingClientRect();t.top-e.top<e.height/2&&(a.scrollTop=a.scrollTop-50),t.left-e.left<e.width/2&&(a.scrollLeft=a.scrollLeft-50)}else a.scrollTop=a.scrollTop-10;a.removeEventListener("scroll",s)}.bind(this),100)}.bind(this);a.addEventListener("scroll",s)}this.getMethods("onScrollToTerritoryEnd")&&this.executeMethod("onScrollToTerritoryEnd",this,e)}.bind(this),300)}.bind(this))},actions:{selectTerritory:function(e,t){(e!=this.data.cxPropTerritory[0].id||this.data.cxPropSelectableOrg)&&(this.getMethods("onSelectTerritory")&&this.executeMethod("onSelectTerritory",e),this.data.cxPropShowModal&&("multiple"==this.data.cxPropType?this.internalOperation||(this.internalOperation=!0,this.data.selectedIds.indexOf(e)>-1?this.performUnCheckedOperation(e):this.performCheckedOperation(e),this.internalOperation=!1):this.data.cxPropShowRadioButton?this.data.cxPropShowRadioButton?$L(t.target).closest("lyte-tree-content").find("lyte-radiobutton")[0].ltProp("checked",!0):this.setData("selectedIds",[e]):(this.getMethods("onSelect")&&this.executeMethod("onSelect",store.peekRecord(this.data.cxPropModelName,e)),this.setData("cxPropValue",[store.peekRecord(this.data.cxPropModelName,e)]),this.closeModalPopup())))},saveModal:function(){if(this.getMethods("onModalSave")){var e=[];this.data.selectedIds.forEach(function(t){e.push(store.peekRecord(this.data.cxPropModelName,t))}.bind(this)),this.executeMethod("onModalSave",e)}this.setData("cxPropValue",e),this.closeModalPopup()},closeModal:function(){this.getMethods("onTerritoryCancel")?this.executeMethod("onTerritoryCancel",this):this.resetValues(),this.closeModalPopup()}},methods:{radioBoxBeforeChange:function(e,t){if(this.data.cxPropDisabledIds.indexOf(t)>-1)return!1;if("check"==e){if(this.getMethods("onBeforeCheckTerritory"))return this.executeMethod("onBeforeCheckTerritory",this.data.selectedIds,t)}else if(this.getMethods("onBeforeUncheckTerritory"))return this.executeMethod("onBeforeUncheckTerritory",this.data.selectedIds,t)},checkBoxBeforeChange:function(e,t){return!(this.data.cxPropDisabledIds.indexOf(t)>-1)&&(this.internalOperation?void 0:(setTimeout(function(){this.internalOperation=!0,"check"!=e?this.performUnCheckedOperation(t):this.performCheckedOperation(t),this.internalOperation=!1}.bind(this),10),!1))},onModalShow:function(e){this.data.cxPropLazyLoadingEnabled&&this.openTerritoryTree("#territoryTree"+this.data.cxPropTerritory[0].id,e.childComp),this.modalBody=this.$node.querySelector("lyte-modal").component.childComp,setTimeout((()=>{var e;"dropdownSearch"==this.data.cxPropSearch?((e=this.modalBody.querySelector("crux-territory-search")).focus(),e.setSearchValue("")):((e=this.modalBody.querySelector("lyte-search")).focus(),e.setValue(""))}),10),this.getMethods("onTerritoryTreeModalShow")&&this.executeMethod("onTerritoryTreeModalShow",this)},scrollTerritory:function(e){this.scrollIntoTerritory(e)},radioCheckedTerritory:function(e){this.internalOperation||(this.internalOperation=!0,this.setData("selectedIds",[e]),this.internalOperation=!1)},treeToggle:function(){this.getMethods("onTerritoryTreeToggle")&&this.executeMethod("onTerritoryTreeToggle",this)},treeOpen:function(){this.getMethods("onTerritoryTreeOpen")&&this.executeMethod("onTerritoryTreeOpen",this)},treeClose:function(){this.getMethods("onTerritoryTreeClose")&&this.executeMethod("onTerritoryTreeClose",this)},treeBeforeOpen:function(e,t,o,r,i,a){},onModalClose:function(e){this.getMethods("onTerritoryModalClose")&&this.executeMethod("onTerritoryModalClose",e)}},closeModalPopup:function(){this.resetSearch(),this.$node.querySelector("lyte-modal").ltProp("show",!1)},performCheckedOperation:function(e){var t;-1==this.data.selectedIds.indexOf(e)&&-1==this.data.cxPropDisabledIds.indexOf(e)&&(this.getMethods("onBeforeCheckTerritory")&&(t=this.executeMethod("onBeforeCheckTerritory",this.data.selectedIds,e)),(void 0===t||t)&&Lyte.arrayUtils(this.data.selectedIds,"push",e));var o=store.peekRecord(this.data.cxPropModelName,e);o.children&&o.children.length&&o.children.forEach(function(e){this.performCheckedOperation(e.id)}.bind(this))},performUnCheckedOperation:function(e){var t,o=this.data.selectedIds.indexOf(e);o>-1&&-1==this.data.cxPropDisabledIds.indexOf(e)&&(this.getMethods("onBeforeUncheckTerritory")&&(t=this.executeMethod("onBeforeUncheckTerritory",this.data.selectedIds,e)),(void 0===t||t)&&Lyte.arrayUtils(this.data.selectedIds,"removeAt",o));var r=store.peekRecord(this.data.cxPropModelName,e);r.children&&r.children.length&&r.children.forEach(function(e){this.performUnCheckedOperation(e.id)}.bind(this))},observeValue:function(){this.resetValues()}.observes("cxPropValue.[]").on("init"),resetValues:function(){this.internalOperation=!0,this.setData("selectedIds",[]),this.data.cxPropValue&&this.data.cxPropValue.forEach(function(e){e.id?Lyte.arrayUtils(this.data.selectedIds,"push",e.id):Lyte.arrayUtils(this.data.selectedIds,"push",e)}.bind(this)),this.internalOperation=!1},resetSearch:function(){},setChildData:function(e){for(var t=0;t<e.length;t++)if(e[t].parent_id){var o=store.peekRecord(this.data.cxPropModelName,e[t].parent_id);o._children||(o._children=[]),o._children.push(e[t])}this.rendered++,this.setChildren(e[0],0)},maxRenderCount:10,setChildren:function(e,t,o){if(!e._children||!e._children[t]){var r=store.peekRecord(this.data.cxPropModelName,e.parent_id);return null==r?void(this.lastSetTerritory=void 0):this.setChildren(r,r.lastRendered+1,o)}o?(e.children||Lyte.objectUtils(e,"add","children",[]),Lyte.arrayUtils(e.children,"push",e._children[t])):(e.children||(e.children=[]),e.children.push(e._children[t])),e.lastRendered=t,this.rendered++,this.rendered%this.maxRenderCount!=0?this.setChildren(e.children[e.children.length-1],0,o):this.lastSetTerritory=e},expandCollapseFn:function(e){var t=this.$node;this.data.cxPropShowModal&&(this.modalBody||(this.modalBody=this.$node.querySelector("lyte-modal").component.childComp),t=this.modalBody),$L("lyte-tree",t)[0][e](this.data.cxPropLazyLoadingEnabled?{changeCollapsed:!0}:{})},openTerritoryTree:function(e,t){var o=$L("lyte-tree",t)[0],r=$L(e,t)[0];r=r.closest("lyte-tree-body"),o.openTree(r,r.querySelectorAll("lyte-tree").length?{}:{changeCollapsed:!0})}}),Lyte.Component.register("crux-territory-search",{_template:'<template tag-name="crux-territory-search"> <lyte-dropdown on-option-selected="{{method(\'optionSelected\')}}" lt-prop-placeholder="Search" on-before-show="{{method(\'onBeforeDropdownOpen\')}}" class="cxBoxDropdown" lt-prop-freeze="false"> <template is="registerYield" yield-name="yield"> <lyte-drop-button class="{{if(dropButtonFocus,\'cxDropButtonFocused\')}}"> <lyte-search class="cxTerritorySearchElement" lt-prop-close-icon="true" lt-prop-query-selector="{&quot;scope&quot;:&quot;.searchScopeTerritory{{cxPropId}}&quot;,&quot;search&quot;:&quot;.cxTerritorySearchTerritoryName&quot;,&quot;target&quot;:&quot;.cxTerritorySearchDropItem&quot;}" on-search="{{method(\'showNoOption\')}}" lt-prop-placeholder="{{cxPropSearchPlaceholder}}" on-blur="{{method(\'onBlur\')}}" on-focus="{{method(\'onFocus\')}}" on-value-change="{{method(\'onSearchValueChange\')}}" data-zcqa="territoryTreeSearch"></lyte-search> </lyte-drop-button> <lyte-drop-box class="cxTerritoriesDropbox searchScopeTerritory{{cxPropId}} cxDropbox"> <lyte-drop-body> <template is="for" items="{{territoryDropdownData}}" item="item" index="index"> <lyte-drop-item class="cxTerritorySearchDropItem" data-value="{{item.id}}" data-zcqa="terrtioryItem_{{item.name}}"> <lyte-text class="cxTerritorySearchTerritoryName cxTerritorySearchDropItemPrimaryLabel" lt-prop-value="{{item.name}}"></lyte-text> <lyte-text class="cxTerritorySearchDropItemSecondaryLabel" lt-prop-value="{{cruxJoin(cruxSplit(item.hierachyName,\'>cx\'),\'>\')}}" lt-prop-yield="true"> <template is="registerYield" yield-name="lyte-text"> {{unescape(getHeirachyNames(item.hierachyName))}} </template> </lyte-text> </lyte-drop-item> </template> <template is="if" value="{{showNoOption}}"><template case="true"> <div class="cxDropdownNoResult" data-value="prevent">{{cruxGetI18n("crm.label.no.options.found")}}</div> </template></template> </lyte-drop-body> </lyte-drop-box> </template> </lyte-dropdown> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"componentDynamic",position:[1,1]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"attr",position:[3,1,1]},{type:"for",position:[3,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3]},{type:"registerYield",position:[1,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,3]},{type:"componentDynamic",position:[1]}]},{type:"attr",position:[3,1,3]},{type:"if",position:[3,1,3],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}},{type:"componentDynamic",position:[3,1]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[1]}],_observedAttributes:["territoryDropdownData","cxPropTerritory","cxPropModelName","cxPropQueryParams","cxPropCustomData","cxPropSearchPlaceholder","dropButtonFocus","openDropdown","cxPropId"],data:function(){return{territoryDropdownData:Lyte.attr("array",{default:[]}),cxPropTerritory:Lyte.attr("array",{default:[]}),cxPropModelName:Lyte.attr("string",{default:"territory"}),cxPropQueryParams:Lyte.attr("object"),cxPropCustomData:Lyte.attr("object"),cxPropSearchPlaceholder:Lyte.attr("string",{default:_cruxUtils.getI18n("crm.globalsearch.search.title")}),dropButtonFocus:Lyte.attr("boolean",{default:!1}),openDropdown:Lyte.attr("boolean",{default:!1}),cxPropId:Lyte.attr("string")}},setDatas:function(){var e=[],t=this.data.cxPropTerritory[0];e.push(Object.assign(t,{hierachyName:t.name})),function e(t,o,r){t.children&&t.children.forEach((function(t){var i=o+" >cx "+t.name;r.push(Object.assign(t,{hierachyName:i})),e(t,i,r)}))}(t,t.name,e),this.setData("territoryDropdownData",e)},init:function(){this.$node.focus=function(){var e=this.querySelector("lyte-search");e.click(),e.focus()},this.$node.setSearchValue=function(e){this.querySelector("lyte-search").setValue(e)},this.data.cxPropTerritory&&0!=this.data.cxPropTerritory.length?this.setDatas():store.peekAll(this.data.cxPropModelName)&&0!=store.peekAll(this.data.cxPropModelName).length?(this.setData("cxPropTerritory",[].concat(store.peekAll(this.data.cxPropModelName)[0])),this.setDatas()):store.findAll(this.data.cxPropModelName).then(function(e){this.setData("cxPropTerritory",[].concat(e[0])),this.setDatas()}.bind(this))},setFromComp:!1,actions:{},methods:{optionSelected:function(e,t){this.getMethods("onTerritorySelected")?this.executeMethod("onTerritorySelected",t):console.warn("Please use the onTerritorySelected to get the selected territory")},onBeforeDropdownOpen:function(e,t){return t&&t.setData("ltPropSelected",""),this.setFromComp},showNoOption:function(e,t,o,r){if(this.setData("showNoOption",0==e.length),0==r.length){var i=this.$node.querySelector("lyte-dropdown");i.ltProp("isOpen")&&i.close(),this.setFromComp=!1}else this.setFromComp=!0},onSearchValueChange:function(e){var t=this.$node.querySelector("lyte-dropdown");e.newValue.length>=1?(this.setData("openDropdown",!0),t.ltProp("isOpen")||(this.setFromComp=!0,t.open())):t.ltProp("isOpen")&&(this.setFromComp=!1,t.close())},onFocus:function(){this.setData("dropButtonFocus",!0)},onBlur:function(){this.setData("dropButtonFocus",!1)}}}),Lyte.Component.registerHelper("getHeirachyNames",(function(e){for(var t=e.split(">cx"),o=$ESAPI.encoder().encodeForHTML(t[0]),r=1;r<t.length;r++)o+='<span class="cxTerritoryCrumb"> > </span>'+$ESAPI.encoder().encodeForHTML(t[r]);return o}));
